<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMOTIVE A.I. Core - Combined Interface</title>
    <link rel="icon" type="image/svg+xml" href="assets/emotive-engine-icon.svg">
    <!-- External dependencies removed for performance -->
    <style>
        /* Fallback fonts - use system fonts for better performance */
        @font-face {
            font-family: 'Chakra Petch';
            src: local('system-ui'), local('-apple-system'), local('BlinkMacSystemFont');
        }
        @font-face {
            font-family: 'Orbitron';  
            src: local('system-ui'), local('-apple-system'), local('BlinkMacSystemFont');
            font-weight: 700;
        }
    </style>
    <style>
        :root {
            --blur-strength: 16px;
            --control-width: clamp(240px, 30vw, 320px);
            --gap: 20px;
        }

        /* Theme Variables - Light Theme (CAN have blue) */
        .light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-grid: rgba(0, 0, 0, 0.05);
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-primary: #007acc;
            --accent-glow: #0099ff;
            --border-color: rgba(0, 122, 204, 0.3);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --button-bg: rgba(255, 255, 255, 0.8);
            --button-hover: rgba(0, 122, 204, 0.1);
            --canvas-bg: rgba(242, 241, 241, 0.3);
            --canvas-backdrop: rgba(255, 255, 255, 0.1);
        }

        /* Dark Theme (CAN have blue) */
        .dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-grid: rgba(255, 255, 255, 0.05);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-primary: #00e5ff;
            --accent-glow: #00ccff;
            --border-color: rgba(0, 229, 255, 0.3);
            --panel-bg: rgba(42, 42, 42, 0.95);
            --button-bg: rgba(0, 0, 0, 0.4);
            --button-hover: rgba(0, 229, 255, 0.1);
            --canvas-bg: rgba(0, 0, 0, 0.3);
        }

        /* Night Theme (NO BLUES - Burnt orange/copper accents) */
        .night {
            --bg-primary: #0E0E0E;  /* flex tape dark */
            --bg-secondary: #1A1A1A; /* slightly lighter dark */
            --bg-grid: rgba(204, 102, 51, 0.08); /* burnt orange grid */
            --text-primary: #FFF5F0; /* off-white with subtle orange tint */
            --text-secondary: rgba(255, 245, 240, 0.8); /* orange-tinted white */
            --accent-primary: #CC6633; /* burnt orange for frame borders - NO BLUES */
            --accent-glow: #E67E50;    /* slightly brighter for glow */
            --border-color: rgba(204, 102, 51, 0.3); /* burnt orange border for frame */
            --panel-bg: rgba(14, 14, 14, 0.95); /* flex tape based */
            --button-bg: rgba(0, 0, 0, 0.4);
            --button-hover: rgba(255, 138, 101, 0.15); /* brighter orange hover */
            --canvas-bg: rgba(14, 14, 14, 0.3);
            --canvas-backdrop: rgba(0, 0, 0, 0.1);
        }

        /* 1. Base Reset & Typography */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-primary);
            background-image:
                linear-gradient(var(--bg-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
            background-size: 25px 25px;
            color: var(--text-primary);
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-switcher:hover {
            transform: scale(1.1);
        }

        .theme-icon {
            width: 32px;
            height: 32px;
            transition: transform 0.3s ease;
            opacity: 0.33;
        }

        .theme-switcher:hover .theme-icon {
            transform: rotate(360deg);
            opacity: 1;
        }

        /* Skip Navigation Link - WCAG 2.1 AA */
        .skip-nav {
            position: absolute;
            left: -9999px;
            z-index: 999;
            padding: 1rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
        }
        
        .skip-nav:focus {
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
        }

        /* 2. Main Layout Structure (Mobile First) */
        body {
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100%;
        }
        
        .center-container {
            order: 1;
            position: sticky;
            top: 0;
            z-index: 100;
            transform-origin: center center;
        }
        
        .shape-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 0;
            padding: 8px;
            background: rgba(0,0,0,0.8);
            border: none;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            height: 44px;
            flex-shrink: 0;
        }
        
        .shape-controls .shape-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .shape-controls .shape-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 255, 0.1));
            border-color: rgba(0, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        .controls-left { 
            order: 2; 
            transform-origin: left center;
        }
        .controls-right { 
            order: 3; 
            transform-origin: right center;
        }

        /* 3. Central Display Unit */
        .display-and-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .display-container {
            aspect-ratio: 1 / 1 !important; /* THE LAW: Always square */
            position: relative;
            background: rgba(10, 14, 26, 0.25);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            contain: layout size paint; /* Isolate layout calculations and painting */
        }
        
        #emotive-canvas {
            /* Removed will-change and image-rendering as they can hurt performance */
            transform: translateZ(0); /* Keep GPU acceleration */
            -webkit-transform: translateZ(0);
        }
        /* Fallback for browsers without aspect-ratio support - only for mobile portrait */
        @media (orientation: portrait), (max-width: 1024px) {
            .display-container::before {
                content: "";
                display: block;
                padding-top: 100%; /* Forces 1:1 Aspect Ratio using the width */
            }
        }
        .display-content {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--canvas-bg);
        }
        
        .system-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            height: 56px;
            background: linear-gradient(180deg, rgba(15,20,30,0.95), rgba(5,10,20,0.98));
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            position: relative;
            margin: 0;
            width: 100%;
            border-top: 1px solid rgba(0, 255, 255, 0.1);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        
        .system-controls-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 12px;
            border-left: 1px solid rgba(0, 255, 255, 0.1);
        }
        
        .system-controls-group:first-child {
            border-left: none;
        }
        
        .system-controls .sci-fi-btn {
            width: 42px;
            height: 42px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            background: linear-gradient(145deg, rgba(20,30,45,0.8), rgba(10,15,25,0.9));
            color: rgba(0, 255, 255, 0.7);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .system-controls .sci-fi-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(145deg, rgba(30,45,60,0.9), rgba(15,25,35,0.95));
            color: rgba(0, 255, 255, 1);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.4),
                0 0 20px rgba(0, 255, 255, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .system-controls .sci-fi-btn.active {
            background: linear-gradient(145deg, rgba(0, 255, 255, 0.2), rgba(0, 150, 150, 0.3));
            color: #00ffff;
            border-color: rgba(0, 255, 255, 0.8);
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.4),
                inset 0 0 10px rgba(0, 255, 255, 0.1);
        }
        
        .system-controls .sci-fi-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .system-controls .sci-fi-btn:hover::before {
            left: 100%;
        }
        
        /* Control Sections */
        .control-section {
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.3));
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .control-section h3 {
            font-size: 0.9rem;
            color: var(--accent-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .rhythm-controls {
            display: flex;
            flex-direction: column;
        }
        
        /* Console panels for side controls */
        .console-panel {
            display: flex;
            gap: 5px;
            padding: 10px 5px;
            background: linear-gradient(to bottom, rgba(5, 8, 12, 0.95), rgba(5, 8, 12, 0.7));
            align-items: center;
        }
        
        .controls-left {
            background: linear-gradient(to right, rgba(5, 8, 12, 0.95), rgba(5, 8, 12, 0.5));
        }
        
        .controls-right {
            background: linear-gradient(to left, rgba(5, 8, 12, 0.95), rgba(5, 8, 12, 0.5));
        }
        
        .control-column {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 65px;
        }
        
        .column-dice {
            width: 100%;
            height: 28px;
            padding: 0;
            margin-bottom: 3px;
            background: var(--button-bg);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }
        
        .column-dice:hover {
            background: var(--button-hover);
            transform: rotate(180deg);
        }
        
        .button-stack {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .button-stack .sci-fi-btn {
            width: 100%;
            height: 40px;
            padding: 10px 14px;
            margin: 0;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            background: linear-gradient(135deg, rgba(20,30,40,0.8), rgba(10,15,20,0.9));
            backdrop-filter: blur(4px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            font-family: 'Chakra Petch', sans-serif;
        }
        
        .button-stack .sci-fi-btn:hover {
            transform: translateX(2px);
            background: linear-gradient(135deg, rgba(30,40,50,0.9), rgba(20,25,30,0.95));
        }
        
        /* Audio visualizer */
        .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            min-height: 100px;
        }
        
        .spectrum-viz {
            height: 100%;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            padding: 0 5px 5px 5px;
        }
        
        .sci-fi-btn {
            width: 100%; 
            padding: 10px 14px; 
            margin: 4px 0;
            background: linear-gradient(135deg, var(--button-bg), rgba(0,0,0,0.3)); 
            border: 1px solid var(--border-color);
            color: var(--text-secondary); 
            border-radius: 6px; 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-family: 'Chakra Petch', sans-serif;
            font-size: 0.7rem; 
            font-weight: 600;
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
            text-overflow: ellipsis;
            min-height: 40px;
        }
        .sci-fi-btn:hover {
            background: linear-gradient(135deg, var(--button-hover), rgba(0,0,0,0.2)); 
            border-color: var(--accent-primary);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 20px rgba(var(--accent-rgb), 0.15);
        }
        .sci-fi-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .sci-fi-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), rgba(var(--accent-rgb), 0.7)); 
            border-color: var(--accent-primary);
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            box-shadow: 0 2px 12px rgba(var(--accent-rgb), 0.4), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .chain-btn {
            background: var(--button-bg);
            border: 1px solid var(--accent-primary);
            font-weight: bold;
            position: relative;
            overflow: hidden;
            font-size: 0.7rem;
        }
        
        .chain-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 229, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .chain-btn:hover::before {
            left: 100%;
        }
        
        /* 5. Holo Effects & Decorations */
        .holo-element { position: absolute; pointer-events: none; }
        .corner-bracket { z-index: 50; width: 40px; height: 40px; }
        .corner-bracket::before, .corner-bracket::after { 
            content: ''; 
            position: absolute; 
            background-color: var(--accent-primary); 
            animation: subtle-glow 4s infinite ease-in-out; 
        }
        .top-left { top: 0; left: 0; } 
        .top-left::before { height: 4px; width: 100%; } 
        .top-left::after { width: 4px; height: 100%; }
        .top-right { top: 0; right: 0; } 
        .top-right::before { height: 4px; width: 100%; } 
        .top-right::after { width: 4px; height: 100%; right: 0; }
        .bottom-left { bottom: 0; left: 0; } 
        .bottom-left::before { height: 4px; width: 100%; bottom: 0; } 
        .bottom-left::after { width: 4px; height: 100%; }
        .bottom-right { bottom: 0; right: 0; } 
        .bottom-right::before { height: 4px; width: 100%; bottom: 0; } 
        .bottom-right::after { width: 4px; height: 100%; right: 0; }
        .holo-circle { 
            z-index: 5; 
            border: 2px solid; 
            border-radius: 50%; 
            animation: rotate 80s infinite linear; 
            aspect-ratio: 1 / 1; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
        }
        .circle-1 { 
            width: 90%; 
            border-color: var(--border-color); 
            border-style: dotted; 
        }
        .circle-2 { 
            width: 80%; 
            border-color: var(--border-color); 
            animation-direction: reverse; 
            animation-duration: 15s; 
        }
        .info-display { 
            z-index: 200; 
            bottom: 25px; 
            left: 25px; 
            font-family: 'Chakra Petch', sans-serif; 
            font-size: 1rem; 
            width: calc(100% - 50px); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .info-display > .status-text { 
            animation: subtle-glow-cyan 4s infinite ease-in-out; 
            text-transform: uppercase; 
        }
        .info-display > .undertone-text { 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--border-color); 
            padding: 4px 12px; 
            border-radius: 4px; 
            color: var(--text-secondary); 
            font-size: 0.85rem; 
            text-transform: uppercase; 
        }
        
        .fps-display { 
            z-index: 200; 
            position: absolute; 
            bottom: 60px; 
            right: 25px;
            font-family: 'Chakra Petch', sans-serif; 
            font-size: 0.75rem; 
            color: var(--accent-primary); 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid var(--border-color); 
            padding: 8px 12px; 
            border-radius: 4px; 
            display: none; 
            text-align: right; 
            line-height: 1.4; 
        }
        .fps-display.active { display: block; } 
        .fps-display .fps-value { font-size: 1.2rem; font-weight: bold; }

        /* Beat indicator */
        .beat-indicator {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(var(--accent-rgb, 59, 130, 246), 0.1), transparent);
            box-shadow: 0 0 10px rgba(var(--accent-rgb, 59, 130, 246), 0.2);
        }
        
        #beat-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            transition: all 0.1s;
            box-shadow: 0 0 8px var(--accent-primary);
        }

        /* Mobile Responsive - Phone Portrait */
        @media (max-width: 768px) {
            
            .main-layout {
                flex-direction: column;
            }
            
            .controls-left, .controls-right {
                width: 100%;
                position: relative;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 10px;
            }
            
            .console-panel {
                flex-direction: row;
                gap: 10px;
                padding: 5px;
            }
            
            .control-column {
                min-width: 60px;
            }
            
            .shape-controls {
                padding: 5px;
                gap: 5px;
            }
            
            .shape-controls .shape-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .display-container {
                width: calc(100vw - 20px);
                max-width: 500px;
                margin: 0 auto;
            }
            
            .control-section {
                margin: 10px;
                padding: 10px;
            }
            
            .system-controls {
                flex-wrap: wrap;
                padding: 5px;
            }
            
            .system-controls .sci-fi-btn {
                font-size: 0.65rem;
                padding: 8px;
                min-width: 80px;
            }
        }
        
        /* Tablet Portrait */
        @media (min-width: 769px) and (max-width: 1024px) {
            
            .main-layout {
                padding: 10px;
            }
            
            .controls-left, .controls-right {
                width: 200px;
            }
            
            .display-container {
                max-width: 600px;
            }
        }
        
        /* 6. Landscape Mode for Mobile/Tablet Devices */
        @media (orientation: landscape) and (max-height: 768px) {
            body { overflow: hidden; }
            .main-layout {
                flex-direction: row;
                height: 100vh;
                padding: 5px;
                gap: 5px;
            }
            .center-container {
                order: 0;
                position: relative;
                flex: 1;
                min-width: 0;
                height: auto;
                display: flex;
                align-items: flex-start;
                justify-content: center;
            }
            .controls-left, .controls-right {
                order: 0;
                width: 180px;
                flex-shrink: 0;
                height: auto;
                overflow-y: auto;
                overflow-x: hidden;
                background-color: var(--panel-bg);
                align-self: flex-start;
            }
            .display-and-controls {
                height: auto;
                width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }
            .display-container {
                width: 100%;
                max-width: calc(100vh - 70px); /* Account for system controls */
                max-height: calc(100vh - 70px);
                aspect-ratio: 1 / 1 !important;
                margin: 0 auto;
            }
            /* Hide the ::before pseudo-element in landscape */
            .display-container::before {
                display: none;
            }
            .system-controls {
                height: 45px;
                font-size: 0.7rem;
                padding: 0 5px;
                flex-shrink: 0;
            }
            .system-controls .sci-fi-btn {
                padding: 5px 8px;
            }
            .sci-fi-btn {
                padding: 5px;
                font-size: 0.65rem;
                margin: 2px 0;
            }
            .control-section {
                padding: 8px;
            }
            .control-section h3 {
                font-size: 0.65rem;
                margin-bottom: 6px;
            }
        }
        

        /* 7. Desktop Layout - FRAME CENTERED, EVERYTHING ATTACHED */
        @media (min-width: 1025px) {
            body { 
                overflow: hidden;
                margin: 0;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
                width: 100vw;
            }
            
            /* Main layout - centered with frame as anchor */
            .main-layout {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                position: relative;
            }
            
            /* CENTER CONTAINER - THE BOSS */
            .center-container {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Display and controls wrapper */
            .display-and-controls {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 0;
            }
            
            /* ANIMATION FRAME - THE KING */
            .display-container {
                width: min(80vh, 80vw);
                height: min(80vh, 80vw);
                aspect-ratio: 1 / 1 !important;
                position: relative;
                margin: 0;
            }
            
            /* Shape controls - ATTACHED TO TOP OF FRAME */
            .shape-controls {
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 5px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.9);
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            
            .shape-controls .shape-btn {
                width: 45px;
                height: 45px;
                padding: 0;
                font-size: 1.3rem;
            }
            
            /* System controls - ATTACHED TO BOTTOM OF FRAME */
            .system-controls {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 5px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.9);
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }
            
            .system-controls .sci-fi-btn {
                padding: 8px 12px;
                font-size: 0.7rem;
                height: 36px;
            }
            
            /* Left panel - ATTACHED TO LEFT OF FRAME */
            .controls-left {
                position: absolute;
                right: 100%;
                top: 0;
                bottom: 0;
                width: 250px;
                background: linear-gradient(to right, rgba(5, 8, 12, 0.95), rgba(5, 8, 12, 0.5));
                padding: 15px;
                overflow-y: auto;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
                gap: 10px;
                border-top-left-radius: 8px;
                border-bottom-left-radius: 8px;
            }
            
            /* Right panel - ATTACHED TO RIGHT OF FRAME */
            .controls-right {
                position: absolute;
                left: 100%;
                top: 0;
                bottom: 0;
                width: 250px;
                background: linear-gradient(to left, rgba(5, 8, 12, 0.95), rgba(5, 8, 12, 0.5));
                padding: 15px;
                overflow-y: auto;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
                gap: 10px;
                border-top-right-radius: 8px;
                border-bottom-right-radius: 8px;
            }
            
            /* Console panel layout */
            .console-panel {
                background: transparent;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .control-column {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 3px;
            }
            
            .button-stack {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 3px;
            }
            
            .button-stack .sci-fi-btn {
                padding: 8px;
                height: 35px;
                font-size: 0.65rem;
            }
            
            /* Chain buttons in single column */
            .control-column:first-child .button-stack {
                grid-template-columns: 1fr;
            }
            
            /* Remove pseudo element */
            .display-container::before {
                display: none;
            }
        }

        /* 8. Animations */
        #emotive-canvas { 
            display: block; 
            position: absolute; 
            z-index: 10; 
            width: 100% !important; 
            height: 100% !important; 
            top: 0;
            left: 0;
            object-fit: contain;
        }
        @keyframes subtle-glow { 
            0%, 100% { 
                background-color: var(--accent-primary); 
            } 
            50% { 
                background-color: var(--accent-glow); 
            } 
        }
        @keyframes subtle-glow-cyan { 
            0%, 100% { 
                color: var(--accent-primary); 
                text-shadow: 0 0 5px var(--accent-glow); 
            } 
            50% { 
                color: var(--accent-glow); 
                text-shadow: 0 0 8px var(--accent-glow); 
            } 
        }
        @keyframes rotate { 
            from { transform: translate(-50%, -50%) rotate(0deg); } 
            to { transform: translate(-50%, -50%) rotate(360deg); } 
        }
        
        /* Audio player styling */
        #audio-player::-webkit-media-controls-current-time-display,
        #audio-player::-webkit-media-controls-time-remaining-display {
            color: var(--text-primary);
        }
        
        #audio-player::-webkit-media-controls-panel {
            background: transparent;
        }
    </style>
</head>
<body class="night">
    <a href="#display-container" class="skip-nav">Skip to main content</a>
    
    <main class="main-layout" role="main">
        <nav class="controls-left" role="navigation" aria-label="Gesture controls">
            <div class="control-section">
                <h3>Rhythm Sync Module</h3>
                <div class="rhythm-controls">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <button class="sci-fi-btn" id="rhythm-toggle" style="flex: 1;">
                            <span id="rhythm-status">‚ñ∂ START</span>
                        </button>
                        <div id="beat-indicator" style="width: 30px; height: 30px; border: 1px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div id="beat-dot" style="width: 10px; height: 10px; background: var(--accent-primary); border-radius: 50%; transition: all 0.1s;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="color: var(--text-secondary); font-size: 0.7rem; display: block; margin-bottom: 5px;">BPM: <span id="bpm-value">120</span></label>
                        <input type="range" id="bpm-slider" min="60" max="220" value="120" style="width: 100%; accent-color: var(--accent-primary);">
                    </div>
                </div>
            </div>
            
            <div class="console-panel">
            <!-- Chain Combos Column (Most Important) -->
            <div class="control-column">
                <button class="dice-btn column-dice" id="randomize-chain-btn" aria-label="Random chain" title="üé≤">üé≤</button>
                <div class="button-stack">
                    <button class="sci-fi-btn chain-btn" data-chain="buildup">Build</button>
                    <button class="sci-fi-btn chain-btn" data-chain="cascade">Cascade</button>
                    <button class="sci-fi-btn chain-btn" data-chain="celebrate">Celebrate</button>
                    <button class="sci-fi-btn chain-btn" data-chain="smooth">Smooth</button>
                    <button class="sci-fi-btn chain-btn" data-chain="chaos">Chaos</button>
                    <button class="sci-fi-btn chain-btn" data-chain="custom">Custom</button>
                </div>
            </div>
            
            <!-- Dance Column -->
            <div class="control-column">
                <button class="dice-btn column-dice" id="randomize-dance-btn" aria-label="Random dance" title="üé≤">üé≤</button>
                <div class="button-stack">
                    <button class="sci-fi-btn gesture-btn" data-gesture="bounce">Bounce</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="sway">Sway</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="headBob">HeadBob</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="wiggle">Wiggle</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="spin">Spin</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="hula">Hula</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="orbit">Orbit</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="groove">Groove</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="jump">Jump</button>
                </div>
            </div>
            
            <!-- Overlayable Column -->
            <div class="control-column">
                <button class="dice-btn column-dice" id="randomize-gesture-btn" aria-label="Random gesture" title="üé≤">üé≤</button>
                <div class="button-stack">
                    <button class="sci-fi-btn gesture-btn" data-gesture="wave">Wave</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="point">Point</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="nod">Nod</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="shake">Shake</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="lean">Lean</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="tilt">Tilt</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="reach">Reach</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="breathe">Breathe</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="float">Float</button>
                </div>
            </div>
            
            <!-- Glow Column -->
            <div class="control-column">
                <button class="sci-fi-btn sound-toggle" id="sound-toggle" aria-label="Toggle sound" title="Sound">üîä</button>
                <div class="button-stack">
                    <button class="sci-fi-btn gesture-btn" data-gesture="sparkle">Sparkle</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="pulse">Pulse</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="glow">Glow</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="flash">Flash</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="shimmer">Shimmer</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="flicker">Flicker</button>
                </div>
            </div>
            </div>
        </nav>

        <div class="center-container">
            <div class="display-and-controls">
                <!-- Shape buttons above canvas -->
                <div class="shape-controls">
                    <button class="sci-fi-btn shape-btn active" data-shape="circle">‚óã</button>
                    <button class="sci-fi-btn shape-btn" data-shape="heart">‚ô•</button>
                    <button class="sci-fi-btn shape-btn" data-shape="star">‚òÖ</button>
                    <button class="sci-fi-btn shape-btn" data-shape="sun">‚òÄ</button>
                    <button class="sci-fi-btn shape-btn" data-shape="moon">‚òæ</button>
                    <button class="sci-fi-btn shape-btn" data-shape="lunar">‚óè</button>
                    <button class="sci-fi-btn shape-btn" data-shape="square">‚ñ°</button>
                    <button class="sci-fi-btn shape-btn" data-shape="triangle">‚ñ≥</button>
                    <button class="dice-btn" id="randomize-shape-btn" aria-label="Random shape" title="üé≤">üé≤</button>
                </div>
                <div id="display-container" class="display-container">
                    <div class="display-content">
                        <canvas id="emotive-canvas"></canvas>
                        <div style="position: absolute; top: 20px; left: 20px; z-index: 100; opacity: 0.33;">
                            <img id="logo-image" src="assets/emotive-engine-full-BW.svg" alt="Emotive Engine" style="height: 40px; filter: brightness(0) invert(1);">
                        </div>
                        <!-- Theme Switcher -->
                        <div class="theme-switcher" id="theme-switcher">
                            <svg class="theme-icon" id="theme-icon" viewBox="0 0 24 24" fill="currentColor">
                                <!-- Icon path will be replaced dynamically -->
                                <path d="" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="holo-element corner-bracket top-left"></div>
                        <div class="holo-element corner-bracket top-right"></div>
                        <div class="holo-element corner-bracket bottom-left"></div>
                        <div class="holo-element corner-bracket bottom-right"></div>
                        <div class="holo-element holo-circle circle-1"></div>
                        <div class="holo-element holo-circle circle-2"></div>
                        <div class="holo-element info-display">
                            <div class="status-text" id="emotion-display">EMOTION: NEUTRAL</div>
                            <div class="undertone-text" id="undertone-display">STABLE</div>
                        </div>
                        <div class="fps-display" id="fps-display">
                            <span class="fps-value" id="fps-value">0</span>
                            <span class="fps-label">FPS</span>
                        </div>
                    </div>
                </div>
                <div class="system-controls" role="group" aria-label="System controls">
                    <div class="system-controls-group">
                        <button class="sci-fi-btn" id="load-audio-btn" aria-label="Load audio file" title="Load Audio">üìÅ</button>
                        <button class="sci-fi-btn" id="load-song-btn" aria-label="Load demo song" title="Demo Song">‚ö°</button>
                        <button class="sci-fi-btn" id="mic-btn" aria-label="Use microphone" title="Microphone">üé§</button>
                    </div>
                    <div class="system-controls-group">
                        <button class="sci-fi-btn active" id="blinking-toggle" aria-label="Toggle blinking" aria-pressed="true" title="Blinking">üëÅ</button>
                        <button class="sci-fi-btn" id="fps-toggle" aria-label="Toggle FPS display" aria-pressed="false" title="FPS">üìä</button>
                        <button class="sci-fi-btn" id="record-btn" aria-label="Toggle audio recording" aria-pressed="false" title="Record">üî¥</button>
                        <button class="sci-fi-btn master-dice" id="randomize-all-btn" aria-label="Randomize everything" aria-pressed="false" title="Roll All">üé∞</button>
                    </div>
                </div>
            </div>
        </div>

        <aside class="controls-right" role="complementary" aria-label="Emotion controls">
            <div class="control-section">
                <div class="audio-controls">
                    <input type="file" id="audio-file" accept="audio/*" style="display: none;">
                    <!-- Audio source buttons in a compact row -->
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button class="sci-fi-btn" id="load-audio-btn2" style="flex: 1; padding: 8px; font-size: 0.8rem;">Load File</button>
                        <button class="sci-fi-btn" id="load-song-btn2" style="flex: 1; padding: 8px; font-size: 0.8rem;">Electric Glow</button>
                        <button class="sci-fi-btn" id="mic-btn2" style="flex: 1; padding: 8px; font-size: 0.8rem;">Use Microphone</button>
                    </div>
                    
                    <!-- Visualizer with integrated controls -->
                    <div id="audio-viz2" class="audio-viz-container">
                        <!-- Animated background effect -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, var(--accent-glow), transparent); opacity: 0.1; pointer-events: none;"></div>
                        
                        <!-- Audio player overlay (top-right safe zone) -->
                        <div style="
                            position: absolute; 
                            top: 10px; 
                            right: 10px; 
                            width: 220px; 
                            height: 32px;
                            z-index: 10;
                            display: none;
                        " id="audio-player-container2">
                            <audio id="audio-player" controls style="
                                width: 100%; 
                                height: 100%;
                                border: none !important;
                                background: transparent;
                                filter: opacity(0.9);
                            "></audio>
                        </div>
                        
                        <!-- Spectrum Visualizer -->
                        <div id="spectrum-viz" class="spectrum-viz">
                            <!-- Bars will be dynamically created -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="console-panel">
            <!-- Emotions Column -->
            <div class="control-column">
                <button class="dice-btn column-dice" id="randomize-btn" aria-label="Random emotion" title="üé≤">üé≤</button>
                <div class="button-stack">
                    <button class="sci-fi-btn emotion-btn active" data-emotion="neutral">Neutral</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="joy">Joy</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="sadness">Sad</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="anger">Anger</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="fear">Fear</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="surprise">Surprise</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="disgust">Disgust</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="love">Love</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="excited">Excited</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="euphoria">Euphoria</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="glitch">Glitch</button>
                </div>
            </div>
            
            <!-- Undertones Column -->
            <div class="control-column">
                <button class="dice-btn column-dice" id="randomize-undertone-btn" aria-label="Random undertone" title="üé≤">üé≤</button>
                <div class="button-stack">
                    <button class="sci-fi-btn undertone-btn active" data-undertone="">Clear</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="subdued">Subdued</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="tired">Tired</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="nervous">Nervous</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="confident">Confident</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="intense">Intense</button>
                </div>
            </div>
            </div>
        </aside>

    </main>

    <script type="module">
        // Performance optimization: Use dynamic import for faster initial load
        let EmotiveEngine;
        let mascot;
        let currentEmotion = 'neutral';
        let currentUndertone = '';
        let showingFPS = false;
        let isRecording = false;
        let currentTheme = 'night';
        let soundEnabled = false;
        
        // Load EmotiveEngine asynchronously
        const loadEngine = async () => {
            const module = await import('./src/EmotiveMascot.js');
            EmotiveEngine = module.default;
            return EmotiveEngine;
        };
        
        // Load rhythm and gesture modules
        let rhythmIntegration, rhythmEngine, GestureScheduler, FPSCounter;
        let gestureScheduler, fpsCounter;
        // Make rhythmActive global so rhythmIntegration can update it
        window.rhythmActive = false;
        
        const loadRhythmModules = async () => {
            const [rhythmIntegrationModule, rhythmModule, gestureModule, fpsModule] = await Promise.all([
                import('./src/core/rhythmIntegration.js'),
                import('./src/core/rhythm.js'),
                import('./src/core/GestureScheduler.js'),
                import('./src/utils/FPSCounter.js')
            ]);
            rhythmIntegration = rhythmIntegrationModule.default;
            rhythmEngine = rhythmModule.rhythmEngine;
            GestureScheduler = gestureModule.default;
            FPSCounter = fpsModule.default;
        };

        // Theme management
        const themes = ['light', 'dark', 'night'];
        const themeIcons = {
            // Sun icon for light theme - larger starburst with eclipse-matching center hole
            'light': 'M 12 0 L 9.5 6.5 A 5.5 5.5 0 0 1 14.5 6.5 L 12 0 z M 2 2 L 6.5 9.5 A 5.5 5.5 0 0 1 9.5 6.5 L 2 2 z M 0 12 L 6.5 14.5 A 5.5 5.5 0 0 1 6.5 9.5 L 0 12 z M 2 22 L 9.5 17.5 A 5.5 5.5 0 0 1 6.5 14.5 L 2 22 z M 12 24 L 14.5 17.5 A 5.5 5.5 0 0 1 9.5 17.5 L 12 24 z M 22 22 L 17.5 14.5 A 5.5 5.5 0 0 1 14.5 17.5 L 22 22 z M 24 12 L 17.5 9.5 A 5.5 5.5 0 0 1 17.5 14.5 L 24 12 z M 22 2 L 14.5 6.5 A 5.5 5.5 0 0 1 17.5 9.5 L 22 2 z',
            // Moon icon for dark theme - crescent using negative space
            'dark': 'M 12 3 C 7.03 3 3 7.03 3 12 C 3 16.97 7.03 21 12 21 C 16.97 21 21 16.97 21 12 C 21 11.34 20.91 10.7 20.75 10.09 C 19.84 10.67 18.75 11 17.57 11 C 14.48 11 12 8.52 12 5.43 C 12 4.25 12.33 3.16 12.91 2.25 C 12.61 3.09 12 3 12 3 z',
            // Eclipse icon for night theme - sun with moon overlay
            'night': 'M 12 2 C 6.48 2 2 6.48 2 12 C 2 17.52 6.48 22 12 22 C 17.52 22 22 17.52 22 12 C 22 6.48 17.52 2 12 2 z M 15 4.5 C 18.04 4.5 20.5 6.96 20.5 10 C 20.5 13.04 18.04 15.5 15 15.5 C 11.96 15.5 9.5 13.04 9.5 10 C 9.5 6.96 11.96 4.5 15 4.5 z'
        };
        const iconColors = {
            'light': '#007acc',  /* blue - light theme CAN have blue */
            'dark': '#00e5ff',   /* cyan - dark theme CAN have blue */
            'night': '#CC6633'   /* burnt orange/copper - night theme NO blues */
        };

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            const path = icon.querySelector('path');
            path.setAttribute('d', themeIcons[theme]);
            path.setAttribute('fill-rule', 'evenodd');
            icon.style.color = iconColors[theme];
        }

        function cycleTheme() {
            const currentIndex = themes.indexOf(currentTheme);
            currentTheme = themes[(currentIndex + 1) % themes.length];
            
            // Remove all theme classes and apply new one
            document.body.classList.remove(...themes);
            document.body.classList.add(currentTheme);
            
            // Update icon
            updateThemeIcon(currentTheme);
            
            // Update logo filter to match theme with subtle tint
            const logo = document.getElementById('logo-image');
            if (logo) {
                switch(currentTheme) {
                    case 'light':
                        // Subtle blue tint for light theme
                        logo.style.filter = 'brightness(0) sepia(1) saturate(5) hue-rotate(190deg) brightness(0.4)';
                        break;
                    case 'night':
                        // Subtle orange tint for night theme  
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(15deg) brightness(0.9)';
                        break;
                    case 'dark':
                    default:
                        // Subtle cyan tint for dark theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(150deg) brightness(0.95)';
                        break;
                }
            }
            
            // Save preference
            localStorage.setItem('emotive-theme', currentTheme);
        }
        
        async function init() {
            // Load saved theme
            const savedTheme = localStorage.getItem('emotive-theme') || 'night';
            currentTheme = savedTheme;
            document.body.classList.remove(...themes);
            document.body.classList.add(currentTheme);
            updateThemeIcon(currentTheme);
            
            // Set initial logo filter based on theme with subtle tint
            const logo = document.getElementById('logo-image');
            if (logo) {
                switch(currentTheme) {
                    case 'light':
                        // Subtle blue tint for light theme
                        logo.style.filter = 'brightness(0) sepia(1) saturate(5) hue-rotate(190deg) brightness(0.4)';
                        break;
                    case 'night':
                        // Subtle orange tint for night theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(15deg) brightness(0.9)';
                        break;
                    case 'dark':
                    default:
                        // Subtle cyan tint for dark theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(150deg) brightness(0.95)';
                        break;
                }
            }

            // Load engine dynamically for better performance
            await loadEngine();
            
            mascot = new EmotiveEngine({
                canvasId: 'emotive-canvas',
                startingEmotion: 'neutral',
                emotionalResponsiveness: 0.8,
                particleIntensity: 1.0,
                glowIntensity: 0.8,
                audioEnabled: true,  // Initialize audio system
                showFPS: false,
                debugMode: false,
                renderMode: 'default',
                maxParticles: 100
            });
            
            // Initialize audio analyzer
            if (mascot.audioAnalyzer) {
                await mascot.audioAnalyzer.init();
            }
            
            // After mascot is created, disable sound until user enables it
            setTimeout(() => {
                if (mascot.soundSystem) {
                    mascot.soundSystem.isEnabled = false;
                }
            }, 100);
            
            mascot.start();
            
            // Initialize spectrum visualizer bars
            const spectrumViz = document.getElementById('spectrum-viz');
            const numBars = 16; // Reduced for cleaner look
            for (let i = 0; i < numBars; i++) {
                const bar = document.createElement('div');
                bar.className = 'spectrum-bar';
                bar.style.cssText = `
                    flex: 1;
                    background: linear-gradient(180deg, var(--accent-glow), var(--accent-primary));
                    border-radius: 2px 2px 0 0;
                    transition: height 0.15s ease-out;
                    opacity: 0.8;
                    min-height: 2px;
                    height: 2px;
                `;
                spectrumViz.appendChild(bar);
            }
            
            // Initialize audio visualizer update loop
            function updateAudioViz() {
                if (mascot && mascot.shapeMorpher) {
                    const morpher = mascot.shapeMorpher;
                    
                    // Update spectrum bars
                    if (morpher.frequencyData && morpher.frequencyData.length > 0) {
                        const bars = spectrumViz.querySelectorAll('.spectrum-bar');
                        const bandsPerBar = Math.floor(morpher.frequencyData.length / numBars);
                        
                        bars.forEach((bar, i) => {
                            // Average the energy for bands that map to this bar
                            let energy = 0;
                            let count = 0;
                            for (let j = 0; j < bandsPerBar; j++) {
                                const bandIndex = i * bandsPerBar + j;
                                if (bandIndex < morpher.frequencyData.length) {
                                    energy += morpher.frequencyData[bandIndex] || 0;
                                    count++;
                                }
                            }
                            energy = count > 0 ? energy / count : 0;
                            
                            // Apply logarithmic scaling for better visual response
                            const height = Math.pow(energy, 0.7) * 100;
                            bar.style.height = `${Math.max(2, Math.min(100, height))}%`;
                            
                            // Color variation based on frequency range
                            if (i < 2) {
                                // Bass frequencies - use primary accent
                                bar.style.opacity = '1';
                                bar.style.filter = 'hue-rotate(0deg)';
                            } else if (i >= 6 && i <= 10) {
                                // Mid frequencies (vocals) - use secondary accent  
                                bar.style.opacity = '0.9';
                                bar.style.filter = 'hue-rotate(60deg)';
                            } else {
                                // High frequencies
                                bar.style.opacity = '0.7';
                                bar.style.filter = 'hue-rotate(120deg)';
                            }
                        });
                    }
                }
                
                requestAnimationFrame(updateAudioViz);
            }
            updateAudioViz();
            
            // Load and initialize rhythm modules
            await loadRhythmModules();
            
            // Initialize rhythm system
            rhythmIntegration.initialize();
            
            // Make rhythmIntegration globally accessible for BPM updates
            window.rhythmIntegration = rhythmIntegration;
            
            // Also update UI when rhythm auto-starts
            const originalStart = rhythmIntegration.start.bind(rhythmIntegration);
            rhythmIntegration.start = function(bpm, pattern) {
                originalStart(bpm, pattern);
                window.rhythmActive = true;
                const rhythmStatus = document.getElementById('rhythm-status');
                if (rhythmStatus) {
                    rhythmStatus.textContent = '‚ñ† STOP';
                }
            };
            
            // Initialize gesture scheduler
            gestureScheduler = new GestureScheduler(mascot);
            
            // Setup scheduler callbacks for visual feedback
            gestureScheduler.onGestureQueued = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.add('gesture-pending');
                }
            };
            
            gestureScheduler.onGestureTriggered = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.remove('gesture-pending');
                    btn.classList.add('gesture-triggered');
                    setTimeout(() => btn.classList.remove('gesture-triggered'), 200);
                }
            };
            
            // Setup beat indicator
            rhythmEngine.on('beat', (beatInfo) => {
                if (window.rhythmActive) {
                    const beatDot = document.getElementById('beat-dot');
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
                    const glowColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-glow');
                    
                    beatDot.style.width = '20px';
                    beatDot.style.height = '20px';
                    beatDot.style.background = accentColor;
                    beatDot.style.boxShadow = `0 0 20px ${glowColor}`;
                    
                    setTimeout(() => {
                        beatDot.style.width = '10px';
                        beatDot.style.height = '10px';
                        beatDot.style.background = accentColor;
                        beatDot.style.boxShadow = 'none';
                    }, 100);
                }
            });
            
            // Initialize FPS counter
            fpsCounter = new FPSCounter();
            
            // Start FPS tracking animation loop
            function updateFPS() {
                const fps = fpsCounter.update();
                if (showingFPS) {
                    document.getElementById('fps-value').textContent = fps;
                }
                requestAnimationFrame(updateFPS);
            }
            updateFPS();
            
            setupEventHandlers();
            updateDisplay();
            
            // Handle orientation changes
            let previousOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
            let isTransitioning = false;
            
            const handleOrientationChange = () => {
                const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
                
                if (currentOrientation !== previousOrientation && !isTransitioning) {
                    isTransitioning = true;
                    
                    // Heavy blur on current frame
                    document.body.style.filter = 'blur(30px)';
                    
                    // Wait for blur, then switch with new view pre-blurred
                    setTimeout(() => {
                        previousOrientation = currentOrientation;
                        
                        // Clear particles while blurred
                        if (mascot && mascot.particleSystem) {
                            mascot.particleSystem.particles = [];
                        }
                        
                        // Force canvas resize to prevent orb squishing
                        if (mascot && mascot.canvasManager) {
                            // Wait a frame for layout to settle
                            requestAnimationFrame(() => {
                                // Force full canvas reset
                                const canvas = mascot.canvasManager.canvas;
                                
                                // Clear any inline dimensions
                                canvas.style.width = '';
                                canvas.style.height = '';
                                
                                // Let CSS reflow
                                const rect = canvas.getBoundingClientRect();
                                
                                // Reset the canvas internal dimensions
                                mascot.canvasManager.dpr = window.devicePixelRatio || 1;
                                mascot.canvasManager.width = rect.width;
                                mascot.canvasManager.height = rect.height;
                                mascot.canvasManager.canvas.width = rect.width * mascot.canvasManager.dpr;
                                mascot.canvasManager.canvas.height = rect.height * mascot.canvasManager.dpr;
                                mascot.canvasManager.centerX = rect.width / 2;
                                mascot.canvasManager.centerY = rect.height / 2;
                                
                                // Reset context scaling
                                mascot.canvasManager.ctx.setTransform(1, 0, 0, 1, 0, 0);
                                mascot.canvasManager.ctx.scale(mascot.canvasManager.dpr, mascot.canvasManager.dpr);
                                
                                // Update renderer's scale factor
                                if (mascot.renderer) {
                                    const canvasSize = Math.min(rect.width || 400, rect.height || 400);
                                    mascot.renderer.scaleFactor = (canvasSize / 400) * (mascot.renderer.config.baseScale || 1.0);
                                    
                                    // Force offscreen canvas update
                                    if (mascot.renderer.offscreenCanvas) {
                                        mascot.renderer.offscreenCanvas.width = rect.width;
                                        mascot.renderer.offscreenCanvas.height = rect.height;
                                    }
                                    
                                    // Clear caches
                                    if (mascot.renderer.glowCache) {
                                        mascot.renderer.glowCache.clear();
                                    }
                                }
                            });
                        }
                        
                        // Keep blur for incoming view
                        document.body.style.filter = 'blur(25px)';
                        
                        // Then quickly unblur to reveal new layout
                        setTimeout(() => {
                            document.body.style.filter = '';
                            isTransitioning = false;
                            
                            // Double-check canvas dimensions after transition
                            if (mascot && mascot.canvasManager) {
                                // Wait two frames to ensure complete layout settlement
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(() => {
                                        const canvas = mascot.canvasManager.canvas;
                                        canvas.style.width = '';
                                        canvas.style.height = '';
                                        
                                        const rect = canvas.getBoundingClientRect();
                                        
                                        mascot.canvasManager.dpr = window.devicePixelRatio || 1;
                                        mascot.canvasManager.width = rect.width;
                                        mascot.canvasManager.height = rect.height;
                                        mascot.canvasManager.canvas.width = rect.width * mascot.canvasManager.dpr;
                                        mascot.canvasManager.canvas.height = rect.height * mascot.canvasManager.dpr;
                                        mascot.canvasManager.centerX = rect.width / 2;
                                        mascot.canvasManager.centerY = rect.height / 2;
                                        
                                        mascot.canvasManager.ctx.setTransform(1, 0, 0, 1, 0, 0);
                                        mascot.canvasManager.ctx.scale(mascot.canvasManager.dpr, mascot.canvasManager.dpr);
                                        
                                        if (mascot.renderer) {
                                            const canvasSize = Math.min(rect.width || 400, rect.height || 400);
                                            mascot.renderer.scaleFactor = (canvasSize / 400) * (mascot.renderer.config.baseScale || 1.0);
                                            
                                            if (mascot.renderer.offscreenCanvas) {
                                                mascot.renderer.offscreenCanvas.width = rect.width;
                                                mascot.renderer.offscreenCanvas.height = rect.height;
                                            }
                                            
                                            if (mascot.renderer.glowCache) {
                                                mascot.renderer.glowCache.clear();
                                            }
                                        }
                                    });
                                });
                            }
                        }, 50);
                    }, 150);
                }
            };
            
            // Single debounced resize handler
            let resizeTimeout;
            let blurApplied = false;
            
            window.addEventListener('resize', () => {
                const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
                
                // Only apply blur once when orientation actually changes
                if (currentOrientation !== previousOrientation && !isTransitioning && !blurApplied) {
                    document.body.style.filter = 'blur(30px)';
                    blurApplied = true;
                }
                
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    handleOrientationChange();
                    blurApplied = false; // Reset for next orientation change
                }, 100);
            });
            
            if ('orientation' in window) {
                window.addEventListener('orientationchange', () => {
                    if (!isTransitioning) {
                        // Apply heavy blur immediately
                        document.body.style.filter = 'blur(30px)';
                        setTimeout(handleOrientationChange, 100);
                    }
                });
            }
        }

        function setupEventHandlers() {
            // Theme switcher
            document.getElementById('theme-switcher').addEventListener('click', cycleTheme);
            
            // Sound toggle
            const soundToggle = document.getElementById('sound-toggle');
            
            // Function to update button appearance based on state
            const updateSoundButton = (enabled) => {
                if (!soundToggle) return;
                
                if (enabled) {
                    soundToggle.classList.add('active');
                    soundToggle.setAttribute('aria-pressed', 'true');
                    soundToggle.textContent = 'üîä';
                } else {
                    soundToggle.classList.remove('active');
                    soundToggle.setAttribute('aria-pressed', 'false');
                    soundToggle.textContent = 'üîá';
                }
            };
            
            // Initialize button to show disabled state
            updateSoundButton(false);
            
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                if (!mascot || !mascot.soundSystem) return;
                
                // Toggle the sound state
                soundEnabled = !soundEnabled;
                
                // Update mascot configuration and sound system
                mascot.config.enableAudio = soundEnabled;
                mascot.soundSystem.isEnabled = soundEnabled;
                
                // Update button appearance
                updateSoundButton(soundEnabled);
                
                if (!soundEnabled && mascot.soundSystem.isAvailable()) {
                    // Stop any playing ambient tones when disabling
                    mascot.soundSystem.stopAmbientTone(200);
                }
                
                console.log('Sound', soundEnabled ? 'enabled' : 'disabled');
                });
            }

            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentEmotion = btn.dataset.emotion;
                    mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                    
                    document.querySelectorAll('.emotion-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-pressed', 'true');
                    updateDisplay();
                });
            });

            document.querySelectorAll('.gesture-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const gestureName = btn.dataset.gesture;
                    
                    if (window.rhythmActive && gestureScheduler) {
                        gestureScheduler.requestGesture(gestureName);
                    } else {
                        mascot.express(gestureName);
                    }
                });
            });

            // Chain button functionality
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const chainType = btn.dataset.chain;
                    
                    // Define chains - these stack with z-index layering
                    const chains = {
                        buildup: [
                            { gesture: 'bounce', delay: 0 },
                            { gesture: 'sway', delay: 100 },
                            { gesture: 'glow', delay: 200 },
                            { gesture: 'sparkle', delay: 500 }
                        ],
                        cascade: [
                            { gesture: 'wave', delay: 0 },
                            { gesture: 'pulse', delay: 100 },
                            { gesture: 'shimmer', delay: 200 }
                        ],
                        celebrate: [
                            { gesture: 'spin', delay: 0 },
                            { gesture: 'bounce', delay: 100 },
                            { gesture: 'sparkle', delay: 200 },
                            { gesture: 'flash', delay: 400 }
                        ],
                        smooth: [
                            { gesture: 'sway', delay: 0 },
                            { gesture: 'wave', delay: 100 },
                            { gesture: 'glow', delay: 200 },
                            { gesture: 'point', delay: 400 }
                        ],
                        chaos: [
                            { gesture: 'wiggle', delay: 0 },
                            { gesture: 'shake', delay: 50 },
                            { gesture: 'spin', delay: 100 },
                            { gesture: 'flash', delay: 150 },
                            { gesture: 'sparkle', delay: 200 }
                        ],
                        custom: [
                            { gesture: 'lean', delay: 0 },
                            { gesture: 'reach', delay: 150 },
                            { gesture: 'groove', delay: 300 },
                            { gesture: 'shimmer', delay: 450 },
                            { gesture: 'orbit', delay: 600 }
                        ]
                    };
                    
                    const chain = chains[chainType];
                    if (chain && mascot) {
                        // Execute chain with delays for layering effect
                        chain.forEach(item => {
                            setTimeout(() => {
                                if (window.rhythmActive && gestureScheduler) {
                                    gestureScheduler.requestGesture(item.gesture);
                                } else {
                                    mascot.express(item.gesture);
                                }
                            }, item.delay);
                        });
                        
                        // Visual feedback
                        btn.style.animation = 'none';
                        setTimeout(() => btn.style.animation = '', 10);
                    }
                });
            });

            document.querySelectorAll('.undertone-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentUndertone = btn.dataset.undertone;
                    mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                    document.querySelectorAll('.undertone-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-pressed', 'true');
                    updateDisplay();
                });
            });

            document.getElementById('fps-toggle').addEventListener('click', function() {
                showingFPS = !showingFPS;
                document.getElementById('fps-display').classList.toggle('active', showingFPS);
                this.innerHTML = showingFPS ? 'üìä Hide FPS' : 'üìä FPS';
                this.classList.toggle('active', showingFPS);
                this.setAttribute('aria-pressed', showingFPS ? 'true' : 'false');
                
                // Start or stop FPS updates
                if (showingFPS) {
                    updateFPS();
                }
            });
            
            // Blinking toggle
            let blinkingEnabled = true;
            document.getElementById('blinking-toggle').addEventListener('click', function() {
                blinkingEnabled = !blinkingEnabled;
                this.innerHTML = blinkingEnabled ? 'üëÅ Blinking' : 'üëÅ‚Äçüó® No Blink';
                this.classList.toggle('active', blinkingEnabled);
                this.setAttribute('aria-pressed', blinkingEnabled ? 'true' : 'false');
                
                // Set blinking on the renderer (which actually controls the blinking)
                if (mascot && mascot.renderer) {
                    mascot.renderer.setBlinkingEnabled(blinkingEnabled);
                }
            });
            
            // Rhythm controls
            document.getElementById('rhythm-toggle').addEventListener('click', function() {
                const bpm = document.getElementById('bpm-slider').value;
                const pattern = 'straight'; // Default pattern
                
                if (!window.rhythmActive) {
                    // Starting rhythm
                    const shapeMorpher = mascot?.shapeMorpher;
                    
                    // If audio is playing, reset detection to get fresh BPM
                    if (shapeMorpher && audioPlayer && !audioPlayer.paused) {
                        // Reset detection for fresh readings
                        shapeMorpher.resetMusicDetection();
                        console.log('üîÑ Resampling BPM and time signature...');
                        
                        // Clear the manual stop flag so auto-detection can work
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                        
                        // The BPM detection will auto-start rhythm when ready
                        // For now, show pending state
                        document.getElementById('rhythm-status').textContent = '‚è≥ DETECTING...';
                        this.classList.add('pending');
                        
                        // Fallback: start with slider value if no BPM detected after 2 seconds
                        setTimeout(() => {
                            if (!window.rhythmActive) {
                                console.log('‚è∞ Timeout - starting with default BPM');
                                rhythmIntegration.start(parseInt(bpm), pattern);
                                window.rhythmActive = true;
                                document.getElementById('rhythm-status').textContent = '‚ñ† STOP';
                                this.classList.remove('pending');
                                this.classList.add('active');
                            }
                        }, 2000);
                    } else {
                        // No audio playing, use slider value immediately
                        rhythmIntegration.start(parseInt(bpm), pattern);
                        window.rhythmActive = true;
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                        document.getElementById('rhythm-status').textContent = '‚ñ† STOP';
                        this.classList.add('active');
                    }
                } else {
                    // Stopping rhythm
                    rhythmIntegration.stop();
                    window.rhythmActive = false;
                    window.rhythmManuallyStoppedForCurrentAudio = true;
                    document.getElementById('rhythm-status').textContent = '‚ñ∂ START';
                    this.classList.remove('active');
                    this.classList.remove('pending');
                    
                    // Also stop any pending detection
                    if (mascot?.shapeMorpher) {
                        // Don't reset, just mark as manually stopped
                        console.log('üõë Rhythm sync stopped');
                    }
                }
            });
            
            document.getElementById('bpm-slider').addEventListener('input', function(e) {
                const bpm = parseInt(e.target.value);
                document.getElementById('bpm-value').textContent = bpm;
                if (window.rhythmActive) {
                    rhythmIntegration.setBPM(bpm);
                }
            });
            
            document.getElementById('record-btn').addEventListener('click', function() {
                isRecording = !isRecording;
                this.innerHTML = isRecording ? '‚èπ Stop' : 'üî¥ Record';
                this.classList.toggle('active', isRecording);
                this.setAttribute('aria-pressed', isRecording ? 'true' : 'false');
                if (isRecording) mascot.startRecording(); else mascot.stopRecording();
            });

            
            // Random emotion dice
            document.getElementById('randomize-btn').addEventListener('click', () => {
                const emotions = Array.from(document.querySelectorAll('.emotion-btn')).map(b => b.dataset.emotion);
                const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                document.querySelector(`.emotion-btn[data-emotion="${randomEmotion}"]`).click();
            });
            
            // Random undertone dice
            document.getElementById('randomize-undertone-btn').addEventListener('click', () => {
                const undertones = Array.from(document.querySelectorAll('.undertone-btn')).map(b => b.dataset.undertone);
                const randomUndertone = undertones[Math.floor(Math.random() * undertones.length)];
                document.querySelector(`.undertone-btn[data-undertone="${randomUndertone}"]`).click();
            });
            
            // Random shape dice
            document.getElementById('randomize-shape-btn').addEventListener('click', () => {
                const shapes = Array.from(document.querySelectorAll('.shape-btn')).map(b => b.dataset.shape);
                const randomShape = shapes[Math.floor(Math.random() * shapes.length)];
                document.querySelector(`.shape-btn[data-shape="${randomShape}"]`).click();
            });
            
            // Random gesture dice
            document.getElementById('randomize-gesture-btn').addEventListener('click', () => {
                const gestures = Array.from(document.querySelectorAll('.gesture-btn')).map(b => b.dataset.gesture);
                const randomGesture = gestures[Math.floor(Math.random() * gestures.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomGesture}"]`).click();
            });
            
            // Random chain dice
            document.getElementById('randomize-chain-btn').addEventListener('click', () => {
                const chains = Array.from(document.querySelectorAll('.chain-btn')).map(b => b.dataset.chain);
                const randomChain = chains[Math.floor(Math.random() * chains.length)];
                document.querySelector(`.chain-btn[data-chain="${randomChain}"]`).click();
            });
            
            // Random dance dice
            document.getElementById('randomize-dance-btn').addEventListener('click', () => {
                const danceGestures = ['bounce', 'sway', 'headBob', 'wiggle', 'spin', 'hula', 'orbit', 'groove', 'jump'];
                const randomDance = danceGestures[Math.floor(Math.random() * danceGestures.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomDance}"]`).click();
            });
            
            // Master dice - roll everything!
            document.getElementById('randomize-all-btn').addEventListener('click', () => {
                // Trigger all individual dice with a slight delay for visual effect
                document.getElementById('randomize-btn').click();
                setTimeout(() => document.getElementById('randomize-undertone-btn').click(), 100);
                setTimeout(() => document.getElementById('randomize-shape-btn').click(), 200);
                setTimeout(() => document.getElementById('randomize-gesture-btn').click(), 300);
            });
            
            // Shape morphing controls
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const shape = btn.dataset.shape;
                    const mode = 'hybrid'; // Default to hybrid mode
                    
                    if (mascot) {
                        // Visual feedback
                        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Morph to new shape
                        console.log(`Morphing to shape: ${shape}, mode: ${mode}`);
                        mascot.morphTo(shape, {
                            duration: window.rhythmActive ? 'bar' : 1000, // Musical time if rhythm active
                            mode: mode,
                            onBeat: window.rhythmActive
                        });
                    }
                });
            });
            
            // Audio controls
            const audioFile = document.getElementById('audio-file');
            const audioPlayer = document.getElementById('audio-player');
            let micActive = false;
            
            // Set up audio player event listeners once
            audioPlayer.addEventListener('play', async () => {
                if (mascot) {
                    // Reset music detection when audio starts playing
                    if (mascot.shapeMorpher) {
                        mascot.shapeMorpher.resetMusicDetection();
                        // Clear the manual stop flag so rhythm can auto-start
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                    }
                    
                    // Resume audio context if suspended
                    if (mascot.audioAnalyzer && mascot.audioAnalyzer.audioContext) {
                        await mascot.audioAnalyzer.resume();
                    }
                    mascot.connectAudio(audioPlayer);
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
            });
            
            audioPlayer.addEventListener('ended', () => {
                if (mascot) {
                    mascot.disconnectAudio();
                }
            });
            
            // Handle both audio button sets
            ['load-audio-btn', 'load-audio-btn2'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        audioFile.click();
                    });
                }
            });
            
            audioFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    audioPlayer.src = url;
                    document.getElementById('audio-player-container').style.display = 'block';
                    document.getElementById('audio-player-container2').style.display = 'block';
                }
            });
            
            // Load Electric Glow button - both buttons
            ['load-song-btn', 'load-song-btn2'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        audioPlayer.src = 'assets/Electric Glow (Remix).wav';
                        document.getElementById('audio-player-container').style.display = 'block';
                        document.getElementById('audio-player-container2').style.display = 'block';
                    });
                }
            });
            
            // Mic button - both buttons
            ['mic-btn', 'mic-btn2'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', async () => {
                if (!micActive) {
                    try {
                        if (!mascot) {
                            console.error('Mascot not initialized');
                            alert('Engine not initialized. Please wait for the page to fully load.');
                            return;
                        }
                        
                        console.log('Attempting to connect microphone...');
                        await mascot.connectMicrophone();
                        micActive = true;
                        // Update both mic buttons
                        ['mic-btn', 'mic-btn2'].forEach(btnId => {
                            const micBtn = document.getElementById(btnId);
                            if (micBtn) {
                                micBtn.textContent = 'Stop Microphone';
                                micBtn.classList.add('active');
                            }
                        });
                        // Reset manual stop flag when switching to microphone
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                        console.log('Microphone connected successfully');
                    } catch (error) {
                        console.error('Microphone error:', error);
                        alert('Microphone access failed: ' + error.message);
                    }
                } else {
                    if (mascot) {
                        mascot.disconnectAudio();
                        micActive = false;
                        // Update both mic buttons
                        ['mic-btn', 'mic-btn2'].forEach(btnId => {
                            const micBtn = document.getElementById(btnId);
                            if (micBtn) {
                                micBtn.textContent = 'Use Microphone';
                                micBtn.classList.remove('active');
                            }
                        });
                        console.log('Microphone disconnected');
                    }
                }
                    });
                }
            });
        }

        function updateDisplay() {
            document.getElementById('emotion-display').textContent = `EMOTION: ${currentEmotion.toUpperCase()}`;
            document.getElementById('undertone-display').textContent = currentUndertone.toUpperCase() || 'STABLE';
        }
        
        let lastFPSValue = -1;
        function updateFPS() {
            if (!showingFPS || !mascot) return;
            
            const metrics = mascot.getPerformanceMetrics();
            const fps = Math.round(metrics.fps || 0);
            
            // Only update DOM if value changed
            if (fps !== lastFPSValue) {
                document.getElementById('fps-value').textContent = fps;
                lastFPSValue = fps;
            }
            
            // Continue updating while showing FPS
            requestAnimationFrame(updateFPS);
        }

        // Wait for DOM to be ready before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => init().catch(console.error));
        } else {
            // DOM is already ready
            init().catch(console.error);
        }
    </script>
</body>
</html>