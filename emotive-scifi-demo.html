<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMOTIVE A.I. Core - Neural Interface</title>
    <link rel="icon" type="image/svg+xml" href="assets/emotive-engine-icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --blur-strength: 16px;
            --control-width: clamp(240px, 30vw, 320px);
            --gap: 20px;
        }

        /* 1. Base Reset & Typography */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0e1a;
            background-image:
                linear-gradient(rgba(0, 229, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        /* 2. Main Layout Structure (Mobile First) */
        body {
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100%;
        }
        .center-container {
            order: 1;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .controls-left { order: 2; background-color: #0a0e1a; }
        .controls-right { order: 3; background-color: #0a0e1a; }

        /* 3. Central Display Unit */
        .display-and-controls {
            display: flex;
            flex-direction: column;
        }
        .display-container {
            width: 100%;
            aspect-ratio: 1 / 1; /* Always square */
            position: relative;
            background: rgba(10, 14, 26, 0.25);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
        }
        .display-content {
            width: 100%; height: 100%; position: relative;
            overflow: hidden; background: rgba(0, 0, 0, 0.3);
        }
        .system-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
            height: 60px;
            background: rgba(5, 21, 63, 0.95);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        /* 4. Control Panels & Buttons */
        .control-section { padding: 15px; }
        .control-section h3 {
            color: rgba(0, 229, 255, 0.9); font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 10px; padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 229, 255, 0.2);
        }
        .sci-fi-btn {
            width: 100%; padding: 8px; margin: 4px 0;
            background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 229, 255, 0.3);
            color: rgba(255, 255, 255, 0.8); border-radius: 4px; cursor: pointer;
            transition: all 0.2s; font-family: 'Chakra Petch', sans-serif;
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
        }
        .sci-fi-btn:hover {
            background: rgba(0, 229, 255, 0.1); border-color: rgba(0, 229, 255, 0.6);
            color: #00e5ff; box-shadow: 0 0 10px rgba(0, 229, 255, 0.4);
        }
        .sci-fi-btn.active {
            background: rgba(0, 229, 255, 0.2); border-color: rgba(0, 229, 255, 0.8);
            color: #00e5ff; box-shadow: 0 0 15px rgba(0, 229, 255, 0.6);
        }
        .sci-fi-btn.gesture-pending {
            animation: pending-pulse 0.5s infinite;
            border-color: rgba(255, 200, 0, 0.6);
            color: rgba(255, 200, 0, 0.8);
        }
        .sci-fi-btn.gesture-triggered {
            animation: trigger-flash 0.2s;
            background: rgba(0, 255, 100, 0.3) !important;
            border-color: rgba(0, 255, 100, 0.8) !important;
            color: #00ff64 !important;
        }
        @keyframes pending-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes trigger-flash {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 100, 0.6); }
            100% { transform: scale(1); }
        }
        .btn-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; }
        
        /* 5. Holo Effects & Decorations */
        .holo-element { position: absolute; pointer-events: none; }
        .corner-bracket { z-index: 50; width: 40px; height: 40px; }
        .corner-bracket::before, .corner-bracket::after { content: ''; position: absolute; background-color: rgba(0, 229, 255, 0.8); animation: subtle-glow 4s infinite ease-in-out; }
        .top-left { top: 0; left: 0; } .top-left::before { height: 4px; width: 100%; } .top-left::after { width: 4px; height: 100%; }
        .top-right { top: 0; right: 0; } .top-right::before { height: 4px; width: 100%; } .top-right::after { width: 4px; height: 100%; right: 0; }
        .bottom-left { bottom: 0; left: 0; } .bottom-left::before { height: 4px; width: 100%; bottom: 0; } .bottom-left::after { width: 4px; height: 100%; }
        .bottom-right { bottom: 0; right: 0; } .bottom-right::before { height: 4px; width: 100%; bottom: 0; } .bottom-right::after { width: 4px; height: 100%; right: 0; }
        .holo-circle { z-index: 5; border: 2px solid; border-radius: 50%; animation: rotate 80s infinite linear; aspect-ratio: 1 / 1; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-1 { width: 90%; border-color: rgba(0, 229, 255, 0.15); border-style: dotted; }
        .circle-2 { width: 80%; border-color: rgba(0, 229, 255, 0.2); animation-direction: reverse; animation-duration: 15s; }
        .info-display { z-index: 200; bottom: 25px; left: 25px; font-family: 'Chakra Petch', sans-serif; font-size: 1rem; width: calc(100% - 50px); display: flex; justify-content: space-between; align-items: center; }
        .info-display > .status-text { animation: subtle-glow-cyan 4s infinite ease-in-out; text-transform: uppercase; }
        .info-display > .undertone-text { background: rgba(0, 0, 0, 0.4); border: 1px solid #2c303a; padding: 4px 12px; border-radius: 4px; color: #ccc; font-size: 0.85rem; text-transform: uppercase; }
        .status-indicator, .fps-display { z-index: 200; position: absolute; top: 25px; right: 25px; font-family: 'Chakra Petch', sans-serif; font-size: 0.75rem; color: rgba(0, 229, 255, 0.9); }
        .fps-display { background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(0, 229, 255, 0.3); padding: 8px 12px; border-radius: 4px; display: none; text-align: right; line-height: 1.4; }
        .fps-display.active { display: block; } .fps-display .fps-value { font-size: 1.2rem; font-weight: bold; }

        /* 6. Desktop Layout Overrides */
        @media (min-width: 1025px) {
            body { overflow: hidden; }
            .main-layout {
                flex-direction: row;
                height: 100vh;
                padding: var(--gap);
                gap: var(--gap);
            }
            .center-container {
                order: 0; /* Reset order */
                position: relative;
                flex: 1;
                min-width: 0;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .controls-left, .controls-right {
                order: 0; /* Reset order */
                width: var(--control-width);
                flex-shrink: 0;
                height: 100%;
                overflow-y: auto;
                background-color: rgba(10, 14, 26, 0.95);
            }
            .display-and-controls {
                /* Size is constrained by height, and width matches to stay square */
                height: 100%;
                width: 100%;
                max-height: 800px;
                max-width: 800px; /* Set a reasonable max size */
            }
            .display-container {
                flex-grow: 1; /* Allow frame to fill available space in parent */
                min-height: 0; /* Fix flexbox overflow bug */
            }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .controls-left::-webkit-scrollbar, .controls-right::-webkit-scrollbar { width: 8px; }
            .controls-left::-webkit-scrollbar-track, .controls-right::-webkit-scrollbar-track { background: rgba(0, 229, 255, 0.1); }
            .controls-left::-webkit-scrollbar-thumb, .controls-right::-webkit-scrollbar-thumb { background: rgba(0, 229, 255, 0.3); border-radius: 4px; }
        }

        /* 7. Animations (Keep as is) */
        #emotive-canvas { 
            display: block; 
            position: absolute; 
            z-index: 10; 
            width: 100%; 
            height: 100%; 
            top: 0;
            left: 0;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.8; transform: scale(1); box-shadow: 0 0 10px rgba(0, 229, 255, 0.7); } 50% { opacity: 1; transform: scale(1.02); box-shadow: 0 0 15px rgba(0, 229, 255, 0.9); } }
        @keyframes subtle-glow { 0%, 100% { background-color: rgba(0, 229, 255, 0.7); } 50% { background-color: #00e5ff; } }
        @keyframes subtle-glow-cyan { 0%, 100% { color: rgba(0, 229, 255, 0.8); text-shadow: 0 0 5px rgba(0, 229, 255, 0.6); } 50% { color: #00e5ff; text-shadow: 0 0 8px #00e5ff; } }
        @keyframes rotate { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .collapsible .collapse-indicator { transition: transform 0.3s; font-size: 0.8rem; }
        .collapsible.collapsed .collapse-indicator { transform: rotate(-90deg); }
        .collapsible .section-content { max-height: 500px; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible.collapsed .section-content { max-height: 0; }
    </style>
</head>
<body>
    <div class="main-layout">
        
        <div class="controls-left">
            <div class="control-section">
                <h3>Emotion Matrix</h3>
                <div class="btn-group">
                    <button class="sci-fi-btn emotion-btn active" data-emotion="neutral">Neutral</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="joy">Joy</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="sadness">Sadness</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="anger">Anger</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="fear">Fear</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="surprise">Surprise</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="disgust">Disgust</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="love">Love</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="euphoria">Euphoria</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="excited">Excited</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="suspicion">Suspicion</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="resting">Resting</button>
                </div>
            </div>
            <div class="control-section">
                <h3>Undertone Modifier</h3>
                <div class="btn-group">
                    <button class="sci-fi-btn undertone-btn" data-undertone="nervous">Nervous</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="intense">Intense</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="tired">Tired</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="confident">Confident</button>
                    <button class="sci-fi-btn undertone-btn" data-undertone="subdued">Subdued</button>
                    <button class="sci-fi-btn undertone-btn active" data-undertone="">Clear</button>
                </div>
            </div>
        </div>

        <div class="center-container">
            <div class="display-and-controls">
                <div id="display-container" class="display-container">
                    <div class="display-content">
                        <canvas id="emotive-canvas"></canvas>
                        <div style="position: absolute; top: 20px; left: 20px; z-index: 100; opacity: 0.33;">
                            <img src="assets/emotive-engine-full-BW.svg" alt="Emotive Engine" style="height: 40px; filter: brightness(0) invert(1);">
                        </div>
                        <div class="holo-element corner-bracket top-left"></div>
                        <div class="holo-element corner-bracket top-right"></div>
                        <div class="holo-element corner-bracket bottom-left"></div>
                        <div class="holo-element corner-bracket bottom-right"></div>
                        <div class="holo-element holo-circle circle-1"></div>
                        <div class="holo-element holo-circle circle-2"></div>
                        <div class="holo-element info-display">
                            <div class="status-text" id="emotion-display">EMOTION: NEUTRAL</div>
                            <div class="undertone-text" id="undertone-display">STABLE</div>
                        </div>
                        <div class="fps-display" id="fps-display">
                            <span class="fps-value" id="fps-value">0</span>
                            <span class="fps-label">FPS</span>
                        </div>
                        <div class="status-indicator" id="status-indicator">NEURAL CORE: ONLINE</div>
                    </div>
                </div>
                <div class="system-controls">
                    <button class="sci-fi-btn" id="fps-toggle">Show FPS</button>
                    <button class="sci-fi-btn" id="record-btn">Record</button>
                    <button class="sci-fi-btn" id="randomize-btn">Randomize</button>
                    <button class="sci-fi-btn" id="reset-btn">Reset</button>
                </div>
            </div>
        </div>

        <div class="controls-right">
            <div class="control-section">
                <h3>Rhythm Sync Module</h3>
                <div class="rhythm-controls">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="sci-fi-btn" id="rhythm-toggle" style="flex: 1;">
                            <span id="rhythm-status">▶ START</span>
                        </button>
                        <div id="beat-indicator" style="width: 30px; height: 30px; border: 1px solid rgba(0, 229, 255, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div id="beat-dot" style="width: 10px; height: 10px; background: rgba(0, 229, 255, 0.5); border-radius: 50%; transition: all 0.1s;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="color: rgba(0, 229, 255, 0.7); font-size: 0.7rem; display: block; margin-bottom: 5px;">BPM: <span id="bpm-value">120</span></label>
                        <input type="range" id="bpm-slider" min="60" max="180" value="120" style="width: 100%; accent-color: #00e5ff;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="color: rgba(0, 229, 255, 0.7); font-size: 0.7rem; display: block; margin-bottom: 5px;">PATTERN</label>
                        <select id="pattern-select" class="sci-fi-btn" style="width: 100%; padding: 5px; font-size: 0.8rem;">
                            <option value="straight">Straight</option>
                            <option value="swing">Swing</option>
                            <option value="breakbeat">Breakbeat</option>
                            <option value="dubstep">Dubstep</option>
                            <option value="four-on-floor">Four on Floor</option>
                        </select>
                    </div>
                    <div class="btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <button class="sci-fi-btn rhythm-preset" data-preset="ambient" style="font-size: 0.7rem;">Ambient</button>
                        <button class="sci-fi-btn rhythm-preset" data-preset="electronic" style="font-size: 0.7rem;">Electronic</button>
                        <button class="sci-fi-btn rhythm-preset" data-preset="jazz" style="font-size: 0.7rem;">Jazz</button>
                        <button class="sci-fi-btn rhythm-preset" data-preset="dnb" style="font-size: 0.7rem;">Drum & Bass</button>
                    </div>
                </div>
            </div>
            <div class="control-section">
                <h3>Gesture Protocol</h3>
                <div class="btn-group">
                    <button class="sci-fi-btn gesture-btn" data-gesture="bounce">Bounce</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="pulse">Pulse</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="shake">Shake</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="spin">Spin</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="nod">Nod</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="wave">Wave</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="breathe">Breathe</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="tilt">Tilt</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="expand">Expand</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="contract">Contract</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="flash">Flash</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="drift">Drift</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="stretch">Stretch</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="glow">Glow</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="flicker">Flicker</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="vibrate">Vibrate</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="morph">Morph</button>
                    <button class="sci-fi-btn gesture-btn" data-gesture="jump">Jump</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Import the real EmotiveEngine
        import EmotiveEngine from './src/EmotiveMascot.js?v=2.1.0';
        import rhythmIntegration from './src/core/rhythmIntegration.js';
        import rhythmEngine from './src/core/rhythm.js';
        import GestureScheduler from './src/core/GestureScheduler.js';

        let mascot;
        let gestureScheduler;
        let currentEmotion = 'neutral';
        let currentUndertone = '';
        let showingFPS = false;
        let isRecording = false;
        let rhythmActive = false;
        
        // Rhythm presets for different music genres
        const rhythmPresets = {
            ambient: { 
                bpm: 70, 
                pattern: 'straight', 
                emotions: ['zen', 'serene', 'neutral'],
                gestures: ['breathe', 'float', 'drift']
            },
            electronic: { 
                bpm: 128, 
                pattern: 'four-on-floor', 
                emotions: ['energetic', 'excited', 'euphoria'],
                gestures: ['pulse', 'flash', 'vibrate']
            },
            jazz: { 
                bpm: 120, 
                pattern: 'swing', 
                emotions: ['joy', 'playful', 'curious'],
                gestures: ['sway', 'bounce', 'tilt']
            },
            dnb: { 
                bpm: 174, 
                pattern: 'breakbeat', 
                emotions: ['excited', 'energetic', 'intense'],
                gestures: ['shake', 'jitter', 'twitch']
            }
        };

        async function init() {
            mascot = new EmotiveEngine({
                canvasId: 'emotive-canvas',
                startingEmotion: 'neutral',
                emotionalResponsiveness: 0.8,
                particleIntensity: 1.0,
                glowIntensity: 0.8,
                audioEnabled: false,
                showFPS: false,
                debugMode: false,
                renderMode: 'default',
                maxParticles: 100
            });
            mascot.start();
            
            // Initialize rhythm system
            rhythmIntegration.initialize();
            
            // Initialize gesture scheduler
            gestureScheduler = new GestureScheduler(mascot);
            
            // Setup scheduler callbacks for visual feedback
            gestureScheduler.onGestureQueued = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.add('gesture-pending');
                }
            };
            
            gestureScheduler.onGestureTriggered = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.remove('gesture-pending');
                    btn.classList.add('gesture-triggered');
                    setTimeout(() => btn.classList.remove('gesture-triggered'), 200);
                }
            };
            
            // Setup beat indicator
            rhythmEngine.on('beat', (beatInfo) => {
                if (rhythmActive) {
                    const beatDot = document.getElementById('beat-dot');
                    beatDot.style.width = '20px';
                    beatDot.style.height = '20px';
                    beatDot.style.background = 'rgba(0, 229, 255, 1)';
                    beatDot.style.boxShadow = '0 0 20px rgba(0, 229, 255, 0.8)';
                    setTimeout(() => {
                        beatDot.style.width = '10px';
                        beatDot.style.height = '10px';
                        beatDot.style.background = 'rgba(0, 229, 255, 0.5)';
                        beatDot.style.boxShadow = 'none';
                    }, 100);
                }
            });
            
            setupEventHandlers();
            setupRhythmControls();
            updateDisplay();
            
            // Start with ambient preset by default
            setTimeout(() => {
                // Set ambient preset values
                const ambientPreset = rhythmPresets.ambient;
                document.getElementById('bpm-slider').value = ambientPreset.bpm;
                document.getElementById('bpm-value').textContent = ambientPreset.bpm;
                document.getElementById('pattern-select').value = ambientPreset.pattern;
                
                // Mark ambient preset as active
                document.querySelector('.rhythm-preset[data-preset="ambient"]').classList.add('active');
                
                // Start rhythm in ambient mode
                startRhythm();
                
                // Trigger a gentle breathing gesture through scheduler
                setTimeout(() => {
                    gestureScheduler.requestGesture('breathe');
                }, 500);
            }, 1000); // Wait a second for everything to initialize
        }
        
        function startRhythm() {
            const bpm = document.getElementById('bpm-slider').value;
            const pattern = document.getElementById('pattern-select').value;
            rhythmIntegration.start(parseInt(bpm), pattern);
            rhythmActive = true;
            document.getElementById('rhythm-status').textContent = '■ STOP';
            document.getElementById('rhythm-toggle').classList.add('active');
            
            // Trigger a rhythm-appropriate gesture through scheduler
            const rhythmGestures = ['pulse', 'bounce', 'sway', 'float'];
            const randomGesture = rhythmGestures[Math.floor(Math.random() * rhythmGestures.length)];
            gestureScheduler.requestGesture(randomGesture);
        }
        
        function stopRhythm() {
            rhythmIntegration.stop();
            rhythmActive = false;
            document.getElementById('rhythm-status').textContent = '▶ START';
            document.getElementById('rhythm-toggle').classList.remove('active');
        }
        
        function setupRhythmControls() {
            // Rhythm toggle button
            document.getElementById('rhythm-toggle').addEventListener('click', () => {
                if (rhythmActive) {
                    stopRhythm();
                } else {
                    startRhythm();
                }
            });
            
            // BPM slider
            const bpmSlider = document.getElementById('bpm-slider');
            const bpmValue = document.getElementById('bpm-value');
            bpmSlider.addEventListener('input', (e) => {
                bpmValue.textContent = e.target.value;
                if (rhythmActive) {
                    rhythmIntegration.setBPM(parseInt(e.target.value));
                }
            });
            
            // Pattern selector
            document.getElementById('pattern-select').addEventListener('change', (e) => {
                if (rhythmActive) {
                    rhythmIntegration.setPattern(e.target.value);
                }
            });
            
            // Preset buttons
            document.querySelectorAll('.rhythm-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = rhythmPresets[btn.dataset.preset];
                    if (preset) {
                        // Apply preset settings
                        document.getElementById('bpm-slider').value = preset.bpm;
                        document.getElementById('bpm-value').textContent = preset.bpm;
                        document.getElementById('pattern-select').value = preset.pattern;
                        
                        // Set a matching emotion
                        const randomEmotion = preset.emotions[Math.floor(Math.random() * preset.emotions.length)];
                        const emotionBtn = document.querySelector(`.emotion-btn[data-emotion="${randomEmotion}"]`);
                        if (emotionBtn) emotionBtn.click();
                        
                        // Start rhythm if not already running
                        if (!rhythmActive) {
                            startRhythm();
                        } else {
                            rhythmIntegration.setBPM(preset.bpm);
                            rhythmIntegration.setPattern(preset.pattern);
                        }
                        
                        // Trigger a matching gesture
                        const randomGesture = preset.gestures[Math.floor(Math.random() * preset.gestures.length)];
                        mascot.express(randomGesture);
                        
                        // Visual feedback
                        document.querySelectorAll('.rhythm-preset').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            });
        }

        function setupEventHandlers() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentEmotion = btn.dataset.emotion;
                    mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                    document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateDisplay();
                });
            });

            document.querySelectorAll('.gesture-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (rhythmActive) {
                        // Use scheduler when rhythm is active
                        gestureScheduler.requestGesture(btn.dataset.gesture);
                    } else {
                        // Direct trigger when rhythm is off
                        mascot.express(btn.dataset.gesture);
                    }
                });
            });

            document.querySelectorAll('.undertone-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentUndertone = btn.dataset.undertone;
                    mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                    document.querySelectorAll('.undertone-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateDisplay();
                });
            });

            document.getElementById('fps-toggle').addEventListener('click', function() {
                showingFPS = !showingFPS;
                document.getElementById('fps-display').classList.toggle('active', showingFPS);
                this.textContent = showingFPS ? 'Hide FPS' : 'Show FPS';
            });
            
            document.getElementById('record-btn').addEventListener('click', function() {
                isRecording = !isRecording;
                this.textContent = isRecording ? 'Stop' : 'Record';
                this.classList.toggle('active', isRecording);
                if (isRecording) mascot.startRecording(); else mascot.stopRecording();
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                currentEmotion = 'neutral';
                currentUndertone = '';
                mascot.setEmotion('neutral');
                document.querySelectorAll('.emotion-btn, .undertone-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.emotion-btn[data-emotion="neutral"]').classList.add('active');
                document.querySelector('.undertone-btn[data-undertone=""]').classList.add('active');
                updateDisplay();
            });
            
            document.getElementById('randomize-btn').addEventListener('click', () => {
                const emotions = Array.from(document.querySelectorAll('.emotion-btn')).map(b => b.dataset.emotion);
                const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                document.querySelector(`.emotion-btn[data-emotion="${randomEmotion}"]`).click();
            });
        }

        function updateDisplay() {
            document.getElementById('emotion-display').textContent = `EMOTION: ${currentEmotion.toUpperCase()}`;
            document.getElementById('undertone-display').textContent = currentUndertone.toUpperCase() || 'STABLE';
        }

        init().catch(console.error);
    </script>
</body>
</html>