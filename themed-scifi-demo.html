<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMOTIVE A.I. Core - Neural Interface</title>
    <link rel="icon" type="image/svg+xml" href="assets/emotive-engine-icon.svg">
    <!-- Google Fonts for Poppins and Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Z-index system for layering */
        :root {
            /* Z-index levels */
            --z-base: 1;
            --z-dropdown: 5;
            --z-menu: 10;
            --z-overlay: 100;
            --z-modal: 999;
            --z-header: 1000;
            --z-system: 2000;
            --z-max: 9999;
        }

        :root {
            --blur-strength: 16px;
            --control-width: clamp(240px, 30vw, 320px);
            --gap: 20px;

            /* Typography */
            --font-primary: 'Poppins', sans-serif;
            --font-heading: 'Montserrat', sans-serif;

            /* Font Sizes */
            --text-xs: 0.65rem;
            --text-sm: 0.75rem;
            --text-base: 0.85rem;
            --text-md: 1rem;
            --text-lg: 1.2rem;
            --text-xl: 1.5rem;
            --text-2xl: 2rem;

            /* Calculated Font Sizes */
            --text-xl-plus-1: calc(var(--text-xl) + 0.1rem);
            --text-xl-plus-2: calc(var(--text-xl) + 0.2rem);
            --text-xl-plus-3: calc(var(--text-xl) + 0.3rem);
            --text-2xl-plus-2: calc(var(--text-2xl) + 0.2rem);
            --text-md-plus-1: calc(var(--text-md) + 0.1rem);
            --text-sm-plus: calc(var(--text-sm) + 0.05rem);
            --text-base-plus: calc(var(--text-base) + 0.05rem);

            /* Font Weights */
            --font-light: 300;
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Border Radius */
            --radius-sm: 2px;
            --radius-base: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 15px;
            --radius-round: 50%;

            /* Common Spacing */
            --spacing-xs: 2px;
            --spacing-sm: 4px;
            --spacing-base: 8px;
            --spacing-md: 10px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;

            /* Letter Spacing */
            --spacing-letter-tight: 0.3px;
            --spacing-letter-normal: 0.5px;
            --spacing-letter-wide: 1px;
            --spacing-letter-wider: 2px;
            --spacing-letter-widest: 4px;

            /* Line Height */
            --line-height-tight: 1.2;
            --line-height-normal: 1.4;
            --line-height-relaxed: 1.6;
            --line-height-loose: 1.8;

            /* Common Dimensions */
            --size-full: 100%;
            --size-half: 50%;
            --size-third: 33.333%;
            --size-quarter: 25%;
            --size-min-button: 40px;
            --size-icon-sm: 28px;
            --size-icon-base: 30px;
            --size-icon-md: 32px;
            --size-icon-lg: 42px;
            --size-icon-xl: 52px;
            --size-thumb-wide: 160px;
            --size-bar-height: 50px;
            --size-bar-mobile: 40px;
            --size-track: 10px;
            --size-divider: 2px;
            --size-thumb: 30px;
            --size-btn-sm: 28px;
            --size-btn-base: 40px;
            --size-corner: 4px;
            --size-logo: 16px;
            --size-badge: 24px;

            /* Common Layout Positions */
            --pos-footer: 45px;
            --pos-footer-landscape: 32px;
            --pos-menu-landscape: 180px;
            --pos-hero: 76px;
            --pos-hero-mobile: 58px;
            --pos-content-top: 70px;
            --pos-hero-rotation: 126px;
            --pos-hero-rotation-mobile: 98px;
            --pos-controls-bottom: 140px;
            --pos-edge-sm: 5px;
            --pos-edge-md: 10px;
            --pos-edge-lg: 25px;
            --pos-info-bottom: 60px;

            /* Common Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.3s ease;
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-spring: 0.6s cubic-bezier(0.23, 1, 0.32, 1);

            /* Animation Durations */
            --anim-pulse: 2s infinite;
            --anim-rotate-slow: 80s infinite linear;
            --anim-rotate-fast: 15s infinite linear;
            --anim-glow: 4s infinite ease-in-out;
            --anim-flash: 0.2s;
            --anim-fade: 0.6s ease-in-out;

            /* Backdrop Filters */
            --blur-light: blur(8px);
            --blur-medium: blur(12px);
            --blur-heavy: blur(20px);
            --blur-glass: blur(20px) saturate(1.8);

            /* Common Gradients */
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-red-dark: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            --gradient-amber: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --gradient-cyan: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 255, 0.1));
            --gradient-slider: linear-gradient(to right, #ef4444 0%, #ef4444 45%, #666666 45%, #666666 55%, #4ade80 55%, #4ade80 100%);
        }

        /* Theme Variables - Light Theme (CAN have blue) */
        .light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-grid: rgba(0, 0, 0, 0.05);
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-primary: #007acc;
            --accent-glow: #0099ff;
            --border-color: rgba(0, 122, 204, 0.3);
            --panel-bg: transparent;
            --button-bg: rgba(255, 255, 255, 0.8);
            --button-hover: rgba(0, 122, 204, 0.1);
            --canvas-bg: rgba(242, 241, 241, 0.3);
            --canvas-backdrop: rgba(255, 255, 255, 0.1);
            --system-bar-bg: rgba(255, 255, 255, 0.95);
            --system-bar-border: rgba(0, 122, 204, 0.2);
            --system-btn-bg: rgba(245, 245, 245, 0.9);
            --system-btn-hover: rgba(0, 122, 204, 0.15);

            /* Additional opacity variations */
            --opacity-subtle: 0.05;
            --opacity-light: 0.1;
            --opacity-soft: 0.15;
            --opacity-medium: 0.3;
            --opacity-strong: 0.5;
            --opacity-heavy: 0.7;
            --opacity-solid: 0.9;
            --opacity-full: 0.95;

            /* Shadow colors */
            --shadow-light: rgba(0, 0, 0, 0.03);
            --shadow-medium: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);

            /* Box Shadow Patterns */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
            --shadow-base: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 2px 10px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 2px 20px rgba(0, 0, 0, 0.5);
            --shadow-2xl: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.5);

            /* Common Border Styles */
            --border-thin: 1px solid var(--border-color);
            --border-medium: 2px solid var(--border-color);
            --border-accent: 2px solid var(--accent-primary);
            --border-subtle: 1px solid rgba(0, 122, 204, 0.2);
            --border-strong: 2px solid rgba(0, 122, 204, 0.5);
            --border-light: 1px solid rgba(0, 0, 0, 0.12);

            /* Special colors */
            --color-white-70: rgba(255, 255, 255, 0.7);
            --color-white-90: rgba(255, 255, 255, 0.9);
            --color-black-95: rgba(0, 0, 0, 0.95);
            --color-accent-amber: #fbbf24;
            --color-red-border: #dc2626;
            --color-orange-bright: #FF8A65;
            --color-orange-pale: #FFD4B8;
            --color-green-bright: #00ff64;
            --color-white-warm: #FFF5F0;
            --color-white-pure: #FEFEFE;

            /* Common Background Patterns */
            --bg-transparent: transparent;
            --bg-black-03: rgba(0, 0, 0, 0.03);
            --bg-black-04: rgba(0, 0, 0, 0.04);
            --bg-black-08: rgba(0, 0, 0, 0.08);
            --bg-black-10: rgba(0, 0, 0, 0.1);
            --bg-black-15: rgba(0, 0, 0, 0.15);
            --bg-black-30: rgba(0, 0, 0, 0.3);
            --bg-black-40: rgba(0, 0, 0, 0.4);
            --bg-black-60: rgba(0, 0, 0, 0.6);
            --bg-black-80: rgba(0, 0, 0, 0.8);
            --bg-black-90: rgba(0, 0, 0, 0.9);

            /* Common Opacity Values */
            --opacity-20: 0.2;
            --opacity-33: 0.33;
            --opacity-60: 0.6;
            --opacity-80: 0.8;

            /* Common Box Shadows */
            --shadow-glow-sm: 0 0 8px;
            --shadow-glow-md: 0 0 12px;
            --shadow-glow-lg: 0 0 20px;
            --shadow-glow-xl: 0 0 40px;
            --shadow-inset-sm: inset 0 0 6px;
            --shadow-inset-md: inset 0 0 10px;
            --shadow-depth-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-depth-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-depth-lg: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Dark Theme (CAN have blue) */
        .dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-grid: rgba(255, 255, 255, 0.05);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-primary: #00e5ff;
            --accent-glow: #00ccff;
            --border-color: rgba(0, 229, 255, 0.3);
            --panel-bg: transparent;
            --button-bg: rgba(0, 0, 0, 0.4);
            --button-hover: rgba(0, 229, 255, 0.1);
            --canvas-bg: rgba(0, 0, 0, 0.3);
            --system-bar-bg: rgba(0, 0, 0, 0.7);
            --system-bar-border: transparent;
            --system-btn-bg: rgba(0, 0, 0, 0.5);
            --system-btn-hover: rgba(0, 229, 255, 0.1);

            /* Shadow colors - dark theme */
            --shadow-light: rgba(255, 255, 255, 0.03);
            --shadow-medium: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);

            /* Special colors - dark theme */
            --color-white-70: rgba(255, 255, 255, 0.4);
            --color-white-90: rgba(255, 255, 255, 0.7);
            --color-black-95: rgba(0, 0, 0, 0.95);
            --color-accent-amber: #fbbf24;
        }

        /* Night Theme (NO BLUES - Burnt orange/copper accents) */
        .night {
            --bg-primary: #0E0E0E;  /* flex tape dark */
            --bg-secondary: #1A1A1A; /* slightly lighter dark */
            --bg-grid: rgba(204, 102, 51, 0.08); /* burnt orange grid */
            --text-primary: #FFF5F0; /* off-white with subtle orange tint */
            --text-secondary: rgba(255, 245, 240, 0.8); /* orange-tinted white */
            --accent-primary: #CC6633; /* burnt orange for frame borders - NO BLUES */
            --accent-glow: #E67E50;    /* slightly brighter for glow */
            --border-color: rgba(204, 102, 51, 0.3); /* burnt orange border for frame */
            --panel-bg: transparent; /* flex tape based */
            --button-bg: rgba(0, 0, 0, 0.4);
            --button-hover: rgba(255, 138, 101, 0.15); /* brighter orange hover */
            --canvas-bg: rgba(14, 14, 14, 0.3);
            --canvas-backdrop: rgba(0, 0, 0, 0.1);
            --system-bar-bg: rgba(0, 0, 0, 0.7);
            --system-bar-border: transparent;
            --system-btn-bg: rgba(0, 0, 0, 0.5);
            --system-btn-hover: rgba(255, 138, 101, 0.15);
        }

        /* 1. Base Reset & Typography */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { 
            width: var(--size-full);
            height: var(--size-full);
        }
        body { 
            width: var(--size-full);
            height: var(--size-full);
            min-height: 100vh;
        }
        
        /* Footer Styling - Subtle single line that pushes content */
        .legal-footer {
            background: var(--system-bar-bg);
            backdrop-filter: var(--blur-light);
            -webkit-backdrop-filter: var(--blur-light);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: var(--spacing-md) var(--spacing-xl);
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            color: var(--color-white-70);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: calc(var(--spacing-xl) * 2);
        }
        
        .legal-footer:hover {
            color: var(--color-white-90);
        }
        
        .footer-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .trademark {
            font-weight: var(--font-medium);
            opacity: var(--opacity-heavy);
            letter-spacing: var(--spacing-letter-normal);
        }
        
        .separator {
            opacity: var(--opacity-20);
            user-select: none; /* Prevent text selection */
            margin: 0 var(--spacing-base);
        }
        
        .copyright {
            opacity: var(--opacity-60);
            font-weight: var(--font-normal);
        }
        
        .footer-links {
            display: flex;
            gap: var(--spacing-xl);
        }
        
        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            opacity: var(--opacity-strong);
            transition: opacity var(--transition-base);
            font-size: var(--text-xs);
            letter-spacing: var(--spacing-letter-tight);
        }
        
        .footer-link:hover {
            opacity: var(--opacity-80);
        }
        
        /* Light theme footer */
        .light .legal-footer {
            background: rgba(255, 255, 255, var(--opacity-heavy));
            border-top: 1px solid rgba(0, 0, 0, var(--opacity-subtle));
            box-shadow: 0 -1px 5px var(--shadow-light);
        }
        
        /* Mobile responsive footer */
        @media (max-width: 768px) {
            .legal-footer {
                padding: var(--spacing-md) calc(var(--spacing-lg) - 1px);
                font-size: var(--text-xs);
            }
            
            .footer-content {
                justify-content: center;
                text-align: center;
            }
            
            .footer-text {
                justify-content: center;
            }
            
            .footer-links {
                width: var(--size-full);
                justify-content: center;
            }
            
            .separator {
                display: none;
            }
            
            .footer-text > * {
                margin: var(--spacing-xs) calc(var(--spacing-sm) + 1px);
            }
        }
        body {
            font-family: var(--font-primary);
            background-color: var(--bg-primary);
            background-image:
                linear-gradient(var(--bg-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
            background-size: 25px 25px;
            color: var(--text-primary);
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute;
            top: var(--pos-content-top);
            right: var(--spacing-xl);
            z-index: var(--z-overlay);
            width: var(--size-icon-base);
            height: var(--size-icon-base);
            background: var(--bg-transparent);
            cursor: pointer;
            pointer-events: auto; /* Ensure theme switcher is clickable */
            transition: transform var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-switcher:hover {
            transform: scale(1.1);
        }

        .theme-icon {
            width: var(--size-icon-md);
            height: var(--size-icon-md);
            transition: transform var(--transition-slow);
            opacity: var(--opacity-33);
        }

        .theme-switcher:hover .theme-icon {
            transform: rotate(360deg);
            opacity: 1;
        }

        /* Skip Navigation Link - WCAG 2.1 AA */
        .skip-nav {
            position: absolute;
            left: -9999px;
            z-index: var(--z-modal);
            padding: calc(var(--spacing-lg) * 1.2);
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            border: var(--border-accent);
            border-radius: var(--radius-base);
        }
        
        .skip-nav:focus {
            left: 50%;
            top: var(--spacing-xl);
            transform: translateX(-50%);
        }

        /* Hero spacer to push content below fixed hero bar */
        .hero-spacer {
            height: var(--pos-hero-rotation); /* 76px hero + 50px rotation bar */
            flex-shrink: 0;
        }

        /* Rotation control bar - only spans center area */
        .rotation-control-bar {
            position: fixed;
            top: var(--pos-hero); /* Right below hero bar */
            left: var(--control-width); /* Start after left menu */
            right: var(--control-width); /* End before right menu */
            width: auto;
            height: var(--size-bar-height);
            background: var(--color-black-95);
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
            z-index: var(--z-modal);
            /* Removed borders for cleaner look */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile portrait - full width */
        @media (orientation: portrait) and (max-width: 480px) {
            .rotation-control-bar {
                top: var(--pos-hero-mobile); /* Below smaller mobile hero bar */
                left: 0;
                right: 0;
                width: var(--size-full);
                height: var(--size-bar-mobile); /* Smaller in mobile */
            }
        }

        /* Landscape mode adjustment */
        @media (orientation: landscape) and (max-height: 900px) {
            .rotation-control-bar {
                top: var(--pos-hero-mobile); /* Below smaller landscape hero bar */
                left: var(--pos-menu-landscape); /* Match landscape menu width */
                right: var(--pos-menu-landscape);
                height: var(--size-bar-mobile); /* Smaller in landscape */
            }
        }

        .rotation-control-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            width: 100%;
            padding: 0;
            position: relative;
        }

        .rotation-left-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-right: var(--spacing-xl);
        }

        .rotation-center-section {
            width: min(900px, 100vw - 40px); /* Match animation frame width */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }

        .rotation-right-section {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: calc(var(--spacing-lg) - 1px);
            padding-left: var(--spacing-xl);
        }

        .rotation-label-left,
        .rotation-label-right {
            color: var(--text-secondary);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wide);
            min-width: var(--size-min-button);
        }

        .rotation-label-left {
            text-align: right;
        }

        .rotation-slider-wrapper {
            width: 100%;
            position: relative;
            padding: 15px 0; /* Increase padding to ensure full thumb is clickable */
            overflow: visible;
            z-index: var(--z-menu);
        }

        .rotation-slider-full {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: var(--size-thumb); /* Increase height to match thumb */
            background: var(--bg-transparent);
            outline: none;
            position: relative;
            margin: 0;
            padding: 0;
            cursor: pointer;
            will-change: transform;
            transform: translateZ(0); /* Force GPU acceleration */
        }

        /* Slider track */
        .rotation-slider-full::-webkit-slider-runnable-track {
            width: 100%;
            height: var(--size-track);
            cursor: pointer;
            background: linear-gradient(to right,
                #ef4444 0%,     /* Red for CCW */
                #ef4444 45%,
                #666666 45%,        /* Gray center zone */
                #666666 55%,
                #4ade80 55%,     /* Green for CW */
                #4ade80 100%);
            border-radius: var(--radius-md);
            box-shadow: inset 0 2px 4px var(--shadow-dark),
                        inset 0 -1px 0 rgba(255, 255, 255, 0.1);
            margin-top: var(--spacing-md); /* Center track vertically in the 30px height */
        }

        .rotation-slider-full::-moz-range-track {
            width: 100%;
            height: var(--size-track);
            cursor: pointer;
            background: linear-gradient(to right,
                #ef4444 0%,
                #ef4444 45%,
                #666666 45%,
                #666666 55%,
                #4ade80 55%,
                #4ade80 100%);
            border-radius: var(--radius-md);
            box-shadow: inset 0 2px 4px var(--shadow-dark),
                        inset 0 -1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Slider thumb - Extra wide for easy clicking */
        .rotation-slider-full::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: var(--size-thumb-wide); /* Extra wide thumb */
            height: var(--size-thumb);
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(200, 200, 200, 0.8) 50%,
                rgba(150, 150, 150, 0.7) 100%);
            border: 2px solid rgba(255, 255, 255, var(--opacity-medium));
            border-radius: var(--radius-xl);
            cursor: grab;
            margin-top: -10px; /* Center thumb on track */
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all var(--transition-fast);
        }

        .rotation-slider-full::-moz-range-thumb {
            width: var(--size-thumb-wide);
            height: var(--size-thumb);
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(200, 200, 200, 0.8) 50%,
                rgba(150, 150, 150, 0.7) 100%);
            border: 2px solid rgba(255, 255, 255, var(--opacity-medium));
            border-radius: var(--radius-xl);
            cursor: grab;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all var(--transition-fast);
        }

        .rotation-slider-full:active::-webkit-slider-thumb {
            cursor: grabbing;
            transform: scale(0.98); /* Consistent active scale */
            box-shadow:
                0 1px 4px rgba(0, 0, 0, 0.5),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }

        .rotation-slider-full:active::-moz-range-thumb {
            cursor: grabbing;
            transform: scale(0.98); /* Consistent active scale */
            box-shadow:
                0 1px 4px rgba(0, 0, 0, 0.5),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }

        /* Center indicator line */
        .center-indicator {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: var(--size-divider);
            background: rgba(255, 255, 255, var(--opacity-strong));
            pointer-events: none;
            transform: translateX(-50%);
            z-index: var(--z-base);
        }

        /* Brake button */
        .rotation-brake-btn {
            padding: var(--spacing-base) var(--spacing-lg);
            background: var(--gradient-red-dark);
            color: white;
            border: 2px solid var(--color-red-border);
            border-radius: var(--radius-md);
            font-weight: var(--font-bold);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wide);
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: 0 2px 4px var(--shadow-medium);
        }

        .rotation-brake-btn:hover {
            background: var(--gradient-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* Keep unique */
        }

        .rotation-brake-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .rotation-brake-btn.braking {
            background: var(--gradient-amber);
            border-color: var(--color-accent-amber);
            animation: pulse-brake 1s infinite; /* Keep specific animation timing */
        }

        @keyframes pulse-brake {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Shape Controls Hero Bar */
        .shape-controls-hero {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--color-black-95);
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
            z-index: var(--z-header);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 20px var(--shadow-dark);
        }
        
        .shape-controls-hero .shape-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: calc(var(--spacing-md) + 2px);
            padding: var(--spacing-md) var(--spacing-xl);
            width: 100%;
            background: var(--bg-transparent);
            border-radius: 0;
        }
        
        .shape-controls-hero .shape-btn {
            width: var(--size-icon-xl);
            height: var(--size-icon-xl);
            font-size: var(--text-2xl);
            border-radius: var(--radius-lg);
            background: var(--bg-black-60);
            outline: 2px solid transparent;
            outline-offset: -2px;
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        
        .shape-controls-hero .shape-btn:hover {
            background: rgba(var(--accent-rgb, 0, 229, 255), 0.1);
            outline-color: var(--accent-primary);
            transform: translateY(-2px) scale(1.05);
        }
        
        .shape-controls-hero .shape-btn.active {
            background: var(--gradient-cyan);
            outline-color: rgba(0, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6), inset 0 0 10px rgba(0, 255, 255, 0.2);
            transform: scale(1.05); /* Consistent hover scale */
        }
        
        .shape-controls-hero .dice-btn {
            width: var(--size-icon-xl);
            height: var(--size-icon-xl);
            font-size: var(--text-2xl-plus-2);
        }
        
        /* 2. Main Layout Structure (Mobile First) */
        body {
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            padding: 0; /* NO PADDING */
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: calc(100vh - var(--pos-hero));
        }
        
        .center-container {
            order: 1;
            position: sticky;
            top: 0; /* NO OFFSET */
            z-index: var(--z-overlay);
            transform-origin: center center;
        }
        .controls-left {
            order: 2;
            background-color: var(--panel-bg);
            transform-origin: left center;
        }
        .controls-right {
            order: 3;
            background-color: var(--panel-bg);
            transform-origin: right center;
        }

        /* 3. Central Display Unit */
        .display-and-controls {
            display: flex;
            flex-direction: column;
            pointer-events: none; /* Don't block clicks */
        }
        .display-container {
            width: 100%;
            flex: 1; /* Fill available vertical space */
            position: relative;
            background: rgba(10, 14, 26, 0.25);
            min-height: 0;
            z-index: calc(var(--z-overlay) - 5);
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            pointer-events: auto; /* Container can receive events */
        }
        
        #emotive-canvas {
            /* No special transforms - let browser handle rendering */
        }
        /* Mobile portrait only - not tablets */
        @media (orientation: portrait) and (max-width: 480px) {
            /* Removed aspect ratio constraint to fill available space */

            /* System controls full width on mobile */
            .system-controls {
                left: 0;
                right: 0;
                bottom: var(--pos-footer); /* Keep above footer */
            }

            /* Adjust corner brackets for mobile portrait */
            .display-and-controls .corner-bracket {
                position: absolute; /* Use absolute on mobile */
            }
            .top-left, .top-right {
                top: 0; /* Reset to container-relative positioning */
            }
            .top-left {
                left: 0;
            }
            .top-right {
                right: 0;
            }
            .bottom-left, .bottom-right {
                bottom: 0; /* Reset to container-relative positioning */
            }
            .bottom-left {
                left: 0;
            }
            .bottom-right {
                right: 0;
            }
            
            /* Hero bar responsive adjustments */
            .shape-controls-hero .shape-controls {
                padding: var(--spacing-base) var(--spacing-md);
                gap: calc(var(--spacing-sm) * 1.5);
            }
            
            .shape-controls-hero .shape-btn {
                width: var(--size-icon-lg);
                height: var(--size-icon-lg);
                font-size: var(--text-xl-plus-1);
            }
            
            .shape-controls-hero .dice-btn {
                width: var(--size-icon-lg);
                height: var(--size-icon-lg);
                font-size: var(--text-xl-plus-3);
            }
            
            body {
                padding: 0; /* NO PADDING */
            }
            
            .hero-spacer {
                height: var(--pos-hero-rotation-mobile); /* Hero bar (58px) + rotation bar (40px) in portrait/mobile */
            }
            
            .main-layout {
                min-height: calc(100vh - var(--pos-hero-rotation-mobile)); /* Account for hero + rotation bar */
            }
            
            .center-container {
                top: 0; /* NO OFFSET */
            }
            
            .gesture-group .column-dice,
            .dice-btn {
                width: var(--size-icon-sm);
                height: var(--size-btn-sm);
                font-size: var(--text-xl);
            }
        }
        .display-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: var(--size-full);
            overflow: hidden;
            background: var(--canvas-bg);
            pointer-events: none; /* Don't block clicks */
        }
        .system-controls {
            position: fixed; /* Fixed positioning to stick to bottom */
            bottom: var(--pos-footer); /* Position above footer */
            left: var(--control-width); /* Start after left menu */
            right: var(--control-width); /* End before right menu */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-base);
            padding: var(--spacing-md);
            height: auto;
            background: var(--bg-black-30); /* Semi-transparent black */
            /* Removed backdrop-filter for true transparency */
            /* backdrop-filter: blur(12px); */
            /* -webkit-backdrop-filter: blur(12px); */
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            z-index: var(--z-system); /* Ensure system controls are above everything */
            pointer-events: auto !important; /* Force system controls to be clickable */
            transition: transform var(--transition-spring),
                        opacity 0.4s ease-out;
            transform-origin: bottom center;
        }
        
        /* Removed hidden state - system controls always visible */
        /* .system-controls.hidden - REMOVED */
        
        /* Add mechanical settling animation */
        @keyframes pneumatic-extend {
            0% { transform: translateY(-60px); }
            90% { transform: translateY(2px); } /* Gentle overshoot */
            100% { transform: translateY(0); } /* Settle to position */
        }
        
        @keyframes pneumatic-retract {
            0% { transform: translateY(0); }
            10% { transform: translateY(1px); } /* Subtle resistance */
            100% { transform: translateY(-60px); }
        }
        
        /* Removed extending/retracting animations - system controls always visible */
        /* .system-controls.extending - REMOVED */
        /* .system-controls.retracting - REMOVED */
        
        /* Removed shadow effect for cleaner look */
        
        .system-controls-group {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        
        .system-controls-divider {
            width: 1px; /* Keep ultra-thin divider */
            height: var(--size-badge);
            background: rgba(255, 255, 255, var(--opacity-light));
            margin: 0 var(--spacing-base);
        }
        
        
        .system-controls .sci-fi-btn {
            width: var(--size-btn-base);
            height: var(--size-btn-base);
            min-width: var(--size-min-button);
            min-height: var(--size-btn-base);
            padding: 0;
            margin: 0;
            font-size: var(--text-md-plus-1);
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, var(--opacity-light)); /* Nearly transparent buttons */
            color: var(--color-white-70);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            outline: 2px solid transparent;
            outline-offset: -2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-smooth);
            box-shadow: none;
            box-sizing: border-box; /* Ensure consistent sizing */
            pointer-events: auto; /* Ensure buttons are clickable */
            z-index: calc(var(--z-system) + 1); /* Above the parent container */
        }
        
        /* Hover - subtle border appears */
        .system-controls .sci-fi-btn:hover {
            background: rgba(255, 255, 255, var(--opacity-subtle));
            color: var(--color-white-90);
            outline-color: rgba(255, 255, 255, var(--opacity-light));
            transform: scale(1.05); /* Consistent hover scale */
        }
        
        /* Active state - subtle glow */
        .system-controls .sci-fi-btn.active {
            background: rgba(0, 255, 255, var(--opacity-soft));
            color: rgba(0, 255, 255, var(--opacity-solid));
            outline-color: rgba(0, 255, 255, var(--opacity-medium));
        }
        
        /* Recording button - subtle red when recording */
        .system-controls .sci-fi-btn.recording {
            background: rgba(255, 0, 0, 0.15);
            color: rgba(255, 100, 100, 0.9);
            outline-color: rgba(255, 0, 0, 0.3);
            animation: pulse-recording var(--anim-pulse);
        }
        
        @keyframes pulse-recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Master dice button special styling */
        .system-controls .sci-fi-btn.master-dice {
            background: var(--bg-black-60);
            color: rgba(255, 255, 255, 0.4);
        }
        
        .system-controls .sci-fi-btn.master-dice:hover {
            background: rgba(150, 100, 255, 0.1);
            color: rgba(150, 100, 255, 0.8);
            outline-color: rgba(150, 100, 255, 0.2);
        }
        
        /* Light theme rotation bar */
        .light .rotation-control-bar {
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(0, 122, 204, 0.2);
            box-shadow: var(--shadow-lg);
        }

        .light .rotation-slider-full::-webkit-slider-runnable-track {
            background: linear-gradient(to right,
                #dc2626 0%,     /* Lighter red for CCW */
                #f87171 20%,
                #64748b 45%,    /* Light gray center */
                #cbd5e1 50%,    /* Light gray center */
                #64748b 55%,    /* Light gray center */
                #60a5fa 80%,    /* Light blue */
                #2563eb 100%);  /* Blue for CW */
            border: var(--border-subtle);
        }

        .light .rotation-slider-full::-moz-range-track {
            background: linear-gradient(to right,
                #dc2626 0%,
                #f87171 20%,
                #64748b 45%,
                #cbd5e1 50%,
                #64748b 55%,
                #60a5fa 80%,
                #2563eb 100%);
            border: var(--border-subtle);
        }

        .light .rotation-slider-full::-webkit-slider-thumb {
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 1) 0%,
                rgba(240, 240, 240, 0.95) 50%,
                rgba(200, 200, 200, 0.9) 100%);
            border: var(--border-strong);
            box-shadow:
                0 2px 6px rgba(0, 0, 0, 0.15),
                inset 0 1px 3px rgba(255, 255, 255, 0.9);
        }

        .light .rotation-slider-full::-moz-range-thumb {
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 1) 0%,
                rgba(240, 240, 240, 0.95) 50%,
                rgba(200, 200, 200, 0.9) 100%);
            border: var(--border-strong);
            box-shadow:
                0 2px 6px rgba(0, 0, 0, 0.15),
                inset 0 1px 3px rgba(255, 255, 255, 0.9);
        }

        .light .rotation-label-left,
        .light .rotation-label-right {
            color: var(--accent-primary);
        }

        /* Light theme specific overrides */
        
        /* Light theme morph bar */
        .light .shape-controls-hero {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: var(--shadow-lg);
        }
        
        .light .shape-controls-hero .shape-btn {
            background: var(--bg-black-03);
            color: rgba(0, 0, 0, 0.6);
            outline-color: transparent;
        }
        
        .light .shape-controls-hero .shape-btn:hover {
            background: rgba(0, 122, 204, 0.08);
            outline-color: rgba(0, 122, 204, 0.2);
            color: rgba(0, 122, 204, 0.9);
            transform: scale(1.05); /* Consistent hover scale */
        }
        
        .light .shape-controls-hero .shape-btn.active {
            background: rgba(0, 122, 204, 0.12);
            outline-color: rgba(0, 122, 204, 0.4);
            color: var(--accent-primary);
            box-shadow: 0 0 12px rgba(0, 122, 204, 0.2), inset 0 0 6px rgba(0, 122, 204, 0.1);
        }
        
        .light .shape-controls-hero .dice-btn {
            background: var(--bg-black-03);
            color: rgba(0, 0, 0, 0.5);
        }
        
        .light .shape-controls-hero .dice-btn:hover {
            background: rgba(150, 100, 255, 0.08);
            outline-color: rgba(150, 100, 255, 0.2);
            color: rgba(150, 100, 255, 0.9);
        }
        
        /* Light theme system controls */
        /* Light theme - darken the animation frame background */
        .light .display-container {
            background: var(--bg-black-15); /* Darker overlay for light theme */
        }

        .light .system-controls {
            background: rgba(255, 255, 255, 0.3); /* Semi-transparent white */
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .light .system-controls-divider {
            background: var(--bg-black-08);
        }
        
        .light .system-controls .sci-fi-btn {
            background: rgba(255, 255, 255, 0.2); /* More translucent */
            color: rgba(0, 0, 0, 0.5);
            outline-color: transparent;
        }
        
        .light .system-controls .sci-fi-btn:hover {
            background: rgba(0, 122, 204, 0.08);
            outline-color: rgba(0, 122, 204, 0.2);
            color: rgba(0, 122, 204, 0.9);
            transform: scale(1.05); /* Consistent hover scale */
        }
        
        .light .system-controls .sci-fi-btn.active {
            background: rgba(0, 122, 204, 0.12);
            outline-color: rgba(0, 122, 204, 0.3);
            color: var(--accent-primary);
        }
        
        .light .system-controls .sci-fi-btn.recording {
            background: rgba(255, 0, 0, 0.1);
            outline-color: rgba(255, 0, 0, 0.3);
            color: rgba(200, 0, 0, 0.8);
        }
        
        .light .system-controls .sci-fi-btn.master-dice {
            background: var(--bg-black-03);
            color: rgba(0, 0, 0, 0.5);
        }
        
        .light .system-controls .sci-fi-btn.master-dice:hover {
            background: rgba(150, 100, 255, 0.08);
            outline-color: rgba(150, 100, 255, 0.2);
            color: rgba(150, 100, 255, 0.9);
        }
        
        /* Light theme BPM modifier buttons */
        .light .bpm-modifier-btn {
            background: var(--bg-black-04);
            border: var(--border-light);
            color: rgba(0, 0, 0, 0.5);
        }
        
        .light .bpm-modifier-btn:hover {
            background: rgba(0, 122, 204, 0.08);
            border-color: rgba(0, 122, 204, 0.3);
            color: rgba(0, 122, 204, 0.9);
            transform: scale(1.05); /* Consistent hover scale */
        }
        
        .light .bpm-modifier-btn.active {
            background: rgba(0, 122, 204, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 8px rgba(0, 122, 204, 0.15), inset 0 0 6px rgba(0, 122, 204, 0.08);
        }
        
        /* Simple icon styling */
        .system-controls .sci-fi-btn span {
            display: inline-block;
            margin-right: var(--spacing-sm);
        }

        /* HUD Tooltip */
        .hud-tooltip {
            position: absolute;
            bottom: var(--pos-controls-bottom); /* Moved up 3 button heights (40px Ã— 3 = 120px) */
            left: 50%;
            transform: translateX(-50%);
            padding: var(--spacing-base) var(--spacing-lg);
            background: var(--bg-black-90);
            border: 1px solid var(--accent-primary); /* Keep specific accent border */
            color: var(--accent-primary);
            font-size: var(--text-sm);
            font-family: var(--font-heading);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wide);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--anim-fade);
            z-index: calc(var(--z-header) + 100);
            white-space: nowrap;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .hud-tooltip::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--accent-glow) 50%,
                transparent 100%);
            opacity: 0;
            animation: none;
        }

        .hud-tooltip.visible {
            opacity: 1;
        }

        .hud-tooltip.activated {
            animation: tooltip-activate var(--transition-slow) ease-out;
        }

        @keyframes tooltip-activate {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            }
            50% {
                transform: translateX(-50%) scale(1.1);
                box-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            }
        }

        /* Light theme tooltip */
        .light .hud-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 122, 204, 0.2);
        }

        /* Theme-specific animations */
        .night .hud-tooltip.activated,
        .sunset .hud-tooltip.activated {
            animation: tooltip-activate-warm var(--transition-slow) ease-out;
        }

        @keyframes tooltip-activate-warm {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 20px rgba(204, 102, 51, 0.2);
            }
            50% {
                transform: translateX(-50%) scale(1.1);
                box-shadow: 0 0 40px rgba(204, 102, 51, 0.6);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 20px rgba(204, 102, 51, 0.2);
            }
        }
        

        /* 4. Control Panels & Buttons */
        .control-section {
            padding: var(--spacing-md);
            margin-bottom: calc(var(--spacing-lg) - 1px);
        }
        
        /* First control section reduced top padding */
        .controls-left .control-section:first-child,
        .controls-right .control-section:first-child {
            padding-top: calc(var(--spacing-sm) + 1px);
            margin-top: calc(var(--spacing-sm) + 1px);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: calc(var(--spacing-sm) + 1px);
        }
        
        /* Left menu: dice on the left, headings on the right */
        .left-menu .section-header {
            flex-direction: row-reverse;
            justify-content: space-between;
        }

        .left-menu .section-header h3 {
            text-align: right;
            flex: 1;
        }
        
        /* Right menu: dice on the right */
        .right-menu .section-header {
            flex-direction: row;
        }
        .control-section h3 {
            color: var(--accent-primary);
            font-size: var(--text-base);
            font-family: var(--font-heading);
            font-weight: var(--font-medium);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
            margin: 0;
        }
        /* Night theme headings use brighter orange */
        .night .control-section h3 {
            color: var(--color-orange-bright); /* brighter orange for headings */
        }
        .night .section-header {
            border-bottom-color: rgba(255, 138, 101, 0.2);
        }
        .dice-btn {
            background: var(--bg-transparent);
            font-size: calc(var(--text-xl) + 0.3rem);
            cursor: pointer;
            padding: 0;
            transition: transform var(--transition-base);
            opacity: var(--opacity-80);
            color: var(--accent-primary);
            width: var(--size-icon-md);
            height: var(--size-icon-md);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .dice-btn:hover {
            transform: rotate(180deg) scale(1.2);
            opacity: 1;
        }
        .dice-btn:active {
            transform: rotate(360deg);
            transition: transform var(--transition-slow);
        }
        .sound-toggle {
            background: var(--bg-transparent);
            border: 1px solid var(--accent-primary); /* Keep specific accent border */
            color: var(--accent-primary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-base);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-slow);
        }
        .sound-toggle:hover {
            background: var(--button-hover);
            transform: scale(1.05); /* Consistent hover scale */
        }
        .sound-toggle.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        .sound-toggle svg {
            width: var(--size-logo);
            height: var(--size-logo);
        }
        /* Base button styling - all buttons inherit from this */
        .sci-fi-btn {
            width: 100%;
            padding: var(--spacing-base);
            margin: 4px 0;
            background: var(--button-bg);
            border: var(--border-thin);
            color: var(--text-secondary);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--transition-base);
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            font-weight: var(--font-light);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wide);
        }

        .sci-fi-btn:hover {
            background: var(--button-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .sci-fi-btn:active {
            transform: translateY(0);
        }
        
        /* Keyboard focus indicators */
        .sci-fi-btn:focus {
            outline: 1px solid var(--border-color);
            outline-offset: 1px;
        }
        
        /* Remove outline for mouse users */
        .sci-fi-btn:focus:not(:focus-visible) {
            outline: none;
        }
        
        .sci-fi-btn.active {
            background: var(--button-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 8px rgba(var(--accent-rgb, 0, 229, 255), 0.2);
        }
        
        
        /* Gesture Categories Styling */
        .gesture-categories {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-md) + 2px);
            margin-top: 0;
        }
        
        .gesture-group {
            background: var(--bg-transparent);
            padding: 0;
            border-radius: 0;
            position: relative;
        }

        /* Light theme gesture groups */
        .light .gesture-group {
            background: var(--bg-transparent);
            box-shadow: none;
        }

        /* Chain Combo styling - matches gesture groups */
        .combo-categories {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-top: 0;
        }

        .combo-group {
            background: var(--bg-transparent);
            padding: 0;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }

        .light .combo-group {
            background: var(--bg-transparent);
            box-shadow: none;
        }

        .combo-group-title {
            font-size: var(--text-base);
            font-family: var(--font-heading);
            font-weight: var(--font-medium);
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
            margin: 0 0 var(--spacing-base) 0;
            text-align: center;
        }

        .light .combo-group-title {
            color: var(--accent-primary);
            font-weight: var(--font-semibold);
        }

        /* Glow Effects styling - matches gesture groups */
        .glow-categories {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-top: 0;
        }

        .glow-group {
            background: var(--bg-transparent);
            padding: 0;
            border-radius: 0;
            position: relative;
        }

        .light .glow-group {
            background: var(--bg-transparent);
            box-shadow: none;
        }

        /* ALL control containers styling - unified */
        .rhythm-controls-container,
        .combo-controls-container,
        .glow-controls-container,
        .dance-controls-container,
        .overlayable-controls-container {
            padding: var(--spacing-md);
            border: var(--border-thin);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            background: var(--bg-black-30);
        }

        /* Dark theme containers */
        .dark .rhythm-controls-container,
        .dark .combo-controls-container,
        .dark .glow-controls-container,
        .dark .dance-controls-container,
        .dark .overlayable-controls-container {
            background: var(--bg-black-30);
            border: var(--border-thin);
        }

        /* Light theme containers - very light gray */
        .light .rhythm-controls-container,
        .light .combo-controls-container,
        .light .glow-controls-container,
        .light .dance-controls-container,
        .light .overlayable-controls-container {
            background: var(--bg-black-04);
            border: 1px solid rgba(0, 122, 204, 0.15); /* Keep specific opacity */
        }

        /* Night theme containers */
        .night .rhythm-controls-container,
        .night .combo-controls-container,
        .night .glow-controls-container,
        .night .dance-controls-container,
        .night .overlayable-controls-container {
            background: var(--bg-black-40);
            border: var(--border-thin);
        }

        .glow-group-title {
            font-size: var(--text-base);
            font-family: var(--font-heading);
            font-weight: var(--font-medium);
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
            margin: 0 0 var(--spacing-base) 0;
            text-align: center;
        }

        .light .glow-group-title {
            color: var(--accent-primary);
            font-weight: var(--font-semibold);
        }

        /* Undertone section styling */
        .undertone-section {
            padding: 0 !important;
            margin-bottom: calc(var(--spacing-lg) - 1px) !important;
        }

        .undertone-group {
            background: var(--bg-transparent);
            padding: 0;
            border-radius: 0;
            position: relative;
        }

        .light .undertone-group {
            background: var(--bg-transparent);
            box-shadow: none;
        }

        .undertone-title {
            font-size: var(--text-base);
            font-family: var(--font-heading);
            font-weight: var(--font-medium);
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
            margin: 0 0 var(--spacing-base) 0;
            text-align: center;
        }

        .light .undertone-title {
            color: var(--accent-primary);
            font-weight: var(--font-semibold);
        }

        /* Rhythm Sync section styling - matching Audio Visualizer */
        .rhythm-group {
            background: var(--bg-transparent);
            padding: 0;
            border-radius: 0;
            position: relative;
            box-sizing: border-box;
        }

        /* Rhythm controls specific styling removed - using unified container styles */

        .rhythm-group-title {
            font-size: var(--text-base);
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
            margin: 0 0 var(--spacing-md) 0;
            text-align: center;
            font-weight: var(--font-normal);
        }

        .light .rhythm-group-title {
            color: var(--accent-primary);
        }

        .rhythm-toggle-btn:hover {
            background: var(--button-hover);
            transform: scale(1.05); /* Consistent hover scale */
        }

        .rhythm-toggle-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* Column dice styling for combo and glow groups */
        .combo-group .column-dice,
        .glow-group .column-dice {
            position: absolute;
            top: var(--pos-edge-sm);
            left: var(--pos-edge-sm);
            width: var(--size-icon-md);
            height: var(--size-icon-md);
            padding: 0;
            background: var(--bg-transparent);
            font-size: calc(var(--text-xl) + 0.3rem);
            cursor: pointer;
            opacity: var(--opacity-60);
            transition: all var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .combo-group .column-dice:hover,
        .glow-group .column-dice:hover {
            transform: rotate(180deg) scale(1.2);
            opacity: 1;
        }

        .light .combo-group .column-dice,
        .light .glow-group .column-dice {
            background: rgba(255, 255, 255, 0.8);
            color: var(--accent-primary);
            border: var(--border-subtle);
        }

        .light .combo-group .column-dice:hover,
        .light .glow-group .column-dice:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .light .gesture-group-title {
            color: var(--accent-primary);
            font-weight: var(--font-semibold);
        }
        
        .light .gesture-group .column-dice {
            background: rgba(255, 255, 255, 0.8);
            color: var(--accent-primary);
            border: var(--border-subtle);
        }
        
        .light .gesture-group .column-dice:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        /* Light theme gesture buttons */
        /* Light theme gesture buttons - removed, using base sci-fi-btn styles */
        
        .gesture-group-title {
            font-size: var(--text-base);
            font-family: var(--font-heading);
            font-weight: var(--font-medium);
            color: var(--accent-primary);
            margin-bottom: var(--spacing-base);
            text-transform: uppercase;
            letter-spacing: var(--spacing-letter-wider);
        }
        
        /* Right menu: align Dance and Overlayable titles to the left */
        .right-menu .gesture-group-title {
            text-align: left;
        }
        
        .gesture-group .column-dice {
            position: absolute;
            top: var(--pos-edge-sm);
            right: var(--pos-edge-sm);
            width: var(--size-icon-md);
            height: var(--size-icon-md);
            padding: 0;
            background: var(--bg-transparent);
            color: var(--accent-primary);
            font-size: calc(var(--text-xl) + 0.3rem);
            cursor: pointer;
            transition: all var(--transition-base);
            border-radius: var(--radius-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gesture-group .column-dice:hover {
            transform: rotate(180deg) scale(1.2);
        }
        
        /* Right menu: column dice on right */
        .right-menu .gesture-group .column-dice {
            right: var(--pos-edge-sm);
            left: auto;
        }
        
        /* Left menu: column dice on left */
        .left-menu .gesture-group .column-dice {
            left: var(--pos-edge-sm);
            right: auto;
        }
        
        /* Removed redundant btn-group rules - using base .btn-group */
        .combo-group .btn-group,
        .glow-group .btn-group {
            margin-top: calc(var(--spacing-sm) + 1px);
        }
        
        /* Chain group uses same layout as btn-group */
        .chain-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }
        
        
        .sci-fi-btn.gesture-pending {
            animation: pending-pulse 0.5s infinite; /* Keep specific pulse timing */
            border-color: rgba(255, 200, 0, 0.6);
            color: rgba(255, 200, 0, 0.8);
        }
        .sci-fi-btn.gesture-triggered {
            animation: trigger-flash var(--anim-flash);
            background: rgba(0, 255, 100, 0.3) !important;
            border-color: rgba(0, 255, 100, 0.8) !important;
            color: var(--color-green-bright) !important;
        }
        @keyframes pending-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes trigger-flash {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 100, 0.6); }
            100% { transform: scale(1); }
        }
        /* Button group layouts */
        .btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .btn-group-auto {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        
        /* 5. Holo Effects & Decorations */
        .holo-element { position: absolute; pointer-events: none; }
        .corner-bracket {
            z-index: var(--z-header);
            width: var(--size-btn-base);
            height: var(--size-btn-base);
            pointer-events: none; /* Ensure they don't block interactions */
        }
        .corner-bracket::before, .corner-bracket::after {
            content: '';
            position: absolute;
            background-color: var(--accent-glow); /* Uses theme accent */
            animation: subtle-glow var(--anim-glow);
        }
        /* Position corners relative to display-and-controls container */
        .display-and-controls .corner-bracket {
            position: fixed;
            z-index: var(--z-header) !important; /* Force above rotation bar */
        }
        .top-left {
            top: var(--pos-hero-rotation); /* Align with main-layout top position */
            left: var(--control-width);
        }
        .top-left::before { height: var(--size-corner); width: 100%; }
        .top-left::after { width: var(--size-corner); height: var(--size-full); }
        .top-right {
            top: var(--pos-hero-rotation); /* Align with main-layout top position */
            right: var(--control-width);
        }
        .top-right::before { height: var(--size-corner); width: 100%; }
        .top-right::after { width: var(--size-corner); height: var(--size-full); right: 0; }
        .bottom-left {
            bottom: var(--pos-footer); /* Position at bottom (above footer) */
            left: var(--control-width);
        }
        .bottom-left::before { height: var(--size-corner); width: 100%; bottom: 0; }
        .bottom-left::after { width: var(--size-corner); height: var(--size-full); }
        .bottom-right {
            bottom: var(--pos-footer); /* Position at bottom (above footer) */
            right: var(--control-width);
        }
        .bottom-right::before { height: var(--size-corner); width: 100%; bottom: 0; }
        .bottom-right::after { width: var(--size-corner); height: var(--size-full); right: 0; }
        .holo-circle { 
            z-index: var(--z-dropdown); 
            border: 2px solid; 
            border-radius: 50%; 
            animation: rotate-centered var(--anim-rotate-slow); 
            aspect-ratio: 1 / 1; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
        }
        .circle-1 { 
            width: 90%; 
            border-color: var(--border-color); 
            border-style: dotted; 
        }
        .circle-2 { 
            width: 80%; 
            border-color: var(--border-color); 
            animation-direction: reverse; 
            animation-duration: 15s; 
        }
        .info-display {
            position: absolute;
            z-index: var(--z-max); /* Highest z-index */
            bottom: var(--pos-edge-lg);
            left: var(--pos-edge-lg);
            font-family: var(--font-primary);
            font-size: var(--text-md);
            width: calc(100% - 50px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto; /* Make visible */
        }
        .info-display > .status-text { 
            animation: subtle-glow-cyan var(--anim-glow); 
            text-transform: uppercase; 
        }
        .info-display > .undertone-text { 
            background: var(--bg-black-40); 
            border: var(--border-thin); 
            padding: var(--spacing-sm) calc(var(--spacing-base) * 1.5); 
            border-radius: var(--radius-base); 
            color: var(--text-secondary); 
            font-size: var(--text-base); 
            text-transform: uppercase; 
        }
        /* Light theme undertone tag styling */
        .light .info-display > .undertone-text {
            background: rgba(0, 122, 204, 0.15);
            border: 1px solid rgba(0, 122, 204, 0.4);
            color: var(--accent-primary);
        }
        /* Light theme FPS display styling */
        .light .fps-display {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 122, 204, 0.4);
            color: var(--accent-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Light theme specific */
        }
        .fps-display {
            position: absolute;
            z-index: var(--z-max); /* Highest z-index */
            bottom: var(--pos-info-bottom);
            right: var(--pos-edge-lg);
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            color: var(--accent-primary);
            background: var(--bg-black-60);
            border: var(--border-thin);
            padding: var(--spacing-base) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-base);
            display: none;
            text-align: right;
            line-height: var(--line-height-normal);
            pointer-events: auto; /* Make visible */
        }
        .fps-display.active { display: block; } 
        .fps-display .fps-value { font-size: var(--text-lg); font-weight: var(--font-bold); }

        /* Audio player container glassmorphism for each theme */
        #audio-player-container {
            background: var(--bg-black-60) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
            -webkit-backdrop-filter: blur(20px) saturate(1.8) !important;
            border: none !important;
            border-radius: 16px !important;
            overflow: hidden !important;
        }
        
        /* Dark/default theme glass */
        .dark #audio-player-container {
            background: rgba(17, 25, 40, 0.7) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Light theme glass */
        .light #audio-player-container {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Blue theme glass */
        .blue #audio-player-container {
            background: rgba(0, 122, 204, 0.3) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Purple theme glass */
        .purple #audio-player-container {
            background: rgba(139, 92, 246, 0.3) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Ocean theme glass */
        .ocean #audio-player-container {
            background: rgba(6, 182, 212, 0.3) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Night/Sunset theme glass - warm only */
        .night #audio-player-container,
        .sunset #audio-player-container {
            background: rgba(204, 102, 51, 0.4) !important;
            backdrop-filter: blur(20px) saturate(1.5) !important;
        }
        
        /* Neon theme glass */
        .neon #audio-player-container {
            background: rgba(255, 0, 255, 0.3) !important;
            backdrop-filter: blur(20px) saturate(2) !important;
        }
        
        /* Forest theme glass */
        .forest #audio-player-container {
            background: rgba(34, 197, 94, 0.3) !important;
            backdrop-filter: blur(20px) saturate(1.8) !important;
        }
        
        /* Terminal theme glass */
        .terminal #audio-player-container {
            background: rgba(0, 255, 0, 0.2) !important;
            backdrop-filter: blur(20px) saturate(1.5) !important;
        }
        
        /* Synthwave theme glass */
        .synthwave #audio-player-container {
            background: linear-gradient(135deg, rgba(255, 0, 128, 0.3), rgba(0, 255, 255, 0.3)) !important;
            backdrop-filter: blur(20px) saturate(2) !important;
        }
        
        /* Monochrome theme glass */
        .monochrome #audio-player-container {
            background: rgba(128, 128, 128, 0.4) !important;
            backdrop-filter: blur(20px) grayscale(1) !important;
        }
        
        /* High contrast theme glass */
        .high-contrast #audio-player-container {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: none !important;
        }
        
        /* Audio player styling for visibility across all themes */
        #audio-player {
            /* Reset browser default audio styling */
            color-scheme: dark;
            border: none !important;
            outline: none !important;
        }
        
        /* Remove ALL borders from audio controls */
        #audio-player::-webkit-media-controls-enclosure {
            border: none !important;
            outline: none !important;
        }
        
        #audio-player::-webkit-media-controls-panel {
            border: none !important;
            outline: none !important;
        }
        
        /* For light themes, ensure controls are visible */
        .light #audio-player-container {
            background: rgba(50, 50, 50, 0.8) !important;
        }
        
        .light #audio-player {
            color-scheme: light;
        }
        
        .light #audio-player::-webkit-media-controls-panel {
            background: var(--bg-transparent);
            color: white;
        }
        
        .light #audio-player::-webkit-media-controls-current-time-display,
        .light #audio-player::-webkit-media-controls-time-remaining-display {
            color: black !important;
            text-shadow: none !important;
        }
        
        /* For dark themes, ensure proper visibility */
        .dark #audio-player,
        .blue #audio-player,
        .purple #audio-player,
        .ocean #audio-player,
        .neon #audio-player,
        .forest #audio-player,
        .terminal #audio-player,
        .synthwave #audio-player,
        .monochrome #audio-player {
            filter: brightness(1.2) contrast(1.1);
        }
        
        /* Night/sunset theme - warm colors only, NO BLUE */
        .night #audio-player,
        .sunset #audio-player {
            filter: brightness(1.2) contrast(1.1) hue-rotate(30deg) saturate(1.2);
        }
        
        /* High contrast theme needs stronger filter */
        .high-contrast #audio-player {
            filter: brightness(1.5) contrast(1.3);
        }
        
        /* Audio visualizer container backgrounds per theme */
        .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
        }
        
        /* Audio visualizer container backgrounds per theme */
        .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
        }
        
        .light .audio-viz-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,240,240,0.8));
        }
        
        .blue .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,30,60,0.85), rgba(0,50,100,0.7));
        }
        
        .purple .audio-viz-container {
            background: linear-gradient(135deg, rgba(30,0,60,0.85), rgba(50,0,100,0.7));
        }
        
        .ocean .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,40,60,0.85), rgba(0,60,80,0.7));
        }
        
        .night .audio-viz-container,
        .sunset .audio-viz-container {
            background: linear-gradient(135deg, rgba(40,20,0,0.85), rgba(60,30,10,0.7));
        }
        
        .neon .audio-viz-container {
            background: linear-gradient(135deg, rgba(20,0,40,0.85), rgba(40,0,60,0.7));
        }
        
        .forest .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,20,10,0.85), rgba(0,40,20,0.7));
        }
        
        .terminal .audio-viz-container {
            background: linear-gradient(135deg, rgba(0,10,0,0.9), rgba(0,20,0,0.8));
        }
        
        .synthwave .audio-viz-container {
            background: linear-gradient(135deg, rgba(20,0,40,0.85), rgba(40,0,60,0.7));
        }
        
        .monochrome .audio-viz-container {
            background: linear-gradient(135deg, rgba(20,20,20,0.85), rgba(40,40,40,0.7));
        }
        
        .high-contrast .audio-viz-container {
            background: black;
        }

        /* 6. Landscape Mode (includes tablets) */
        @media (orientation: landscape) and (max-height: 900px) {
            /* Adjust corner brackets for landscape */
            .top-left, .top-right {
                top: 58px; /* Position at top of center container in landscape */
            }
            .top-left {
                left: 180px; /* Landscape menu width */
            }
            .top-right {
                right: var(--pos-menu-landscape); /* Landscape menu width */
            }
            .bottom-left {
                bottom: 32px; /* Position at bottom (above footer in landscape) */
                left: 180px;
            }
            .bottom-right {
                bottom: 32px; /* Position at bottom (above footer in landscape) */
                right: var(--pos-menu-landscape);
            }
            body { 
                overflow: hidden;
                padding: 0;
            }
            
            .hero-spacer {
                display: none; /* No spacer in landscape - different layout */
            }
            
            /* Footer in landscape */
            .legal-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin-top: 0;
                z-index: var(--z-modal);
                padding: calc(var(--spacing-sm) * 1.5) calc(var(--spacing-lg) - 1px);
                font-size: var(--text-xs);
                background: var(--bg-black-90);
            }
            
            .shape-controls-hero .shape-controls {
                padding: calc(var(--spacing-sm) * 1.5) calc(var(--spacing-lg) - 1px);
            }
            
            .shape-controls-hero .shape-btn {
                width: var(--size-btn-base);
                height: var(--size-btn-base);
                font-size: var(--text-xl);
            }
            
            .shape-controls-hero .dice-btn {
                width: var(--size-btn-base);
                height: var(--size-btn-base);
                font-size: var(--text-xl-plus-2);
            }
            .main-layout {
                position: absolute;
                top: 98px; /* Below hero bar (58px) + rotation bar (40px) */
                left: 0;
                right: 0;
                bottom: 32px; /* Account for footer */
                flex-direction: row;
                padding: 0;
                gap: 0;
                margin: 0;
                display: flex;
            }
            .center-container {
                position: absolute;
                top: 58px; /* Start right below hero bar in landscape */
                left: 180px; /* Start after left menu */
                right: var(--pos-menu-landscape); /* End before right menu */
                bottom: 32px; /* Stop at footer */
                display: flex;
                align-items: center; /* Center vertically */
                justify-content: center; /* Center horizontally */
                padding: 0; /* ZERO padding */
                margin: 0; /* ZERO margin */
            }
            .controls-left, .controls-right {
                position: fixed;
                top: 58px; /* Start right below landscape hero bar */
                bottom: 32px; /* Stop at footer */
                width: 180px;
                overflow-y: auto;
                overflow-x: hidden;
                background-color: var(--panel-bg);
                border: var(--border-thin); /* Visual separation */
                padding-top: var(--spacing-md);
                padding-bottom: calc(var(--spacing-xl) * 2);
                box-sizing: border-box;
                z-index: var(--z-menu); /* Base layer for menus */
            }
            .controls-left {
                left: 0;
            }
            .controls-right {
                right: 0;
            }
            .display-and-controls {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 45px; /* Stop at system controls */
                width: var(--size-full);
                height: var(--size-full);
                display: flex;
                flex-direction: column;
                justify-content: flex-start; /* Start from top - NO GAP */
                align-items: stretch;
                padding: 0; /* No padding */
                margin: 0;
            }
            .display-container {
                flex: 1; /* Take up all available space */
                width: var(--size-full);
                position: relative;
                margin: 0;
            }
            /* Hide the ::before pseudo-element in landscape */
            .display-container::before {
                display: none;
            }
            .system-controls {
                /* Keep fixed positioning in landscape */
                position: fixed;
                bottom: 32px; /* Adjusted for landscape footer */
                left: var(--pos-menu-landscape); /* Match landscape menu width */
                right: var(--pos-menu-landscape); /* Match landscape menu width */
                height: var(--size-btn-base);
                font-size: var(--text-sm);
                padding: var(--spacing-sm) var(--spacing-md);
                flex-shrink: 0;
            }
            .system-controls .sci-fi-btn {
                padding: calc(var(--spacing-sm) + 1px) var(--spacing-base);
            }
            .btn-group { 
                grid-template-columns: 1fr 1fr;
                gap: var(--spacing-xs);
            }
            .sci-fi-btn {
                padding: calc(var(--spacing-sm) + 1px);
                font-size: var(--text-xs);
                margin: 2px 0;
            }
            .control-section {
                padding: var(--spacing-base);
            }
            
            .control-section h3 {
                font-size: var(--text-xs);
                margin-bottom: calc(var(--spacing-sm) + 2px);
            }
        }
        

        /* 7. Desktop Layout Overrides */
        @media (min-width: 1025px) {
            body { 
                overflow: hidden;
                padding: 0;
                height: 100vh;
                box-sizing: border-box;
            }
            
            .hero-spacer {
                display: none; /* No spacer in desktop - different layout */
            }
            
            /* Footer always visible in desktop */
            .legal-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: calc(var(--z-modal) - 2);
            }
            .main-layout {
                position: absolute;
                top: 126px; /* Start below hero bar (76px) + rotation bar (50px) */
                left: 0;
                right: 0;
                bottom: 90px; /* Stop before system controls (45px footer + 45px for controls) */
                flex-direction: row;
                padding: 0;
                gap: 0;
                margin: 0;
                display: flex;
            }
            .center-container {
                position: absolute;
                top: 0; /* No additional offset - parent already positioned at 126px */
                left: var(--control-width); /* Start after left menu */
                right: var(--control-width); /* End before right menu */
                bottom: 45px; /* Stop at footer */
                display: flex;
                align-items: flex-start; /* Start from top */
                justify-content: center;
                padding: 0; /* ZERO padding */
                margin: 0; /* ZERO margin */
            }
            .controls-left, .controls-right {
                position: fixed;
                top: 76px; /* Start right below hero bar */
                bottom: 45px; /* Stop at footer */
                width: var(--control-width);
                overflow-y: auto;
                overflow-x: hidden;
                background-color: var(--panel-bg);
                box-sizing: border-box;
                border: var(--border-thin); /* Add border for visual separation */
                padding-top: var(--spacing-md);
                padding-bottom: var(--spacing-md);
                z-index: var(--z-menu); /* Base layer for menus */
            }
            .controls-left {
                left: 0;
            }
            .controls-right {
                right: 0;
            }
            .display-and-controls {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 45px; /* Stop at system controls */
                width: var(--size-full);
                height: var(--size-full);
                display: flex;
                flex-direction: column; /* Stack vertically */
                justify-content: flex-start; /* Start from top - NO GAP */
                align-items: stretch;
                box-sizing: border-box;
                padding: 0; /* No padding anywhere */
                margin: 0;
            }
            .display-container {
                flex: 1; /* Take up all available space */
                width: var(--size-full);
                position: relative;
                margin: 0;
            }
            /* Hide the ::before pseudo-element in desktop */
            .display-container::before {
                display: none;
            }
            .system-controls {
                flex-shrink: 0;
            }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .controls-left::-webkit-scrollbar, .controls-right::-webkit-scrollbar { width: 8px; }
            .controls-left::-webkit-scrollbar-track, .controls-right::-webkit-scrollbar-track { 
                background: var(--button-bg); 
            }
            .controls-left::-webkit-scrollbar-thumb, .controls-right::-webkit-scrollbar-thumb { 
                background: var(--border-color); 
                border-radius: var(--radius-base); 
            }
        }

        /* 8. Animations */
        #emotive-canvas {
            display: block;
            position: absolute;
            z-index: var(--z-menu);
            width: 100%;
            height: var(--size-full);
            top: 0;
            left: 0;
            pointer-events: none; /* Disable all pointer events by default */
        }
        @keyframes pulse { 
            0%, 100% { 
                opacity: var(--opacity-80); 
                transform: scale(1); 
                box-shadow: 0 0 10px var(--accent-glow); 
            } 
            50% { 
                opacity: 1; 
                transform: scale(1.02); 
 
            } 
        }
        @keyframes subtle-glow { 
            0%, 100% { 
                background-color: var(--accent-primary); 
            } 
            50% { 
                background-color: var(--accent-glow); 
            } 
        }
        @keyframes subtle-glow-cyan { 
            0%, 100% { 
                color: var(--accent-primary); 
                text-shadow: 0 0 5px var(--accent-glow); 
            } 
            50% { 
                color: var(--accent-glow); 
                text-shadow: 0 0 8px var(--accent-glow); 
            } 
        }
        /* Utility classes for common patterns */

        /* Text utilities */
        .uppercase { text-transform: uppercase; }
        .lowercase { text-transform: lowercase; }
        .capitalize { text-transform: capitalize; }

        /* Position utilities */
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .sticky { position: sticky; }
        .static { position: static; }

        /* Border utilities */
        .border-none { border: none; }
        .border { border: 1px solid var(--border-color); }
        .border-2 { border: 2px solid var(--border-color); }
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded { border-radius: var(--radius-base); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-full { border-radius: var(--radius-round); }

        /* Margin utilities */
        .m-0 { margin: 0; }
        .m-auto { margin: auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .my-auto { margin-top: auto; margin-bottom: auto; }

        /* Padding utilities */
        .p-0 { padding: 0; }
        .p-xs { padding: var(--spacing-xs); }
        .p-sm { padding: var(--spacing-sm); }
        .p-base { padding: var(--spacing-base); }
        .p-md { padding: var(--spacing-md); }
        .p-lg { padding: var(--spacing-lg); }
        .p-xl { padding: var(--spacing-xl); }

        /* Cursor utilities */
        .cursor-pointer { cursor: pointer; }
        .cursor-default { cursor: default; }
        .cursor-move { cursor: move; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .cursor-not-allowed { cursor: not-allowed; }
        .cursor-wait { cursor: wait; }
        .cursor-text { cursor: text; }

        /* Pointer Events */
        .pointer-events-none { pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }

        /* Opacity utilities */
        .opacity-0 { opacity: 0; }
        .opacity-10 { opacity: var(--opacity-light); }
        .opacity-30 { opacity: var(--opacity-medium); }
        .opacity-50 { opacity: var(--opacity-strong); }
        .opacity-70 { opacity: var(--opacity-heavy); }
        .opacity-90 { opacity: var(--opacity-solid); }
        .opacity-100 { opacity: 1; }

        /* Background utilities */
        .bg-transparent { background: transparent; }
        .bg-current { background: currentColor; }
        .bg-inherit { background: inherit; }
        .bg-none { background: none; }

        /* Transform utilities */
        .scale-95 { transform: scale(0.95); }
        .scale-100 { transform: scale(1); }
        .scale-105 { transform: scale(1.05); }
        .scale-110 { transform: scale(1.1); }
        .rotate-0 { transform: rotate(0deg); }
        .rotate-90 { transform: rotate(90deg); }
        .rotate-180 { transform: rotate(180deg); }
        .rotate-270 { transform: rotate(270deg); }
        .translate-center { transform: translate(-50%, -50%); }
        .translate-x-center { transform: translateX(-50%); }
        .translate-y-center { transform: translateY(-50%); }

        /* Transform Origin */
        .origin-center { transform-origin: center; }
        .origin-top { transform-origin: top; }
        .origin-bottom { transform-origin: bottom; }
        .origin-left { transform-origin: left; }
        .origin-right { transform-origin: right; }

        /* Hover/Active Transform Effects */
        .hover-scale-105:hover { transform: scale(1.05); }
        .hover-scale-110:hover { transform: scale(1.1); }
        .hover-lift:hover { transform: translateY(-2px); }
        .hover-lift-scale:hover { transform: translateY(-2px) scale(1.05); }
        .active-scale-98:active { transform: scale(0.98); }
        .active-scale-95:active { transform: scale(0.95); }

        /* Transition Presets */
        .transition-transform { transition: transform var(--transition-base); }
        .transition-all { transition: all var(--transition-base); }
        .transition-colors { transition: color var(--transition-base), background-color var(--transition-base), border-color var(--transition-base); }

        /* Border/Outline utilities */
        .outline-none { outline: none; }
        .outline-transparent { outline: 2px solid transparent; }
        .border-none { border: none; }

        /* Display utilities */
        .d-none { display: none; }
        .d-block { display: block; }
        .d-inline { display: inline; }
        .d-inline-block { display: inline-block; }
        .d-flex { display: flex; }
        .d-inline-flex { display: inline-flex; }
        .d-grid { display: grid; }
        .d-table { display: table; }

        /* User interaction utilities */
        .user-select-none { user-select: none; }
        .user-select-auto { user-select: auto; }
        .user-select-text { user-select: text; }
        .user-select-all { user-select: all; }

        /* White-space utilities */
        .ws-normal { white-space: normal; }
        .ws-nowrap { white-space: nowrap; }
        .ws-pre { white-space: pre; }
        .ws-pre-wrap { white-space: pre-wrap; }
        .ws-pre-line { white-space: pre-line; }

        /* Text decoration utilities */
        .text-decoration-none { text-decoration: none; }
        .text-decoration-underline { text-decoration: underline; }
        .text-decoration-overline { text-decoration: overline; }
        .text-decoration-line-through { text-decoration: line-through; }

        /* Common style resets */
        .reset-button {
            background: transparent;
            outline: none;
            cursor: pointer;
        }

        .glow-bg-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, var(--accent-glow), transparent);
            opacity: var(--opacity-light);
            pointer-events: none;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Flex utilities */
        .justify-center { justify-content: center; }
        .justify-start { justify-content: flex-start; }
        .justify-end { justify-content: flex-end; }
        .justify-between { justify-content: space-between; }
        .justify-around { justify-content: space-around; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .flex-col { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-nowrap { flex-wrap: nowrap; }
        .flex-1 { flex: 1; }
        .flex-auto { flex: auto; }
        .flex-none { flex: none; }

        /* Width utilities */
        .w-full { width: 100%; }
        .w-half { width: 50%; }
        .w-auto { width: auto; }
        .w-fit { width: fit-content; }

        /* Height utilities */
        .h-full { height: var(--size-full); }
        .h-half { height: 50%; }
        .h-auto { height: auto; }
        .h-screen { height: 100vh; }

        /* Position utilities */
        .absolute-fill {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .absolute-top-left {
            position: absolute;
            top: 0;
            left: 0;
        }

        .section-title {
            text-align: center;
            flex: 1;
        }

        .rhythm-controls {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-sm) * 1.5);
            margin-bottom: var(--spacing-md);
        }

        .bpm-input {
            width: var(--size-icon-lg);
            background: var(--bg-black-30);
            border: var(--border-thin);
            color: var(--accent-primary);
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            font-weight: var(--font-light);
            text-align: center;
            padding: calc(var(--spacing-xs) + 1px) var(--spacing-xs);
            border-radius: var(--radius-base);
            outline: none;
        }

        .rhythm-toggle-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            background: var(--bg-transparent);
            border: 1px solid var(--accent-primary); /* Keep specific accent border */
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--transition-slow);
        }

        .beat-indicator {
            width: 18px;
            height: 18px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .beat-ring-outer {
            position: absolute;
            width: 100%;
            height: var(--size-full);
            border: 1px solid var(--accent-primary); /* Keep specific accent border */
            border-radius: 50%;
            opacity: var(--opacity-20);
        }

        .beat-ring-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border: 1px solid var(--accent-primary); /* Keep specific accent border */
            border-radius: 50%;
            opacity: var(--opacity-medium);
        }

        .beat-dot {
            width: 5px;
            height: 5px;
            background: var(--accent-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--accent-glow);
            z-index: var(--z-base);
        }

        .audio-viz-container {
            padding: var(--spacing-md);
            border: var(--border-thin);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            min-height: 100px;
        }

        .spectrum-viz {
            height: 80px;
            display: flex;
            align-items: flex-end;
            gap: 1px; /* Keep precise 1px gap */
            position: relative;
        }

        .undertone-controls-container {
            padding: var(--spacing-md) var(--spacing-xl);
        }

        .undertone-slider-container {
            padding: var(--spacing-base) 0;
            position: relative;
        }

        .dice-btn {
            margin-right: var(--spacing-md);
        }

        .bpm-modifier-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .hidden {
            display: none;
        }

        .logo-watermark {
            position: absolute;
            top: var(--pos-content-top);
            left: var(--spacing-xl);
            z-index: var(--z-overlay);
            opacity: var(--opacity-33);
            pointer-events: none;
        }

        .logo-image {
            height: var(--size-btn-base);
            filter: brightness(0) invert(1);
            pointer-events: auto;
        }

        .undertone-value {
            color: var(--accent-primary);
            font-size: var(--text-sm-plus);
            text-transform: uppercase;
            transition: all var(--transition-slow);
        }

        .rotation-icon {
            font-size: var(--text-lg);
        }

        .text-center {
            text-align: center;
        }

        .undertone-label {
            color: var(--text-secondary);
            font-size: var(--text-xs);
        }

        .rhythm-slider {
            width: 100%;
            height: var(--size-corner);
        }

        .rhythm-status {
            font-size: var(--text-base-plus);
        }

        .mb-8 {
            margin-bottom: var(--spacing-base);
        }

        .mr-10 {
            margin-right: var(--spacing-md);
        }

        .ml-10 {
            margin-left: var(--spacing-md);
        }

        .flex-1 {
            flex: 1;
        }

        .p-3-0 {
            padding: calc(var(--spacing-xs) + 1px) 0;
        }

        .position-relative {
            position: relative;
        }

        /* Common backdrop filter effects */
        .backdrop-blur {
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
        }

        .backdrop-blur-heavy {
            backdrop-filter: blur(20px) saturate(1.8);
            -webkit-backdrop-filter: blur(20px) saturate(1.8);
        }

        /* Common spacing values */
        .gap-4 { gap: 4px; }
        .gap-6 { gap: 6px; }
        .gap-8 { gap: 8px; }
        .gap-10 { gap: 10px; }
        .gap-12 { gap: 12px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }

        /* Size utilities */
        .w-full { width: 100%; }
        .h-full { height: var(--size-full); }
        .w-h-full { width: 100%; height: var(--size-full); }

        /* Overflow utilities */
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-visible { overflow: visible; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-hidden { overflow-x: hidden; }

        /* Text alignment utilities */
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        /* Letter spacing utilities */
        .tracking-tight { letter-spacing: var(--spacing-letter-tight); }
        .tracking-normal { letter-spacing: var(--spacing-letter-normal); }
        .tracking-wide { letter-spacing: var(--spacing-letter-wide); }
        .tracking-wider { letter-spacing: var(--spacing-letter-wider); }
        .tracking-widest { letter-spacing: var(--spacing-letter-widest); }

        /* Night theme specific styles */
        .night .sci-fi-btn.active {
            color: var(--color-white-warm); /* orange-tinted white for active buttons */
            border-color: var(--color-orange-bright); /* brighter orange border */
        }
        .night .info-display .status-text {
            color: var(--color-white-pure) !important; /* force white core */
            text-shadow: 0 0 15px #FF8A65; /* single orange glow */
            animation: none !important; /* disable the animation */
        }
        .night .info-display > .undertone-text {
            background: rgba(20, 14, 10, 0.8);
            border: 1px solid var(--color-orange-bright);
            color: var(--color-orange-pale);
        }
        .night .fps-display {
            background: rgba(20, 14, 10, 0.8);
            border: 1px solid var(--color-orange-bright);
            color: var(--color-orange-bright);
        }
        
        /* Dark theme specific styles */
        .dark .info-display .status-text {
            color: var(--color-white-pure) !important; /* force white core */
            text-shadow: 0 0 15px #00e5ff; /* cyan blue glow */
            animation: none !important; /* disable the animation */
        }
        
        /* Light theme specific styles */
        .light .info-display .status-text {
            color: #0E0E0E !important; /* flex tape dark text */
            text-shadow: 0 0 15px #007acc; /* blue glow */
            animation: none !important; /* disable the animation */
        }
        
        /* Emotion button emoji styling - simplified */
        .emotion-btn {
            font-size: calc(var(--text-xl) + 0.3rem);
            line-height: var(--line-height-tight);
        }
        
        /* Hide number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Rhythm slider styling - Base styles */
        .rhythm-slider {
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-transparent);
            outline: none;
            cursor: pointer;
            height: var(--size-corner);
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        .rhythm-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: var(--size-corner);
            background: linear-gradient(to right,
                var(--accent-primary) 0%,
                var(--accent-primary) var(--value, 50%),
                rgba(255, 255, 255, 0.1) var(--value, 50%),
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: var(--radius-sm);
        }

        .rhythm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 6px var(--accent-glow);
            transition: all var(--transition-base);
            margin-top: -4px;
        }

        .rhythm-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Firefox */
        .rhythm-slider::-moz-range-track {
            width: 100%;
            height: var(--size-corner);
            background: rgba(255, 255, 255, var(--opacity-light));
            border-radius: var(--radius-sm);
        }

        .rhythm-slider::-moz-range-progress {
            height: var(--size-corner);
            background: var(--accent-primary);
            border-radius: var(--radius-sm);
        }

        .rhythm-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 6px var(--accent-glow);
            transition: all var(--transition-base);
        }

        .rhythm-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Light theme slider styling */
        .light .rhythm-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right,
                #007acc 0%,
                #007acc var(--value, 50%),
                rgba(0, 0, 0, 0.1) var(--value, 50%),
                rgba(0, 0, 0, 0.1) 100%);
        }

        .light .rhythm-slider::-webkit-slider-thumb {
            background: var(--accent-primary);
            box-shadow: 0 0 6px rgba(0, 122, 204, 0.5);
        }

        .light .rhythm-slider::-moz-range-track {
            background: var(--bg-black-10);
        }

        .light .rhythm-slider::-moz-range-progress {
            background: var(--accent-primary);
        }

        .light .rhythm-slider::-moz-range-thumb {
            background: var(--accent-primary);
            box-shadow: 0 0 6px rgba(0, 122, 204, 0.5);
        }

        /* Night theme slider - warm orange colors */
        .night .rhythm-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right,
                #FF8A65 0%,
                #FF8A65 var(--value, 50%),
                rgba(255, 138, 101, 0.2) var(--value, 50%),
                rgba(255, 138, 101, 0.2) 100%);
        }

        .night .rhythm-slider::-webkit-slider-thumb {
            background: var(--accent-primary);
            box-shadow: 0 0 8px rgba(255, 138, 101, 0.6);
        }

        .night .rhythm-slider::-moz-range-track {
            background: rgba(255, 138, 101, 0.2);
        }

        .night .rhythm-slider::-moz-range-progress {
            background: var(--accent-primary);
        }

        .night .rhythm-slider::-moz-range-thumb {
            background: var(--accent-primary);
            box-shadow: 0 0 8px rgba(255, 138, 101, 0.6);
        }
        
        /* Rhythm button active state */
        .rhythm-btn.active {
            border-color: var(--accent-glow) !important;
            box-shadow: 0 0 20px var(--accent-primary), inset 0 0 10px rgba(var(--accent-rgb, 0,229,255), 0.3);
        }
        
        /* Beat pulse animation */
        @keyframes beatPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Simple rotation for orbital indicator */
        /* Consolidated rotation animations */
        @keyframes rotate-cw {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes rotate-ccw {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        /* Brake button styles */
        .brake-btn {
            padding: calc(var(--spacing-xs) + 1px) calc(var(--spacing-sm) + 2px);
            font-size: var(--text-sm);
            background: linear-gradient(135deg, rgba(255, 50, 50, 0.15), rgba(255, 0, 0, 0.05));
            border: 1px solid rgba(255, 100, 100, 0.4);
            color: rgba(255, 150, 150, 0.9);
            font-weight: var(--font-semibold);
            transition: all var(--transition-base);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-base);
            flex-shrink: 0;
            min-width: var(--size-icon-sm);
        }

        .brake-btn:hover {
            background: linear-gradient(135deg, rgba(255, 80, 80, 0.25), rgba(255, 30, 30, 0.1));
            border-color: rgba(255, 120, 120, 0.6);
            color: rgba(255, 180, 180, 1);
            box-shadow: 0 0 12px rgba(255, 100, 100, 0.3);
            transform: scale(1.05); /* Consistent hover scale */
        }

        .brake-btn:active {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.3), rgba(255, 50, 50, 0.15));
            transform: scale(0.95);
            box-shadow: 0 0 8px rgba(255, 100, 100, 0.5);
        }

        .brake-btn.braking {
            animation: brake-pulse 0.5s ease-out; /* Keep specific brake timing */
        }

        /* Light theme brake button */
        .light .brake-btn {
            background: linear-gradient(135deg, rgba(204, 51, 51, 0.12), rgba(204, 51, 51, 0.05));
            border-color: rgba(204, 51, 51, 0.3);
            color: rgba(204, 51, 51, 0.8);
        }

        .light .brake-btn:hover {
            background: linear-gradient(135deg, rgba(204, 51, 51, 0.2), rgba(204, 51, 51, 0.1));
            border-color: rgba(204, 51, 51, 0.5);
            color: rgba(204, 51, 51, 1);
            box-shadow: 0 0 12px rgba(204, 51, 51, 0.2);
        }

        .light .brake-btn:active {
            background: linear-gradient(135deg, rgba(204, 51, 51, 0.25), rgba(204, 51, 51, 0.12));
            box-shadow: 0 0 8px rgba(204, 51, 51, 0.3);
        }

        /* Warm theme brake button */
        .warm .brake-btn {
            background: linear-gradient(135deg, rgba(255, 102, 51, 0.15), rgba(255, 51, 0, 0.05));
            border-color: rgba(255, 102, 51, 0.4);
            color: rgba(255, 153, 102, 0.9);
        }

        .warm .brake-btn:hover {
            background: linear-gradient(135deg, rgba(255, 102, 51, 0.25), rgba(255, 51, 0, 0.1));
            border-color: rgba(255, 102, 51, 0.6);
            color: rgba(255, 153, 102, 1);
            box-shadow: 0 0 12px rgba(255, 102, 51, 0.3);
        }

        .warm .brake-btn:active {
            background: linear-gradient(135deg, rgba(255, 102, 51, 0.3), rgba(255, 51, 0, 0.15));
            box-shadow: 0 0 8px rgba(255, 102, 51, 0.4);
        }

        @keyframes brake-pulse {
            0% {
                box-shadow: 0 0 0 0 currentColor;
            }
            50% {
                box-shadow: 0 0 20px 5px currentColor;
                opacity: var(--opacity-80);
            }
            100% {
                box-shadow: 0 0 0 0 currentColor;
                opacity: 1;
            }
        }

        /* Rotation slider styles */
        #rotation-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: var(--radius-base);
            outline: none;
            transition: opacity var(--transition-base);
            background: linear-gradient(to right,
                #60a5fa 0%,     /* Blue for counter-clockwise */
                #374151 48%,    /* Dark gray approaching center */
                #1f2937 50%,    /* Darkest at center */
                #374151 52%,    /* Dark gray leaving center */
                #4ade80 100%);  /* Green for clockwise */
        }

        #rotation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: var(--size-badge);
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffcc, #00d4aa);
            cursor: pointer;
            box-shadow: var(--shadow-md),
                       0 0 20px rgba(0, 255, 204, 0.4);
            transition: all var(--transition-base);
            border: 2px solid rgba(0, 255, 204, 0.3);
        }

        #rotation-slider::-moz-range-thumb {
            width: 24px;
            height: var(--size-badge);
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffcc, #00d4aa);
            cursor: pointer;
            box-shadow: var(--shadow-md),
                       0 0 20px rgba(0, 255, 204, 0.4);
            transition: all var(--transition-base);
            border: 2px solid rgba(0, 255, 204, 0.3);
        }

        #rotation-slider:hover::-webkit-slider-thumb {
            transform: scale(1.15) translateY(-2px);
            box-shadow: var(--shadow-2xl),
                       0 0 30px rgba(0, 255, 204, 0.6);
        }

        #rotation-slider:hover::-moz-range-thumb {
            transform: scale(1.15) translateY(-2px);
            box-shadow: var(--shadow-2xl),
                       0 0 30px rgba(0, 255, 204, 0.6);
        }

        #rotation-slider:active::-webkit-slider-thumb {
            transform: scale(1.1) translateY(0);
        }

        #rotation-slider:active::-moz-range-thumb {
            transform: scale(1.1) translateY(0);
        }
        
        /* Emotion panels on sides of display */
        .emotion-panel {
            display: none; /* Hidden on mobile by default */
            pointer-events: auto; /* Emotion panels can be clicked */
        }
        
        @media (min-width: 1025px) {
            .display-and-controls {
                flex-direction: row !important;
                align-items: stretch !important;
                position: relative;
            }
            
            .emotion-panel {
                display: flex;
                flex-direction: column;
                gap: calc(var(--spacing-md) + 2px);
                padding: 12px 0;
                justify-content: center;
                background: var(--bg-transparent);
                    position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: var(--z-overlay);
            }
            
            .emotion-panel-left {
                left: -27px; /* Position 2/3 toward frame, 1/3 toward menu (80px * 1/3 = 27px) */
            }
            
            .emotion-panel-right {
                right: -27px; /* Position 2/3 toward frame, 1/3 toward menu (80px * 1/3 = 27px) */
            }
            
            .display-container {
                order: 2;
                flex: 1;
            }
            
            /* System controls positioning handled by base styles */
            
            .emotion-panel .emotion-btn {
                width: 80px;
                height: 80px;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: calc(var(--text-2xl) * 1.45) !important;
                border-radius: 50%;
                background: var(--bg-transparent);
                outline: none;
                transition: all var(--transition-smooth);
                    cursor: pointer;
                color: var(--text-primary);
                box-shadow: none;
            }
            
            .emotion-panel .emotion-btn:hover {
                transform: translateY(-2px) scale(1.1);
                filter: brightness(1.2);
            }
            
            .emotion-panel .emotion-btn.active {
                transform: scale(1.15);
                filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.6));
            }
        }
        @keyframes rotate-centered {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Remove conflicting audio player styles - handled above */
        
        /* Simple audio player text color styling */
        #audio-player::-webkit-media-controls-current-time-display,
        #audio-player::-webkit-media-controls-time-remaining-display {
            color: var(--text-primary);
        }
        
        #audio-player::-webkit-media-controls-panel {
            background: var(--bg-transparent);
        }
        
        /* Audio Visualizer Visibility */
        #audio-viz-section {
            display: none; /* Hidden by default on mobile portrait */
        }
        
        /* Show on landscape and desktop */
        @media (orientation: landscape), (min-width: 769px) {
            #audio-viz-section {
                display: block !important; /* Always visible in landscape/desktop */
            }
        }
        
    </style>
</head>
<body class="night">
    <a href="#display-container" class="skip-nav">Skip to main content</a>
    <!-- Shape Controls Hero Bar -->
    <div class="shape-controls-hero">
        <div class="shape-controls">
            <button class="sci-fi-btn shape-btn" data-shape="heart">â™¥</button>
            <button class="sci-fi-btn shape-btn" data-shape="triangle">â–³</button>
            <button class="sci-fi-btn shape-btn" data-shape="square">â–¡</button>
            <button class="sci-fi-btn shape-btn active" data-shape="circle">â—‹</button>
            <button class="sci-fi-btn shape-btn" data-shape="star">â˜…</button>
            <button class="sci-fi-btn shape-btn" data-shape="sun">â˜€</button>
            <button class="sci-fi-btn shape-btn" data-shape="solar">â˜‰</button>
            <button class="sci-fi-btn shape-btn" data-shape="moon">â˜¾</button>
            <button class="sci-fi-btn shape-btn" data-shape="lunar">â—</button>
            <button class="dice-btn" id="randomize-shape-btn" aria-label="Random shape" title="ðŸŽ²">ðŸŽ²</button>
        </div>
    </div>

    <!-- Full-width rotation control bar -->
    <div class="rotation-control-bar">
        <div class="rotation-control-content">
            <div class="rotation-left-section">
                <span class="rotation-label-left rotation-icon">â†º</span>
            </div>
            <div class="rotation-center-section">
                <div class="rotation-slider-wrapper">
                    <input type="range" id="rotation-slider-full" min="-10" max="10" value="0" step="0.1" class="rotation-slider-full">
                    <div class="center-indicator"></div>
                </div>
            </div>
            <div class="rotation-right-section">
                <span class="rotation-label-right rotation-icon">â†»</span>
            </div>
        </div>
    </div>

    <div class="hero-spacer"></div>
    <main class="main-layout" role="main">
        
        <nav class="controls-left left-menu" role="navigation" aria-label="Emotion controls">
            <!-- Audio Visualizer Section -->
            <div class="control-section" id="audio-viz-section">
                <div class="section-header">
                    <h3 class="text-center">Audio Visualizer</h3>
                </div>
                <div id="audio-viz" class="audio-viz-container">
                    <!-- Animated background effect -->
                    <div class="glow-bg-effect"></div>

                    <!-- Audio player overlay (top-right safe zone) -->
                    <div style="
                        position: absolute;
                        top: var(--pos-edge-md);
                        right: var(--pos-edge-md);
                        width: 220px;
                        height: 32px;
                        z-index: var(--z-menu);
                        display: none;
                    " id="audio-player-container">
                        <audio id="audio-player" controls style="
                            width: var(--size-full);
                            height: var(--size-full);
                            border: none !important;
                            outline: none !important;
                            background: var(--bg-transparent);
                            display: block;
                            margin: 0;
                            padding: 0;
                        "></audio>
                    </div>

                    <!-- Frequency spectrum visualizer -->
                    <div id="spectrum-viz" class="spectrum-viz">
                        <!-- Bars will be dynamically created -->
                    </div>
                </div>
            </div>

            <!-- Hidden file input -->
            <input type="file" id="audio-file" accept="audio/*" class="hidden">
            <div class="control-section undertone-section">
                <div class="undertone-group">
                    <div class="section-header">
                        <h3 class="text-center">UNDERTONE MODIFIER</h3>
                    </div>
                    <div class="undertone-controls-container">
                        <div class="undertone-slider-container">
                        <div class="flex-between mb-8">
                            <span class="undertone-label">SUBDUED</span>
                            <span class="undertone-label">INTENSE</span>
                        </div>
                        <input type="range" id="undertone-slider" min="-3" max="3" value="0" step="1" class="rhythm-slider">
                    </div>
                    <div class="text-center p-3-0">
                        <span id="undertone-value" class="undertone-value">CLEAR</span>
                    </div>
                    </div> <!-- Close undertone-controls-container -->
                </div>
            </div>


            <!-- Chain Combos Section -->
            <div class="control-section">
                <div class="combo-categories">
                    <div class="combo-group">
                        <div class="section-header">
                            <button class="dice-btn mr-10" id="randomize-chain-btn" aria-label="Random chain" title="ðŸŽ²">ðŸŽ²</button>
                            <h3 class="section-title">CHAIN COMBOS</h3>
                        </div>
                        <div class="combo-controls-container">
                            <!-- Animated background effect -->
                            <div class="glow-bg-effect"></div>
                        <div class="btn-group chain-group" role="group" aria-label="Chain combinations">
                            <button class="sci-fi-btn chain-btn" data-chain="buildup">Build</button>
                            <button class="sci-fi-btn chain-btn" data-chain="cascade">Cascade</button>
                            <button class="sci-fi-btn chain-btn" data-chain="celebrate">Celebrate</button>
                            <button class="sci-fi-btn chain-btn" data-chain="smooth">Smooth</button>
                            <button class="sci-fi-btn chain-btn" data-chain="chaos">Chaos</button>
                            <button class="sci-fi-btn chain-btn" data-chain="custom">Custom</button>
                        </div>
                        </div> <!-- Close combo-controls-container -->
                    </div>
                </div>
            </div>

            <!-- Glow Effects -->
            <div class="control-section">
                <div class="glow-categories">
                    <div class="glow-group">
                        <div class="section-header">
                            <button class="dice-btn mr-10" id="randomize-glow-btn" aria-label="Random glow" title="ðŸŽ²">ðŸŽ²</button>
                            <h3 class="section-title">GLOW EFFECTS</h3>
                        </div>
                        <div class="glow-controls-container">
                            <!-- Animated background effect -->
                            <div class="glow-bg-effect"></div>
                        <div class="btn-group" role="group" aria-label="Glow animations">
                            <button class="sci-fi-btn gesture-btn" data-gesture="sparkle">Sparkle</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="pulse">Pulse</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="glow">Glow</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="flash">Flash</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="shimmer">Shimmer</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="flicker">Flicker</button>
                        </div>
                        </div> <!-- Close glow-controls-container -->
                    </div>
                </div>
            </div>

        </nav>

        <div class="center-container">
            <div class="display-and-controls">
                <!-- Left emotion panel (positive) -->
                <div class="emotion-panel emotion-panel-left">
                    <button class="sci-fi-btn emotion-btn active" data-emotion="neutral" aria-label="Neutral" title="Neutral">ðŸ˜</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="calm" aria-label="Calm" title="Calm">ðŸ˜Œ</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="joy" aria-label="Joy" title="Joy">ðŸ˜Š</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="excited" aria-label="Excited" title="Excited">ðŸ¤©</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="love" aria-label="Love" title="Love">ðŸ¥°</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="euphoria" aria-label="Euphoria" title="Euphoria">âœ¨</button>
                </div>
                
                <div id="display-container" class="display-container">
                    <div class="display-content">
                        <canvas id="emotive-canvas"></canvas>
                        <div class="logo-watermark">
                            <img id="logo-image" class="logo-image" src="assets/emotive-engine-full-BW.svg" alt="Emotive Engine">
                        </div>
                        <!-- HUD Tooltip -->
                        <div id="hud-tooltip" class="hud-tooltip"></div>
                        <!-- Theme Switcher -->
                        <div class="theme-switcher border-none" id="theme-switcher">
                            <svg class="theme-icon" id="theme-icon" viewBox="0 0 24 24" fill="currentColor">
                                <!-- Icon path will be replaced dynamically -->
                                <path d="" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="holo-element corner-bracket top-left"></div>
                        <div class="holo-element corner-bracket top-right"></div>
                        <div class="holo-element corner-bracket bottom-left"></div>
                        <div class="holo-element corner-bracket bottom-right"></div>
                        <div class="holo-element holo-circle circle-1"></div>
                        <div class="holo-element holo-circle circle-2"></div>
                    </div>
                </div>
                
                <!-- Right emotion panel (negative) -->
                <div class="emotion-panel emotion-panel-right">
                    <button class="sci-fi-btn emotion-btn" data-emotion="surprise" aria-label="Surprise" title="Surprise">ðŸ˜²</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="fear" aria-label="Fear" title="Fear">ðŸ˜¨</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="disgust" aria-label="Disgust" title="Disgust">ðŸ¤¢</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="sadness" aria-label="Sadness" title="Sadness">ðŸ˜¢</button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="anger" aria-label="Anger" title="Anger">ðŸ˜ </button>
                    <button class="sci-fi-btn emotion-btn" data-emotion="glitch" aria-label="Glitch" title="Glitch">ðŸ‘¾</button>
                </div>
                
                <!-- System controls moved outside for proper clickability -->
            </div>
            <!-- Displays positioned at highest level -->
            <div class="holo-element info-display">
                <div class="status-text" id="emotion-display">EMOTION: NEUTRAL</div>
                <div class="undertone-text" id="undertone-display">STABLE</div>
            </div>
            <div class="fps-display" id="fps-display">
                <span class="fps-value" id="fps-value">0</span>
                <span class="fps-label">FPS</span>
            </div>
        </div>

        <!-- System controls moved completely outside center-container -->
        <div class="system-controls" role="group" aria-label="System controls">
            <div class="system-controls-group">
                <button class="sci-fi-btn audio-icon-btn" id="load-audio-btn" aria-label="Play demo song">â–¶</button>
                <button class="sci-fi-btn audio-icon-btn" id="load-song-btn" aria-label="Load audio file">â™ª</button>
            </div>
            <div class="system-controls-divider"></div>
            <div class="system-controls-group">
                <button class="sci-fi-btn active" id="blinking-toggle" aria-label="Toggle blinking" aria-pressed="true">ðŸ‘</button>
                <button class="sci-fi-btn" id="gaze-toggle" aria-label="Toggle gaze tracking" aria-pressed="false">ðŸ‘€</button>
                <button class="sci-fi-btn" id="fps-toggle" aria-label="Toggle FPS display" aria-pressed="false">â–£</button>
                <button class="sci-fi-btn" id="record-btn" aria-label="Toggle audio recording" aria-pressed="false">â—</button>
                <button class="sci-fi-btn master-dice" id="randomize-all-btn" aria-label="Randomize everything" aria-pressed="false">âŸ³</button>
            </div>
        </div>

        <aside class="controls-right right-menu" role="complementary" aria-label="Gesture controls">
            <!-- Rhythm Sync Section -->
            <div class="control-section">
                <div class="rhythm-group">
                    <div class="section-header">
                        <h3 class="section-title">RHYTHM SYNC</h3>
                    </div>
                    <div class="rhythm-controls-container">
                        <!-- Animated background effect -->
                        <div class="glow-bg-effect"></div>

                        <!-- Main rhythm controls -->
                        <div class="rhythm-controls">
                        <!-- Beat indicator -->
                        <div id="beat-indicator" class="beat-indicator">
                            <div class="beat-ring-outer"></div>
                            <div class="beat-ring-inner"></div>
                            <div id="beat-dot" class="beat-dot"></div>
                        </div>

                        <!-- BPM slider -->
                        <input type="range" id="bpm-slider" min="60" max="360" value="120" class="rhythm-slider flex-1">

                        <!-- BPM value input -->
                        <input type="number" id="bpm-value" class="bpm-input" value="120" min="60" max="360">

                        <!-- Play/pause button -->
                        <button class="rhythm-toggle-btn" id="rhythm-toggle" aria-label="Toggle rhythm">
                            <span id="rhythm-status" class="rhythm-status">â–¶</span>
                        </button>
                    </div>

                    <!-- BPM modifier buttons -->
                    <div class="bpm-modifier-controls">
                        <button class="sci-fi-btn bpm-modifier-btn" data-modifier="0.5" id="bpm-half">Â½Ã—</button>
                        <button class="sci-fi-btn bpm-modifier-btn active" data-modifier="1" id="bpm-regular">1Ã—</button>
                        <button class="sci-fi-btn bpm-modifier-btn" data-modifier="2" id="bpm-double">2Ã—</button>
                    </div>
                    </div> <!-- Close rhythm-controls-container -->
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-header position-relative">
                    <button class="dice-btn mr-10" id="randomize-gesture-btn" aria-label="Random gesture" title="Random gesture">ðŸŽ²</button>
                    <h3 class="section-title">GESTURE PROTOCOL</h3>
                    <button class="sound-toggle ml-10" id="sound-toggle" aria-label="Toggle sound" title="Toggle sound" aria-pressed="false">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <g class="sound-on hidden">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </g>
                            <g class="sound-off">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                <line x1="23" y1="9" x2="17" y2="15"/>
                                <line x1="17" y1="9" x2="23" y2="15"/>
                            </g>
                        </svg>
                    </button>
                </div>
                
                <div class="gesture-categories">
                    <!-- Dance Gestures -->
                    <div class="gesture-group">
                        <div class="section-header">
                            <button class="dice-btn mr-10" id="randomize-dance-btn" aria-label="Random dance" title="ðŸŽ²">ðŸŽ²</button>
                            <h3 class="section-title">DANCE</h3>
                        </div>
                        <div class="dance-controls-container">
                            <!-- Animated background effect -->
                            <div class="glow-bg-effect"></div>
                            <div class="btn-group" role="group" aria-label="Dance animations">
                            <button class="sci-fi-btn gesture-btn" data-gesture="bounce">Bounce</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="sway">Sway</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="headBob">HeadBob</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="wiggle">Wiggle</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="spin">Spin</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="hula">Hula</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="orbit">Orbit</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="groove">Groove</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="jump">Jump</button>
                        </div>
                        </div> <!-- Close dance-controls-container -->
                    </div>

                    <!-- Overlayable Gestures -->
                    <div class="gesture-group">
                        <div class="section-header">
                            <button class="dice-btn mr-10" id="randomize-overlayable-btn" aria-label="Random overlayable" title="ðŸŽ²">ðŸŽ²</button>
                            <h3 class="section-title">OVERLAYABLE</h3>
                        </div>
                        <div class="overlayable-controls-container">
                            <!-- Animated background effect -->
                            <div class="glow-bg-effect"></div>
                            <div class="btn-group" role="group" aria-label="Overlayable animations">
                            <button class="sci-fi-btn gesture-btn" data-gesture="wave">Wave</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="point">Point</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="nod">Nod</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="shake">Shake</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="lean">Lean</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="tilt">Tilt</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="reach">Reach</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="breathe">Breathe</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="float">Float</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="rain">Rain</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="runningman">RunMan</button>
                            <button class="sci-fi-btn gesture-btn" data-gesture="charleston">Charles</button>
                        </div>
                        </div> <!-- Close overlayable-controls-container -->
                    </div>
                </div>
            </div>
        </aside>

    </main>
    
    <!-- Footer with trademark and copyright -->
    <footer class="legal-footer">
        <div class="footer-content">
            <span class="trademark">emotive ENGINEâ„¢</span>
            <span class="separator">â€¢</span>
            <span class="copyright">Â© 2025 Joshua Tollette</span>
            <span class="separator">â€¢</span>
            <a href="#" class="footer-link">License</a>
        </div>
    </footer>

    <script type="module">
        // Performance optimization: Use dynamic import for faster initial load
        let EmotiveEngine;
        let mascot;
        let currentEmotion = 'neutral';
        let currentUndertone = '';
        let showingFPS = false;
        let isRecording = false;
        let currentTheme = 'night';
        let soundEnabled = false;
        
        // Load EmotiveEngine asynchronously
        const loadEngine = async () => {
            const module = await import('./src/EmotiveMascot.js');
            EmotiveEngine = module.default;
            return EmotiveEngine;
        };
        
        // Load rhythm and gesture modules
        let rhythmIntegration, rhythmEngine, GestureScheduler, FPSCounter;
        let gestureScheduler, fpsCounter;
        // Make rhythmActive global so rhythmIntegration can update it
        window.rhythmActive = false;
        
        // Rhythm presets for different music genres
        const rhythmPresets = {
            ambient: {
                bpm: 72,
                pattern: '4/4',
                gestures: ['breathe', 'float', 'drift']
            },
            electronic: {
                bpm: 128,
                pattern: '4/4',
                gestures: ['pulse', 'flash', 'vibrate']
            },
            jazz: {
                bpm: 96,
                pattern: '4/4',
                gestures: ['sway', 'bounce', 'tilt']
            },
            dnb: {
                bpm: 174,
                pattern: '4/4',
                gestures: ['shake', 'jitter', 'twitch']
            }
        };
        
        const loadRhythmModules = async () => {
            const [rhythmIntegrationModule, rhythmModule, gestureModule, fpsModule] = await Promise.all([
                import('./src/core/rhythmIntegration.js'),
                import('./src/core/rhythm.js'),
                import('./src/core/GestureScheduler.js'),
                import('./src/utils/FPSCounter.js')
            ]);
            rhythmIntegration = rhythmIntegrationModule.default;
            rhythmEngine = rhythmModule.rhythmEngine;
            GestureScheduler = gestureModule.default;
            FPSCounter = fpsModule.default;
        };

        // Theme management
        const themes = ['light', 'dark', 'night'];
        const themeIcons = {
            // Sun icon for light theme - larger starburst with eclipse-matching center hole
            'light': 'M 12 0 L 9.5 6.5 A 5.5 5.5 0 0 1 14.5 6.5 L 12 0 z M 2 2 L 6.5 9.5 A 5.5 5.5 0 0 1 9.5 6.5 L 2 2 z M 0 12 L 6.5 14.5 A 5.5 5.5 0 0 1 6.5 9.5 L 0 12 z M 2 22 L 9.5 17.5 A 5.5 5.5 0 0 1 6.5 14.5 L 2 22 z M 12 24 L 14.5 17.5 A 5.5 5.5 0 0 1 9.5 17.5 L 12 24 z M 22 22 L 17.5 14.5 A 5.5 5.5 0 0 1 14.5 17.5 L 22 22 z M 24 12 L 17.5 9.5 A 5.5 5.5 0 0 1 17.5 14.5 L 24 12 z M 22 2 L 14.5 6.5 A 5.5 5.5 0 0 1 17.5 9.5 L 22 2 z',
            // Moon icon for dark theme - crescent using negative space
            'dark': 'M 12 3 C 7.03 3 3 7.03 3 12 C 3 16.97 7.03 21 12 21 C 16.97 21 21 16.97 21 12 C 21 11.34 20.91 10.7 20.75 10.09 C 19.84 10.67 18.75 11 17.57 11 C 14.48 11 12 8.52 12 5.43 C 12 4.25 12.33 3.16 12.91 2.25 C 12.61 3.09 12 3 12 3 z',
            // Eclipse icon for night theme - sun with moon overlay
            'night': 'M 12 2 C 6.48 2 2 6.48 2 12 C 2 17.52 6.48 22 12 22 C 17.52 22 22 17.52 22 12 C 22 6.48 17.52 2 12 2 z M 15 4.5 C 18.04 4.5 20.5 6.96 20.5 10 C 20.5 13.04 18.04 15.5 15 15.5 C 11.96 15.5 9.5 13.04 9.5 10 C 9.5 6.96 11.96 4.5 15 4.5 z'
        };
        const iconColors = {
            'light': '#007acc',  /* blue - light theme CAN have blue */
            'dark': '#00e5ff',   /* cyan - dark theme CAN have blue */
            'night': '#CC6633'   /* burnt orange/copper - night theme NO blues */
        };

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            const path = icon.querySelector('path');
            path.setAttribute('d', themeIcons[theme]);
            path.setAttribute('fill-rule', 'evenodd');
            icon.style.color = iconColors[theme];
        }

        function cycleTheme() {
            const currentIndex = themes.indexOf(currentTheme);
            currentTheme = themes[(currentIndex + 1) % themes.length];
            
            // Remove all theme classes and apply new one
            document.body.classList.remove(...themes);
            document.body.classList.add(currentTheme);
            
            // Update icon
            updateThemeIcon(currentTheme);
            
            // Update logo filter to match theme with subtle tint
            const logo = document.getElementById('logo-image');
            if (logo) {
                switch(currentTheme) {
                    case 'light':
                        // Subtle blue tint for light theme
                        logo.style.filter = 'brightness(0) sepia(1) saturate(5) hue-rotate(190deg) brightness(0.4)';
                        break;
                    case 'night':
                        // Subtle orange tint for night theme  
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(15deg) brightness(0.9)';
                        break;
                    case 'dark':
                    default:
                        // Subtle cyan tint for dark theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(150deg) brightness(0.95)';
                        break;
                }
            }
            
            // Save preference
            localStorage.setItem('emotive-theme', currentTheme);
        }

        async function init() {
            // Load saved theme
            const savedTheme = localStorage.getItem('emotive-theme') || 'night';
            currentTheme = savedTheme;
            document.body.classList.remove(...themes);
            document.body.classList.add(currentTheme);
            updateThemeIcon(currentTheme);
            
            // Set initial logo filter based on theme with subtle tint
            const logo = document.getElementById('logo-image');
            if (logo) {
                switch(currentTheme) {
                    case 'light':
                        // Subtle blue tint for light theme
                        logo.style.filter = 'brightness(0) sepia(1) saturate(5) hue-rotate(190deg) brightness(0.4)';
                        break;
                    case 'night':
                        // Subtle orange tint for night theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(15deg) brightness(0.9)';
                        break;
                    case 'dark':
                    default:
                        // Subtle cyan tint for dark theme
                        logo.style.filter = 'brightness(0) invert(1) sepia(1) saturate(2) hue-rotate(150deg) brightness(0.95)';
                        break;
                }
            }

            // Load engine dynamically for better performance
            await loadEngine();
            
            mascot = new EmotiveEngine({
                canvasId: 'emotive-canvas',
                startingEmotion: 'neutral',
                emotionalResponsiveness: 0.8,
                particleIntensity: 1.0,
                glowIntensity: 0.8,
                audioEnabled: true,  // Initialize audio system
                showFPS: false,
                debugMode: false,
                renderMode: 'default',
                maxParticles: 100,
                topOffset: 0  // No offset needed after fixing CSS gap
            });
            
            // Initialize audio analyzer
            if (mascot.audioAnalyzer) {
                await mascot.audioAnalyzer.init();
            }
            
            // After mascot is created, disable sound until user enables it
            setTimeout(() => {
                if (mascot.soundSystem) {
                    mascot.soundSystem.isEnabled = false;
                }
            }, 100);
            
            mascot.start();
            
            // Don't set initial BPM - rotation only happens when rhythm is active
            
            // Initialize spectrum visualizer bars
            const spectrumViz = document.getElementById('spectrum-viz');
            const numBars = 16; // Reduced for cleaner look
            for (let i = 0; i < numBars; i++) {
                const bar = document.createElement('div');
                bar.className = 'spectrum-bar';
                bar.style.cssText = `
                    flex: 1;
                    background: linear-gradient(180deg, var(--accent-glow), var(--accent-primary));
                    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
                    transition: height 0.15s ease-out;
                    opacity: var(--opacity-80);
                    min-height: 2px;
                    height: 2px;
                `;
                spectrumViz.appendChild(bar);
            }
            
            // Audio visualizer state - moved to global scope for event listeners
            window.audioVizActive = false;
            window.audioVizAnimationId = null;
            
            // Initialize audio visualizer update loop - make globally accessible
            window.updateAudioViz = function() {
                // Only update if audio is actually playing
                if (!window.audioVizActive) {
                    window.audioVizAnimationId = null;
                    return;
                }
                
                if (mascot && mascot.shapeMorpher) {
                    const morpher = mascot.shapeMorpher;
                    
                    // Update spectrum bars
                    if (morpher.frequencyData && morpher.frequencyData.length > 0) {
                        // Check if we have any non-zero data (only log once)
                        const hasData = morpher.frequencyData.some(v => v > 0);
                        if (!hasData && !window.vizDataWarned) {
                            console.log('Warning: Histogram has no data. Check console for AudioAnalyzer messages.');
                            window.vizDataWarned = true;
                        } else if (hasData && window.vizDataWarned) {
                            console.log('Histogram now receiving data!');
                            window.vizDataWarned = false;
                        }
                        const bars = spectrumViz.querySelectorAll('.spectrum-bar');
                        const bandsPerBar = Math.floor(morpher.frequencyData.length / numBars);
                        
                        bars.forEach((bar, i) => {
                            // Average the energy for bands that map to this bar
                            let energy = 0;
                            let count = 0;
                            for (let j = 0; j < bandsPerBar; j++) {
                                const bandIndex = i * bandsPerBar + j;
                                if (bandIndex < morpher.frequencyData.length) {
                                    energy += morpher.frequencyData[bandIndex] || 0;
                                    count++;
                                }
                            }
                            energy = count > 0 ? energy / count : 0;
                            
                            // Apply logarithmic scaling for better visual response
                            const height = Math.pow(energy, 0.7) * 100;
                            bar.style.height = `${Math.max(2, Math.min(100, height))}%`;
                            
                            // Color variation based on frequency range
                            if (i < 2) {
                                // Bass frequencies - use primary accent
                                bar.style.opacity = '1';
                                bar.style.filter = 'hue-rotate(0deg)';
                            } else if (i >= 6 && i <= 10) {
                                // Mid frequencies (vocals) - use secondary accent  
                                bar.style.opacity = '0.9';
                                bar.style.filter = 'hue-rotate(60deg)';
                            } else {
                                // High frequencies
                                bar.style.opacity = '0.7';
                                bar.style.filter = 'hue-rotate(120deg)';
                            }
                        });
                    }
                }
                
                window.audioVizAnimationId = requestAnimationFrame(window.updateAudioViz);
            }
            
            // Start/stop audio visualizer based on audio state - make globally accessible
            window.startAudioViz = function() {
                if (!window.audioVizActive) {
                    window.audioVizActive = true;
                    window.updateAudioViz();
                }
            }
            
            window.stopAudioViz = function() {
                window.audioVizActive = false;
                if (window.audioVizAnimationId) {
                    cancelAnimationFrame(window.audioVizAnimationId);
                    window.audioVizAnimationId = null;
                }
                // Reset bars to minimum height
                const bars = spectrumViz.querySelectorAll('.spectrum-bar');
                bars.forEach(bar => {
                    bar.style.height = '2%';
                });
            }
            
            // Load and initialize rhythm modules
            await loadRhythmModules();
            
            // Initialize rhythm system
            rhythmIntegration.initialize();
            
            // Make rhythmIntegration globally accessible for BPM updates
            window.rhythmIntegration = rhythmIntegration;
            
            // Initialize BPM Modifier early
            let currentBPMModifier = 1.0; // Default to regular (1x)
            window.currentBPMModifier = currentBPMModifier;
            
            // Initialize gesture scheduler
            gestureScheduler = new GestureScheduler(mascot);
            
            // Setup scheduler callbacks for visual feedback
            gestureScheduler.onGestureQueued = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.add('gesture-pending');
                }
            };
            
            gestureScheduler.onGestureTriggered = (item) => {
                const btn = document.querySelector(`.gesture-btn[data-gesture="${item.gestureName}"]`);
                if (btn) {
                    btn.classList.remove('gesture-pending');
                    btn.classList.add('gesture-triggered');
                    setTimeout(() => btn.classList.remove('gesture-triggered'), 200);
                }
            };
            
            // Setup beat indicator
            rhythmEngine.on('beat', (beatInfo) => {
                if (window.rhythmActive) {
                    const beatDot = document.getElementById('beat-dot');
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
                    const glowColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-glow');
                    
                    beatDot.style.width = '20px';
                    beatDot.style.height = '20px';
                    beatDot.style.background = accentColor;
                    beatDot.style.boxShadow = `0 0 20px ${glowColor}`;
                    
                    setTimeout(() => {
                        beatDot.style.width = '10px';
                        beatDot.style.height = '10px';
                        beatDot.style.background = accentColor;
                        beatDot.style.boxShadow = 'none';
                    }, 100);
                }
            });
            
            // Initialize FPS counter
            fpsCounter = new FPSCounter();
            
            // Start FPS tracking animation loop
            function updateFPS() {
                const fps = fpsCounter.update();
                if (showingFPS) {
                    document.getElementById('fps-value').textContent = fps;
                }
                requestAnimationFrame(updateFPS);
            }
            updateFPS();
            
            setupEventHandlers();
            updateDisplay();
            // initSystemControlsAnimation(); // Disabled - system controls always visible
            
            // Handle orientation changes - blur both sides of transition
            let previousOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
            let isTransitioning = false;
            
            const handleOrientationChange = () => {
                const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
                
                if (currentOrientation !== previousOrientation && !isTransitioning) {
                    isTransitioning = true;
                    
                    // Heavy blur on current frame
                    document.body.style.filter = 'blur(30px)';
                    
                    // Wait for blur, then switch with new view pre-blurred
                    setTimeout(() => {
                        previousOrientation = currentOrientation;
                        
                        // Clear particles while blurred
                        if (mascot && mascot.particleSystem) {
                            mascot.particleSystem.particles = [];
                        }
                        
                        // Force canvas resize to prevent orb squishing
                        if (mascot && mascot.canvasManager) {
                            // Wait a frame for layout to settle
                            requestAnimationFrame(() => {
                                // Force full canvas reset
                                const canvas = mascot.canvasManager.canvas;
                                
                                // Clear any inline dimensions
                                canvas.style.width = '';
                                canvas.style.height = '';
                                
                                // Let CSS reflow
                                const rect = canvas.getBoundingClientRect();
                                
                                // Reset the canvas internal dimensions
                                mascot.canvasManager.dpr = window.devicePixelRatio || 1;
                                mascot.canvasManager.width = rect.width;
                                mascot.canvasManager.height = rect.height;
                                mascot.canvasManager.canvas.width = rect.width * mascot.canvasManager.dpr;
                                mascot.canvasManager.canvas.height = rect.height * mascot.canvasManager.dpr;
                                mascot.canvasManager.centerX = rect.width / 2;
                                mascot.canvasManager.centerY = rect.height / 2;
                                
                                // Reset context scaling
                                mascot.canvasManager.ctx.setTransform(1, 0, 0, 1, 0, 0);
                                mascot.canvasManager.ctx.scale(mascot.canvasManager.dpr, mascot.canvasManager.dpr);
                                
                                // Update renderer's scale factor
                                if (mascot.renderer) {
                                    const canvasSize = Math.min(rect.width || 400, rect.height || 400);
                                    mascot.renderer.scaleFactor = (canvasSize / 400) * (mascot.renderer.config.baseScale || 1.0);
                                    
                                    // Force offscreen canvas update
                                    if (mascot.renderer.offscreenCanvas) {
                                        mascot.renderer.offscreenCanvas.width = rect.width;
                                        mascot.renderer.offscreenCanvas.height = rect.height;
                                    }
                                    
                                    // Clear caches
                                    if (mascot.renderer.glowCache) {
                                        mascot.renderer.glowCache.clear();
                                    }
                                }
                            });
                        }
                        
                        // Keep blur for incoming view
                        document.body.style.filter = 'blur(25px)';
                        
                        // Then quickly unblur to reveal new layout
                        setTimeout(() => {
                            document.body.style.filter = '';
                            isTransitioning = false;
                            
                            // Double-check canvas dimensions after transition
                            if (mascot && mascot.canvasManager) {
                                // Wait two frames to ensure complete layout settlement
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(() => {
                                        const canvas = mascot.canvasManager.canvas;
                                        canvas.style.width = '';
                                        canvas.style.height = '';
                                        
                                        const rect = canvas.getBoundingClientRect();
                                        
                                        mascot.canvasManager.dpr = window.devicePixelRatio || 1;
                                        mascot.canvasManager.width = rect.width;
                                        mascot.canvasManager.height = rect.height;
                                        mascot.canvasManager.canvas.width = rect.width * mascot.canvasManager.dpr;
                                        mascot.canvasManager.canvas.height = rect.height * mascot.canvasManager.dpr;
                                        mascot.canvasManager.centerX = rect.width / 2;
                                        mascot.canvasManager.centerY = rect.height / 2;
                                        
                                        mascot.canvasManager.ctx.setTransform(1, 0, 0, 1, 0, 0);
                                        mascot.canvasManager.ctx.scale(mascot.canvasManager.dpr, mascot.canvasManager.dpr);
                                        
                                        if (mascot.renderer) {
                                            const canvasSize = Math.min(rect.width || 400, rect.height || 400);
                                            mascot.renderer.scaleFactor = (canvasSize / 400) * (mascot.renderer.config.baseScale || 1.0);
                                            
                                            if (mascot.renderer.offscreenCanvas) {
                                                mascot.renderer.offscreenCanvas.width = rect.width;
                                                mascot.renderer.offscreenCanvas.height = rect.height;
                                            }
                                            
                                            if (mascot.renderer.glowCache) {
                                                mascot.renderer.glowCache.clear();
                                            }
                                        }
                                    });
                                });
                            }
                        }, 50);
                    }, 150);
                }
            };
            
            // Single debounced resize handler
            let resizeTimeout;
            let blurApplied = false;
            
            window.addEventListener('resize', () => {
                const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
                
                // Only apply blur once when orientation actually changes
                if (currentOrientation !== previousOrientation && !isTransitioning && !blurApplied) {
                    document.body.style.filter = 'blur(30px)';
                    blurApplied = true;
                }
                
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    handleOrientationChange();
                    blurApplied = false; // Reset for next orientation change
                }, 100);
            });
            
            if ('orientation' in window) {
                window.addEventListener('orientationchange', () => {
                    if (!isTransitioning) {
                        // Apply heavy blur immediately
                        document.body.style.filter = 'blur(30px)';
                        setTimeout(handleOrientationChange, 100);
                    }
                });
            }
        }

        function setupEventHandlers() {
            // Theme switcher
            document.getElementById('theme-switcher').addEventListener('click', cycleTheme);
            
            // Sound toggle
            const soundToggle = document.getElementById('sound-toggle');
            const soundOn = soundToggle.querySelector('.sound-on');
            const soundOff = soundToggle.querySelector('.sound-off');
            
            // Function to update button appearance based on state
            const updateSoundButton = (enabled) => {
                if (enabled) {
                    soundToggle.classList.add('active');
                    soundOn.style.display = 'block';
                    soundOff.style.display = 'none';
                    soundToggle.setAttribute('aria-pressed', 'true');
                } else {
                    soundToggle.classList.remove('active');
                    soundOn.style.display = 'none';
                    soundOff.style.display = 'block';
                    soundToggle.setAttribute('aria-pressed', 'false');
                }
            };
            
            // Initialize button to show disabled state
            updateSoundButton(false);
            
            soundToggle.addEventListener('click', () => {
                if (!mascot || !mascot.soundSystem) return;
                
                // Toggle the sound state
                soundEnabled = !soundEnabled;
                
                // Update mascot configuration and sound system
                mascot.config.enableAudio = soundEnabled;
                mascot.soundSystem.isEnabled = soundEnabled;
                
                // Update button appearance
                updateSoundButton(soundEnabled);
                
                if (!soundEnabled && mascot.soundSystem.isAvailable()) {
                    // Stop any playing ambient tones when disabling
                    mascot.soundSystem.stopAmbientTone(200);
                }
                
                console.log('Sound', soundEnabled ? 'enabled' : 'disabled');
            });

            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentEmotion = btn.dataset.emotion;
                    mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                    
                    document.querySelectorAll('.emotion-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-pressed', 'true');
                    updateDisplay();
                });
            });

            document.querySelectorAll('.gesture-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const gestureName = btn.dataset.gesture;
                    
                    // Special handling for morph gesture - morph core to random shape
                    if (gestureName === 'morph' && mascot) {
                        const shapes = ['heart', 'star', 'sun', 'moon', 'lunar', 'solar', 'square', 'triangle'];
                        const randomShape = shapes[Math.floor(Math.random() * shapes.length)];
                        mascot.morphTo(randomShape, {
                            duration: window.rhythmActive ? 'bar' : 1000,
                            mode: 'core-only',
                            onBeat: window.rhythmActive
                        });
                        
                        // Update visual feedback
                        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
                        const shapeBtn = document.querySelector(`.shape-btn[data-shape="${randomShape}"]`);
                        if (shapeBtn) shapeBtn.classList.add('active');
                    } else if (window.rhythmActive && gestureScheduler) {
                        gestureScheduler.requestGesture(gestureName);
                    } else {
                        mascot.express(gestureName);
                    }
                });
            });
            
            // Chain button functionality
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const chainType = btn.dataset.chain;
                    
                    // Define chains - these stack with z-index layering
                    const chains = {
                        buildup: [
                            { gesture: 'bounce', delay: 0 },
                            { gesture: 'sway', delay: 100 },
                            { gesture: 'glow', delay: 200 },
                            { gesture: 'sparkle', delay: 500 }
                        ],
                        cascade: [
                            { gesture: 'wave', delay: 0 },
                            { gesture: 'pulse', delay: 100 },
                            { gesture: 'shimmer', delay: 200 }
                        ],
                        celebrate: [
                            { gesture: 'spin', delay: 0 },
                            { gesture: 'bounce', delay: 100 },
                            { gesture: 'sparkle', delay: 200 },
                            { gesture: 'flash', delay: 400 }
                        ],
                        smooth: [
                            { gesture: 'sway', delay: 0 },
                            { gesture: 'wave', delay: 100 },
                            { gesture: 'glow', delay: 200 },
                            { gesture: 'point', delay: 400 }
                        ],
                        chaos: [
                            { gesture: 'wiggle', delay: 0 },
                            { gesture: 'shake', delay: 50 },
                            { gesture: 'spin', delay: 100 },
                            { gesture: 'flash', delay: 150 },
                            { gesture: 'sparkle', delay: 200 }
                        ],
                        custom: [
                            { gesture: 'lean', delay: 0 },
                            { gesture: 'reach', delay: 150 },
                            { gesture: 'groove', delay: 300 },
                            { gesture: 'shimmer', delay: 450 },
                            { gesture: 'orbit', delay: 600 }
                        ]
                    };
                    
                    const chain = chains[chainType];
                    if (chain && mascot) {
                        // 10% chance to trigger a shape morph with the chain
                        if (Math.random() < 0.1) {
                            // Get all available shapes
                            const shapes = Array.from(document.querySelectorAll('.shape-btn')).map(b => b.dataset.shape);
                            const currentShape = document.querySelector('.shape-btn.active')?.dataset.shape;
                            const availableShapes = shapes.filter(s => s !== currentShape);
                            
                            if (availableShapes.length > 0) {
                                // Pick a random shape and morph to it
                                const randomShape = availableShapes[Math.floor(Math.random() * availableShapes.length)];
                                
                                // Trigger the morph slightly before the chain starts for better effect
                                setTimeout(() => {
                                    document.querySelector(`.shape-btn[data-shape="${randomShape}"]`).click();
                                }, 0);
                            }
                        }
                        
                        // Execute chain with delays for layering effect
                        chain.forEach(item => {
                            setTimeout(() => {
                                if (window.rhythmActive && gestureScheduler) {
                                    gestureScheduler.requestGesture(item.gesture);
                                } else {
                                    mascot.express(item.gesture);
                                }
                            }, item.delay);
                        });
                        
                        // Visual feedback
                        btn.style.animation = 'none';
                        setTimeout(() => btn.style.animation = '', 10);
                    }
                });
            });

            // Undertone slider with smooth transitions
            const undertoneSlider = document.getElementById('undertone-slider');
            const undertoneValue = document.getElementById('undertone-value');
            let undertoneDebounceTimer = null;
            let lastUndertone = '';
            
            // Function to get undertone from discrete slider value (-3 to 3)
            function getUndertoneFromValue(value) {
                let undertone = '';
                let displayText = 'CLEAR';

                switch(value) {
                    case -3:
                        undertone = 'subdued';
                        displayText = 'SUBDUED';
                        break;
                    case -2:
                        undertone = 'tired';
                        displayText = 'TIRED';
                        break;
                    case -1:
                        undertone = 'nervous';
                        displayText = 'NERVOUS';
                        break;
                    case 0:
                        undertone = '';
                        displayText = 'CLEAR';
                        break;
                    case 1:
                        undertone = 'energetic';
                        displayText = 'ENERGETIC';
                        break;
                    case 2:
                        undertone = 'confident';
                        displayText = 'CONFIDENT';
                        break;
                    case 3:
                        undertone = 'intense';
                        displayText = 'INTENSE';
                        break;
                    default:
                        undertone = '';
                        displayText = 'CLEAR';
                }

                return { undertone, displayText };
            }
            
            // Initialize undertone slider background
            updateSliderBackground(undertoneSlider);

            // Update display immediately, but debounce mascot updates
            undertoneSlider.addEventListener('input', () => {
                const value = parseInt(undertoneSlider.value);
                const { undertone, displayText } = getUndertoneFromValue(value);

                // Update slider visual
                updateSliderBackground(undertoneSlider);

                // Update display text immediately for responsiveness
                undertoneValue.textContent = displayText;

                // Only update mascot when undertone actually changes
                if (undertone !== lastUndertone) {
                    lastUndertone = undertone;
                    currentUndertone = undertone;
                    
                    // Clear any pending update
                    if (undertoneDebounceTimer) {
                        clearTimeout(undertoneDebounceTimer);
                    }
                    
                    // Debounce the mascot update for smoothness
                    undertoneDebounceTimer = setTimeout(() => {
                        // Use updateUndertone to prevent glow multiplication
                        if (mascot.updateUndertone) {
                            mascot.updateUndertone(currentUndertone || null);
                        } else {
                            // Fallback to setEmotion if direct method not available
                            mascot.setEmotion(currentEmotion, currentUndertone || undefined);
                        }
                        updateDisplay();
                    }, 50); // Small delay for smooth transitions
                }
            });

            document.getElementById('fps-toggle').addEventListener('click', function() {
                showingFPS = !showingFPS;
                document.getElementById('fps-display').classList.toggle('active', showingFPS);
                // Keep icon only, no text
                this.classList.toggle('active', showingFPS);
                this.setAttribute('aria-pressed', showingFPS ? 'true' : 'false');
                
                // Start or stop FPS updates
                if (showingFPS) {
                    updateFPS();
                }
            });
            
            // Blinking toggle
            let blinkingEnabled = true;
            document.getElementById('blinking-toggle').addEventListener('click', function() {
                blinkingEnabled = !blinkingEnabled;
                // Keep icon only, no text
                this.classList.toggle('active', blinkingEnabled);
                this.setAttribute('aria-pressed', blinkingEnabled ? 'true' : 'false');

                // Set blinking on the renderer (which actually controls the blinking)
                if (mascot && mascot.renderer) {
                    mascot.renderer.setBlinkingEnabled(blinkingEnabled);
                }
            });

            // Gaze tracker toggle
            let gazeTrackingEnabled = false;
            document.getElementById('gaze-toggle').addEventListener('click', function() {
                gazeTrackingEnabled = !gazeTrackingEnabled;
                this.classList.toggle('active', gazeTrackingEnabled);
                this.setAttribute('aria-pressed', gazeTrackingEnabled ? 'true' : 'false');

                // Set gaze tracking on the mascot
                if (mascot) {
                    mascot.setGazeTracking(gazeTrackingEnabled);
                }
            });
            
            // Rhythm controls
            document.getElementById('rhythm-toggle').addEventListener('click', function() {
                const bpm = document.getElementById('bpm-slider').value;
                const pattern = 'straight'; // Default pattern
                
                if (!window.rhythmActive) {
                    // Starting rhythm
                    const shapeMorpher = mascot?.shapeMorpher;
                    
                    // If audio is playing, reset detection to get fresh BPM
                    if (shapeMorpher && audioPlayer && !audioPlayer.paused) {
                        // Reset detection for fresh readings
                        shapeMorpher.resetMusicDetection();
                        console.log('ðŸ”„ Resampling BPM and time signature...');
                        
                        // Unlock BPM in rhythm integration for resampling
                        if (rhythmIntegration.resampleBPM) {
                            rhythmIntegration.resampleBPM();
                        }
                        
                        // Clear the manual stop flag so auto-detection can work
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                        
                        // The BPM detection will auto-start rhythm when ready
                        // For now, show pending state
                        document.getElementById('rhythm-status').textContent = 'â³';
                        this.classList.add('pending');
                        
                        // Fallback: start with slider value if no BPM detected after 2 seconds
                        setTimeout(() => {
                            if (!window.rhythmActive) {
                                console.log('â° Timeout - starting with default BPM');
                                rhythmIntegration.start(parseInt(bpm), pattern);
                                window.rhythmActive = true;
                                document.getElementById('rhythm-status').textContent = 'â¸';
                                this.classList.remove('pending');
                                this.classList.add('active');
                                // Update mascot core rotation
                                if (mascot && mascot.setBPM) {
                                    mascot.setBPM(parseInt(bpm));
                                }
                            }
                        }, 2000);
                    } else {
                        // No audio playing, use slider value immediately
                        rhythmIntegration.start(parseInt(bpm), pattern);
                        window.rhythmActive = true;
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                        document.getElementById('rhythm-status').textContent = 'â¸';
                        this.classList.add('active');
                        // Update mascot core rotation
                        if (mascot && mascot.setBPM) {
                            mascot.setBPM(parseInt(bpm));
                        }
                    }
                } else {
                    // Stopping rhythm
                    rhythmIntegration.stop();
                    window.rhythmActive = false;
                    window.rhythmManuallyStoppedForCurrentAudio = true;
                    document.getElementById('rhythm-status').textContent = 'â–¶';
                    this.classList.remove('active');
                    this.classList.remove('pending');
                    
                    // Stop core rotation
                    if (mascot && mascot.setBPM) {
                        mascot.setBPM(0);
                    }
                    
                    // Also stop any pending detection
                    if (mascot?.shapeMorpher) {
                        // Don't reset, just mark as manually stopped
                        console.log('ðŸ›‘ Rhythm sync stopped');
                    }
                }
            });
            
            // Function to update slider background based on value
            function updateSliderBackground(slider) {
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                const value = parseFloat(slider.value);
                const percent = ((value - min) / (max - min)) * 100;

                // Set CSS variable for gradient
                slider.style.setProperty('--value', percent + '%');
            }

            // Sync slider and input field
            const bpmSlider = document.getElementById('bpm-slider');
            const bpmInput = document.getElementById('bpm-value');

            // Initialize BPM slider background
            updateSliderBackground(bpmSlider);

            bpmSlider.addEventListener('input', function(e) {
                const bpm = parseInt(e.target.value);
                bpmInput.value = bpm;
                updateSliderBackground(e.target);
                // Only update mascot core rotation when rhythm is active
                if (window.rhythmActive) {
                    if (mascot && mascot.setBPM) {
                        mascot.setBPM(bpm);
                    }
                    rhythmIntegration.setBPM(bpm);
                }
            });
            
            bpmInput.addEventListener('input', function(e) {
                let bpm = parseInt(e.target.value);
                if (isNaN(bpm)) bpm = 120;
                if (bpm < 60) bpm = 60;
                if (bpm > 360) bpm = 360;
                e.target.value = bpm;
                bpmSlider.value = bpm;

                // Update slider visual
                updateSliderBackground(bpmSlider);

                // Only update mascot core rotation when rhythm is active
                if (window.rhythmActive) {
                    if (mascot && mascot.setBPM) {
                        mascot.setBPM(bpm);
                    }
                    rhythmIntegration.setBPM(bpm);
                }
            });
            
            // Pattern select removed - using default pattern
            
            // BPM Modifier Logic
            currentBPMModifier = window.currentBPMModifier || 1.0; // Use existing or default
            
            // Helper function to apply BPM modifier
            function applyBPMModifier(baseBPM) {
                const modifiedBPM = Math.round(baseBPM * currentBPMModifier);
                // Clamp to valid range
                return Math.max(60, Math.min(360, modifiedBPM));
            }
            
            // Override rhythmIntegration.start to apply modifier
            const originalRhythmStart = rhythmIntegration.start.bind(rhythmIntegration);
            rhythmIntegration.start = function(bpm, pattern) {
                const modifiedBPM = applyBPMModifier(bpm);
                console.log(`ðŸŽµ BPM Modifier: ${bpm} Ã— ${currentBPMModifier} = ${modifiedBPM}`);
                
                // Update UI to show modified BPM
                document.getElementById('bpm-value').value = modifiedBPM;
                document.getElementById('bpm-slider').value = modifiedBPM;
                const percent = ((modifiedBPM - 60) / (360 - 60)) * 100;
                document.getElementById('bpm-slider').style.background = `linear-gradient(to right, var(--accent-primary) 0%, var(--accent-primary) ${percent}%, rgba(255,255,255,0.1) ${percent}%, rgba(255,255,255,0.1) 100%)`;
                
                // Call original with modified BPM
                originalRhythmStart(modifiedBPM, pattern);
                window.rhythmActive = true;
                
                // Update mascot
                if (mascot && mascot.setBPM) {
                    mascot.setBPM(modifiedBPM);
                }
                
                // Update UI
                const rhythmStatus = document.getElementById('rhythm-status');
                if (rhythmStatus) {
                    rhythmStatus.textContent = 'â¸';
                }
                const rhythmToggle = document.getElementById('rhythm-toggle');
                if (rhythmToggle) {
                    rhythmToggle.classList.add('active');
                    rhythmToggle.classList.remove('pending');
                }
            };
            
            // BPM Modifier button handlers
            document.querySelectorAll('.bpm-modifier-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.bpm-modifier-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get the modifier value
                    const modifier = parseFloat(this.dataset.modifier);
                    const previousModifier = currentBPMModifier;
                    currentBPMModifier = modifier;
                    window.currentBPMModifier = modifier;
                    
                    // If rhythm is active, update it with the new modifier
                    if (window.rhythmActive) {
                        // Get the base BPM (reverse the previous modifier)
                        const currentBPM = parseInt(document.getElementById('bpm-value').value);
                        const baseBPM = Math.round(currentBPM / previousModifier);
                        
                        // Stop and restart with new modifier
                        rhythmIntegration.stop();
                        window.rhythmActive = false;
                        
                        // Small delay to ensure clean restart
                        setTimeout(() => {
                            rhythmIntegration.start(baseBPM, 'straight');
                        }, 100);
                    }
                });
            });
            
            document.getElementById('record-btn').addEventListener('click', function() {
                isRecording = !isRecording;
                this.innerHTML = isRecording ? 'â—¼' : 'â—'; // Square for stop, circle for record
                this.classList.toggle('active', isRecording);
                this.classList.toggle('recording', isRecording);
                this.setAttribute('aria-pressed', isRecording ? 'true' : 'false');
                if (isRecording) mascot.startRecording(); else mascot.stopRecording();
            });

            
            // Random emotion dice - function for reuse
            function randomizeEmotion() {
                const emotions = Array.from(document.querySelectorAll('.emotion-btn')).map(b => b.dataset.emotion);
                const currentEmotion = document.querySelector('.emotion-btn.active')?.dataset.emotion;
                const availableEmotions = emotions.filter(e => e !== currentEmotion);
                if (availableEmotions.length === 0) return; // All are the same somehow
                const randomEmotion = availableEmotions[Math.floor(Math.random() * availableEmotions.length)];
                document.querySelector(`.emotion-btn[data-emotion="${randomEmotion}"]`).click();
            }
            
            // Check if randomize button exists (might be removed in some layouts)
            const randomizeBtn = document.getElementById('randomize-btn');
            if (randomizeBtn) {
                randomizeBtn.addEventListener('click', randomizeEmotion);
            }
            
            // Random undertone - now using discrete slider values
            function randomizeUndertone() {
                const randomValue = Math.floor(Math.random() * 7) - 3; // -3 to 3
                undertoneSlider.value = randomValue;
                updateSliderBackground(undertoneSlider);
                undertoneSlider.dispatchEvent(new Event('input'));
            }
            
            // Random shape dice
            document.getElementById('randomize-shape-btn').addEventListener('click', () => {
                const shapes = Array.from(document.querySelectorAll('.shape-btn')).map(b => b.dataset.shape);
                const currentShape = document.querySelector('.shape-btn.active')?.dataset.shape;
                const availableShapes = shapes.filter(s => s !== currentShape);
                if (availableShapes.length === 0) return;
                const randomShape = availableShapes[Math.floor(Math.random() * availableShapes.length)];
                document.querySelector(`.shape-btn[data-shape="${randomShape}"]`).click();
            });
            
            // Random main gesture dice (all gestures)
            document.getElementById('randomize-gesture-btn').addEventListener('click', () => {
                const allGestures = Array.from(document.querySelectorAll('.gesture-btn')).map(b => b.dataset.gesture);
                const activeGestures = Array.from(document.querySelectorAll('.gesture-btn.active')).map(b => b.dataset.gesture);
                const availableGestures = allGestures.filter(g => !activeGestures.includes(g));
                if (availableGestures.length === 0) return;
                const randomGesture = availableGestures[Math.floor(Math.random() * availableGestures.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomGesture}"]`).click();
            });
            
            // Random overlayable gesture dice  
            document.getElementById('randomize-overlayable-btn').addEventListener('click', () => {
                const overlayableGestures = ['wave', 'point', 'nod', 'shake', 'lean', 'tilt', 'reach', 'breathe', 'float', 'rain', 'runningman', 'charleston'];
                // Get currently active gesture if any
                const activeGestures = Array.from(document.querySelectorAll('.gesture-btn.active')).map(b => b.dataset.gesture);
                const availableGestures = overlayableGestures.filter(g => !activeGestures.includes(g));
                if (availableGestures.length === 0) return;
                const randomGesture = availableGestures[Math.floor(Math.random() * availableGestures.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomGesture}"]`).click();
            });
            
            // Random dance dice
            document.getElementById('randomize-dance-btn').addEventListener('click', () => {
                const danceGestures = ['bounce', 'sway', 'headBob', 'wiggle', 'spin', 'hula', 'orbit', 'groove', 'jump'];
                const activeGestures = Array.from(document.querySelectorAll('.gesture-btn.active')).map(b => b.dataset.gesture);
                const availableDances = danceGestures.filter(g => !activeGestures.includes(g));
                if (availableDances.length === 0) return;
                const randomDance = availableDances[Math.floor(Math.random() * availableDances.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomDance}"]`).click();
            });
            
            // Random chain dice
            document.getElementById('randomize-chain-btn').addEventListener('click', () => {
                const chains = Array.from(document.querySelectorAll('.chain-btn')).map(b => b.dataset.chain);
                const currentChain = document.querySelector('.chain-btn.active')?.dataset.chain;
                const availableChains = chains.filter(c => c !== currentChain);
                if (availableChains.length === 0) return;
                const randomChain = availableChains[Math.floor(Math.random() * availableChains.length)];
                document.querySelector(`.chain-btn[data-chain="${randomChain}"]`).click();
            });
            
            // Random glow dice
            document.getElementById('randomize-glow-btn').addEventListener('click', () => {
                const glowGestures = ['sparkle', 'pulse', 'glow', 'flash', 'shimmer', 'flicker'];
                const activeGestures = Array.from(document.querySelectorAll('.gesture-btn.active')).map(b => b.dataset.gesture);
                const availableGlows = glowGestures.filter(g => !activeGestures.includes(g));
                if (availableGlows.length === 0) return;
                const randomGlow = availableGlows[Math.floor(Math.random() * availableGlows.length)];
                document.querySelector(`.gesture-btn[data-gesture="${randomGlow}"]`).click();
            });
            
            // Master dice - roll everything!
            document.getElementById('randomize-all-btn').addEventListener('click', () => {
                // Roll emotion and undertone (no dice buttons for these)
                randomizeEmotion();
                setTimeout(() => randomizeUndertone(), 100);
                
                // Find and trigger ALL dice buttons on the page
                const allDiceButtons = Array.from(document.querySelectorAll('.dice-btn'));
                
                // Trigger each dice with a slight delay for visual cascade effect
                allDiceButtons.forEach((btn, index) => {
                    setTimeout(() => {
                        btn.click();
                    }, (index + 2) * 100); // Start at index+2 since emotion/undertone go first
                });
            });

            // Master Rotation Slider
            const rotationSlider = document.getElementById('rotation-slider');
            const rotationValue = document.getElementById('rotation-value');
            const rotationIndicatorDot = document.getElementById('rotation-indicator');
            const rotationStopBtn = document.getElementById('rotation-stop');
            let rotationDecelerationInterval = null;

            function setRotationSpeed(value) {
                const velocity = parseInt(value); // Direct velocity in degrees per frame

                // Update speed display
                if (rotationValue) {
                    rotationValue.textContent = velocity;
                }

                // Update rotation indicator
                if (rotationIndicatorDot) {
                    if (velocity === 0) {
                        rotationIndicatorDot.style.animation = 'none';
                    } else if (velocity < 0) {
                        // CCW rotation
                        const duration = Math.max(0.5, 20 / Math.abs(velocity));
                        rotationIndicatorDot.style.animation = `rotate-ccw ${duration}s linear infinite`;
                    } else {
                        // CW rotation
                        const duration = Math.max(0.5, 20 / Math.abs(velocity));
                        rotationIndicatorDot.style.animation = `rotate-cw ${duration}s linear infinite`;
                    }
                }

                // Update slider background
                updateSliderBackground(rotationSlider);

                // Set rotation speed in DEGREES per frame
                if (mascot && mascot.setRotationSpeed) {
                    mascot.setRotationSpeed(velocity);
                }
            }

            if (rotationSlider) {
                rotationSlider.addEventListener('input', () => {
                    // Clear any ongoing deceleration
                    if (rotationDecelerationInterval) {
                        clearInterval(rotationDecelerationInterval);
                        rotationDecelerationInterval = null;
                    }

                    // Cancel any braking when slider is moved
                    if (mascot && mascot.renderer && mascot.renderer.rotationBrake) {
                        mascot.renderer.rotationBrake.stop();
                    }

                    const value = parseInt(rotationSlider.value);
                    setRotationSpeed(value);
                });

                // Initialize rotation slider background
                updateSliderBackground(rotationSlider);
            }

            // Stop button with smooth deceleration using RotationBrake system
            if (rotationStopBtn) {
                rotationStopBtn.addEventListener('click', async () => {
                    // Check if mascot and renderer exist
                    if (!mascot || !mascot.renderer || !mascot.renderer.rotationBrake) {
                        console.warn('RotationBrake not available');
                        return;
                    }

                    // Do nothing if not moving or already braking
                    const currentSpeed = mascot.renderer.state.rotationSpeed || 0;
                    if (Math.abs(currentSpeed) < 0.001 || mascot.renderer.rotationBrake.isBraking()) {
                        return;
                    }

                    // Add visual feedback
                    rotationStopBtn.classList.add('braking');

                    // Reset slider immediately for visual feedback
                    rotationSlider.value = 0;
                    if (rotationValue) {
                        rotationValue.textContent = '0';
                    }

                    // Start braking to upright position
                    await mascot.renderer.rotationBrake.brakeToUpright({
                        onProgress: (progress, speed, angle) => {
                            // Update rotation indicator based on virtual speed
                            if (rotationIndicatorDot) {
                                if (Math.abs(speed) < 0.1) {
                                    rotationIndicatorDot.style.animation = 'none';
                                } else {
                                    const duration = Math.max(0.5, 2 / Math.abs(speed / (Math.PI * 2)));
                                    if (speed > 0) {
                                        rotationIndicatorDot.style.animation = `rotate-cw ${duration}s linear infinite`;
                                    } else {
                                        rotationIndicatorDot.style.animation = `rotate-ccw ${duration}s linear infinite`;
                                    }
                                }
                            }
                        },
                        onComplete: () => {
                            // Ensure everything is reset
                            if (rotationIndicatorDot) {
                                rotationIndicatorDot.style.animation = 'none';
                            }
                            rotationStopBtn.classList.remove('braking');
                        }
                    })
                });
            }

            // Full-width rotation slider controls
            const rotationSliderFull = document.getElementById('rotation-slider-full');
            const rotationBrakeBtn = document.getElementById('rotation-brake-btn');
            let isDragging = false;
            let lastPointerTime = 0;

            if (rotationSliderFull) {
                // Helper function to check if click is on thumb
                function isOnThumb(e) {
                    const rect = rotationSliderFull.getBoundingClientRect();
                    const sliderWidth = rect.width;
                    const sliderValue = parseFloat(rotationSliderFull.value);
                    const sliderMin = parseFloat(rotationSliderFull.min);
                    const sliderMax = parseFloat(rotationSliderFull.max);

                    // Calculate thumb center position
                    const thumbCenterX = rect.left + (sliderWidth * ((sliderValue - sliderMin) / (sliderMax - sliderMin)));
                    const clickX = e.clientX || (e.touches && e.touches[0].clientX);

                    // Check if click is within thumb area (85px from center since thumb is 160px wide)
                    return Math.abs(clickX - thumbCenterX) <= 85;
                }

                // Unified pointer events for mouse and touch
                rotationSliderFull.addEventListener('pointerdown', (e) => {
                    lastPointerTime = Date.now();
                    if (isOnThumb(e)) {
                        isDragging = true;
                    }
                });

                rotationSliderFull.addEventListener('pointermove', (e) => {
                    if (isDragging) {
                        // Cancel any braking when dragging
                        if (mascot && mascot.renderer && mascot.renderer.rotationBrake) {
                            mascot.renderer.rotationBrake.stop();
                        }
                    }
                });

                rotationSliderFull.addEventListener('pointerup', (e) => {
                    const timeSinceDown = Date.now() - lastPointerTime;

                    // If it was a quick tap on the thumb and not dragging
                    if (isOnThumb(e) && timeSinceDown < 200 && !isDragging) {
                        // Brake to upright
                        rotationSliderFull.value = 0;
                        setRotationSpeed(0);

                        if (mascot && mascot.renderer && mascot.renderer.rotationBrake) {
                            mascot.renderer.rotationBrake.brakeToUpright({
                                onProgress: (progress, virtualSpeed) => {
                                    // Update slider to show virtual speed during braking
                                    const sign = mascot.renderer.state.rotationSpeed > 0 ? 1 : -1;
                                    rotationSliderFull.value = virtualSpeed * sign;
                                },
                                onComplete: () => {
                                    rotationSliderFull.value = 0;
                                    rotationBrakeBtn.classList.remove('braking');
                                }
                            });
                            rotationBrakeBtn.classList.add('braking');
                        }
                    }

                    isDragging = false;
                });

                // Handle input changes
                rotationSliderFull.addEventListener('input', (e) => {
                    const value = parseFloat(rotationSliderFull.value);
                    setRotationSpeed(value);
                });

                // Brake button
                if (rotationBrakeBtn) {
                    rotationBrakeBtn.addEventListener('click', () => {
                        rotationSliderFull.value = 0;
                        setRotationSpeed(0);

                        if (mascot && mascot.renderer && mascot.renderer.rotationBrake) {
                            mascot.renderer.rotationBrake.brakeToUpright({
                                onProgress: (progress, virtualSpeed) => {
                                    // Update slider to show virtual speed during braking
                                    const sign = mascot.renderer.state.rotationSpeed > 0 ? 1 : -1;
                                    rotationSliderFull.value = virtualSpeed * sign;
                                },
                                onComplete: () => {
                                    rotationSliderFull.value = 0;
                                    rotationBrakeBtn.classList.remove('braking');
                                }
                            });
                            rotationBrakeBtn.classList.add('braking');
                        }
                    });
                }
            }

            // DJ Scratch Controls
            const canvas = document.getElementById('emotive-canvas');
            let scratching = false;
            let lastAngle = 0;
            let currentAngle = 0;
            let angularVelocity = 0;
            let momentum = 0;
            let animationFrame = null;
            let hasShownScratchTutorial = false;

            // Helper to get angle from center to mouse position
            function getAngleFromCenter(e, rect) {
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const x = (e.clientX || e.touches[0].clientX) - rect.left - centerX;
                const y = (e.clientY || e.touches[0].clientY) - rect.top - centerY;
                return Math.atan2(y, x);
            }

            // Start scratching
            function startScratch(e) {
                // Get click position and canvas dimensions
                const rect = canvas.getBoundingClientRect();
                const clickX = e.type.startsWith('touch') ?
                    e.touches[0].clientX - rect.left :
                    e.clientX - rect.left;
                const clickY = e.type.startsWith('touch') ?
                    e.touches[0].clientY - rect.top :
                    e.clientY - rect.top;

                // Calculate distance from center of canvas (mascot position)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const distance = Math.sqrt(
                    Math.pow(clickX - centerX, 2) +
                    Math.pow(clickY - centerY, 2)
                );

                // Define rotation zone as a circle around the mascot
                // Very small area - max 1/3 of the animation frame width
                const rotationRadius = rect.width / 6; // Half of 1/3 width = 1/6 width for radius

                // Check if click is outside the rotation circle
                if (distance > rotationRadius) {
                    // Click is outside rotation area, don't start rotation
                    return;
                }

                e.preventDefault();

                // Show tutorial on first interaction
                if (!hasShownScratchTutorial) {
                    showScratchTutorial();
                }

                scratching = true;
                lastAngle = getAngleFromCenter(e, rect);
                currentAngle = lastAngle;
                angularVelocity = 0;

                // Stop any momentum animation
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }

                // Add visual indicator and ensure pointer events stay on
                canvas.style.cursor = 'grabbing';
                canvas.style.pointerEvents = 'auto';
            }

            // Update scratch
            function updateScratch(e) {
                if (!scratching) return;
                e.preventDefault();

                const rect = canvas.getBoundingClientRect();
                currentAngle = getAngleFromCenter(e, rect);

                // Calculate angular change
                let deltaAngle = currentAngle - lastAngle;

                // Handle wrap-around
                if (deltaAngle > Math.PI) {
                    deltaAngle -= Math.PI * 2;
                } else if (deltaAngle < -Math.PI) {
                    deltaAngle += Math.PI * 2;
                }

                // Calculate angular velocity (radians per frame)
                angularVelocity = deltaAngle * 0.8 + angularVelocity * 0.2; // Smooth it

                // Apply direct rotation
                if (mascot) {
                    const currentRotation = mascot.renderer ? mascot.renderer.state.manualRotation : 0;
                    mascot.setRotationAngle(currentRotation + deltaAngle);
                }

                lastAngle = currentAngle;
            }

            // End scratch
            function endScratch() {
                if (!scratching) return;
                scratching = false;

                // Reset cursor based on current mouse position
                const rect = canvas.getBoundingClientRect();
                if (e.type.startsWith('touch')) {
                    canvas.style.cursor = 'default';
                } else {
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const distance = Math.sqrt(
                        Math.pow(mouseX - centerX, 2) +
                        Math.pow(mouseY - centerY, 2)
                    );
                    const rotationRadius = rect.width / 6;
                    canvas.style.cursor = distance <= rotationRadius ? 'grab' : 'default';
                }

                // Transfer angular velocity to momentum
                momentum = angularVelocity * 20; // Scale up for momentum effect

                // Start momentum animation
                animateMomentum();
            }

            // Momentum animation
            function animateMomentum() {
                if (Math.abs(momentum) < 0.001) {
                    momentum = 0;
                    return;
                }

                // Apply friction
                momentum *= 0.95;

                // Apply momentum to rotation
                if (mascot) {
                    mascot.setRotationSpeed(momentum);
                }

                animationFrame = requestAnimationFrame(animateMomentum);
            }

            // Rotation tutorial indicator
            let rotationIndicator = null;

            function showScratchTutorial() {
                if (hasShownScratchTutorial || rotationIndicator) return;
                hasShownScratchTutorial = true;

                rotationIndicator = document.createElement('div');
                rotationIndicator.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: var(--size-full);
                    height: var(--size-full);
                    pointer-events: none;
                    z-index: var(--z-header);
                `;

                // Create tutorial message
                const tutorialText = document.createElement('div');
                tutorialText.style.cssText = `
                    position: absolute;
                    top: 25%;
                    left: 50%;
                    transform: translateX(-50%);
                    color: var(--accent-primary);
                    font-family: var(--font-heading);
                    font-size: var(--text-lg);
                    font-weight: var(--font-bold);
                    text-transform: uppercase;
                    letter-spacing: var(--spacing-letter-widest);
                    text-align: center;
                    padding: var(--spacing-md) var(--spacing-xl);
                    border: var(--border-accent);
                    background: var(--bg-black-80);
                    box-shadow: 0 0 30px var(--accent-glow), inset 0 0 20px rgba(0, 255, 255, 0.1);
                    opacity: 0;
                    animation: tutorial-cta-pulse 0.8s ease-out forwards;
                `;
                tutorialText.innerHTML = '<span style="font-size: var(--text-xl);">DRAG TO SPIN</span>';
                rotationIndicator.appendChild(tutorialText);

                // Create just one arrow at the top
                const arrow = document.createElement('img');
                arrow.className = 'rotation-arrow';
                arrow.src = 'assets/spin-arrows.svg';

                // Position at top of circle
                const angle = -Math.PI / 2; // Top position (-90 degrees)
                const radiusPercent = 48;
                const x = 50 + radiusPercent * Math.cos(angle); // Should be 50 (center x)
                const y = 50 + radiusPercent * Math.sin(angle); // Should be 2 (top)

                arrow.style.cssText = `
                    position: absolute;
                    top: ${y}%;
                    left: ${x}%;
                    transform: translate(-50%, -50%) scale(0);
                    width: 180px;
                    height: 45px;
                    filter: brightness(0) invert(1);
                    opacity: 0;
                    pointer-events: none;
                    animation: arrow-pulse-in 0.6s ease-out forwards;
                `;

                rotationIndicator.appendChild(arrow);

                // Add CSS animations
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes arrow-pulse-in {
                        0% {
                            transform: translate(-50%, -50%) scale(0);
                            opacity: 0;
                        }
                        50% {
                            transform: translate(-50%, -50%) scale(1.5);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) scale(1);
                            opacity: var(--opacity-80);
                        }
                    }
                    @keyframes tutorial-cta-pulse {
                        0% {
                            opacity: 0;
                            transform: translateX(-50%) scale(0.8);
                        }
                        50% {
                            opacity: 1;
                            transform: translateX(-50%) scale(1.05);
                        }
                        75% {
                            transform: translateX(-50%) scale(0.98);
                        }
                        100% {
                            opacity: 1;
                            transform: translateX(-50%) scale(1);
                        }
                    }
                    @keyframes tutorial-fade-out {
                        from {
                            opacity: 1;
                            transform: translateX(-50%) scale(1);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(-50%) scale(0.9);
                        }
                    }
                `;
                document.head.appendChild(style);

                canvas.parentElement.appendChild(rotationIndicator);

                // Start slow rotation animation
                let rotationAngle = 0;
                const rotateInterval = setInterval(() => {
                    rotationAngle += 0.5;
                    rotationIndicator.style.transform = `rotate(${rotationAngle}deg)`;
                }, 16);

                // Start fade out after 1.5 seconds (halfway through rotation)
                setTimeout(() => {
                    // Gradual fade out while still rotating
                    const arrows = rotationIndicator.querySelectorAll('.rotation-arrow');
                    arrows.forEach(arrow => {
                        // First ensure the arrow is visible
                        arrow.style.animation = 'none';
                        arrow.style.opacity = '0.8';  // Set to current visible state
                        arrow.style.transform = 'translate(-50%, -50%) scale(1)';  // Maintain scale

                        // Then apply transition and fade
                        setTimeout(() => {
                            arrow.style.transition = 'opacity 1s ease-out';
                            arrow.style.opacity = '0';
                        }, 50);
                    });

                    tutorialText.style.animation = 'none';
                    tutorialText.style.opacity = '1';
                    setTimeout(() => {
                        tutorialText.style.transition = 'opacity 1s ease-out';
                        tutorialText.style.opacity = '0';
                    }, 50);
                }, 1500);

                // Stop rotation and remove after 3 seconds total
                setTimeout(() => {
                    clearInterval(rotateInterval);

                    // Remove element
                    if (rotationIndicator && rotationIndicator.parentElement) {
                        rotationIndicator.parentElement.removeChild(rotationIndicator);
                        rotationIndicator = null;
                    }
                }, 3000);
            }

            // HUD Tooltip System
            const hudTooltip = document.getElementById('hud-tooltip');
            let tooltipTimeout = null;

            const tooltipTexts = {
                'load-audio-btn': 'Play Demo Song',
                'load-song-btn': 'Load Audio File',
                'blinking-toggle': 'Toggle Blinking',
                'gaze-toggle': 'Toggle Gaze Tracking',
                'fps-toggle': 'Show FPS Counter',
                'record-btn': 'Record Audio',
                'randomize-all-btn': 'Randomize Everything'
            };

            function showTooltip(text, activated = false) {
                clearTimeout(tooltipTimeout);
                hudTooltip.textContent = text;
                hudTooltip.classList.add('visible');

                if (activated) {
                    hudTooltip.classList.add('activated');
                    // Remove activation animation after 300ms
                    setTimeout(() => {
                        hudTooltip.classList.remove('activated');
                    }, 300);
                    // Start fading out after 1.5 seconds
                    tooltipTimeout = setTimeout(() => {
                        hudTooltip.classList.remove('visible');
                    }, 1500);
                }
            }

            function hideTooltip() {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    hudTooltip.classList.remove('visible');
                    hudTooltip.classList.remove('activated');
                }, 100);
            }

            // Add tooltip handlers to system control buttons
            document.querySelectorAll('.system-controls .sci-fi-btn').forEach(btn => {
                const tooltipText = tooltipTexts[btn.id] || btn.getAttribute('aria-label') || '';

                btn.addEventListener('mouseenter', () => {
                    if (tooltipText) {
                        showTooltip(tooltipText);
                    }
                });

                btn.addEventListener('mouseleave', () => {
                    hideTooltip();
                });

                // Show activated animation on click
                btn.addEventListener('click', () => {
                    if (tooltipText) {
                        const isActive = btn.classList.contains('active');
                        const statusText = btn.id === 'blinking-toggle' ?
                            (isActive ? 'Blinking Enabled' : 'Blinking Disabled') :
                            btn.id === 'gaze-toggle' ?
                            (isActive ? 'Gaze Tracking On' : 'Gaze Tracking Off') :
                            btn.id === 'fps-toggle' ?
                            (isActive ? 'FPS Display On' : 'FPS Display Off') :
                            btn.id === 'record-btn' ?
                            (isActive ? 'Recording Started' : 'Recording Stopped') :
                            tooltipText;

                        showTooltip(statusText, true);
                    }
                });
            });

            // Add event listeners
            // Remove default grab cursor - will be set dynamically on hover
            canvas.style.cursor = 'default';

            // Function to check if point is in rotation area
            function isInRotationArea(x, y, rect) {
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const distance = Math.sqrt(
                    Math.pow(x - centerX, 2) +
                    Math.pow(y - centerY, 2)
                );
                const rotationRadius = rect.width / 6;
                return distance <= rotationRadius;
            }

            // Add mousemove to update cursor and pointer-events based on position
            document.addEventListener('mousemove', (e) => {
                if (scratching) return; // Don't change while dragging

                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Check if mouse is over canvas at all
                if (mouseX >= 0 && mouseX <= rect.width && mouseY >= 0 && mouseY <= rect.height) {
                    if (isInRotationArea(mouseX, mouseY, rect)) {
                        // Enable pointer events and show grab cursor in rotation area
                        canvas.style.pointerEvents = 'auto';
                        canvas.style.cursor = 'grab';
                    } else {
                        // Disable pointer events outside rotation area
                        canvas.style.pointerEvents = 'none';
                        canvas.style.cursor = 'default';
                    }
                } else {
                    // Mouse is outside canvas
                    canvas.style.pointerEvents = 'none';
                    canvas.style.cursor = 'default';
                }
            });

            // Mouse events
            canvas.addEventListener('mousedown', startScratch);
            document.addEventListener('mousemove', updateScratch);
            document.addEventListener('mouseup', endScratch);

            // Touch events
            canvas.addEventListener('touchstart', startScratch);
            document.addEventListener('touchmove', updateScratch);
            document.addEventListener('touchend', endScratch);

            // Shape morphing controls
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const shape = btn.dataset.shape;
                    const mode = 'hybrid'; // Default to hybrid mode
                    
                    if (mascot) {
                        // Visual feedback
                        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Get current shape for transition detection
                        const currentShape = mascot.shapeMorpher ? mascot.shapeMorpher.currentShape : null;
                        
                        // Faster transitions between lunar and solar
                        const isLunarSolarTransition = 
                            (currentShape === 'lunar' && shape === 'solar') ||
                            (currentShape === 'solar' && shape === 'lunar');
                        
                        // Morph to new shape
                        mascot.morphTo(shape, {
                            duration: window.rhythmActive ? 'bar' : (isLunarSolarTransition ? 500 : 1000), // Faster for lunar-solar
                            mode: mode,
                            onBeat: window.rhythmActive
                        });
                    }
                });
            });
            
            // Audio controls
            const audioFile = document.getElementById('audio-file');
            const audioPlayer = document.getElementById('audio-player');
            
            // Set up audio player event listeners once
            audioPlayer.addEventListener('play', async () => {
                if (mascot) {
                    // Reset music detection when audio starts playing
                    if (mascot.shapeMorpher) {
                        mascot.shapeMorpher.resetMusicDetection();
                        // Clear the manual stop flag so rhythm can auto-start
                        window.rhythmManuallyStoppedForCurrentAudio = false;
                    }
                    
                    // Resume audio context if suspended
                    if (mascot.audioAnalyzer && mascot.audioAnalyzer.audioContext) {
                        await mascot.audioAnalyzer.resume();
                    }
                    mascot.connectAudio(audioPlayer);
                    window.startAudioViz(); // Start the audio visualization
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
                window.stopAudioViz(); // Stop visualization when paused
            });
            
            audioPlayer.addEventListener('ended', () => {
                if (mascot) {
                    mascot.disconnectAudio();
                }
                window.stopAudioViz(); // Stop the audio visualization
                // Hide audio visualizer when audio ends (only on mobile portrait)
                if (window.innerWidth <= 768 && window.innerHeight > window.innerWidth) {
                    document.getElementById('audio-viz-section').style.display = 'none';
                }
            });
            
            // Play button - plays Electric Glow track
            document.getElementById('load-audio-btn').addEventListener('click', () => {
                audioPlayer.src = 'assets/Electric Glow (Remix).wav';
                document.getElementById('audio-player-container').style.display = 'block';
                document.getElementById('audio-viz-section').style.display = 'block';
                audioPlayer.play();
            });
            
            audioFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    audioPlayer.src = url;
                    document.getElementById('audio-player-container').style.display = 'block';
                    document.getElementById('audio-viz-section').style.display = 'block';
                }
            });
            
            // Music note button - opens file explorer
            document.getElementById('load-song-btn').addEventListener('click', () => {
                audioFile.click();
            });
            
        }

        function updateDisplay() {
            document.getElementById('emotion-display').textContent = `EMOTION: ${currentEmotion.toUpperCase()}`;
            document.getElementById('undertone-display').textContent = currentUndertone.toUpperCase() || 'STABLE';
        }
        
        // Footer is now static, no animations needed
        
        // REMOVED - System controls always visible
        function initSystemControlsAnimation() {
            // Disabled - system controls no longer hide
            return;
            const systemControls = document.querySelector('.system-controls');
            
            // Check if we're on mobile phone portrait (small screens only)
            function isMobileView() {
                const isPortrait = window.innerHeight > window.innerWidth;
                const isSmallScreen = window.innerWidth <= 480; // Only phones
                return isPortrait && isSmallScreen;
            }
            
            // Ensure system controls are visible on desktop/landscape
            function updateSystemControlsVisibility() {
                if (!isMobileView()) {
                    // Always show on desktop/landscape
                    systemControls.classList.remove('hidden', 'retracting', 'extending');
                } else {
                    // Apply scroll behavior on mobile
                    handleScroll();
                }
            }
            
            let isAnimating = false;
            let scrollTimeout;
            let lastKnownScrollPosition = 0;
            
            function handleScroll() {
                // Only apply scroll behavior on mobile
                if (!isMobileView()) {
                    systemControls.classList.remove('hidden', 'retracting', 'extending');
                    return;
                }
                
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Prevent animation conflicts
                if (isAnimating) return;
                
                // Hide when scrolled down past threshold - trigger IMMEDIATELY
                if (scrollTop > 5 && !systemControls.classList.contains('hidden') && !systemControls.classList.contains('retracting')) {
                    isAnimating = true;
                    systemControls.classList.remove('extending');
                    systemControls.classList.add('retracting');
                    
                    setTimeout(() => {
                        systemControls.classList.add('hidden');
                        systemControls.classList.remove('retracting');
                        isAnimating = false;
                    }, 300); // Match the faster animation
                    
                    // Play pneumatic retraction sound if sound is enabled
                    if (mascot && mascot.soundSystem && mascot.soundSystem.isEnabled) {
                        // Smooth hiss then mechanical clunk
                        mascot.soundSystem.playTone(180, 0.03, 150); // Smooth pneumatic hiss
                        setTimeout(() => mascot.soundSystem.playTone(120, 0.08, 30), 550); // Deep thunk at end
                    }
                } 
                // Only show when scrolled all the way back to top
                else if (scrollTop <= 10 && systemControls.classList.contains('hidden') && !systemControls.classList.contains('extending')) {
                    isAnimating = true;
                    systemControls.classList.remove('hidden');
                    systemControls.classList.remove('retracting');
                    systemControls.classList.add('extending');
                    
                    setTimeout(() => {
                        systemControls.classList.remove('extending');
                        isAnimating = false;
                    }, 600);
                    
                    // Play pneumatic extension sound if sound is enabled
                    if (mascot && mascot.soundSystem && mascot.soundSystem.isEnabled) {
                        // Smooth release then mechanical lock
                        mascot.soundSystem.playTone(150, 0.03, 200); // Smooth air release
                        setTimeout(() => mascot.soundSystem.playTone(100, 0.08, 30), 540); // Deep thunk lock
                    }
                }
                
                lastKnownScrollPosition = scrollTop;
            }
            
            // Throttled scroll handler for better performance
            let scrollTicking = false;
            window.addEventListener('scroll', () => {
                if (!scrollTicking) {
                    scrollTicking = true;
                    requestAnimationFrame(() => {
                        handleScroll();
                        scrollTicking = false;
                    });
                }
            }, { passive: true });
            
            // Handle window resize to update visibility (debounced)
            let resizeVisibilityTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeVisibilityTimeout);
                resizeVisibilityTimeout = setTimeout(updateSystemControlsVisibility, 150);
            }, { passive: true });
            
            // Initialize on load
            updateSystemControlsVisibility();
        }
        
        let lastFPSValue = -1;
        function updateFPS() {
            if (!showingFPS || !mascot) return;
            
            const metrics = mascot.getPerformanceMetrics();
            const fps = Math.round(metrics.fps || 0);
            
            // Only update DOM if value changed
            if (fps !== lastFPSValue) {
                document.getElementById('fps-value').textContent = fps;
                lastFPSValue = fps;
            }
            
            // Continue updating while showing FPS
            requestAnimationFrame(updateFPS);
        }

        init().catch(console.error);
    </script>
</body>
</html>