<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotive Engine - Performance Monitor</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .performance-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .canvas-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        canvas {
            border: 2px solid #444;
            border-radius: 8px;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }
        
        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #333 0%, #2a2a2a 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        
        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #ccc;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-good { color: #4CAF50; }
        .metric-warning { color: #FF9800; }
        .metric-critical { color: #f44336; }
        
        .chart-container {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            height: 200px;
            position: relative;
        }
        
        .chart {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
            border-radius: 4px;
        }
        
        .controls-panel {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .control-row:last-child {
            margin-bottom: 0;
        }
        
        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .stress-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .stress-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .danger-btn:hover {
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
        }
        
        .memory-monitor {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .memory-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .memory-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #FF9800 70%, #f44336 90%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .device-info {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .device-info h4 {
            margin: 0 0 10px 0;
            color: #4ECDC4;
            font-family: inherit;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        
        .log-panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.performance { color: #4ECDC4; }
        .log-entry.warning { color: #FF9800; }
        .log-entry.critical { color: #f44336; }
        
        .log-entry .timestamp {
            color: #666;
            margin-right: 10px;
        }
        
        .status-bar {
            background: #333;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-indicator.running {
            background: #4CAF50;
            color: white;
        }
        
        .status-indicator.degraded {
            background: #FF9800;
            color: white;
        }
        
        .status-indicator.critical {
            background: #f44336;
            color: white;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 768px) {
            .performance-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Performance Monitor & Stress Testing</h1>
            <p>Real-time performance analysis and optimization testing</p>
        </div>
        
        <div class="status-bar">
            <div>
                <span class="status-indicator running" id="system-status">
                    <span class="status-dot"></span>
                    System Ready
                </span>
            </div>
            <div>
                <button id="start-monitoring">Start Monitoring</button>
                <button id="stop-monitoring" disabled>Stop Monitoring</button>
            </div>
        </div>
        
        <div class="performance-grid">
            <div class="performance-section">
                <h3 style="margin-top: 0; color: #4ECDC4;">Live Performance Metrics</h3>
                
                <div class="canvas-container">
                    <canvas id="performance-canvas" width="400" height="300"></canvas>
                </div>
                
                <div class="metrics-dashboard">
                    <div class="metric-card">
                        <div class="metric-value metric-good" id="fps-metric">0</div>
                        <div class="metric-label">FPS</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value metric-good" id="frame-time-metric">0</div>
                        <div class="metric-label">Frame Time (ms)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value metric-good" id="particles-metric">0</div>
                        <div class="metric-label">Particles</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value metric-good" id="memory-metric">0</div>
                        <div class="metric-label">Memory (MB)</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4 style="margin: 0 0 10px 0; color: #ccc;">FPS History</h4>
                    <canvas class="chart-canvas" id="fps-chart" width="400" height="150"></canvas>
                </div>
                
                <div class="memory-monitor">
                    <h4 style="margin: 0 0 10px 0; color: #ccc;">Memory Usage</h4>
                    <div class="memory-bar">
                        <div class="memory-fill" id="memory-fill" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                        <span>0 MB</span>
                        <span id="memory-text">0 MB / 50 MB</span>
                        <span>50 MB</span>
                    </div>
                </div>
            </div>
            
            <div class="performance-section">
                <h3 style="margin-top: 0; color: #FF9800;">Stress Testing Controls</h3>
                
                <div class="controls-panel">
                    <div class="control-row">
                        <label style="min-width: 120px;">Particle Count:</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="particle-slider" min="10" max="200" value="50">
                            <span id="particle-value">50</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label style="min-width: 120px;">Target FPS:</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="fps-slider" min="15" max="120" value="60">
                            <span id="fps-value">60</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label style="min-width: 120px;">Emotion Speed:</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="emotion-speed-slider" min="100" max="5000" value="2000">
                            <span id="emotion-speed-value">2000ms</span>
                        </div>
                    </div>
                </div>
                
                <div class="controls-panel">
                    <h4 style="margin: 0 0 15px 0; color: #ccc;">Stress Tests</h4>
                    <div class="control-row">
                        <button class="stress-btn" id="rapid-emotions">Rapid Emotions</button>
                        <button class="stress-btn" id="gesture-spam">Gesture Spam</button>
                        <button class="stress-btn" id="particle-burst">Particle Burst</button>
                        <button class="danger-btn" id="memory-stress">Memory Stress</button>
                    </div>
                    <div class="control-row">
                        <button id="auto-degradation">Test Auto Degradation</button>
                        <button id="recovery-test">Test Recovery</button>
                        <button class="danger-btn" id="crash-test">Crash Test</button>
                    </div>
                </div>
                
                <div class="device-info">
                    <h4>Device Information</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span>User Agent:</span>
                            <span id="user-agent">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Screen Resolution:</span>
                            <span id="screen-resolution">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Device Pixel Ratio:</span>
                            <span id="device-pixel-ratio">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Hardware Concurrency:</span>
                            <span id="hardware-concurrency">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Memory (approx):</span>
                            <span id="device-memory">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>Connection:</span>
                            <span id="connection-type">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="log-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #4ECDC4;">Performance Log</strong>
                        <button id="clear-log" style="padding: 2px 8px; font-size: 11px;">Clear</button>
                    </div>
                    <div id="performance-log"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import EmotiveMascot from '../src/EmotiveMascot.js';

        // Initialize mascot
        const canvas = document.getElementById('performance-canvas');
        const mascot = new EmotiveMascot({ 
            canvasId: canvas,
            enableAudio: false, // Disable audio for performance testing
            targetFPS: 60,
            maxParticles: 50
        });

        // Performance monitoring state
        let isMonitoring = false;
        let performanceData = {
            fps: [],
            frameTime: [],
            particles: [],
            memory: []
        };
        let maxDataPoints = 100;
        let stressTests = new Map();

        // UI elements
        const systemStatus = document.getElementById('system-status');
        const startBtn = document.getElementById('start-monitoring');
        const stopBtn = document.getElementById('stop-monitoring');
        const performanceLog = document.getElementById('performance-log');
        const fpsChart = document.getElementById('fps-chart');
        const fpsChartCtx = fpsChart.getContext('2d');

        // Initialize device info
        function initializeDeviceInfo() {
            document.getElementById('user-agent').textContent = navigator.userAgent.split(' ').slice(-2).join(' ');
            document.getElementById('screen-resolution').textContent = `${screen.width}Ã—${screen.height}`;
            document.getElementById('device-pixel-ratio').textContent = window.devicePixelRatio || 1;
            document.getElementById('hardware-concurrency').textContent = navigator.hardwareConcurrency || 'Unknown';
            document.getElementById('device-memory').textContent = navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'Unknown';
            
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            document.getElementById('connection-type').textContent = connection ? 
                `${connection.effectiveType || 'Unknown'} (${connection.downlink || '?'} Mbps)` : 'Unknown';
        }

        // Performance logging
        function logPerformance(message, type = 'performance') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            
            performanceLog.insertBefore(logEntry, performanceLog.firstChild);
            
            // Keep only last 100 entries
            while (performanceLog.children.length > 100) {
                performanceLog.removeChild(performanceLog.lastChild);
            }
        }

        // Update performance metrics
        function updateMetrics() {
            if (!isMonitoring) return;

            const metrics = mascot.getPerformanceMetrics();
            const fps = metrics.fps || 0;
            const frameTime = fps > 0 ? (1000 / fps) : 0;
            const particles = metrics.particleCount || 0;
            const memory = estimateMemoryUsage();

            // Update metric displays
            updateMetricDisplay('fps-metric', fps, [60, 30, 15]);
            updateMetricDisplay('frame-time-metric', frameTime.toFixed(1), [16.7, 33.3, 66.7], true);
            updateMetricDisplay('particles-metric', particles, [100, 150, 200]);
            updateMetricDisplay('memory-metric', memory.toFixed(1), [10, 25, 50]);

            // Store data for charts
            performanceData.fps.push(fps);
            performanceData.frameTime.push(frameTime);
            performanceData.particles.push(particles);
            performanceData.memory.push(memory);

            // Limit data points
            Object.keys(performanceData).forEach(key => {
                if (performanceData[key].length > maxDataPoints) {
                    performanceData[key].shift();
                }
            });

            // Update charts
            updateFpsChart();
            updateMemoryBar(memory);

            // Check for performance issues
            checkPerformanceThresholds(fps, frameTime, memory);
        }

        function updateMetricDisplay(elementId, value, thresholds, reverse = false) {
            const element = document.getElementById(elementId);
            element.textContent = value;
            
            // Remove existing classes
            element.classList.remove('metric-good', 'metric-warning', 'metric-critical');
            
            // Add appropriate class based on thresholds
            const numValue = parseFloat(value);
            if (reverse) {
                // For metrics where lower is better (like frame time)
                if (numValue <= thresholds[0]) {
                    element.classList.add('metric-good');
                } else if (numValue <= thresholds[1]) {
                    element.classList.add('metric-warning');
                } else {
                    element.classList.add('metric-critical');
                }
            } else {
                // For metrics where higher is better (like FPS)
                if (numValue >= thresholds[0]) {
                    element.classList.add('metric-good');
                } else if (numValue >= thresholds[1]) {
                    element.classList.add('metric-warning');
                } else {
                    element.classList.add('metric-critical');
                }
            }
        }

        function updateFpsChart() {
            const ctx = fpsChartCtx;
            const width = fpsChart.width;
            const height = fpsChart.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (performanceData.fps.length < 2) return;
            
            // Draw grid
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            
            // Horizontal lines (FPS levels)
            const fpsLevels = [15, 30, 45, 60, 90, 120];
            fpsLevels.forEach(fps => {
                const y = height - (fps / 120) * height;
                if (y >= 0 && y <= height) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                    
                    // Label
                    ctx.fillStyle = '#666';
                    ctx.font = '10px monospace';
                    ctx.fillText(`${fps}`, 5, y - 2);
                }
            });
            
            // Draw FPS line
            ctx.strokeStyle = '#4ECDC4';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const data = performanceData.fps;
            const stepX = width / (maxDataPoints - 1);
            
            data.forEach((fps, index) => {
                const x = index * stepX;
                const y = height - Math.min(fps / 120, 1) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw target FPS line
            const targetFPS = parseInt(document.getElementById('fps-slider').value);
            const targetY = height - (targetFPS / 120) * height;
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, targetY);
            ctx.lineTo(width, targetY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function updateMemoryBar(memory) {
            const memoryFill = document.getElementById('memory-fill');
            const memoryText = document.getElementById('memory-text');
            
            const percentage = Math.min((memory / 50) * 100, 100);
            memoryFill.style.width = `${percentage}%`;
            memoryText.textContent = `${memory.toFixed(1)} MB / 50 MB`;
        }

        function estimateMemoryUsage() {
            // Rough estimation based on particle count and other factors
            const metrics = mascot.getPerformanceMetrics();
            const particles = metrics.particleCount || 0;
            const baseMemory = 2; // Base memory usage in MB
            const particleMemory = particles * 0.001; // Rough estimate per particle
            const canvasMemory = (canvas.width * canvas.height * 4) / (1024 * 1024); // Canvas memory
            
            return baseMemory + particleMemory + canvasMemory;
        }

        function checkPerformanceThresholds(fps, frameTime, memory) {
            const targetFPS = parseInt(document.getElementById('fps-slider').value);
            
            // Update system status
            if (fps < targetFPS * 0.5) {
                systemStatus.className = 'status-indicator critical';
                systemStatus.innerHTML = '<span class="status-dot"></span>Critical Performance';
                
                if (!stressTests.has('critical-logged')) {
                    logPerformance(`Critical performance: ${fps} FPS (target: ${targetFPS})`, 'critical');
                    stressTests.set('critical-logged', true);
                }
            } else if (fps < targetFPS * 0.8) {
                systemStatus.className = 'status-indicator degraded';
                systemStatus.innerHTML = '<span class="status-dot"></span>Performance Degraded';
                
                if (!stressTests.has('degraded-logged')) {
                    logPerformance(`Performance degraded: ${fps} FPS (target: ${targetFPS})`, 'warning');
                    stressTests.set('degraded-logged', true);
                }
            } else {
                systemStatus.className = 'status-indicator running';
                systemStatus.innerHTML = '<span class="status-dot"></span>Optimal Performance';
                stressTests.delete('critical-logged');
                stressTests.delete('degraded-logged');
            }
            
            // Memory warnings
            if (memory > 40) {
                logPerformance(`High memory usage: ${memory.toFixed(1)} MB`, 'warning');
            }
        }

        // Stress test functions
        function rapidEmotionTest() {
            if (stressTests.has('rapid-emotions')) {
                clearInterval(stressTests.get('rapid-emotions'));
                stressTests.delete('rapid-emotions');
                document.getElementById('rapid-emotions').textContent = 'Rapid Emotions';
                logPerformance('Rapid emotion test stopped');
                return;
            }
            
            const emotions = ['neutral', 'joy', 'sadness', 'anger', 'fear', 'surprise', 'disgust', 'love'];
            let currentIndex = 0;
            
            const interval = setInterval(() => {
                mascot.setEmotion(emotions[currentIndex]);
                currentIndex = (currentIndex + 1) % emotions.length;
            }, 200);
            
            stressTests.set('rapid-emotions', interval);
            document.getElementById('rapid-emotions').textContent = 'Stop Rapid Emotions';
            logPerformance('Rapid emotion test started (200ms intervals)');
            
            // Auto-stop after 30 seconds
            setTimeout(() => {
                if (stressTests.has('rapid-emotions')) {
                    clearInterval(stressTests.get('rapid-emotions'));
                    stressTests.delete('rapid-emotions');
                    document.getElementById('rapid-emotions').textContent = 'Rapid Emotions';
                    logPerformance('Rapid emotion test auto-stopped');
                }
            }, 30000);
        }

        function gestureSpamTest() {
            if (stressTests.has('gesture-spam')) {
                clearInterval(stressTests.get('gesture-spam'));
                stressTests.delete('gesture-spam');
                document.getElementById('gesture-spam').textContent = 'Gesture Spam';
                logPerformance('Gesture spam test stopped');
                return;
            }
            
            const gestures = ['bounce', 'pulse', 'shake', 'spin', 'nod', 'tilt', 'expand', 'contract', 'flash', 'drift'];
            
            const interval = setInterval(() => {
                const gesture = gestures[Math.floor(Math.random() * gestures.length)];
                mascot.express(gesture);
            }, 100);
            
            stressTests.set('gesture-spam', interval);
            document.getElementById('gesture-spam').textContent = 'Stop Gesture Spam';
            logPerformance('Gesture spam test started (100ms intervals)');
            
            // Auto-stop after 20 seconds
            setTimeout(() => {
                if (stressTests.has('gesture-spam')) {
                    clearInterval(stressTests.get('gesture-spam'));
                    stressTests.delete('gesture-spam');
                    document.getElementById('gesture-spam').textContent = 'Gesture Spam';
                    logPerformance('Gesture spam test auto-stopped');
                }
            }, 20000);
        }

        function particleBurstTest() {
            logPerformance('Particle burst test started');
            
            // Temporarily increase particle limit
            const originalMax = mascot.particleSystem.maxParticles;
            mascot.particleSystem.setMaxParticles(300);
            
            // Trigger multiple gestures that create particles
            const burstGestures = ['spin', 'expand', 'pulse', 'flash'];
            burstGestures.forEach((gesture, index) => {
                setTimeout(() => {
                    mascot.express(gesture);
                }, index * 100);
            });
            
            // Restore original limit after 5 seconds
            setTimeout(() => {
                mascot.particleSystem.setMaxParticles(originalMax);
                logPerformance(`Particle burst test completed, restored max particles to ${originalMax}`);
            }, 5000);
        }

        function memoryStressTest() {
            logPerformance('Memory stress test started - creating memory pressure');
            
            // Create arrays to consume memory
            const memoryArrays = [];
            const arraySize = 100000;
            
            for (let i = 0; i < 50; i++) {
                memoryArrays.push(new Array(arraySize).fill(Math.random()));
            }
            
            // Force garbage collection after 10 seconds
            setTimeout(() => {
                memoryArrays.length = 0;
                if (window.gc) {
                    window.gc();
                }
                logPerformance('Memory stress test completed, arrays cleared');
            }, 10000);
        }

        function autoDegradationTest() {
            logPerformance('Auto-degradation test started - forcing low FPS');
            
            // Create artificial load to trigger degradation
            const heavyLoop = () => {
                const start = performance.now();
                while (performance.now() - start < 50) {
                    // Busy wait to consume CPU
                    Math.random();
                }
            };
            
            const interval = setInterval(heavyLoop, 16);
            
            // Stop after 15 seconds
            setTimeout(() => {
                clearInterval(interval);
                logPerformance('Auto-degradation test completed');
            }, 15000);
        }

        function recoveryTest() {
            logPerformance('Recovery test started - testing performance recovery');
            
            // First degrade performance
            const originalMax = mascot.particleSystem.maxParticles;
            mascot.particleSystem.setMaxParticles(10);
            
            // Then restore after 5 seconds
            setTimeout(() => {
                mascot.particleSystem.setMaxParticles(originalMax);
                logPerformance('Recovery test: particle limit restored');
            }, 5000);
        }

        function crashTest() {
            logPerformance('Crash test started - testing error handling', 'warning');
            
            try {
                // Test invalid operations
                mascot.setEmotion('invalid-emotion');
                mascot.express('invalid-gesture');
                mascot.chain('invalid1', 'invalid2', 'invalid3');
                
                // Test null operations
                mascot.setEmotion(null);
                mascot.express(null);
                
                logPerformance('Crash test completed - error handling working correctly');
            } catch (error) {
                logPerformance(`Crash test failed: ${error.message}`, 'critical');
            }
        }

        // Control handlers
        startBtn.addEventListener('click', () => {
            mascot.start();
            isMonitoring = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            logPerformance('Performance monitoring started');
        });

        stopBtn.addEventListener('click', () => {
            mascot.stop();
            isMonitoring = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // Stop all stress tests
            stressTests.forEach((interval, key) => {
                if (typeof interval === 'number') {
                    clearInterval(interval);
                }
            });
            stressTests.clear();
            
            logPerformance('Performance monitoring stopped');
        });

        // Slider handlers
        document.getElementById('particle-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('particle-value').textContent = value;
            mascot.particleSystem.setMaxParticles(parseInt(value));
            logPerformance(`Particle limit set to ${value}`);
        });

        document.getElementById('fps-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('fps-value').textContent = value;
            mascot.config.targetFPS = parseInt(value);
            logPerformance(`Target FPS set to ${value}`);
        });

        document.getElementById('emotion-speed-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('emotion-speed-value').textContent = `${value}ms`;
        });

        // Stress test handlers
        document.getElementById('rapid-emotions').addEventListener('click', rapidEmotionTest);
        document.getElementById('gesture-spam').addEventListener('click', gestureSpamTest);
        document.getElementById('particle-burst').addEventListener('click', particleBurstTest);
        document.getElementById('memory-stress').addEventListener('click', memoryStressTest);
        document.getElementById('auto-degradation').addEventListener('click', autoDegradationTest);
        document.getElementById('recovery-test').addEventListener('click', recoveryTest);
        document.getElementById('crash-test').addEventListener('click', crashTest);

        // Clear log handler
        document.getElementById('clear-log').addEventListener('click', () => {
            performanceLog.innerHTML = '';
            logPerformance('Performance log cleared');
        });

        // Performance monitoring loop
        setInterval(updateMetrics, 100);

        // Initialize
        initializeDeviceInfo();
        logPerformance('Performance monitor initialized');
        
        console.log('Performance demo loaded successfully');
    </script>
</body>
</html>