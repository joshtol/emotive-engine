<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotive Communication Engine - Interactive Demo</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #FFD700, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            margin: 10px 0;
            color: #ccc;
            font-size: 1.1em;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .canvas-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .controls-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 600px;
            overflow-y: auto;
        }
        
        canvas {
            border: 2px solid #444;
            border-radius: 8px;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            display: block;
            margin: 0 auto;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }
        
        .control-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        
        .control-group:last-child {
            border-bottom: none;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            color: #FFD700;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group h3::before {
            content: "●";
            color: #4ECDC4;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .button-grid.emotions {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .button-grid.gestures {
            grid-template-columns: repeat(2, 1fr);
        }
        
        button {
            padding: 10px 12px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .emotion-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .emotion-btn:hover {
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .emotion-btn.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
            color: #000;
        }
        
        .gesture-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .gesture-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        
        .undertone-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .undertone-btn:hover {
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        
        .undertone-btn.active {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
        }
        
        .chain-builder {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .chain-display {
            min-height: 40px;
            background: #222;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px dashed #555;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .chain-gesture {
            background: #FF9800;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chain-gesture .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .chain-arrow {
            color: #666;
            font-size: 12px;
        }
        
        .compatibility-score {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            text-align: center;
        }
        
        .compatibility-score.good {
            background: #4CAF50;
            color: white;
        }
        
        .compatibility-score.warning {
            background: #FF9800;
            color: white;
        }
        
        .compatibility-score.poor {
            background: #f44336;
            color: white;
        }
        
        .audio-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .volume-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
            border: none;
        }
        
        .metrics-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .metric-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #ccc;
            font-size: 0.9em;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-indicator.running {
            background: #4CAF50;
            color: white;
        }
        
        .status-indicator.stopped {
            background: #f44336;
            color: white;
        }
        
        .status-indicator.speaking {
            background: #FF9800;
            color: white;
        }
        
        .log-section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #4ECDC4;
        }
        
        .log-entry.warning {
            color: #FF9800;
        }
        
        .log-entry.error {
            color: #f44336;
        }
        
        .log-entry .timestamp {
            color: #666;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
            
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Emotive Communication Engine</h1>
            <p>Interactive Demo - Experience AI Emotional Expression</p>
        </div>
        
        <div class="demo-grid">
            <div class="canvas-section">
                <canvas id="emotive-canvas" width="500" height="500"></canvas>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <h3>System Control</h3>
                    <div class="button-grid">
                        <button id="start-btn">Start</button>
                        <button id="stop-btn" disabled>Stop</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Emotional States</h3>
                    <div class="button-grid emotions">
                        <button class="emotion-btn active" data-emotion="neutral">Neutral</button>
                        <button class="emotion-btn" data-emotion="joy">Joy</button>
                        <button class="emotion-btn" data-emotion="sadness">Sadness</button>
                        <button class="emotion-btn" data-emotion="anger">Anger</button>
                        <button class="emotion-btn" data-emotion="fear">Fear</button>
                        <button class="emotion-btn" data-emotion="surprise">Surprise</button>
                        <button class="emotion-btn" data-emotion="disgust">Disgust</button>
                        <button class="emotion-btn" data-emotion="love">Love</button>
                    </div>
                    
                    <h4 style="margin: 15px 0 10px 0; color: #ccc; font-size: 1em;">Undertones</h4>
                    <div class="button-grid">
                        <button class="undertone-btn" data-undertone="nervous">Nervous</button>
                        <button class="undertone-btn" data-undertone="confident">Confident</button>
                        <button class="undertone-btn" data-undertone="tired">Tired</button>
                        <button class="undertone-btn" data-undertone="intense">Intense</button>
                        <button class="undertone-btn" data-undertone="subdued">Subdued</button>
                        <button class="undertone-btn" id="clear-undertone">Clear</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Gestures</h3>
                    <div class="button-grid gestures">
                        <button class="gesture-btn" data-gesture="bounce">Bounce</button>
                        <button class="gesture-btn" data-gesture="pulse">Pulse</button>
                        <button class="gesture-btn" data-gesture="shake">Shake</button>
                        <button class="gesture-btn" data-gesture="spin">Spin</button>
                        <button class="gesture-btn" data-gesture="nod">Nod</button>
                        <button class="gesture-btn" data-gesture="tilt">Tilt</button>
                        <button class="gesture-btn" data-gesture="expand">Expand</button>
                        <button class="gesture-btn" data-gesture="contract">Contract</button>
                        <button class="gesture-btn" data-gesture="flash">Flash</button>
                        <button class="gesture-btn" data-gesture="drift">Drift</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Gesture Chain Builder</h3>
                    <div class="chain-builder">
                        <div class="chain-display" id="chain-display">
                            <span style="color: #666; font-style: italic;">Click gestures above to build a chain...</span>
                        </div>
                        <div class="button-grid">
                            <button id="execute-chain">Execute Chain</button>
                            <button id="clear-chain">Clear Chain</button>
                        </div>
                        <div id="compatibility-feedback"></div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Audio Controls</h3>
                    <div class="audio-controls">
                        <label for="volume-slider" style="color: #ccc;">Master Volume:</label>
                        <span id="volume-display">50%</span>
                    </div>
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="50">
                    
                    <div class="button-grid" style="margin-top: 15px;">
                        <button id="speech-btn">Start Speech</button>
                        <button id="stop-speech-btn" disabled>Stop Speech</button>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button id="simulate-speech">Simulate Speech</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="metrics-section">
            <h3 style="margin-top: 0; color: #FFD700;">Performance Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="fps-value">0</div>
                    <div class="metric-label">FPS</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="particles-value">0</div>
                    <div class="metric-label">Particles</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errors-value">0</div>
                    <div class="metric-label">Errors</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="audio-level-value">0%</div>
                    <div class="metric-label">Audio Level</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div>
                    <strong>Status:</strong> 
                    <span class="status-indicator stopped" id="status-indicator">Stopped</span>
                </div>
                <div>
                    <strong>Current Emotion:</strong> 
                    <span id="current-emotion" style="color: #4ECDC4;">neutral</span>
                </div>
                <div>
                    <strong>Active Gesture:</strong> 
                    <span id="active-gesture" style="color: #FF9800;">none</span>
                </div>
            </div>
            
            <div class="log-section">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #FFD700;">Event Log</strong>
                    <button id="clear-log" style="padding: 2px 8px; font-size: 11px;">Clear</button>
                </div>
                <div id="event-log"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import EmotiveMascot from '../src/EmotiveMascot.js';

        // Initialize mascot
        const canvas = document.getElementById('emotive-canvas');
        const mascot = new EmotiveMascot({ 
            canvasId: canvas,
            enableAudio: true,
            masterVolume: 0.5,
            targetFPS: 60
        });

        // State management
        let currentEmotion = 'neutral';
        let currentUndertone = null;
        let gestureChain = [];
        let speechSimulation = null;

        // UI elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const currentEmotionEl = document.getElementById('current-emotion');
        const activeGestureEl = document.getElementById('active-gesture');
        const eventLog = document.getElementById('event-log');
        const chainDisplay = document.getElementById('chain-display');
        const compatibilityFeedback = document.getElementById('compatibility-feedback');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');

        // Gesture chain management
        function updateChainDisplay() {
            if (gestureChain.length === 0) {
                chainDisplay.innerHTML = '<span style="color: #666; font-style: italic;">Click gestures above to build a chain...</span>';
                compatibilityFeedback.innerHTML = '';
                return;
            }

            const chainHtml = gestureChain.map((gesture, index) => {
                return `
                    <div class="chain-gesture">
                        ${gesture}
                        <span class="remove" onclick="removeFromChain(${index})">×</span>
                    </div>
                    ${index < gestureChain.length - 1 ? '<span class="chain-arrow">→</span>' : ''}
                `;
            }).join('');

            chainDisplay.innerHTML = chainHtml;

            // Show compatibility feedback
            if (gestureChain.length > 1) {
                const compatibility = calculateChainCompatibility(gestureChain);
                let scoreClass = 'good';
                let scoreText = 'Excellent';
                
                if (compatibility < 0.7) {
                    scoreClass = 'warning';
                    scoreText = 'Fair';
                }
                if (compatibility < 0.3) {
                    scoreClass = 'poor';
                    scoreText = 'Poor';
                }

                compatibilityFeedback.innerHTML = `
                    <div class="compatibility-score ${scoreClass}">
                        Compatibility: ${scoreText} (${(compatibility * 100).toFixed(0)}%)
                    </div>
                `;
            } else {
                compatibilityFeedback.innerHTML = '';
            }
        }

        // Simple compatibility calculation (would use actual gesture system in real implementation)
        function calculateChainCompatibility(chain) {
            if (chain.length < 2) return 1.0;
            
            const compatibilityMatrix = {
                'bounce': { 'pulse': 0.8, 'shake': 0.3, 'spin': 0.6, 'nod': 0.9, 'tilt': 0.7, 'expand': 0.5, 'contract': 0.4, 'flash': 0.7, 'drift': 0.6 },
                'pulse': { 'bounce': 0.8, 'shake': 0.4, 'spin': 0.7, 'nod': 0.6, 'tilt': 0.5, 'expand': 0.9, 'contract': 0.3, 'flash': 0.8, 'drift': 0.5 },
                'shake': { 'bounce': 0.3, 'pulse': 0.4, 'spin': 0.2, 'nod': 0.2, 'tilt': 0.6, 'expand': 0.3, 'contract': 0.4, 'flash': 0.5, 'drift': 0.3 },
                'spin': { 'bounce': 0.6, 'pulse': 0.7, 'shake': 0.2, 'nod': 0.4, 'tilt': 0.8, 'expand': 0.6, 'contract': 0.5, 'flash': 0.7, 'drift': 0.9 },
                'nod': { 'bounce': 0.9, 'pulse': 0.6, 'shake': 0.2, 'spin': 0.4, 'tilt': 0.7, 'expand': 0.5, 'contract': 0.6, 'flash': 0.4, 'drift': 0.5 },
                'tilt': { 'bounce': 0.7, 'pulse': 0.5, 'shake': 0.6, 'spin': 0.8, 'nod': 0.7, 'expand': 0.4, 'contract': 0.5, 'flash': 0.6, 'drift': 0.7 },
                'expand': { 'bounce': 0.5, 'pulse': 0.9, 'shake': 0.3, 'spin': 0.6, 'nod': 0.5, 'tilt': 0.4, 'contract': 0.95, 'flash': 0.8, 'drift': 0.4 },
                'contract': { 'bounce': 0.4, 'pulse': 0.3, 'shake': 0.4, 'spin': 0.5, 'nod': 0.6, 'tilt': 0.5, 'expand': 0.95, 'flash': 0.6, 'drift': 0.5 },
                'flash': { 'bounce': 0.7, 'pulse': 0.8, 'shake': 0.5, 'spin': 0.7, 'nod': 0.4, 'tilt': 0.6, 'expand': 0.8, 'contract': 0.6, 'drift': 0.5 },
                'drift': { 'bounce': 0.6, 'pulse': 0.5, 'shake': 0.3, 'spin': 0.9, 'nod': 0.5, 'tilt': 0.7, 'expand': 0.4, 'contract': 0.5, 'flash': 0.5 }
            };

            let totalCompatibility = 0;
            let pairCount = 0;

            for (let i = 0; i < chain.length - 1; i++) {
                const current = chain[i];
                const next = chain[i + 1];
                
                if (compatibilityMatrix[current] && compatibilityMatrix[current][next] !== undefined) {
                    totalCompatibility += compatibilityMatrix[current][next];
                    pairCount++;
                }
            }

            return pairCount > 0 ? totalCompatibility / pairCount : 1.0;
        }

        // Make removeFromChain globally available
        window.removeFromChain = function(index) {
            gestureChain.splice(index, 1);
            updateChainDisplay();
        };

        // Event logging
        function logEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            
            eventLog.insertBefore(logEntry, eventLog.firstChild);
            
            // Keep only last 50 entries
            while (eventLog.children.length > 50) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }

        // System control handlers
        startBtn.addEventListener('click', () => {
            mascot.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusIndicator.textContent = 'Running';
            statusIndicator.className = 'status-indicator running';
            logEvent('Emotive mascot started');
        });

        stopBtn.addEventListener('click', () => {
            mascot.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusIndicator.textContent = 'Stopped';
            statusIndicator.className = 'status-indicator stopped';
            logEvent('Emotive mascot stopped');
        });

        // Emotion control handlers
        document.querySelectorAll('.emotion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const emotion = btn.dataset.emotion;
                currentEmotion = emotion;
                
                mascot.setEmotion(emotion, currentUndertone);
                currentEmotionEl.textContent = emotion + (currentUndertone ? ` (${currentUndertone})` : '');
                
                logEvent(`Emotion changed to: ${emotion}${currentUndertone ? ` with ${currentUndertone} undertone` : ''}`);
            });
        });

        // Undertone control handlers
        document.querySelectorAll('.undertone-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.id === 'clear-undertone') {
                    // Clear undertone
                    document.querySelectorAll('.undertone-btn').forEach(b => b.classList.remove('active'));
                    currentUndertone = null;
                    mascot.setEmotion(currentEmotion, null);
                    currentEmotionEl.textContent = currentEmotion;
                    logEvent('Undertone cleared');
                } else {
                    // Set undertone
                    document.querySelectorAll('.undertone-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const undertone = btn.dataset.undertone;
                    currentUndertone = undertone;
                    
                    mascot.setEmotion(currentEmotion, undertone);
                    currentEmotionEl.textContent = `${currentEmotion} (${undertone})`;
                    
                    logEvent(`Undertone set to: ${undertone}`);
                }
            });
        });

        // Gesture control handlers
        document.querySelectorAll('.gesture-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const gesture = btn.dataset.gesture;
                
                // Add to chain if shift is held, otherwise execute immediately
                if (event.shiftKey) {
                    if (gestureChain.length < 3) {
                        gestureChain.push(gesture);
                        updateChainDisplay();
                        logEvent(`Added ${gesture} to gesture chain`);
                    } else {
                        logEvent('Gesture chain is full (max 3 gestures)', 'warning');
                    }
                } else {
                    mascot.express(gesture);
                    logEvent(`Executed gesture: ${gesture}`);
                }
            });
        });

        // Chain control handlers
        document.getElementById('execute-chain').addEventListener('click', () => {
            if (gestureChain.length === 0) {
                logEvent('No gestures in chain to execute', 'warning');
                return;
            }
            
            mascot.chain(...gestureChain);
            logEvent(`Executed gesture chain: ${gestureChain.join(' → ')}`);
            
            // Clear chain after execution
            gestureChain = [];
            updateChainDisplay();
        });

        document.getElementById('clear-chain').addEventListener('click', () => {
            gestureChain = [];
            updateChainDisplay();
            logEvent('Gesture chain cleared');
        });

        // Audio control handlers
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            mascot.setMasterVolume(volume);
            volumeDisplay.textContent = `${e.target.value}%`;
            logEvent(`Volume set to ${e.target.value}%`);
        });

        // Speech simulation
        let speechAudioContext = null;
        let speechOscillator = null;
        let speechGain = null;

        document.getElementById('speech-btn').addEventListener('click', async () => {
            try {
                // Create audio context for speech simulation
                speechAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Start speech reactivity
                mascot.startSpeaking(speechAudioContext);
                
                document.getElementById('speech-btn').disabled = true;
                document.getElementById('stop-speech-btn').disabled = false;
                
                // Update status
                const speechIndicator = document.createElement('span');
                speechIndicator.className = 'status-indicator speaking';
                speechIndicator.textContent = 'Speaking';
                speechIndicator.id = 'speech-status';
                statusIndicator.parentNode.insertBefore(speechIndicator, statusIndicator.nextSibling);
                
                logEvent('Speech reactivity started');
            } catch (error) {
                logEvent(`Failed to start speech: ${error.message}`, 'error');
            }
        });

        document.getElementById('stop-speech-btn').addEventListener('click', () => {
            mascot.stopSpeaking();
            
            if (speechAudioContext) {
                speechAudioContext.close();
                speechAudioContext = null;
            }
            
            document.getElementById('speech-btn').disabled = false;
            document.getElementById('stop-speech-btn').disabled = true;
            
            // Remove speech status
            const speechStatus = document.getElementById('speech-status');
            if (speechStatus) {
                speechStatus.remove();
            }
            
            logEvent('Speech reactivity stopped');
        });

        // Speech simulation
        document.getElementById('simulate-speech').addEventListener('click', () => {
            if (!speechAudioContext) {
                logEvent('Start speech reactivity first', 'warning');
                return;
            }
            
            // Create oscillator for speech simulation
            const oscillator = speechAudioContext.createOscillator();
            const gainNode = speechAudioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(speechAudioContext.destination);
            
            // Connect to mascot's analyser for reactivity
            const mascotAnalyser = mascot.audioAnalyser;
            if (mascotAnalyser) {
                gainNode.connect(mascotAnalyser);
            }
            
            // Simulate speech with varying frequency and amplitude
            oscillator.frequency.setValueAtTime(200, speechAudioContext.currentTime);
            gainNode.gain.setValueAtTime(0, speechAudioContext.currentTime);
            
            // Create speech-like pattern
            const duration = 3; // 3 seconds
            const steps = 20;
            const stepDuration = duration / steps;
            
            for (let i = 0; i < steps; i++) {
                const time = speechAudioContext.currentTime + (i * stepDuration);
                const frequency = 150 + Math.random() * 200; // Vary frequency
                const amplitude = 0.1 + Math.random() * 0.3; // Vary amplitude
                
                oscillator.frequency.setValueAtTime(frequency, time);
                gainNode.gain.setValueAtTime(amplitude, time);
            }
            
            // Fade out
            gainNode.gain.setValueAtTime(0, speechAudioContext.currentTime + duration);
            
            oscillator.start();
            oscillator.stop(speechAudioContext.currentTime + duration);
            
            logEvent('Simulated speech for 3 seconds');
        });

        // Clear log handler
        document.getElementById('clear-log').addEventListener('click', () => {
            eventLog.innerHTML = '';
            logEvent('Event log cleared');
        });

        // Performance metrics update
        setInterval(() => {
            const metrics = mascot.getPerformanceMetrics();
            
            document.getElementById('fps-value').textContent = metrics.fps || 0;
            document.getElementById('particles-value').textContent = metrics.particleCount || 0;
            document.getElementById('errors-value').textContent = metrics.errorStats?.totalErrors || 0;
            
            // Update audio level if speaking
            if (mascot.speaking && mascot.audioLevel !== undefined) {
                document.getElementById('audio-level-value').textContent = `${Math.round(mascot.audioLevel * 100)}%`;
            } else {
                document.getElementById('audio-level-value').textContent = '0%';
            }
        }, 100);

        // Mascot event listeners
        mascot.on('gestureStarted', (data) => {
            activeGestureEl.textContent = data.gesture;
            setTimeout(() => {
                if (activeGestureEl.textContent === data.gesture) {
                    activeGestureEl.textContent = 'none';
                }
            }, 2000);
        });

        mascot.on('performanceDegradation', (data) => {
            logEvent(`Performance degradation: FPS ${data.fps} < ${data.minFPS}, reduced particles to ${data.newMax}`, 'warning');
        });

        mascot.on('volumeSpike', (data) => {
            logEvent(`Volume spike detected: ${(data.level * 100).toFixed(1)}% - triggered pulse gesture`);
        });

        // Initialize display
        updateChainDisplay();
        logEvent('Interactive demo initialized');
        
        // Add helpful instructions
        setTimeout(() => {
            logEvent('Tip: Hold Shift while clicking gestures to add them to the chain', 'info');
        }, 2000);

        console.log('Interactive demo loaded successfully');
    </script>
</body>
</html>