class t{constructor(t){if(this.canvas=t,this.gl=t.getContext("webgl2",{alpha:!0,antialias:!0,depth:!0,premultipliedAlpha:!1}),!this.gl)throw new Error("WebGL 2.0 not supported");this.setupGL(),this.program=this.createProgram("#version 300 es\nin vec3 a_position;in vec3 a_normal;uniform mat4 u_modelMatrix;uniform mat4 u_viewMatrix;uniform mat4 u_projectionMatrix;out vec3 v_normal;out vec3 v_position;void main(){vec4 worldPos=u_modelMatrix*vec4(a_position,1.0);vec4 viewPos=u_viewMatrix*worldPos;gl_Position=u_projectionMatrix*viewPos;v_normal=mat3(u_modelMatrix)*a_normal;v_position=worldPos.xyz;}","#version 300 es\nprecision highp float;in vec3 v_normal;in vec3 v_position;uniform vec3 u_glowColor;uniform float u_glowIntensity;uniform vec3 u_cameraPosition;out vec4 fragColor;void main(){vec3 normal=normalize(v_normal);vec3 viewDir=normalize(u_cameraPosition-v_position);float fresnel=pow(1.0-max(dot(normal,viewDir),0.0),3.0);vec3 coreColor=vec3(1.0);vec3 glow=u_glowColor*u_glowIntensity*(0.3+fresnel*0.7);vec3 finalColor=coreColor+glow;fragColor=vec4(finalColor,1.0);}"),this.locations={position:this.gl.getAttribLocation(this.program,"a_position"),normal:this.gl.getAttribLocation(this.program,"a_normal"),modelMatrix:this.gl.getUniformLocation(this.program,"u_modelMatrix"),viewMatrix:this.gl.getUniformLocation(this.program,"u_viewMatrix"),projectionMatrix:this.gl.getUniformLocation(this.program,"u_projectionMatrix"),glowColor:this.gl.getUniformLocation(this.program,"u_glowColor"),glowIntensity:this.gl.getUniformLocation(this.program,"u_glowIntensity"),cameraPosition:this.gl.getUniformLocation(this.program,"u_cameraPosition")},this.cameraPosition=[0,0,3],this.cameraTarget=[0,0,0],this.projectionMatrix=this.createPerspectiveMatrix(),this.viewMatrix=this.createViewMatrix(),this.currentGeometry=null,this.buffers={}}setupGL(){const{gl:t}=this;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,0),t.viewport(0,0,this.canvas.width,this.canvas.height)}createProgram(t,e){const{gl:i}=this,a=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(a,t),i.compileShader(a),!i.getShaderParameter(a,i.COMPILE_STATUS))throw console.error("Vertex shader error:",i.getShaderInfoLog(a)),new Error("Vertex shader compilation failed");const n=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw console.error("Fragment shader error:",i.getShaderInfoLog(n)),new Error("Fragment shader compilation failed");const s=i.createProgram();if(i.attachShader(s,a),i.attachShader(s,n),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS))throw console.error("Program link error:",i.getProgramInfoLog(s)),new Error("Shader program linking failed");return s}uploadGeometry(t){const{gl:e}=this;this.buffers.position||(this.buffers.position=e.createBuffer(),this.buffers.normal=e.createBuffer(),this.buffers.indices=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.buffers.position),e.bufferData(e.ARRAY_BUFFER,t.vertices,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.buffers.normal),e.bufferData(e.ARRAY_BUFFER,t.normals,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffers.indices),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t.indices,e.STATIC_DRAW),this.currentGeometry=t}render(t){const{gl:e}=this,{geometry:i,position:a=[0,0,0],rotation:n=[0,0,0],scale:s=1,glowColor:o=[1,1,1],glowIntensity:r=1}=t;i!==this.currentGeometry&&this.uploadGeometry(i),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(this.program);const l=this.createModelMatrix(a,n,s);e.uniformMatrix4fv(this.locations.modelMatrix,!1,l),e.uniformMatrix4fv(this.locations.viewMatrix,!1,this.viewMatrix),e.uniformMatrix4fv(this.locations.projectionMatrix,!1,this.projectionMatrix),e.uniform3fv(this.locations.glowColor,o),e.uniform1f(this.locations.glowIntensity,r),e.uniform3fv(this.locations.cameraPosition,this.cameraPosition),e.bindBuffer(e.ARRAY_BUFFER,this.buffers.position),e.enableVertexAttribArray(this.locations.position),e.vertexAttribPointer(this.locations.position,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.buffers.normal),e.enableVertexAttribArray(this.locations.normal),e.vertexAttribPointer(this.locations.normal,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffers.indices),e.drawElements(e.TRIANGLES,this.currentGeometry.indices.length,e.UNSIGNED_SHORT,0)}createModelMatrix(t,e,i){const a=this.identity();return this.translate(a,t),this.rotateX(a,e[0]),this.rotateY(a,e[1]),this.rotateZ(a,e[2]),this.scale(a,[i,i,i]),a}createPerspectiveMatrix(){const t=45*Math.PI/180,e=this.canvas.width/this.canvas.height,i=1/Math.tan(t/2),a=1/-99.9;return new Float32Array([i/e,0,0,0,0,i,0,0,0,0,100.1*a,-1,0,0,10*a*2,0])}createViewMatrix(){const t=this.cameraPosition,e=this.cameraTarget,i=[0,1,0],a=e[0]-t[0],n=e[1]-t[1],s=e[2]-t[2],o=Math.sqrt(a*a+n*n+s*s),r=[a/o,n/o,s/o],l=r[1]*i[2]-r[2]*i[1],c=r[2]*i[0]-r[0]*i[2],h=r[0]*i[1]-r[1]*i[0],u=Math.sqrt(l*l+c*c+h*h),p=[l/u,c/u,h/u],d=[p[1]*r[2]-p[2]*r[1],p[2]*r[0]-p[0]*r[2],p[0]*r[1]-p[1]*r[0]];return new Float32Array([p[0],d[0],-r[0],0,p[1],d[1],-r[1],0,p[2],d[2],-r[2],0,-(p[0]*t[0]+p[1]*t[1]+p[2]*t[2]),-(d[0]*t[0]+d[1]*t[1]+d[2]*t[2]),r[0]*t[0]+r[1]*t[1]+r[2]*t[2],1])}identity(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}translate(t,[e,i,a]){t[12]+=e,t[13]+=i,t[14]+=a}rotateX(t,e){const i=Math.cos(e),a=Math.sin(e),n=t[4],s=t[5],o=t[6],r=t[7],l=t[8],c=t[9],h=t[10],u=t[11];t[4]=n*i+l*a,t[5]=s*i+c*a,t[6]=o*i+h*a,t[7]=r*i+u*a,t[8]=l*i-n*a,t[9]=c*i-s*a,t[10]=h*i-o*a,t[11]=u*i-r*a}rotateY(t,e){const i=Math.cos(e),a=Math.sin(e),n=t[0],s=t[1],o=t[2],r=t[3],l=t[8],c=t[9],h=t[10],u=t[11];t[0]=n*i-l*a,t[1]=s*i-c*a,t[2]=o*i-h*a,t[3]=r*i-u*a,t[8]=n*a+l*i,t[9]=s*a+c*i,t[10]=o*a+h*i,t[11]=r*a+u*i}rotateZ(t,e){const i=Math.cos(e),a=Math.sin(e),n=t[0],s=t[1],o=t[2],r=t[3],l=t[4],c=t[5],h=t[6],u=t[7];t[0]=n*i+l*a,t[1]=s*i+c*a,t[2]=o*i+h*a,t[3]=r*i+u*a,t[4]=l*i-n*a,t[5]=c*i-s*a,t[6]=h*i-o*a,t[7]=u*i-r*a}scale(t,[e,i,a]){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t[4]*=i,t[5]*=i,t[6]*=i,t[7]*=i,t[8]*=a,t[9]*=a,t[10]*=a,t[11]*=a}destroy(){const{gl:t}=this;this.buffers.position&&t.deleteBuffer(this.buffers.position),this.buffers.normal&&t.deleteBuffer(this.buffers.normal),this.buffers.indices&&t.deleteBuffer(this.buffers.indices),this.program&&t.deleteProgram(this.program)}}function e(t=32,e=32){const i=[],a=[],n=[];for(let n=0;n<=e;n++){const s=n/e*Math.PI;for(let e=0;e<=t;e++){const n=e/t*Math.PI*2,o=Math.cos(n)*Math.sin(s),r=Math.cos(s),l=Math.sin(n)*Math.sin(s);i.push(o,r,l),a.push(o,r,l)}}for(let i=0;i<e;i++)for(let e=0;e<t;e++){const a=i*(t+1)+e,s=a+t+1,o=a+1,r=s+1;n.push(a,s,o),n.push(o,s,r)}return{vertices:new Float32Array(i),normals:new Float32Array(a),indices:new Uint16Array(n)}}function i(t=6){const e=[],i=[],a=[],n=new Map;let s=0;function o(t,a,o,r,l,c){const h=`${t},${a},${o}`;return n.has(h)||(e.push(t,a,o),i.push(r,l,c),n.set(h,s++)),n.get(h)}const r=o(0,1.5,0,0,1,0),l=[];for(let e=0;e<t;e++){const i=e/t*Math.PI*2,a=o(.7*Math.cos(i),0,.7*Math.sin(i),Math.cos(i),0,Math.sin(i));l.push(a)}const c=o(0,-1.5,0,0,-1,0);for(let e=0;e<t;e++){const i=(e+1)%t;a.push(r,l[e],l[i])}for(let e=0;e<t;e++){const i=(e+1)%t;a.push(l[e],c,l[i])}return{vertices:new Float32Array(e),normals:new Float32Array(i),indices:new Uint16Array(a)}}function a(){const t=[],e=[],i=[],a=[0,1.2,0],n=[0,-.8,0],s=[];for(let t=0;t<8;t++){const e=t/8*Math.PI*2;s.push([.8*Math.cos(e),0,.8*Math.sin(e)])}function o(a,n,s){const o=[n[0]-a[0],n[1]-a[1],n[2]-a[2]],r=[s[0]-a[0],s[1]-a[1],s[2]-a[2]],l=o[1]*r[2]-o[2]*r[1],c=o[2]*r[0]-o[0]*r[2],h=o[0]*r[1]-o[1]*r[0],u=Math.sqrt(l*l+c*c+h*h),p=[l/u,c/u,h/u],d=t.length/3;t.push(...a),e.push(...p),t.push(...n),e.push(...p),t.push(...s),e.push(...p),i.push(d,d+1,d+2)}for(let t=0;t<8;t++){const e=(t+1)%8;o(a,s[t],s[e])}for(let t=0;t<8;t++){const e=(t+1)%8;o(s[t],n,s[e])}return{vertices:new Float32Array(t),normals:new Float32Array(e),indices:new Uint16Array(i)}}const n={sphere:e(32,32),crystal:i(6),diamond:a()};class s{constructor(){this.currentAnimation=null,this.animations=[],this.time=0}playEmotion(t,e={}){const i=this.createEmotionAnimation(t);this.startAnimation(i,e)}playGesture(t,e={}){const i=this.createGestureAnimation(t);this.startAnimation(i,e)}playMorph(t,e,i={}){const a=this.createMorphAnimation(t,e);this.startAnimation(a,i)}update(t){this.time+=t;for(let t=this.animations.length-1;t>=0;t--){const e=this.animations[t],i=Math.min((this.time-e.startTime)/e.duration,1),a=e.evaluate(i);e.callbacks.onUpdate&&e.callbacks.onUpdate(a),i>=1&&(e.callbacks.onComplete&&e.callbacks.onComplete(),this.animations.splice(t,1))}}createEmotionAnimation(t){const e={joy:{duration:.6,evaluate:t=>({scale:1+.15*Math.sin(t*Math.PI),glowIntensity:1+.3*Math.sin(t*Math.PI)})},love:{duration:1.2,evaluate:t=>({scale:1+.08*Math.sin(t*Math.PI*2),glowIntensity:1.2+.2*Math.sin(t*Math.PI*2)})},curiosity:{duration:.8,evaluate:t=>({rotation:[0,.1*Math.sin(t*Math.PI*4),0],scale:1+.05*Math.sin(t*Math.PI)})},sadness:{duration:1.5,evaluate:t=>({scale:1-.1*t,glowIntensity:1-.3*t})},anger:{duration:.4,evaluate:t=>{const e=.15*Math.sin(t*Math.PI*8);return{rotation:[e,e,0],scale:1.1+.1*Math.sin(t*Math.PI),glowIntensity:1.5}}},fear:{duration:.5,evaluate:t=>{const e=.08*Math.sin(t*Math.PI*10);return{scale:.9+e,rotation:[e,0,e],glowIntensity:.7}}},surprise:{duration:.4,evaluate:t=>({scale:1+.25*(1-Math.cos(t*Math.PI)),glowIntensity:1+.4*(1-Math.cos(t*Math.PI))})},neutral:{duration:.5,evaluate:t=>({scale:1,glowIntensity:1})}};return e[t]||e.neutral}createGestureAnimation(t){const e={bounce:{duration:.8,evaluate:t=>{const e=Math.abs(Math.sin(t*Math.PI));return{position:[0,.5*e,0],scale:1+.1*e}}},pulse:{duration:.6,evaluate:t=>{const e=Math.sin(t*Math.PI);return{scale:1+.2*e,glowIntensity:1+.5*e}}},spin:{duration:1,evaluate:t=>({rotation:[0,t*Math.PI*2,0]})},wobble:{duration:1,evaluate:t=>{const e=Math.sin(t*Math.PI*3);return{rotation:[.3*e,0,.2*e]}}},float:{duration:2,evaluate:t=>({position:[0,.3*Math.sin(t*Math.PI),0]})},shake:{duration:.5,evaluate:t=>{const e=Math.sin(t*Math.PI*6)*(1-t);return{position:[.2*e,0,0],rotation:[0,0,.1*e]}}},nod:{duration:.8,evaluate:t=>({rotation:[.3*Math.sin(t*Math.PI*2),0,0]})}};return e[t]||e.pulse}createMorphAnimation(t,e){return{duration:1,fromShape:t,toShape:e,evaluate:t=>({morphProgress:t,scale:1+.1*Math.sin(t*Math.PI),rotation:[0,t*Math.PI*.5,0]})}}startAnimation(t,e){this.animations.push({...t,startTime:this.time,callbacks:e||{}}),this.currentAnimation=t}stopAll(){this.animations=[],this.currentAnimation=null}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}getIdleAnimation(){return{duration:3,loop:!0,evaluate:t=>{const e=Math.sin(t*Math.PI*2),i=Math.sin(t*Math.PI);return{scale:1+.02*e,position:[.05*i,.03*e,0],rotation:[0,.05*i,0],glowIntensity:1+.1*e}}}}isPlaying(){return this.animations.length>0}}const o=new Map;var r=function(t){return o.get(t)||null},l=function(){return Array.from(o.keys())},c={name:"suspicion",emoji:"🤨",description:"Paranoid watchfulness with surveillance scanning",visual:{glowColor:"#6B46C1",glowIntensity:.85,particleRate:18,minParticles:6,maxParticles:12,particleBehavior:"surveillance",particleSpeed:.2,breathRate:.6,breathDepth:.04,coreJitter:.02,particleColors:[{color:"#6B46C1",weight:30},{color:"#4A5568",weight:25},{color:"#8B4789",weight:20},{color:"#9F7AEA",weight:15},{color:"#2D3748",weight:10}],threatLevel:0,getGlowIntensity(){return.3+.7*this.threatLevel},getParticleSpeed(){return.2+.8*this.threatLevel},getGlowColor(){const t=this.threatLevel||0,e=Math.round(107+113*t),i=Math.round(70+-32*t),a=Math.round(193+-66*t),n=t=>t.toString(16).padStart(2,"0");return`#${n(e)}${n(i)}${n(a)}`}},modifiers:{speed:.4,amplitude:.6,intensity:1.2,smoothness:.3,regularity:.2,focus:1.5,addWobble:!0},typicalGestures:["scan","twitch","peek","tilt","hold"],transitions:{duration:500,easing:"linear",priority:4},special:{coreSquint:.6,scanInterval:2e3,scanDuration:1200,scanAngle:60,twitchChance:.02,peekInterval:4e3,maxThreatDistance:300,alertThreshold:.7}},h={name:"calm",emoji:"😌",description:"Serene, peaceful state with gentle movements",visual:{glowColor:"#66D9CC",glowIntensity:.6,particleRate:25,minParticles:8,maxParticles:25,particleBehavior:"zen",breathRate:.4,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#66D9CC",weight:35},{color:"#99E6D9",weight:25},{color:"#40BFB3",weight:20},{color:"#B3F2E6",weight:15},{color:"#339980",weight:5}]},modifiers:{speed:.5,amplitude:.3,intensity:.4,smoothness:2,regularity:1.5,addWeight:!1,floatHeight:.2,swayAmount:.15,duration:1.5},typicalGestures:["breathe","float","drift","idle"],transitions:{duration:800,easing:"easeInOutSine",priority:1},movement:{floatPattern:"sine_slow",floatPeriod:6e3,floatAmplitude:8,swayPattern:"gentle",swayPeriod:8e3,swayAmplitude:5,microMovements:!1},getCoreParams(t){const e=t.time||Date.now(),i=.5*Math.sin(6e-4*e)+.5;return{scaleX:1-.02*i,scaleY:1-.02*i,eyeOpenness:.85,eyeExpression:"serene",pupilOffset:{x:2*Math.sin(3e-4*e),y:1*Math.cos(4e-4*e)},glowPulse:.95+.05*i}},updateParticle(t,e){t.x+=.1*Math.sin(.001*t.life),t.y-=.02*e,t.opacity=.3*Math.sin(.002*t.life)+.2,t.size=t.baseSize*(1+.2*Math.sin(.001*t.life))},renderCore:(t,e,i,a)=>!1};const u=new Map,p={happy:"joy",peaceful:"calm",curious:"surprise",frustrated:"anger",sad:"sadness"};function d(t){const e=p[t]||t,i=u.get(e);if(i)return i;return r(e)||null}function m(t){const e=d(t);if(!e)return d("neutral").visual;if(!e.visual)return{};const{visual:i}=e,a={};for(const t in i)"function"!=typeof i[t]&&(a[t]=i[t]);return"function"==typeof i.getGlowIntensity&&(a.glowIntensity=i.getGlowIntensity()),"function"==typeof i.getParticleSpeed&&(a.particleSpeed=i.getParticleSpeed()),"function"==typeof i.getParticleRate&&(a.particleRate=i.getParticleRate()),"function"==typeof i.getGlowColor&&(a.glowColor=i.getGlowColor()),a}function g(t){const e=d(t);return e?e.modifiers:d("neutral").modifiers}function y(t,e){const i=d(t),a=d(e);return i&&a?a.transitions&&a.transitions[t]?a.transitions[t]:{duration:1e3,easing:"ease-in-out",gesture:a.transitions?.defaultGesture||null}:{duration:1e3,easing:"ease-in-out"}}[{name:"neutral",emoji:"😐",description:"Calm, balanced emotional state",visual:{glowColor:"#00BCD4",glowIntensity:.9,particleRate:2,minParticles:8,maxParticles:10,particleBehavior:"ambient",breathRate:1,breathDepth:.08,coreJitter:!1,particleColors:[{color:"#00BCD4",weight:25},{color:"#00ACC1",weight:20},{color:"#26C6DA",weight:15},{color:"#B2EBF2",weight:15},{color:"#0097A7",weight:10},{color:"#80DEEA",weight:10},{color:"#E0F7FA",weight:5}]},modifiers:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},typicalGestures:["breathe","float","idle","blink"],transitions:{duration:500,easing:"easeInOut",priority:0},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"neutral",pupilOffset:{x:0,y:0}}),renderCore:(t,e,i,a)=>!1},{name:"joy",emoji:"😊",description:"Playful happiness and celebration",visual:{glowColor:"#FFEB3B",glowIntensity:1.6,particleRate:40,minParticles:0,maxParticles:40,particleBehavior:"popcorn",breathRate:1.5,breathDepth:.1,coreJitter:!1,particleColors:[{color:"#FFEB3B",weight:25},{color:"#FFC107",weight:20},{color:"#FFFF00",weight:15},{color:"#FFD700",weight:15},{color:"#FFF59D",weight:10},{color:"#FF9800",weight:10},{color:"#FFFDE7",weight:5}]},modifiers:{speed:1.8,amplitude:1.9,intensity:1.1,smoothness:1,regularity:.9,addBounce:!0},typicalGestures:["bounce","spin","wave","expand","shake","float"],transitions:{duration:400,easing:"easeOutBack",priority:5,burstOnEntry:!0},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"happy",pupilOffset:{x:0,y:-.1},sparkle:!0})},{name:"sadness",emoji:"😢",description:"Deep melancholic sorrow",visual:{glowColor:"#4169E1",glowIntensity:.65,particleRate:25,minParticles:0,maxParticles:25,particleBehavior:"falling",breathRate:.6,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#4169E1",weight:25},{color:"#1E90FF",weight:20},{color:"#6495ED",weight:15},{color:"#B0C4DE",weight:15},{color:"#191970",weight:10},{color:"#87CEEB",weight:10},{color:"#2F4F4F",weight:5}]},modifiers:{speed:.7,amplitude:.6,intensity:.8,smoothness:1.3,regularity:1.1,addGravity:!0},typicalGestures:["droop","sway","contract","drift","sink"],transitions:{duration:800,easing:"easeInOut",priority:3}},{name:"anger",emoji:"😠",description:"Intense rage and aggression",visual:{glowColor:"#DC143C",glowIntensity:1.8,particleRate:20,minParticles:3,maxParticles:10,particleBehavior:"aggressive",breathRate:2.2,breathDepth:.15,coreJitter:!0,particleColors:[{color:"#DC143C",weight:25},{color:"#FF0000",weight:20},{color:"#B22222",weight:15},{color:"#FF4500",weight:15},{color:"#8B0000",weight:10},{color:"#FF6347",weight:10},{color:"#660000",weight:5}]},modifiers:{speed:1.5,amplitude:1.4,intensity:1.3,smoothness:.3,regularity:.7,addShake:!0},typicalGestures:["shake","vibrate","expand","pulse","flicker","strike"],transitions:{duration:300,easing:"easeOutExpo",priority:8,shakeOnEntry:!0},special:{screenShake:!0,particleTrails:"fire",glowPulse:!0,temperatureEffect:"hot"}},{name:"fear",emoji:"😨",description:"Anxious state with fleeing particles",visual:{glowColor:"#8A2BE2",glowIntensity:.9,particleRate:18,minParticles:4,maxParticles:16,particleBehavior:"scattering",breathRate:2.5,breathDepth:.06,coreJitter:!0,particleColors:[{color:"#8A2BE2",weight:25},{color:"#4B0082",weight:20},{color:"#9400D3",weight:15},{color:"#6B46C1",weight:15},{color:"#9932CC",weight:10},{color:"#E6E6FA",weight:8},{color:"#301934",weight:7}]},modifiers:{speed:1.4,amplitude:.8,intensity:1.2,smoothness:.5,regularity:.5,addJitter:!0},typicalGestures:["shake","vibrate","contract","flicker","retreat"],transitions:{duration:400,easing:"easeOut",priority:7}},{name:"surprise",emoji:"😲",description:"Sudden shock with explosive particles",visual:{glowColor:"#FFD700",glowIntensity:1.8,particleRate:30,minParticles:0,maxParticles:15,particleBehavior:"burst",breathRate:.3,breathDepth:.18,coreJitter:!1,particleColors:[{color:"#FFD700",weight:25},{color:"#FFA500",weight:20},{color:"#FFFF00",weight:15},{color:"#FF6347",weight:15},{color:"#FFE4B5",weight:10},{color:"#FF4500",weight:10},{color:"#FFFACD",weight:5}]},modifiers:{speed:1.6,amplitude:1.5,intensity:1.4,smoothness:.7,regularity:.8,addPop:!0},typicalGestures:["expand","bounce","flash","pulse","pop"],transitions:{duration:200,easing:"easeOutBack",priority:6}},{name:"disgust",emoji:"🤢",description:"Revulsion with repelling particles",visual:{glowColor:"#9ACD32",glowIntensity:1,particleRate:15,minParticles:5,maxParticles:12,particleBehavior:"repelling",breathRate:.7,breathDepth:.04,coreJitter:!1,particleColors:[{color:"#9ACD32",weight:25},{color:"#ADFF2F",weight:20},{color:"#7FFF00",weight:15},{color:"#BDB76B",weight:15},{color:"#6B8E23",weight:10},{color:"#CCFF00",weight:8},{color:"#556B2F",weight:7}]},modifiers:{speed:.9,amplitude:.7,intensity:.9,smoothness:.8,regularity:1,addRecoil:!0},typicalGestures:["contract","shake","recoil","wobble"],transitions:{duration:600,easing:"easeIn",priority:4}},{name:"love",emoji:"💕",description:"Warm affection with orbiting particles",visual:{glowColor:"#FF1493",glowIntensity:1.8,particleRate:25,minParticles:10,maxParticles:18,particleBehavior:"orbiting",breathRate:.75,breathDepth:.15,coreJitter:!1,particleColors:[{color:"#FF1493",weight:30},{color:"#FF69B4",weight:25},{color:"#FF007F",weight:15},{color:"#FFB6C1",weight:10},{color:"#FF45A0",weight:10},{color:"#E91E63",weight:5},{color:"#FFC0CB",weight:5}]},modifiers:{speed:.9,amplitude:1.1,intensity:1.2,smoothness:1.4,regularity:1.2,addWarmth:!0},typicalGestures:["pulse","sway","orbit","glow","breathe","float"],transitions:{duration:700,easing:"easeInOut",priority:5}},c,{name:"excited",emoji:"🤩",description:"High energy with rapid particles",visual:{glowColor:"#FF6B35",glowIntensity:1.5,particleRate:25,minParticles:8,maxParticles:30,particleBehavior:"burst",breathRate:2,breathDepth:.14,coreJitter:!0,particleColors:[{color:"#FF6B35",weight:25},{color:"#FF1744",weight:20},{color:"#FFC107",weight:15},{color:"#FF9100",weight:15},{color:"#FFEB3B",weight:10},{color:"#FF5722",weight:10},{color:"#FFF59D",weight:5}]},modifiers:{speed:1.4,amplitude:1.3,intensity:1.3,smoothness:.8,regularity:.7,addVibration:!0},typicalGestures:["bounce","spin","vibrate","expand","shake","pulse"],transitions:{duration:300,easing:"easeOutElastic",priority:6}},{name:"resting",emoji:"😴",description:"Deep relaxation with slow drift",visual:{glowColor:"#9370DB",glowIntensity:.8,particleRate:10,minParticles:3,maxParticles:5,particleBehavior:"resting",breathRate:.8,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#9370DB",weight:30},{color:"#A591C4",weight:20},{color:"#B366FF",weight:20},{color:"#B8A1E6",weight:15},{color:"#674D9B",weight:15}]},modifiers:{speed:.5,amplitude:.4,intensity:.5,smoothness:1.4,regularity:.9,addWeight:!0},typicalGestures:["breathe","drift","sway","float"],transitions:{duration:1e3,easing:"easeInOut",priority:2}},{name:"euphoria",emoji:"🌟",description:"Radiant hope and new beginnings",visual:{glowColor:"#FFB6C1",glowIntensity:1.2,particleRate:35,minParticles:15,maxParticles:30,particleBehavior:"radiant",breathRate:1.3,breathDepth:.25,coreJitter:!1,particleColors:[{color:"#FFB6C1",weight:20},{color:"#FFD700",weight:18},{color:"#87CEEB",weight:15},{color:"#DDA0DD",weight:15},{color:"#98FB98",weight:12},{color:"#FFA07A",weight:10},{color:"#E6E6FA",weight:8},{color:"#FFFFFF",weight:2}]},modifiers:{speed:1.4,amplitude:1.5,intensity:1.6,smoothness:1.3,regularity:.8,addWarmth:!0,addLift:!0},typicalGestures:["expand","radiate","pulse","glow","float","bloom"],transitions:{duration:600,easing:"easeOutExpo",priority:8}},{name:"focused",emoji:"🎯",description:"Intense concentration with directed flow",visual:{glowColor:"#00CED1",glowIntensity:1.2,particleRate:10,minParticles:5,maxParticles:12,particleBehavior:"directed",breathRate:1.2,breathDepth:.08,coreJitter:!0,particleColors:[{color:"#00CED1",weight:30},{color:"#4A9FA0",weight:20},{color:"#00FFFF",weight:20},{color:"#5FE5E7",weight:15},{color:"#006B6D",weight:15}],eyeOpenness:.7,microAdjustments:!0},modifiers:{speed:1,amplitude:.9,intensity:1.1,smoothness:1.1,regularity:1.2,addPrecision:!0},typicalGestures:["track","lock","scan","pulse","vibrate"],transitions:{duration:400,easing:"easeIn",priority:5},getCoreParams:t=>({scaleX:1.1,scaleY:.7,eyeOpenness:.7,eyeExpression:"focused",pupilOffset:{x:0,y:0},microAdjustments:!0})},{name:"glitch",emoji:"🌈",description:"Surprised sadness with rainbow colors and glitch wiggle",visual:{primaryColor:"#FF6B9D",glowColor:"#4169E1",glowIntensity:1.2,particleRate:20,minParticles:5,maxParticles:15,particleBehavior:"burst",particleSpeed:1,breathRate:.4,breathDepth:.15,coreJitter:!1,coreSize:1,eyeOpenness:.8,particleColors:[{color:"#FF0080",weight:18},{color:"#00FF80",weight:18},{color:"#8000FF",weight:18},{color:"#FF8000",weight:15},{color:"#0080FF",weight:15},{color:"#FFFF00",weight:10},{color:"#FF6B9D",weight:6}],particleGlitchWiggle:!0,glitchWiggleIntensity:.3,glitchWiggleFrequency:.1},modifiers:{speed:1.1,amplitude:1,intensity:1.1,smoothness:.8,regularity:.7,focus:.6},typicalGestures:["bounce","sway","pulse","drift","flash"],transitions:{duration:300,easing:"easeInOut",priority:5}},h].forEach(t=>{t&&t.name&&u.set(t.name,t)});const f=new Map;var M=function(t){return f.get(t)||null},v={name:"bounce",emoji:"⬆️",type:"blending",description:"Vertical oscillation with smooth easing",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:30,frequency:2,axis:"vertical",damping:!0,easing:"sine",strength:.6,particleMotion:{type:"bounce",axis:"vertical",strength:.6,frequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"bounce"},frequencySync:{mode:"tempo",multiplier:1},durationSync:{mode:"beats",beats:4},accentResponse:{enabled:!0,multiplier:1.5},patternOverrides:{waltz:{frequencySync:{multiplier:.75},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:2,offBeat:.4,curve:"ease"}},dubstep:{amplitudeSync:{onBeat:1.5,dropBeat:3,curve:"pulse"}},breakbeat:{frequencySync:{multiplier:1.5},amplitudeSync:{onBeat:2.2,offBeat:.3}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.bounce={startY:t.y,startX:t.x,startVx:t.vx,startVy:t.vy,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.bounce?.initialized||this.initialize(t,i);const o={...this.config,...i},r=o.strength||this.config.strength||1,l=this.easeInOutCubic(e);let{frequency:c}=o;const h=i.phase||0;let u=o.amplitude*r*t.scaleFactor;i.rhythmModulation&&(u*=i.rhythmModulation.amplitudeMultiplier||1,u*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(c*=i.rhythmModulation.frequencyMultiplier));const p=Math.sin((l+h)*Math.PI*2*c);if(o.damping&&e>.7&&(u*=1-(e-.7)/.3*.8),"vertical"===o.axis?(t.vy+=p*u*.01*a,e>.9&&(t.vx*=.98)):"horizontal"===o.axis&&(t.vx+=p*u*.01*a,e>.9&&(t.vy*=.98)),e>.9){const i=1-10*(e-.9);t.vx=t.vx*(.95+.05*i),t.vy=t.vy*(.95+.05*i)}},cleanup(t){t.gestureData?.bounce&&delete t.gestureData.bounce},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,"3d":{evaluate(t,e){const i=e||{},a=.02*(i.amplitude||30),n=i.frequency||2,s=i.strength||.6,o=t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,r=Math.sin(o*Math.PI*2*n);let l=a*s;return t>.7&&(l*=1-(t-.7)/.3*.8),{position:[0,r*l*.25,0],rotation:[0,0,0],scale:1+.05*Math.abs(r)}}}},b={name:"pulse",emoji:"💗",type:"blending",description:"Radial expansion and contraction from center",config:{duration:600,amplitude:30,frequency:1,holdPeak:.1,easing:"sine",scaleAmount:.2,glowAmount:.3,strength:.15,direction:"outward",particleMotion:{type:"pulse",strength:.15,direction:"outward",frequency:1}},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.6,offBeat:.8,curve:"pulse"},frequencySync:{mode:"locked",subdivision:"quarter"},durationSync:{mode:"beats",beats:1},accentResponse:{enabled:!0,multiplier:2},patternOverrides:{waltz:{amplitudeSync:{onBeat:2,offBeat:.5},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"ease"},frequencySync:{subdivision:"swing"}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:4,curve:"pulse"}},breakbeat:{frequencySync:{mode:"random",range:[.5,2]},amplitudeSync:{onBeat:2.5,offBeat:.3}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.sqrt(n*n+s*s),r=Math.atan2(s,n);t.gestureData.pulse={baseDistance:o,angle:r,startX:t.x,startY:t.y,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.pulse?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.pulse,r={...this.config,...i},l=i.strength||1,c=this.easeInOutSine(e);let h,{frequency:u}=r,{amplitude:p}=r;i.rhythmModulation&&(p*=i.rhythmModulation.amplitudeMultiplier||1,p*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(u*=i.rhythmModulation.frequencyMultiplier));const d=c*u*2%2;h=r.holdPeak>0&&d>1-r.holdPeak&&d<1+r.holdPeak?1:Math.sin(c*Math.PI*2*u);const m=h*p*l*t.scaleFactor,g=o.baseDistance+m,y=n+Math.cos(o.angle)*g,f=s+Math.sin(o.angle)*g,M=.15*a;if(t.vx+=(y-t.x)*M*.1,t.vy+=(f-t.y)*M*.1,e>.9){const i=1-10*(e-.9);t.vx*=.9+.1*i,t.vy*=.9+.1*i}},cleanup(t){t.gestureData?.pulse&&delete t.gestureData.pulse},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2,"3d":{evaluate(t,e){const i=e||{},a=i.frequency||1,n=i.strength||.15,s=i.scaleAmount||.2,o=i.glowAmount||.3,r=-(Math.cos(Math.PI*t)-1)/2,l=Math.sin(r*Math.PI*2*a);return{position:[0,0,0],rotation:[0,0,0],scale:1+l*s*n,glowIntensity:1+l*o*n}}}},w={name:"shake",emoji:"🫨",type:"blending",description:"Random jitter movement for vibration effects",config:{duration:400,amplitude:15,frequency:15,decay:.9,smoothing:.1,axes:"both",easing:"linear",strength:3,particleMotion:{type:"shake",strength:3,frequency:15,decay:!1}},rhythm:{enabled:!0,syncMode:"subdivision",amplitudeSync:{subdivision:"sixteenth",onBeat:2.5,offBeat:.7,curve:"pulse"},frequencySync:{mode:"tempo",baseFrequency:15,scaling:"linear"},durationSync:{mode:"beats",beats:2},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.2},frequencySync:{mode:"random",range:[8,20]}},dubstep:{amplitudeSync:{subdivision:"eighth",onBeat:4,dropBeat:6,curve:"pulse"}},swing:{amplitudeSync:{onBeat:1.8,offBeat:1,curve:"ease"}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.shake={originalX:t.x,originalY:t.y,randomAngle:Math.random()*Math.PI*2,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.shake?.initialized||this.initialize(t,i);const o=t.gestureData.shake,r={...this.config,...i},l=r.strength||this.config.strength||1;let{amplitude:c}=r,{frequency:h}=r;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(h*=i.rhythmModulation.frequencyMultiplier));const u=r.decay?1-e:1,p=Math.sin(e*Math.PI*h)*c*u*l*t.scaleFactor,d=p*Math.cos(o.randomAngle),m=p*Math.sin(o.randomAngle);t.x=o.originalX+d,t.y=o.originalY+m},pseudoRandom(t){const e=1e4*Math.sin(t);return e-Math.floor(e)},cleanup(t){t.gestureData?.shake&&(t.x=t.gestureData.shake.originalX,t.y=t.gestureData.shake.originalY,delete t.gestureData.shake)},"3d":{evaluate(t,e){const i=e||{},a=.015*(i.amplitude||15),n=i.frequency||15,s=i.strength||1,o=i.decay?1-t:1,r=Math.sin(t*Math.PI*n)*a*o*s,l=Math.floor(t*n);return{position:[r*(1e4*Math.sin(l)%1-.5)*2*.25,0,r*(1e4*Math.sin(1.3*l)%1-.5)*2*.25],rotation:[0,0,r*(1e4*Math.sin(1.7*l)%1-.5)*.5*.25],scale:1}}}},x={name:"nod",emoji:"🙂",type:"blending",description:"Vertical nodding motion",config:{duration:500,amplitude:15,frequency:2,easing:"sine",strength:.4,particleMotion:{type:"bounce",axis:"vertical",strength:.4,frequency:2,phase:0}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!1,priority:5,blendable:!1,minDuration:"halfBar",frequencySync:{mode:"subdivision",subdivision:"half",multiplier:1},amplitudeSync:{onBeat:1.4,offBeat:.8,curve:"ease"},durationSync:{mode:"beats",beats:2},patternOverrides:{waltz:{frequencySync:{subdivision:"quarter"},amplitudeSync:{onBeat:1.6,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.5,offBeat:.9}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:3,curve:"pulse"}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.nod={startY:t.y,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.nod?.initialized||this.initialize(t,i);const o={...this.config,...i},r=o.strength||this.config.strength||1;let{frequency:l}=o,{amplitude:c}=o;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(l*=i.rhythmModulation.frequencyMultiplier));const h=Math.sin(e*Math.PI*2*l);c=c*r*t.scaleFactor,t.vy+=h*c*.01*a,e>.9&&(t.vy*=.95)},cleanup(t){t.gestureData?.nod&&delete t.gestureData.nod},"3d":{evaluate(t,e){const i={...this.config,...e};let{frequency:a}=i,{amplitude:n}=i;return e.rhythmModulation&&(n*=e.rhythmModulation.amplitudeMultiplier||1,n*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(a*=e.rhythmModulation.frequencyMultiplier)),{position:[0,0,0],rotation:[Math.sin(t*Math.PI*2*a)*(.02*n)*.25*(t>.9?.95:1),0,0],scale:1}}}},S={name:"vibrate",emoji:"📳",type:"blending",description:"High frequency vibration",config:{duration:500,frequency:20,amplitude:8,easing:"linear",strength:2,particleMotion:{type:"shake",strength:2,frequency:20,amplitude:8}},rhythm:{enabled:!0,syncMode:"subdivision",frequencySync:{subdivision:"thirty-second",baseFrequency:20,tempoScaling:!0},amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"pulse"},durationSync:{mode:"beats",beats:1},patternOverrides:{dubstep:{frequencySync:{subdivision:"sixteenth"},amplitudeSync:{onBeat:2,dropBeat:3}},breakbeat:{frequencySync:{mode:"random",range:[15,30]}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.vibrate={timer:0,seed:1e3*Math.random(),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.vibrate?.initialized||this.initialize(t,i);const o=t.gestureData.vibrate,r={...this.config,...i},l=r.strength||this.config.strength||1;let{amplitude:c}=r,{frequency:h}=r;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(h*=i.rhythmModulation.frequencyMultiplier)),o.timer+=a*h;const u=(Math.random()-.5)*c*l,p=(Math.random()-.5)*c*l;if(t.vx+=.5*u*a,t.vy+=.5*p*a,t.vx*=.9,t.vy*=.9,e>.8){const i=1-5*(e-.8);t.vx*=i,t.vy*=i}},cleanup(t){t.gestureData?.vibrate&&delete t.gestureData.vibrate},"3d":{evaluate(t,e){const i={...this.config,...e};let{amplitude:a}=i;const n=i.strength||this.config.strength||1;e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1);const s=t>.8?1-5*(t-.8):1;return{position:[(Math.random()-.5)*a*n*.5*s*.25,(Math.random()-.5)*a*n*.5*s*.25,(Math.random()-.5)*a*n*.5*s*.25],rotation:[.05*(Math.random()-.5)*s*.25,.05*(Math.random()-.5)*s*.25,.05*(Math.random()-.5)*s*.25],scale:1+.02*(Math.random()-.5)*s}}}},P={name:"orbit",emoji:"🪐",description:"3D orbital motion around center",type:"override",config:{speed:1,rotations:1,zRotations:1,smoothness:.15,verticalOscillation:0,centripetal:!1},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:1,scaling:"linear"},rotationSync:{mode:"bars",rotationsPerBar:1,zSync:!0},radiusSync:{subdivision:"quarter",pulsAmount:.1,curve:"ease"},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{pulsAmount:.15}},swing:{speedSync:{mode:"swing",ratio:.67},verticalOscillation:.2},dubstep:{radiusSync:{subdivision:"eighth",pulsAmount:.3,dropMultiplier:2}},breakbeat:{speedSync:{mode:"random",range:[.5,2]},centripetal:!0}}},apply:function(t,e,i,a,n,s,o){if(!e.initialized){e.originalX=t.x,e.originalY=t.y,e.originalZ=t.z||0,e.originalVx=t.vx||0,e.originalVy=t.vy||0;const a=t.x-s,n=t.y-o;e.radius=Math.sqrt(a*a+n*n),e.radius<50&&(e.radius=50+100*Math.random()),e.initialAngle=Math.atan2(n,a),e.orbitSpeed=i.speed*(.8+.4*Math.random()),e.orbitTilt=.3*Math.random(),e.initialized=!0}let{rotations:r}=i,l=.05;i.rhythmModulation&&(i.rhythmModulation.speedMultiplier&&(e.orbitSpeed*=i.rhythmModulation.speedMultiplier),i.rhythmModulation.rotationMultiplier&&(r*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusPulse&&(l=i.rhythmModulation.radiusPulse));let c=1,h=1;a<.15?(c=a/.15,c=c*c*(3-2*c),h=c):a>.85&&(c=(1-a)/.15,c=c*c*(3-2*c),h=c);const u=e.initialAngle+a*Math.PI*2*r*c,p=1+Math.sin(a*Math.PI*4)*l*c,d=e.radius*n*p*c,m=s+Math.cos(u)*d,g=o+Math.sin(u)*d,y=u*i.zRotations;if(t.z=.8*Math.sin(y)*c+e.originalZ*(1-c),a<.15){const i=.3*c;t.x=e.originalX+(m-e.originalX)*i,t.y=e.originalY+(g-e.originalY)*i;const a=-Math.sin(u)*d*e.orbitSpeed,n=Math.cos(u)*d*e.orbitSpeed;t.vx=e.originalVx+(a-e.originalVx)*h,t.vy=e.originalVy+(n-e.originalVy)*h}else if(a>.85){t.x=m+(e.originalX-m)*(1-c),t.y=g+(e.originalY-g)*(1-c);const i=-Math.sin(u)*d*e.orbitSpeed,a=Math.cos(u)*d*e.orbitSpeed;t.vx=i*h+e.originalVx*(1-h),t.vy=a*h+e.originalVy*(1-h)}else{if(i.verticalOscillation>0){const e=Math.sin(2*u)*i.verticalOscillation*n;t.y=g+e,t.x=m}else{const e=i.smoothness||.1;t.x+=(m-t.x)*e,t.y+=(g-t.y)*e}t.vx=-Math.sin(u)*d*e.orbitSpeed,t.vy=Math.cos(u)*d*e.orbitSpeed}if(i.centripetal){const n=1+.3*(1-Math.abs(t.z)),r=e.initialAngle+a*Math.PI*2*i.rotations*n;t.x=s+Math.cos(r)*d,t.y=o+Math.sin(r)*d}},emotions:["zen","love","excited","surprise"],features:{uses3D:!0,smooth:!0,looping:!0,dramatic:!0},"3d":{evaluate(t,e){const i={...this.config,...e};let{rotations:a}=i;const{zRotations:n}=i;e.rhythmModulation&&e.rhythmModulation.rotationMultiplier&&(a*=e.rhythmModulation.rotationMultiplier);let s=1;t<.15?(s=t/.15,s=s*s*(3-2*s)):t>.85&&(s=(1-t)/.15,s=s*s*(3-2*s));const o=t*Math.PI*2*a*s,r=o*n,l=.1*Math.sin(o)*s,c=.05*Math.cos(o)*s,h=.05*Math.sin(r)*s;return{position:[0,0,.2*Math.sin(r)*s*.25],rotation:[.25*c,.25*l,.25*h],scale:1+.03*Math.sin(2*o)*s}}}},D={name:"twitch",emoji:"⚡",type:"blending",description:"Nervous, paranoid twitching",config:{intensity:8,frequency:.08,duration:100,recovery:200,maxOffset:15,sharpness:.9},rhythm:{enabled:!0,syncMode:"subdivision",probabilitySync:{subdivision:"sixteenth",onBeat:.3,offBeat:.05,accentBoost:2},intensitySync:{onBeat:2,offBeat:.8,curve:"pulse"},patternOverrides:{breakbeat:{probabilitySync:{onBeat:.5,offBeat:.1},intensitySync:{onBeat:3,offBeat:.5}},dubstep:{intensitySync:{onBeat:1.5,dropBeat:5,curve:"pulse"}}}},apply(t,e,i,a,n,s){t.gestureData||(t.gestureData={}),t.gestureData.twitch||(t.gestureData.twitch={twitchOffset:{x:0,y:0},targetOffset:{x:0,y:0},isTwitching:!1,twitchTimer:0,cooldownTimer:0,lastTwitch:0});const o=t.gestureData.twitch,{config:r}=this;let l=i.intensity||r.intensity;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,l*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.probabilityMultiplier);const c=Date.now();if(!o.isTwitching&&o.cooldownTimer<=0&&Math.random()<(i.frequency||r.frequency)){o.isTwitching=!0,o.twitchTimer=r.duration,o.cooldownTimer=r.recovery;const t=Math.random()*Math.PI*2,e=.5*r.maxOffset+Math.random()*(.5*r.maxOffset);o.targetOffset={x:Math.cos(t)*e*l/8,y:Math.sin(t)*e*l/8},o.lastTwitch=c}if(o.cooldownTimer>0&&(o.cooldownTimer-=16*a),o.isTwitching)if(o.twitchTimer-=16*a,o.twitchTimer>0){const{sharpness:t}=r;o.twitchOffset.x+=(o.targetOffset.x-o.twitchOffset.x)*t,o.twitchOffset.y+=(o.targetOffset.y-o.twitchOffset.y)*t}else o.isTwitching=!1;else o.twitchOffset.x*=.85,o.twitchOffset.y*=.85;t.vx+=o.twitchOffset.x*a*.5,t.vy+=o.twitchOffset.y*a*.5,Math.random()<.1&&(t.vx+=(Math.random()-.5)*l*.3,t.vy+=(Math.random()-.5)*l*.3)},cleanup(t){t.gestureData?.twitch&&delete t.gestureData.twitch},"3d":{evaluate(t,e){const{config:i}=this;let a=e.intensity||i.intensity;const{maxOffset:n}=i;e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1);const s=9999*Math.floor(10*t),o=t=>{const e=1e4*Math.sin(s+t);return e-Math.floor(e)};if(o(0)<3*i.frequency){const t=o(1)*Math.PI*2,e=n*a/8;return{position:[Math.cos(t)*e*o(2)*.25,Math.sin(t)*e*o(3)*.25,(o(4)-.5)*e*.25],rotation:[.2*(o(5)-.5)*.25,.2*(o(6)-.5)*.25,.2*(o(7)-.5)*.25],scale:1+.1*(o(8)-.5)}}{const t=.5;return{position:[(o(10)-.5)*t*.25,(o(11)-.5)*t*.25,(o(12)-.5)*t*.25],rotation:[.01*(o(13)-.5)*.25,.01*(o(14)-.5)*.25,.01*(o(15)-.5)*.25],scale:1}}}}},I={name:"sway",type:"blending",emoji:"🌊",description:"Gentle side-to-side swaying motion",config:{duration:2e3,amplitude:20,frequency:1,strength:.5},rhythm:{enabled:!0,syncMode:"bar",amplitudeSync:{onBeat:1.2,offBeat:.9,curve:"ease"},durationSync:{mode:"bars",bars:1},patternOverrides:{waltz:{durationSync:{bars:1},amplitudeSync:{onBeat:1.5,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.3,offBeat:.7,curve:"bounce"}}}},apply(t,e,i,a,n,s){const o={...this.config,...i},r=o.amplitude||this.config.amplitude,l=o.frequency||this.config.frequency,c=o.strength||this.config.strength,h=Math.sin(e*Math.PI*2*l)*r;t.vx+=.01*h*a*c,t.vy+=.5*Math.cos(e*Math.PI*4)*a*c},cleanup(t){},"3d":{evaluate(t,e){const i={...this.config,...e};let a=i.amplitude||this.config.amplitude;const n=i.frequency||this.config.frequency,s=i.strength||this.config.strength;e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1);const o=Math.sin(t*Math.PI*2*n),r=a*s*.3,l=.15*o*s,c=.08*o*s;return{position:[o*r*.25,.3*Math.cos(t*Math.PI*4)*r*.25,Math.sin(t*Math.PI*n)*r*.5*.25],rotation:[0,.25*c,.25*l],scale:1}}}},z={name:"float",type:"blending",emoji:"🎈",description:"Gentle floating upward motion",config:{duration:2e3,amplitude:80,wobbleAmount:20,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"bounce"},wobbleSync:{subdivision:"eighth",intensity:.7},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:1.3},patternOverrides:{waltz:{wobbleSync:{subdivision:"quarter",intensity:.9}},dubstep:{amplitudeSync:{onBeat:2,curve:"pulse"}}}},apply(t,e,i,a,n,s){t.gestureData||(t.gestureData={}),t.gestureData.float||(t.gestureData.float={originalSize:t.size,originalOpacity:t.opacity||1});const o={...this.config,...i};let r=o.amplitude||this.config.amplitude,l=o.wobbleAmount||this.config.wobbleAmount;const c=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1,l*=i.rhythmModulation.wobbleMultiplier||1);const h=Math.sin(e*Math.PI*4)*l;t.vy-=.01*r*a*c*(1-.5*e),t.vx+=.01*h*a*c,t.size=t.baseSize*(1+.1*e),t.opacity=1-.3*e},cleanup(t){t.gestureData?.float?(t.opacity=t.gestureData.float.originalOpacity,t.size=t.gestureData.float.originalSize,delete t.gestureData.float):(t.opacity=1,t.size=t.baseSize),t.vx*=.5,t.vy*=.5},"3d":{evaluate(t,e){const i={...this.config,...e};let a=i.amplitude||this.config.amplitude,n=i.wobbleAmount||this.config.wobbleAmount;const s=i.strength||this.config.strength;e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1,n*=e.rhythmModulation.wobbleMultiplier||1);const o=-a*t*s*(1-.5*t),r=Math.sin(t*Math.PI*4)*n*.3,l=t*Math.PI*.5*s;return{position:[.25*r,.25*o,0],rotation:[.1*Math.sin(t*Math.PI*2)*.25,.25*l,.08*Math.cos(t*Math.PI*3)*.25],scale:1+.1*t}}}},B={name:"jitter",type:"blending",emoji:"🫨",description:"Nervous jittery movement",config:{duration:1e3,intensity:15,frequency:30,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:2,offBeat:.5,curve:"pulse"},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.3}},dubstep:{amplitudeSync:{onBeat:5,offBeat:.1,curve:"pulse"}}}},apply(t,e,i,a,n,s){t.gestureData||(t.gestureData={}),t.gestureData.jitter||(t.gestureData.jitter={originalSize:t.size});const o={...this.config,...i};let r=o.intensity||this.config.intensity;const l=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const c=(Math.random()-.5)*r*l,h=(Math.random()-.5)*r*l,u=1-.5*e;t.vx+=.1*c*a*u,t.vy+=.1*h*a*u,t.size=t.baseSize*(1+.1*(Math.random()-.5))},cleanup(t){t.gestureData?.jitter?(t.size=t.gestureData.jitter.originalSize,delete t.gestureData.jitter):t.size=t.baseSize,t.vx*=.7,t.vy*=.7},"3d":{evaluate(t,e){const i={...this.config,...e};let a=i.intensity||this.config.intensity;const n=i.strength||this.config.strength;e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1);const s=1-.5*t,o=a*n*.2*s;return{position:[(Math.random()-.5)*o*.25,(Math.random()-.5)*o*.25,(Math.random()-.5)*o*.25],rotation:[.03*(Math.random()-.5)*s*.25,.03*(Math.random()-.5)*s*.25,.03*(Math.random()-.5)*s*.25],scale:1+.05*(Math.random()-.5)*s}}}},C={name:"wiggle",type:"blending",emoji:"〰️",description:"Quick side-to-side wiggling motion",config:{duration:800,amplitude:15,frequency:6,easing:"linear",strength:.8},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"sharp"},durationSync:{mode:"beats",beats:2},patternOverrides:{disco:{amplitudeSync:{onBeat:2,curve:"bounce"}},funk:{frequency:8,amplitudeSync:{onBeat:1.8,offBeat:.6}}}},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.frequency||this.config.frequency,c=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const h=Math.sin(e*Math.PI*2*l)*r;t.vx+=.05*h*a*c},cleanup(t){},"3d":{evaluate(t,e){const i={...this.config,...e};let a=i.amplitude||this.config.amplitude;const n=i.frequency||this.config.frequency,s=i.strength||this.config.strength;return e.rhythmModulation&&(a*=e.rhythmModulation.amplitudeMultiplier||1,a*=e.rhythmModulation.accentMultiplier||1),{position:[0,Math.sin(t*Math.PI*2*n)*(a*s*2)*.25,0],rotation:[0,0,0],scale:1}}}},F={name:"groove",emoji:"🎵",type:"blending",description:"Rhythmic circular swaying motion",config:{duration:1e3,musicalDuration:{musical:!0,beats:2},amplitude:25,frequency:2,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.frequency||this.config.frequency,c=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const h=e*Math.PI*2*l,u=Math.sin(h)*r,p=Math.cos(h)*r*.5;t.vx+=.03*u*a*c,t.vy+=.03*p*a*c},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=t*Math.PI*2*2;return{position:[.3*Math.sin(a)*i,0,.4*Math.cos(a)*i],rotation:[0,.2*Math.sin(a)*i,0],scale:1}}}},O={name:"point",emoji:"👉",type:"blending",description:"Directional pointing with extension",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:20,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const c=Math.sin(e*Math.PI),h=c*r;t.vx+=.04*h*a*l;const u=c*r*.3;t.vy-=.02*u*a*l},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=Math.sin(t*Math.PI);return{position:[.2*a*i,0,.4*a*i],rotation:[0,.15*a*i,0],scale:1+.1*a*i}}}},A={name:"lean",emoji:"↗️",type:"blending",description:"Side-to-side tilting motion",config:{duration:1e3,musicalDuration:{musical:!0,beats:2},amplitude:18,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const c=Math.sin(e*Math.PI),h=c*r;t.vx+=.035*h*a*l;const u=Math.abs(c)*r*.2;t.vy-=.015*u*a*l},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=Math.sin(t*Math.PI);return{position:[.15*a*i,0,0],rotation:[0,0,.4*a*i],scale:1}}}},T={name:"reach",emoji:"🤚",type:"blending",description:"Upward reaching with extension",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:30,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const c=Math.sin(e*Math.PI),h=c*r;t.vy-=.04*h*a*l;const u=c*r*.2;t.vx+=.015*u*a*l},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=Math.sin(t*Math.PI);return{position:[0,.3*a*i*.25,0],rotation:[0,0,0],scale:1+.1*a}}}},k={name:"headBob",emoji:"🎧",type:"blending",description:"Rhythmic vertical bobbing to music",config:{duration:1e3,musicalDuration:{musical:!0,beats:2},amplitude:20,frequency:2,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply(t,e,i,a,n,s){const o={...this.config,...i};let r=o.amplitude||this.config.amplitude;const l=o.frequency||this.config.frequency,c=o.strength||this.config.strength;i.rhythmModulation&&(r*=i.rhythmModulation.amplitudeMultiplier||1,r*=i.rhythmModulation.accentMultiplier||1);const h=Math.sin(e*Math.PI*2*l)*r;t.vy+=.04*h*a*c;const u=Math.cos(e*Math.PI*2*l)*r*.2;t.vx+=.02*u*a*c},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=Math.sin(t*Math.PI*2*2);return{position:[0,.15*a*i*.25,0],rotation:[.08*a*i*.25,0,0],scale:1}}}},R={name:"spin",emoji:"🌀",type:"override",description:"Orbital rotation around center point",config:{duration:600,musicalDuration:{musical:!0,beats:1},rotations:1,direction:"random",radiusMultiplier:1,spiralOut:!1,accelerate:!0,maintainDistance:!0,scaleAmount:.1,easing:"linear",strength:.7,particleMotion:{type:"spin",strength:.7,rotations:1,radius:1}},rhythm:{enabled:!0,syncMode:"bar",rotationSync:{mode:"bars",rotationsPerBar:1,accelerateOnBeat:!0},radiusSync:{subdivision:"quarter",expandOnBeat:1.2,contractOffBeat:.9,curve:"bounce"},durationSync:{mode:"beats",beats:4},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{curve:"ease"}},swing:{rotationSync:{accelerateOnBeat:!1},direction:"alternating"},dubstep:{radiusSync:{subdivision:"eighth",expandOnBeat:1.5,dropMultiplier:2},spiralOut:!0},breakbeat:{rotationSync:{mode:"random",range:[.5,2]},direction:"random"}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;let o=e.direction||this.config.direction;"random"===o&&(o=Math.random()<.5?"clockwise":"counter-clockwise"),t.gestureData.spin={startAngle:Math.atan2(s,n),startRadius:Math.sqrt(n*n+s*s)||30,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,direction:o,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.spin?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.spin,r={...this.config,...i},l=i.strength||1;let{rotations:c}=r,{radiusMultiplier:h}=r;i.rhythmModulation&&(i.rhythmModulation.rotationMultiplier&&(c*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusMultiplier&&(h*=i.rhythmModulation.radiusMultiplier));let u=e;r.accelerate&&(u=e<.5?.5*this.easeInQuad(2*e):.5+.5*this.easeOutQuad(2*(e-.5)));const p=c*Math.PI*2*l,d="counter-clockwise"===o.direction?-1:1,m=o.startAngle+p*u*d;let g=o.startRadius;r.spiralOut&&(g*=1+.5*e),1!==h&&(g*=1+(h-1)*Math.sin(e*Math.PI));const y=n+Math.cos(m)*g,f=s+Math.sin(m)*g;if(t.x+=.25*(y-t.x),t.y+=.25*(f-t.y),t.vx=.5*(y-t.x),t.vy=.5*(f-t.y),e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.spin){const e=t.gestureData.spin;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.spin}},easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.spin)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.spin,n=e.config||{},s=e.strength||1;let o=t;n.accelerate&&(o=t<.5?t*t*4*.5:.5+(t-.5)*(2-(t-.5))*.5);const r=(n.rotations||1)*Math.PI*2*s*o*("counter-clockwise"===a.direction?-1:1),l=1+(n.scaleAmount||.1)*Math.sin(t*Math.PI)*s;return{position:[.25*i.x,.25*i.y,0],rotation:[0,.25*r,0],scale:l}}}},E={name:"jump",emoji:"🦘",type:"override",description:"Vertical jump with squash and stretch",config:{duration:800,musicalDuration:{musical:!0,beats:2},jumpHeight:.5,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:5,blendable:!1,crossfadePoint:"anyBeat",maxQueue:1},initialize(t,e,i,a){t.gestureData||(t.gestureData={}),t.gestureData.jump={startX:t.x,startY:t.y,startSize:t.size,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.jump?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.jump;this.config;let r=0,l=1;if(e<.2){const t=e/.2;r=10*t,l=1-.2*t}else if(e<.8){const t=(e-.2)/.6,i=Math.sin(t*Math.PI);r=100*-i,l=1+.3*i}else l=1-.2*(1-(e-.8)/.2);t.y=o.startY+r,t.size=o.startSize*l},cleanup(t){if(t.gestureData?.jump){const e=t.gestureData.jump;t.y=e.startY,t.size=e.startSize,delete t.gestureData.jump}},"3d":{evaluate(t,e){const i=e&&e.strength||1;let a=0,n=1;if(t<.2){const e=t/.2;a=.1*-e*i,n=1-.2*e}else if(t<.8){const e=(t-.2)/.6,s=Math.sin(e*Math.PI);a=.5*s*i,n=1+.3*s}else a=0,n=.8+(t-.8)/.2*.2;return{position:[0,a,0],rotation:[0,0,0],scale:n}}}},q={name:"morph",emoji:"✨",type:"override",description:"Form geometric patterns and shapes",config:{musicalDuration:{musical:!0,beats:2,minBeats:1,maxBeats:8},phases:[{name:"gather",beats:.25},{name:"form",beats:.75},{name:"hold",beats:.5},{name:"dissolve",beats:.5}],morphType:"fluid",pattern:"star",points:5,innerRadius:.4,size:80,amplitude:20,rotation:0,smooth:!0,randomizeOrder:!1,easing:"sine",strength:1.2,particleMotion:{type:"morph",pattern:"star",strength:1.2,smooth:!0,points:5}},rhythm:{enabled:!0,syncMode:"phrase",patternSync:{verse:"circle",chorus:"star",bridge:"heart",drop:"explosion"},timingSync:{formationBeat:1,holdBeats:2,dissolveBeat:4,curve:"anticipatory"},sizeSync:{onBeat:1.2,offBeat:.95,subdivision:"quarter",curve:"elastic"},rotationSync:{mode:"continuous",degreesPerBar:90,direction:"clockwise"},dynamics:{forte:{points:8,size:100},piano:{points:3,size:60}}},initialize(t,e,i,a,n){t.gestureData||(t.gestureData={});const s={...this.config,...e},o=t.x,r=t.y,l=Math.atan2(t.y-a,t.x-i),c=Math.random()<.5?1:-1;let h,u;const p=s.size*t.scaleFactor,d=(s.rotation||0)*Math.PI/180*c;switch(s.pattern){case"star":h=i,u=a,this.calculateStarPosition(t,l,p,s.points,s.innerRadius,d,i,a);break;case"heart":this.calculateHeartPosition(t,l,p,d,i,a);break;case"square":this.calculateSquarePosition(t,l,p,d,i,a);break;case"triangle":this.calculateTrianglePosition(t,l,p,d,i,a);break;default:{const t=p;h=i+Math.cos(l+d)*t,u=a+Math.sin(l+d)*t;break}}t.gestureData.morph={startX:o,startY:r,targetX:t.gestureData.morphTargetX||h,targetY:t.gestureData.morphTargetY||u,originalVx:t.vx,originalVy:t.vy,rotationDirection:c,initialized:!0}},calculateStarPosition(t,e,i,a,n,s,o,r){const l=((e+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI),c=Math.floor(l/(2*Math.PI)*10),h=c%2==0,u=Math.floor(c/2);let p;p=h?72*u*Math.PI/180:(72*u+36)*Math.PI/180,p+=s;const d=h?i:i*n;t.gestureData.morphTargetX=o+Math.cos(p)*d,t.gestureData.morphTargetY=r+Math.sin(p)*d},calculateHeartPosition(t,e,i,a,n,s){const o=(e+Math.PI)/(2*Math.PI),r=.05*i,l=16*Math.pow(Math.sin(o*Math.PI*2),3),c=-(13*Math.cos(o*Math.PI*2)-5*Math.cos(2*o*Math.PI*2)-2*Math.cos(3*o*Math.PI*2)-Math.cos(4*o*Math.PI*2)),h=Math.cos(a),u=Math.sin(a),p=l*h-c*u,d=l*u+c*h;t.gestureData.morphTargetX=n+p*r,t.gestureData.morphTargetY=s+d*r},calculateSquarePosition(t,e,i,a,n,s){const o=((e+a)%(2*Math.PI)+2*Math.PI)%(2*Math.PI);let r,l;const c=i;o<Math.PI/4||o>=7*Math.PI/4?(r=c,l=c*Math.tan(o)):o<3*Math.PI/4?(r=c/Math.tan(o),l=c):o<5*Math.PI/4?(r=-c,l=-c*Math.tan(o)):(r=-c/Math.tan(o),l=-c);const h=Math.cos(a),u=Math.sin(a),p=r*h-l*u,d=r*u+l*h;t.gestureData.morphTargetX=n+p,t.gestureData.morphTargetY=s+d},calculateTrianglePosition(t,e,i,a,n,s){const o=[{x:0,y:-i},{x:.866*-i,y:.5*i},{x:.866*i,y:.5*i}],r=Math.floor((e+Math.PI)/(2*Math.PI)*3)%3,l=(r+1)%3,c=Math.random(),h=o[r].x+(o[l].x-o[r].x)*c,u=o[r].y+(o[l].y-o[r].y)*c,p=Math.cos(a),d=Math.sin(a),m=h*p-u*d,g=h*d+u*p;t.gestureData.morphTargetX=n+m,t.gestureData.morphTargetY=s+g},apply(t,e,i,a,n,s){t.gestureData?.morph?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.morph,r={...this.config,...i};let l,c,h=e;if(r.holdTime>0){const t=.5-r.holdTime/2,i=.5+r.holdTime/2;h=e<t?e/t*.5:e<i?.5:.5+(e-i)/(1-i)*.5}if(h<=.5){const t=2*h;l=o.startX+(o.targetX-o.startX)*this.easeOutQuad(t),c=o.startY+(o.targetY-o.startY)*this.easeOutQuad(t)}else{const t=2*(h-.5);l=o.targetX+(o.startX-o.targetX)*this.easeInQuad(t),c=o.targetY+(o.startY-o.targetY)*this.easeInQuad(t)}if(r.smooth){const e=.2;t.x+=(l-t.x)*e,t.y+=(c-t.y)*e}else t.x=l,t.y=c;if(t.vx=.5*(l-t.x),t.vy=.5*(c-t.y),e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.morph){const e=t.gestureData.morph;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.morph,delete t.gestureData.morphTargetX,delete t.gestureData.morphTargetY}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t),easeInQuad:t=>t*t,"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.morph)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.morph,n=e.config||{};let s,o,r=t;if(n.holdTime>0){const e=.5-n.holdTime/2,i=.5+n.holdTime/2;r=t<e?t/e*.5:t<i?.5:.5+(t-i)/(1-i)*.5}if(r<=.5){const t=2*r,e=t*(2-t);s=a.startX+(a.targetX-a.startX)*e,o=a.startY+(a.targetY-a.startY)*e}else{const t=2*(r-.5),e=t*t;s=a.targetX+(a.startX-a.targetX)*e,o=a.targetY+(a.startY-a.targetY)*e}const l=a.rotationDirection||1;return{position:[s,o,0],rotation:[0,r*Math.PI*2*l*.5,0],scale:1+.1*Math.sin(r*Math.PI)}}}},j={name:"stretch",emoji:"↔️",type:"override",description:"Scale particles along X and Y axes",config:{duration:2e3,scaleX:1.3,scaleY:.9,alternate:!1,elastic:!0,overshoot:.1,frequency:1,easing:"sine",strength:1,particleMotion:{type:"stretch",scaleX:1.8,scaleY:.6,strength:1},centerBased:!0,preserveArea:!1},rhythm:{enabled:!0,syncMode:"beat",scaleSync:{onBeat:{x:1.5,y:.7},offBeat:{x:.8,y:1.3},subdivision:"eighth",curve:"elastic"},alternateSync:{pattern:"XYXY",beatsPerChange:1,overlap:.1},overshootSync:{normal:.1,accent:.3,downbeat:.2,curve:"spring"},preservationSync:{verse:!0,chorus:!1,bridge:!0},dynamics:{forte:{scaleX:2,scaleY:.5,overshoot:.4},piano:{scaleX:1.1,scaleY:.95,overshoot:.05}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;t.gestureData.stretch={offsetX:n,offsetY:s,startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.stretch?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.stretch,r={...this.config,...i},l=i.strength||1;let c,h,{scaleX:u}=r,{scaleY:p}=r;if(r.preserveArea&&1!==u&&1!==p){const t=u*p,e=Math.sqrt(1/t);u*=e,p*=e}if(r.alternate)if(e<.5){const t=2*e;u=1+(u-1)*this.getElasticProgress(t,r),p=1+(1/u-1)*(r.preserveArea?1:0)}else{const t=2*(e-.5);u+=(1-u)*this.getElasticProgress(t,r),p=1+(p-1)*this.getElasticProgress(t,r)}else{const t=this.getElasticProgress(e,r);u=1+(u-1)*t*l,p=1+(p-1)*t*l}if(r.centerBased?(c=n+o.offsetX*u,h=s+o.offsetY*p):(c=o.startX*u,h=o.startY*p),t.x=c,t.y=h,t.vx=o.offsetX*(u-1)*l*.1,t.vy=o.offsetY*(p-1)*l*.1,e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},getElasticProgress(t,e){if(!e.elastic)return this.easeInOutCubic(t);if(0===t)return 0;if(1===t)return 1;const i=e.overshoot||.1;if(t<.5){const e=2*t;return.5*this.easeInElastic(e,i)}{const e=2*(t-.5);return.5+.5*this.easeOutElastic(e,i)}},cleanup(t){if(t.gestureData?.stretch){const e=t.gestureData.stretch;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.stretch}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeInElastic:(t,e)=>0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1-.075)*(2*Math.PI)/.3)*(1+e),easeOutElastic:(t,e)=>0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)*(1+e)+1,"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.stretch)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=e.config||{},n=e.strength||1;let s,o,r,l=a.scaleX||1.3,c=a.scaleY||.9;if(a.preserveArea&&1!==l&&1!==c){const t=l*c,e=Math.sqrt(1/t);l*=e,c*=e}if(a.elastic){const e=a.overshoot||.1;if(t<.5){const i=2*t,a=.3,n=a/4;s=-Math.pow(2,10*(i-1))*Math.sin((i-1-n)*(2*Math.PI)/a)*(1+e)*.5}else{const i=2*(t-.5),a=.3,n=a/4;s=.5+.5*(Math.pow(2,-10*i)*Math.sin((i-n)*(2*Math.PI)/a)*(1+e)+1)}}else s=t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;a.alternate?t<.5?(o=1+(l-1)*s*n,r=1+(1/l-1)*(a.preserveArea?1:0)):(o=l+(1-l)*(s-.5)*2*n,r=1+(c-1)*(s-.5)*2*n):(o=1+(l-1)*s*n,r=1+(c-1)*s*n);const h=Math.sqrt(o*r);return{position:[i.x,i.y,0],rotation:[0,0,0],scale:h}}}},G={name:"tilt",emoji:"🤔",type:"override",description:"Gather particles then tilt as unified group",config:{duration:500,gatherPhase:.2,tiltAngle:45,swayAmount:80,liftAmount:60,frequency:3,homeRadius:20,easing:"sine",strength:2.5,particleMotion:{type:"tilt",strength:2.5,frequency:3,swayAmount:80,liftAmount:60},smoothness:.25},rhythm:{enabled:!0,syncMode:"swing",angleSync:{onBeat:45,offBeat:-30,swing:15,subdivision:"triplet",curve:"ease-in-out"},gatherSync:{beatsBefore:.5,releaseAfter:.25,intensity:"dynamic"},swaySync:{verse:60,chorus:100,bridge:80,syncopated:!0},liftSync:{upOnTilt:!0,heightOnAccent:80,normalHeight:40,curve:"bounce"},dynamics:{forte:{tiltAngle:60,swayAmount:120,frequency:4},piano:{tiltAngle:20,swayAmount:40,frequency:2}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.atan2(s,n),r=Math.sqrt(n*n+s*s),l=Math.random(),c=({...this.config,...e}.homeRadius+20*Math.random())*t.scaleFactor;t.gestureData.tilt={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,angle:o,distance:r,homeRadius:c,homeX:i+Math.cos(o)*c,homeY:a+Math.sin(o)*c,role:l,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.tilt?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.tilt,r={...this.config,...i},l=i.strength||1;let c,h;if(e<r.gatherPhase){const i=e/r.gatherPhase,a=this.easeInOutCubic(i);c=o.startX+(o.homeX-o.startX)*a,h=o.startY+(o.homeY-o.startY)*a;const n=.6;t.x+=(c-t.x)*n,t.y+=(h-t.y)*n}else{const i=(e-r.gatherPhase)/(1-r.gatherPhase)*Math.PI*r.frequency,a=Math.sin(i),u=r.tiltAngle*Math.PI/180*l,p=o.angle+a*u,d=Math.abs(a)*r.liftAmount*t.scaleFactor,m=o.homeRadius+d;c=n+Math.cos(p)*m,h=s+Math.sin(p)*m-.3*d;const g=r.smoothness+.1*o.role;t.x+=(c-t.x)*g,t.y+=(h-t.y)*g;const y=-Math.sin(p),f=Math.cos(p);t.vx=y*a*2,t.vy=f*a*2}if(e<r.gatherPhase&&(t.vx=.25*(c-t.x),t.vy=.25*(h-t.y)),e>.9){const i=10*(1-e),a=o.startX+(t.x-o.startX)*i,n=o.startY+(t.y-o.startY)*i;t.x=a,t.y=n,t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.tilt){const e=t.gestureData.tilt;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.tilt}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.tilt)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.tilt,n=e.config||{},s=e.strength||1,o=n.gatherPhase||.2;let r=0,l=0;if(t>=o){const e=(t-o)/(1-o)*Math.PI*(n.frequency||3),i=Math.sin(e),c=(n.tiltAngle||45)*Math.PI/180*s,h=Math.abs(a.angle%Math.PI);h<Math.PI/4||h>3*Math.PI/4?l=i*c:r=i*c}return{position:[.25*i.x,.25*i.y,0],rotation:[.25*r,0,.25*l],scale:1}}}},V={name:"orbital",emoji:"🪐",type:"override",description:"Orbital motion around center",config:{speed:.02,maintainRadius:!0,elliptical:!1,use3D:!0,zPhaseOffset:0,verticalOscillation:0,duration:3e3,particleMotion:{type:"orbital",strength:1}},rhythm:{enabled:!0,syncMode:"harmonic",speedSync:{tonic:.02,fifth:.03,octave:.04,third:.025,curve:"smooth"},radiusSync:{bass:150,mid:100,treble:50,scaling:"logarithmic"},depthSync:{major:{z:1,phase:0},minor:{z:-1,phase:Math.PI},diminished:{z:.5,phase:Math.PI/2},augmented:{z:.8,phase:-Math.PI/2}},phaseSync:{mode:"harmonic",intervals:[1,1.5,2],drift:.05},dynamics:{forte:{speed:.04,maintainRadius:!1},piano:{speed:.01,maintainRadius:!0}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.sqrt(n*n+s*s),r=Math.random()<.5?1:-1,l=Math.max(o,100+180*Math.random());t.gestureData.orbital={radius:l,targetRadius:l,angle:o<5?Math.random()*Math.PI*2:Math.atan2(s,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,direction:r}},apply(t,e,i,a,n,s){t.gestureData?.orbital||this.initialize(t,i,n,s);const o=t.gestureData.orbital,r=(i.speed||this.config.speed)*(i.strength||1);o.angle+=r*a*o.direction;let{radius:l}=o;if(i.maintainRadius||(l=o.radius*(1+.1*Math.sin(e*Math.PI*2))),t.x=n+Math.cos(o.angle)*l,t.y=s+Math.sin(o.angle)*l,!1!==i.use3D){const e=o.angle+o.zPhase+(i.zPhaseOffset||0);if(t.z=.8*Math.sin(e),i.verticalOscillation){const a=Math.cos(e)*i.verticalOscillation*l*.1;t.y+=a}}if(t.vx=-Math.sin(o.angle)*l*r,t.vy=Math.cos(o.angle)*l*r,e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.orbital){const e=t.gestureData.orbital;t.vx=e.originalVx,t.vy=e.originalVy,t.z=e.originalZ,delete t.gestureData.orbital}},"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.orbital)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.orbital,n=i.z||0,s=a.angle+Math.PI/2,o=1+.15*n;return{position:[i.x,i.y,n],rotation:[0,s,0],scale:o}}}},Y={name:"hula",emoji:"🌀",type:"override",description:"Hula-hoop motion with vertical waves",config:{speed:.015,maintainRadius:!1,elliptical:!0,use3D:!0,zPhaseOffset:Math.PI/4,verticalOscillation:.3,wobbleAmount:.15,duration:2500,particleMotion:{type:"hula",strength:1,verticalOscillation:.3}},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:.015,scaling:"proportional"},wobbleSync:{onBeat:.25,offBeat:.1,curve:"sine"},verticalSync:{subdivision:"quarter",amplitude:.4,phase:"sequential"},dynamics:{forte:{wobbleAmount:.3,speed:1.2},piano:{wobbleAmount:.05,speed:.8}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.sqrt(n*n+s*s),r=Math.random()<.5?1:-1,l=Math.max(o,100+180*Math.random());t.gestureData.hula={radius:l,angle:o<5?Math.random()*Math.PI*2:Math.atan2(s,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,wobblePhase:Math.random()*Math.PI*2,direction:r}},apply(t,e,i,a,n,s){t.gestureData?.hula||this.initialize(t,i,n,s);const o=t.gestureData.hula,r=(i.speed||this.config.speed)*(i.strength||1);let l=1;e<.1?(l=e/.1,l=Math.sin(l*Math.PI*.5)):e>.9&&(l=(1-e)/.1,l=Math.sin(l*Math.PI*.5)),o.angle+=r*a*o.direction*l;const c=Math.sin(2*o.angle+o.wobblePhase)*(i.wobbleAmount||this.config.wobbleAmount)*l,h=o.radius*(1+c)*l,u=o.radius*(.7+c)*l,p=n+Math.cos(o.angle)*h,d=s+Math.sin(o.angle)*u;if(e<.1){const e=t.x-n,i=t.y-s;Math.sqrt(e*e+i*i)<50?(t.x=n+Math.cos(o.angle)*h,t.y=s+Math.sin(o.angle)*u):(t.x=t.x+(p-t.x)*l*.5,t.y=t.y+(d-t.y)*l*.5)}else t.x=p,t.y=d;const m=o.angle+o.zPhase+(i.zPhaseOffset||this.config.zPhaseOffset);t.z=.9*Math.sin(m)*l;const g=i.verticalOscillation||this.config.verticalOscillation,y=Math.cos(2*m)*g*o.radius*.2*l;t.y+=y;const f=t.z*o.radius*.1;t.y-=f;const M=-Math.sin(o.angle)*h*r,v=Math.cos(o.angle)*u*r;e<.1?(t.vx=o.originalVx+(M-o.originalVx)*l,t.vy=o.originalVy+(v-o.originalVy)*l):e>.9?(t.vx=M*l+o.originalVx*(1-l),t.vy=v*l+o.originalVy*(1-l),t.z=t.z*l+o.originalZ*(1-l)):(t.vx=M,t.vy=v)},cleanup(t){if(t.gestureData?.hula){const e=t.gestureData.hula;t.vx=e.originalVx,t.vy=e.originalVy,t.z=e.originalZ,delete t.gestureData.hula}},"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.hula)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.hula,n=e.config||{},s=i.z||0,o=a.angle+a.direction*t*Math.PI*2,r=Math.sin(2*a.angle+a.wobblePhase)*(n.wobbleAmount||.15),l=Math.cos(a.angle)*r*10,c=s,h=1+.1*Math.abs(Math.sin(a.angle));return{position:[.25*(i.x+l),.25*i.y,.25*c],rotation:[0,.25*o,0],scale:h}}}},_={name:"scan",emoji:"🔍",type:"override",description:"Searchlight scanning motion",config:{scanSpeed:.008,scanWidth:120,pauseDuration:300,scanHeight:40,layers:3,duration:3e3},rhythm:{enabled:!0,syncMode:"measure",sweepSync:{beatsPerSweep:4,pauseOnDownbeat:!0,reverseOnBar:!0,curve:"linear"},layerSync:{quiet:1,moderate:2,loud:3,stagger:"sequential"},pauseSync:{onBeat:500,offBeat:100,accent:800,subdivision:"quarter"},widthSync:{verse:80,chorus:140,bridge:100,transition:"smooth"},dynamics:{forte:{scanSpeed:.012,layers:4},piano:{scanSpeed:.004,layers:1}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=Math.floor(Math.random()*this.config.layers);t.gestureData.scan={layer:n,phase:Math.random()*Math.PI*2,direction:Math.random()<.5?1:-1,pauseTimer:0,isPaused:!1,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,scanOffset:20*(Math.random()-.5),verticalOffset:30*n-30,initialized:!0,startTime:Date.now()}},apply(t,e,i,a,n,s){t.gestureData?.scan||this.initialize(t,i,n,s);const o=t.gestureData.scan,r=i.scanSpeed||this.config.scanSpeed,l=i.scanWidth||this.config.scanWidth,c=i.pauseDuration||this.config.pauseDuration;if(o.isPaused)o.pauseTimer-=16*a,o.pauseTimer<=0&&(o.isPaused=!1,o.direction*=-1);else{o.phase+=r*o.direction*a;const t=Math.sin(o.phase);Math.abs(t)>.95&&(o.isPaused=!0,o.pauseTimer=c)}const h=Math.sin(o.phase)*l,u=Math.cos(.5*o.phase)*(this.config.scanHeight/2);let p=1;e<.15?(p=e/.15,p*=p):e>.85&&(p=(1-e)/.15,p*=p);const d=n+h+o.scanOffset,m=s+u+o.verticalOffset;t.x=o.originalX+(d-o.originalX)*p,t.y=o.originalY+(m-o.originalY)*p,o.isPaused?(t.vx*=.85,t.vy*=.85):(t.vx=-Math.cos(o.phase)*l*r*60,t.vy=-Math.sin(.5*o.phase)*this.config.scanHeight*r*30),Math.random()<.02&&(t.vx+=2*(Math.random()-.5),t.vy+=2*(Math.random()-.5))},cleanup(t){if(t.gestureData?.scan){const e=t.gestureData.scan;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.scan}},"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.scan)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.scan,n=a.phase,s=.2*(a.layer-1),o=a.isPaused?.05*Math.sin(t*Math.PI*4):0,r=a.isPaused?1+.05*Math.sin(t*Math.PI*8):1,l=.2*a.layer-.2;return{position:[i.x,i.y,l],rotation:[s,n,o],scale:r}}}},X={name:"twist",emoji:"🌀",type:"override",description:"Twisting dance motion with alternating rotation",config:{duration:1200,rotationAngle:45,contractionFactor:.8,twistFrequency:2,easing:"smooth",strength:.8,particleMotion:{type:"twist",rotationAngle:45,contractionFactor:.8,twistFrequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:4,blendable:!1,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.5,offBeat:.7,curve:"elastic"},patternOverrides:{funk:{rotationAngle:60,contractionFactor:.7},disco:{twistFrequency:3,rotationAngle:50},latin:{rotationAngle:35,contractionFactor:.85,twistFrequency:2.5}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.twist={startX:t.x,startY:t.y,startAngle:Math.atan2(t.y-e.centerY,t.x-e.centerX),startDistance:Math.sqrt(Math.pow(t.x-e.centerX,2)+Math.pow(t.y-e.centerY,2)),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.twist?.initialized||this.initialize(t,{...i,centerX:n,centerY:s});const o={...this.config,...i},r=t.gestureData.twist,l=o.strength||this.config.strength||1,c=e*o.twistFrequency*Math.PI*2,h=Math.sin(c)*l;let{rotationAngle:u}=o,{contractionFactor:p}=o;i.rhythmModulation&&(u*=i.rhythmModulation.amplitudeMultiplier||1,p=1-(1-p)*(i.rhythmModulation.amplitudeMultiplier||1));const d=u*Math.PI/180*h,m=1-(1-p)*Math.abs(h),g=r.startAngle+d,y=r.startDistance*m,f=n+Math.cos(g)*y,M=s+Math.sin(g)*y,v=.15*l;t.x+=(f-t.x)*v,t.y+=(M-t.y)*v,t.vx=.05*(f-t.x),t.vy=.05*(M-t.y);const b=5*Math.sin(e*Math.PI*4)*l;if(t.y+=.1*b,e>.9){const i=1-10*(e-.9);t.vx*=i,t.vy*=i}},cleanup(t){t.gestureData?.twist&&delete t.gestureData.twist},"3d":{evaluate(t,e){const{particle:i}=e;if(!i||!i.gestureData?.twist)return{position:[0,0,0],rotation:[0,0,0],scale:1};const a=i.gestureData.twist,n=e.config||{},s=n.strength||1,o=t*(n.twistFrequency||2)*Math.PI*2,r=Math.sin(o)*s,l=r*((n.rotationAngle||45)*Math.PI/180),c=a.startAngle+l,h=(n.contractionFactor||.8)*a.startDistance,u=Math.cos(c)*h*.1,p=Math.sin(c)*h*.1,d=.1*Math.cos(o)*s,m=.15*Math.sin(.5*o)*s,g=1-(1-(n.contractionFactor||.8))*Math.abs(r);return{position:[.25*(i.x+u),.25*i.y,.25*p],rotation:[.25*d,.25*l,.25*m],scale:g}}}},L={name:"wave",emoji:"🌊",type:"override",description:"Infinity pattern flow with phasing",config:{musicalDuration:{musical:!0,bars:1,minBeats:4,maxBeats:16},phases:[{name:"gather",beats:.5},{name:"rise",beats:.5},{name:"waveLeft",beats:1},{name:"waveRight",beats:1},{name:"settle",beats:1}],amplitude:40,frequency:1,phaseShift:.3,liftHeight:20,fadeInOut:!0,smoothness:.1,easing:"sine",strength:1,particleMotion:{type:"wave",strength:1,amplitude:50}},rhythm:{enabled:!0,syncMode:"wave",amplitudeSync:{onWave:65,onStatic:25,curve:"flowing"},frequencySync:{mode:"phrase",slow:.7,fast:1.8,curve:"melodic"},durationSync:{mode:"bars",adaptToPhrase:!0,sustain:!0},phaseSync:{enabled:!0,multiplier:.5,type:"ensemble"},melodicResponse:{enabled:!0,multiplier:1.4,type:"amplitude"},patternOverrides:{ambient:{amplitudeSync:{onWave:80,onStatic:40,curve:"hypnotic"},frequencySync:{slow:.5,fast:1.2},durationSync:{minBeats:16,maxBeats:64}},ocean:{amplitudeSync:{onWave:90,onStatic:20,curve:"natural"},phaseSync:{multiplier:.8},melodicResponse:{multiplier:1.8}},electronic:{amplitudeSync:{onWave:70,onStatic:30,curve:"digital"},frequencySync:{slow:.8,fast:2.5,curve:"precise"}},orchestral:{amplitudeSync:{onWave:75,onStatic:35},phaseSync:{multiplier:.7},melodicResponse:{multiplier:2}}},dynamics:{forte:{amplitudeSync:{onWave:{multiplier:1.8},onStatic:{multiplier:1.4}},frequencySync:{multiplier:1.3},melodicResponse:{multiplier:2.2}},piano:{amplitudeSync:{onWave:{multiplier:.6},onStatic:{multiplier:.4}},frequencySync:{multiplier:.7},melodicResponse:{multiplier:1.1}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.atan2(s,n),r=Math.sqrt(n*n+s*s),l=Math.random()<.5?1:-1;t.gestureData.wave={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,angle:o,radius:r,offset:Math.random()*Math.PI*2,role:Math.random(),direction:l,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.wave?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.wave,r={...this.config,...i},l=i.strength||1,c=this.easeInOutSine(e),h=o.role*r.phaseShift,u=Math.max(0,c-h),p=u*Math.PI*2*r.frequency*o.direction+o.offset,d=.5+o.radius/100*.5,m=r.amplitude*d*l*t.scaleFactor,g=n+Math.sin(p)*m,y=s+Math.sin(2*p)*m*.3+-Math.abs(Math.sin(c*Math.PI))*r.liftHeight*t.scaleFactor,f=r.smoothness+.12*o.role;if(t.x+=(g-t.x)*f,t.y+=(y-t.y)*f,t.vx=.3*(g-t.x),t.vy=.3*(y-t.y),r.fadeInOut){let e;e=u<.1?u/.1:u>.9?(1-u)/.1:.5+.5*Math.sin(u*Math.PI),t.opacity=o.baseOpacity*(.3+.7*e),void 0!==t.life&&(t.life=t.opacity)}if(e>=.95){const i=20*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i),r.fadeInOut&&(t.opacity=o.baseOpacity*i,void 0!==t.life&&(t.life=t.opacity))}},cleanup(t){if(t.gestureData?.wave){const e=t.gestureData.wave;t.vx=e.originalVx,t.vy=e.originalVy,t.opacity=e.baseOpacity,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.wave}},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2,"3d":{evaluate(t,e){const i={...this.config,...e},a=-(Math.cos(Math.PI*t)-1)/2,n=a*Math.PI*2*i.frequency;return{position:[.15*Math.sin(n)*(e.strength||1),.08*Math.sin(2*n)*(e.strength||1),0],rotation:[0,0,0],scale:1+.05*Math.abs(Math.sin(a*Math.PI)),glowIntensity:1+.2*Math.sin(a*Math.PI)}}}},H={name:"drift",emoji:"☁️",type:"override",description:"Controlled floating with fade effects",config:{duration:800,distance:50,angle:45,returnToOrigin:!0,fadeOut:!1,holdTime:.2,turbulence:.1,angleSpread:45,smoothness:.08,easing:"ease",strength:1,particleMotion:{type:"drift",strength:1,distance:60}},rhythm:{enabled:!0,syncMode:"ambient",distanceSync:{quiet:30,loud:80,crescendo:"expand",diminuendo:"contract"},angleSync:{major:45,minor:225,modulation:"smooth",cadence:"return"},holdSync:{shortPhrase:.1,longPhrase:.4,fermata:"sustain"},accentResponse:{enabled:!0,multiplier:1.3,type:"distance"},patternOverrides:{ambient:{distanceSync:{quiet:40,loud:100},holdSync:{shortPhrase:.3,longPhrase:.6}},classical:{angleSync:{major:30,minor:210},distanceSync:{quiet:25,loud:60}},jazz:{angleSync:{major:60,minor:240,swing:!0,syncopated:!0}},new_age:{distanceSync:{quiet:35,loud:70},holdSync:{shortPhrase:.4,longPhrase:.8},angleSync:{modulation:"gradual"}}},dynamics:{forte:{distanceSync:{quiet:{multiplier:1.5},loud:{multiplier:1.8}},holdSync:{multiplier:1.2},accentResponse:{multiplier:1.6}},piano:{distanceSync:{quiet:{multiplier:.6},loud:{multiplier:.8}},holdSync:{multiplier:.8},accentResponse:{multiplier:1.1}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;let o=Math.atan2(s,n);const r={...this.config,...e}.angleSpread*Math.PI/180,l=(Math.random()-.5)*r;o+=l;const c=30+30*Math.random();t.gestureData.drift={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,driftAngle:o,angleOffset:l,homeRadius:c*t.scaleFactor,homeX:i+Math.cos(o)*c,homeY:a+Math.sin(o)*c,role:Math.random(),turbulencePhase:Math.random()*Math.PI*2,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.drift?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.drift,r={...this.config,...i},l=i.strength||1,c=this.easeInOutCubic(e),h=Math.max(0,c-.1*o.role);let u,p,d;if(r.returnToOrigin)if(h<.4){const t=h/.4,e=this.easeOutQuad(t);u=o.startX+(o.homeX-o.startX)*e,p=o.startY+(o.homeY-o.startY)*e}else if(h<.6+r.holdTime){const e=(h-.4)/(.2+r.holdTime);d=o.homeRadius+Math.sin(e*Math.PI*.5)*r.distance*l*t.scaleFactor}else{const e=(h-.6-r.holdTime)/(.4-r.holdTime);d=o.homeRadius+Math.cos(e*Math.PI*.5)*r.distance*l*t.scaleFactor}else{const e=h;d=o.homeRadius+e*r.distance*l*t.scaleFactor}if(void 0!==d){o.turbulencePhase+=r.turbulence*a;const t=Math.sin(o.turbulencePhase)*r.turbulence*10,e=Math.cos(1.3*o.turbulencePhase)*r.turbulence*10,i=o.driftAngle+o.angleOffset;u=n+Math.cos(i)*d+t,p=s+Math.sin(i)*d+e}const m=r.smoothness+.08*o.role;if(t.x+=(u-t.x)*m,t.y+=(p-t.y)*m,t.vx=.25*(u-t.x),t.vy=.25*(p-t.y),r.fadeOut){let i;i=e<.25?.3+e/.25*.7:e<.75?.7+.3*Math.sin((e-.25)*Math.PI/.5):4*(1-e),t.opacity=o.baseOpacity*i,void 0!==t.life&&(t.life=t.opacity)}e>=.99&&(t.vx=.1*o.originalVx,t.vy=.1*o.originalVy,r.fadeOut&&(t.opacity=o.baseOpacity,void 0!==t.life&&(t.life=o.baseOpacity)))},cleanup(t){if(t.gestureData?.drift){const e=t.gestureData.drift;t.vx=e.originalVx,t.vy=e.originalVy,t.opacity=e.baseOpacity,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.drift}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t),"3d":{evaluate(t,e){const i={...this.config,...e},a=e.strength||1,n=(i.angle||45)*Math.PI/180,s=i.returnToOrigin?t<.5?2*t:2*(1-t):t;return{position:[Math.cos(n)*s*.3*a,Math.sin(n)*s*.3*a,.15*Math.sin(t*Math.PI)*a],rotation:[0,10*s*a,0],scale:1+.03*Math.sin(t*Math.PI),glowIntensity:1-.1*s}}}},$={name:"flicker",emoji:"⚡",type:"blending",description:"Rapid opacity changes with motion jitter",config:{duration:800,flickerRate:15,frequency:6,minOpacity:.3,maxOpacity:1,jitterAmount:2,colorShift:!1,strobe:!1,pulseMode:!1,groupFlicker:.3,easing:"linear",strength:.7,particleMotion:{type:"flicker",strength:.7,frequency:6}},rhythm:{enabled:!0,syncMode:"subdivision",rateSync:{subdivision:"sixteenth",onBeat:30,offBeat:10,triplet:20,curve:"step"},opacitySync:{pattern:"HLMH",subdivision:"eighth",onAccent:.1,regular:.5},jitterSync:{onBeat:5,offBeat:1,accent:10,curve:"random"},strobeSync:{verse:!1,chorus:!0,drop:"intense",pattern:"XOXO"},dynamics:{forte:{flickerRate:25,jitterAmount:5,minOpacity:.1},piano:{flickerRate:8,jitterAmount:1,minOpacity:.5}}},initialize(t,e){t.gestureData||(t.gestureData={});const i={...this.config,...e},a=Math.random()<i.groupFlicker;t.gestureData.flicker={baseOpacity:t.opacity||t.life||1,baseColor:t.color,baseX:t.x,baseY:t.y,flickerTimer:0,lastFlicker:0,flickerState:!0,isGrouped:a,groupId:a?Math.floor(3*Math.random()):-1,phase:Math.random()*Math.PI*2,colorHue:0,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.flicker?.initialized||this.initialize(t,i);const o=t.gestureData.flicker,r={...this.config,...i},l=i.strength||1;let c;if(o.flickerTimer+=a*r.flickerRate,r.strobe)c=(o.flickerTimer+o.phase)%1<.5?1:r.minOpacity;else if(r.pulseMode){const t=o.flickerTimer+o.phase;c=r.minOpacity+(r.maxOpacity-r.minOpacity)*(.5*Math.sin(t)+.5)}else{if(o.flickerTimer-o.lastFlicker>1)if(o.lastFlicker=o.flickerTimer,o.isGrouped){const t=Math.floor(o.flickerTimer)%3;o.flickerState=t===o.groupId}else o.flickerState=Math.random()>.3;const e=o.flickerState?r.maxOpacity:r.minOpacity+.3*Math.random(),i=t.opacity/o.baseOpacity;c=i+.3*(e-i)}const h=o.baseOpacity*(1+(c-1)*l);if(t.opacity=Math.max(0,Math.min(1,h)),void 0!==t.life&&(t.life=t.opacity),r.jitterAmount>0&&c>r.minOpacity){const e=r.jitterAmount*l*t.scaleFactor,i=(Math.random()-.5)*e*c,n=(Math.random()-.5)*e*c;t.vx+=.1*i*a,t.vy+=.1*n*a}if(r.colorShift&&t.color){o.colorHue+=.01*a;const e=30*Math.sin(o.colorHue);t.color=this.shiftHue(o.baseColor,e*l)}let u=1;e<.1?u=e/.1:e>.9&&(u=(1-e)/.1),t.opacity*=u,void 0!==t.life&&(t.life=t.opacity),e>.8&&(t.vx*=.95,t.vy*=.95)},shiftHue(t,e){if(!t||!t.startsWith("#"))return t;const i=t.slice(1),a=parseInt(i.substr(0,2),16)/255,n=parseInt(i.substr(2,2),16)/255,s=parseInt(i.substr(4,2),16)/255,o=e*Math.PI/180,r=Math.cos(o),l=Math.sin(o),c=a*l+n*r,h=s,u=t=>Math.max(0,Math.min(255,Math.round(255*t))).toString(16).padStart(2,"0");return`#${u(a*r-n*l)}${u(c)}${u(h)}`},cleanup(t){if(t.gestureData?.flicker){const e=t.gestureData.flicker;t.opacity=e.baseOpacity,t.color=e.baseColor,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.flicker}},"3d":{evaluate(t,e){const i={...this.config,...e},a=e.strength||.7;let n;n=i.strobe?t*i.flickerRate%1<.5?1.5:.3:.5+(.5*Math.sin(t*i.frequency*Math.PI*2)+.5)*a;const s=.01*i.jitterAmount*a;return{position:[(Math.random()-.5)*s,(Math.random()-.5)*s,0],rotation:[0,0,0],scale:1,glowIntensity:n}}}},U={name:"burst",emoji:"💥",type:"blending",description:"Explosive outward burst from center",config:{decay:.5,strength:2},rhythm:{enabled:!0,syncMode:"beat",strengthSync:{onBeat:3.5,offBeat:1,curve:"explosion"},decaySync:{mode:"tempo",fast:.8,slow:.3,curve:"exponential"},durationSync:{mode:"beats",beats:.5,sustain:!1},accentResponse:{enabled:!0,multiplier:2.5,type:"strength"},patternOverrides:{rock:{strengthSync:{onBeat:4,offBeat:1.5},decaySync:{fast:.6,slow:.4}},electronic:{strengthSync:{onBeat:3.8,offBeat:.8,curve:"sharp"},decaySync:{fast:.9,slow:.7}},jazz:{strengthSync:{onBeat:2.8,offBeat:1.8,swing:!0},decaySync:{fast:.5,slow:.2}},orchestral:{strengthSync:{onBeat:3.2,offBeat:.5},accentResponse:{multiplier:3}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:2},offBeat:{multiplier:1.5}},decaySync:{multiplier:.7},accentResponse:{multiplier:3.5}},piano:{strengthSync:{onBeat:{multiplier:.6},offBeat:{multiplier:.3}},decaySync:{multiplier:1.3},accentResponse:{multiplier:1.8}}}},apply(t,e,i,a,n,s){const o=i.decay||this.config.decay,r=(i.strength||this.config.strength)*(1-e*o),l=t.x-n,c=t.y-s,h=Math.sqrt(l*l+c*c);h>1&&(t.vx+=l/h*r*2*a,t.vy+=c/h*r*2*a)},"3d":{evaluate(t,e){const i={...this.config,...e}.decay||.5,a=(e.strength||2)*(1-t*i);return{position:[0,0,0],rotation:[0,0,0],scale:1+(t<.2?5*t:1.5*(1-t))*a,glowIntensity:1+(t<.3?10*(.3-t):0)*a}}}},W={name:"directional",emoji:"➡️",type:"blending",description:"Move particles in a specific direction",config:{angle:0,returnToOrigin:!1,strength:1},rhythm:{enabled:!0,syncMode:"flow",angleSync:{verse:0,chorus:90,bridge:180,outro:270,transition:"smooth"},strengthSync:{onBeat:1.8,offBeat:.6,curve:"wave"},returnSync:{enabled:!0,onSectionChange:!0,duration:"transition",strength:1.2},accentResponse:{enabled:!0,multiplier:2,type:"strength"},patternOverrides:{march:{angleSync:{verse:0,chorus:0},strengthSync:{onBeat:2.5,offBeat:1}},waltz:{angleSync:{verse:45,chorus:135,bridge:225,outro:315,transition:"circular"}},swing:{strengthSync:{onBeat:1.6,offBeat:1.4,swing:!0}},electronic:{angleSync:{transition:"instant"},strengthSync:{onBeat:2.2,offBeat:.4,curve:"sharp"}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:1.6},offBeat:{multiplier:1.2}},angleSync:{transition:"sharp"},accentResponse:{multiplier:2.5}},piano:{strengthSync:{onBeat:{multiplier:.7},offBeat:{multiplier:.8}},angleSync:{transition:"gradual"},accentResponse:{multiplier:1.4}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.directional={initialX:t.x,initialY:t.y}},apply(t,e,i,a,n,s){t.gestureData?.directional||this.initialize(t);const o=(i.angle||this.config.angle)*Math.PI/180,r=i.strength||this.config.strength;if(t.vx+=Math.cos(o)*r*.3*a,t.vy+=Math.sin(o)*r*.3*a,i.returnToOrigin&&e>.5){const i=2*(e-.5),n=t.gestureData.directional,s=n.initialX-t.x,o=n.initialY-t.y;t.vx+=s*i*.02*a,t.vy+=o*i*.02*a}},"3d":{evaluate(t,e){const i={...this.config,...e},a=(i.angle||0)*Math.PI/180,n=e.strength||1,s=i.returnToOrigin?t<.5?2*t:2*(1-t):t;return{position:[Math.cos(a)*s*.4*n,Math.sin(a)*s*.4*n,0],rotation:[0,0,0],scale:1,glowIntensity:1}}}},Q={name:"settle",emoji:"🍃",type:"blending",description:"Gradually settle particles to rest",config:{damping:.02,threshold:.01},rhythm:{enabled:!0,syncMode:"resolution",dampingSync:{onResolution:.035,onTension:.015,curve:"gradual"},thresholdSync:{mode:"dynamics",forte:.02,piano:.005,curve:"exponential"},durationSync:{mode:"phrase",minBeats:2,maxBeats:12,sustain:!0},cadenceResponse:{enabled:!0,multiplier:1.6,type:"damping"},patternOverrides:{ambient:{dampingSync:{onResolution:.025,onTension:.008,curve:"atmospheric"},durationSync:{minBeats:8,maxBeats:32}},jazz:{dampingSync:{onResolution:.04,onTension:.02},cadenceResponse:{multiplier:1.8}},classical:{dampingSync:{onResolution:.045,onTension:.012,curve:"expressive"},cadenceResponse:{multiplier:2}},minimalist:{dampingSync:{onResolution:.02,onTension:.005},durationSync:{minBeats:16,maxBeats:64}}},dynamics:{forte:{dampingSync:{onResolution:{multiplier:1.4},onTension:{multiplier:.8}},thresholdSync:{multiplier:2},cadenceResponse:{multiplier:2.2}},piano:{dampingSync:{onResolution:{multiplier:.7},onTension:{multiplier:1.2}},thresholdSync:{multiplier:.5},cadenceResponse:{multiplier:1.3}}}},apply(t,e,i,a,n,s){const o=i.damping||this.config.damping,r=i.threshold||this.config.threshold;t.vx*=Math.max(0,1-o*a*60),t.vy*=Math.max(0,1-o*a*60),Math.abs(t.vx)<r&&(t.vx=0),Math.abs(t.vy)<r&&(t.vy=0)},"3d":{evaluate(t,e){const i=1-t;return{position:[.1*i,.1*i,0],rotation:[0,0,0],scale:1-.05*t,glowIntensity:1-.2*t}}}},N={name:"fade",emoji:"👻",type:"blending",description:"Fade particle opacity",config:{fadeIn:!1,fadeOut:!0,minOpacity:0,maxOpacity:1},rhythm:{enabled:!0,syncMode:"dynamic",opacitySync:{onBeat:.9,offBeat:.3,subdivision:"eighth",curve:"exponential"},fadePhaseSync:{verse:{fadeIn:!0,fadeOut:!1},chorus:{fadeIn:!1,fadeOut:!1},bridge:{fadeIn:!0,fadeOut:!0},outro:{fadeIn:!1,fadeOut:!0}},pulseSync:{enabled:!0,frequency:"quarter",intensity:.2,onAccent:.4},dynamics:{forte:{minOpacity:.5,maxOpacity:1},piano:{minOpacity:0,maxOpacity:.4}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.fade={baseOpacity:t.opacity||t.life||1}},apply(t,e,i,a,n,s){t.gestureData?.fade||this.initialize(t);const o=t.gestureData.fade,r={...this.config,...i};let l;l=r.fadeIn&&!r.fadeOut?r.minOpacity+(r.maxOpacity-r.minOpacity)*e:r.fadeOut&&!r.fadeIn?r.maxOpacity-(r.maxOpacity-r.minOpacity)*e:e<.5?r.minOpacity+(r.maxOpacity-r.minOpacity)*(2*e):r.maxOpacity-(r.maxOpacity-r.minOpacity)*(2*(e-.5)),t.opacity=o.baseOpacity*l,void 0!==t.life&&(t.life=t.opacity)},cleanup(t){t.gestureData?.fade&&(t.opacity=t.gestureData.fade.baseOpacity,void 0!==t.life&&(t.life=t.opacity),delete t.gestureData.fade)},"3d":{evaluate(t,e){const i={...this.config,...e};let a;return a=i.fadeIn&&!i.fadeOut?i.minOpacity+(i.maxOpacity-i.minOpacity)*t:i.fadeOut&&!i.fadeIn?i.maxOpacity-(i.maxOpacity-i.minOpacity)*t:t<.5?i.minOpacity+(i.maxOpacity-i.minOpacity)*(2*t):i.maxOpacity-(i.maxOpacity-i.minOpacity)*(2*(t-.5)),{position:[0,0,0],rotation:[0,0,0],scale:1,glowIntensity:a}}}},J={name:"hold",emoji:"⏸️",type:"override",description:"Hold particles in current position",config:{holdStrength:.95,allowDrift:!1},rhythm:{enabled:!0,syncMode:"rest",holdSync:{onRest:.98,onSound:.8,curve:"immediate"},durationSync:{mode:"rests",minBeats:.5,maxBeats:8,sustain:!0},pauseResponse:{enabled:!0,multiplier:1.5,type:"strength"},patternOverrides:{classical:{holdSync:{onRest:.99,onSound:.75,curve:"dramatic"},pauseResponse:{multiplier:2}},minimal:{holdSync:{onRest:.95,onSound:.85},durationSync:{minBeats:2,maxBeats:16}},jazz:{holdSync:{onRest:.9,onSound:.7},allowDrift:!0},electronic:{holdSync:{onRest:.99,onSound:.6,curve:"digital"},pauseResponse:{multiplier:1.2}}},dynamics:{forte:{holdSync:{onRest:{multiplier:1.02},onSound:{multiplier:.9}},pauseResponse:{multiplier:2.2}},piano:{holdSync:{onRest:{multiplier:.97},onSound:{multiplier:.85}},pauseResponse:{multiplier:1.3}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.hold={holdX:t.x,holdY:t.y,originalVx:t.vx,originalVy:t.vy}},apply(t,e,i,a,n,s){t.gestureData?.hold||this.initialize(t);const o=t.gestureData.hold,r=i.holdStrength||this.config.holdStrength;if(i.allowDrift?(t.vx*=r,t.vy*=r):(t.x+=(o.holdX-t.x)*(1-r),t.y+=(o.holdY-t.y)*(1-r),t.vx=0,t.vy=0),e>.9){const i=10*(e-.9);t.vx=t.vx*(1-i)+o.originalVx*i,t.vy=t.vy*(1-i)+o.originalVy*i}},cleanup(t){if(t.gestureData?.hold){const e=t.gestureData.hold;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.hold}},"3d":{evaluate:(t,e)=>({position:[0,0,0],rotation:[0,0,0],scale:1,glowIntensity:1})}},Z={name:"breathe",emoji:"🫁",type:"blending",description:"Breathing rhythm with inhale and exhale",config:{musicalDuration:{musical:!0,bars:1,minBeats:2,maxBeats:16},phases:[{name:"inhale",beats:1.5},{name:"hold_in",beats:.5},{name:"exhale",beats:1.5},{name:"hold_out",beats:.5}],inhaleRadius:1.5,exhaleRadius:.3,breathRate:.3,spiralStrength:.002,scaleAmount:.25,glowAmount:.4,frequency:1,easing:"sine",strength:.8,particleMotion:{type:"breathe",strength:.8,inhaleRadius:1.5,exhaleRadius:.3}},rhythm:{enabled:!0,syncMode:"phrase",breathRateSync:{mode:"tempo",bpm:"auto",subdivision:"whole",curve:"sine"},radiusSync:{inhale:{onUpbeat:1.8,onDownbeat:1.4,curve:"ease-in"},exhale:{onUpbeat:.2,onDownbeat:.4,curve:"ease-out"}},durationSync:{mode:"phrases",phrases:2,hold:"fermata"},accentResponse:{enabled:!0,multiplier:1.5,type:"expansion"},patternOverrides:{ballad:{breathRateSync:{subdivision:"double-whole"},radiusSync:{inhale:{onUpbeat:2.2,onDownbeat:1.8},exhale:{onUpbeat:.1,onDownbeat:.2}}},uptempo:{breathRateSync:{subdivision:"half"},radiusSync:{inhale:{onUpbeat:1.4,onDownbeat:1.2},exhale:{onUpbeat:.3,onDownbeat:.4}}},ambient:{breathRateSync:{subdivision:"whole",curve:"ease"},radiusSync:{inhale:{onUpbeat:1.6,onDownbeat:1.6},exhale:{onUpbeat:.2,onDownbeat:.2}}}},dynamics:{forte:{radiusSync:{inhale:{multiplier:1.8},exhale:{multiplier:.5}},spiralStrength:.004,scaleAmount:.4},piano:{radiusSync:{inhale:{multiplier:1.2},exhale:{multiplier:.8}},spiralStrength:.001,scaleAmount:.1}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;t.gestureData.breathe={startX:t.x,startY:t.y,angle:Math.atan2(s,n),baseRadius:Math.sqrt(n*n+s*s),phaseOffset:.2*Math.random()-.1}},apply(t,e,i,a,n,s){t.gestureData?.breathe||this.initialize(t,i,n,s);const o={...this.config,...i},r=(Math.sin(e*Math.PI*2*o.breathRate)+1)/2,l=100*(t.scaleFactor||1),c=o.inhaleRadius*l,h=o.exhaleRadius*l,u=h+(c-h)*r,p=t.x-n,d=t.y-s,m=Math.sqrt(p*p+d*d),g=u-m,y=.05*(i.strength||.8)*a;if(m>0){const e=p/m*g*y,n=d/m*g*y;t.vx+=e,t.vy+=n;const s=o.spiralStrength*a*(i.strength||1),l=-d/m,c=p/m;t.vx+=l*s*r,t.vy+=c*s*r}t.vx*=.98,t.vy*=.98},cleanup(t){t.gestureData?.breathe&&delete t.gestureData.breathe},"3d":{evaluate(t,e){const i={...this.config,...e},a=(Math.sin(t*Math.PI*2*i.breathRate)+1)/2;return{position:[0,0,0],rotation:[0,0,0],scale:1+(a-.5)*(i.scaleAmount||.25),glowIntensity:1+(a-.5)*(i.glowAmount||.4)}}}},K={name:"expand",emoji:"💫",type:"blending",description:"Radial expansion from center",config:{duration:600,scaleAmount:3,scaleTarget:3,glowAmount:.5,easing:"back",strength:3,particleMotion:{type:"pulse",strength:3,direction:"outward",persist:!0}},rhythm:{enabled:!0,syncMode:"crescendo",strengthSync:{pianissimo:1.5,fortissimo:5,crescendo:"build",sforzando:"burst"},scaleTargetSync:{verse:2,chorus:4.5,climax:6,curve:"exponential"},durationSync:{mode:"phrases",build:1.2,release:.8,sustain:"hold"},accentResponse:{enabled:!0,multiplier:2.8,type:"strength"},patternOverrides:{orchestral:{strengthSync:{pianissimo:2,fortissimo:6.5,crescendo:"dramatic"},scaleTargetSync:{climax:8}},rock:{strengthSync:{pianissimo:1.8,fortissimo:5.5,curve:"power"},accentResponse:{multiplier:3.2}},ambient:{strengthSync:{pianissimo:1.2,fortissimo:3.5,crescendo:"organic"},durationSync:{build:1.8,release:1.2}},electronic:{strengthSync:{pianissimo:1.6,fortissimo:4.8,curve:"digital"},scaleTargetSync:{curve:"linear"}}},dynamics:{forte:{strengthSync:{pianissimo:{multiplier:1.4},fortissimo:{multiplier:1.8}},scaleTargetSync:{multiplier:1.6},accentResponse:{multiplier:3.5}},piano:{strengthSync:{pianissimo:{multiplier:.8},fortissimo:{multiplier:1.2}},scaleTargetSync:{multiplier:.7},accentResponse:{multiplier:2}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;t.gestureData.expand={startX:t.x,startY:t.y,angle:Math.atan2(s,n),baseRadius:Math.sqrt(n*n+s*s),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.expand?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.expand,r={...this.config,...i},l=r.strength||1,c=1+(r.scaleTarget-1)*e*l,h=o.baseRadius*c,u=n+Math.cos(o.angle)*h,p=s+Math.sin(o.angle)*h,d=u-t.x,m=p-t.y;t.vx+=.8*d*a,t.vy+=.8*m*a,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.expand&&delete t.gestureData.expand},"3d":{evaluate(t,e){const i={...this.config,...e},a=i.strength||3;return{position:[0,0,0],rotation:[0,0,0],scale:1+t*(i.scaleAmount||3)*(a/3),glowIntensity:1+t*(i.glowAmount||.5)*a}}}},tt={name:"contract",emoji:"🌀",type:"blending",description:"Radial contraction toward center",config:{duration:600,scaleAmount:.2,scaleTarget:.2,glowAmount:-.2,easing:"cubic",strength:2.5,particleMotion:{type:"pulse",strength:2.5,direction:"inward",persist:!0}},rhythm:{enabled:!0,syncMode:"tension",strengthSync:{onTension:4,onRelease:1.5,curve:"magnetic"},scaleTargetSync:{forte:.1,piano:.4,crescendo:"gradual",diminuendo:"ease"},durationSync:{mode:"phrases",shortPhrase:.8,longPhrase:1.5,hold:"sustain"},accentResponse:{enabled:!0,multiplier:2.2,type:"strength"},patternOverrides:{classical:{strengthSync:{onTension:3.5,onRelease:1.8},scaleTargetSync:{forte:.15,piano:.35}},metal:{strengthSync:{onTension:5,onRelease:2,curve:"sharp"},scaleTargetSync:{forte:.05,piano:.25}},ambient:{strengthSync:{onTension:2.8,onRelease:1.2,curve:"ease"},durationSync:{shortPhrase:1.2,longPhrase:2}},trap:{strengthSync:{onTension:4.5,onRelease:1,dropBeat:6},scaleTargetSync:{forte:.08,piano:.3}}},dynamics:{forte:{strengthSync:{onTension:{multiplier:1.8},onRelease:{multiplier:1.4}},scaleTargetSync:{multiplier:.6},accentResponse:{multiplier:2.8}},piano:{strengthSync:{onTension:{multiplier:.7},onRelease:{multiplier:.8}},scaleTargetSync:{multiplier:1.4},accentResponse:{multiplier:1.6}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a;t.gestureData.contract={startX:t.x,startY:t.y,angle:Math.atan2(s,n),baseRadius:Math.sqrt(n*n+s*s),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.contract?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.contract,r={...this.config,...i},l=r.strength||1,c=1-(1-r.scaleTarget)*e*l,h=o.baseRadius*c,u=n+Math.cos(o.angle)*h,p=s+Math.sin(o.angle)*h,d=u-t.x,m=p-t.y;t.vx+=.5*d*a,t.vy+=.5*m*a,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.contract&&delete t.gestureData.contract},"3d":{evaluate(t,e){const i={...this.config,...e},a=i.strength||2.5,n=i.scaleTarget||.2,s=1-t*(1-n)*(a/2.5),o=1+t*(i.glowAmount||-.2);return{position:[0,0,0],rotation:[0,0,0],scale:Math.max(n,s),glowIntensity:Math.max(.5,o)}}}},et={name:"flash",emoji:"⚡",type:"blending",description:"Bright flash burst effect",config:{duration:400,glowAmount:2.5,glowPeak:3,scalePeak:1.1,easing:"cubic",strength:1,particleMotion:{type:"burst",strength:1,decay:.3}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"immediate",interruptible:!0,priority:8,blendable:!0,intensitySync:{onBeat:3.5,offBeat:1,accent:5,subdivision:"quarter",curve:"exponential"},durationSync:{mode:"tempo",baseDuration:400,scaling:"inverse"},scaleSync:{onBeat:1.2,offBeat:1,accent:1.4,curve:"elastic"},strobeSync:{enabled:!1,pattern:"XXOX",subdivision:"sixteenth"},dynamics:{forte:{glowPeak:4,scalePeak:1.3,duration:300},piano:{glowPeak:2,scalePeak:1.05,duration:500}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.flash={originalOpacity:t.opacity,originalSize:t.size,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.flash?.initialized||this.initialize(t,i);const o=t.gestureData.flash,r={...this.config,...i},l=r.strength||1;let c;c=e<.3?e/.3*r.glowPeak:r.glowPeak*(1-(e-.3)/.7),t.opacity=Math.min(1,o.originalOpacity*(1+c*l)),t.size=o.originalSize*(1+(r.scalePeak-1)*c*l*.1)},cleanup(t){t.gestureData?.flash&&(t.opacity=t.gestureData.flash.originalOpacity,t.size=t.gestureData.flash.originalSize,delete t.gestureData.flash)},"3d":{evaluate(t,e){const i={...this.config,...e},a=e.strength||1;let n;return n=t<.3?1+t/.3*(i.glowPeak||3)*a:1+(1-(t-.3)/.7)*(i.glowPeak||3)*a,{position:[0,0,0],rotation:[0,0,0],scale:1+(t<.3?t/.3:(1-t)/.7)*((i.scalePeak||1.1)-1),glowIntensity:n}}}},it={name:"glow",emoji:"✨",type:"blending",description:"Pure luminous glow without movement",config:{duration:1500,amplitude:0,frequency:1,holdPeak:.3,easing:"sine",scaleAmount:.1,glowAmount:.8,strength:0,direction:"none",particleMotion:{type:"glow",strength:0,direction:"none",frequency:1}},rhythm:{enabled:!0,syncMode:"phrase",amplitudeSync:{onBeat:2,offBeat:1.2,curve:"smooth"},frequencySync:{mode:"phrase",subdivision:"bar"},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:2.5},patternOverrides:{ambient:{amplitudeSync:{onBeat:2.5,offBeat:1.8},durationSync:{bars:4}},electronic:{amplitudeSync:{onBeat:3,offBeat:.5,curve:"sharp"},frequencySync:{subdivision:"quarter"}}}},initialize(t,e,i,a){t.gestureData||(t.gestureData={}),t.gestureData.glow={startOpacity:t.opacity,startGlow:t.glowSizeMultiplier||0,initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.glow?.initialized||this.initialize(t,i,n,s);const o={...this.config,...i},r=this.easeInOutSine(e);let l,{frequency:c}=o,{glowAmount:h}=o;i.rhythmModulation&&(h*=i.rhythmModulation.amplitudeMultiplier||1,h*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(c*=i.rhythmModulation.frequencyMultiplier));const u=r*c*2%2;l=o.holdPeak>0&&u>1-o.holdPeak&&u<1+o.holdPeak?1:Math.sin(r*Math.PI*2*c);let p=1;e>.9&&(p=.5+.5*(1-10*(e-.9))),t.glowIntensity=1+l*h*p},cleanup(t){t.gestureData?.glow&&(t.glowIntensity=1,delete t.gestureData.glow)},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2,"3d":{evaluate(t,e){const i={...this.config,...e},a=-(Math.cos(Math.PI*t)-1)/2;let n;const s=i.frequency||1;let o=i.glowAmount||.8;e.rhythmModulation&&(o*=e.rhythmModulation.amplitudeMultiplier||1,o*=e.rhythmModulation.accentMultiplier||1);const r=a*s*2%2,l=i.holdPeak||.3;n=l>0&&r>1-l&&r<1+l?1:Math.sin(a*Math.PI*2*s);const c=1+n*o;return{position:[0,0,0],rotation:[0,0,0],scale:1+n*(i.scaleAmount||.1)*.5,glowIntensity:c}}}},at={name:"peek",emoji:"👀",type:"effect",description:"Quick peek and hide motion",config:{peekDistance:40,peekSpeed:.15,holdDuration:200,hideSpeed:.25,stagger:!0,duration:1500},rhythm:{enabled:!0,syncMode:"accent",distanceSync:{onAccent:60,offAccent:25,curve:"quick"},speedSync:{mode:"tempo",fast:.25,slow:.1,hideMultiplier:1.8},durationSync:{mode:"subdivision",beats:.25,staggerBeats:.125,sustain:!1},syncopationResponse:{enabled:!0,multiplier:1.8,type:"distance"},patternOverrides:{funk:{distanceSync:{onAccent:70,offAccent:35,curve:"funky"},syncopationResponse:{multiplier:2.2}},latin:{speedSync:{fast:.3,slow:.12},durationSync:{beats:.5,staggerBeats:.25}},breakbeat:{distanceSync:{onAccent:55,offAccent:40},syncopationResponse:{multiplier:2.5}},classical:{distanceSync:{onAccent:45,offAccent:20,curve:"elegant"},speedSync:{fast:.18,slow:.08}}},dynamics:{forte:{distanceSync:{onAccent:{multiplier:1.6},offAccent:{multiplier:1.3}},speedSync:{multiplier:1.4},syncopationResponse:{multiplier:2.8}},piano:{distanceSync:{onAccent:{multiplier:.6},offAccent:{multiplier:.4}},speedSync:{multiplier:.7},syncopationResponse:{multiplier:1.2}}}},apply(t,e,i,a,n,s){if(t.gestureData||(t.gestureData={}),!t.gestureData.peek){const e=t.x-n,i=t.y-s,a=Math.atan2(i,e),o=Math.sqrt(e*e+i*i);t.gestureData.peek={originalX:t.x,originalY:t.y,peekAngle:a,originalDistance:o,staggerDelay:this.config.stagger?.3*Math.random():0,phase:"waiting",phaseTimer:0,peekOffset:{x:0,y:0}}}const o=t.gestureData.peek,{config:r}=this,l=Math.max(0,Math.min(1,(e-o.staggerDelay)/(1-o.staggerDelay)));0===l?o.phase="waiting":l<.3?o.phase="peeking":l<.6?o.phase="holding":l<1&&(o.phase="hiding");let c=0;switch(o.phase){case"peeking":{const t=l/.3;c=this.easeOutCubic(t)*r.peekDistance;break}case"holding":c=r.peekDistance,Math.random()<.1&&(o.peekOffset.x+=2*(Math.random()-.5),o.peekOffset.y+=2*(Math.random()-.5));break;case"hiding":{const t=(l-.6)/.4;c=(1-this.easeInCubic(t))*r.peekDistance;break}}if("waiting"!==o.phase){const e=Math.cos(o.peekAngle)*c,i=Math.sin(o.peekAngle)*c;o.peekOffset.x+=(e-o.peekOffset.x)*r.peekSpeed,o.peekOffset.y+=(i-o.peekOffset.y)*r.peekSpeed,t.x=o.originalX+o.peekOffset.x,t.y=o.originalY+o.peekOffset.y}void 0!==t.alpha&&("peeking"===o.phase||"holding"===o.phase?t.alpha=.7+.3*Math.random():t.alpha=1)},easeOutCubic:t=>1-Math.pow(1-t,3),easeInCubic:t=>t*t*t,cleanup(t){t.gestureData?.peek&&(t.x=t.gestureData.peek.originalX,t.y=t.gestureData.peek.originalY,void 0!==t.alpha&&(t.alpha=1),delete t.gestureData.peek)},"3d":{evaluate(t,e){const i=.01*({...this.config,...e}.peekDistance||40);let a=0,n=1;if(t<.3){const e=t/.3;a=(1-Math.pow(1-e,3))*i}else if(t<.6)a=i,n=.7+.3*Math.random();else{const e=(t-.6)/.4;a=(1-Math.pow(e,3))*i}return{position:[a,0,0],rotation:[0,0,0],scale:1,glowIntensity:n}}}},nt={name:"runningman",emoji:"🏃",type:"effect",description:"Hip-hop running man shuffle",config:{duration:2e3,slideDistance:30,stepHeight:15,speed:1.2,strength:.8,particleMotion:{type:"runningman",strength:.7}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:1,accentBeats:[1,3]},apply:(t,e,i,a,n,s)=>!1,blend:(t,e,i)=>!1,"3d":{evaluate(t,e){const i={...this.config,...e},a=i.speed||1.2,n=i.strength||.8,s=15*Math.sin(t*Math.PI*4*a)*n,o=.01*(i.stepHeight||15),r=Math.abs(Math.sin(t*Math.PI*8*a))*o*n,l=.01*(i.slideDistance||30);return{position:[Math.sin(t*Math.PI*2*a)*l*n,r,0],rotation:[0,s,0],scale:1,glowIntensity:1+.2*Math.sin(t*Math.PI*8*a)}}}},st={name:"charleston",emoji:"🕺",type:"effect",description:"Hip-hop Charleston shuffle with crisscross",config:{duration:2500,kickDistance:35,swivelRange:40,bounceHeight:12,strength:.9,particleMotion:{type:"charleston",strength:.8}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:2,accentBeats:[1,2.5,3,4.5]},apply:(t,e,i,a,n,s)=>!1,blend:(t,e,i)=>!1,"3d":{evaluate(t,e){const i={...this.config,...e},a=i.strength||.9,n=8*t,s=.01*(i.kickDistance||35),o=20*Math.sin(n*Math.PI)*a,r=Math.sin(n*Math.PI)*s*a,l=.5*(i.swivelRange||40),c=Math.sin(n*Math.PI*2)*l*a,h=.01*(i.bounceHeight||12);return{position:[0,Math.abs(Math.sin(n*Math.PI*2))*h*a,r],rotation:[o,0,c],scale:1,glowIntensity:1+.3*Math.sin(n*Math.PI*2)}}}},ot={name:"sparkle",emoji:"✨",type:"override",description:"Twinkling star effect with rapid shimmer",config:{musicalDuration:{musical:!0,beats:2,minBeats:1,maxBeats:8},sparkleFrequency:8,minScale:.5,maxScale:1.8,minOpacity:.3,maxOpacity:1,randomOffset:.5,expansionRadius:15,strength:1},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},initialize(t,e,i,a){t.gestureData||(t.gestureData={}),t.gestureData.sparkle={baseOpacity:t.opacity||t.life||1,baseScale:t.scale||1,phaseOffset:Math.random()*Math.PI*2,twinkleSpeed:.8+.4*Math.random(),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.sparkle?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.sparkle,r={...this.config,...i},l=i.strength||1,c=(e*r.sparkleFrequency*o.twinkleSpeed+o.phaseOffset)%(2*Math.PI),h=Math.sin(c),u=r.maxScale-r.minScale,p=r.minScale+(.5*h+.5)*u*l;t.scale=o.baseScale*p;const d=c+.3*Math.PI,m=Math.sin(d),g=r.maxOpacity-r.minOpacity,y=r.minOpacity+(.5*m+.5)*g;if(t.opacity=o.baseOpacity*y,void 0!==t.life&&(t.life=t.opacity),e>=.95){const i=20*(1-e);t.opacity=o.baseOpacity*i+t.opacity*(1-i),t.scale=o.baseScale*i+t.scale*(1-i),void 0!==t.life&&(t.life=t.opacity)}},cleanup(t){if(t.gestureData?.sparkle){const e=t.gestureData.sparkle;t.opacity=e.baseOpacity,t.scale=e.baseScale,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.sparkle}},"3d":{evaluate:(t,e)=>({position:[0,0,0],rotation:[0,0,0],scale:1})}},rt={name:"shimmer",emoji:"🌟",type:"particle",description:"Shimmer effect with sparkling particles",config:{duration:2e3,musicalDuration:{musical:!0,bars:1},particleMotion:"radiant",waveFrequency:3,shimmerSpeed:10,minOpacity:.4,maxOpacity:1,waveAmplitude:.6,strength:1},rhythm:{enabled:!0,syncType:"beat",durationSync:{mode:"bars",bars:1},intensity:.8},initialize(t,e,i,a){t.gestureData||(t.gestureData={});const n=t.x-i,s=t.y-a,o=Math.sqrt(n*n+s*s);t.gestureData.shimmer={baseOpacity:t.opacity||t.life||1,baseScale:t.scale||1,distance:o,phaseOffset:Math.random()*Math.PI*2,waveOffset:.02*o,shimmerSpeed:.8+.4*Math.random(),initialized:!0}},override(t,e,i,a,n,s){t.gestureData?.shimmer?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.shimmer,r={...this.config,...i},l=i.strength||1,c=(e*r.waveFrequency+o.waveOffset)*Math.PI*2,h=.5*Math.sin(c)+.5,u=(e*r.shimmerSpeed*o.shimmerSpeed+o.phaseOffset)*Math.PI*2,p=.5*Math.sin(u)+.5,d=h*r.waveAmplitude+p*(1-r.waveAmplitude),m=r.maxOpacity-r.minOpacity;return t.opacity=o.baseOpacity*(r.minOpacity+d*m*l),void 0!==t.life&&(t.life=t.opacity),t.scale=o.baseScale*(.9+.2*d*l),t.shimmerEffect=!0,t.shimmerProgress=e,!0},blend:(t,e,i)=>!1,cleanup(t){if(t.gestureData?.shimmer){const e=t.gestureData.shimmer;t.opacity=e.baseOpacity,t.scale=e.baseScale,void 0!==t.life&&(t.life=e.baseOpacity),t.shimmerEffect=!1,delete t.gestureData.shimmer}},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=Math.sin(t*Math.PI*2*3);return{position:[0,0,0],rotation:[0,t*Math.PI*2*.3*i,0],scale:1+.1*(.5*a+.5)*i,glowIntensity:1+.8*(.5*a+.5)*i}}}},lt={name:"rain",emoji:"🌧️",type:"particle",description:"Rain effect with falling particles",config:{duration:3e3,musicalDuration:{musical:!0,bars:2},particleMotion:"falling",fallSpeed:80,fallVariation:.4,horizontalDrift:15,fadeStart:.3,minOpacity:.2,strength:1},rhythm:{enabled:!0,syncType:"off-beat",durationSync:{mode:"bars",bars:2},intensity:.8},initialize(t,e,i,a){t.gestureData||(t.gestureData={}),t.gestureData.rain={startY:t.y,baseOpacity:t.opacity||t.life||1,fallSpeedMultiplier:.8+.4*Math.random(),driftDirection:Math.random()<.5?1:-1,driftSpeed:.5*Math.random(),initialized:!0}},apply(t,e,i,a,n,s){t.gestureData?.rain?.initialized||this.initialize(t,i,n,s);const o=t.gestureData.rain,r={...this.config,...i},l=i.strength||1,c=r.fallSpeed*o.fallSpeedMultiplier*l;t.vy+=.05*c*a;const h=r.horizontalDrift*o.driftDirection*o.driftSpeed*l;if(t.vx+=.02*h*a,e>=r.fadeStart){const i=(e-r.fadeStart)/(1-r.fadeStart),a=o.baseOpacity*(1-i*(1-r.minOpacity));t.opacity=Math.max(r.minOpacity,a),void 0!==t.life&&(t.life=t.opacity)}return t.rainEffect=!0,t.rainProgress=e,!0},blend:(t,e,i)=>!1,cleanup(t){if(t.gestureData?.rain){const e=t.gestureData.rain;t.opacity=e.baseOpacity,void 0!==t.life&&(t.life=e.baseOpacity),t.rainEffect=!1,delete t.gestureData.rain}},"3d":{evaluate(t,e){const i=e&&e.strength||1,a=.6*-t*i;return{position:[.1*Math.sin(t*Math.PI*2)*i,a,0],rotation:[.2*t*i,0,0],scale:1}}}};const ct=[v,b,w,x,S,P,D,I,z,B,C,F,O,A,T,k],ht=[R,E,q,j,G,V,Y,_,X],ut=[L,H,$,U,W,Q,N,J,Z,K,tt,et,it,at,nt,st,ot,rt,lt],pt={};function dt(t){if(pt[t])return pt[t];return M(t)||null}[...ct,...ht,...ut].forEach(t=>{pt[t.name]=t}),ct.map(t=>t.name),ht.map(t=>t.name),ut.map(t=>t.name);class mt{constructor(e,i={}){this.canvas=e,this.options=i,this.renderer=new t(e),this.geometryType=i.geometry||"sphere",this.geometry=n[this.geometryType],this.geometry||(console.warn(`Unknown geometry: ${this.geometryType}, falling back to sphere`),this.geometry=n.sphere),this.animator=new s,this.emotion=i.emotion||"neutral",this.glowColor=[1,1,1],this.glowIntensity=1,this.rotation=[0,0,0],this.baseScale=.16,this.scale=.16,this.position=[0,0,0],this.setEmotion(this.emotion)}setEmotion(t){this.emotion=t;const e=d(t);e&&e.visual&&(e.visual.glowColor&&(this.glowColor=this.hexToRGB(e.visual.glowColor)),void 0!==e.visual.glowIntensity&&(this.glowIntensity=e.visual.glowIntensity)),this.animator.playEmotion(t,{onUpdate:t=>{void 0!==t.scale&&(this.scale=this.baseScale*t.scale),void 0!==t.glowIntensity&&(this.glowIntensity=t.glowIntensity),t.position&&(this.position=t.position),t.rotation&&(this.rotation=t.rotation)}})}playGesture(t){const e=dt(t);if(!e)return void console.warn(`Unknown gesture: ${t}`);const i={x:0,y:0,vx:0,vy:0,size:1,baseSize:1,opacity:1,scaleFactor:1,gestureData:{}},a=e.config||{},n=a.musicalDuration?.musical?500*(a.musicalDuration.beats||2):a.duration||800,s=this.animator.time,o={virtualParticle:i,gesture:e,duration:n,startTime:s,startPosition:[...this.position],startRotation:[...this.rotation],startScale:this.scale};this.animator.animations.push({duration:n,startTime:s,evaluate:n=>{i.x=0,i.y=0,i.vx=0,i.vy=0,i.size=1,i.opacity=1,i.z=0;const s=e["3d"]&&e["3d"].evaluate;let r=!1;if(e.apply){const s={...a};"orbit"===t?(e.apply(i,i.gestureData,s,n,s.strength||1,0,0),r=!0):(r=!1!==e.apply(i,n,s,1,0,0),r&&(i.x+=2*i.vx,i.y+=2*i.vy))}if(r||!s){const t=this.translate2DTo3D(i,n,e,o);if(s){const s={...a,particle:i,config:a,strength:a.strength||1},o=e["3d"].evaluate(n,s);return{position:t.position,rotation:o.rotation||t.rotation,scale:o.scale||t.scale,glowIntensity:o.glowIntensity||t.glowIntensity}}return t}{if(!s)return console.warn(`Gesture ${t} has no particle motion and no 3D section`),{position:[0,0,0],rotation:[0,0,0],scale:1};const o={...a,particle:i,config:a,strength:a.strength||1};return e["3d"].evaluate(n,o)}},callbacks:{onUpdate:t=>{t.position&&(this.position=t.position),t.rotation&&(this.rotation=t.rotation),void 0!==t.scale&&(this.scale=this.baseScale*t.scale),void 0!==t.glowIntensity&&(this.glowIntensity=t.glowIntensity)},onComplete:()=>{e.cleanup&&e.cleanup(i),this.position=[0,0,0],this.rotation=[0,0,0],this.scale=this.baseScale}}})}translate2DTo3D(t,e,i,a){const n={position:[0,0,0],rotation:[0,0,0],scale:1},s=i.name;if("bounce"===s)n.position[0]=0,n.position[1]=.02*t.vy,n.position[2]=0,n.scale=1+.005*Math.abs(t.vy);else if("pulse"===s){const e=Math.sqrt(t.x*t.x+t.y*t.y);n.position[0]=0,n.position[1]=0,n.position[2]=0,n.scale=1+.01*e}else if("shake"===s)n.position[0]=.05*t.x,n.position[1]=.05*t.y,n.position[2]=0,n.rotation[2]=.01*t.vx;else if("nod"===s)n.position[0]=0,n.position[1]=.05*t.y,n.position[2]=0,n.rotation[0]=.02*t.vy;else if("vibrate"===s)n.position[0]=.03*t.x,n.position[1]=.03*t.y,n.position[2]=0,n.rotation[2]=.005*t.vx;else if("orbit"===s)n.position[0]=.003*t.x,n.position[1]=.003*-t.y,n.position[2]=t.z||0;else if("twitch"===s)n.position[0]=.04*t.x,n.position[1]=.04*t.y,n.position[2]=0,n.rotation[0]=.01*t.vy,n.rotation[1]=.01*t.vx;else if("sway"===s)n.position[0]=.05*t.x,n.position[1]=.02*t.y,n.position[2]=0,n.rotation[2]=.008*t.x;else if("float"===s)n.position[0]=0,n.position[1]=.02*-t.vy,n.position[2]=.3*(t.size-1),n.scale=1+.2*(t.size-1);else if("jitter"===s)n.position[0]=.04*t.x,n.position[1]=.04*t.y,n.position[2]=0;else if("wiggle"===s)n.position[0]=.05*t.x,n.position[1]=0,n.position[2]=0;else if("spin"===s){const e=Math.atan2(t.y,t.x);n.position[0]=0,n.position[1]=0,n.position[2]=0,n.rotation[1]=e}else if("jump"===s)n.position[0]=.01*t.x,n.position[1]=.01*t.y,n.position[2]=0,n.scale=1+.3*(t.size-1);else if("morph"===s)n.position[0]=0,n.position[1]=0,n.position[2]=0,n.scale=t.size||1;else if("stretch"===s)n.position[0]=.01*t.x,n.position[1]=.01*t.y,n.position[2]=0,n.scale=1+.01*Math.abs(t.vy);else if("tilt"===s)n.position[0]=.03*t.x,n.position[1]=0,n.position[2]=0,n.rotation[2]=.015*t.x;else if("orbital"===s){const e=Math.atan2(t.y,t.x),i=Math.sqrt(t.x*t.x+t.y*t.y);n.position[0]=Math.cos(e)*i*.005,n.position[1]=Math.sin(e)*i*.005,n.position[2]=0,n.rotation[1]=e}else"hula"===s?(n.position[0]=.004*t.x,n.position[1]=.004*t.y,n.position[2]=0,n.rotation[1]=.5*Math.atan2(t.y,t.x)):"scan"===s?(n.position[0]=.03*t.x,n.position[1]=0,n.position[2]=0,n.rotation[1]=.01*t.x):"twist"===s?(n.position[0]=0,n.position[1]=0,n.position[2]=0,n.rotation[1]=e*Math.PI*2):(n.position[0]=.01*t.x,n.position[1]=.01*t.y,n.position[2]=0,1!==t.size&&(n.scale=t.size));return n}morphToShape(t){const e=n[t];e?this.animator.playMorph(this.geometry,e,{duration:1e3,onUpdate:t=>{this.geometry=t},onComplete:()=>{this.geometry=e,this.geometryType=t}}):console.warn(`Unknown shape: ${t}`)}render(t){this.animator.update(t),this.rotation[1]+=3e-4*t,this.renderer.render({geometry:this.geometry,position:this.position,rotation:this.rotation,scale:this.scale,glowColor:this.glowColor,glowIntensity:this.glowIntensity})}hexToRGB(t){return t=t.replace("#",""),[parseInt(t.substring(0,2),16)/255,parseInt(t.substring(2,4),16)/255,parseInt(t.substring(4,6),16)/255]}destroy(){this.renderer.destroy(),this.animator.stopAll()}}function gt(t){return 3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join("")),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}}const yt={intense:1.6,confident:1.3,nervous:1.15,clear:1,tired:.8,subdued:.5};function ft(t,e){if(!e||"clear"===e)return t;const i=yt[e.toLowerCase()];return i&&1!==i?function(t,e){const i=gt(t),a=function(t,e,i){t/=255,e/=255,i/=255;const a=Math.max(t,e,i),n=Math.min(t,e,i),s=(a+n)/2;let o,r;if(a===n)o=r=0;else{const l=a-n;switch(r=s>.5?l/(2-a-n):l/(a+n),a){case t:o=(e-i)/l+(e<i?6:0);break;case e:o=(i-t)/l+2;break;case i:o=(t-e)/l+4}o/=6}return{h:360*o,s:100*r,l:100*s}}(i.r,i.g,i.b);a.s=Math.max(0,Math.min(100,a.s*e));const n=function(t,e,i){t/=360,i/=100;const a=(t,e,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t);let n,s,o;if(0==(e/=100))n=s=o=i;else{const r=i<.5?i*(1+e):i+e-i*e,l=2*i-r;n=a(l,r,t+1/3),s=a(l,r,t),o=a(l,r,t-1/3)}return{r:Math.round(255*n),g:Math.round(255*s),b:Math.round(255*o)}}(a.h,a.s,a.l);return function(t,e,i){const a=t=>{const e=Math.round(Math.max(0,Math.min(255,t))).toString(16);return 1===e.length?`0${e}`:e};return`#${a(t)}${a(e)}${a(i)}`}(n.r,n.g,n.b)}(t,i):t}Object.fromEntries(Object.entries({neutral:"#B0B0B0",joy:"#FFD700",sadness:"#4169E1",anger:"#DC143C",fear:"#8B008B",surprise:"#FF8C00",disgust:"#9ACD32",love:"#FF69B4"}).map(([t,e])=>{const i=gt(e);return[t,`${i.r}, ${i.g}, ${i.b}`]}));const Mt=new class{constructor(){this.bpm=120,this.timeSignature=[4,4],this.isPlaying=!1,this.startTime=0,this.currentBeat=0,this.currentBar=0,this.beatProgress=0,this.barProgress=0,this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.lastBeatTime=0,this.nextBeatTime=0,this.listeners=new Map,this.beatCallbacks=new Set,this.barCallbacks=new Set,this.subdivisions={sixteenth:0,eighth:0,triplet:0,swing:0},this.audioSync=null,this.syncOffset=0,this.autoSync=!1,this.intensity=1,this.groove=0,this.humanize=.05,this.patterns=new Map,this.currentPattern=null,this.initializePatterns()}initializePatterns(){this.patterns.set("4/4",{name:"4/4",description:"Common time - 4 beats per bar",timeSignature:[4,4],groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("straight",{name:"straight",description:"Straight, even timing",groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("swing",{name:"swing",description:"Swing/shuffle timing",groove:.67,accents:[1,.3,.8,.3]}),this.patterns.set("3/4",{name:"3/4",description:"Waltz time - 3 beats per bar",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("waltz",{name:"waltz",description:"3/4 waltz timing",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("6/8",{name:"6/8",description:"Compound duple time",timeSignature:[6,8],accents:[1,.3,.3,.7,.3,.3]}),this.patterns.set("5/4",{name:"5/4",description:"Complex meter - 5 beats per bar",timeSignature:[5,4],accents:[1,.5,.6,.5,.7]}),this.patterns.set("7/8",{name:"7/8",description:"Irregular meter",timeSignature:[7,8],accents:[1,.5,.5,.7,.5,.5,.6]}),this.patterns.set("dubstep",{name:"dubstep",description:"Dubstep half-time feel",accents:[.2,.2,1,.2],subdivisions:{wobble:!0}}),this.patterns.set("breakbeat",{name:"breakbeat",description:"Broken beat pattern",accents:[1,.2,.7,.9,.2,.8,.4,.2]})}start(){this.isPlaying||(this.isPlaying=!0,this.isRunning=!0,this.startTime=performance.now(),this.lastBeatTime=this.startTime,this.nextBeatTime=this.startTime+this.beatDuration,this.currentBeat=0,this.currentBar=0,this.emit("start",{bpm:this.bpm,timeSignature:this.timeSignature,pattern:this.currentPattern}),this.update())}stop(){this.isPlaying&&(this.isPlaying=!1,this.emit("stop",{totalBeats:this.currentBeat,totalBars:this.currentBar}))}update(){if(!this.isPlaying)return;const t=(performance.now()-this.startTime)/this.beatDuration,e=Math.floor(t);this.beatProgress=t%1,e>this.currentBeat&&this.onBeat(e);const i=Math.floor(e/this.timeSignature[0]);i>this.currentBar&&this.onBar(i),this.currentBeat=e,this.currentBar=i,this.barProgress=e%this.timeSignature[0]/this.timeSignature[0],this.updateSubdivisions(),this.emit("update",this.getTimeInfo()),this.isPlaying&&requestAnimationFrame(()=>this.update())}onBeat(t){const e=t%this.timeSignature[0],i=this.getAccent(e),a=this.humanize*(Math.random()-.5)*this.beatDuration,n={beat:t,beatInBar:e,bar:this.currentBar,accent:i,intensity:this.intensity*i,humanTiming:a,timestamp:performance.now()};this.emit("beat",n),this.beatCallbacks.forEach(t=>t(n)),this.lastBeatTime=performance.now(),this.nextBeatTime=this.lastBeatTime+this.beatDuration}onBar(t){const e={bar:t,timeSignature:this.timeSignature,pattern:this.currentPattern,timestamp:performance.now()};this.emit("bar",e),this.barCallbacks.forEach(t=>t(e))}updateSubdivisions(){if(this.subdivisions.sixteenth=4*this.beatProgress%1,this.subdivisions.eighth=2*this.beatProgress%1,this.subdivisions.triplet=3*this.beatProgress%1,this.groove>0){const t=.5+.17*this.groove;this.subdivisions.eighth<.5?this.subdivisions.swing=this.subdivisions.eighth/t:this.subdivisions.swing=.5+(this.subdivisions.eighth-.5)/(1-t)}else this.subdivisions.swing=this.subdivisions.eighth}getAccent(t){if(this.currentPattern&&this.patterns.has(this.currentPattern)){const e=this.patterns.get(this.currentPattern);if(e.accents&&void 0!==e.accents[t])return e.accents[t]}return 0===t?1:2===t&&4===this.timeSignature[0]?.7:.5}getTimeInfo(){return{elapsed:performance.now()-this.startTime,beat:this.currentBeat,bar:this.currentBar,beatInBar:this.currentBeat%this.timeSignature[0],beatProgress:this.beatProgress,barProgress:this.barProgress,subdivisions:{...this.subdivisions},bpm:this.bpm,beatDuration:this.beatDuration,timeSignature:[...this.timeSignature],intensity:this.intensity,groove:this.groove,pattern:this.currentPattern,nextBeatIn:this.nextBeatTime-performance.now(),accent:this.getAccent(this.currentBeat%this.timeSignature[0])}}setBPM(t){this.bpm=Math.max(20,Math.min(360,t)),this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.emit("tempoChange",{bpm:this.bpm})}setTimeSignature(t,e){this.timeSignature=[t,e],this.barDuration=this.beatDuration*t,this.emit("timeSignatureChange",{timeSignature:this.timeSignature})}setPattern(t){if(!this.patterns.has(t))return;const e=this.patterns.get(t);this.currentPattern=t,e.timeSignature&&this.setTimeSignature(...e.timeSignature),void 0!==e.groove&&(this.groove=e.groove),this.emit("patternChange",{pattern:t})}onBeatCallback(t){return this.beatCallbacks.add(t),()=>this.beatCallbacks.delete(t)}onBarCallback(t){return this.barCallbacks.add(t),()=>this.barCallbacks.delete(t)}emit(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(t=>t(e))}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.has(t)&&this.listeners.get(t).delete(e)}}syncToAudio(t,e){this.audioSync={context:t,source:e}}getAdapter(){return{getTimeInfo:()=>this.getTimeInfo(),isOnBeat:(t=.1)=>this.beatProgress<t||this.beatProgress>1-t,isOnSubdivision:(t,e=.1)=>{const i=this.subdivisions[t]||0;return i<e||i>1-e},getBeatSync:(t=0,e=1,i="linear")=>{let a=this.beatProgress;switch(i){case"ease":a=.5-Math.cos(a*Math.PI)/2;break;case"bounce":a=Math.abs(Math.sin(a*Math.PI));break;case"pulse":a=Math.pow(Math.sin(a*Math.PI),2)}return t+(e-t)*a},getAccentedValue:(t,e=2)=>t*(1+(this.getAccent(this.currentBeat%this.timeSignature[0])-.5)*e),onBeat:t=>this.onBeatCallback(t),onBar:t=>this.onBarCallback(t),beatsToMs:t=>t*this.beatDuration,msToBeats:t=>t/this.beatDuration,isPlaying:()=>this.isPlaying,getBPM:()=>this.bpm,getPattern:()=>this.currentPattern}}},vt=new class{constructor(){this.enabled=!1,this.adapter=null,this.subsystemConfigs=new Map,this.activeModulations=new Map}initialize(){this.adapter=Mt.getAdapter(),this.enabled=!0,this.adapter.onBeat(this.handleBeat.bind(this)),this.adapter.onBar(this.handleBar.bind(this))}updateBPM(t){if(t>=60&&t<=220){if(window.rhythmManuallyStoppedForCurrentAudio)return;if(!Mt.isRunning)return this.start(t,"straight"),void(window.rhythmSyncVisualizer&&!window.rhythmSyncVisualizer.state.active&&window.rhythmSyncVisualizer.start());Mt.setBPM(t)}}registerConfig(t,e,i){if(!i.rhythm||!i.rhythm.enabled)return;const a=`${t}:${e}`;this.subsystemConfigs.set(a,{type:t,name:e,rhythmConfig:i.rhythm,originalConfig:i})}applyGestureRhythm(t,e,i,a){if(!this.enabled||!t.rhythm?.enabled)return{};const n=t.rhythm,s={};if(n.amplitudeSync){const t=n.amplitudeSync,e=this.adapter.getBeatSync(t.offBeat||.8,t.onBeat||1.5,t.curve||"linear");s.amplitudeMultiplier=e}if(n.wobbleSync){const t=n.wobbleSync;this.adapter.isOnSubdivision(t.subdivision,.1)?s.wobbleMultiplier=1+t.intensity:s.wobbleMultiplier=1}if(n.accentResponse?.enabled){const t=this.adapter.getAccentedValue(1,n.accentResponse.multiplier||1.5);s.accentMultiplier=t}const o=this.adapter.getPattern();return o&&n.patternOverrides?.[o]&&Object.assign(s,n.patternOverrides[o]),s}applyParticleRhythm(t,e){if(!this.enabled||!t.rhythm?.enabled)return{};const i=this.adapter.getTimeInfo(),a=t.rhythm,n={};if(a.particleEmission){const t=a.particleEmission;"beat"===t.syncMode&&this.adapter.isOnBeat(.1)?n.emitBurst=t.burstSize||3:void 0!==t.offBeatRate&&(n.emissionRate=t.offBeatRate)}if(a.glowSync){const t=a.glowSync,e=this.adapter.getBeatSync(t.intensityRange[0]||1,t.intensityRange[1]||2,"pulse");n.glowIntensity=e}if("bars"===a.breathSync?.mode){const t=a.breathSync,e=i.bar%t.barsPerBreath/t.barsPerBreath;n.breathPhase=e*Math.PI*2}return n}applyBehaviorRhythm(t,e,i){if(!this.enabled||!t.rhythm?.enabled)return{};const a=this.adapter.getTimeInfo(),n=t.rhythm,s={};if(n.glitchTiming){const t=n.glitchTiming;if(this.adapter.isOnSubdivision(t.subdivision,.05)&&Math.random()<t.probability){const e=this.adapter.isOnBeat()?t.intensityOnBeat:t.intensityOffBeat;s.triggerGlitch=!0,s.glitchIntensity=e}}if(n.orbitRhythm){const t=n.orbitRhythm;"tempo"===t.baseSpeed&&(s.speedMultiplier=this.adapter.getBPM()/120),t.beatAcceleration&&this.adapter.isOnBeat(.1)&&(s.speedBoost=t.beatAcceleration),t.barReset&&0===a.beatInBar&&(s.resetOrbit=!0)}if(n.stutterSync){const t=n.stutterSync,e=this.adapter.getPattern();if(e&&t.patterns?.[e]){const i=t.patterns[e];i.freezeOnDrop&&2===a.beatInBar?(s.freeze=!0,s.freezeDuration=i.dropDuration):i.randomFreeze&&Math.random()<i.randomFreeze&&(s.freeze=!0,s.freezeDuration=i.duration)}}return s}handleBeat(t){this.lastBeatInfo=t}handleBar(t){this.lastBarInfo=t}getMusicalDuration(t,e){if(!this.enabled||!t?.durationSync)return e;const i=t.durationSync;return"bars"===i.mode?this.adapter.beatsToMs(4*i.bars):"beats"===i.mode?this.adapter.beatsToMs(i.beats):e}isEnabled(){return this.enabled&&this.adapter.isPlaying()}start(t=120,e="straight"){t&&Mt.setBPM(t),e&&Mt.setPattern(e),Mt.start(),this.enabled=!0}stop(){Mt.stop(),this.enabled=!1,this.bpmLocked=!1,this.lockedBPM=null}setPattern(t){Mt.setPattern(t)}setBPM(t){Mt.setBPM(t),this.bpmLocked&&(this.lockedBPM=t)}resampleBPM(){this.bpmLocked=!1,this.lockedBPM=null}setTimeSignature(t){this.timeSignature=t;const e=document.getElementById("time-sig-display");e&&(e.textContent=t),"3/4"===t&&Mt.getPattern()}syncToAudio(t,e){Mt.syncToAudio(t,e)}},bt=new class{constructor(){this.emotionCache=new Map,this.visualParamsCache=new Map,this.modifiersCache=new Map,this.transitionCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const t=[...Array.from(u.keys()),...l()];t.forEach(t=>{this.cacheEmotion(t)}),this.cacheCommonTransitions(t),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.emotionCache.size}catch(t){console.error("[EmotionCache] Initialization failed:",t),this.isInitialized=!1}}cacheEmotion(t){try{const e=d(t);e&&this.emotionCache.set(t,e);const i=m(t);this.visualParamsCache.set(t,i);const a=g(t);this.modifiersCache.set(t,a)}catch(e){console.warn(`[EmotionCache] Failed to cache emotion '${t}':`,e)}}cacheCommonTransitions(t){[["neutral","joy"],["neutral","sadness"],["neutral","anger"],["joy","sadness"],["sadness","joy"],["anger","calm"],["calm","anger"]].forEach(([e,i])=>{if(t.includes(e)&&t.includes(i))try{const t=y(e,i),a=`${e}->${i}`;this.transitionCache.set(a,t)}catch(t){console.warn(`[EmotionCache] Failed to cache transition '${e}->${i}':`,t)}})}getEmotion(t){if(!this.isInitialized)return console.warn("[EmotionCache] Cache not initialized, falling back to direct access"),d(t);const e=this.emotionCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,console.warn(`[EmotionCache] Cache miss for emotion '${t}', consider adding to pre-cache`),d(t))}getVisualParams(t){if(!this.isInitialized)return m(t);const e=this.visualParamsCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,m(t))}getModifiers(t){if(!this.isInitialized)return g(t);const e=this.modifiersCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,g(t))}getTransitionParams(t,e){if(!this.isInitialized)return y(t,e);const i=`${t}->${e}`,a=this.transitionCache.get(i);return a?(this.stats.hits++,a):(this.stats.misses++,y(t,e))}hasEmotion(t){return this.emotionCache.has(t)}getStats(){const t=this.stats.hits+this.stats.misses,e=t>0?(this.stats.hits/t*100).toFixed(2):0;return{isInitialized:this.isInitialized,loadTime:this.stats.loadTime,cacheSize:this.stats.cacheSize,hits:this.stats.hits,misses:this.stats.misses,hitRate:`${e}%`,emotions:this.emotionCache.size,visualParams:this.visualParamsCache.size,modifiers:this.modifiersCache.size,transitions:this.transitionCache.size}}clear(){this.emotionCache.clear(),this.visualParamsCache.clear(),this.modifiersCache.clear(),this.transitionCache.clear(),this.isInitialized=!1,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0}}reinitialize(){this.clear(),this.initialize()}};function wt(t){if(!t||0===t.length)return"#FFFFFF";let e=0,i=0;const a=[];for(const n of t)"string"==typeof n?(a.push({color:n,weight:null}),i++):n&&"object"==typeof n&&n.color&&(a.push({color:n.color,weight:n.weight||null}),n.weight?e+=n.weight:i++);const n=Math.max(0,100-e),s=i>0?n/i:0,o=[];let r=0;for(const t of a)r+=null!==t.weight?t.weight:s,o.push({color:t.color,threshold:r});const l=Math.random()*r;for(const t of o)if(l<=t.threshold)return t.color;return a[a.length-1].color}var xt={name:"ambient",emoji:"☁️",description:"Gentle upward drift like smoke",initialize:function(t){t.vx=0,t.vy=-.04-.02*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={upwardSpeed:5e-4,waviness:0,friction:.998}},update:function(t,e,i,a){const n=t.behaviorData;t.vy*=Math.pow(n.friction,e),t.vy-=n.upwardSpeed*e,t.vx=0}};const St=2*Math.PI;var Pt={name:"orbiting",emoji:"💕",description:"Romantic firefly dance around the orb",initialize:function(t){t.lifeDecay=.001+.002*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.isSparkle="#FFE4E1"===t.color||"#FFCCCB"===t.color||"#FFC0CB"===t.color;const e=40*(t.scaleFactor||1)*(1.3+.9*Math.random());t.blinkPhase=Math.random()*St,t.blinkSpeed=.3+1.2*Math.random(),t.blinkIntensity=.6+.4*Math.random(),t.fadePhase=Math.random()*St,t.fadeSpeed=.1+.3*Math.random(),t.minOpacity=.2+.2*Math.random(),t.maxOpacity=.8+.2*Math.random(),t.isSparkle&&(t.blinkSpeed*=2,t.blinkIntensity=1,t.minOpacity=0,t.maxOpacity=1),t.behaviorData={angle:Math.random()*St,radius:e,baseRadius:e,angularVelocity:8e-4+.0017*Math.random(),swayAmount:3+7*Math.random(),swaySpeed:.2+.5*Math.random(),floatOffset:Math.random()*St,floatSpeed:.3+.7*Math.random(),floatAmount:2+6*Math.random(),twinklePhase:Math.random()*St,twinkleSpeed:2+3*Math.random()}},update:function(t,e,i,a){const n=t.behaviorData;n.angle+=n.angularVelocity*e;const s=Math.sin(n.angle*n.swaySpeed)*n.swayAmount,o=6*Math.sin(1.5*n.angle),r=(n.radius||n.baseRadius)+o+.2*s,l=i+Math.cos(n.angle)*r,c=a+Math.sin(n.angle)*r;n.floatOffset+=n.floatSpeed*e*.001;const h=Math.sin(n.floatOffset)*n.floatAmount;t.vx=.1*(l-t.x),t.vy=.1*(c+h-t.y),t.fadePhase+=t.fadeSpeed*e*.001;const u=.5*Math.sin(t.fadePhase)+.5,p=t.minOpacity+(t.maxOpacity-t.minOpacity)*u;let d;t.blinkPhase+=t.blinkSpeed*e*.002,t.isSparkle?(n.twinklePhase+=n.twinkleSpeed*e*.001,d=.7*Math.pow(Math.sin(n.twinklePhase),16)+.2*Math.sin(5*t.blinkPhase)+.1):d=.4*Math.sin(t.blinkPhase)+.3*Math.sin(3*t.blinkPhase)+.2*Math.sin(7*t.blinkPhase)+.1*Math.sin(11*t.blinkPhase);const m=.5*(d+1),g=.2+m*t.blinkIntensity*.8;t.opacity=t.baseOpacity*p*g,t.isSparkle?t.size=t.baseSize*(.5+1*m):t.size=t.baseSize*(.8+.3*m),t.isSparkle&&(t.tempColor=m>.85?"#FFFFFF":t.color)}},Dt={name:"rising",emoji:"🎈",description:"Buoyant upward movement like balloons",initialize:function(t){t.vx=.02*(Math.random()-.5),t.vy=-.05-.03*Math.random(),t.lifeDecay=.002,t.baseOpacity=.7+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={buoyancy:.001,driftAmount:.005}},update:function(t,e,i,a){const n=t.behaviorData;t.vy-=n.buoyancy*e,t.vx+=(Math.random()-.5)*n.driftAmount*e,t.vx*=Math.pow(.995,e),t.vy*=Math.pow(.998,e)}},It={name:"falling",emoji:"💧",description:"Heavy downward drift like tears",initialize:function(t){t.vx=.03*(Math.random()-.5),t.vy=.05+.05*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={gravity:.002,drag:.995}},update:function(t,e,i,a){const n=t.behaviorData;t.vy+=n.gravity*e,t.vx*=Math.pow(n.drag,e),t.vy*=Math.pow(n.drag,e),t.vy>2&&(t.vy=2)}};const zt=2e3,Bt=3,Ct=8,Ft=.7;var Ot={name:"popcorn",emoji:"🍿",description:"Spontaneous popping with gravity and bounces",initialize:function(t){if(t.vx=.1*(Math.random()-.5),t.vy=.1*(Math.random()-.5),t.lifeDecay=.008+.012*Math.random(),t.emotionColors&&t.emotionColors.length>0)t.color=wt(t.emotionColors);else{const e=["#FFFFFF","#FFFACD","#FFF8DC","#FFFFE0","#FAFAD2"];t.color=wt(e)}t.size=Math.random()<.3?(8+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier:(2+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier,t.baseSize=t.size,t.hasGlow=Math.random()<.2,t.glowSizeMultiplier=t.hasGlow?1.2:0,t.behaviorData={popDelay:Math.random()*zt,hasPopped:!1,popStrength:Bt+Math.random()*(Ct-Bt),gravity:.098,bounceDamping:Ft,bounceCount:0,maxBounces:2+Math.floor(2*Math.random()),spinRate:10*(Math.random()-.5),lifetime:0}},update:function(t,e,i,a){const n=t.behaviorData;if(n.lifetime+=16.67*e,!n.hasPopped&&n.lifetime>n.popDelay){n.hasPopped=!0;const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*n.popStrength*1.5,t.vy=Math.sin(e)*n.popStrength-.3,t.size=1.25*t.baseSize}if(n.hasPopped){t.vy+=n.gravity*e;const i=a+100*t.scaleFactor;t.y>i&&n.bounceCount<n.maxBounces&&(t.y=i,t.vy=-Math.abs(t.vy)*n.bounceDamping,t.vx*=.9,n.bounceCount++,t.size=t.baseSize*(1.5-.1*n.bounceCount)),n.bounceCount>=n.maxBounces&&(t.lifeDecay=.03+.02*Math.random(),t.size*=.95),Math.sqrt(t.vx*t.vx+t.vy*t.vy)<.5&&(t.lifeDecay*=1.5)}}},At={name:"burst",emoji:"💥",description:"Explosive expansion from center",initialize:function(t){const e="suspicion"===t.emotion,i="surprise"===t.emotion,a="glitch"===t.emotion,n=Math.random()*St,s=e?1+.8*Math.random():i?7+5*Math.random():a?2+1.5*Math.random():3.5+2.5*Math.random();t.vx=Math.cos(n)*s,t.vy=Math.sin(n)*s,t.lifeDecay=e?.01:i?.006+.008*Math.random():a?.012:.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),e&&(t.size=(6+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.opacity=1,t.baseOpacity=t.opacity),t.behaviorData={isSuspicion:e,isSurprise:i,isGlitch:a,age:0,fadeStart:e?.3:.2,glitchPhase:Math.random()*Math.PI*2,glitchIntensity:a?.3:0,glitchFrequency:a?.1:0}},update:function(t,e,i,a){const n=t.behaviorData;if(n.isSurprise)if(n.age+=.016*e,n.age<.15){const i=.98;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}else if(n.age<.25){const i=.85;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}else{const i=.99;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e),t.vx+=.01*(Math.random()-.5)*e,t.vy+=.01*(Math.random()-.5)*e}else{const i=n.isSuspicion?.99:n.isGlitch?.97:.95;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}if(n.isSuspicion){const i=.001*Date.now();t.vx+=.01*Math.sin(2*i+t.id)*e}if(n.isGlitch){n.age+=.016*e,n.glitchPhase+=n.glitchFrequency*e;const i=Math.sin(n.glitchPhase)*n.glitchIntensity*e,a=Math.cos(1.3*n.glitchPhase)*n.glitchIntensity*e;if(t.vx+=i,t.vy+=a,Math.random()<.02){const e=Math.random()*Math.PI*2,i=.5+.5*Math.random();t.vx+=Math.cos(e)*i,t.vy+=Math.sin(e)*i}}}},Tt={name:"aggressive",emoji:"⚡",description:"Sharp, chaotic movement with violent bursts",initialize:function(t){const e=Math.random()*St,i=1.5+2*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={acceleration:.05,jitter:.3,speedDecay:.95}},update:function(t,e,i,a){const n=t.behaviorData;if(t.vx+=(Math.random()-.5)*n.jitter*e,t.vy+=(Math.random()-.5)*n.jitter*e,t.vx*=Math.pow(n.speedDecay,e),t.vy*=Math.pow(n.speedDecay,e),Math.random()<Math.min(.05*e,.5)){const e=Math.random()*St;t.vx+=Math.cos(e)*n.acceleration,t.vy+=Math.sin(e)*n.acceleration}}},kt={name:"scattering",emoji:"😨",description:"Particles flee from center in panic",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.008,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={fleeSpeed:2,panicFactor:1.2,initialized:!1}},update:function(t,e,i,a){const n=t.behaviorData;if(!n.initialized){const e=t.x-i,s=t.y-a,o=Math.sqrt(e*e+s*s);if(o>0)t.vx=e/o*n.fleeSpeed,t.vy=s/o*n.fleeSpeed;else{const e=Math.random()*St;t.vx=Math.cos(e)*n.fleeSpeed,t.vy=Math.sin(e)*n.fleeSpeed}n.initialized=!0}const s=t.x-i,o=t.y-a,r=Math.sqrt(s*s+o*o);r>0&&(t.vx+=s/r*n.panicFactor*.01*e,t.vy+=o/r*n.panicFactor*.01*e),t.vx+=.1*(Math.random()-.5)*e,t.vy+=.1*(Math.random()-.5)*e,t.vx*=Math.pow(.98,e),t.vy*=Math.pow(.98,e)}},Rt={name:"repelling",emoji:"🚫",description:"Particles pushed away from center, maintaining distance",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.01,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={repelStrength:.8,minDistance:50,initialized:!1}},update:function(t,e,i,a){const n=t.behaviorData,s=t.x-i,o=t.y-a,r=Math.sqrt(s*s+o*o);if(!n.initialized||r<n.minDistance){if(r>0){const i=n.repelStrength/Math.max(r,5);t.vx+=s/r*i*e,t.vy+=o/r*i*e}n.initialized=!0}t.vx*=Math.pow(.99,e),t.vy*=Math.pow(.99,e)}},Et={name:"connecting",emoji:"🔗",description:"Chaotic movement with center attraction for social states",initialize:function(t){const e=Math.random()*St,i=2+5*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.012,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={attractionForce:.008,chaosFactor:1,friction:.95}},update:function(t,e,i,a){const n=t.behaviorData;t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e);const s=(i-t.x)*n.attractionForce,o=(a-t.y)*n.attractionForce,r=(Math.random()-.5)*n.chaosFactor,l=(Math.random()-.5)*n.chaosFactor;t.vx+=s+r,t.vy+=o+l}},qt={name:"resting",emoji:"😴",description:"Ultra-slow vertical drift for deep rest states",initialize:function(t){t.vx=0,t.vy=-.01,t.lifeDecay=.001,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={upwardSpeed:2e-5,friction:.999}},update:function(t,e,i,a){const n=t.behaviorData;t.vy*=Math.pow(n.friction,e),t.vy-=n.upwardSpeed*e,t.vx=0}},jt={name:"radiant",emoji:"☀️",description:"Particles radiate outward like sunbeams",initialize:function(t){const e=Math.random()*St,i=.8+.4*Math.random();if(t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.006,t.emotionColors&&t.emotionColors.length>0)t.color=wt(t.emotionColors);else{const e=["#FFD700","#FFB347","#FFA500","#FF69B4"];t.color=wt(e)}t.hasGlow=Math.random()<.7,t.glowSizeMultiplier=t.hasGlow?1.5+.5*Math.random():0,t.behaviorData={radialSpeed:.02,shimmer:Math.random()*St,shimmerSpeed:.1,friction:.99}},update:function(t,e,i,a){const n=t.behaviorData,s=t.x-i,o=t.y-a,r=Math.sqrt(s*s+o*o);if(r>0){const i=s/r,a=o/r;t.vx+=i*n.radialSpeed*e,t.vy+=a*n.radialSpeed*e}n.shimmer+=n.shimmerSpeed*e;const l=Math.sin(n.shimmer);t.size=t.baseSize*(1+.2*l),t.opacity=t.baseOpacity*(1+.3*l),t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e)}};function Gt(t){t.vx=.02*(Math.random()-.5),t.vy=-.03-.02*Math.random(),t.lifeDecay=8e-4,t.size=(6+6*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1)*1.33,t.baseSize=t.size,t.baseOpacity=.2+.2*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={ascensionSpeed:3e-4,waveFactor:.5,waveFrequency:.001,friction:.998,fadeStartDistance:100}}var Vt={name:"ascending",emoji:"🧘",description:"Slow steady upward float like incense smoke",initialize:Gt,update:function(t,e,i,a){const n=t.behaviorData;if(!n)return void Gt(t);t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e),t.vy-=n.ascensionSpeed*e;const s=Math.sin(t.age*n.waveFrequency*1e3)*n.waveFactor;t.vx+=.001*s*e,void 0===t.initialY&&(t.initialY=t.y);const o=t.initialY-t.y;if(o>n.fadeStartDistance){const e=(o-n.fadeStartDistance)/100,i=Math.max(0,1-e);t.baseOpacity*=.995,i<.5&&(t.lifeDecay*=1.02)}Math.abs(t.vx)>.05&&(t.vx*=Math.pow(.95,e)),t.vy<-.1&&(t.vy=-.1)}},Yt={name:"erratic",emoji:"😰",description:"Nervous jittery movement for anxious states",initialize:function(t){const e=Math.random()*St,i=.1+.15*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.004,t.size=(2+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.4+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={jitterStrength:.02,directionChangeRate:.1,speedVariation:.3,spinRate:.05+.1*Math.random()}},update:function(t,e){const i=t.behaviorData;if(t.vx+=(Math.random()-.5)*i.jitterStrength*e,t.vy+=(Math.random()-.5)*i.jitterStrength*e,Math.random()<Math.min(i.directionChangeRate*e,.5)){const e=Math.random()*St,i=Math.sqrt(t.vx*t.vx+t.vy*t.vy);t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i}const a=1+(Math.random()-.5)*i.speedVariation*e;t.vx*=a,t.vy*=a;const n=t.age*i.spinRate*1e3;t.size=t.baseSize*(1+.2*Math.sin(n)),t.opacity=t.baseOpacity*(.8+.4*Math.random()),t.vx*=Math.pow(.98,e),t.vy*=Math.pow(.98,e);const s=Math.sqrt(t.vx*t.vx+t.vy*t.vy);s>.5&&(t.vx=t.vx/s*.5,t.vy=t.vy/s*.5)}},_t={name:"cautious",emoji:"🤨",description:"Slow careful movement with watchful pauses",initialize:function(t){const e=Math.random()*St,i=.02+.03*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.001,t.life=1,t.size=(4+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.8+.2*Math.random(),t.opacity=t.baseOpacity,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={pauseTimer:2*Math.random(),pauseDuration:.5+.5*Math.random(),moveDuration:1+.5*Math.random(),isMoving:Math.random()>.5,moveTimer:0,originalVx:t.vx,originalVy:t.vy,watchRadius:50+30*Math.random()}},update:function(t,e,i,a){const n=t.behaviorData;if(n.moveTimer+=e,n.isMoving)n.moveTimer>n.moveDuration?(n.isMoving=!1,n.moveTimer=0,t.vx=0,t.vy=0):(t.vx=n.originalVx,t.vy=n.originalVy);else if(n.moveTimer>n.pauseDuration){n.isMoving=!0,n.moveTimer=0;const e=Math.random()*St,i=.02+.03*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,n.originalVx=t.vx,n.originalVy=t.vy}const s=t.x-i,o=t.y-a,r=Math.sqrt(s*s+o*o);if(r>n.watchRadius){const i=.02;t.vx-=s/r*i*e,t.vy-=o/r*i*e}t.vx*=Math.pow(.995,e),t.vy*=Math.pow(.995,e),n.isMoving?t.opacity=t.baseOpacity:t.opacity=t.baseOpacity*(.9+.1*Math.sin(5*t.age))}},Xt={name:"surveillance",emoji:"👁️",description:"Searchlight scanning with paranoid watchfulness",initialize(t,e){t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorState={scanAngle:Math.random()*Math.PI-Math.PI/2,scanDirection:Math.random()<.5?1:-1,scanSpeed:.3+.2*Math.random(),scanRange:Math.PI/3+Math.random()*Math.PI/4,scanCenter:Math.random()*Math.PI*2,pauseTimer:0,pauseDuration:500+500*Math.random(),mode:"scanning",modeTimer:0,nextModeChange:2e3+3e3*Math.random(),dartTarget:{x:0,y:0},dartSpeed:0,patrolRadius:150+100*Math.random(),patrolAngle:Math.random()*Math.PI*2,alertLevel:0,lastPosition:{x:t.x,y:t.y}};const i=Math.random();i<.7?t.behaviorState.primaryRole="scanner":i<.9?(t.behaviorState.primaryRole="patroller",t.behaviorState.mode="patrolling"):(t.behaviorState.primaryRole="watcher",t.behaviorState.mode="frozen")},update(t,e,i){const a=t.behaviorState;if(a){switch(a.modeTimer+=16*e,a.modeTimer>a.nextModeChange&&(this.changeMode(t,a),a.modeTimer=0,a.nextModeChange=2e3+4e3*Math.random()),a.mode){case"scanning":this.updateScanning(t,e,a,i);break;case"darting":this.updateDarting(t,e,a,i);break;case"frozen":this.updateFrozen(t,e,a,i);break;case"patrolling":this.updatePatrolling(t,e,a,i)}t.vy+=.05*e,t.x+=t.vx*e,t.y+=t.vy*e,a.lastPosition.x=t.x,a.lastPosition.y=t.y}},updateScanning(t,e,i,a){i.pauseTimer>0?(i.pauseTimer-=16*e,t.vx*=.9,t.vy*=.9):(i.scanAngle+=i.scanDirection*i.scanSpeed*e*.02,Math.abs(i.scanAngle)>i.scanRange/2&&(i.scanDirection*=-1,i.pauseTimer=i.pauseDuration,i.scanAngle=Math.sign(i.scanAngle)*i.scanRange/2));const n=i.scanCenter+i.scanAngle,s=.8+.5*i.alertLevel;t.vx=Math.cos(n)*s,t.vy=Math.sin(n)*s*.3},updateDarting(t,e,i,a){const n=i.dartTarget.x-t.x,s=i.dartTarget.y-t.y,o=Math.sqrt(n*n+s*s);o>5?(t.vx=n/o*i.dartSpeed,t.vy=s/o*i.dartSpeed):(i.mode="scanning",i.modeTimer=0)},updateFrozen(t,e,i,a){t.vx*=.95,t.vy*=.95,Math.random()<.01&&(t.vx+=.5*(Math.random()-.5),t.vy+=.5*(Math.random()-.5))},updatePatrolling(t,e,i,a){i.patrolAngle+=.01*e;const n=Math.cos(i.patrolAngle)*i.patrolRadius,s=Math.sin(i.patrolAngle)*i.patrolRadius,o=n-t.x,r=s-t.y;t.vx=.02*o,t.vy=.02*r},changeMode(t,e){const i=Math.random();"scanner"===e.primaryRole?i<.1?(e.mode="darting",e.dartTarget={x:200*(Math.random()-.5),y:200*(Math.random()-.5)},e.dartSpeed=3+2*Math.random()):e.mode=i<.2?"frozen":"scanning":"patroller"===e.primaryRole?e.mode=i<.1?"frozen":"patrolling":e.mode=i<.3?"scanning":"frozen"}},Lt={name:"glitchy",emoji:"⚡",description:"Digital glitch with stuttering orbits and corruption",rhythm:{enabled:!0,glitchTiming:{mode:"subdivision",subdivision:"sixteenth",probability:.3,intensityOnBeat:2,intensityOffBeat:.5},stutterSync:{mode:"pattern",patterns:{dubstep:{freezeOnDrop:!0,dropDuration:100},breakbeat:{randomFreeze:.1,duration:50}}},orbitRhythm:{baseSpeed:"tempo",wobbleSync:"eighth",beatAcceleration:1.5,barReset:!0},rgbSync:{enabled:!0,amount:"intensity",direction:"beat",maxSplit:10},noiseRhythm:{trigger:"accent",duration:50,intensity:"drop"}},initialize(t,e,i,a){t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorState={orbitAngle:Math.random()*Math.PI*2,orbitRadius:300+400*Math.random(),orbitSpeed:.01+.02*Math.random(),glitchTimer:0,nextGlitch:500*Math.random()+100,isGlitching:!1,glitchDuration:0,glitchOffset:{x:0,y:0},stutterTimer:0,nextStutter:200*Math.random()+50,isFrozen:!1,frozenPosition:{x:0,y:0},frozenVelocity:{x:0,y:0},hasGhost:Math.random()<.3,ghostOffset:20*Math.random()+10,ghostAngle:Math.random()*Math.PI*2,rgbSplit:Math.random()<.4,rgbPhase:Math.random()*Math.PI*2,noiseLevel:0,noiseBurst:!1,beatPhase:Math.random()*Math.PI*2,beatFrequency:.05+.03*Math.random(),dropIntensity:0},t.lifeDecay=.0015,t.hasGlow=!0,t.glowSizeMultiplier=3+2*Math.random()},update(t,e,i,a){const n=t.behaviorState;if(!n)return;n.glitchTimer+=16*e,n.stutterTimer+=16*e,n.stutterTimer>n.nextStutter&&(n.isFrozen?(n.isFrozen=!1,n.stutterTimer=0,n.nextStutter=100+300*Math.random(),Math.random()<.3&&(t.x+=60*(Math.random()-.5),t.y+=60*(Math.random()-.5))):(n.isFrozen=!0,n.frozenPosition={x:t.x,y:t.y},n.frozenVelocity={x:t.vx,y:t.vy},n.stutterTimer=0,n.nextStutter=20+40*Math.random())),n.glitchTimer>n.nextGlitch&&!n.isGlitching&&(n.isGlitching=!0,n.glitchDuration=50+100*Math.random(),n.glitchOffset={x:80*(Math.random()-.5),y:80*(Math.random()-.5)},n.glitchTimer=0,Math.random()<.5&&t.emotionColors&&(t.color=wt(t.emotionColors))),n.isGlitching&&n.glitchTimer>n.glitchDuration&&(n.isGlitching=!1,n.glitchTimer=0,n.nextGlitch=200+800*Math.random(),n.glitchOffset={x:0,y:0}),n.beatPhase+=n.beatFrequency*e;const s=.5*Math.sin(n.beatPhase)+.5;if(n.beatPhase%(4*Math.PI)<.5*Math.PI?n.dropIntensity=Math.min(1,n.dropIntensity+.1*e):n.dropIntensity=Math.max(0,n.dropIntensity-.05*e),n.isFrozen)t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5);else{n.orbitAngle+=n.orbitSpeed*e*(1+.5*s);const o=n.orbitRadius*(1+.3*n.dropIntensity*Math.sin(4*n.beatPhase));let r=i+Math.cos(n.orbitAngle)*o,l=a+Math.sin(n.orbitAngle)*o*.6;if(n.isGlitching&&(r+=n.glitchOffset.x*Math.random()*.8,l+=n.glitchOffset.y*Math.random()*.8),n.rgbSplit){const t=3*(1+n.dropIntensity);r+=Math.sin(n.rgbPhase)*t,l+=Math.cos(n.rgbPhase)*t,n.rgbPhase+=.1*e}n.dropIntensity>.8&&Math.random()<.1&&(r+=30*(Math.random()-.5),l+=30*(Math.random()-.5));const c=n.isGlitching?.02:.03;t.vx=(r-t.x)*c,t.vy=(l-t.y)*c,t.vx+=(Math.random()-.5)*s*2,t.vy+=(Math.random()-.5)*s*2}t.x+=t.vx*e,t.y+=t.vy*e,Math.random()<.02&&(t.opacity=.1+.9*Math.random()),t.size=t.baseSize*(1+.3*s+.5*n.dropIntensity)}},Ht={name:"spaz",description:"Ultra-aggressive particles with explosive spread and chaotic motion",initialize(t,e,i,a){t.x=i,t.y=a,t.life=1,t.size=3+4*Math.random();const n=Math.random()*Math.PI*2,s=200+300*Math.random();t.vx=Math.cos(n)*s,t.vy=Math.sin(n)*s,t.behaviorState={explosionPhase:0,explosionTimer:0,explosionDuration:1e3+2e3*Math.random(),chaosTimer:0,nextChaosChange:100+200*Math.random(),chaosAngle:n,chaosSpeed:50+100*Math.random(),spazIntensity:.8+.4*Math.random(),zigzagPattern:Math.random()<.5,spiralPattern:Math.random()<.3,teleportChance:.02,sizePulse:!0,sizePulseSpeed:.1+.05*Math.random(),sizePulsePhase:Math.random()*Math.PI*2,colorShift:Math.random()<.3,colorShiftSpeed:.05+.03*Math.random()},t.lifeDecay=8e-4,t.hasGlow=!0,t.glowSizeMultiplier=4+3*Math.random(),t.glowIntensity=1.5+.5*Math.random()},update(t,e,i,a){const n=t.behaviorState;if(n.explosionTimer+=e,n.chaosTimer+=e,0===n.explosionPhase&&n.explosionTimer<500)t.vx*=.98,t.vy*=.98,Math.random()<.1&&(t.vx+=100*(Math.random()-.5),t.vy+=100*(Math.random()-.5));else if(0===n.explosionPhase&&n.explosionTimer>=500)n.explosionPhase=1,n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=30+70*Math.random();else if(1===n.explosionPhase){n.chaosTimer>=n.nextChaosChange&&(n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=20+80*Math.random(),n.nextChaosChange=50+150*Math.random(),n.chaosTimer=0);const e=Math.cos(n.chaosAngle)*n.chaosSpeed,i=Math.sin(n.chaosAngle)*n.chaosSpeed;if(t.vx=.7*t.vx+.3*e,t.vy=.7*t.vy+.3*i,n.zigzagPattern){const e=.01*n.chaosTimer;t.vx+=20*Math.sin(e),t.vy+=20*Math.cos(e)}if(n.spiralPattern){const e=.005*n.chaosTimer,i=50+30*Math.sin(.003*n.chaosTimer);t.vx+=Math.cos(e)*i*.1,t.vy+=Math.sin(e)*i*.1}}if(Math.random()<n.teleportChance){const e=Math.random()*Math.PI*2,n=200+400*Math.random();t.x=i+Math.cos(e)*n,t.y=a+Math.sin(e)*n,t.vx=200*(Math.random()-.5),t.vy=200*(Math.random()-.5)}if(t.x+=t.vx*(e/1e3),t.y+=t.vy*(e/1e3),n.sizePulse){n.sizePulsePhase+=n.sizePulseSpeed*e;const i=1+.5*Math.sin(n.sizePulsePhase);t.size=(3+4*Math.random())*i}n.colorShift&&(n.colorShiftPhase=(n.colorShiftPhase||0)+n.colorShiftSpeed*e),t.vx*=.995,t.vy*=.995,t.life-=t.lifeDecay*e,(t.life<=0||Math.abs(t.x-i)>2e3||Math.abs(t.y-a)>2e3)&&(t.life=0)},getSpawnPosition(t,e){const i=Math.random()*Math.PI*2,a=100+200*Math.random();return{x:t+Math.cos(i)*a,y:e+Math.sin(i)*a}},getVisualProperties:()=>({glowColor:"#FF00AA",glowIntensity:2,particleColors:[{color:"#FF00AA",weight:30},{color:"#00FFAA",weight:25},{color:"#FFAA00",weight:20},{color:"#AA00FF",weight:15},{color:"#00AAFF",weight:10}]})},$t={name:"directed",emoji:"🎯",description:"Focused, straight-line movement toward target",config:{speed:3,acceleration:.15,focusStrength:.8,randomness:.1,edgeBuffer:50},initialize(t,e,i,a,n){const s=e-t.x,o=i-t.y,r=Math.sqrt(s*s+o*o);if(r>0)t.vx=s/r*this.config.speed,t.vy=o/r*this.config.speed;else{const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*this.config.speed,t.vy=Math.sin(e)*this.config.speed}t.targetX=e,t.targetY=i,t.directedPhase=0},update(t,e,i,a,n,s){t.directedPhase+=.05*e;const o=t.targetX-t.x,r=t.targetY-t.y,l=Math.sqrt(o*o+r*r);if(l>10){const i=o/l*this.config.speed,a=r/l*this.config.speed;t.vx+=(i-t.vx)*this.config.acceleration*e,t.vy+=(a-t.vy)*this.config.acceleration*e,t.vx+=(Math.random()-.5)*this.config.randomness,t.vy+=(Math.random()-.5)*this.config.randomness}else{const e=Math.random()*Math.PI*2,o=100+200*Math.random();t.targetX=i+Math.cos(e)*o,t.targetY=a+Math.sin(e)*o,t.targetX=Math.max(this.config.edgeBuffer,Math.min(n-this.config.edgeBuffer,t.targetX)),t.targetY=Math.max(this.config.edgeBuffer,Math.min(s-this.config.edgeBuffer,t.targetY))}t.x+=t.vx*e,t.y+=t.vy*e,(t.x<=0||t.x>=n)&&(t.vx*=-.8,t.x=Math.max(0,Math.min(n,t.x)),t.targetX=i+300*(Math.random()-.5)),(t.y<=0||t.y>=s)&&(t.vy*=-.8,t.y=Math.max(0,Math.min(s,t.y)),t.targetY=a+300*(Math.random()-.5))},visuals:{trailLength:"medium",opacity:.9,sizeMultiplier:1,blurAmount:.2}},Ut={name:"fizzy",emoji:"🫧",description:"Bubbly, effervescent movement like carbonation",config:{baseRiseSpeed:2.5,wobbleAmplitude:30,wobbleFrequency:.15,popChance:.002,popForce:8,fizziness:.3,gravity:-.05},initialize(t,e,i,a,n){t.vx=2*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.wobblePhase=Math.random()*Math.PI*2,t.wobbleSpeed=this.config.wobbleFrequency*(.8+.4*Math.random()),t.bubbleSize=.5+.5*Math.random(),t.popTimer=0,t.isFizzing=!0},update(t,e,i,a,n,s){t.wobblePhase+=t.wobbleSpeed*e;const o=Math.sin(t.wobblePhase)*this.config.wobbleAmplitude;if(t.vx=.05*o+(Math.random()-.5)*this.config.fizziness,t.vy+=this.config.gravity*e,t.vy+=(Math.random()-.5)*this.config.fizziness,Math.random()<this.config.popChance){const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*this.config.popForce,t.vy=Math.sin(e)*this.config.popForce*.7,t.popTimer=1,t.bubbleSize=.3+.7*Math.random()}t.popTimer>0&&(t.popTimer-=.05*e,t.vx*=.95,t.vy*=.95),t.x+=t.vx*e,t.y+=t.vy*e,t.y<-50&&(t.y=s+50,t.x=i+300*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.bubbleSize=.5+.5*Math.random()),(t.x<=0||t.x>=n)&&(t.vx*=-.5,t.x=Math.max(0,Math.min(n,t.x))),t.y>s+50&&(t.y=s,t.vy=1.5*-this.config.baseRiseSpeed),t.size=t.baseSize*t.bubbleSize*(1+.1*Math.sin(2*t.wobblePhase))},visuals:{trailLength:"short",opacity:.6,sizeMultiplier:1.2,blurAmount:.5,sparkle:!0}};var Wt={name:"zen",emoji:"☯️",description:"Peaceful orbital movement like a hovering aura",initialize:function(t){t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5),t.lifeDecay=.003,t.emotionColors&&t.emotionColors.length>0&&(t.color=wt(t.emotionColors)),t.behaviorData={orbitAngle:Math.random()*Math.PI*2,orbitRadius:40+60*Math.random(),orbitSpeed:8e-4+6e-4*Math.random(),floatOffset:Math.random()*Math.PI*2,breathingOffset:Math.random()*Math.PI*2,lifetime:0}},update:function(t,e,i,a){const n=t.behaviorData;if(!n)return;n.lifetime+=e;const s=(n.lifetime+8e3*n.breathingOffset)/8e3,o=.5*Math.sin(s*Math.PI*2)+.5;t.size=t.baseSize*(.95+.05*o),n.orbitAngle+=n.orbitSpeed*e;const r=10*Math.sin(1e-4*n.lifetime+n.floatOffset),l=n.orbitRadius+r,c=i+Math.cos(n.orbitAngle)*l,h=a+Math.sin(n.orbitAngle)*l,u=15*Math.sin(3e-4*n.lifetime+n.breathingOffset),p=c-t.x,d=h+u-t.y;t.vx=.03*p,t.vy=.03*d,t.vx+=.02*(Math.random()-.5),t.vy+=.02*(Math.random()-.5),t.vx*=.98,t.vy*=.98}};const Qt=new Map;var Nt=function(t){return Qt.get(t)||null},Jt=function(){return Array.from(Qt.keys())};const Zt={};function Kt(t){if(Zt[t])return Zt[t];return Nt(t)||null}function te(t,e){const i=Kt(e);return i&&i.initialize?(i.initialize(t),!0):"ambient"!==e&&(console.warn(`⚠️ Behavior '${e}' not found, falling back to ambient`),te(t,"ambient"))}function ee(t,e,i,a,n){const s=Kt(e);return!(!s||!s.update||(s.update(t,i,a,n),0))}[xt,$t,Ut,Pt,Dt,It,Ot,At,Tt,kt,Rt,Et,qt,jt,Vt,Yt,_t,Xt,Lt,Ht,Wt].forEach(t=>{Zt[t.name]=t}),"undefined"!=typeof window&&window.DEBUG_PARTICLES&&(window.ParticleBehaviors={registry:Zt,list:function(){return[...Object.values(Zt).map(t=>({name:t.name,emoji:t.emoji||"🎯",description:t.description||"No description",type:"core"})),...Jt().map(t=>{const e=Nt(t);return{name:e.name,emoji:e.emoji||"🔌",description:e.description||"Plugin behavior",type:"plugin"}})]},get:Kt});class ie{constructor(t,e,i="ambient",a=1,n=1,s=null){const o=Math.random();this.z=o<1/13?.5+.5*Math.random():.9*Math.random()-1;const r=this.z>0?(20+20*Math.random())*a:3*a,l=Math.random()*Math.PI*2;this.x=t+Math.cos(l)*r,this.y=e+Math.sin(l)*r,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.maxLife=1,this.lifeDecay=.01,this.fadeInTime=.15,this.fadeOutTime=.3,this.isFadingOut=!1,this.age=0,this.scaleFactor=a,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*a*n,this.baseSize=this.size,this.emotionColors=s,this.color="#ffffff",this.opacity=1,this.hasGlow=Math.random()<.333,this.glowSizeMultiplier=this.hasGlow?1.33+.33*Math.random():0,this.isCellShaded=Math.random()<.333,this.baseOpacity=.3+.4*Math.random(),this.cachedColors=new Map,this.lastColor=null,this.lastOpacity=-1,this.behavior=i,this.behaviorData={},this.gestureData={initialX:t,initialY:e},te(this,i)}update(t,e,i,a=null,n=null,s=0,o=null){const r=Math.min(t,50)/16.67,l=n&&n.type&&s>0&&function(t){const e=dt(t);return!!e&&"override"===e.type}(n.type);let c,h;if(l?this.applyGestureMotion(n,s,r,e,i):"falling"===this.gestureBehavior?ee(this,"falling",r,e,i):"radiant"===this.gestureBehavior?ee(this,"radiant",r,e,i):(ee(this,this.behavior,r,e,i),n&&s>0&&this.applyGestureMotion(n,s,r,e,i)),l||(this.x+=this.vx*r,this.y+=this.vy*r),o)c=o.width,h=o.height;else{const t=document.getElementById("card-mascot")||document.getElementById("cherokee-guide-mascot")||document.querySelector("canvas");c=t?t.width:2*e,h=t?t.height:2*i}const u=e-c/2+20,p=e+c/2-20,d=i-h/2+20,m=i+h/2-20;this.x-this.size<u?(this.x=u+this.size,this.vx=.5*Math.abs(this.vx)):this.x+this.size>p&&(this.x=p-this.size,this.vx=.5*-Math.abs(this.vx)),this.y-this.size<d?(this.y=d+this.size,this.vy=.5*Math.abs(this.vy)):this.y+this.size>m&&(this.y=m-this.size,this.vy=.5*-Math.abs(this.vy)),this.age+=this.lifeDecay*r,this.age<this.fadeInTime?this.life=this.age/this.fadeInTime:this.age<1-this.fadeOutTime?this.life=1:(this.life=(1-this.age)/this.fadeOutTime,this.isFadingOut=!0,"popcorn"===this.behavior&&(this.size=this.baseSize*(.5+.5*this.life))),this.life=Math.max(0,Math.min(1,this.life)),this.opacity=this.easeInOutCubic(this.life),"burst"===this.behavior&&this.behaviorData&&this.life<this.behaviorData.fadeStart&&(this.size=this.baseSize*(this.life/this.behaviorData.fadeStart))}applyUndertoneModifier(t,e){}applyGestureMotion(t,e,i,a,n){!function(t,e,i,a,n,s){if(!i||!i.type||a>=1)return;t.gestureData||(t.gestureData={originalVx:t.vx,originalVy:t.vy,initialX:t.x,initialY:t.y,startAngle:Math.atan2(t.y-s,t.x-n),startRadius:Math.sqrt(Math.pow(t.x-n,2)+Math.pow(t.y-s,2))});const o=dt(i.type);if(!o)return;let r=i;if(vt.isEnabled()&&o.rhythm?.enabled){const n=vt.applyGestureRhythm(o,t,a,e);r={...i,amplitude:(i.amplitude||1)*(n.amplitudeMultiplier||1)*(n.accentMultiplier||1),wobbleAmount:(i.wobbleAmount||0)*(n.wobbleMultiplier||1),rhythmModulation:n}}o.apply&&o.apply(t,a,r,e,n,s),a>=.99&&o.cleanup&&(o.cleanup(t),t.gestureData=null)}(this,i,t,e,a,n)}isOutOfBounds(t,e){return this.x<-50||this.x>t+50||this.y<-50||this.y>e+50}isAlive(){return this.life>0}setOutwardVelocity(t){if(this.behaviorData&&void 0!==this.behaviorData.outwardSpeed){const e=this.behaviorData.outwardSpeed;this.vx=Math.cos(t)*e,this.vy=Math.sin(t)*e+(this.behaviorData.upwardBias||0)}}getDepthAdjustedSize(){const t=1+.2*this.z;return this.size*t}getState(){return{position:{x:this.x,y:this.y,z:this.z},velocity:{x:this.vx,y:this.vy,z:this.vz},life:this.life,behavior:this.behavior,size:this.size,opacity:this.opacity}}reset(t,e,i="ambient",a=1,n=1,s=null){const o=Math.random();this.z=o<1/13?.5+.5*Math.random():.9*Math.random()-1;const r=this.z>0?(20+20*Math.random())*a:3*a,l=Math.random()*Math.PI*2;if(this.x=t+Math.cos(l)*r,this.y=e+Math.sin(l)*r,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.age=0,this.scaleFactor=a,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*a*n,this.baseSize=this.size,this.emotionColors=s,this.cachedColors.clear(),this.opacity=0,this.isFadingOut=!1,this.baseOpacity=.3+.4*Math.random(),this.color="#ffffff",this.behavior=i,this.gestureData=null,this.behaviorData)for(const t in this.behaviorData)delete this.behaviorData[t];else this.behaviorData={};te(this,i)}getCachedColor(t,e){const i=Math.round(100*e)/100,a=`${t}_${i}`;return this.cachedColors.has(a)||this.cachedColors.set(a,this.hexToRgba(t,i)),this.cachedColors.get(a)}hexToRgba(t,e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?`rgba(${parseInt(i[1],16)}, ${parseInt(i[2],16)}, ${parseInt(i[3],16)}, ${e})`:`rgba(255, 255, 255, ${e})`}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}render(t,e="#ffffff"){if(this.life<=0)return;if(!isFinite(this.x)||!isFinite(this.y))return;const i=this.x,a=this.y,n=Math.max(.1,this.size),s=this.tempColor||this.color||e;if(t.save(),this.isCellShaded){t.strokeStyle=this.getCachedColor(s,.9*this.opacity),t.lineWidth=2,t.beginPath(),t.arc(i,a,n,0,2*Math.PI),t.stroke();const e=Math.floor(3*this.opacity)/3;t.fillStyle=this.getCachedColor(s,e*(this.baseOpacity||.5)*.5),t.beginPath(),t.arc(i,a,Math.max(.1,n-1),0,2*Math.PI),t.fill(),e>.5&&(t.fillStyle=this.getCachedColor("#FFFFFF",.3),t.beginPath(),t.arc(i-.3*n,a-.3*n,.3*n,0,2*Math.PI),t.fill())}else{const e=t.createRadialGradient(i,a,0,i,a,n);if(e.addColorStop(0,this.getCachedColor(s,this.opacity*(this.baseOpacity||.5))),e.addColorStop(.5,this.getCachedColor(s,this.opacity*(this.baseOpacity||.5)*.5)),e.addColorStop(1,this.getCachedColor(s,0)),t.fillStyle=e,t.beginPath(),t.arc(i,a,n,0,2*Math.PI),t.fill(),this.hasGlow&&this.glowSizeMultiplier>0){const e=n*this.glowSizeMultiplier,o=t.createRadialGradient(i,a,.5*n,i,a,e),r=.3,l=Math.max(r,this.opacity),c=Math.min(1,this.glowSizeMultiplier/3);o.addColorStop(0,this.getCachedColor(s,Math.max(.5,.8*l)*c)),o.addColorStop(.25,this.getCachedColor(s,Math.max(.3,.6*l)*c)),o.addColorStop(.5,this.getCachedColor(s,Math.max(.2,.4*l)*c)),o.addColorStop(.75,this.getCachedColor(s,Math.max(.1,.2*l)*c)),o.addColorStop(1,this.getCachedColor(s,0)),t.save(),t.globalCompositeOperation="screen",t.fillStyle=o,t.beginPath(),t.arc(i,a,e,0,2*Math.PI),t.fill(),t.restore()}}t.restore()}}class ae{constructor(t=50){this.poolSize=Math.min(t,50),this.pool=[],this.totalParticlesCreated=0,this.totalParticlesDestroyed=0,this.poolHits=0,this.poolMisses=0}getParticle(t,e,i,a,n,s,o,r=null){let l;return this.pool.length>0?(l=this.pool.pop(),l.reset(t,e,i,a,n,s),this.poolHits++):(l=new ie(t,e,i,a,n,s),this.poolMisses++,this.totalParticlesCreated++),l.emotion=o,r&&(l.gestureBehavior=r),l}returnParticle(t){if(this.pool.length<this.poolSize){if(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData)for(const e in t.behaviorData)delete t.behaviorData[e];this.pool.push(t)}else this.totalParticlesDestroyed++}refreshPool(){const t=this.pool.length-this.poolSize;t>0&&(this.pool.splice(this.poolSize),this.totalParticlesDestroyed+=t)}getStats(){return{poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,totalCreated:this.totalParticlesCreated,totalDestroyed:this.totalParticlesDestroyed}}clear(){this.pool=[],this.poolHits=0,this.poolMisses=0,this.totalParticlesCreated=0,this.totalParticlesDestroyed=0}}class ne{constructor(){this.spawnAccumulator=0}getSpawnPosition(t,e,i,a,n,s=null){const o=Math.min(a,n)/12,r=2.5*o,l=1.1*r,c=Math.min(e-30,a-e-30),h=Math.min(i-30,n-i-30),u=Math.min(1.5*r,c,h);switch(t){case"ambient":case"resting":{const t=Math.random()*Math.PI*2,a=.9*r;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a,angle:t}}case"rising":case"falling":{const t=Math.random()*Math.PI*2,a=l+Math.random()*(u-l);return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}case"aggressive":{const t=Math.random()*Math.PI*2,a=r+Math.random()*o;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}case"scattering":default:return{x:e,y:i};case"burst":{const t=Math.random()*Math.PI*2;if("suspicion"===s){const a=1.5*o;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}if("surprise"===s){const a=1.2*o;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}return{x:e,y:i}}case"repelling":{const t=Math.random()*Math.PI*2,a=.9*r;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}case"orbiting":{const t=Math.random()*Math.PI*2,a=1.2*r+Math.random()*r*.5;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}case"glitchy":{const t=Math.random()*Math.PI*2,a=3*r+Math.random()*r*4;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}case"spaz":{const t=Math.random()*Math.PI*2,a=2*r+Math.random()*r*3;return{x:e+Math.cos(t)*a,y:i+Math.sin(t)*a}}}}clampToCanvas(t,e,i,a,n=30){return{x:Math.max(n,Math.min(i-n,t)),y:Math.max(n,Math.min(a-n,e))}}calculateSpawnRate(t,e){if(t<=0)return 0;const i=Math.min(e,50),a=t/1e3;this.spawnAccumulator+=a*i,this.spawnAccumulator=Math.min(this.spawnAccumulator,3);let n=0;for(;this.spawnAccumulator>=1;)n++,this.spawnAccumulator-=1;return n}resetAccumulator(){this.spawnAccumulator=0}}class se{render(t,e,i="#ffffff",a=null){const n=[];for(const t of e)t.life<=0||n.push(t);this._renderParticles(t,n,i,a)}renderLayer(t,e,i="#ffffff",a=!1,n=null){const s=[],o=t.canvas.width,r=t.canvas.height;for(const t of e)t.z>=0===a&&(t.x<-50||t.x>o+50||t.y<-50||t.y>r+50||t.life<=0||s.push(t));return s.sort((t,e)=>t.isCellShaded!==e.isCellShaded?t.isCellShaded?-1:1:t.hasGlow!==e.hasGlow?t.hasGlow?-1:1:0),this._renderParticles(t,s,i,n),s}_renderParticles(t,e,i,a=null){t.save();let n=null;for(const s of e)if(s.isCellShaded)s.render(t,i),n=null;else{const e=s.color||i;if(e!==n&&(t.fillStyle=e,n=e),!isFinite(s.x)||!isFinite(s.y))continue;const o=s.getDepthAdjustedSize?s.getDepthAdjustedSize():s.size;let r=Math.max(.1,o),l=1;if(a&&a.fireflyEffect){const t=(.01*s.x+.01*s.y+.1*s.size)%(2*Math.PI),e=a.fireflyTime||.001*Date.now(),i=a.particleGlow||2;l=.3+Math.max(0,Math.sin(3*e+t))*i}if(a&&a.flickerEffect){const t=(.02*s.x+.02*s.y)%(2*Math.PI),e=a.flickerTime||.001*Date.now(),i=a.particleGlow||2;l=.5+Math.sin(12*e+t)*i*.5}if(a&&a.shimmerEffect){const e=s.x-t.canvas.width/2,i=s.y-t.canvas.height/2,n=Math.sqrt(e*e+i*i)/200,o=a.shimmerTime||.001*Date.now(),r=a.shimmerWave||0,c=a.particleGlow||1.2;l=1+.15*Math.sin(3*o-n+r)*c}if(a&&a.glowEffect){const e=a.glowProgress||0,i=a.particleGlow||2,n=s.x-t.canvas.width/2,o=s.y-t.canvas.height/2,l=Math.sqrt(n*n+o*o)/300,c=Math.min(.3*l,.5),h=Math.max(0,(e-c)/(1-c)),u=Math.sin(h*Math.PI);s._originalGlow||(s._originalGlow={hasGlow:s.hasGlow,glowSizeMultiplier:s.glowSizeMultiplier||0}),s.hasGlow=!0,s.glowSizeMultiplier=Math.max(3,s._originalGlow.glowSizeMultiplier)+u*i*3,r*=1+.3*u,e>=.99&&s._originalGlow&&(s.hasGlow=s._originalGlow.hasGlow,s.glowSizeMultiplier=s._originalGlow.glowSizeMultiplier,delete s._originalGlow)}if(s.hasGlow||l>1){const e=Math.max(.1,r*(s.glowSizeMultiplier||1.5)*l),i=t.globalCompositeOperation;t.globalCompositeOperation="screen",t.globalAlpha=.15*s.opacity*l,t.beginPath(),t.arc(s.x,s.y,e,0,2*Math.PI),t.fill(),t.globalAlpha=.25*s.opacity*l,t.beginPath(),t.arc(s.x,s.y,.6*e,0,2*Math.PI),t.fill(),t.globalCompositeOperation=i}t.globalAlpha=s.opacity*(s.baseOpacity||.5)*.6*Math.min(2,l),t.beginPath(),t.arc(s.x,s.y,r,0,2*Math.PI),t.fill()}t.restore()}}class oe{constructor(t=50,e=null){this.errorBoundary=e,this.maxParticles=t,this.absoluteMaxParticles=2*t,this.particles=[],this.particlePool=new ae(t),this.particleSpawner=new ne,this.particleRenderer=new se,this.containmentBounds=null,this.stateChangeCount=0,this.lastMemoryCheck=Date.now(),this.lastLeakedCount=0,this.particleCount=0,this.cleanupTimer=0,this.cleanupInterval=5e3}get pool(){return this.particlePool.pool}get poolSize(){return this.particlePool.poolSize}get poolHits(){return this.particlePool.poolHits}get poolMisses(){return this.particlePool.poolMisses}get totalParticlesCreated(){return this.particlePool.totalParticlesCreated}get totalParticlesDestroyed(){return this.particlePool.totalParticlesDestroyed}get spawnAccumulator(){return this.particleSpawner.spawnAccumulator}set spawnAccumulator(t){this.particleSpawner.spawnAccumulator=t}getParticleFromPool(t,e,i){return this.particlePool.getParticle(t,e,i,this.scaleFactor||1,this.particleSizeMultiplier||1,this.currentEmotionColors,this.currentEmotion,this.gestureBehavior)}returnParticleToPool(t){this.particlePool.returnParticle(t)}spawn(t,e,i,a,n,s,o=null,r=0,l=10,c=1,h=1,u=null,p=null){if(this.scaleFactor=c,this.particleSizeMultiplier=h,this.errorBoundary)return this.errorBoundary.wrap(()=>{this._spawn(t,e,i,a,n,s,o,r,l,u,p)},"particle-spawn")();this._spawn(t,e,i,a,n,s,o,r,l,u,p)}resetAccumulator(){this.particleSpawner.resetAccumulator()}_spawn(t,e,i,a,n,s,o,r=0,l=10,c=null,h=null){this.currentEmotion=e,this.baseEmotionColors=c,this.currentUndertone=h,this.currentEmotionColors=c&&h?function(t,e){return t&&Array.isArray(t)&&e&&"clear"!==e?t.map(t=>"string"==typeof t?ft(t,e):t&&"object"==typeof t&&t.color?{...t,color:ft(t.color,e)}:t):t}(c,h):c;let u=i;if(vt.isEnabled()){const i=bt&&bt.isInitialized?bt.getEmotion(e):d(e);if(i){const e=vt.applyParticleRhythm(i,this);if(e.emitBurst)for(let i=0;i<e.emitBurst&&this.particles.length<l;i++)this.spawnSingleParticle(t,a,n);void 0!==e.emissionRate&&(u*=e.emissionRate)}}if(null!==o){for(let e=0;e<o&&this.particles.length<this.maxParticles;e++)this.spawnSingleParticle(t,a,n);return}if(this.skipSpawnThisFrame)return;for(;this.particles.length<r&&this.particles.length<this.maxParticles;)this.spawnSingleParticle(t,a,n);if(this.particles.length>=l)return;if(u<=0)return;const p=this.particleSpawner.calculateSpawnRate(u,s);for(let e=0;e<p&&this.particles.length<l;e++)this.spawnSingleParticle(t,a,n)}getSpawnPosition(t,e,i,a,n){return this.particleSpawner.getSpawnPosition(t,e,i,a,n,this.currentEmotion)}clampToCanvas(t,e,i,a,n=30){return this.particleSpawner.clampToCanvas(t,e,i,a,n)}spawnSingleParticle(t,e,i){if(this.particles.length>=this.absoluteMaxParticles)return;const a=this.canvasWidth||2*e,n=this.canvasHeight||2*i,s=this.particleSpawner.getSpawnPosition(t,e,i,a,n,this.currentEmotion),o=this.particleSpawner.clampToCanvas(s.x,s.y,a,n);s.x=o.x,s.y=o.y;const r=this.getParticleFromPool(s.x,s.y,t);"meditation_swirl"===t&&s.palmCenter&&(r.palmCenter=s.palmCenter,r.swirlAngle=s.swirlAngle),this.particles.push(r),this.particleCount++}update(t,e,i,a=null,n=0,s=null){if(this.errorBoundary)return this.errorBoundary.wrap((t,e,i,a,n,s)=>this._update(t,e,i,a,n,s),"particle-update")(t,e,i,a,n,s);this._update(t,e,i,a,n,s)}_update(t,e,i,a=null,n=0,s=null){for(this.particles=this.particles.filter(o=>(o.update(t,e,i,s,a,n,this.containmentBounds),o.isAlive()));this.particles.length>this.maxParticles;)this.removeParticle(0)}setGestureBehavior(t,e){this.gestureBehavior=e?t:null,e?this.particles.forEach(e=>{e.gestureBehavior=t}):this.particles.forEach(t=>{t.gestureBehavior=null})}removeParticle(t){if(t>=0&&t<this.particles.length){const e=this.particles.splice(t,1)[0];e.cachedGradient=null,e.cachedGradientKey=null,this.returnParticleToPool(e),this.particleCount=Math.max(0,this.particleCount-1)}}render(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._render(t,e,i)},"particle-render")();this._render(t,e,i)}renderBackground(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._renderLayer(t,e,!1,i)},"particle-render-bg")();this._renderLayer(t,e,!1,i)}renderForeground(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._renderLayer(t,e,!0,i)},"particle-render-fg")();this._renderLayer(t,e,!0,i)}_renderLayer(t,e,i,a=null){this.particleRenderer.renderLayer(t,this.particles,e,i,a)}_render(t,e,i=null){this.particleRenderer.render(t,this.particles,e,i)}clear(){for(this.stateChangeCount++;this.particles.length>0;){const t=this.particles.pop();if(t.cachedColors&&t.cachedColors.clear(),t.behaviorData)for(const e in t.behaviorData)delete t.behaviorData[e];this.pool.length<this.poolSize&&!this.pool.includes(t)&&this.pool.push(t)}if(this.particles.length=0,this.particleCount=0,this.spawnAccumulator=0,this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;this.pool.splice(this.poolSize,t)}}burst(t,e,i,a){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._burst(t,e,i,a)},"particle-burst")();this._burst(t,e,i,a)}_burst(t,e,i,a){const n=Math.min(t,this.maxParticles-this.particles.length);for(let t=0;t<n;t++)this.spawnSingleParticle(e,i,a)}performCleanup(){if(this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;for(let e=0;e<t;e++){const t=this.pool.pop();t&&(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData=null)}}for(const t of this.particles)t.cachedGradient&&t.life<.5&&(t.cachedGradient=null,t.cachedGradientKey=null)}getStats(){return{activeParticles:this.particles.length,maxParticles:this.maxParticles,poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,poolEfficiency:this.poolHits/Math.max(1,this.poolHits+this.poolMisses),spawnAccumulator:this.spawnAccumulator}}setMaxParticles(t){for(this.originalMaxParticles=this.originalMaxParticles||this.maxParticles,this.maxParticles=Math.max(1,t);this.particles.length>this.maxParticles;)this.removeParticle(0)}cleanupDeadParticles(){const t=this.particles.length;this.particles=this.particles.filter(t=>t.isAlive());const e=t-this.particles.length;return this.pool.length>20&&(this.pool.length=20),e}getParticlesByBehavior(t){return this.particles.filter(e=>e.behavior===t)}validateParticles(){for(const t of this.particles)if(!t.isAlive()||t.life<0||t.life>1)return!1;return!0}cleanup(){for(let t=this.particles.length-1;t>=0;t--)this.particles[t].isAlive()||this.removeParticle(t)}refreshPool(){this.particlePool.clear();for(const t of this.particles)t.life=0}setContainmentBounds(t){this.containmentBounds=t}destroy(){this.clear(),this.particlePool.clear()}}class re{constructor(){this.listeners=new Map,this.groups=new Map,this.stats={registered:0,removed:0,active:0}}addEventListener(t,e,i,a={},n="default"){const s=this.generateId(),o={id:s,target:t,eventType:e,handler:i,options:a,group:n,active:!0};return this.listeners.set(s,o),this.groups.has(n)||this.groups.set(n,new Set),this.groups.get(n).add(s),t.addEventListener(e,i,a),this.stats.registered++,this.stats.active++,s}removeEventListener(t){const e=this.listeners.get(t);if(!e||!e.active)return!1;e.target.removeEventListener(e.eventType,e.handler,e.options),e.active=!1;const i=this.groups.get(e.group);return i&&(i.delete(t),0===i.size&&this.groups.delete(e.group)),this.listeners.delete(t),this.stats.removed++,this.stats.active--,!0}removeGroup(t){const e=this.groups.get(t);if(!e)return 0;let i=0;for(const t of e)this.removeEventListener(t)&&i++;return i}removeAllForTarget(t){let e=0;for(const[i,a]of this.listeners.entries())a.target===t&&a.active&&this.removeEventListener(i)&&e++;return e}removeAllOfType(t){let e=0;for(const[i,a]of this.listeners.entries())a.eventType===t&&a.active&&this.removeEventListener(i)&&e++;return e}removeAll(){let t=0;for(const[e,i]of this.listeners.entries())i.active&&this.removeEventListener(e)&&t++;return t}createAutoRemove(t,e,i,a={}){const n=this.addEventListener(t,e,i,a);return{id:n,remove:()=>this.removeEventListener(n)}}once(t,e,i,a={}){const n=this.addEventListener(t,e,t=>{i(t),this.removeEventListener(n)},a);return n}debounced(t,e,i,a=250,n={}){let s;return this.addEventListener(t,e,t=>{clearTimeout(s),s=setTimeout(()=>i(t),a)},n)}throttled(t,e,i,a=100,n={}){let s=!1;return this.addEventListener(t,e,t=>{s||(i(t),s=!0,setTimeout(()=>{s=!1},a))},n)}generateId(){return`listener_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getStats(){return{...this.stats,groups:this.groups.size,listeners:this.listeners.size}}getActiveListeners(){const t=[];for(const[e,i]of this.listeners.entries())i.active&&t.push({id:e,eventType:i.eventType,group:i.group,target:i.target.constructor.name});return t}analyzeLeaks(){const t={totalListeners:this.listeners.size,activeListeners:this.stats.active,inactiveButNotRemoved:0,byTarget:new Map,byType:new Map,potentialLeaks:[]};for(const[e,i]of this.listeners.entries()){const a=i.target.constructor.name;t.byTarget.set(a,(t.byTarget.get(a)||0)+1),t.byType.set(i.eventType,(t.byType.get(i.eventType)||0)+1),i.active||(t.inactiveButNotRemoved++,t.potentialLeaks.push({id:e,eventType:i.eventType,target:a}))}return t.byTarget=Object.fromEntries(t.byTarget),t.byType=Object.fromEntries(t.byType),t}cleanup(){let t=0;for(const[e,i]of this.listeners.entries())i.active||(this.listeners.delete(e),t++);return t}destroy(){const t=this.removeAll();return this.listeners.clear(),this.groups.clear(),this.stats={registered:0,removed:0,active:0},t}}class le{constructor(){this.errors=[],this.maxErrors=10,this.errorCounts=new Map,this.defaults={emotion:"neutral",gesture:null,audioLevel:0,particleCount:0,glowIntensity:.7,coreSize:1,breathRate:1,color:"#B0B0B0"}}wrap(t,e,i=null){return(...a)=>{try{return t(...a)}catch(t){return this.logError(t,e),null!==i?i:this.getDefault(e)}}}logError(t,e){const i={timestamp:(new Date).toISOString(),context:e,message:t.message,stack:t.stack};this.errors.push(i);const a=this.errorCounts.get(e)||0;this.errorCounts.set(e,a+1),this.errors.length>this.maxErrors&&this.errors.shift()}getDefault(t){const e={"emotion-transition":this.defaults.emotion,"gesture-execution":this.defaults.gesture,"audio-processing":this.defaults.audioLevel,"particle-system":this.defaults.particleCount,rendering:{glowIntensity:this.defaults.glowIntensity,coreSize:this.defaults.coreSize,color:this.defaults.color},"canvas-operations":null,"state-management":this.defaults.emotion};return Object.prototype.hasOwnProperty.call(e,t)?e[t]:null}validateInput(t,e,i){try{switch(e){case"emotion":return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria"].includes(t)?t:i;case"undertone":return null===t||["nervous","confident","tired","intense","subdued"].includes(t)?t:null;case"gesture":return["bounce","pulse","shake","spin","nod","tilt","expand","contract","flash","drift"].includes(t)?t:i;case"number":return"number"!=typeof t||isNaN(t)?i:t;case"string":return"string"==typeof t?t:i;case"boolean":return"boolean"==typeof t?t:i;default:return null!=t?t:i}}catch(t){return this.logError(t,"input-validation"),i}}hasExceededThreshold(t,e=5){return(this.errorCounts.get(t)||0)>=e}getErrorStats(){return{totalErrors:this.errors.length,errorsByContext:Object.fromEntries(this.errorCounts),recentErrors:this.errors.slice(-5)}}clearErrors(){this.errors=[],this.errorCounts.clear()}async attemptRecovery(t,e,i=3){let a=0;for(;a<i;)try{return await e()}catch(e){if(a++,this.logError(e,`recovery-${t}-attempt-${a}`),a>=i)throw new Error(`Recovery failed for ${t} after ${i} attempts`);await new Promise(t=>setTimeout(t,100*Math.pow(2,a)))}}}class ce{constructor(t={}){this.config={canvasId:t.canvasId||"emotive-canvas",coreGeometry:t.coreGeometry||"sphere",targetFPS:t.targetFPS||60,enableParticles:!1!==t.enableParticles,defaultEmotion:t.defaultEmotion||"neutral",...t},this.container=null,this.webglCanvas=null,this.canvas2D=null,this.core3D=null,this.particleSystem=null,this.isRunning=!1,this.animationFrameId=null,this.lastFrameTime=0,this.eventManager=new re,this.eventManager.emit||(this.eventManager._listeners={},this.eventManager.emit=(t,e)=>{const i=this.eventManager._listeners[t];i&&i.forEach(t=>t(e))},this.eventManager.on=(t,e)=>{this.eventManager._listeners[t]||(this.eventManager._listeners[t]=[]),this.eventManager._listeners[t].push(e)},this.eventManager.off=(t,e)=>{const i=this.eventManager._listeners[t];if(i){const t=i.indexOf(e);t>-1&&i.splice(t,1)}}),this.errorBoundary=new le,this.emotion="neutral",this.undertone=null}init(t){try{if(this.setupCanvasLayers(t),this.core3D=new mt(this.webglCanvas,{geometry:this.config.coreGeometry,emotion:this.config.defaultEmotion}),this.config.enableParticles){const t=this.config.maxParticles||300;this.particleSystem=new oe(t,this.errorBoundary),this.particleSystem.canvasWidth=this.canvas2D.width,this.particleSystem.canvasHeight=this.canvas2D.height}return this}catch(t){throw console.error("Failed to initialize 3D engine:",t),t}}setupCanvasLayers(t){if("CANVAS"===t.tagName){const e=t.parentElement;this.container=document.createElement("div"),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%",e.replaceChild(this.container,t)}else this.container=t,this.container.style.position="relative";this.canvas2D=document.createElement("canvas"),this.canvas2D.id=`${this.config.canvasId}-particles`,this.canvas2D.width=this.container.offsetWidth||400,this.canvas2D.height=this.container.offsetHeight||400,this.canvas2D.style.position="absolute",this.canvas2D.style.top="0",this.canvas2D.style.left="0",this.canvas2D.style.zIndex="1",this.container.appendChild(this.canvas2D),this.webglCanvas=document.createElement("canvas"),this.webglCanvas.id=`${this.config.canvasId}-3d`,this.webglCanvas.width=this.canvas2D.width,this.webglCanvas.height=this.canvas2D.height,this.webglCanvas.style.position="absolute",this.webglCanvas.style.top="0",this.webglCanvas.style.left="0",this.webglCanvas.style.zIndex="2",this.webglCanvas.style.pointerEvents="none",this.container.appendChild(this.webglCanvas)}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.animate(this.lastFrameTime))}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}buildGestureTransform(t,e,i){const a=.001*Date.now();switch(t){case"sparkle":return{particleGlow:i.intensity||2,glow:.3*Math.sin(e*Math.PI*4)+.7,fireflyTime:a,fireflyEffect:!0};case"flicker":{const t=i.intensity||2,n=i.speed||3,s=1+Math.sin(e*Math.PI*2*n)*t*.3,o=.5*Math.sin(e*Math.PI*n*2)+.5;return{offsetX:5*Math.sin(e*Math.PI*4),glow:s,particleGlow:o*t,flickerTime:a,flickerEffect:!0}}case"shimmer":{const t=i.intensity||.3,n=Math.sin(2*a+e*Math.PI*2);return{offsetX:0,offsetY:0,glow:1+n*t,scale:1+.01*n,particleGlow:1+.2*n,shimmerTime:a,shimmerWave:n,shimmerEffect:!0}}case"glow":return{glowEffect:!0,glowProgress:e,particleGlow:i.glowAmount||2};default:return null}}animate(t){if(!this.isRunning)return;const e=t-this.lastFrameTime;if(this.lastFrameTime=t,this.core3D&&this.core3D.render(e),this.particleSystem){const i=this.canvas2D.width/2,a=this.canvas2D.height/2,n=this.canvas2D.getContext("2d"),s=this.core3D?this.core3D.emotion:"neutral",o=d(s),r=this.core3D?this.rgbToHex(this.core3D.glowColor):"#FFFFFF",l=o?.visual?.particleBehavior||"ambient",c=o?.visual?.particleRate||15,h=o?.visual?.minParticles||5,u=o?.visual?.maxParticles||30,p=o?.visual?.particleColors||null;this.particleSystem.spawn(l,s,c,i,a,e,null,h,u,1,1,p,this.undertone);let m=null,g=0,y=null;if(this.currentGesture){const e=t-this.currentGesture.startTime;g=Math.min(e/this.currentGesture.duration,1),m={...this.currentGesture.config,type:this.currentGesture.name},y=this.buildGestureTransform(this.currentGesture.name,g,this.currentGesture.config)}this.particleSystem.update(e,i,a,m,g,this.undertone),n.clearRect(0,0,this.canvas2D.width,this.canvas2D.height),this.particleSystem.render(n,r,y)}this.animationFrameId=requestAnimationFrame(t=>this.animate(t))}setEmotion(t,e){this.emotion=t,"string"==typeof e?this.undertone=e:e&&"object"==typeof e&&(this.undertone=e.undertone||null),this.core3D&&this.core3D.setEmotion(t),this.particleSystem&&(this.particleSystem.particles=[]),this.eventManager.emit("emotion:change",{emotion:t,undertone:this.undertone})}updateUndertone(t){this.undertone=t,this.eventManager.emit("undertone:change",{undertone:t})}express(t){this.core3D&&this.core3D.playGesture(t);const e=dt(t);if(e){const i=e.config||{},a=i.musicalDuration?.musical?500*(i.musicalDuration.beats||2):i.duration||800;this.currentGesture={name:t,gesture:e,config:i,startTime:performance.now(),duration:a},setTimeout(()=>{this.currentGesture&&this.currentGesture.name===t&&(this.currentGesture=null)},a)}this.eventManager.emit("gesture:trigger",{gesture:t})}chain(t){const e=("string"==typeof t?{rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash"}[t]||t:t.join(">")).split(">").map(t=>t.trim().split("+").map(t=>t.trim()).filter(t=>t.length>0));this.executeChainSequence(e)}executeChainSequence(t){if(!t||0===t.length)return;let e=0;const i=()=>{e>=t.length||(t[e].forEach(t=>{this.express(t)}),e++,e<t.length&&setTimeout(i,800))};i()}morphTo(t){this.core3D&&this.core3D.morphToShape(t),this.eventManager.emit("shape:morph",{shape:t})}enableParticles(){if(!this.particleSystem&&this.canvas2D){const t=this.config.maxParticles||300;this.particleSystem=new oe(t,this.errorBoundary),this.particleSystem.canvasWidth=this.canvas2D.width,this.particleSystem.canvasHeight=this.canvas2D.height}}disableParticles(){this.particleSystem&&(this.particleSystem.destroy(),this.particleSystem=null)}get particlesEnabled(){return null!==this.particleSystem}rgbToHex(t){return`#${[Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])].map(t=>{const e=t.toString(16);return 1===e.length?`0${e}`:e}).join("")}`}destroy(){this.stop(),this.core3D&&this.core3D.destroy(),this.particleSystem&&this.particleSystem.destroy()}}export{n as CORE_GEOMETRIES,mt as Core3DManager,ce as EmotiveMascot3D,i as createCrystal,a as createDiamond,e as createSphere,ce as default};
//# sourceMappingURL=emotive-mascot-3d.js.map
