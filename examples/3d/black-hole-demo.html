<!DOCTYPE html>
<!--
  BLACK HOLE SHOWCASE - Emotive Engine 3D Demo
  ‚ö†Ô∏è WORK IN PROGRESS ‚ö†Ô∏è

  A demonstration of NASA M87* Event Horizon Telescope black hole rendering.

  What you'll learn:
  - Black hole accretion disk with differential rotation
  - Gravitational particle accretion with spaghettification
  - Event horizon, photon ring, and ISCO physics
  - Doppler beaming and relativistic effects
  - Blend mode layer system for accretion disk appearance

  Complexity: ‚≠ê‚≠ê‚≠ê Advanced 3D + Physics + Shaders
  Features: Black hole geometry, gravitational accretion, blend layers, shader effects
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Hole Showcase - Emotive Engine 3D</title>
    <meta name="description" content="NASA M87* black hole demo with accretion disk and gravitational physics">

    <!-- Shared 3D example styles -->
    <link rel="stylesheet" href="../3d-example-style.css">

    <style>
        /* Theme: Orange cosmic */
        :root {
            --accent: #ff5500;
            --accent-rgb: 255, 85, 0;
        }

        body {
            background: url('../../assets/bg/star-bg-optimized.jpg') center/cover fixed,
                        linear-gradient(135deg, #000000 0%, #0a0010 50%, #000008 100%);
        }

        /* Override panel borders with orange */
        .left-menu {
            border-right: 1px solid rgba(255, 100, 0, 0.2);
        }

        .right-menu {
            border-left: 1px solid rgba(255, 100, 0, 0.2);
        }

        .section {
            border-bottom-color: rgba(255, 100, 0, 0.1);
        }

        /* Black hole container */
        #blackhole-container {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 1;
            border-radius: clamp(12px, 1.5vw, 20px);
            background: url('../../assets/bg/star-bg-optimized.jpg') center/cover,
                        radial-gradient(circle at center, rgba(255, 100, 0, 0.1), transparent);
            box-shadow: 0 0 150px rgba(255, 100, 0, 0.3);
            touch-action: none;
        }

        #blackhole-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Custom scrollbar for orange theme */
        .left-menu::-webkit-scrollbar-thumb,
        .right-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 100, 0, 0.3);
        }

        .left-menu::-webkit-scrollbar-thumb:hover,
        .right-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 100, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- LEFT MENU: Black Hole Controls -->
    <div class="left-menu">
        <div class="section">
            <h2>Emotions (Auto-Derived Behavior)</h2>
            <div class="section-content">
                <div class="button-grid">
                    <button data-emotion="neutral">üòê Neutral</button>
                    <button data-emotion="joy">üòä Joy</button>
                    <button data-emotion="fear" class="active">üò® Fear</button>
                    <button data-emotion="anger">üò† Anger</button>
                    <button data-emotion="sadness">üò¢ Sad</button>
                    <button data-emotion="surprise">üò≤ Surprise</button>
                </div>
                <div class="info-box" style="margin-top: 8px; font-size: clamp(8px, 0.75vw, 9px);">
                    Black hole adapts to emotion modifiers:<br>
                    ‚Ä¢ <strong>Speed</strong> ‚Üí disk rotation<br>
                    ‚Ä¢ <strong>Intensity</strong> ‚Üí turbulence<br>
                    ‚Ä¢ <strong>Smoothness</strong> ‚Üí chaos (inverse)
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Relativistic Jets</h2>
            <div class="section-content collapsed">
                <button data-action="toggle-jets" class="active" style="width: 100%; margin-bottom: 10px">üöÄ Show Jets</button>
                <div id="jet-controls">
                    <div class="slider-control">
                        <div class="slider-label">
                            <span>Jet Intensity</span>
                            <span class="slider-value" id="jet-intensity-value">80%</span>
                        </div>
                        <input type="range" id="jet-intensity-slider" min="0" max="1" step="0.01" value="0.8">
                    </div>
                    <div style="margin-top: 10px">
                        <label style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 4px; display: block">Blend Mode</label>
                        <select id="jet-blend-mode" style="width: 100%; padding: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px">
                            <option value="5">Screen (Default)</option>
                            <option value="6">Linear Dodge</option>
                            <option value="7">Color Dodge</option>
                            <option value="8">Lighten</option>
                            <option value="9">Lighter Color</option>
                            <option value="10">Overlay</option>
                            <option value="11">Soft Light</option>
                            <option value="12">Hard Light</option>
                            <option value="0">Multiply</option>
                            <option value="16">Difference</option>
                            <option value="17">Exclusion</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Hawking Radiation</h2>
            <div class="section-content collapsed">
                <button data-action="toggle-hawking" style="width: 100%; margin-bottom: 10px">‚ú® Show Hawking Radiation</button>
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Spawn Rate</span>
                        <span class="slider-value" id="hawking-rate-value">0.0/sec</span>
                    </div>
                    <input type="range" id="hawking-rate-slider" min="0" max="5" step="0.1" value="0">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Gravitational Lensing</h2>
            <div class="section-content collapsed">
                <button data-action="toggle-lensing" style="width: 100%; margin-bottom: 10px">üåÄ Show Einstein Ring</button>
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Lensing Strength</span>
                        <span class="slider-value" id="lensing-strength-value">0%</span>
                    </div>
                    <input type="range" id="lensing-strength-slider" min="0" max="1" step="0.01" value="0">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Disk Rotation Speed</h2>
            <div class="section-content collapsed">
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Speed</span>
                        <span class="slider-value" id="rotation-speed-value">1.00x</span>
                    </div>
                    <input type="range" id="rotation-speed-slider" min="0" max="3" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <div class="section">
            <div class="info-box">
                <strong>M87* Black Hole:</strong><br>
                6.5 billion solar masses. Event horizon (black), accretion disk (orbiting plasma), photon ring (bright inner ring). Particles spiral inward and experience spaghettification near the event horizon.
            </div>
        </div>
    </div>

    <!-- CENTER: Black Hole Animation -->
    <div class="center-content">
        <div id="blackhole-container"></div>
        <div class="camera-hint">Drag to rotate ‚Ä¢ Pinch or scroll to zoom</div>
    </div>

    <!-- RIGHT MENU: Visuals & Physics -->
    <div class="right-menu">
        <div class="section visual-controls">
            <h2 class="has-toggle">
                <span>Visuals</span>
                <div class="toggle-switch" id="particles-toggle">Particles</div>
            </h2>
            <div class="section-content">
                <div class="button-grid">
                    <button data-action="toggle-glow" class="toggle-btn active">Core Glow</button>
                    <button data-action="toggle-auto-rotate" class="toggle-btn">Auto-Rotate</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Blend</h2>
            <div class="section-content collapsed">
                <div id="layer-stack" class="layer-stack"></div>
                <button class="add-layer-btn" id="add-layer-btn">+ Layer</button>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">NASA M87* Physics</h2>
            <div class="section-content collapsed">
                <div class="info-box">
                    <strong>Event Horizon:</strong> 2.0√ó Schwarzschild<br>
                    Pure black sphere<br><br>

                    <strong>Photon Ring:</strong> 1.5√ó Schwarzschild<br>
                    Light orbits here<br><br>

                    <strong>ISCO:</strong> 2.5√ó Schwarzschild<br>
                    Inner edge of disk<br><br>

                    <strong>Disk:</strong> 2.5-8√ó Schwarzschild<br>
                    Hot plasma, differential rotation
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="collapsed">Particle Physics</h2>
            <div class="section-content collapsed">
                <div class="info-box">
                    <strong>Orbital Decay:</strong> Angular momentum loss<br><br>
                    <strong>Spaghettification:</strong> Tidal stretching near horizon<br><br>
                    <strong>Velocity:</strong> Increases as radius decreases
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import EmotiveMascot3D, { blendModeNames } from '../../dist/emotive-mascot-3d.js';
        import { exitPrecisionMode } from './layer-utils.js';
        import { setupParticlesToggle, createBlendLayerGroup, syncLayersFromShader } from './demo-utils.js';

        let mascot = null;

        // Initialize black hole
        (async () => {
            try {
                const container = document.getElementById('blackhole-container');
                mascot = new EmotiveMascot3D({
                    coreGeometry: 'blackHole',
                    materialVariant: 'multiplexer', // Use multiplexer shader with blend layers
                    enableParticles: false, // Start with particles OFF for comparison
                    enablePostProcessing: true,
                    enableShadows: false,
                    enableControls: true, // Enable camera controls by default
                    autoRotate: false, // Black hole doesn't rotate
                    enableBlinking: false,
                    enableBreathing: false,
                    cameraDistance: 2.0
                });

                mascot.init(container);
                mascot.start();

                // Set to a dark emotion to match black hole theme
                mascot.setEmotion('fear'); // Dark purple/black theme

                console.log('üï≥Ô∏è EmotiveMascot3D Black Hole initialized');

                // Log black hole material state
                if (mascot.core3D && mascot.core3D.coreMesh) {
                    console.log('üï≥Ô∏è Black hole mesh state:', {
                        hasCoreMesh: !!mascot.core3D.coreMesh,
                        isGroup: !!mascot.core3D.coreMesh.isGroup,
                        childCount: mascot.core3D.coreMesh.children ? mascot.core3D.coreMesh.children.length : 0,
                        hasDiskMaterial: !!(mascot.core3D.coreMesh.userData && mascot.core3D.coreMesh.userData.diskMesh && mascot.core3D.coreMesh.userData.diskMesh.material)
                    });
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize:', error);
            }
        })();

        // Setup particles toggle from demo-utils
        setupParticlesToggle(mascot);

        // Event delegation for controls
        document.addEventListener('click', (e) => {
            // Emotion selector
            if (e.target.dataset.emotion) {
                const emotion = e.target.dataset.emotion;
                mascot.setEmotion(emotion);

                // Update active state
                document.querySelectorAll('[data-emotion]').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');

                console.log(`üé≠ Emotion changed to: ${emotion}`);
                return;
            }

            // Toggle disk glow
            if (e.target.dataset.action === 'toggle-glow') {
                if (mascot.core3D?.coreGlowEnabled !== false) {
                    mascot.core3D.setCoreGlowEnabled(false);
                    e.target.classList.remove('active');
                    console.log('üí´ Disk glow disabled');
                } else {
                    mascot.core3D.setCoreGlowEnabled(true);
                    e.target.classList.add('active');
                    console.log('üí´ Disk glow enabled');
                }
                return;
            }

            // Toggle auto-rotate
            if (e.target.dataset.action === 'toggle-auto-rotate') {
                if (mascot.autoRotateEnabled) {
                    mascot.disableAutoRotate();
                    e.target.classList.remove('active');
                } else {
                    mascot.enableAutoRotate();
                    e.target.classList.add('active');
                }
                return;
            }

            // Toggle jets
            if (e.target.dataset.action === 'toggle-jets') {
                const topJetMesh = mascot?.core3D?.coreMesh?.userData?.topJetMesh;
                const bottomJetMesh = mascot?.core3D?.coreMesh?.userData?.bottomJetMesh;

                if (topJetMesh && bottomJetMesh && topJetMesh.material?.uniforms && bottomJetMesh.material?.uniforms) {
                    const currentIntensity = topJetMesh.material.uniforms.jetIntensity.value;
                    const newIntensity = currentIntensity > 0 ? 0 : 0.8;

                    topJetMesh.material.uniforms.jetIntensity.value = newIntensity;
                    bottomJetMesh.material.uniforms.jetIntensity.value = newIntensity;

                    document.getElementById('jet-intensity-slider').value = newIntensity;
                    document.getElementById('jet-intensity-value').textContent = `${Math.round(newIntensity * 100)}%`;

                    const jetControls = document.getElementById('jet-controls');
                    if (newIntensity > 0) {
                        e.target.classList.add('active');
                        jetControls.style.display = 'block';
                        console.log('üöÄ Relativistic jets ON');
                    } else {
                        e.target.classList.remove('active');
                        jetControls.style.display = 'none';
                        console.log('üöÄ Relativistic jets OFF');
                    }
                }
                return;
            }

            // Toggle Hawking radiation
            if (e.target.dataset.action === 'toggle-hawking') {
                const hawkingParticles = mascot?.core3D?.coreMesh?.userData?.hawkingParticles;

                if (hawkingParticles) {
                    const currentRate = hawkingParticles.userData.spawnRate;
                    const newRate = currentRate > 0 ? 0 : 2.0; // 2 particles/sec default

                    hawkingParticles.userData.spawnRate = newRate;

                    document.getElementById('hawking-rate-slider').value = newRate;
                    document.getElementById('hawking-rate-value').textContent = `${newRate.toFixed(1)}/sec`;

                    if (newRate > 0) {
                        e.target.classList.add('active');
                        console.log('‚ú® Hawking radiation ON (quantum tunneling particles)');
                    } else {
                        e.target.classList.remove('active');
                        console.log('‚ú® Hawking radiation OFF');
                    }
                }
                return;
            }

            // Toggle gravitational lensing
            if (e.target.dataset.action === 'toggle-lensing') {
                const lensingRingMesh = mascot?.core3D?.coreMesh?.userData?.lensingRingMesh;

                if (lensingRingMesh) {
                    const currentStrength = lensingRingMesh.material.uniforms.lensingStrength.value;
                    const newStrength = currentStrength > 0 ? 0 : 0.8; // 80% default

                    lensingRingMesh.material.uniforms.lensingStrength.value = newStrength;

                    document.getElementById('lensing-strength-slider').value = newStrength;
                    document.getElementById('lensing-strength-value').textContent = `${Math.round(newStrength * 100)}%`;

                    if (newStrength > 0) {
                        e.target.classList.add('active');
                        console.log('üåÄ Gravitational lensing ON (Einstein ring effect)');
                    } else {
                        e.target.classList.remove('active');
                        console.log('üåÄ Gravitational lensing OFF');
                    }
                }
                return;
            }
        });

        // Disk rotation speed slider
        const rotationSpeedSlider = document.getElementById('rotation-speed-slider');
        rotationSpeedSlider.addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            document.getElementById('rotation-speed-value').textContent = `${speed.toFixed(2)}x`;

            // Update disk rotation speed in shader
            if (mascot?.core3D?.coreMesh?.userData?.diskMesh?.material?.uniforms?.diskRotationSpeed) {
                mascot.core3D.coreMesh.userData.diskMesh.material.uniforms.diskRotationSpeed.value = speed;
                console.log(`üåÄ Disk rotation speed: ${speed.toFixed(2)}x`);
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BLEND LAYER MANAGEMENT (using shared utilities)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const MAX_BLEND_LAYERS = 4;

        const layerGroup = createBlendLayerGroup({
            name: 'Layer',
            containerId: 'layer-stack',
            addBtnId: 'add-layer-btn',
            maxLayers: MAX_BLEND_LAYERS,
            updateShader: (layers) => {
                // Black hole targets diskMesh instead of coreMesh
                const diskMesh = mascot?.core3D?.coreMesh?.userData?.diskMesh;
                if (!diskMesh?.material?.uniforms) return;

                for (let i = 0; i < MAX_BLEND_LAYERS; i++) {
                    const layerNum = i + 1;
                    const uiLayer = layers[i];
                    if (uiLayer) {
                        if (diskMesh.material.uniforms[`layer${layerNum}Mode`]) {
                            diskMesh.material.uniforms[`layer${layerNum}Mode`].value = uiLayer.mode;
                        }
                        if (diskMesh.material.uniforms[`layer${layerNum}Strength`]) {
                            diskMesh.material.uniforms[`layer${layerNum}Strength`].value = uiLayer.strength;
                        }
                        if (diskMesh.material.uniforms[`layer${layerNum}Enabled`]) {
                            diskMesh.material.uniforms[`layer${layerNum}Enabled`].value = uiLayer.enabled ? 1.0 : 0.0;
                        }
                    } else {
                        if (diskMesh.material.uniforms[`layer${layerNum}Enabled`]) {
                            diskMesh.material.uniforms[`layer${layerNum}Enabled`].value = 0.0;
                        }
                    }
                }
            },
            blendModeNames
        });

        // Initialize layers from shader defaults after mascot loads
        setTimeout(() => {
            syncLayersFromShader(
                layerGroup,
                () => mascot?.core3D?.coreMesh?.userData?.diskMesh?.material?.uniforms,
                'layer',
                MAX_BLEND_LAYERS
            );
            console.log(`üï≥Ô∏è Layer system initialized - ${layerGroup.getLayers().length} layers`);
        }, 1500);

        // Jet intensity slider
        const jetIntensitySlider = document.getElementById('jet-intensity-slider');
        jetIntensitySlider.addEventListener('input', (e) => {
            const intensity = parseFloat(e.target.value);
            document.getElementById('jet-intensity-value').textContent = `${Math.round(intensity * 100)}%`;

            // Update jet intensity in shader uniforms
            const topJetMesh = mascot?.core3D?.coreMesh?.userData?.topJetMesh;
            const bottomJetMesh = mascot?.core3D?.coreMesh?.userData?.bottomJetMesh;

            if (topJetMesh?.material?.uniforms?.jetIntensity) {
                topJetMesh.material.uniforms.jetIntensity.value = intensity;
            }
            if (bottomJetMesh?.material?.uniforms?.jetIntensity) {
                bottomJetMesh.material.uniforms.jetIntensity.value = intensity;
            }

            // Update button active state
            const jetButton = document.querySelector('[data-action="toggle-jets"]');
            if (intensity > 0) {
                jetButton.classList.add('active');
            } else {
                jetButton.classList.remove('active');
            }

            console.log(`üöÄ Jet intensity: ${Math.round(intensity * 100)}%`);
        });

        // Jet blend mode selector
        const jetBlendModeSelect = document.getElementById('jet-blend-mode');
        jetBlendModeSelect.addEventListener('change', (e) => {
            const blendMode = parseInt(e.target.value);
            const topJetMesh = mascot?.core3D?.coreMesh?.userData?.topJetMesh;
            const bottomJetMesh = mascot?.core3D?.coreMesh?.userData?.bottomJetMesh;

            if (topJetMesh && bottomJetMesh && topJetMesh.material?.uniforms && bottomJetMesh.material?.uniforms) {
                topJetMesh.material.uniforms.jetBlendMode.value = blendMode;
                bottomJetMesh.material.uniforms.jetBlendMode.value = blendMode;

                const blendModeNames = ['Multiply', 'Linear Burn', 'Color Burn', 'Darken', 'Darker Color',
                    'Screen', 'Linear Dodge', 'Color Dodge', 'Lighten', 'Lighter Color',
                    'Overlay', 'Soft Light', 'Hard Light', 'Vivid Light', 'Linear Light', 'Pin Light',
                    'Difference', 'Exclusion', 'Subtract', 'Divide', 'Hue', 'Saturation'];
                console.log(`üé® Jet blend mode: ${blendModeNames[blendMode]}`);
            }
        });

        // Hawking radiation spawn rate slider
        const hawkingRateSlider = document.getElementById('hawking-rate-slider');
        hawkingRateSlider.addEventListener('input', (e) => {
            const rate = parseFloat(e.target.value);
            document.getElementById('hawking-rate-value').textContent = `${rate.toFixed(1)}/sec`;

            // Update Hawking radiation spawn rate
            const hawkingParticles = mascot?.core3D?.coreMesh?.userData?.hawkingParticles;

            if (hawkingParticles) {
                hawkingParticles.userData.spawnRate = rate;
            }

            // Update button active state
            const hawkingButton = document.querySelector('[data-action="toggle-hawking"]');
            if (rate > 0) {
                hawkingButton.classList.add('active');
            } else {
                hawkingButton.classList.remove('active');
            }

            console.log(`‚ú® Hawking radiation: ${rate.toFixed(1)} particles/sec`);
        });

        // Gravitational lensing strength slider
        const lensingStrengthSlider = document.getElementById('lensing-strength-slider');
        lensingStrengthSlider.addEventListener('input', (e) => {
            const strength = parseFloat(e.target.value);
            document.getElementById('lensing-strength-value').textContent = `${Math.round(strength * 100)}%`;

            // Update lensing strength in shader
            const lensingRingMesh = mascot?.core3D?.coreMesh?.userData?.lensingRingMesh;

            if (lensingRingMesh?.material?.uniforms?.lensingStrength) {
                lensingRingMesh.material.uniforms.lensingStrength.value = strength;
            }

            // Update button active state
            const lensingButton = document.querySelector('[data-action="toggle-lensing"]');
            if (strength > 0) {
                lensingButton.classList.add('active');
            } else {
                lensingButton.classList.remove('active');
            }

            console.log(`üåÄ Gravitational lensing: ${Math.round(strength * 100)}% (Einstein ring)`);
        });
    </script>
</body>
</html>
