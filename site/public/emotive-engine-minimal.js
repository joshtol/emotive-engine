!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).EmotiveMascotMinimal={})}(this,function(e){"use strict";class t{constructor(e){this.canvas=e,this.ctx=e.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.dpr=window.devicePixelRatio||1,this.width=0,this.height=0,this.centerX=0,this.centerY=0,this.renderSize=null,this.resizeCallbacks=[],this.handleResize=this.handleResize.bind(this),window.addEventListener("resize",this.handleResize),this.resize()}resize(){if(this.renderSize&&this.renderSize.width&&this.renderSize.height)this.width=this.renderSize.width,this.height=this.renderSize.height,this.canvas.width=this.width,this.canvas.height=this.height;else if(this.canvas.hasAttribute("width")&&this.canvas.hasAttribute("height")){const e=parseInt(this.canvas.getAttribute("width"),10),t=parseInt(this.canvas.getAttribute("height"),10),i=this.canvas.getBoundingClientRect(),n=i.width,s=i.height;e>1.5*n||t>1.5*s?(this.width=n,this.height=s,this.canvas.width=e,this.canvas.height=t,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)):(this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t)}else{const e=this.canvas.getBoundingClientRect();this.width=e.width,this.height=e.height,this.canvas.width=this.width*this.dpr,this.canvas.height=this.height*this.dpr,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}this.centerX=this.width/2,this.centerY=this.height/2,this.resizeCallbacks.forEach(e=>{try{e(this.width,this.height,this.dpr)}catch{}})}onResize(e){"function"==typeof e&&this.resizeCallbacks.push(e)}handleResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.renderSize&&this.renderSize.width&&this.renderSize.height||this.resize()},100)}setRenderSize(e,t){this.renderSize={width:e,height:t},this.resize()}clear(){this.ctx.clearRect(0,0,this.width,this.height)}getCenter(){return{x:this.centerX,y:this.centerY}}setTransform(e=0,t=0,i=1,n=0){this.ctx.save(),this.ctx.translate(e,t),this.ctx.rotate(n),this.ctx.scale(i,i)}restoreTransform(){this.ctx.restore()}getContext(){return this.ctx}getDimensions(){return{width:this.width,height:this.height}}destroy(){window.removeEventListener("resize",this.handleResize),clearTimeout(this.resizeTimeout)}}class i{constructor(){this.errors=[],this.maxErrors=10,this.errorCounts=new Map,this.defaults={emotion:"neutral",gesture:null,audioLevel:0,particleCount:0,glowIntensity:.7,coreSize:1,breathRate:1,color:"#B0B0B0"}}wrap(e,t,i=null){return(...n)=>{try{return e(...n)}catch(e){return this.logError(e,t),null!==i?i:this.getDefault(t)}}}logError(e,t){const i={timestamp:(new Date).toISOString(),context:t,message:e.message,stack:e.stack};this.errors.push(i);const n=this.errorCounts.get(t)||0;this.errorCounts.set(t,n+1),this.errors.length>this.maxErrors&&this.errors.shift()}getDefault(e){const t={"emotion-transition":this.defaults.emotion,"gesture-execution":this.defaults.gesture,"audio-processing":this.defaults.audioLevel,"particle-system":this.defaults.particleCount,rendering:{glowIntensity:this.defaults.glowIntensity,coreSize:this.defaults.coreSize,color:this.defaults.color},"canvas-operations":null,"state-management":this.defaults.emotion};return{}.hasOwnProperty.call(t,e)?t[e]:null}validateInput(e,t,i){try{switch(t){case"emotion":return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria"].includes(e)?e:i;case"undertone":return null===e||["nervous","confident","tired","intense","subdued"].includes(e)?e:null;case"gesture":return["bounce","pulse","shake","spin","nod","tilt","expand","contract","flash","drift"].includes(e)?e:i;case"number":return"number"!=typeof e||isNaN(e)?i:e;case"string":return"string"==typeof e?e:i;case"boolean":return"boolean"==typeof e?e:i;default:return null!=e?e:i}}catch(e){return this.logError(e,"input-validation"),i}}hasExceededThreshold(e,t=5){return(this.errorCounts.get(e)||0)>=t}getErrorStats(){return{totalErrors:this.errors.length,errorsByContext:Object.fromEntries(this.errorCounts),recentErrors:this.errors.slice(-5)}}clearErrors(){this.errors=[],this.errorCounts.clear()}async attemptRecovery(e,t,i=3){let n=0;for(;n<i;)try{return await t()}catch(t){if(n++,this.logError(t,`recovery-${e}-attempt-${n}`),n>=i)throw new Error(`Recovery failed for ${e} after ${i} attempts`);await new Promise(e=>setTimeout(e,100*Math.pow(2,n)))}}}function n(e){return 3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join("")),{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16)}}function s(e,t,i){const n=e=>{const t=Math.round(Math.max(0,Math.min(255,e))).toString(16);return 1===t.length?`0${t}`:t};return`#${n(e)}${n(t)}${n(i)}`}function r(e,t,i){e/=255,t/=255,i/=255;const n=Math.max(e,t,i),s=Math.min(e,t,i),r=(n+s)/2;let a,o;if(n===s)a=o=0;else{const c=n-s;switch(o=r>.5?c/(2-n-s):c/(n+s),n){case e:a=(t-i)/c+(t<i?6:0);break;case t:a=(i-e)/c+2;break;case i:a=(e-t)/c+4}a/=6}return{h:360*a,s:100*o,l:100*r}}function a(e,t,i){e/=360,i/=100;const n=(e,t,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e);let s,r,a;if(0==(t/=100))s=r=a=i;else{const o=i<.5?i*(1+t):i+t-i*t,c=2*i-o;s=n(c,o,e+1/3),r=n(c,o,e),a=n(c,o,e-1/3)}return{r:Math.round(255*s),g:Math.round(255*r),b:Math.round(255*a)}}function o(e,t,i){const o=n(e),c=n(t),l=r(o.r,o.g,o.b),h=r(c.r,c.g,c.b),u=l.h;let d=h.h;const p=d-u;p>180?d-=360:p<-180&&(d+=360);const m=a(((u+(d-u)*i)%360+360)%360,l.s+(h.s-l.s)*i,l.l+(h.l-l.l)*i);return s(m.r,m.g,m.b)}const c={intense:1.6,confident:1.3,nervous:1.15,clear:1,tired:.8,subdued:.5};function l(e,t){if(!t||"clear"===t)return e;const i=c[t.toLowerCase()];return i&&1!==i?function(e,t){const i=n(e),o=r(i.r,i.g,i.b);o.s=Math.max(0,Math.min(100,o.s*t));const c=a(o.h,o.s,o.l);return s(c.r,c.g,c.b)}(e,i):e}function h(e){return e}function u(e){return e*(2-e)}function d(e){return e*e}function p(e){return e<.5?2*e*e:(4-2*e)*e-1}function m(e){return 1-Math.pow(1-e,3)}function g(e){return e*e*e}function f(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}function y(e){const t=2*Math.PI/3;return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((10*e-.75)*t)+1}function v(e){const t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}function b(e){const t=2.5949095;return e<.5?Math.pow(2*e,2)*(7.189819*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(2*e-2)+t)+2)/2}function w(e){return Math.sin(e*Math.PI/2)}function S(e){return-(Math.cos(Math.PI*e)-1)/2}function M(e,t,i,n="linear"){return t+(i-t)*("string"==typeof n?{linear:h,easeOutQuad:u,easeInQuad:d,easeInOutQuad:p,easeOutCubic:m,easeInCubic:g,easeInOutCubic:f,easeOutElastic:y,easeOutBounce:v,easeInOutBack:b,easeOutSine:w,easeInOutSine:S}[n]||h:n)(Math.max(0,Math.min(1,e)))}Object.fromEntries(Object.entries({neutral:"#B0B0B0",joy:"#FFD700",sadness:"#4169E1",anger:"#DC143C",fear:"#8B008B",surprise:"#FF8C00",disgust:"#9ACD32",love:"#FF69B4"}).map(([e,t])=>{const i=n(t);return[e,`${i.r}, ${i.g}, ${i.b}`]}));const x=new Map;var C={registerPluginEmotion:function(e,t){return!!t.color&&(t.name||(t.name=e),t.visual||(t.visual={primaryColor:t.color,particleCount:t.particleCount||15,particleSize:t.particleSize||{min:2,max:6}}),t.modifiers||(t.modifiers={speed:1,amplitude:1,intensity:1}),x.set(e,t),!0)},unregisterPluginEmotion:function(e){return!!x.has(e)&&(x.delete(e),!0)},getPluginEmotion:function(e){return x.get(e)||null},getAllPluginEmotions:function(){return Array.from(x.keys())},clearPluginEmotions:function(){x.clear()},createLegacyAdapter:function(e){return{name:e.name||"unknown",emoji:e.emoji||"🔌",color:e.primaryColor||e.color||"#7B68EE",energy:e.energy||"medium",visual:{primaryColor:e.primaryColor||e.color||"#7B68EE",secondaryColor:e.secondaryColor,particleCount:e.particleCount||e.particleRate||15,particleSize:e.particleSize||{min:2,max:6},glowIntensity:e.glowIntensity||.5,trailLength:e.trailLength||5,pulseRate:e.pulseRate||e.breathRate||1},particles:{behavior:e.particleBehavior||"ambient",density:e.particleDensity||"medium",speed:e.particleSpeed||"normal"},modifiers:{speed:e.speedMultiplier||1,amplitude:e.amplitudeMultiplier||1,intensity:e.intensityMultiplier||1,smoothness:e.smoothnessMultiplier||1},gestures:e.gestures||[],transitions:e.transitions||{}}}},T={name:"suspicion",emoji:"🤨",description:"Paranoid watchfulness with surveillance scanning",visual:{glowColor:"#6B46C1",glowIntensity:.85,particleRate:18,minParticles:6,maxParticles:12,particleBehavior:"surveillance",particleSpeed:.2,breathRate:.6,breathDepth:.04,coreJitter:.02,particleColors:[{color:"#6B46C1",weight:30},{color:"#4A5568",weight:25},{color:"#8B4789",weight:20},{color:"#9F7AEA",weight:15},{color:"#2D3748",weight:10}],threatLevel:0,getGlowIntensity(){return.3+.7*this.threatLevel},getParticleSpeed(){return.2+.8*this.threatLevel},getGlowColor(){const e=this.threatLevel||0,t=Math.round(107+113*e),i=Math.round(70+-32*e),n=Math.round(193+-66*e),s=e=>e.toString(16).padStart(2,"0");return`#${s(t)}${s(i)}${s(n)}`}},modifiers:{speed:.4,amplitude:.6,intensity:1.2,smoothness:.3,regularity:.2,focus:1.5,addWobble:!0},typicalGestures:["scan","twitch","peek","tilt","hold"],transitions:{duration:500,easing:"linear",priority:4},special:{coreSquint:.6,scanInterval:2e3,scanDuration:1200,scanAngle:60,twitchChance:.02,peekInterval:4e3,maxThreatDistance:300,alertThreshold:.7}},k={name:"calm",emoji:"😌",description:"Serene, peaceful state with gentle movements",visual:{glowColor:"#66D9CC",glowIntensity:.6,particleRate:25,minParticles:8,maxParticles:25,particleBehavior:"zen",breathRate:.4,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#66D9CC",weight:35},{color:"#99E6D9",weight:25},{color:"#40BFB3",weight:20},{color:"#B3F2E6",weight:15},{color:"#339980",weight:5}]},modifiers:{speed:.5,amplitude:.3,intensity:.4,smoothness:2,regularity:1.5,addWeight:!1,floatHeight:.2,swayAmount:.15,duration:1.5},typicalGestures:["breathe","float","drift","idle"],transitions:{duration:800,easing:"easeInOutSine",priority:1},movement:{floatPattern:"sine_slow",floatPeriod:6e3,floatAmplitude:8,swayPattern:"gentle",swayPeriod:8e3,swayAmplitude:5,microMovements:!1},getCoreParams(e){const t=e.time||Date.now(),i=.5*Math.sin(6e-4*t)+.5;return{scaleX:1-.02*i,scaleY:1-.02*i,eyeOpenness:.85,eyeExpression:"serene",pupilOffset:{x:2*Math.sin(3e-4*t),y:1*Math.cos(4e-4*t)},glowPulse:.95+.05*i}},updateParticle(e,t){e.x+=.1*Math.sin(.001*e.life),e.y-=.02*t,e.opacity=.3*Math.sin(.002*e.life)+.2,e.size=e.baseSize*(1+.2*Math.sin(.001*e.life))},renderCore:(e,t,i,n)=>!1};const E=new Map,P={happy:"joy",peaceful:"calm",curious:"surprise",frustrated:"anger",sad:"sadness"};function _(e){e.name&&E.set(e.name,e)}function A(e){const t=P[e]||e,i=E.get(t);if(i)return i;return C.getPluginEmotion(t)||null}function I(e){const t=A(e);if(!t)return A("neutral").visual;if(!t.visual)return{};const{visual:i}=t,n={};for(const e in i)"function"!=typeof i[e]&&(n[e]=i[e]);return"function"==typeof i.getGlowIntensity&&(n.glowIntensity=i.getGlowIntensity()),"function"==typeof i.getParticleSpeed&&(n.particleSpeed=i.getParticleSpeed()),"function"==typeof i.getParticleRate&&(n.particleRate=i.getParticleRate()),"function"==typeof i.getGlowColor&&(n.glowColor=i.getGlowColor()),n}function R(e){const t=A(e);return t?t.modifiers:A("neutral").modifiers}function D(){return[...Array.from(E.keys()),...C.getAllPluginEmotions()]}function O(){const e={};return E.forEach((t,i)=>{e[i]=t}),e}function z(e){const t=P[e]||e;return E.has(t)||null!==C.getPluginEmotion(t)}function B(e,t){P[e]=t}function F(e,t){const i=A(e),n=A(t);return i&&n?n.transitions&&n.transitions[e]?n.transitions[e]:{duration:1e3,easing:"ease-in-out",gesture:n.transitions?.defaultGesture||null}:{duration:1e3,easing:"ease-in-out"}}function L(e){const t=A(e);return t?.gestures||[]}[{name:"neutral",emoji:"😐",description:"Calm, balanced emotional state",visual:{glowColor:"#00BCD4",glowIntensity:.9,particleRate:2,minParticles:8,maxParticles:10,particleBehavior:"ambient",breathRate:1,breathDepth:.08,coreJitter:!1,particleColors:[{color:"#00BCD4",weight:25},{color:"#00ACC1",weight:20},{color:"#26C6DA",weight:15},{color:"#B2EBF2",weight:15},{color:"#0097A7",weight:10},{color:"#80DEEA",weight:10},{color:"#E0F7FA",weight:5}]},modifiers:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},typicalGestures:["breathe","float","idle","blink"],transitions:{duration:500,easing:"easeInOut",priority:0},getCoreParams:e=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"neutral",pupilOffset:{x:0,y:0}}),renderCore:(e,t,i,n)=>!1},{name:"joy",emoji:"😊",description:"Playful happiness and celebration",visual:{glowColor:"#FFEB3B",glowIntensity:1.6,particleRate:40,minParticles:0,maxParticles:40,particleBehavior:"popcorn",breathRate:1.5,breathDepth:.1,coreJitter:!1,particleColors:[{color:"#FFEB3B",weight:25},{color:"#FFC107",weight:20},{color:"#FFFF00",weight:15},{color:"#FFD700",weight:15},{color:"#FFF59D",weight:10},{color:"#FF9800",weight:10},{color:"#FFFDE7",weight:5}]},modifiers:{speed:1.8,amplitude:1.9,intensity:1.1,smoothness:1,regularity:.9,addBounce:!0},typicalGestures:["bounce","spin","wave","expand","shake","float"],transitions:{duration:400,easing:"easeOutBack",priority:5,burstOnEntry:!0},getCoreParams:e=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"happy",pupilOffset:{x:0,y:-.1},sparkle:!0})},{name:"sadness",emoji:"😢",description:"Deep melancholic sorrow",visual:{glowColor:"#4169E1",glowIntensity:.65,particleRate:25,minParticles:0,maxParticles:25,particleBehavior:"falling",breathRate:.6,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#4169E1",weight:25},{color:"#1E90FF",weight:20},{color:"#6495ED",weight:15},{color:"#B0C4DE",weight:15},{color:"#191970",weight:10},{color:"#87CEEB",weight:10},{color:"#2F4F4F",weight:5}]},modifiers:{speed:.7,amplitude:.6,intensity:.8,smoothness:1.3,regularity:1.1,addGravity:!0},typicalGestures:["droop","sway","contract","drift","sink"],transitions:{duration:800,easing:"easeInOut",priority:3}},{name:"anger",emoji:"😠",description:"Intense rage and aggression",visual:{glowColor:"#DC143C",glowIntensity:1.8,particleRate:20,minParticles:3,maxParticles:10,particleBehavior:"aggressive",breathRate:2.2,breathDepth:.15,coreJitter:!0,particleColors:[{color:"#DC143C",weight:25},{color:"#FF0000",weight:20},{color:"#B22222",weight:15},{color:"#FF4500",weight:15},{color:"#8B0000",weight:10},{color:"#FF6347",weight:10},{color:"#660000",weight:5}]},modifiers:{speed:1.5,amplitude:1.4,intensity:1.3,smoothness:.3,regularity:.7,addShake:!0},typicalGestures:["shake","vibrate","expand","pulse","flicker","strike"],transitions:{duration:300,easing:"easeOutExpo",priority:8,shakeOnEntry:!0},special:{screenShake:!0,particleTrails:"fire",glowPulse:!0,temperatureEffect:"hot"}},{name:"fear",emoji:"😨",description:"Anxious state with fleeing particles",visual:{glowColor:"#8A2BE2",glowIntensity:.9,particleRate:18,minParticles:4,maxParticles:16,particleBehavior:"scattering",breathRate:2.5,breathDepth:.06,coreJitter:!0,particleColors:[{color:"#8A2BE2",weight:25},{color:"#4B0082",weight:20},{color:"#9400D3",weight:15},{color:"#6B46C1",weight:15},{color:"#9932CC",weight:10},{color:"#E6E6FA",weight:8},{color:"#301934",weight:7}]},modifiers:{speed:1.4,amplitude:.8,intensity:1.2,smoothness:.5,regularity:.5,addJitter:!0},typicalGestures:["shake","vibrate","contract","flicker","retreat"],transitions:{duration:400,easing:"easeOut",priority:7}},{name:"surprise",emoji:"😲",description:"Sudden shock with explosive particles",visual:{glowColor:"#FFD700",glowIntensity:1.8,particleRate:30,minParticles:0,maxParticles:15,particleBehavior:"burst",breathRate:.3,breathDepth:.18,coreJitter:!1,particleColors:[{color:"#FFD700",weight:25},{color:"#FFA500",weight:20},{color:"#FFFF00",weight:15},{color:"#FF6347",weight:15},{color:"#FFE4B5",weight:10},{color:"#FF4500",weight:10},{color:"#FFFACD",weight:5}]},modifiers:{speed:1.6,amplitude:1.5,intensity:1.4,smoothness:.7,regularity:.8,addPop:!0},typicalGestures:["expand","bounce","flash","pulse","pop"],transitions:{duration:200,easing:"easeOutBack",priority:6}},{name:"disgust",emoji:"🤢",description:"Revulsion with repelling particles",visual:{glowColor:"#9ACD32",glowIntensity:1,particleRate:15,minParticles:5,maxParticles:12,particleBehavior:"repelling",breathRate:.7,breathDepth:.04,coreJitter:!1,particleColors:[{color:"#9ACD32",weight:25},{color:"#ADFF2F",weight:20},{color:"#7FFF00",weight:15},{color:"#BDB76B",weight:15},{color:"#6B8E23",weight:10},{color:"#CCFF00",weight:8},{color:"#556B2F",weight:7}]},modifiers:{speed:.9,amplitude:.7,intensity:.9,smoothness:.8,regularity:1,addRecoil:!0},typicalGestures:["contract","shake","recoil","wobble"],transitions:{duration:600,easing:"easeIn",priority:4}},{name:"love",emoji:"💕",description:"Warm affection with orbiting particles",visual:{glowColor:"#FF1493",glowIntensity:1.8,particleRate:25,minParticles:10,maxParticles:18,particleBehavior:"orbiting",breathRate:.75,breathDepth:.15,coreJitter:!1,particleColors:[{color:"#FF1493",weight:30},{color:"#FF69B4",weight:25},{color:"#FF007F",weight:15},{color:"#FFB6C1",weight:10},{color:"#FF45A0",weight:10},{color:"#E91E63",weight:5},{color:"#FFC0CB",weight:5}]},modifiers:{speed:.9,amplitude:1.1,intensity:1.2,smoothness:1.4,regularity:1.2,addWarmth:!0},typicalGestures:["pulse","sway","orbit","glow","breathe","float"],transitions:{duration:700,easing:"easeInOut",priority:5}},T,{name:"excited",emoji:"🤩",description:"High energy with rapid particles",visual:{glowColor:"#FF6B35",glowIntensity:1.5,particleRate:25,minParticles:8,maxParticles:30,particleBehavior:"burst",breathRate:2,breathDepth:.14,coreJitter:!0,particleColors:[{color:"#FF6B35",weight:25},{color:"#FF1744",weight:20},{color:"#FFC107",weight:15},{color:"#FF9100",weight:15},{color:"#FFEB3B",weight:10},{color:"#FF5722",weight:10},{color:"#FFF59D",weight:5}]},modifiers:{speed:1.4,amplitude:1.3,intensity:1.3,smoothness:.8,regularity:.7,addVibration:!0},typicalGestures:["bounce","spin","vibrate","expand","shake","pulse"],transitions:{duration:300,easing:"easeOutElastic",priority:6}},{name:"resting",emoji:"😴",description:"Deep relaxation with slow drift",visual:{glowColor:"#9370DB",glowIntensity:.8,particleRate:10,minParticles:3,maxParticles:5,particleBehavior:"resting",breathRate:.8,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#9370DB",weight:30},{color:"#A591C4",weight:20},{color:"#B366FF",weight:20},{color:"#B8A1E6",weight:15},{color:"#674D9B",weight:15}]},modifiers:{speed:.5,amplitude:.4,intensity:.5,smoothness:1.4,regularity:.9,addWeight:!0},typicalGestures:["breathe","drift","sway","float"],transitions:{duration:1e3,easing:"easeInOut",priority:2}},{name:"euphoria",emoji:"🌟",description:"Radiant hope and new beginnings",visual:{glowColor:"#FFB6C1",glowIntensity:1.2,particleRate:35,minParticles:15,maxParticles:30,particleBehavior:"radiant",breathRate:1.3,breathDepth:.25,coreJitter:!1,particleColors:[{color:"#FFB6C1",weight:20},{color:"#FFD700",weight:18},{color:"#87CEEB",weight:15},{color:"#DDA0DD",weight:15},{color:"#98FB98",weight:12},{color:"#FFA07A",weight:10},{color:"#E6E6FA",weight:8},{color:"#FFFFFF",weight:2}]},modifiers:{speed:1.4,amplitude:1.5,intensity:1.6,smoothness:1.3,regularity:.8,addWarmth:!0,addLift:!0},typicalGestures:["expand","radiate","pulse","glow","float","bloom"],transitions:{duration:600,easing:"easeOutExpo",priority:8}},{name:"focused",emoji:"🎯",description:"Intense concentration with directed flow",visual:{glowColor:"#00CED1",glowIntensity:1.2,particleRate:10,minParticles:5,maxParticles:12,particleBehavior:"directed",breathRate:1.2,breathDepth:.08,coreJitter:!0,particleColors:[{color:"#00CED1",weight:30},{color:"#4A9FA0",weight:20},{color:"#00FFFF",weight:20},{color:"#5FE5E7",weight:15},{color:"#006B6D",weight:15}],eyeOpenness:.7,microAdjustments:!0},modifiers:{speed:1,amplitude:.9,intensity:1.1,smoothness:1.1,regularity:1.2,addPrecision:!0},typicalGestures:["track","lock","scan","pulse","vibrate"],transitions:{duration:400,easing:"easeIn",priority:5},getCoreParams:e=>({scaleX:1.1,scaleY:.7,eyeOpenness:.7,eyeExpression:"focused",pupilOffset:{x:0,y:0},microAdjustments:!0})},{name:"glitch",emoji:"🌈",description:"Surprised sadness with rainbow colors and glitch wiggle",visual:{primaryColor:"#FF6B9D",glowColor:"#4169E1",glowIntensity:1.2,particleRate:20,minParticles:5,maxParticles:15,particleBehavior:"burst",particleSpeed:1,breathRate:.4,breathDepth:.15,coreJitter:!1,coreSize:1,eyeOpenness:.8,particleColors:[{color:"#FF0080",weight:18},{color:"#00FF80",weight:18},{color:"#8000FF",weight:18},{color:"#FF8000",weight:15},{color:"#0080FF",weight:15},{color:"#FFFF00",weight:10},{color:"#FF6B9D",weight:6}],particleGlitchWiggle:!0,glitchWiggleIntensity:.3,glitchWiggleFrequency:.1},modifiers:{speed:1.1,amplitude:1,intensity:1.1,smoothness:.8,regularity:.7,focus:.6},typicalGestures:["bounce","sway","pulse","drift","flash"],transitions:{duration:300,easing:"easeInOut",priority:5}},k].forEach(e=>{e&&e.name&&E.set(e.name,e)});var q={registerEmotion:_,getEmotion:A,getEmotionVisualParams:I,getEmotionParams:I,getEmotionModifiers:R,listEmotions:D,getAllEmotions:O,hasEmotion:z,addEmotionAlias:B,getTransitionParams:F,getEmotionGestures:L,pluginAdapter:C},G=Object.freeze({__proto__:null,addEmotionAlias:B,default:q,getAllEmotions:O,getEmotion:A,getEmotionGestures:L,getEmotionModifiers:R,getEmotionVisualParams:I,getTransitionParams:F,hasEmotion:z,listEmotions:D,pluginAdapter:C,registerEmotion:_});const $=new class{constructor(){this.emotionCache=new Map,this.visualParamsCache=new Map,this.modifiersCache=new Map,this.transitionCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const e=D();e.forEach(e=>{this.cacheEmotion(e)}),this.cacheCommonTransitions(e),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.emotionCache.size}catch(e){console.error("[EmotionCache] Initialization failed:",e),this.isInitialized=!1}}cacheEmotion(e){try{const t=A(e);t&&this.emotionCache.set(e,t);const i=I(e);this.visualParamsCache.set(e,i);const n=R(e);this.modifiersCache.set(e,n)}catch(t){console.warn(`[EmotionCache] Failed to cache emotion '${e}':`,t)}}cacheCommonTransitions(e){[["neutral","joy"],["neutral","sadness"],["neutral","anger"],["joy","sadness"],["sadness","joy"],["anger","calm"],["calm","anger"]].forEach(([t,i])=>{if(e.includes(t)&&e.includes(i))try{const e=F(t,i),n=`${t}->${i}`;this.transitionCache.set(n,e)}catch(e){console.warn(`[EmotionCache] Failed to cache transition '${t}->${i}':`,e)}})}getEmotion(e){if(!this.isInitialized)return console.warn("[EmotionCache] Cache not initialized, falling back to direct access"),A(e);const t=this.emotionCache.get(e);return t?(this.stats.hits++,t):(this.stats.misses++,console.warn(`[EmotionCache] Cache miss for emotion '${e}', consider adding to pre-cache`),A(e))}getVisualParams(e){if(!this.isInitialized)return I(e);const t=this.visualParamsCache.get(e);return t?(this.stats.hits++,t):(this.stats.misses++,I(e))}getModifiers(e){if(!this.isInitialized)return R(e);const t=this.modifiersCache.get(e);return t?(this.stats.hits++,t):(this.stats.misses++,R(e))}getTransitionParams(e,t){if(!this.isInitialized)return F(e,t);const i=`${e}->${t}`,n=this.transitionCache.get(i);return n?(this.stats.hits++,n):(this.stats.misses++,F(e,t))}hasEmotion(e){return this.emotionCache.has(e)}getStats(){const e=this.stats.hits+this.stats.misses,t=e>0?(this.stats.hits/e*100).toFixed(2):0;return{isInitialized:this.isInitialized,loadTime:this.stats.loadTime,cacheSize:this.stats.cacheSize,hits:this.stats.hits,misses:this.stats.misses,hitRate:`${t}%`,emotions:this.emotionCache.size,visualParams:this.visualParamsCache.size,modifiers:this.modifiersCache.size,transitions:this.transitionCache.size}}clear(){this.emotionCache.clear(),this.visualParamsCache.clear(),this.modifiersCache.clear(),this.transitionCache.clear(),this.isInitialized=!1,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0}}reinitialize(){this.clear(),this.initialize()}};class H{constructor(e){this.errorBoundary=e,this.state={emotion:"neutral",undertone:null,gesture:null,speaking:!1,audioLevel:0},this.transitions={emotional:{current:"neutral",target:null,progress:0,duration:500,startTime:0,isActive:!1},undertone:{current:null,target:null,progress:0,duration:300,startTime:0,isActive:!1,currentWeight:0,targetWeight:0}},this.interpolationCache={lastUpdate:0,cacheInterval:100,cachedProperties:null,cachedRenderState:null},this.initializeEmotionalStates(),this.initializeUndertoneModifiers()}initializeEmotionalStates(){this.emotionalStates=this.loadEmotionalStatesFromCache()}loadEmotionalStatesFromCache(){const e={};return["neutral","joy","sadness","anger","fear","surprise","disgust","love","suspicion","excited","resting","euphoria","focused","glitch","calm"].forEach(t=>{const i=$.getVisualParams(t);i&&(e[t]={primaryColor:i.primaryColor||"#B0B0B0",glowIntensity:i.glowIntensity||.7,particleRate:i.particleRate||1,minParticles:i.minParticles||3,maxParticles:i.maxParticles||4,particleBehavior:i.particleBehavior||"ambient",coreSize:i.coreSize||1,breathRate:i.breathRate||1,breathDepth:i.breathDepth||.1})}),e}initializeUndertoneModifiers(){this.undertoneModifiers={nervous:{jitterAmount:.3,breathRateMultiplier:1.2,glowIntensityMultiplier:.9,particleRateMultiplier:1.1},confident:{coreSizeMultiplier:1.1,glowIntensityMultiplier:1.2,breathRateMultiplier:.9,particleRateMultiplier:1},tired:{breathRateMultiplier:.7,particleRateMultiplier:.5,glowIntensityMultiplier:.8,coreSizeMultiplier:.95},intense:{amplificationFactor:1.3},subdued:{dampeningFactor:.7}}}setEmotion(e,t=null,i=500){return this.errorBoundary.wrap(()=>{if(this.interpolationCache.cachedProperties=null,this.interpolationCache.cachedRenderState=null,!z(e)&&!{}.hasOwnProperty.call(this.emotionalStates,e)){const t=[...Object.keys(this.emotionalStates),...D()],i=[...new Set(t)];throw new Error(`Invalid emotion: ${e}. Valid emotions: ${i.join(", ")}`)}if(null!==t&&!{}.hasOwnProperty.call(this.undertoneModifiers,t))throw new Error(`Invalid undertone: ${t}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.emotion===e&&this.state.undertone===t||(this.state.emotion!==e&&(i>0?(this.transitions.emotional={current:this.state.emotion,target:e,progress:0,duration:Math.max(100,i),startTime:performance.now(),isActive:!0},void 0!==this._simulatedTime&&(this._simulatedTime=0)):this.transitions.emotional={current:e,target:null,progress:1,duration:0,startTime:performance.now(),isActive:!1},this.state.emotion=e),this.state.undertone!==t&&(this.transitions.undertone={current:this.state.undertone,target:t,progress:0,duration:300,startTime:performance.now(),isActive:!0,currentWeight:this.state.undertone?1:0,targetWeight:t?1:0},this.state.undertone=t)),!0},"emotion-setting",!1)()}applyUndertone(e,t){if(!t||!{}.hasOwnProperty.call(this.undertoneModifiers,t))return{...e};const i=this.undertoneModifiers[t],n={...e};if(void 0!==i.glowIntensityMultiplier&&(n.glowIntensity*=i.glowIntensityMultiplier),void 0!==i.breathRateMultiplier&&(n.breathRate*=i.breathRateMultiplier),void 0!==i.particleRateMultiplier&&(n.particleRate=Math.round(n.particleRate*i.particleRateMultiplier)),void 0!==i.coreSizeMultiplier&&(n.coreSize*=i.coreSizeMultiplier),void 0!==i.amplificationFactor){const e=i.amplificationFactor;n.glowIntensity*=e,n.breathRate*=e,n.particleRate=Math.round(n.particleRate*e),n.coreSize*=e}if(void 0!==i.dampeningFactor){const e=i.dampeningFactor;n.glowIntensity*=e,n.breathRate*=e,n.particleRate=Math.round(n.particleRate*e),n.coreSize*=e}return void 0!==i.jitterAmount&&(n.jitterAmount=i.jitterAmount),n}update(e){this.errorBoundary.wrap(()=>{this.transitions.emotional.isActive&&this.updateEmotionalTransition(e),this.transitions.undertone.isActive&&this.updateUndertoneTransition(e)},"state-machine-update")()}updateUndertoneTransition(e){const t=this.transitions.undertone,i=performance.now()-t.startTime,n=Math.min(i/t.duration,1),s=f(n);t.current&&t.target?(t.currentWeight=1-s,t.targetWeight=s):t.current&&!t.target?(t.currentWeight=1-s,t.targetWeight=0):!t.current&&t.target&&(t.currentWeight=0,t.targetWeight=s),t.progress=n,n>=1&&(t.isActive=!1,t.current=t.target,t.currentWeight=t.target?1:0,t.targetWeight=0)}updateEmotionalTransition(e){const t=this.transitions.emotional;let i;void 0!==this._simulatedTime?(this._simulatedTime+=e,i=this._simulatedTime):i=performance.now()-t.startTime,t.progress=Math.min(1,i/t.duration),t.progress>=1&&(t.isActive=!1,t.current=t.target,t.target=null,t.progress=1)}getCurrentEmotionalProperties(){return this.errorBoundary.wrap(()=>{const e=performance.now();if(this.interpolationCache.cachedProperties&&e-this.interpolationCache.lastUpdate<this.interpolationCache.cacheInterval)return this.interpolationCache.cachedProperties;const t=this.transitions.emotional;let i;return i=t.isActive&&t.target?this.interpolateEmotionalProperties(t.current,t.target,t.progress):{...this.emotionalStates[this.state.emotion]||this.emotionalStates.neutral},i=this.applyUndertone(i,this.state.undertone),this.interpolationCache.cachedProperties=i,this.interpolationCache.lastUpdate=e,i},"emotional-properties",()=>this.emotionalStates.neutral)()}interpolateEmotionalProperties(e,t,i){const n=this.emotionalStates[e]||this.emotionalStates.neutral,s=this.emotionalStates[t]||this.emotionalStates.neutral,r=M(i,0,1,"easeOutCubic");return{primaryColor:o(n.primaryColor,s.primaryColor,r),glowIntensity:n.glowIntensity+(s.glowIntensity-n.glowIntensity)*r,particleRate:Math.round(n.particleRate+(s.particleRate-n.particleRate)*r),coreSize:n.coreSize+(s.coreSize-n.coreSize)*r,breathRate:n.breathRate+(s.breathRate-n.breathRate)*r,breathDepth:n.breathDepth+(s.breathDepth-n.breathDepth)*r,particleBehavior:r>.5?s.particleBehavior:n.particleBehavior}}getCurrentState(){return{emotion:this.state.emotion,undertone:this.state.undertone,isTransitioning:this.transitions.emotional.isActive,transitionProgress:this.transitions.emotional.progress,properties:this.getCurrentEmotionalProperties()}}applyUndertoneModifier(e){return this.errorBoundary.wrap(()=>{if(null!==e&&!{}.hasOwnProperty.call(this.undertoneModifiers,e))throw new Error(`Invalid undertone: ${e}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.undertone=e,!0},"undertone-application",!1)()}clearUndertone(){this.state.undertone=null}getUndertoneModifier(e){return this.errorBoundary.wrap(()=>{if(this.renderer&&this.renderer.undertoneModifiers&&this.renderer.undertoneModifiers[e])return{...this.renderer.undertoneModifiers[e]};if(!e||!{}.hasOwnProperty.call(this.undertoneModifiers,e))return null;const t={...this.undertoneModifiers[e]};return t.glowRadiusMult||(t.glowRadiusMult=1),t},"undertone-retrieval",null)()}getWeightedUndertoneModifiers(){const e=this.transitions.undertone;if(!e.isActive){if(this.state.undertone){const e=this.getUndertoneModifier(this.state.undertone);if(e)return{...e,weight:1,type:this.state.undertone}}return null}if(e.target){const t=this.getUndertoneModifier(e.target);if(t)return{...t,weight:e.targetWeight,type:e.target}}if(e.current&&e.currentWeight>0){const t=this.getUndertoneModifier(e.current);if(t)return{...t,weight:e.currentWeight,type:e.current}}return null}reset(e=500){this.setEmotion("neutral",null,e)}isValidEmotion(e){return{}.hasOwnProperty.call(this.emotionalStates,e)}isValidUndertone(e){return null===e||{}.hasOwnProperty.call(this.undertoneModifiers,e)}getAvailableEmotions(){return Object.keys(this.emotionalStates)}getAvailableUndertones(){return Object.keys(this.undertoneModifiers)}isTransitioning(){return this.transitions.emotional.isActive}getTransitionProgress(){return this.transitions.emotional.isActive?this.transitions.emotional.progress:1}completeTransition(){this.transitions.emotional.isActive&&(this.transitions.emotional.progress=1,this.transitions.emotional.isActive=!1,this.transitions.emotional.current=this.transitions.emotional.target,this.transitions.emotional.target=null)}interpolateProperty(e,t,i,n="easeOutCubic"){return e+(t-e)*M(i,0,1,n)}enableSimulatedTime(e=!0){e?this._simulatedTime=0:delete this._simulatedTime}}const j=new class{constructor(){this.bpm=120,this.timeSignature=[4,4],this.isPlaying=!1,this.startTime=0,this.currentBeat=0,this.currentBar=0,this.beatProgress=0,this.barProgress=0,this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.lastBeatTime=0,this.nextBeatTime=0,this.listeners=new Map,this.beatCallbacks=new Set,this.barCallbacks=new Set,this.subdivisions={sixteenth:0,eighth:0,triplet:0,swing:0},this.audioSync=null,this.syncOffset=0,this.autoSync=!1,this.intensity=1,this.groove=0,this.humanize=.05,this.patterns=new Map,this.currentPattern=null,this.initializePatterns()}initializePatterns(){this.patterns.set("4/4",{name:"4/4",description:"Common time - 4 beats per bar",timeSignature:[4,4],groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("straight",{name:"straight",description:"Straight, even timing",groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("swing",{name:"swing",description:"Swing/shuffle timing",groove:.67,accents:[1,.3,.8,.3]}),this.patterns.set("3/4",{name:"3/4",description:"Waltz time - 3 beats per bar",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("waltz",{name:"waltz",description:"3/4 waltz timing",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("6/8",{name:"6/8",description:"Compound duple time",timeSignature:[6,8],accents:[1,.3,.3,.7,.3,.3]}),this.patterns.set("5/4",{name:"5/4",description:"Complex meter - 5 beats per bar",timeSignature:[5,4],accents:[1,.5,.6,.5,.7]}),this.patterns.set("7/8",{name:"7/8",description:"Irregular meter",timeSignature:[7,8],accents:[1,.5,.5,.7,.5,.5,.6]}),this.patterns.set("dubstep",{name:"dubstep",description:"Dubstep half-time feel",accents:[.2,.2,1,.2],subdivisions:{wobble:!0}}),this.patterns.set("breakbeat",{name:"breakbeat",description:"Broken beat pattern",accents:[1,.2,.7,.9,.2,.8,.4,.2]})}start(){this.isPlaying||(this.isPlaying=!0,this.isRunning=!0,this.startTime=performance.now(),this.lastBeatTime=this.startTime,this.nextBeatTime=this.startTime+this.beatDuration,this.currentBeat=0,this.currentBar=0,this.emit("start",{bpm:this.bpm,timeSignature:this.timeSignature,pattern:this.currentPattern}),this.update())}stop(){this.isPlaying&&(this.isPlaying=!1,this.emit("stop",{totalBeats:this.currentBeat,totalBars:this.currentBar}))}update(){if(!this.isPlaying)return;const e=(performance.now()-this.startTime)/this.beatDuration,t=Math.floor(e);this.beatProgress=e%1,t>this.currentBeat&&this.onBeat(t);const i=Math.floor(t/this.timeSignature[0]);i>this.currentBar&&this.onBar(i),this.currentBeat=t,this.currentBar=i,this.barProgress=t%this.timeSignature[0]/this.timeSignature[0],this.updateSubdivisions(),this.emit("update",this.getTimeInfo()),this.isPlaying&&requestAnimationFrame(()=>this.update())}onBeat(e){const t=e%this.timeSignature[0],i=this.getAccent(t),n=this.humanize*(Math.random()-.5)*this.beatDuration,s={beat:e,beatInBar:t,bar:this.currentBar,accent:i,intensity:this.intensity*i,humanTiming:n,timestamp:performance.now()};this.emit("beat",s),this.beatCallbacks.forEach(e=>e(s)),this.lastBeatTime=performance.now(),this.nextBeatTime=this.lastBeatTime+this.beatDuration}onBar(e){const t={bar:e,timeSignature:this.timeSignature,pattern:this.currentPattern,timestamp:performance.now()};this.emit("bar",t),this.barCallbacks.forEach(e=>e(t))}updateSubdivisions(){if(this.subdivisions.sixteenth=4*this.beatProgress%1,this.subdivisions.eighth=2*this.beatProgress%1,this.subdivisions.triplet=3*this.beatProgress%1,this.groove>0){const e=.5+.17*this.groove;this.subdivisions.eighth<.5?this.subdivisions.swing=this.subdivisions.eighth/e:this.subdivisions.swing=.5+(this.subdivisions.eighth-.5)/(1-e)}else this.subdivisions.swing=this.subdivisions.eighth}getAccent(e){if(this.currentPattern&&this.patterns.has(this.currentPattern)){const t=this.patterns.get(this.currentPattern);if(t.accents&&void 0!==t.accents[e])return t.accents[e]}return 0===e?1:2===e&&4===this.timeSignature[0]?.7:.5}getTimeInfo(){return{elapsed:performance.now()-this.startTime,beat:this.currentBeat,bar:this.currentBar,beatInBar:this.currentBeat%this.timeSignature[0],beatProgress:this.beatProgress,barProgress:this.barProgress,subdivisions:{...this.subdivisions},bpm:this.bpm,beatDuration:this.beatDuration,timeSignature:[...this.timeSignature],intensity:this.intensity,groove:this.groove,pattern:this.currentPattern,nextBeatIn:this.nextBeatTime-performance.now(),accent:this.getAccent(this.currentBeat%this.timeSignature[0])}}setBPM(e){this.bpm=Math.max(20,Math.min(360,e)),this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.emit("tempoChange",{bpm:this.bpm})}setTimeSignature(e,t){this.timeSignature=[e,t],this.barDuration=this.beatDuration*e,this.emit("timeSignatureChange",{timeSignature:this.timeSignature})}setPattern(e){if(!this.patterns.has(e))return;const t=this.patterns.get(e);this.currentPattern=e,t.timeSignature&&this.setTimeSignature(...t.timeSignature),void 0!==t.groove&&(this.groove=t.groove),this.emit("patternChange",{pattern:e})}onBeatCallback(e){return this.beatCallbacks.add(e),()=>this.beatCallbacks.delete(e)}onBarCallback(e){return this.barCallbacks.add(e),()=>this.barCallbacks.delete(e)}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(e=>e(t))}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.has(e)&&this.listeners.get(e).delete(t)}}syncToAudio(e,t){this.audioSync={context:e,source:t}}getAdapter(){return{getTimeInfo:()=>this.getTimeInfo(),isOnBeat:(e=.1)=>this.beatProgress<e||this.beatProgress>1-e,isOnSubdivision:(e,t=.1)=>{const i=this.subdivisions[e]||0;return i<t||i>1-t},getBeatSync:(e=0,t=1,i="linear")=>{let n=this.beatProgress;switch(i){case"ease":n=.5-Math.cos(n*Math.PI)/2;break;case"bounce":n=Math.abs(Math.sin(n*Math.PI));break;case"pulse":n=Math.pow(Math.sin(n*Math.PI),2)}return e+(t-e)*n},getAccentedValue:(e,t=2)=>e*(1+(this.getAccent(this.currentBeat%this.timeSignature[0])-.5)*t),onBeat:e=>this.onBeatCallback(e),onBar:e=>this.onBarCallback(e),beatsToMs:e=>e*this.beatDuration,msToBeats:e=>e/this.beatDuration,isPlaying:()=>this.isPlaying,getBPM:()=>this.bpm,getPattern:()=>this.currentPattern}}},W=new class{constructor(){this.enabled=!1,this.adapter=null,this.subsystemConfigs=new Map,this.activeModulations=new Map}initialize(){this.adapter=j.getAdapter(),this.enabled=!0,this.adapter.onBeat(this.handleBeat.bind(this)),this.adapter.onBar(this.handleBar.bind(this))}updateBPM(e){if(e>=60&&e<=220){if(window.rhythmManuallyStoppedForCurrentAudio)return;if(!j.isRunning)return this.start(e,"straight"),void(window.rhythmSyncVisualizer&&!window.rhythmSyncVisualizer.state.active&&window.rhythmSyncVisualizer.start());j.setBPM(e)}}registerConfig(e,t,i){if(!i.rhythm||!i.rhythm.enabled)return;const n=`${e}:${t}`;this.subsystemConfigs.set(n,{type:e,name:t,rhythmConfig:i.rhythm,originalConfig:i})}applyGestureRhythm(e,t,i,n){if(!this.enabled||!e.rhythm?.enabled)return{};const s=e.rhythm,r={};if(s.amplitudeSync){const e=s.amplitudeSync,t=this.adapter.getBeatSync(e.offBeat||.8,e.onBeat||1.5,e.curve||"linear");r.amplitudeMultiplier=t}if(s.wobbleSync){const e=s.wobbleSync;this.adapter.isOnSubdivision(e.subdivision,.1)?r.wobbleMultiplier=1+e.intensity:r.wobbleMultiplier=1}if(s.accentResponse?.enabled){const e=this.adapter.getAccentedValue(1,s.accentResponse.multiplier||1.5);r.accentMultiplier=e}const a=this.adapter.getPattern();return a&&s.patternOverrides?.[a]&&Object.assign(r,s.patternOverrides[a]),r}applyParticleRhythm(e,t){if(!this.enabled||!e.rhythm?.enabled)return{};const i=this.adapter.getTimeInfo(),n=e.rhythm,s={};if(n.particleEmission){const e=n.particleEmission;"beat"===e.syncMode&&this.adapter.isOnBeat(.1)?s.emitBurst=e.burstSize||3:void 0!==e.offBeatRate&&(s.emissionRate=e.offBeatRate)}if(n.glowSync){const e=n.glowSync,t=this.adapter.getBeatSync(e.intensityRange[0]||1,e.intensityRange[1]||2,"pulse");s.glowIntensity=t}if("bars"===n.breathSync?.mode){const e=n.breathSync,t=i.bar%e.barsPerBreath/e.barsPerBreath;s.breathPhase=t*Math.PI*2}return s}applyBehaviorRhythm(e,t,i){if(!this.enabled||!e.rhythm?.enabled)return{};const n=this.adapter.getTimeInfo(),s=e.rhythm,r={};if(s.glitchTiming){const e=s.glitchTiming;if(this.adapter.isOnSubdivision(e.subdivision,.05)&&Math.random()<e.probability){const t=this.adapter.isOnBeat()?e.intensityOnBeat:e.intensityOffBeat;r.triggerGlitch=!0,r.glitchIntensity=t}}if(s.orbitRhythm){const e=s.orbitRhythm;"tempo"===e.baseSpeed&&(r.speedMultiplier=this.adapter.getBPM()/120),e.beatAcceleration&&this.adapter.isOnBeat(.1)&&(r.speedBoost=e.beatAcceleration),e.barReset&&0===n.beatInBar&&(r.resetOrbit=!0)}if(s.stutterSync){const e=s.stutterSync,t=this.adapter.getPattern();if(t&&e.patterns?.[t]){const i=e.patterns[t];i.freezeOnDrop&&2===n.beatInBar?(r.freeze=!0,r.freezeDuration=i.dropDuration):i.randomFreeze&&Math.random()<i.randomFreeze&&(r.freeze=!0,r.freezeDuration=i.duration)}}return r}handleBeat(e){this.lastBeatInfo=e}handleBar(e){this.lastBarInfo=e}getMusicalDuration(e,t){if(!this.enabled||!e?.durationSync)return t;const i=e.durationSync;return"bars"===i.mode?this.adapter.beatsToMs(4*i.bars):"beats"===i.mode?this.adapter.beatsToMs(i.beats):t}isEnabled(){return this.enabled&&this.adapter.isPlaying()}start(e=120,t="straight"){e&&j.setBPM(e),t&&j.setPattern(t),j.start(),this.enabled=!0}stop(){j.stop(),this.enabled=!1,this.bpmLocked=!1,this.lockedBPM=null}setPattern(e){j.setPattern(e)}setBPM(e){j.setBPM(e),this.bpmLocked&&(this.lockedBPM=e)}resampleBPM(){this.bpmLocked=!1,this.lockedBPM=null}setTimeSignature(e){this.timeSignature=e;const t=document.getElementById("time-sig-display");t&&(t.textContent=e),"3/4"===e&&j.getPattern()}syncToAudio(e,t){j.syncToAudio(e,t)}};function N(e){if(!e||0===e.length)return"#FFFFFF";let t=0,i=0;const n=[];for(const s of e)"string"==typeof s?(n.push({color:s,weight:null}),i++):s&&"object"==typeof s&&s.color&&(n.push({color:s.color,weight:s.weight||null}),s.weight?t+=s.weight:i++);const s=Math.max(0,100-t),r=i>0?s/i:0,a=[];let o=0;for(const e of n)o+=null!==e.weight?e.weight:r,a.push({color:e.color,threshold:o});const c=Math.random()*o;for(const e of a)if(c<=e.threshold)return e.color;return n[n.length-1].color}var U={name:"ambient",emoji:"☁️",description:"Gentle upward drift like smoke",initialize:function(e){e.vx=0,e.vy=-.04-.02*Math.random(),e.lifeDecay=.002,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={upwardSpeed:5e-4,waviness:0,friction:.998}},update:function(e,t,i,n){const s=e.behaviorData;e.vy*=Math.pow(s.friction,t),e.vy-=s.upwardSpeed*t,e.vx=0}};const V=2*Math.PI;var Y={name:"orbiting",emoji:"💕",description:"Romantic firefly dance around the orb",initialize:function(e){e.lifeDecay=.001+.002*Math.random(),e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.isSparkle="#FFE4E1"===e.color||"#FFCCCB"===e.color||"#FFC0CB"===e.color;const t=40*(e.scaleFactor||1)*(1.3+.9*Math.random());e.blinkPhase=Math.random()*V,e.blinkSpeed=.3+1.2*Math.random(),e.blinkIntensity=.6+.4*Math.random(),e.fadePhase=Math.random()*V,e.fadeSpeed=.1+.3*Math.random(),e.minOpacity=.2+.2*Math.random(),e.maxOpacity=.8+.2*Math.random(),e.isSparkle&&(e.blinkSpeed*=2,e.blinkIntensity=1,e.minOpacity=0,e.maxOpacity=1),e.behaviorData={angle:Math.random()*V,radius:t,baseRadius:t,angularVelocity:8e-4+.0017*Math.random(),swayAmount:3+7*Math.random(),swaySpeed:.2+.5*Math.random(),floatOffset:Math.random()*V,floatSpeed:.3+.7*Math.random(),floatAmount:2+6*Math.random(),twinklePhase:Math.random()*V,twinkleSpeed:2+3*Math.random()}},update:function(e,t,i,n){const s=e.behaviorData;s.angle+=s.angularVelocity*t;const r=Math.sin(s.angle*s.swaySpeed)*s.swayAmount,a=6*Math.sin(1.5*s.angle),o=(s.radius||s.baseRadius)+a+.2*r,c=i+Math.cos(s.angle)*o,l=n+Math.sin(s.angle)*o;s.floatOffset+=s.floatSpeed*t*.001;const h=Math.sin(s.floatOffset)*s.floatAmount;e.vx=.1*(c-e.x),e.vy=.1*(l+h-e.y),e.fadePhase+=e.fadeSpeed*t*.001;const u=.5*Math.sin(e.fadePhase)+.5,d=e.minOpacity+(e.maxOpacity-e.minOpacity)*u;let p;e.blinkPhase+=e.blinkSpeed*t*.002,e.isSparkle?(s.twinklePhase+=s.twinkleSpeed*t*.001,p=.7*Math.pow(Math.sin(s.twinklePhase),16)+.2*Math.sin(5*e.blinkPhase)+.1):p=.4*Math.sin(e.blinkPhase)+.3*Math.sin(3*e.blinkPhase)+.2*Math.sin(7*e.blinkPhase)+.1*Math.sin(11*e.blinkPhase);const m=.5*(p+1),g=.2+m*e.blinkIntensity*.8;e.opacity=e.baseOpacity*d*g,e.isSparkle?e.size=e.baseSize*(.5+1*m):e.size=e.baseSize*(.8+.3*m),e.isSparkle&&(e.tempColor=m>.85?"#FFFFFF":e.color)}},X={name:"rising",emoji:"🎈",description:"Buoyant upward movement like balloons",initialize:function(e){e.vx=.02*(Math.random()-.5),e.vy=-.05-.03*Math.random(),e.lifeDecay=.002,e.baseOpacity=.7+.3*Math.random(),e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={buoyancy:.001,driftAmount:.005}},update:function(e,t,i,n){const s=e.behaviorData;e.vy-=s.buoyancy*t,e.vx+=(Math.random()-.5)*s.driftAmount*t,e.vx*=Math.pow(.995,t),e.vy*=Math.pow(.998,t)}},Q={name:"falling",emoji:"💧",description:"Heavy downward drift like tears",initialize:function(e){e.vx=.03*(Math.random()-.5),e.vy=.05+.05*Math.random(),e.lifeDecay=.002,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={gravity:.002,drag:.995}},update:function(e,t,i,n){const s=e.behaviorData;e.vy+=s.gravity*t,e.vx*=Math.pow(s.drag,t),e.vy*=Math.pow(s.drag,t),e.vy>2&&(e.vy=2)}};const J=2e3,K=3,Z=8,ee=.7;var te={name:"popcorn",emoji:"🍿",description:"Spontaneous popping with gravity and bounces",initialize:function(e){if(e.vx=.1*(Math.random()-.5),e.vy=.1*(Math.random()-.5),e.lifeDecay=.008+.012*Math.random(),e.emotionColors&&e.emotionColors.length>0)e.color=N(e.emotionColors);else{const t=["#FFFFFF","#FFFACD","#FFF8DC","#FFFFE0","#FAFAD2"];e.color=N(t)}e.size=Math.random()<.3?(8+4*Math.random())*e.scaleFactor*e.particleSizeMultiplier:(2+4*Math.random())*e.scaleFactor*e.particleSizeMultiplier,e.baseSize=e.size,e.hasGlow=Math.random()<.2,e.glowSizeMultiplier=e.hasGlow?1.2:0,e.behaviorData={popDelay:Math.random()*J,hasPopped:!1,popStrength:K+Math.random()*(Z-K),gravity:.098,bounceDamping:ee,bounceCount:0,maxBounces:2+Math.floor(2*Math.random()),spinRate:10*(Math.random()-.5),lifetime:0}},update:function(e,t,i,n){const s=e.behaviorData;if(s.lifetime+=16.67*t,!s.hasPopped&&s.lifetime>s.popDelay){s.hasPopped=!0;const t=Math.random()*Math.PI*2;e.vx=Math.cos(t)*s.popStrength*1.5,e.vy=Math.sin(t)*s.popStrength-.3,e.size=1.25*e.baseSize}if(s.hasPopped){e.vy+=s.gravity*t;const i=n+100*e.scaleFactor;e.y>i&&s.bounceCount<s.maxBounces&&(e.y=i,e.vy=-Math.abs(e.vy)*s.bounceDamping,e.vx*=.9,s.bounceCount++,e.size=e.baseSize*(1.5-.1*s.bounceCount)),s.bounceCount>=s.maxBounces&&(e.lifeDecay=.03+.02*Math.random(),e.size*=.95),Math.sqrt(e.vx*e.vx+e.vy*e.vy)<.5&&(e.lifeDecay*=1.5)}}},ie={name:"burst",emoji:"💥",description:"Explosive expansion from center",initialize:function(e){const t="suspicion"===e.emotion,i="surprise"===e.emotion,n="glitch"===e.emotion,s=Math.random()*V,r=t?1+.8*Math.random():i?7+5*Math.random():n?2+1.5*Math.random():3.5+2.5*Math.random();e.vx=Math.cos(s)*r,e.vy=Math.sin(s)*r,e.lifeDecay=t?.01:i?.006+.008*Math.random():n?.012:.015,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),t&&(e.size=(6+4*Math.random())*(e.scaleFactor||1)*(e.particleSizeMultiplier||1),e.baseSize=e.size,e.opacity=1,e.baseOpacity=e.opacity),e.behaviorData={isSuspicion:t,isSurprise:i,isGlitch:n,age:0,fadeStart:t?.3:.2,glitchPhase:Math.random()*Math.PI*2,glitchIntensity:n?.3:0,glitchFrequency:n?.1:0}},update:function(e,t,i,n){const s=e.behaviorData;if(s.isSurprise)if(s.age+=.016*t,s.age<.15){const i=.98;e.vx*=Math.pow(i,t),e.vy*=Math.pow(i,t)}else if(s.age<.25){const i=.85;e.vx*=Math.pow(i,t),e.vy*=Math.pow(i,t)}else{const i=.99;e.vx*=Math.pow(i,t),e.vy*=Math.pow(i,t),e.vx+=.01*(Math.random()-.5)*t,e.vy+=.01*(Math.random()-.5)*t}else{const i=s.isSuspicion?.99:s.isGlitch?.97:.95;e.vx*=Math.pow(i,t),e.vy*=Math.pow(i,t)}if(s.isSuspicion){const i=.001*Date.now();e.vx+=.01*Math.sin(2*i+e.id)*t}if(s.isGlitch){s.age+=.016*t,s.glitchPhase+=s.glitchFrequency*t;const i=Math.sin(s.glitchPhase)*s.glitchIntensity*t,n=Math.cos(1.3*s.glitchPhase)*s.glitchIntensity*t;if(e.vx+=i,e.vy+=n,Math.random()<.02){const t=Math.random()*Math.PI*2,i=.5+.5*Math.random();e.vx+=Math.cos(t)*i,e.vy+=Math.sin(t)*i}}}},ne={name:"aggressive",emoji:"⚡",description:"Sharp, chaotic movement with violent bursts",initialize:function(e){const t=Math.random()*V,i=1.5+2*Math.random();e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,e.lifeDecay=.015,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={acceleration:.05,jitter:.3,speedDecay:.95}},update:function(e,t,i,n){const s=e.behaviorData;if(e.vx+=(Math.random()-.5)*s.jitter*t,e.vy+=(Math.random()-.5)*s.jitter*t,e.vx*=Math.pow(s.speedDecay,t),e.vy*=Math.pow(s.speedDecay,t),Math.random()<Math.min(.05*t,.5)){const t=Math.random()*V;e.vx+=Math.cos(t)*s.acceleration,e.vy+=Math.sin(t)*s.acceleration}}},se={name:"scattering",emoji:"😨",description:"Particles flee from center in panic",initialize:function(e){e.vx=0,e.vy=0,e.lifeDecay=.008,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={fleeSpeed:2,panicFactor:1.2,initialized:!1}},update:function(e,t,i,n){const s=e.behaviorData;if(!s.initialized){const t=e.x-i,r=e.y-n,a=Math.sqrt(t*t+r*r);if(a>0)e.vx=t/a*s.fleeSpeed,e.vy=r/a*s.fleeSpeed;else{const t=Math.random()*V;e.vx=Math.cos(t)*s.fleeSpeed,e.vy=Math.sin(t)*s.fleeSpeed}s.initialized=!0}const r=e.x-i,a=e.y-n,o=Math.sqrt(r*r+a*a);o>0&&(e.vx+=r/o*s.panicFactor*.01*t,e.vy+=a/o*s.panicFactor*.01*t),e.vx+=.1*(Math.random()-.5)*t,e.vy+=.1*(Math.random()-.5)*t,e.vx*=Math.pow(.98,t),e.vy*=Math.pow(.98,t)}},re={name:"repelling",emoji:"🚫",description:"Particles pushed away from center, maintaining distance",initialize:function(e){e.vx=0,e.vy=0,e.lifeDecay=.01,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={repelStrength:.8,minDistance:50,initialized:!1}},update:function(e,t,i,n){const s=e.behaviorData,r=e.x-i,a=e.y-n,o=Math.sqrt(r*r+a*a);if(!s.initialized||o<s.minDistance){if(o>0){const i=s.repelStrength/Math.max(o,5);e.vx+=r/o*i*t,e.vy+=a/o*i*t}s.initialized=!0}e.vx*=Math.pow(.99,t),e.vy*=Math.pow(.99,t)}},ae={name:"connecting",emoji:"🔗",description:"Chaotic movement with center attraction for social states",initialize:function(e){const t=Math.random()*V,i=2+5*Math.random();e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,e.lifeDecay=.012,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={attractionForce:.008,chaosFactor:1,friction:.95}},update:function(e,t,i,n){const s=e.behaviorData;e.vx*=Math.pow(s.friction,t),e.vy*=Math.pow(s.friction,t);const r=(i-e.x)*s.attractionForce,a=(n-e.y)*s.attractionForce,o=(Math.random()-.5)*s.chaosFactor,c=(Math.random()-.5)*s.chaosFactor;e.vx+=r+o,e.vy+=a+c}},oe={name:"resting",emoji:"😴",description:"Ultra-slow vertical drift for deep rest states",initialize:function(e){e.vx=0,e.vy=-.01,e.lifeDecay=.001,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={upwardSpeed:2e-5,friction:.999}},update:function(e,t,i,n){const s=e.behaviorData;e.vy*=Math.pow(s.friction,t),e.vy-=s.upwardSpeed*t,e.vx=0}},ce={name:"radiant",emoji:"☀️",description:"Particles radiate outward like sunbeams",initialize:function(e){const t=Math.random()*V,i=.8+.4*Math.random();if(e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,e.lifeDecay=.006,e.emotionColors&&e.emotionColors.length>0)e.color=N(e.emotionColors);else{const t=["#FFD700","#FFB347","#FFA500","#FF69B4"];e.color=N(t)}e.hasGlow=Math.random()<.7,e.glowSizeMultiplier=e.hasGlow?1.5+.5*Math.random():0,e.behaviorData={radialSpeed:.02,shimmer:Math.random()*V,shimmerSpeed:.1,friction:.99}},update:function(e,t,i,n){const s=e.behaviorData,r=e.x-i,a=e.y-n,o=Math.sqrt(r*r+a*a);if(o>0){const i=r/o,n=a/o;e.vx+=i*s.radialSpeed*t,e.vy+=n*s.radialSpeed*t}s.shimmer+=s.shimmerSpeed*t;const c=Math.sin(s.shimmer);e.size=e.baseSize*(1+.2*c),e.opacity=e.baseOpacity*(1+.3*c),e.vx*=Math.pow(s.friction,t),e.vy*=Math.pow(s.friction,t)}};function le(e){e.vx=.02*(Math.random()-.5),e.vy=-.03-.02*Math.random(),e.lifeDecay=8e-4,e.size=(6+6*Math.random())*(e.scaleFactor||1)*(e.particleSizeMultiplier||1)*1.33,e.baseSize=e.size,e.baseOpacity=.2+.2*Math.random(),e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={ascensionSpeed:3e-4,waveFactor:.5,waveFrequency:.001,friction:.998,fadeStartDistance:100}}var he={name:"ascending",emoji:"🧘",description:"Slow steady upward float like incense smoke",initialize:le,update:function(e,t,i,n){const s=e.behaviorData;if(!s)return void le(e);e.vx*=Math.pow(s.friction,t),e.vy*=Math.pow(s.friction,t),e.vy-=s.ascensionSpeed*t;const r=Math.sin(e.age*s.waveFrequency*1e3)*s.waveFactor;e.vx+=.001*r*t,void 0===e.initialY&&(e.initialY=e.y);const a=e.initialY-e.y;if(a>s.fadeStartDistance){const t=(a-s.fadeStartDistance)/100,i=Math.max(0,1-t);e.baseOpacity*=.995,i<.5&&(e.lifeDecay*=1.02)}Math.abs(e.vx)>.05&&(e.vx*=Math.pow(.95,t)),e.vy<-.1&&(e.vy=-.1)}},ue={name:"erratic",emoji:"😰",description:"Nervous jittery movement for anxious states",initialize:function(e){const t=Math.random()*V,i=.1+.15*Math.random();e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,e.lifeDecay=.004,e.size=(2+4*Math.random())*(e.scaleFactor||1)*(e.particleSizeMultiplier||1),e.baseSize=e.size,e.baseOpacity=.4+.3*Math.random(),e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={jitterStrength:.02,directionChangeRate:.1,speedVariation:.3,spinRate:.05+.1*Math.random()}},update:function(e,t){const i=e.behaviorData;if(e.vx+=(Math.random()-.5)*i.jitterStrength*t,e.vy+=(Math.random()-.5)*i.jitterStrength*t,Math.random()<Math.min(i.directionChangeRate*t,.5)){const t=Math.random()*V,i=Math.sqrt(e.vx*e.vx+e.vy*e.vy);e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i}const n=1+(Math.random()-.5)*i.speedVariation*t;e.vx*=n,e.vy*=n;const s=e.age*i.spinRate*1e3;e.size=e.baseSize*(1+.2*Math.sin(s)),e.opacity=e.baseOpacity*(.8+.4*Math.random()),e.vx*=Math.pow(.98,t),e.vy*=Math.pow(.98,t);const r=Math.sqrt(e.vx*e.vx+e.vy*e.vy);r>.5&&(e.vx=e.vx/r*.5,e.vy=e.vy/r*.5)}},de={name:"cautious",emoji:"🤨",description:"Slow careful movement with watchful pauses",initialize:function(e){const t=Math.random()*V,i=.02+.03*Math.random();e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,e.lifeDecay=.001,e.life=1,e.size=(4+4*Math.random())*(e.scaleFactor||1)*(e.particleSizeMultiplier||1),e.baseSize=e.size,e.baseOpacity=.8+.2*Math.random(),e.opacity=e.baseOpacity,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={pauseTimer:2*Math.random(),pauseDuration:.5+.5*Math.random(),moveDuration:1+.5*Math.random(),isMoving:Math.random()>.5,moveTimer:0,originalVx:e.vx,originalVy:e.vy,watchRadius:50+30*Math.random()}},update:function(e,t,i,n){const s=e.behaviorData;if(s.moveTimer+=t,s.isMoving)s.moveTimer>s.moveDuration?(s.isMoving=!1,s.moveTimer=0,e.vx=0,e.vy=0):(e.vx=s.originalVx,e.vy=s.originalVy);else if(s.moveTimer>s.pauseDuration){s.isMoving=!0,s.moveTimer=0;const t=Math.random()*V,i=.02+.03*Math.random();e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i,s.originalVx=e.vx,s.originalVy=e.vy}const r=e.x-i,a=e.y-n,o=Math.sqrt(r*r+a*a);if(o>s.watchRadius){const i=.02;e.vx-=r/o*i*t,e.vy-=a/o*i*t}e.vx*=Math.pow(.995,t),e.vy*=Math.pow(.995,t),s.isMoving?e.opacity=e.baseOpacity:e.opacity=e.baseOpacity*(.9+.1*Math.sin(5*e.age))}},pe={name:"surveillance",emoji:"👁️",description:"Searchlight scanning with paranoid watchfulness",initialize(e,t){e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorState={scanAngle:Math.random()*Math.PI-Math.PI/2,scanDirection:Math.random()<.5?1:-1,scanSpeed:.3+.2*Math.random(),scanRange:Math.PI/3+Math.random()*Math.PI/4,scanCenter:Math.random()*Math.PI*2,pauseTimer:0,pauseDuration:500+500*Math.random(),mode:"scanning",modeTimer:0,nextModeChange:2e3+3e3*Math.random(),dartTarget:{x:0,y:0},dartSpeed:0,patrolRadius:150+100*Math.random(),patrolAngle:Math.random()*Math.PI*2,alertLevel:0,lastPosition:{x:e.x,y:e.y}};const i=Math.random();i<.7?e.behaviorState.primaryRole="scanner":i<.9?(e.behaviorState.primaryRole="patroller",e.behaviorState.mode="patrolling"):(e.behaviorState.primaryRole="watcher",e.behaviorState.mode="frozen")},update(e,t,i){const n=e.behaviorState;if(n){switch(n.modeTimer+=16*t,n.modeTimer>n.nextModeChange&&(this.changeMode(e,n),n.modeTimer=0,n.nextModeChange=2e3+4e3*Math.random()),n.mode){case"scanning":this.updateScanning(e,t,n,i);break;case"darting":this.updateDarting(e,t,n,i);break;case"frozen":this.updateFrozen(e,t,n,i);break;case"patrolling":this.updatePatrolling(e,t,n,i)}e.vy+=.05*t,e.x+=e.vx*t,e.y+=e.vy*t,n.lastPosition.x=e.x,n.lastPosition.y=e.y}},updateScanning(e,t,i,n){i.pauseTimer>0?(i.pauseTimer-=16*t,e.vx*=.9,e.vy*=.9):(i.scanAngle+=i.scanDirection*i.scanSpeed*t*.02,Math.abs(i.scanAngle)>i.scanRange/2&&(i.scanDirection*=-1,i.pauseTimer=i.pauseDuration,i.scanAngle=Math.sign(i.scanAngle)*i.scanRange/2));const s=i.scanCenter+i.scanAngle,r=.8+.5*i.alertLevel;e.vx=Math.cos(s)*r,e.vy=Math.sin(s)*r*.3},updateDarting(e,t,i,n){const s=i.dartTarget.x-e.x,r=i.dartTarget.y-e.y,a=Math.sqrt(s*s+r*r);a>5?(e.vx=s/a*i.dartSpeed,e.vy=r/a*i.dartSpeed):(i.mode="scanning",i.modeTimer=0)},updateFrozen(e,t,i,n){e.vx*=.95,e.vy*=.95,Math.random()<.01&&(e.vx+=.5*(Math.random()-.5),e.vy+=.5*(Math.random()-.5))},updatePatrolling(e,t,i,n){i.patrolAngle+=.01*t;const s=Math.cos(i.patrolAngle)*i.patrolRadius,r=Math.sin(i.patrolAngle)*i.patrolRadius,a=s-e.x,o=r-e.y;e.vx=.02*a,e.vy=.02*o},changeMode(e,t){const i=Math.random();"scanner"===t.primaryRole?i<.1?(t.mode="darting",t.dartTarget={x:200*(Math.random()-.5),y:200*(Math.random()-.5)},t.dartSpeed=3+2*Math.random()):t.mode=i<.2?"frozen":"scanning":"patroller"===t.primaryRole?t.mode=i<.1?"frozen":"patrolling":t.mode=i<.3?"scanning":"frozen"}},me={name:"glitchy",emoji:"⚡",description:"Digital glitch with stuttering orbits and corruption",rhythm:{enabled:!0,glitchTiming:{mode:"subdivision",subdivision:"sixteenth",probability:.3,intensityOnBeat:2,intensityOffBeat:.5},stutterSync:{mode:"pattern",patterns:{dubstep:{freezeOnDrop:!0,dropDuration:100},breakbeat:{randomFreeze:.1,duration:50}}},orbitRhythm:{baseSpeed:"tempo",wobbleSync:"eighth",beatAcceleration:1.5,barReset:!0},rgbSync:{enabled:!0,amount:"intensity",direction:"beat",maxSplit:10},noiseRhythm:{trigger:"accent",duration:50,intensity:"drop"}},initialize(e,t,i,n){e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorState={orbitAngle:Math.random()*Math.PI*2,orbitRadius:300+400*Math.random(),orbitSpeed:.01+.02*Math.random(),glitchTimer:0,nextGlitch:500*Math.random()+100,isGlitching:!1,glitchDuration:0,glitchOffset:{x:0,y:0},stutterTimer:0,nextStutter:200*Math.random()+50,isFrozen:!1,frozenPosition:{x:0,y:0},frozenVelocity:{x:0,y:0},hasGhost:Math.random()<.3,ghostOffset:20*Math.random()+10,ghostAngle:Math.random()*Math.PI*2,rgbSplit:Math.random()<.4,rgbPhase:Math.random()*Math.PI*2,noiseLevel:0,noiseBurst:!1,beatPhase:Math.random()*Math.PI*2,beatFrequency:.05+.03*Math.random(),dropIntensity:0},e.lifeDecay=.0015,e.hasGlow=!0,e.glowSizeMultiplier=3+2*Math.random()},update(e,t,i,n){const s=e.behaviorState;if(!s)return;s.glitchTimer+=16*t,s.stutterTimer+=16*t,s.stutterTimer>s.nextStutter&&(s.isFrozen?(s.isFrozen=!1,s.stutterTimer=0,s.nextStutter=100+300*Math.random(),Math.random()<.3&&(e.x+=60*(Math.random()-.5),e.y+=60*(Math.random()-.5))):(s.isFrozen=!0,s.frozenPosition={x:e.x,y:e.y},s.frozenVelocity={x:e.vx,y:e.vy},s.stutterTimer=0,s.nextStutter=20+40*Math.random())),s.glitchTimer>s.nextGlitch&&!s.isGlitching&&(s.isGlitching=!0,s.glitchDuration=50+100*Math.random(),s.glitchOffset={x:80*(Math.random()-.5),y:80*(Math.random()-.5)},s.glitchTimer=0,Math.random()<.5&&e.emotionColors&&(e.color=N(e.emotionColors))),s.isGlitching&&s.glitchTimer>s.glitchDuration&&(s.isGlitching=!1,s.glitchTimer=0,s.nextGlitch=200+800*Math.random(),s.glitchOffset={x:0,y:0}),s.beatPhase+=s.beatFrequency*t;const r=.5*Math.sin(s.beatPhase)+.5;if(s.beatPhase%(4*Math.PI)<.5*Math.PI?s.dropIntensity=Math.min(1,s.dropIntensity+.1*t):s.dropIntensity=Math.max(0,s.dropIntensity-.05*t),s.isFrozen)e.vx=.5*(Math.random()-.5),e.vy=.5*(Math.random()-.5);else{s.orbitAngle+=s.orbitSpeed*t*(1+.5*r);const a=s.orbitRadius*(1+.3*s.dropIntensity*Math.sin(4*s.beatPhase));let o=i+Math.cos(s.orbitAngle)*a,c=n+Math.sin(s.orbitAngle)*a*.6;if(s.isGlitching&&(o+=s.glitchOffset.x*Math.random()*.8,c+=s.glitchOffset.y*Math.random()*.8),s.rgbSplit){const e=3*(1+s.dropIntensity);o+=Math.sin(s.rgbPhase)*e,c+=Math.cos(s.rgbPhase)*e,s.rgbPhase+=.1*t}s.dropIntensity>.8&&Math.random()<.1&&(o+=30*(Math.random()-.5),c+=30*(Math.random()-.5));const l=s.isGlitching?.02:.03;e.vx=(o-e.x)*l,e.vy=(c-e.y)*l,e.vx+=(Math.random()-.5)*r*2,e.vy+=(Math.random()-.5)*r*2}e.x+=e.vx*t,e.y+=e.vy*t,Math.random()<.02&&(e.opacity=.1+.9*Math.random()),e.size=e.baseSize*(1+.3*r+.5*s.dropIntensity)}},ge={name:"spaz",description:"Ultra-aggressive particles with explosive spread and chaotic motion",initialize(e,t,i,n){e.x=i,e.y=n,e.life=1,e.size=3+4*Math.random();const s=Math.random()*Math.PI*2,r=200+300*Math.random();e.vx=Math.cos(s)*r,e.vy=Math.sin(s)*r,e.behaviorState={explosionPhase:0,explosionTimer:0,explosionDuration:1e3+2e3*Math.random(),chaosTimer:0,nextChaosChange:100+200*Math.random(),chaosAngle:s,chaosSpeed:50+100*Math.random(),spazIntensity:.8+.4*Math.random(),zigzagPattern:Math.random()<.5,spiralPattern:Math.random()<.3,teleportChance:.02,sizePulse:!0,sizePulseSpeed:.1+.05*Math.random(),sizePulsePhase:Math.random()*Math.PI*2,colorShift:Math.random()<.3,colorShiftSpeed:.05+.03*Math.random()},e.lifeDecay=8e-4,e.hasGlow=!0,e.glowSizeMultiplier=4+3*Math.random(),e.glowIntensity=1.5+.5*Math.random()},update(e,t,i,n){const s=e.behaviorState;if(s.explosionTimer+=t,s.chaosTimer+=t,0===s.explosionPhase&&s.explosionTimer<500)e.vx*=.98,e.vy*=.98,Math.random()<.1&&(e.vx+=100*(Math.random()-.5),e.vy+=100*(Math.random()-.5));else if(0===s.explosionPhase&&s.explosionTimer>=500)s.explosionPhase=1,s.chaosAngle=Math.random()*Math.PI*2,s.chaosSpeed=30+70*Math.random();else if(1===s.explosionPhase){s.chaosTimer>=s.nextChaosChange&&(s.chaosAngle=Math.random()*Math.PI*2,s.chaosSpeed=20+80*Math.random(),s.nextChaosChange=50+150*Math.random(),s.chaosTimer=0);const t=Math.cos(s.chaosAngle)*s.chaosSpeed,i=Math.sin(s.chaosAngle)*s.chaosSpeed;if(e.vx=.7*e.vx+.3*t,e.vy=.7*e.vy+.3*i,s.zigzagPattern){const t=.01*s.chaosTimer;e.vx+=20*Math.sin(t),e.vy+=20*Math.cos(t)}if(s.spiralPattern){const t=.005*s.chaosTimer,i=50+30*Math.sin(.003*s.chaosTimer);e.vx+=Math.cos(t)*i*.1,e.vy+=Math.sin(t)*i*.1}}if(Math.random()<s.teleportChance){const t=Math.random()*Math.PI*2,s=200+400*Math.random();e.x=i+Math.cos(t)*s,e.y=n+Math.sin(t)*s,e.vx=200*(Math.random()-.5),e.vy=200*(Math.random()-.5)}if(e.x+=e.vx*(t/1e3),e.y+=e.vy*(t/1e3),s.sizePulse){s.sizePulsePhase+=s.sizePulseSpeed*t;const i=1+.5*Math.sin(s.sizePulsePhase);e.size=(3+4*Math.random())*i}s.colorShift&&(s.colorShiftPhase=(s.colorShiftPhase||0)+s.colorShiftSpeed*t),e.vx*=.995,e.vy*=.995,e.life-=e.lifeDecay*t,(e.life<=0||Math.abs(e.x-i)>2e3||Math.abs(e.y-n)>2e3)&&(e.life=0)},getSpawnPosition(e,t){const i=Math.random()*Math.PI*2,n=100+200*Math.random();return{x:e+Math.cos(i)*n,y:t+Math.sin(i)*n}},getVisualProperties:()=>({glowColor:"#FF00AA",glowIntensity:2,particleColors:[{color:"#FF00AA",weight:30},{color:"#00FFAA",weight:25},{color:"#FFAA00",weight:20},{color:"#AA00FF",weight:15},{color:"#00AAFF",weight:10}]})},fe={name:"directed",emoji:"🎯",description:"Focused, straight-line movement toward target",config:{speed:3,acceleration:.15,focusStrength:.8,randomness:.1,edgeBuffer:50},initialize(e,t,i,n,s){const r=t-e.x,a=i-e.y,o=Math.sqrt(r*r+a*a);if(o>0)e.vx=r/o*this.config.speed,e.vy=a/o*this.config.speed;else{const t=Math.random()*Math.PI*2;e.vx=Math.cos(t)*this.config.speed,e.vy=Math.sin(t)*this.config.speed}e.targetX=t,e.targetY=i,e.directedPhase=0},update(e,t,i,n,s,r){e.directedPhase+=.05*t;const a=e.targetX-e.x,o=e.targetY-e.y,c=Math.sqrt(a*a+o*o);if(c>10){const i=a/c*this.config.speed,n=o/c*this.config.speed;e.vx+=(i-e.vx)*this.config.acceleration*t,e.vy+=(n-e.vy)*this.config.acceleration*t,e.vx+=(Math.random()-.5)*this.config.randomness,e.vy+=(Math.random()-.5)*this.config.randomness}else{const t=Math.random()*Math.PI*2,a=100+200*Math.random();e.targetX=i+Math.cos(t)*a,e.targetY=n+Math.sin(t)*a,e.targetX=Math.max(this.config.edgeBuffer,Math.min(s-this.config.edgeBuffer,e.targetX)),e.targetY=Math.max(this.config.edgeBuffer,Math.min(r-this.config.edgeBuffer,e.targetY))}e.x+=e.vx*t,e.y+=e.vy*t,(e.x<=0||e.x>=s)&&(e.vx*=-.8,e.x=Math.max(0,Math.min(s,e.x)),e.targetX=i+300*(Math.random()-.5)),(e.y<=0||e.y>=r)&&(e.vy*=-.8,e.y=Math.max(0,Math.min(r,e.y)),e.targetY=n+300*(Math.random()-.5))},visuals:{trailLength:"medium",opacity:.9,sizeMultiplier:1,blurAmount:.2}},ye={name:"fizzy",emoji:"🫧",description:"Bubbly, effervescent movement like carbonation",config:{baseRiseSpeed:2.5,wobbleAmplitude:30,wobbleFrequency:.15,popChance:.002,popForce:8,fizziness:.3,gravity:-.05},initialize(e,t,i,n,s){e.vx=2*(Math.random()-.5),e.vy=-this.config.baseRiseSpeed-2*Math.random(),e.wobblePhase=Math.random()*Math.PI*2,e.wobbleSpeed=this.config.wobbleFrequency*(.8+.4*Math.random()),e.bubbleSize=.5+.5*Math.random(),e.popTimer=0,e.isFizzing=!0},update(e,t,i,n,s,r){e.wobblePhase+=e.wobbleSpeed*t;const a=Math.sin(e.wobblePhase)*this.config.wobbleAmplitude;if(e.vx=.05*a+(Math.random()-.5)*this.config.fizziness,e.vy+=this.config.gravity*t,e.vy+=(Math.random()-.5)*this.config.fizziness,Math.random()<this.config.popChance){const t=Math.random()*Math.PI*2;e.vx=Math.cos(t)*this.config.popForce,e.vy=Math.sin(t)*this.config.popForce*.7,e.popTimer=1,e.bubbleSize=.3+.7*Math.random()}e.popTimer>0&&(e.popTimer-=.05*t,e.vx*=.95,e.vy*=.95),e.x+=e.vx*t,e.y+=e.vy*t,e.y<-50&&(e.y=r+50,e.x=i+300*(Math.random()-.5),e.vy=-this.config.baseRiseSpeed-2*Math.random(),e.bubbleSize=.5+.5*Math.random()),(e.x<=0||e.x>=s)&&(e.vx*=-.5,e.x=Math.max(0,Math.min(s,e.x))),e.y>r+50&&(e.y=r,e.vy=1.5*-this.config.baseRiseSpeed),e.size=e.baseSize*e.bubbleSize*(1+.1*Math.sin(2*e.wobblePhase))},visuals:{trailLength:"short",opacity:.6,sizeMultiplier:1.2,blurAmount:.5,sparkle:!0}};var ve={name:"zen",emoji:"☯️",description:"Peaceful orbital movement like a hovering aura",initialize:function(e){e.vx=.5*(Math.random()-.5),e.vy=.5*(Math.random()-.5),e.lifeDecay=.003,e.emotionColors&&e.emotionColors.length>0&&(e.color=N(e.emotionColors)),e.behaviorData={orbitAngle:Math.random()*Math.PI*2,orbitRadius:40+60*Math.random(),orbitSpeed:8e-4+6e-4*Math.random(),floatOffset:Math.random()*Math.PI*2,breathingOffset:Math.random()*Math.PI*2,lifetime:0}},update:function(e,t,i,n){const s=e.behaviorData;if(!s)return;s.lifetime+=t;const r=(s.lifetime+8e3*s.breathingOffset)/8e3,a=.5*Math.sin(r*Math.PI*2)+.5;e.size=e.baseSize*(.95+.05*a),s.orbitAngle+=s.orbitSpeed*t;const o=10*Math.sin(1e-4*s.lifetime+s.floatOffset),c=s.orbitRadius+o,l=i+Math.cos(s.orbitAngle)*c,h=n+Math.sin(s.orbitAngle)*c,u=15*Math.sin(3e-4*s.lifetime+s.breathingOffset),d=l-e.x,p=h+u-e.y;e.vx=.03*d,e.vy=.03*p,e.vx+=.02*(Math.random()-.5),e.vy+=.02*(Math.random()-.5),e.vx*=.98,e.vy*=.98}};const be=new Map;var we={registerPluginBehavior:function(e,t){return be.has(e),!(!t.initialize||"function"!=typeof t.initialize||!t.update||"function"!=typeof t.update||(be.set(e,{name:e,emoji:t.emoji||"🔌",description:t.description||`Plugin behavior: ${e}`,initialize:t.initialize,update:t.update,isPlugin:!0}),0))},unregisterPluginBehavior:function(e){return!!be.has(e)&&(be.delete(e),!0)},getPluginBehavior:function(e){return be.get(e)||null},getAllPluginBehaviors:function(){return Array.from(be.keys())},createLegacyAdapter:function(e){return{name:e.name||"legacy",emoji:"🔄",description:e.description||"Legacy plugin behavior",initialize(t){if(e.size&&(t.size="object"==typeof e.size?e.size.min+Math.random()*(e.size.max-e.size.min):e.size,t.baseSize=t.size),e.speed){const i="object"==typeof e.speed?e.speed.min+Math.random()*(e.speed.max-e.speed.min):e.speed,n=Math.random()*Math.PI*2;t.vx=Math.cos(n)*i,t.vy=Math.sin(n)*i}if(e.lifespan){const i="object"==typeof e.lifespan?e.lifespan.min+Math.random()*(e.lifespan.max-e.lifespan.min):e.lifespan;t.lifeDecay=1e3/i}e.color&&(t.color=Array.isArray(e.color)?N(e.color):e.color),e.opacity&&(t.life="object"==typeof e.opacity?e.opacity.min+Math.random()*(e.opacity.max-e.opacity.min):e.opacity),t.behaviorData={movementType:e.movementType||"linear",turbulence:e.turbulence||0,drift:e.drift||0,acceleration:e.acceleration||0,...e.customData}},update(t,i,n,s){const r=t.behaviorData;switch(r.movementType){case"wander":t.vx+=(Math.random()-.5)*r.turbulence*i,t.vy+=(Math.random()-.5)*r.turbulence*i;break;case"fall":t.vy+=.1*i,t.vx+=(Math.random()-.5)*r.drift*i;break;case"rain":t.vy+=r.acceleration*i;break;case"orbit":{const e=t.x-n,r=t.y-s,a=Math.sqrt(e*e+r*r);if(a>0){const o=Math.atan2(r,e)+.02*i;t.x=n+Math.cos(o)*a,t.y=s+Math.sin(o)*a}break}}e.customUpdate&&e.customUpdate(t,i,n,s)}}}};const Se={};function Me(e){if(Se[e])return Se[e];return we.getPluginBehavior(e)||null}function xe(e,t){const i=Me(t);return i&&i.initialize?(i.initialize(e),!0):"ambient"!==t&&(console.warn(`⚠️ Behavior '${t}' not found, falling back to ambient`),xe(e,"ambient"))}function Ce(e,t,i,n,s){const r=Me(t);return!(!r||!r.update||(r.update(e,i,n,s),0))}function Te(){return[...Object.values(Se).map(e=>({name:e.name,emoji:e.emoji||"🎯",description:e.description||"No description",type:"core"})),...we.getAllPluginBehaviors().map(e=>{const t=we.getPluginBehavior(e);return{name:t.name,emoji:t.emoji||"🔌",description:t.description||"Plugin behavior",type:"plugin"}})]}[U,fe,ye,Y,X,Q,te,ie,ne,se,re,ae,oe,ce,he,ue,de,pe,me,ge,ve].forEach(e=>{Se[e.name]=e}),"undefined"!=typeof window&&window.DEBUG_PARTICLES&&(window.ParticleBehaviors={registry:Se,list:Te,get:Me});var ke={BEHAVIOR_REGISTRY:Se,getBehavior:Me,initializeBehavior:xe,updateBehavior:Ce,listBehaviors:Te,pluginAdapter:we},Ee=Object.freeze({__proto__:null,BEHAVIOR_REGISTRY:Se,default:ke,getBehavior:Me,initializeBehavior:xe,listBehaviors:Te,pluginAdapter:we,updateBehavior:Ce});const Pe=new Map;var _e={registerPluginGesture:function(e,t){return!(!t.apply&&!t.type||(t.name||(t.name=e),t.type||(t.type="blending"),Pe.set(e,t),0))},unregisterPluginGesture:function(e){return!!Pe.has(e)&&(Pe.delete(e),!0)},getPluginGesture:function(e){return Pe.get(e)||null},getAllPluginGestures:function(){return Array.from(Pe.keys())},clearPluginGestures:function(){Pe.clear()},createLegacyAdapter:function(e){return{name:e.name||"unknown",type:e.type||"blending",emoji:e.emoji||"🔌",description:e.description||"Plugin gesture",config:e.config||{},apply(t,i,n,s,r,a){e.animate?e.animate(t,i,n,s,r,a):e.apply&&e.apply(t,i,n,s,r,a)},cleanup:e.cleanup||function(e){e.gestureData&&e.gestureData[this.name]&&delete e.gestureData[this.name]}}}},Ae={name:"bounce",emoji:"⬆️",type:"blending",description:"Vertical oscillation with smooth easing",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:30,frequency:2,axis:"vertical",damping:!0,easing:"sine",strength:.6,particleMotion:{type:"bounce",axis:"vertical",strength:.6,frequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"bounce"},frequencySync:{mode:"tempo",multiplier:1},durationSync:{mode:"beats",beats:4},accentResponse:{enabled:!0,multiplier:1.5},patternOverrides:{waltz:{frequencySync:{multiplier:.75},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:2,offBeat:.4,curve:"ease"}},dubstep:{amplitudeSync:{onBeat:1.5,dropBeat:3,curve:"pulse"}},breakbeat:{frequencySync:{multiplier:1.5},amplitudeSync:{onBeat:2.2,offBeat:.3}}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.bounce={startY:e.y,startX:e.x,startVx:e.vx,startVy:e.vy,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.bounce?.initialized||this.initialize(e,i);const a={...this.config,...i},o=a.strength||this.config.strength||1,c=this.easeInOutCubic(t);let{frequency:l}=a;const h=i.phase||0;let u=a.amplitude*o*e.scaleFactor;i.rhythmModulation&&(u*=i.rhythmModulation.amplitudeMultiplier||1,u*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(l*=i.rhythmModulation.frequencyMultiplier));const d=Math.sin((c+h)*Math.PI*2*l);if(a.damping&&t>.7&&(u*=1-(t-.7)/.3*.8),"vertical"===a.axis?(e.vy+=d*u*.01*n,t>.9&&(e.vx*=.98)):"horizontal"===a.axis&&(e.vx+=d*u*.01*n,t>.9&&(e.vy*=.98)),t>.9){const i=1-10*(t-.9);e.vx=e.vx*(.95+.05*i),e.vy=e.vy*(.95+.05*i)}},cleanup(e){e.gestureData?.bounce&&delete e.gestureData.bounce},easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2},Ie={name:"pulse",emoji:"💗",type:"blending",description:"Radial expansion and contraction from center",config:{duration:600,amplitude:30,frequency:1,holdPeak:.1,easing:"sine",scaleAmount:.2,glowAmount:.3,strength:.15,direction:"outward",particleMotion:{type:"pulse",strength:.15,direction:"outward",frequency:1}},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.6,offBeat:.8,curve:"pulse"},frequencySync:{mode:"locked",subdivision:"quarter"},durationSync:{mode:"beats",beats:1},accentResponse:{enabled:!0,multiplier:2},patternOverrides:{waltz:{amplitudeSync:{onBeat:2,offBeat:.5},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"ease"},frequencySync:{subdivision:"swing"}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:4,curve:"pulse"}},breakbeat:{frequencySync:{mode:"random",range:[.5,2]},amplitudeSync:{onBeat:2.5,offBeat:.3}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n,a=Math.sqrt(s*s+r*r),o=Math.atan2(r,s);e.gestureData.pulse={baseDistance:a,angle:o,startX:e.x,startY:e.y,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.pulse?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.pulse,o={...this.config,...i},c=i.strength||1,l=this.easeInOutSine(t);let h,{frequency:u}=o,{amplitude:d}=o;i.rhythmModulation&&(d*=i.rhythmModulation.amplitudeMultiplier||1,d*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(u*=i.rhythmModulation.frequencyMultiplier));const p=l*u*2%2;h=o.holdPeak>0&&p>1-o.holdPeak&&p<1+o.holdPeak?1:Math.sin(l*Math.PI*2*u);const m=h*d*c*e.scaleFactor,g=a.baseDistance+m,f=s+Math.cos(a.angle)*g,y=r+Math.sin(a.angle)*g,v=.15*n;if(e.vx+=(f-e.x)*v*.1,e.vy+=(y-e.y)*v*.1,t>.9){const i=1-10*(t-.9);e.vx*=.9+.1*i,e.vy*=.9+.1*i}},cleanup(e){e.gestureData?.pulse&&delete e.gestureData.pulse},easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2},Re={name:"shake",emoji:"🫨",type:"blending",description:"Random jitter movement for vibration effects",config:{duration:400,amplitude:15,frequency:15,decay:.9,smoothing:.1,axes:"both",easing:"linear",strength:3,particleMotion:{type:"shake",strength:3,frequency:15,decay:!1}},rhythm:{enabled:!0,syncMode:"subdivision",amplitudeSync:{subdivision:"sixteenth",onBeat:2.5,offBeat:.7,curve:"pulse"},frequencySync:{mode:"tempo",baseFrequency:15,scaling:"linear"},durationSync:{mode:"beats",beats:2},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.2},frequencySync:{mode:"random",range:[8,20]}},dubstep:{amplitudeSync:{subdivision:"eighth",onBeat:4,dropBeat:6,curve:"pulse"}},swing:{amplitudeSync:{onBeat:1.8,offBeat:1,curve:"ease"}}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.shake={originalX:e.x,originalY:e.y,randomAngle:Math.random()*Math.PI*2,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.shake?.initialized||this.initialize(e,i);const a=e.gestureData.shake,o={...this.config,...i},c=o.strength||this.config.strength||1;let{amplitude:l}=o,{frequency:h}=o;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,l*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(h*=i.rhythmModulation.frequencyMultiplier));const u=o.decay?1-t:1,d=Math.sin(t*Math.PI*h)*l*u*c*e.scaleFactor,p=d*Math.cos(a.randomAngle),m=d*Math.sin(a.randomAngle);e.x=a.originalX+p,e.y=a.originalY+m},pseudoRandom(e){const t=1e4*Math.sin(e);return t-Math.floor(t)},cleanup(e){e.gestureData?.shake&&(e.x=e.gestureData.shake.originalX,e.y=e.gestureData.shake.originalY,delete e.gestureData.shake)}},De={name:"nod",emoji:"🙂",type:"blending",description:"Vertical nodding motion",config:{duration:500,amplitude:15,frequency:2,easing:"sine",strength:.4,particleMotion:{type:"bounce",axis:"vertical",strength:.4,frequency:2,phase:0}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!1,priority:5,blendable:!1,minDuration:"halfBar",frequencySync:{mode:"subdivision",subdivision:"half",multiplier:1},amplitudeSync:{onBeat:1.4,offBeat:.8,curve:"ease"},durationSync:{mode:"beats",beats:2},patternOverrides:{waltz:{frequencySync:{subdivision:"quarter"},amplitudeSync:{onBeat:1.6,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.5,offBeat:.9}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:3,curve:"pulse"}}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.nod={startY:e.y,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.nod?.initialized||this.initialize(e,i);const a={...this.config,...i},o=a.strength||this.config.strength||1;let{frequency:c}=a,{amplitude:l}=a;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,l*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(c*=i.rhythmModulation.frequencyMultiplier));const h=Math.sin(t*Math.PI*2*c);l=l*o*e.scaleFactor,e.vy+=h*l*.01*n,t>.9&&(e.vy*=.95)},cleanup(e){e.gestureData?.nod&&delete e.gestureData.nod}},Oe={name:"vibrate",emoji:"📳",type:"blending",description:"High frequency vibration",config:{duration:500,frequency:20,amplitude:8,easing:"linear",strength:2,particleMotion:{type:"shake",strength:2,frequency:20,amplitude:8}},rhythm:{enabled:!0,syncMode:"subdivision",frequencySync:{subdivision:"thirty-second",baseFrequency:20,tempoScaling:!0},amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"pulse"},durationSync:{mode:"beats",beats:1},patternOverrides:{dubstep:{frequencySync:{subdivision:"sixteenth"},amplitudeSync:{onBeat:2,dropBeat:3}},breakbeat:{frequencySync:{mode:"random",range:[15,30]}}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.vibrate={timer:0,seed:1e3*Math.random(),initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.vibrate?.initialized||this.initialize(e,i);const a=e.gestureData.vibrate,o={...this.config,...i},c=o.strength||this.config.strength||1;let{amplitude:l}=o,{frequency:h}=o;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,l*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(h*=i.rhythmModulation.frequencyMultiplier)),a.timer+=n*h;const u=(Math.random()-.5)*l*c,d=(Math.random()-.5)*l*c;if(e.vx+=.5*u*n,e.vy+=.5*d*n,e.vx*=.9,e.vy*=.9,t>.8){const i=1-5*(t-.8);e.vx*=i,e.vy*=i}},cleanup(e){e.gestureData?.vibrate&&delete e.gestureData.vibrate}},ze={name:"orbit",emoji:"🪐",description:"3D orbital motion around center",type:"override",config:{speed:1,rotations:1,zRotations:1,smoothness:.15,verticalOscillation:0,centripetal:!1},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:1,scaling:"linear"},rotationSync:{mode:"bars",rotationsPerBar:1,zSync:!0},radiusSync:{subdivision:"quarter",pulsAmount:.1,curve:"ease"},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{pulsAmount:.15}},swing:{speedSync:{mode:"swing",ratio:.67},verticalOscillation:.2},dubstep:{radiusSync:{subdivision:"eighth",pulsAmount:.3,dropMultiplier:2}},breakbeat:{speedSync:{mode:"random",range:[.5,2]},centripetal:!0}}},apply:function(e,t,i,n,s,r,a){if(!t.initialized){t.originalX=e.x,t.originalY=e.y,t.originalZ=e.z||0,t.originalVx=e.vx||0,t.originalVy=e.vy||0;const n=e.x-r,s=e.y-a;t.radius=Math.sqrt(n*n+s*s),t.radius<50&&(t.radius=50+100*Math.random()),t.initialAngle=Math.atan2(s,n),t.orbitSpeed=i.speed*(.8+.4*Math.random()),t.orbitTilt=.3*Math.random(),t.initialized=!0}let{rotations:o}=i,c=.05;i.rhythmModulation&&(i.rhythmModulation.speedMultiplier&&(t.orbitSpeed*=i.rhythmModulation.speedMultiplier),i.rhythmModulation.rotationMultiplier&&(o*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusPulse&&(c=i.rhythmModulation.radiusPulse));let l=1,h=1;n<.15?(l=n/.15,l=l*l*(3-2*l),h=l):n>.85&&(l=(1-n)/.15,l=l*l*(3-2*l),h=l);const u=t.initialAngle+n*Math.PI*2*o*l,d=1+Math.sin(n*Math.PI*4)*c*l,p=t.radius*s*d*l,m=r+Math.cos(u)*p,g=a+Math.sin(u)*p,f=u*i.zRotations;if(e.z=.8*Math.sin(f)*l+t.originalZ*(1-l),n<.15){const i=.3*l;e.x=t.originalX+(m-t.originalX)*i,e.y=t.originalY+(g-t.originalY)*i;const n=-Math.sin(u)*p*t.orbitSpeed,s=Math.cos(u)*p*t.orbitSpeed;e.vx=t.originalVx+(n-t.originalVx)*h,e.vy=t.originalVy+(s-t.originalVy)*h}else if(n>.85){e.x=m+(t.originalX-m)*(1-l),e.y=g+(t.originalY-g)*(1-l);const i=-Math.sin(u)*p*t.orbitSpeed,n=Math.cos(u)*p*t.orbitSpeed;e.vx=i*h+t.originalVx*(1-h),e.vy=n*h+t.originalVy*(1-h)}else{if(i.verticalOscillation>0){const t=Math.sin(2*u)*i.verticalOscillation*s;e.y=g+t,e.x=m}else{const t=i.smoothness||.1;e.x+=(m-e.x)*t,e.y+=(g-e.y)*t}e.vx=-Math.sin(u)*p*t.orbitSpeed,e.vy=Math.cos(u)*p*t.orbitSpeed}if(i.centripetal){const s=1+.3*(1-Math.abs(e.z)),o=t.initialAngle+n*Math.PI*2*i.rotations*s;e.x=r+Math.cos(o)*p,e.y=a+Math.sin(o)*p}},emotions:["zen","love","excited","surprise"],features:{uses3D:!0,smooth:!0,looping:!0,dramatic:!0}},Be={name:"twitch",emoji:"⚡",type:"blending",description:"Nervous, paranoid twitching",config:{intensity:8,frequency:.08,duration:100,recovery:200,maxOffset:15,sharpness:.9},rhythm:{enabled:!0,syncMode:"subdivision",probabilitySync:{subdivision:"sixteenth",onBeat:.3,offBeat:.05,accentBoost:2},intensitySync:{onBeat:2,offBeat:.8,curve:"pulse"},patternOverrides:{breakbeat:{probabilitySync:{onBeat:.5,offBeat:.1},intensitySync:{onBeat:3,offBeat:.5}},dubstep:{intensitySync:{onBeat:1.5,dropBeat:5,curve:"pulse"}}}},apply(e,t,i,n,s,r){e.gestureData||(e.gestureData={}),e.gestureData.twitch||(e.gestureData.twitch={twitchOffset:{x:0,y:0},targetOffset:{x:0,y:0},isTwitching:!1,twitchTimer:0,cooldownTimer:0,lastTwitch:0});const a=e.gestureData.twitch,{config:o}=this;let c=i.intensity||o.intensity;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.probabilityMultiplier);const l=Date.now();if(!a.isTwitching&&a.cooldownTimer<=0&&Math.random()<(i.frequency||o.frequency)){a.isTwitching=!0,a.twitchTimer=o.duration,a.cooldownTimer=o.recovery;const e=Math.random()*Math.PI*2,t=.5*o.maxOffset+Math.random()*(.5*o.maxOffset);a.targetOffset={x:Math.cos(e)*t*c/8,y:Math.sin(e)*t*c/8},a.lastTwitch=l}if(a.cooldownTimer>0&&(a.cooldownTimer-=16*n),a.isTwitching)if(a.twitchTimer-=16*n,a.twitchTimer>0){const{sharpness:e}=o;a.twitchOffset.x+=(a.targetOffset.x-a.twitchOffset.x)*e,a.twitchOffset.y+=(a.targetOffset.y-a.twitchOffset.y)*e}else a.isTwitching=!1;else a.twitchOffset.x*=.85,a.twitchOffset.y*=.85;e.vx+=a.twitchOffset.x*n*.5,e.vy+=a.twitchOffset.y*n*.5,Math.random()<.1&&(e.vx+=(Math.random()-.5)*c*.3,e.vy+=(Math.random()-.5)*c*.3)},cleanup(e){e.gestureData?.twitch&&delete e.gestureData.twitch}},Fe={name:"sway",type:"blending",emoji:"🌊",description:"Gentle side-to-side swaying motion",config:{duration:2e3,amplitude:20,frequency:1,strength:.5},rhythm:{enabled:!0,syncMode:"bar",amplitudeSync:{onBeat:1.2,offBeat:.9,curve:"ease"},durationSync:{mode:"bars",bars:1},patternOverrides:{waltz:{durationSync:{bars:1},amplitudeSync:{onBeat:1.5,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.3,offBeat:.7,curve:"bounce"}}}},apply(e,t,i,n,s,r){const a={...this.config,...i},o=a.amplitude||this.config.amplitude,c=a.frequency||this.config.frequency,l=a.strength||this.config.strength,h=Math.sin(t*Math.PI*2*c)*o;e.vx+=.01*h*n*l,e.vy+=.5*Math.cos(t*Math.PI*4)*n*l},cleanup(e){}},Le={name:"float",type:"blending",emoji:"🎈",description:"Gentle floating upward motion",config:{duration:2e3,amplitude:80,wobbleAmount:20,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"bounce"},wobbleSync:{subdivision:"eighth",intensity:.7},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:1.3},patternOverrides:{waltz:{wobbleSync:{subdivision:"quarter",intensity:.9}},dubstep:{amplitudeSync:{onBeat:2,curve:"pulse"}}}},apply(e,t,i,n,s,r){e.gestureData||(e.gestureData={}),e.gestureData.float||(e.gestureData.float={originalSize:e.size,originalOpacity:e.opacity||1});const a={...this.config,...i};let o=a.amplitude||this.config.amplitude,c=a.wobbleAmount||this.config.wobbleAmount;const l=a.strength||this.config.strength;i.rhythmModulation&&(o*=i.rhythmModulation.amplitudeMultiplier||1,o*=i.rhythmModulation.accentMultiplier||1,c*=i.rhythmModulation.wobbleMultiplier||1);const h=Math.sin(t*Math.PI*4)*c;e.vy-=.01*o*n*l*(1-.5*t),e.vx+=.01*h*n*l,e.size=e.baseSize*(1+.1*t),e.opacity=1-.3*t},cleanup(e){e.gestureData?.float?(e.opacity=e.gestureData.float.originalOpacity,e.size=e.gestureData.float.originalSize,delete e.gestureData.float):(e.opacity=1,e.size=e.baseSize),e.vx*=.5,e.vy*=.5}},qe={name:"jitter",type:"blending",emoji:"🫨",description:"Nervous jittery movement",config:{duration:1e3,intensity:15,frequency:30,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:2,offBeat:.5,curve:"pulse"},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.3}},dubstep:{amplitudeSync:{onBeat:5,offBeat:.1,curve:"pulse"}}}},apply(e,t,i,n,s,r){e.gestureData||(e.gestureData={}),e.gestureData.jitter||(e.gestureData.jitter={originalSize:e.size});const a={...this.config,...i};let o=a.intensity||this.config.intensity;const c=a.strength||this.config.strength;i.rhythmModulation&&(o*=i.rhythmModulation.amplitudeMultiplier||1,o*=i.rhythmModulation.accentMultiplier||1);const l=(Math.random()-.5)*o*c,h=(Math.random()-.5)*o*c,u=1-.5*t;e.vx+=.1*l*n*u,e.vy+=.1*h*n*u,e.size=e.baseSize*(1+.1*(Math.random()-.5))},cleanup(e){e.gestureData?.jitter?(e.size=e.gestureData.jitter.originalSize,delete e.gestureData.jitter):e.size=e.baseSize,e.vx*=.7,e.vy*=.7}},Ge={name:"spin",emoji:"🌀",type:"override",description:"Orbital rotation around center point",config:{duration:600,musicalDuration:{musical:!0,beats:1},rotations:1,direction:"random",radiusMultiplier:1,spiralOut:!1,accelerate:!0,maintainDistance:!0,scaleAmount:.1,easing:"linear",strength:.7,particleMotion:{type:"spin",strength:.7,rotations:1,radius:1}},rhythm:{enabled:!0,syncMode:"bar",rotationSync:{mode:"bars",rotationsPerBar:1,accelerateOnBeat:!0},radiusSync:{subdivision:"quarter",expandOnBeat:1.2,contractOffBeat:.9,curve:"bounce"},durationSync:{mode:"beats",beats:4},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{curve:"ease"}},swing:{rotationSync:{accelerateOnBeat:!1},direction:"alternating"},dubstep:{radiusSync:{subdivision:"eighth",expandOnBeat:1.5,dropMultiplier:2},spiralOut:!0},breakbeat:{rotationSync:{mode:"random",range:[.5,2]},direction:"random"}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;let a=t.direction||this.config.direction;"random"===a&&(a=Math.random()<.5?"clockwise":"counter-clockwise"),e.gestureData.spin={startAngle:Math.atan2(r,s),startRadius:Math.sqrt(s*s+r*r)||30,originalX:e.x,originalY:e.y,originalVx:e.vx,originalVy:e.vy,direction:a,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.spin?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.spin,o={...this.config,...i},c=i.strength||1;let{rotations:l}=o,{radiusMultiplier:h}=o;i.rhythmModulation&&(i.rhythmModulation.rotationMultiplier&&(l*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusMultiplier&&(h*=i.rhythmModulation.radiusMultiplier));let u=t;o.accelerate&&(u=t<.5?.5*this.easeInQuad(2*t):.5+.5*this.easeOutQuad(2*(t-.5)));const d=l*Math.PI*2*c,p="counter-clockwise"===a.direction?-1:1,m=a.startAngle+d*u*p;let g=a.startRadius;o.spiralOut&&(g*=1+.5*t),1!==h&&(g*=1+(h-1)*Math.sin(t*Math.PI));const f=s+Math.cos(m)*g,y=r+Math.sin(m)*g;if(e.x+=.25*(f-e.x),e.y+=.25*(y-e.y),e.vx=.5*(f-e.x),e.vy=.5*(y-e.y),t>.9){const i=10*(1-t);e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i)}},cleanup(e){if(e.gestureData?.spin){const t=e.gestureData.spin;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.spin}},easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e)},$e={name:"jump",emoji:"🦘",type:"override",description:"Squash, leap, and land with classic animation principles",config:{duration:800,jumpHeight:60,squashAmount:.8,stretchAmount:1.2,anticipation:.2,hangTime:.1,landingImpact:!0,driftOutward:!0,easing:"quad",particleMotion:{type:"jump",strength:.9,jumpHeight:60,squash:.8,stretch:1.2}},rhythm:{enabled:!0,syncMode:"beat",phaseSync:{anticipation:"eighth",jump:"beat",landing:"sixteenth"},heightSync:{onBeat:1.5,offBeat:.8,accent:2,curve:"exponential"},deformationSync:{squashOnBeat:.6,stretchOnBeat:1.4,timing:"anticipatory"},hangTimeSync:{mode:"tempo",baseDuration:.1,scaling:"inverse"},dynamics:{forte:{jumpHeight:80,stretch:1.3},piano:{jumpHeight:30,stretch:1.1}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={}),e.gestureData.jump={startX:e.x,startY:e.y,startSize:e.size,originalVx:e.vx,originalVy:e.vy,driftDirection:.1*(e.x-i),initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.jump?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.jump,o={...this.config,...i},c=i.strength||1,l=o.jumpHeight*c*e.scaleFactor,h=o.squashAmount,u=o.stretchAmount,d=o.anticipation,p=1-.5*o.anticipation;if(t<d){const i=t/d,n=this.easeOutQuad(i);e.size=a.startSize*(1-(1-h)*n),e.y=a.startY+5*n*e.scaleFactor,e.vx=0,e.vy=0}else if(t<p){const i=(t-d)/(p-d);let n=Math.sin(i*Math.PI);if(o.hangTime>0&&i>.4&&i<.6){const e=(i-.4)/.2;n=.95+.05*this.easeInOutCubic(e)}if(e.y=a.startY-n*l,o.driftOutward&&(e.x=a.startX+n*a.driftDirection),i<.5){const t=2*i;e.size=a.startSize*(h+(u-h)*t)}else{const t=2*(i-.5);e.size=a.startSize*(u-(u-1)*t*.8)}e.vx=.5*a.driftDirection,e.vy=-Math.cos(i*Math.PI)*l*.1}else{const i=(t-p)/(1-p),n=this.easeOutBounce(i);if(e.y=a.startY,o.landingImpact)if(i<.3){const t=i/.3;e.size=a.startSize*(1-(1-.8*h)*(1-t))}else{const t=(i-.3)/.7;e.size=a.startSize*(.8*h+(1-.8*h)*t)}else e.size=a.startSize*(h+(1-h)*n);e.vx=a.originalVx*n,e.vy=a.originalVy*n}},cleanup(e){if(e.gestureData?.jump){const t=e.gestureData.jump;e.size=t.startSize,e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.jump}},easeOutQuad:e=>e*(2-e),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeOutBounce(e){const t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},He={name:"morph",emoji:"✨",type:"override",description:"Form geometric patterns and shapes",config:{musicalDuration:{musical:!0,beats:2,minBeats:1,maxBeats:8},phases:[{name:"gather",beats:.25},{name:"form",beats:.75},{name:"hold",beats:.5},{name:"dissolve",beats:.5}],morphType:"fluid",pattern:"star",points:5,innerRadius:.4,size:80,amplitude:20,rotation:0,smooth:!0,randomizeOrder:!1,easing:"sine",strength:1.2,particleMotion:{type:"morph",pattern:"star",strength:1.2,smooth:!0,points:5}},rhythm:{enabled:!0,syncMode:"phrase",patternSync:{verse:"circle",chorus:"star",bridge:"heart",drop:"explosion"},timingSync:{formationBeat:1,holdBeats:2,dissolveBeat:4,curve:"anticipatory"},sizeSync:{onBeat:1.2,offBeat:.95,subdivision:"quarter",curve:"elastic"},rotationSync:{mode:"continuous",degreesPerBar:90,direction:"clockwise"},dynamics:{forte:{points:8,size:100},piano:{points:3,size:60}}},initialize(e,t,i,n,s){e.gestureData||(e.gestureData={});const r={...this.config,...t},a=e.x,o=e.y,c=Math.atan2(e.y-n,e.x-i),l=Math.random()<.5?1:-1;let h,u;const d=r.size*e.scaleFactor,p=(r.rotation||0)*Math.PI/180*l;switch(r.pattern){case"star":h=i,u=n,this.calculateStarPosition(e,c,d,r.points,r.innerRadius,p,i,n);break;case"heart":this.calculateHeartPosition(e,c,d,p,i,n);break;case"square":this.calculateSquarePosition(e,c,d,p,i,n);break;case"triangle":this.calculateTrianglePosition(e,c,d,p,i,n);break;default:{const e=d;h=i+Math.cos(c+p)*e,u=n+Math.sin(c+p)*e;break}}e.gestureData.morph={startX:a,startY:o,targetX:e.gestureData.morphTargetX||h,targetY:e.gestureData.morphTargetY||u,originalVx:e.vx,originalVy:e.vy,rotationDirection:l,initialized:!0}},calculateStarPosition(e,t,i,n,s,r,a,o){const c=((t+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI),l=Math.floor(c/(2*Math.PI)*10),h=l%2==0,u=Math.floor(l/2);let d;d=h?72*u*Math.PI/180:(72*u+36)*Math.PI/180,d+=r;const p=h?i:i*s;e.gestureData.morphTargetX=a+Math.cos(d)*p,e.gestureData.morphTargetY=o+Math.sin(d)*p},calculateHeartPosition(e,t,i,n,s,r){const a=(t+Math.PI)/(2*Math.PI),o=.05*i,c=16*Math.pow(Math.sin(a*Math.PI*2),3),l=-(13*Math.cos(a*Math.PI*2)-5*Math.cos(2*a*Math.PI*2)-2*Math.cos(3*a*Math.PI*2)-Math.cos(4*a*Math.PI*2)),h=Math.cos(n),u=Math.sin(n),d=c*h-l*u,p=c*u+l*h;e.gestureData.morphTargetX=s+d*o,e.gestureData.morphTargetY=r+p*o},calculateSquarePosition(e,t,i,n,s,r){const a=((t+n)%(2*Math.PI)+2*Math.PI)%(2*Math.PI);let o,c;const l=i;a<Math.PI/4||a>=7*Math.PI/4?(o=l,c=l*Math.tan(a)):a<3*Math.PI/4?(o=l/Math.tan(a),c=l):a<5*Math.PI/4?(o=-l,c=-l*Math.tan(a)):(o=-l/Math.tan(a),c=-l);const h=Math.cos(n),u=Math.sin(n),d=o*h-c*u,p=o*u+c*h;e.gestureData.morphTargetX=s+d,e.gestureData.morphTargetY=r+p},calculateTrianglePosition(e,t,i,n,s,r){const a=[{x:0,y:-i},{x:.866*-i,y:.5*i},{x:.866*i,y:.5*i}],o=Math.floor((t+Math.PI)/(2*Math.PI)*3)%3,c=(o+1)%3,l=Math.random(),h=a[o].x+(a[c].x-a[o].x)*l,u=a[o].y+(a[c].y-a[o].y)*l,d=Math.cos(n),p=Math.sin(n),m=h*d-u*p,g=h*p+u*d;e.gestureData.morphTargetX=s+m,e.gestureData.morphTargetY=r+g},apply(e,t,i,n,s,r){e.gestureData?.morph?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.morph,o={...this.config,...i};let c,l,h=t;if(o.holdTime>0){const e=.5-o.holdTime/2,i=.5+o.holdTime/2;h=t<e?t/e*.5:t<i?.5:.5+(t-i)/(1-i)*.5}if(h<=.5){const e=2*h;c=a.startX+(a.targetX-a.startX)*this.easeOutQuad(e),l=a.startY+(a.targetY-a.startY)*this.easeOutQuad(e)}else{const e=2*(h-.5);c=a.targetX+(a.startX-a.targetX)*this.easeInQuad(e),l=a.targetY+(a.startY-a.targetY)*this.easeInQuad(e)}if(o.smooth){const t=.2;e.x+=(c-e.x)*t,e.y+=(l-e.y)*t}else e.x=c,e.y=l;if(e.vx=.5*(c-e.x),e.vy=.5*(l-e.y),t>.9){const i=10*(1-t);e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i)}},cleanup(e){if(e.gestureData?.morph){const t=e.gestureData.morph;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.morph,delete e.gestureData.morphTargetX,delete e.gestureData.morphTargetY}},easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeOutQuad:e=>e*(2-e),easeInQuad:e=>e*e},je={name:"stretch",emoji:"↔️",type:"override",description:"Scale particles along X and Y axes",config:{duration:2e3,scaleX:1.3,scaleY:.9,alternate:!1,elastic:!0,overshoot:.1,frequency:1,easing:"sine",strength:1,particleMotion:{type:"stretch",scaleX:1.8,scaleY:.6,strength:1},centerBased:!0,preserveArea:!1},rhythm:{enabled:!0,syncMode:"beat",scaleSync:{onBeat:{x:1.5,y:.7},offBeat:{x:.8,y:1.3},subdivision:"eighth",curve:"elastic"},alternateSync:{pattern:"XYXY",beatsPerChange:1,overlap:.1},overshootSync:{normal:.1,accent:.3,downbeat:.2,curve:"spring"},preservationSync:{verse:!0,chorus:!1,bridge:!0},dynamics:{forte:{scaleX:2,scaleY:.5,overshoot:.4},piano:{scaleX:1.1,scaleY:.95,overshoot:.05}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;e.gestureData.stretch={offsetX:s,offsetY:r,startX:e.x,startY:e.y,originalVx:e.vx,originalVy:e.vy,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.stretch?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.stretch,o={...this.config,...i},c=i.strength||1;let l,h,{scaleX:u}=o,{scaleY:d}=o;if(o.preserveArea&&1!==u&&1!==d){const e=u*d,t=Math.sqrt(1/e);u*=t,d*=t}if(o.alternate)if(t<.5){const e=2*t;u=1+(u-1)*this.getElasticProgress(e,o),d=1+(1/u-1)*(o.preserveArea?1:0)}else{const e=2*(t-.5);u+=(1-u)*this.getElasticProgress(e,o),d=1+(d-1)*this.getElasticProgress(e,o)}else{const e=this.getElasticProgress(t,o);u=1+(u-1)*e*c,d=1+(d-1)*e*c}if(o.centerBased?(l=s+a.offsetX*u,h=r+a.offsetY*d):(l=a.startX*u,h=a.startY*d),e.x=l,e.y=h,e.vx=a.offsetX*(u-1)*c*.1,e.vy=a.offsetY*(d-1)*c*.1,t>.9){const i=10*(1-t);e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i)}},getElasticProgress(e,t){if(!t.elastic)return this.easeInOutCubic(e);if(0===e)return 0;if(1===e)return 1;const i=t.overshoot||.1;if(e<.5){const t=2*e;return.5*this.easeInElastic(t,i)}{const t=2*(e-.5);return.5+.5*this.easeOutElastic(t,i)}},cleanup(e){if(e.gestureData?.stretch){const t=e.gestureData.stretch;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.stretch}},easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInElastic:(e,t)=>0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin((e-1-.075)*(2*Math.PI)/.3)*(1+t),easeOutElastic:(e,t)=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)*(1+t)+1},We={name:"tilt",emoji:"🤔",type:"override",description:"Gather particles then tilt as unified group",config:{duration:500,gatherPhase:.2,tiltAngle:45,swayAmount:80,liftAmount:60,frequency:3,homeRadius:20,easing:"sine",strength:2.5,particleMotion:{type:"tilt",strength:2.5,frequency:3,swayAmount:80,liftAmount:60},smoothness:.25},rhythm:{enabled:!0,syncMode:"swing",angleSync:{onBeat:45,offBeat:-30,swing:15,subdivision:"triplet",curve:"ease-in-out"},gatherSync:{beatsBefore:.5,releaseAfter:.25,intensity:"dynamic"},swaySync:{verse:60,chorus:100,bridge:80,syncopated:!0},liftSync:{upOnTilt:!0,heightOnAccent:80,normalHeight:40,curve:"bounce"},dynamics:{forte:{tiltAngle:60,swayAmount:120,frequency:4},piano:{tiltAngle:20,swayAmount:40,frequency:2}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n,a=Math.atan2(r,s),o=Math.sqrt(s*s+r*r),c=Math.random(),l=({...this.config,...t}.homeRadius+20*Math.random())*e.scaleFactor;e.gestureData.tilt={startX:e.x,startY:e.y,originalVx:e.vx,originalVy:e.vy,angle:a,distance:o,homeRadius:l,homeX:i+Math.cos(a)*l,homeY:n+Math.sin(a)*l,role:c,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.tilt?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.tilt,o={...this.config,...i},c=i.strength||1;let l,h;if(t<o.gatherPhase){const i=t/o.gatherPhase,n=this.easeInOutCubic(i);l=a.startX+(a.homeX-a.startX)*n,h=a.startY+(a.homeY-a.startY)*n;const s=.6;e.x+=(l-e.x)*s,e.y+=(h-e.y)*s}else{const i=(t-o.gatherPhase)/(1-o.gatherPhase)*Math.PI*o.frequency,n=Math.sin(i),u=o.tiltAngle*Math.PI/180*c,d=a.angle+n*u,p=Math.abs(n)*o.liftAmount*e.scaleFactor,m=a.homeRadius+p;l=s+Math.cos(d)*m,h=r+Math.sin(d)*m-.3*p;const g=o.smoothness+.1*a.role;e.x+=(l-e.x)*g,e.y+=(h-e.y)*g;const f=-Math.sin(d),y=Math.cos(d);e.vx=f*n*2,e.vy=y*n*2}if(t<o.gatherPhase&&(e.vx=.25*(l-e.x),e.vy=.25*(h-e.y)),t>.9){const i=10*(1-t),n=a.startX+(e.x-a.startX)*i,s=a.startY+(e.y-a.startY)*i;e.x=n,e.y=s,e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i)}},cleanup(e){if(e.gestureData?.tilt){const t=e.gestureData.tilt;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.tilt}},easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2},Ne={name:"orbital",emoji:"🪐",type:"override",description:"Orbital motion around center",config:{speed:.02,maintainRadius:!0,elliptical:!1,use3D:!0,zPhaseOffset:0,verticalOscillation:0,duration:3e3,particleMotion:{type:"orbital",strength:1}},rhythm:{enabled:!0,syncMode:"harmonic",speedSync:{tonic:.02,fifth:.03,octave:.04,third:.025,curve:"smooth"},radiusSync:{bass:150,mid:100,treble:50,scaling:"logarithmic"},depthSync:{major:{z:1,phase:0},minor:{z:-1,phase:Math.PI},diminished:{z:.5,phase:Math.PI/2},augmented:{z:.8,phase:-Math.PI/2}},phaseSync:{mode:"harmonic",intervals:[1,1.5,2],drift:.05},dynamics:{forte:{speed:.04,maintainRadius:!1},piano:{speed:.01,maintainRadius:!0}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n,a=Math.sqrt(s*s+r*r),o=Math.random()<.5?1:-1,c=Math.max(a,100+180*Math.random());e.gestureData.orbital={radius:c,targetRadius:c,angle:a<5?Math.random()*Math.PI*2:Math.atan2(r,s),originalVx:e.vx,originalVy:e.vy,originalZ:e.z||0,zPhase:Math.random()*Math.PI*2,direction:o}},apply(e,t,i,n,s,r){e.gestureData?.orbital||this.initialize(e,i,s,r);const a=e.gestureData.orbital,o=(i.speed||this.config.speed)*(i.strength||1);a.angle+=o*n*a.direction;let{radius:c}=a;if(i.maintainRadius||(c=a.radius*(1+.1*Math.sin(t*Math.PI*2))),e.x=s+Math.cos(a.angle)*c,e.y=r+Math.sin(a.angle)*c,!1!==i.use3D){const t=a.angle+a.zPhase+(i.zPhaseOffset||0);if(e.z=.8*Math.sin(t),i.verticalOscillation){const n=Math.cos(t)*i.verticalOscillation*c*.1;e.y+=n}}if(e.vx=-Math.sin(a.angle)*c*o,e.vy=Math.cos(a.angle)*c*o,t>.9){const i=10*(1-t);e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i)}},cleanup(e){if(e.gestureData?.orbital){const t=e.gestureData.orbital;e.vx=t.originalVx,e.vy=t.originalVy,e.z=t.originalZ,delete e.gestureData.orbital}}},Ue={name:"hula",emoji:"🌀",type:"override",description:"Hula-hoop motion with vertical waves",config:{speed:.015,maintainRadius:!1,elliptical:!0,use3D:!0,zPhaseOffset:Math.PI/4,verticalOscillation:.3,wobbleAmount:.15,duration:2500,particleMotion:{type:"hula",strength:1,verticalOscillation:.3}},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:.015,scaling:"proportional"},wobbleSync:{onBeat:.25,offBeat:.1,curve:"sine"},verticalSync:{subdivision:"quarter",amplitude:.4,phase:"sequential"},dynamics:{forte:{wobbleAmount:.3,speed:1.2},piano:{wobbleAmount:.05,speed:.8}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n,a=Math.sqrt(s*s+r*r),o=Math.random()<.5?1:-1,c=Math.max(a,100+180*Math.random());e.gestureData.hula={radius:c,angle:a<5?Math.random()*Math.PI*2:Math.atan2(r,s),originalVx:e.vx,originalVy:e.vy,originalZ:e.z||0,zPhase:Math.random()*Math.PI*2,wobblePhase:Math.random()*Math.PI*2,direction:o}},apply(e,t,i,n,s,r){e.gestureData?.hula||this.initialize(e,i,s,r);const a=e.gestureData.hula,o=(i.speed||this.config.speed)*(i.strength||1);let c=1;t<.1?(c=t/.1,c=Math.sin(c*Math.PI*.5)):t>.9&&(c=(1-t)/.1,c=Math.sin(c*Math.PI*.5)),a.angle+=o*n*a.direction*c;const l=Math.sin(2*a.angle+a.wobblePhase)*(i.wobbleAmount||this.config.wobbleAmount)*c,h=a.radius*(1+l)*c,u=a.radius*(.7+l)*c,d=s+Math.cos(a.angle)*h,p=r+Math.sin(a.angle)*u;if(t<.1){const t=e.x-s,i=e.y-r;Math.sqrt(t*t+i*i)<50?(e.x=s+Math.cos(a.angle)*h,e.y=r+Math.sin(a.angle)*u):(e.x=e.x+(d-e.x)*c*.5,e.y=e.y+(p-e.y)*c*.5)}else e.x=d,e.y=p;const m=a.angle+a.zPhase+(i.zPhaseOffset||this.config.zPhaseOffset);e.z=.9*Math.sin(m)*c;const g=i.verticalOscillation||this.config.verticalOscillation,f=Math.cos(2*m)*g*a.radius*.2*c;e.y+=f;const y=e.z*a.radius*.1;e.y-=y;const v=-Math.sin(a.angle)*h*o,b=Math.cos(a.angle)*u*o;t<.1?(e.vx=a.originalVx+(v-a.originalVx)*c,e.vy=a.originalVy+(b-a.originalVy)*c):t>.9?(e.vx=v*c+a.originalVx*(1-c),e.vy=b*c+a.originalVy*(1-c),e.z=e.z*c+a.originalZ*(1-c)):(e.vx=v,e.vy=b)},cleanup(e){if(e.gestureData?.hula){const t=e.gestureData.hula;e.vx=t.originalVx,e.vy=t.originalVy,e.z=t.originalZ,delete e.gestureData.hula}}},Ve={name:"scan",emoji:"🔍",type:"override",description:"Searchlight scanning motion",config:{scanSpeed:.008,scanWidth:120,pauseDuration:300,scanHeight:40,layers:3,duration:3e3},rhythm:{enabled:!0,syncMode:"measure",sweepSync:{beatsPerSweep:4,pauseOnDownbeat:!0,reverseOnBar:!0,curve:"linear"},layerSync:{quiet:1,moderate:2,loud:3,stagger:"sequential"},pauseSync:{onBeat:500,offBeat:100,accent:800,subdivision:"quarter"},widthSync:{verse:80,chorus:140,bridge:100,transition:"smooth"},dynamics:{forte:{scanSpeed:.012,layers:4},piano:{scanSpeed:.004,layers:1}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=Math.floor(Math.random()*this.config.layers);e.gestureData.scan={layer:s,phase:Math.random()*Math.PI*2,direction:Math.random()<.5?1:-1,pauseTimer:0,isPaused:!1,originalX:e.x,originalY:e.y,originalVx:e.vx,originalVy:e.vy,scanOffset:20*(Math.random()-.5),verticalOffset:30*s-30,initialized:!0,startTime:Date.now()}},apply(e,t,i,n,s,r){e.gestureData?.scan||this.initialize(e,i,s,r);const a=e.gestureData.scan,o=i.scanSpeed||this.config.scanSpeed,c=i.scanWidth||this.config.scanWidth,l=i.pauseDuration||this.config.pauseDuration;if(a.isPaused)a.pauseTimer-=16*n,a.pauseTimer<=0&&(a.isPaused=!1,a.direction*=-1);else{a.phase+=o*a.direction*n;const e=Math.sin(a.phase);Math.abs(e)>.95&&(a.isPaused=!0,a.pauseTimer=l)}const h=Math.sin(a.phase)*c,u=Math.cos(.5*a.phase)*(this.config.scanHeight/2);let d=1;t<.15?(d=t/.15,d*=d):t>.85&&(d=(1-t)/.15,d*=d);const p=s+h+a.scanOffset,m=r+u+a.verticalOffset;e.x=a.originalX+(p-a.originalX)*d,e.y=a.originalY+(m-a.originalY)*d,a.isPaused?(e.vx*=.85,e.vy*=.85):(e.vx=-Math.cos(a.phase)*c*o*60,e.vy=-Math.sin(.5*a.phase)*this.config.scanHeight*o*30),Math.random()<.02&&(e.vx+=2*(Math.random()-.5),e.vy+=2*(Math.random()-.5))},cleanup(e){if(e.gestureData?.scan){const t=e.gestureData.scan;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.scan}}},Ye={name:"twist",emoji:"🌀",type:"override",description:"Twisting dance motion with alternating rotation",config:{duration:1200,rotationAngle:45,contractionFactor:.8,twistFrequency:2,easing:"smooth",strength:.8,particleMotion:{type:"twist",rotationAngle:45,contractionFactor:.8,twistFrequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:4,blendable:!1,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.5,offBeat:.7,curve:"elastic"},patternOverrides:{funk:{rotationAngle:60,contractionFactor:.7},disco:{twistFrequency:3,rotationAngle:50},latin:{rotationAngle:35,contractionFactor:.85,twistFrequency:2.5}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.twist={startX:e.x,startY:e.y,startAngle:Math.atan2(e.y-t.centerY,e.x-t.centerX),startDistance:Math.sqrt(Math.pow(e.x-t.centerX,2)+Math.pow(e.y-t.centerY,2)),initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.twist?.initialized||this.initialize(e,{...i,centerX:s,centerY:r});const a={...this.config,...i},o=e.gestureData.twist,c=a.strength||this.config.strength||1,l=t*a.twistFrequency*Math.PI*2,h=Math.sin(l)*c;let{rotationAngle:u}=a,{contractionFactor:d}=a;i.rhythmModulation&&(u*=i.rhythmModulation.amplitudeMultiplier||1,d=1-(1-d)*(i.rhythmModulation.amplitudeMultiplier||1));const p=u*Math.PI/180*h,m=1-(1-d)*Math.abs(h),g=o.startAngle+p,f=o.startDistance*m,y=s+Math.cos(g)*f,v=r+Math.sin(g)*f,b=.15*c;e.x+=(y-e.x)*b,e.y+=(v-e.y)*b,e.vx=.05*(y-e.x),e.vy=.05*(v-e.y);const w=5*Math.sin(t*Math.PI*4)*c;if(e.y+=.1*w,t>.9){const i=1-10*(t-.9);e.vx*=i,e.vy*=i}},cleanup(e){e.gestureData?.twist&&delete e.gestureData.twist}},Xe={name:"wave",emoji:"🌊",type:"override",description:"Infinity pattern flow with phasing",config:{musicalDuration:{musical:!0,bars:1,minBeats:4,maxBeats:16},phases:[{name:"gather",beats:.5},{name:"rise",beats:.5},{name:"waveLeft",beats:1},{name:"waveRight",beats:1},{name:"settle",beats:1}],amplitude:40,frequency:1,phaseShift:.3,liftHeight:20,fadeInOut:!0,smoothness:.1,easing:"sine",strength:1,particleMotion:{type:"wave",strength:1,amplitude:50}},rhythm:{enabled:!0,syncMode:"wave",amplitudeSync:{onWave:65,onStatic:25,curve:"flowing"},frequencySync:{mode:"phrase",slow:.7,fast:1.8,curve:"melodic"},durationSync:{mode:"bars",adaptToPhrase:!0,sustain:!0},phaseSync:{enabled:!0,multiplier:.5,type:"ensemble"},melodicResponse:{enabled:!0,multiplier:1.4,type:"amplitude"},patternOverrides:{ambient:{amplitudeSync:{onWave:80,onStatic:40,curve:"hypnotic"},frequencySync:{slow:.5,fast:1.2},durationSync:{minBeats:16,maxBeats:64}},ocean:{amplitudeSync:{onWave:90,onStatic:20,curve:"natural"},phaseSync:{multiplier:.8},melodicResponse:{multiplier:1.8}},electronic:{amplitudeSync:{onWave:70,onStatic:30,curve:"digital"},frequencySync:{slow:.8,fast:2.5,curve:"precise"}},orchestral:{amplitudeSync:{onWave:75,onStatic:35},phaseSync:{multiplier:.7},melodicResponse:{multiplier:2}}},dynamics:{forte:{amplitudeSync:{onWave:{multiplier:1.8},onStatic:{multiplier:1.4}},frequencySync:{multiplier:1.3},melodicResponse:{multiplier:2.2}},piano:{amplitudeSync:{onWave:{multiplier:.6},onStatic:{multiplier:.4}},frequencySync:{multiplier:.7},melodicResponse:{multiplier:1.1}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n,a=Math.atan2(r,s),o=Math.sqrt(s*s+r*r),c=Math.random()<.5?1:-1;e.gestureData.wave={startX:e.x,startY:e.y,originalVx:e.vx,originalVy:e.vy,baseOpacity:e.opacity||e.life||1,angle:a,radius:o,offset:Math.random()*Math.PI*2,role:Math.random(),direction:c,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.wave?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.wave,o={...this.config,...i},c=i.strength||1,l=this.easeInOutSine(t),h=a.role*o.phaseShift,u=Math.max(0,l-h),d=u*Math.PI*2*o.frequency*a.direction+a.offset,p=.5+a.radius/100*.5,m=o.amplitude*p*c*e.scaleFactor,g=s+Math.sin(d)*m,f=r+Math.sin(2*d)*m*.3+-Math.abs(Math.sin(l*Math.PI))*o.liftHeight*e.scaleFactor,y=o.smoothness+.12*a.role;if(e.x+=(g-e.x)*y,e.y+=(f-e.y)*y,e.vx=.3*(g-e.x),e.vy=.3*(f-e.y),o.fadeInOut){let t;t=u<.1?u/.1:u>.9?(1-u)/.1:.5+.5*Math.sin(u*Math.PI),e.opacity=a.baseOpacity*(.3+.7*t),void 0!==e.life&&(e.life=e.opacity)}if(t>=.95){const i=20*(1-t);e.vx=e.vx*i+a.originalVx*(1-i),e.vy=e.vy*i+a.originalVy*(1-i),o.fadeInOut&&(e.opacity=a.baseOpacity*i,void 0!==e.life&&(e.life=e.opacity))}},cleanup(e){if(e.gestureData?.wave){const t=e.gestureData.wave;e.vx=t.originalVx,e.vy=t.originalVy,e.opacity=t.baseOpacity,void 0!==e.life&&(e.life=t.baseOpacity),delete e.gestureData.wave}},easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2},Qe={name:"drift",emoji:"☁️",type:"override",description:"Controlled floating with fade effects",config:{duration:800,distance:50,angle:45,returnToOrigin:!0,fadeOut:!1,holdTime:.2,turbulence:.1,angleSpread:45,smoothness:.08,easing:"ease",strength:1,particleMotion:{type:"drift",strength:1,distance:60}},rhythm:{enabled:!0,syncMode:"ambient",distanceSync:{quiet:30,loud:80,crescendo:"expand",diminuendo:"contract"},angleSync:{major:45,minor:225,modulation:"smooth",cadence:"return"},holdSync:{shortPhrase:.1,longPhrase:.4,fermata:"sustain"},accentResponse:{enabled:!0,multiplier:1.3,type:"distance"},patternOverrides:{ambient:{distanceSync:{quiet:40,loud:100},holdSync:{shortPhrase:.3,longPhrase:.6}},classical:{angleSync:{major:30,minor:210},distanceSync:{quiet:25,loud:60}},jazz:{angleSync:{major:60,minor:240,swing:!0,syncopated:!0}},new_age:{distanceSync:{quiet:35,loud:70},holdSync:{shortPhrase:.4,longPhrase:.8},angleSync:{modulation:"gradual"}}},dynamics:{forte:{distanceSync:{quiet:{multiplier:1.5},loud:{multiplier:1.8}},holdSync:{multiplier:1.2},accentResponse:{multiplier:1.6}},piano:{distanceSync:{quiet:{multiplier:.6},loud:{multiplier:.8}},holdSync:{multiplier:.8},accentResponse:{multiplier:1.1}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;let a=Math.atan2(r,s);const o={...this.config,...t}.angleSpread*Math.PI/180,c=(Math.random()-.5)*o;a+=c;const l=30+30*Math.random();e.gestureData.drift={startX:e.x,startY:e.y,originalVx:e.vx,originalVy:e.vy,baseOpacity:e.opacity||e.life||1,driftAngle:a,angleOffset:c,homeRadius:l*e.scaleFactor,homeX:i+Math.cos(a)*l,homeY:n+Math.sin(a)*l,role:Math.random(),turbulencePhase:Math.random()*Math.PI*2,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.drift?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.drift,o={...this.config,...i},c=i.strength||1,l=this.easeInOutCubic(t),h=Math.max(0,l-.1*a.role);let u,d,p;if(o.returnToOrigin)if(h<.4){const e=h/.4,t=this.easeOutQuad(e);u=a.startX+(a.homeX-a.startX)*t,d=a.startY+(a.homeY-a.startY)*t}else if(h<.6+o.holdTime){const t=(h-.4)/(.2+o.holdTime);p=a.homeRadius+Math.sin(t*Math.PI*.5)*o.distance*c*e.scaleFactor}else{const t=(h-.6-o.holdTime)/(.4-o.holdTime);p=a.homeRadius+Math.cos(t*Math.PI*.5)*o.distance*c*e.scaleFactor}else{const t=h;p=a.homeRadius+t*o.distance*c*e.scaleFactor}if(void 0!==p){a.turbulencePhase+=o.turbulence*n;const e=Math.sin(a.turbulencePhase)*o.turbulence*10,t=Math.cos(1.3*a.turbulencePhase)*o.turbulence*10,i=a.driftAngle+a.angleOffset;u=s+Math.cos(i)*p+e,d=r+Math.sin(i)*p+t}const m=o.smoothness+.08*a.role;if(e.x+=(u-e.x)*m,e.y+=(d-e.y)*m,e.vx=.25*(u-e.x),e.vy=.25*(d-e.y),o.fadeOut){let i;i=t<.25?.3+t/.25*.7:t<.75?.7+.3*Math.sin((t-.25)*Math.PI/.5):4*(1-t),e.opacity=a.baseOpacity*i,void 0!==e.life&&(e.life=e.opacity)}t>=.99&&(e.vx=.1*a.originalVx,e.vy=.1*a.originalVy,o.fadeOut&&(e.opacity=a.baseOpacity,void 0!==e.life&&(e.life=a.baseOpacity)))},cleanup(e){if(e.gestureData?.drift){const t=e.gestureData.drift;e.vx=t.originalVx,e.vy=t.originalVy,e.opacity=t.baseOpacity,void 0!==e.life&&(e.life=t.baseOpacity),delete e.gestureData.drift}},easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeOutQuad:e=>e*(2-e)},Je={name:"flicker",emoji:"⚡",type:"blending",description:"Rapid opacity changes with motion jitter",config:{duration:800,flickerRate:15,frequency:6,minOpacity:.3,maxOpacity:1,jitterAmount:2,colorShift:!1,strobe:!1,pulseMode:!1,groupFlicker:.3,easing:"linear",strength:.7,particleMotion:{type:"flicker",strength:.7,frequency:6}},rhythm:{enabled:!0,syncMode:"subdivision",rateSync:{subdivision:"sixteenth",onBeat:30,offBeat:10,triplet:20,curve:"step"},opacitySync:{pattern:"HLMH",subdivision:"eighth",onAccent:.1,regular:.5},jitterSync:{onBeat:5,offBeat:1,accent:10,curve:"random"},strobeSync:{verse:!1,chorus:!0,drop:"intense",pattern:"XOXO"},dynamics:{forte:{flickerRate:25,jitterAmount:5,minOpacity:.1},piano:{flickerRate:8,jitterAmount:1,minOpacity:.5}}},initialize(e,t){e.gestureData||(e.gestureData={});const i={...this.config,...t},n=Math.random()<i.groupFlicker;e.gestureData.flicker={baseOpacity:e.opacity||e.life||1,baseColor:e.color,baseX:e.x,baseY:e.y,flickerTimer:0,lastFlicker:0,flickerState:!0,isGrouped:n,groupId:n?Math.floor(3*Math.random()):-1,phase:Math.random()*Math.PI*2,colorHue:0,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.flicker?.initialized||this.initialize(e,i);const a=e.gestureData.flicker,o={...this.config,...i},c=i.strength||1;let l;if(a.flickerTimer+=n*o.flickerRate,o.strobe)l=(a.flickerTimer+a.phase)%1<.5?1:o.minOpacity;else if(o.pulseMode){const e=a.flickerTimer+a.phase;l=o.minOpacity+(o.maxOpacity-o.minOpacity)*(.5*Math.sin(e)+.5)}else{if(a.flickerTimer-a.lastFlicker>1)if(a.lastFlicker=a.flickerTimer,a.isGrouped){const e=Math.floor(a.flickerTimer)%3;a.flickerState=e===a.groupId}else a.flickerState=Math.random()>.3;const t=a.flickerState?o.maxOpacity:o.minOpacity+.3*Math.random(),i=e.opacity/a.baseOpacity;l=i+.3*(t-i)}const h=a.baseOpacity*(1+(l-1)*c);if(e.opacity=Math.max(0,Math.min(1,h)),void 0!==e.life&&(e.life=e.opacity),o.jitterAmount>0&&l>o.minOpacity){const t=o.jitterAmount*c*e.scaleFactor,i=(Math.random()-.5)*t*l,s=(Math.random()-.5)*t*l;e.vx+=.1*i*n,e.vy+=.1*s*n}if(o.colorShift&&e.color){a.colorHue+=.01*n;const t=30*Math.sin(a.colorHue);e.color=this.shiftHue(a.baseColor,t*c)}let u=1;t<.1?u=t/.1:t>.9&&(u=(1-t)/.1),e.opacity*=u,void 0!==e.life&&(e.life=e.opacity),t>.8&&(e.vx*=.95,e.vy*=.95)},shiftHue(e,t){if(!e||!e.startsWith("#"))return e;const i=e.slice(1),n=parseInt(i.substr(0,2),16)/255,s=parseInt(i.substr(2,2),16)/255,r=parseInt(i.substr(4,2),16)/255,a=t*Math.PI/180,o=Math.cos(a),c=Math.sin(a),l=n*c+s*o,h=r,u=e=>Math.max(0,Math.min(255,Math.round(255*e))).toString(16).padStart(2,"0");return`#${u(n*o-s*c)}${u(l)}${u(h)}`},cleanup(e){if(e.gestureData?.flicker){const t=e.gestureData.flicker;e.opacity=t.baseOpacity,e.color=t.baseColor,void 0!==e.life&&(e.life=t.baseOpacity),delete e.gestureData.flicker}}},Ke={name:"burst",emoji:"💥",type:"blending",description:"Explosive outward burst from center",config:{decay:.5,strength:2},rhythm:{enabled:!0,syncMode:"beat",strengthSync:{onBeat:3.5,offBeat:1,curve:"explosion"},decaySync:{mode:"tempo",fast:.8,slow:.3,curve:"exponential"},durationSync:{mode:"beats",beats:.5,sustain:!1},accentResponse:{enabled:!0,multiplier:2.5,type:"strength"},patternOverrides:{rock:{strengthSync:{onBeat:4,offBeat:1.5},decaySync:{fast:.6,slow:.4}},electronic:{strengthSync:{onBeat:3.8,offBeat:.8,curve:"sharp"},decaySync:{fast:.9,slow:.7}},jazz:{strengthSync:{onBeat:2.8,offBeat:1.8,swing:!0},decaySync:{fast:.5,slow:.2}},orchestral:{strengthSync:{onBeat:3.2,offBeat:.5},accentResponse:{multiplier:3}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:2},offBeat:{multiplier:1.5}},decaySync:{multiplier:.7},accentResponse:{multiplier:3.5}},piano:{strengthSync:{onBeat:{multiplier:.6},offBeat:{multiplier:.3}},decaySync:{multiplier:1.3},accentResponse:{multiplier:1.8}}}},apply(e,t,i,n,s,r){const a=i.decay||this.config.decay,o=(i.strength||this.config.strength)*(1-t*a),c=e.x-s,l=e.y-r,h=Math.sqrt(c*c+l*l);h>1&&(e.vx+=c/h*o*2*n,e.vy+=l/h*o*2*n)}},Ze={name:"directional",emoji:"➡️",type:"blending",description:"Move particles in a specific direction",config:{angle:0,returnToOrigin:!1,strength:1},rhythm:{enabled:!0,syncMode:"flow",angleSync:{verse:0,chorus:90,bridge:180,outro:270,transition:"smooth"},strengthSync:{onBeat:1.8,offBeat:.6,curve:"wave"},returnSync:{enabled:!0,onSectionChange:!0,duration:"transition",strength:1.2},accentResponse:{enabled:!0,multiplier:2,type:"strength"},patternOverrides:{march:{angleSync:{verse:0,chorus:0},strengthSync:{onBeat:2.5,offBeat:1}},waltz:{angleSync:{verse:45,chorus:135,bridge:225,outro:315,transition:"circular"}},swing:{strengthSync:{onBeat:1.6,offBeat:1.4,swing:!0}},electronic:{angleSync:{transition:"instant"},strengthSync:{onBeat:2.2,offBeat:.4,curve:"sharp"}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:1.6},offBeat:{multiplier:1.2}},angleSync:{transition:"sharp"},accentResponse:{multiplier:2.5}},piano:{strengthSync:{onBeat:{multiplier:.7},offBeat:{multiplier:.8}},angleSync:{transition:"gradual"},accentResponse:{multiplier:1.4}}}},initialize(e){e.gestureData||(e.gestureData={}),e.gestureData.directional={initialX:e.x,initialY:e.y}},apply(e,t,i,n,s,r){e.gestureData?.directional||this.initialize(e);const a=(i.angle||this.config.angle)*Math.PI/180,o=i.strength||this.config.strength;if(e.vx+=Math.cos(a)*o*.3*n,e.vy+=Math.sin(a)*o*.3*n,i.returnToOrigin&&t>.5){const i=2*(t-.5),s=e.gestureData.directional,r=s.initialX-e.x,a=s.initialY-e.y;e.vx+=r*i*.02*n,e.vy+=a*i*.02*n}}},et={name:"settle",emoji:"🍃",type:"blending",description:"Gradually settle particles to rest",config:{damping:.02,threshold:.01},rhythm:{enabled:!0,syncMode:"resolution",dampingSync:{onResolution:.035,onTension:.015,curve:"gradual"},thresholdSync:{mode:"dynamics",forte:.02,piano:.005,curve:"exponential"},durationSync:{mode:"phrase",minBeats:2,maxBeats:12,sustain:!0},cadenceResponse:{enabled:!0,multiplier:1.6,type:"damping"},patternOverrides:{ambient:{dampingSync:{onResolution:.025,onTension:.008,curve:"atmospheric"},durationSync:{minBeats:8,maxBeats:32}},jazz:{dampingSync:{onResolution:.04,onTension:.02},cadenceResponse:{multiplier:1.8}},classical:{dampingSync:{onResolution:.045,onTension:.012,curve:"expressive"},cadenceResponse:{multiplier:2}},minimalist:{dampingSync:{onResolution:.02,onTension:.005},durationSync:{minBeats:16,maxBeats:64}}},dynamics:{forte:{dampingSync:{onResolution:{multiplier:1.4},onTension:{multiplier:.8}},thresholdSync:{multiplier:2},cadenceResponse:{multiplier:2.2}},piano:{dampingSync:{onResolution:{multiplier:.7},onTension:{multiplier:1.2}},thresholdSync:{multiplier:.5},cadenceResponse:{multiplier:1.3}}}},apply(e,t,i,n,s,r){const a=i.damping||this.config.damping,o=i.threshold||this.config.threshold;e.vx*=Math.max(0,1-a*n*60),e.vy*=Math.max(0,1-a*n*60),Math.abs(e.vx)<o&&(e.vx=0),Math.abs(e.vy)<o&&(e.vy=0)}},tt={name:"fade",emoji:"👻",type:"blending",description:"Fade particle opacity",config:{fadeIn:!1,fadeOut:!0,minOpacity:0,maxOpacity:1},rhythm:{enabled:!0,syncMode:"dynamic",opacitySync:{onBeat:.9,offBeat:.3,subdivision:"eighth",curve:"exponential"},fadePhaseSync:{verse:{fadeIn:!0,fadeOut:!1},chorus:{fadeIn:!1,fadeOut:!1},bridge:{fadeIn:!0,fadeOut:!0},outro:{fadeIn:!1,fadeOut:!0}},pulseSync:{enabled:!0,frequency:"quarter",intensity:.2,onAccent:.4},dynamics:{forte:{minOpacity:.5,maxOpacity:1},piano:{minOpacity:0,maxOpacity:.4}}},initialize(e){e.gestureData||(e.gestureData={}),e.gestureData.fade={baseOpacity:e.opacity||e.life||1}},apply(e,t,i,n,s,r){e.gestureData?.fade||this.initialize(e);const a=e.gestureData.fade,o={...this.config,...i};let c;c=o.fadeIn&&!o.fadeOut?o.minOpacity+(o.maxOpacity-o.minOpacity)*t:o.fadeOut&&!o.fadeIn?o.maxOpacity-(o.maxOpacity-o.minOpacity)*t:t<.5?o.minOpacity+(o.maxOpacity-o.minOpacity)*(2*t):o.maxOpacity-(o.maxOpacity-o.minOpacity)*(2*(t-.5)),e.opacity=a.baseOpacity*c,void 0!==e.life&&(e.life=e.opacity)},cleanup(e){e.gestureData?.fade&&(e.opacity=e.gestureData.fade.baseOpacity,void 0!==e.life&&(e.life=e.opacity),delete e.gestureData.fade)}},it={name:"hold",emoji:"⏸️",type:"override",description:"Hold particles in current position",config:{holdStrength:.95,allowDrift:!1},rhythm:{enabled:!0,syncMode:"rest",holdSync:{onRest:.98,onSound:.8,curve:"immediate"},durationSync:{mode:"rests",minBeats:.5,maxBeats:8,sustain:!0},pauseResponse:{enabled:!0,multiplier:1.5,type:"strength"},patternOverrides:{classical:{holdSync:{onRest:.99,onSound:.75,curve:"dramatic"},pauseResponse:{multiplier:2}},minimal:{holdSync:{onRest:.95,onSound:.85},durationSync:{minBeats:2,maxBeats:16}},jazz:{holdSync:{onRest:.9,onSound:.7},allowDrift:!0},electronic:{holdSync:{onRest:.99,onSound:.6,curve:"digital"},pauseResponse:{multiplier:1.2}}},dynamics:{forte:{holdSync:{onRest:{multiplier:1.02},onSound:{multiplier:.9}},pauseResponse:{multiplier:2.2}},piano:{holdSync:{onRest:{multiplier:.97},onSound:{multiplier:.85}},pauseResponse:{multiplier:1.3}}}},initialize(e){e.gestureData||(e.gestureData={}),e.gestureData.hold={holdX:e.x,holdY:e.y,originalVx:e.vx,originalVy:e.vy}},apply(e,t,i,n,s,r){e.gestureData?.hold||this.initialize(e);const a=e.gestureData.hold,o=i.holdStrength||this.config.holdStrength;if(i.allowDrift?(e.vx*=o,e.vy*=o):(e.x+=(a.holdX-e.x)*(1-o),e.y+=(a.holdY-e.y)*(1-o),e.vx=0,e.vy=0),t>.9){const i=10*(t-.9);e.vx=e.vx*(1-i)+a.originalVx*i,e.vy=e.vy*(1-i)+a.originalVy*i}},cleanup(e){if(e.gestureData?.hold){const t=e.gestureData.hold;e.vx=t.originalVx,e.vy=t.originalVy,delete e.gestureData.hold}}},nt={name:"breathe",emoji:"🫁",type:"blending",description:"Breathing rhythm with inhale and exhale",config:{musicalDuration:{musical:!0,bars:1,minBeats:2,maxBeats:16},phases:[{name:"inhale",beats:1.5},{name:"hold_in",beats:.5},{name:"exhale",beats:1.5},{name:"hold_out",beats:.5}],inhaleRadius:1.5,exhaleRadius:.3,breathRate:.3,spiralStrength:.002,scaleAmount:.25,glowAmount:.4,frequency:1,easing:"sine",strength:.8,particleMotion:{type:"breathe",strength:.8,inhaleRadius:1.5,exhaleRadius:.3}},rhythm:{enabled:!0,syncMode:"phrase",breathRateSync:{mode:"tempo",bpm:"auto",subdivision:"whole",curve:"sine"},radiusSync:{inhale:{onUpbeat:1.8,onDownbeat:1.4,curve:"ease-in"},exhale:{onUpbeat:.2,onDownbeat:.4,curve:"ease-out"}},durationSync:{mode:"phrases",phrases:2,hold:"fermata"},accentResponse:{enabled:!0,multiplier:1.5,type:"expansion"},patternOverrides:{ballad:{breathRateSync:{subdivision:"double-whole"},radiusSync:{inhale:{onUpbeat:2.2,onDownbeat:1.8},exhale:{onUpbeat:.1,onDownbeat:.2}}},uptempo:{breathRateSync:{subdivision:"half"},radiusSync:{inhale:{onUpbeat:1.4,onDownbeat:1.2},exhale:{onUpbeat:.3,onDownbeat:.4}}},ambient:{breathRateSync:{subdivision:"whole",curve:"ease"},radiusSync:{inhale:{onUpbeat:1.6,onDownbeat:1.6},exhale:{onUpbeat:.2,onDownbeat:.2}}}},dynamics:{forte:{radiusSync:{inhale:{multiplier:1.8},exhale:{multiplier:.5}},spiralStrength:.004,scaleAmount:.4},piano:{radiusSync:{inhale:{multiplier:1.2},exhale:{multiplier:.8}},spiralStrength:.001,scaleAmount:.1}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;e.gestureData.breathe={startX:e.x,startY:e.y,angle:Math.atan2(r,s),baseRadius:Math.sqrt(s*s+r*r),phaseOffset:.2*Math.random()-.1}},apply(e,t,i,n,s,r){e.gestureData?.breathe||this.initialize(e,i,s,r);const a={...this.config,...i},o=(Math.sin(t*Math.PI*2*a.breathRate)+1)/2,c=100*(e.scaleFactor||1),l=a.inhaleRadius*c,h=a.exhaleRadius*c,u=h+(l-h)*o,d=e.x-s,p=e.y-r,m=Math.sqrt(d*d+p*p),g=u-m,f=.05*(i.strength||.8)*n;if(m>0){const t=d/m*g*f,s=p/m*g*f;e.vx+=t,e.vy+=s;const r=a.spiralStrength*n*(i.strength||1),c=-p/m,l=d/m;e.vx+=c*r*o,e.vy+=l*r*o}e.vx*=.98,e.vy*=.98},cleanup(e){e.gestureData?.breathe&&delete e.gestureData.breathe}},st={name:"expand",emoji:"💫",type:"blending",description:"Radial expansion from center",config:{duration:600,scaleAmount:3,scaleTarget:3,glowAmount:.5,easing:"back",strength:3,particleMotion:{type:"pulse",strength:3,direction:"outward",persist:!0}},rhythm:{enabled:!0,syncMode:"crescendo",strengthSync:{pianissimo:1.5,fortissimo:5,crescendo:"build",sforzando:"burst"},scaleTargetSync:{verse:2,chorus:4.5,climax:6,curve:"exponential"},durationSync:{mode:"phrases",build:1.2,release:.8,sustain:"hold"},accentResponse:{enabled:!0,multiplier:2.8,type:"strength"},patternOverrides:{orchestral:{strengthSync:{pianissimo:2,fortissimo:6.5,crescendo:"dramatic"},scaleTargetSync:{climax:8}},rock:{strengthSync:{pianissimo:1.8,fortissimo:5.5,curve:"power"},accentResponse:{multiplier:3.2}},ambient:{strengthSync:{pianissimo:1.2,fortissimo:3.5,crescendo:"organic"},durationSync:{build:1.8,release:1.2}},electronic:{strengthSync:{pianissimo:1.6,fortissimo:4.8,curve:"digital"},scaleTargetSync:{curve:"linear"}}},dynamics:{forte:{strengthSync:{pianissimo:{multiplier:1.4},fortissimo:{multiplier:1.8}},scaleTargetSync:{multiplier:1.6},accentResponse:{multiplier:3.5}},piano:{strengthSync:{pianissimo:{multiplier:.8},fortissimo:{multiplier:1.2}},scaleTargetSync:{multiplier:.7},accentResponse:{multiplier:2}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;e.gestureData.expand={startX:e.x,startY:e.y,angle:Math.atan2(r,s),baseRadius:Math.sqrt(s*s+r*r),initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.expand?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.expand,o={...this.config,...i},c=o.strength||1,l=1+(o.scaleTarget-1)*t*c,h=a.baseRadius*l,u=s+Math.cos(a.angle)*h,d=r+Math.sin(a.angle)*h,p=u-e.x,m=d-e.y;e.vx+=.8*p*n,e.vy+=.8*m*n,e.vx*=.95,e.vy*=.95},cleanup(e){e.gestureData?.expand&&delete e.gestureData.expand}},rt={name:"contract",emoji:"🌀",type:"blending",description:"Radial contraction toward center",config:{duration:600,scaleAmount:.2,scaleTarget:.2,glowAmount:-.2,easing:"cubic",strength:2.5,particleMotion:{type:"pulse",strength:2.5,direction:"inward",persist:!0}},rhythm:{enabled:!0,syncMode:"tension",strengthSync:{onTension:4,onRelease:1.5,curve:"magnetic"},scaleTargetSync:{forte:.1,piano:.4,crescendo:"gradual",diminuendo:"ease"},durationSync:{mode:"phrases",shortPhrase:.8,longPhrase:1.5,hold:"sustain"},accentResponse:{enabled:!0,multiplier:2.2,type:"strength"},patternOverrides:{classical:{strengthSync:{onTension:3.5,onRelease:1.8},scaleTargetSync:{forte:.15,piano:.35}},metal:{strengthSync:{onTension:5,onRelease:2,curve:"sharp"},scaleTargetSync:{forte:.05,piano:.25}},ambient:{strengthSync:{onTension:2.8,onRelease:1.2,curve:"ease"},durationSync:{shortPhrase:1.2,longPhrase:2}},trap:{strengthSync:{onTension:4.5,onRelease:1,dropBeat:6},scaleTargetSync:{forte:.08,piano:.3}}},dynamics:{forte:{strengthSync:{onTension:{multiplier:1.8},onRelease:{multiplier:1.4}},scaleTargetSync:{multiplier:.6},accentResponse:{multiplier:2.8}},piano:{strengthSync:{onTension:{multiplier:.7},onRelease:{multiplier:.8}},scaleTargetSync:{multiplier:1.4},accentResponse:{multiplier:1.6}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={});const s=e.x-i,r=e.y-n;e.gestureData.contract={startX:e.x,startY:e.y,angle:Math.atan2(r,s),baseRadius:Math.sqrt(s*s+r*r),initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.contract?.initialized||this.initialize(e,i,s,r);const a=e.gestureData.contract,o={...this.config,...i},c=o.strength||1,l=1-(1-o.scaleTarget)*t*c,h=a.baseRadius*l,u=s+Math.cos(a.angle)*h,d=r+Math.sin(a.angle)*h,p=u-e.x,m=d-e.y;e.vx+=.5*p*n,e.vy+=.5*m*n,e.vx*=.95,e.vy*=.95},cleanup(e){e.gestureData?.contract&&delete e.gestureData.contract}},at={name:"flash",emoji:"⚡",type:"blending",description:"Bright flash burst effect",config:{duration:400,glowAmount:2.5,glowPeak:3,scalePeak:1.1,easing:"cubic",strength:1,particleMotion:{type:"burst",strength:1,decay:.3}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"immediate",interruptible:!0,priority:8,blendable:!0,intensitySync:{onBeat:3.5,offBeat:1,accent:5,subdivision:"quarter",curve:"exponential"},durationSync:{mode:"tempo",baseDuration:400,scaling:"inverse"},scaleSync:{onBeat:1.2,offBeat:1,accent:1.4,curve:"elastic"},strobeSync:{enabled:!1,pattern:"XXOX",subdivision:"sixteenth"},dynamics:{forte:{glowPeak:4,scalePeak:1.3,duration:300},piano:{glowPeak:2,scalePeak:1.05,duration:500}}},initialize(e,t){e.gestureData||(e.gestureData={}),e.gestureData.flash={originalOpacity:e.opacity,originalSize:e.size,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.flash?.initialized||this.initialize(e,i);const a=e.gestureData.flash,o={...this.config,...i},c=o.strength||1;let l;if(l=t<.3?t/.3*o.glowPeak:o.glowPeak*(1-(t-.3)/.7),e.opacity=Math.min(1,a.originalOpacity*(1+l*c)),e.size=a.originalSize*(1+(o.scalePeak-1)*l*c*.1),t<.2){const i=(1-t/.2)*c,a=Math.atan2(e.y-r,e.x-s);e.vx+=Math.cos(a)*i*2*n,e.vy+=Math.sin(a)*i*2*n}e.vx*=1-.1*o.particleMotion.decay,e.vy*=1-.1*o.particleMotion.decay},cleanup(e){e.gestureData?.flash&&(e.opacity=e.gestureData.flash.originalOpacity,e.size=e.gestureData.flash.originalSize,delete e.gestureData.flash)}},ot={name:"glow",emoji:"✨",type:"blending",description:"Pure luminous glow without movement",config:{duration:1500,amplitude:0,frequency:1,holdPeak:.3,easing:"sine",scaleAmount:.1,glowAmount:.8,strength:0,direction:"none",particleMotion:{type:"glow",strength:0,direction:"none",frequency:1}},rhythm:{enabled:!0,syncMode:"phrase",amplitudeSync:{onBeat:2,offBeat:1.2,curve:"smooth"},frequencySync:{mode:"phrase",subdivision:"bar"},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:2.5},patternOverrides:{ambient:{amplitudeSync:{onBeat:2.5,offBeat:1.8},durationSync:{bars:4}},electronic:{amplitudeSync:{onBeat:3,offBeat:.5,curve:"sharp"},frequencySync:{subdivision:"quarter"}}}},initialize(e,t,i,n){e.gestureData||(e.gestureData={}),e.gestureData.glow={startOpacity:e.opacity,startGlow:e.glowSizeMultiplier||0,initialized:!0}},apply(e,t,i,n,s,r){e.gestureData?.glow?.initialized||this.initialize(e,i,s,r);const a={...this.config,...i},o=this.easeInOutSine(t);let c,{frequency:l}=a,{glowAmount:h}=a;i.rhythmModulation&&(h*=i.rhythmModulation.amplitudeMultiplier||1,h*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(l*=i.rhythmModulation.frequencyMultiplier));const u=o*l*2%2;c=a.holdPeak>0&&u>1-a.holdPeak&&u<1+a.holdPeak?1:Math.sin(o*Math.PI*2*l);let d=1;t>.9&&(d=.5+.5*(1-10*(t-.9))),e.glowIntensity=1+c*h*d},cleanup(e){e.gestureData?.glow&&(e.glowIntensity=1,delete e.gestureData.glow)},easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2},ct={name:"peek",emoji:"👀",type:"effect",description:"Quick peek and hide motion",config:{peekDistance:40,peekSpeed:.15,holdDuration:200,hideSpeed:.25,stagger:!0,duration:1500},rhythm:{enabled:!0,syncMode:"accent",distanceSync:{onAccent:60,offAccent:25,curve:"quick"},speedSync:{mode:"tempo",fast:.25,slow:.1,hideMultiplier:1.8},durationSync:{mode:"subdivision",beats:.25,staggerBeats:.125,sustain:!1},syncopationResponse:{enabled:!0,multiplier:1.8,type:"distance"},patternOverrides:{funk:{distanceSync:{onAccent:70,offAccent:35,curve:"funky"},syncopationResponse:{multiplier:2.2}},latin:{speedSync:{fast:.3,slow:.12},durationSync:{beats:.5,staggerBeats:.25}},breakbeat:{distanceSync:{onAccent:55,offAccent:40},syncopationResponse:{multiplier:2.5}},classical:{distanceSync:{onAccent:45,offAccent:20,curve:"elegant"},speedSync:{fast:.18,slow:.08}}},dynamics:{forte:{distanceSync:{onAccent:{multiplier:1.6},offAccent:{multiplier:1.3}},speedSync:{multiplier:1.4},syncopationResponse:{multiplier:2.8}},piano:{distanceSync:{onAccent:{multiplier:.6},offAccent:{multiplier:.4}},speedSync:{multiplier:.7},syncopationResponse:{multiplier:1.2}}}},apply(e,t,i,n,s,r){if(e.gestureData||(e.gestureData={}),!e.gestureData.peek){const t=e.x-s,i=e.y-r,n=Math.atan2(i,t),a=Math.sqrt(t*t+i*i);e.gestureData.peek={originalX:e.x,originalY:e.y,peekAngle:n,originalDistance:a,staggerDelay:this.config.stagger?.3*Math.random():0,phase:"waiting",phaseTimer:0,peekOffset:{x:0,y:0}}}const a=e.gestureData.peek,{config:o}=this,c=Math.max(0,Math.min(1,(t-a.staggerDelay)/(1-a.staggerDelay)));0===c?a.phase="waiting":c<.3?a.phase="peeking":c<.6?a.phase="holding":c<1&&(a.phase="hiding");let l=0;switch(a.phase){case"peeking":{const e=c/.3;l=this.easeOutCubic(e)*o.peekDistance;break}case"holding":l=o.peekDistance,Math.random()<.1&&(a.peekOffset.x+=2*(Math.random()-.5),a.peekOffset.y+=2*(Math.random()-.5));break;case"hiding":{const e=(c-.6)/.4;l=(1-this.easeInCubic(e))*o.peekDistance;break}}if("waiting"!==a.phase){const t=Math.cos(a.peekAngle)*l,i=Math.sin(a.peekAngle)*l;a.peekOffset.x+=(t-a.peekOffset.x)*o.peekSpeed,a.peekOffset.y+=(i-a.peekOffset.y)*o.peekSpeed,e.x=a.originalX+a.peekOffset.x,e.y=a.originalY+a.peekOffset.y}void 0!==e.alpha&&("peeking"===a.phase||"holding"===a.phase?e.alpha=.7+.3*Math.random():e.alpha=1)},easeOutCubic:e=>1-Math.pow(1-e,3),easeInCubic:e=>e*e*e,cleanup(e){e.gestureData?.peek&&(e.x=e.gestureData.peek.originalX,e.y=e.gestureData.peek.originalY,void 0!==e.alpha&&(e.alpha=1),delete e.gestureData.peek)}};const lt=(e,t="✨")=>({name:e,emoji:t,type:"blending",description:`${e} animation`,config:{duration:1e3,musicalDuration:{musical:!0,beats:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply:(e,t,i)=>!1,blend:(e,t,i)=>!1}),ht=[Ae,Ie,Re,De,Oe,ze,Be,Fe,Le,qe,lt("sparkle","✨"),{name:"shimmer",emoji:"🌟",type:"particle",description:"Shimmer effect with sparkling particles",config:{duration:2e3,musicalDuration:{musical:!0,bars:1},particleMotion:"radiant"},rhythm:{enabled:!0,syncType:"beat",durationSync:{mode:"bars",bars:1},intensity:.8},override:(e,t,i)=>(e.shimmerEffect=!0,e.shimmerProgress=t,!0),blend:(e,t,i)=>!1},lt("wiggle","〰️"),lt("groove","🎵"),lt("point","👉"),lt("lean","↗️"),lt("reach","🤚"),lt("headBob","🎧"),{name:"rain",emoji:"🌧️",type:"particle",description:"Rain effect with falling particles",config:{duration:3e3,musicalDuration:{musical:!0,bars:2},particleMotion:"falling"},rhythm:{enabled:!0,syncType:"off-beat",durationSync:{mode:"bars",bars:2},intensity:.8},apply:(e,t,i)=>(e.rainEffect=!0,e.rainProgress=t,!0),blend:(e,t,i)=>!1}],ut=[Ge,$e,He,je,We,Ne,Ue,Ve,Ye],dt=[Xe,Qe,Je,Ke,Ze,et,tt,it,nt,st,rt,at,ot,ct,{name:"runningman",emoji:"🏃",type:"effect",description:"Hip-hop running man shuffle",config:{duration:2e3,slideDistance:30,stepHeight:15,speed:1.2,strength:.8,particleMotion:{type:"runningman",strength:.7}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:1,accentBeats:[1,3]},apply:(e,t,i,n,s,r)=>!1,blend:(e,t,i)=>!1},{name:"charleston",emoji:"🕺",type:"effect",description:"Hip-hop Charleston shuffle with crisscross",config:{duration:2500,kickDistance:35,swivelRange:40,bounceHeight:12,strength:.9,particleMotion:{type:"charleston",strength:.8}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:2,accentBeats:[1,2.5,3,4.5]},apply:(e,t,i,n,s,r)=>!1,blend:(e,t,i)=>!1}],pt={};[...ht,...ut,...dt].forEach(e=>{pt[e.name]=e});const mt={blending:ht.map(e=>e.name),override:ut.map(e=>e.name),effect:dt.map(e=>e.name)};function gt(e){if(pt[e])return pt[e];return _e.getPluginGesture(e)||null}function ft(e){const t=gt(e);return!!t&&"blending"===t.type}function yt(e){const t=gt(e);return!!t&&"override"===t.type}function vt(e,t,i,n,s,r,a){const o=gt(t);return!!o&&(o.apply&&o.apply(e,i,n,s,r,a),i>=1&&o.cleanup&&o.cleanup(e),!0)}function bt(){const e=[];return Object.values(pt).forEach(t=>{e.push({name:t.name,emoji:t.emoji||"🎭",type:t.type,description:t.description||"No description",source:"core"})}),_e.getAllPluginGestures().forEach(t=>{const i=_e.getPluginGesture(t);e.push({name:i.name,emoji:i.emoji||"🔌",type:i.type,description:i.description||"Plugin gesture",source:"plugin"})}),e}var wt={GESTURE_REGISTRY:pt,GESTURE_TYPES:mt,getGesture:gt,isBlendingGesture:ft,isOverrideGesture:yt,applyGesture:vt,listGestures:bt,pluginAdapter:_e},St=Object.freeze({__proto__:null,GESTURE_REGISTRY:pt,GESTURE_TYPES:mt,applyGesture:vt,default:wt,getGesture:gt,isBlendingGesture:ft,isOverrideGesture:yt,listGestures:bt,pluginAdapter:_e});class Mt{constructor(e,t,i="ambient",n=1,s=1,r=null){const a=Math.random();this.z=a<1/13?.5+.5*Math.random():.9*Math.random()-1;const o=this.z>0?(20+20*Math.random())*n:3*n,c=Math.random()*Math.PI*2;this.x=e+Math.cos(c)*o,this.y=t+Math.sin(c)*o,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.maxLife=1,this.lifeDecay=.01,this.fadeInTime=.15,this.fadeOutTime=.3,this.isFadingOut=!1,this.age=0,this.scaleFactor=n,this.particleSizeMultiplier=s,this.size=(4+6*Math.random())*n*s,this.baseSize=this.size,this.emotionColors=r,this.color="#ffffff",this.opacity=1,this.hasGlow=Math.random()<.333,this.glowSizeMultiplier=this.hasGlow?1.33+.33*Math.random():0,this.isCellShaded=Math.random()<.333,this.baseOpacity=.3+.4*Math.random(),this.cachedColors=new Map,this.lastColor=null,this.lastOpacity=-1,this.behavior=i,this.behaviorData={},this.gestureData={initialX:e,initialY:t},xe(this,i)}update(e,t,i,n=null,s=null,r=0,a=null){const o=Math.min(e,50)/16.67,c=s&&s.type&&r>0&&yt(s.type);let l,h;if(c?this.applyGestureMotion(s,r,o,t,i):"falling"===this.gestureBehavior?Ce(this,"falling",o,t,i):"radiant"===this.gestureBehavior?Ce(this,"radiant",o,t,i):(Ce(this,this.behavior,o,t,i),s&&r>0&&this.applyGestureMotion(s,r,o,t,i)),c||(this.x+=this.vx*o,this.y+=this.vy*o),a)l=a.width,h=a.height;else{const e=document.getElementById("card-mascot")||document.getElementById("cherokee-guide-mascot")||document.querySelector("canvas");l=e?e.width:2*t,h=e?e.height:2*i}const u=t-l/2+20,d=t+l/2-20,p=i-h/2+20,m=i+h/2-20;this.x-this.size<u?(this.x=u+this.size,this.vx=.5*Math.abs(this.vx)):this.x+this.size>d&&(this.x=d-this.size,this.vx=.5*-Math.abs(this.vx)),this.y-this.size<p?(this.y=p+this.size,this.vy=.5*Math.abs(this.vy)):this.y+this.size>m&&(this.y=m-this.size,this.vy=.5*-Math.abs(this.vy)),this.age+=this.lifeDecay*o,this.age<this.fadeInTime?this.life=this.age/this.fadeInTime:this.age<1-this.fadeOutTime?this.life=1:(this.life=(1-this.age)/this.fadeOutTime,this.isFadingOut=!0,"popcorn"===this.behavior&&(this.size=this.baseSize*(.5+.5*this.life))),this.life=Math.max(0,Math.min(1,this.life)),this.opacity=this.easeInOutCubic(this.life),"burst"===this.behavior&&this.behaviorData&&this.life<this.behaviorData.fadeStart&&(this.size=this.baseSize*(this.life/this.behaviorData.fadeStart))}applyUndertoneModifier(e,t){}applyGestureMotion(e,t,i,n,s){!function(e,t,i,n,s,r){if(!i||!i.type||n>=1)return;e.gestureData||(e.gestureData={originalVx:e.vx,originalVy:e.vy,initialX:e.x,initialY:e.y,startAngle:Math.atan2(e.y-r,e.x-s),startRadius:Math.sqrt(Math.pow(e.x-s,2)+Math.pow(e.y-r,2))});const a=gt(i.type);if(!a)return;let o=i;if(W.isEnabled()&&a.rhythm?.enabled){const s=W.applyGestureRhythm(a,e,n,t);o={...i,amplitude:(i.amplitude||1)*(s.amplitudeMultiplier||1)*(s.accentMultiplier||1),wobbleAmount:(i.wobbleAmount||0)*(s.wobbleMultiplier||1),rhythmModulation:s}}a.apply&&a.apply(e,n,o,t,s,r),n>=.99&&a.cleanup&&(a.cleanup(e),e.gestureData=null)}(this,i,e,t,n,s)}isOutOfBounds(e,t){return this.x<-50||this.x>e+50||this.y<-50||this.y>t+50}isAlive(){return this.life>0}setOutwardVelocity(e){if(this.behaviorData&&void 0!==this.behaviorData.outwardSpeed){const t=this.behaviorData.outwardSpeed;this.vx=Math.cos(e)*t,this.vy=Math.sin(e)*t+(this.behaviorData.upwardBias||0)}}getDepthAdjustedSize(){const e=1+.2*this.z;return this.size*e}getState(){return{position:{x:this.x,y:this.y,z:this.z},velocity:{x:this.vx,y:this.vy,z:this.vz},life:this.life,behavior:this.behavior,size:this.size,opacity:this.opacity}}reset(e,t,i="ambient",n=1,s=1,r=null){const a=Math.random();this.z=a<1/13?.5+.5*Math.random():.9*Math.random()-1;const o=this.z>0?(20+20*Math.random())*n:3*n,c=Math.random()*Math.PI*2;if(this.x=e+Math.cos(c)*o,this.y=t+Math.sin(c)*o,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.age=0,this.scaleFactor=n,this.particleSizeMultiplier=s,this.size=(4+6*Math.random())*n*s,this.baseSize=this.size,this.emotionColors=r,this.cachedColors.clear(),this.opacity=0,this.isFadingOut=!1,this.baseOpacity=.3+.4*Math.random(),this.color="#ffffff",this.behavior=i,this.gestureData=null,this.behaviorData)for(const e in this.behaviorData)delete this.behaviorData[e];else this.behaviorData={};xe(this,i)}getCachedColor(e,t){const i=Math.round(100*t)/100,n=`${e}_${i}`;return this.cachedColors.has(n)||this.cachedColors.set(n,this.hexToRgba(e,i)),this.cachedColors.get(n)}hexToRgba(e,t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?`rgba(${parseInt(i[1],16)}, ${parseInt(i[2],16)}, ${parseInt(i[3],16)}, ${t})`:`rgba(255, 255, 255, ${t})`}easeInOutCubic(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}render(e,t="#ffffff"){if(this.life<=0)return;if(!isFinite(this.x)||!isFinite(this.y))return;const i=this.x,n=this.y,s=Math.max(.1,this.size),r=this.tempColor||this.color||t;if(e.save(),this.isCellShaded){e.strokeStyle=this.getCachedColor(r,.9*this.opacity),e.lineWidth=2,e.beginPath(),e.arc(i,n,s,0,2*Math.PI),e.stroke();const t=Math.floor(3*this.opacity)/3;e.fillStyle=this.getCachedColor(r,t*(this.baseOpacity||.5)*.5),e.beginPath(),e.arc(i,n,Math.max(.1,s-1),0,2*Math.PI),e.fill(),t>.5&&(e.fillStyle=this.getCachedColor("#FFFFFF",.3),e.beginPath(),e.arc(i-.3*s,n-.3*s,.3*s,0,2*Math.PI),e.fill())}else{const t=e.createRadialGradient(i,n,0,i,n,s);if(t.addColorStop(0,this.getCachedColor(r,this.opacity*(this.baseOpacity||.5))),t.addColorStop(.5,this.getCachedColor(r,this.opacity*(this.baseOpacity||.5)*.5)),t.addColorStop(1,this.getCachedColor(r,0)),e.fillStyle=t,e.beginPath(),e.arc(i,n,s,0,2*Math.PI),e.fill(),this.hasGlow&&this.glowSizeMultiplier>0){const t=s*this.glowSizeMultiplier,a=e.createRadialGradient(i,n,.5*s,i,n,t),o=.3,c=Math.max(o,this.opacity),l=Math.min(1,this.glowSizeMultiplier/3);a.addColorStop(0,this.getCachedColor(r,Math.max(.5,.8*c)*l)),a.addColorStop(.25,this.getCachedColor(r,Math.max(.3,.6*c)*l)),a.addColorStop(.5,this.getCachedColor(r,Math.max(.2,.4*c)*l)),a.addColorStop(.75,this.getCachedColor(r,Math.max(.1,.2*c)*l)),a.addColorStop(1,this.getCachedColor(r,0)),e.save(),e.globalCompositeOperation="screen",e.fillStyle=a,e.beginPath(),e.arc(i,n,t,0,2*Math.PI),e.fill(),e.restore()}}e.restore()}}class xt{constructor(e=50){this.poolSize=Math.min(e,50),this.pool=[],this.totalParticlesCreated=0,this.totalParticlesDestroyed=0,this.poolHits=0,this.poolMisses=0}getParticle(e,t,i,n,s,r,a,o=null){let c;return this.pool.length>0?(c=this.pool.pop(),c.reset(e,t,i,n,s,r),this.poolHits++):(c=new Mt(e,t,i,n,s,r),this.poolMisses++,this.totalParticlesCreated++),c.emotion=a,o&&(c.gestureBehavior=o),c}returnParticle(e){if(this.pool.length<this.poolSize){if(e.cachedGradient=null,e.cachedGradientKey=null,e.behaviorData)for(const t in e.behaviorData)delete e.behaviorData[t];this.pool.push(e)}else this.totalParticlesDestroyed++}refreshPool(){const e=this.pool.length-this.poolSize;e>0&&(this.pool.splice(this.poolSize),this.totalParticlesDestroyed+=e)}getStats(){return{poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,totalCreated:this.totalParticlesCreated,totalDestroyed:this.totalParticlesDestroyed}}clear(){this.pool=[],this.poolHits=0,this.poolMisses=0,this.totalParticlesCreated=0,this.totalParticlesDestroyed=0}}class Ct{constructor(){this.spawnAccumulator=0}getSpawnPosition(e,t,i,n,s,r=null){const a=Math.min(n,s)/12,o=2.5*a,c=1.1*o,l=Math.min(t-30,n-t-30),h=Math.min(i-30,s-i-30),u=Math.min(1.5*o,l,h);switch(e){case"ambient":case"resting":{const e=Math.random()*Math.PI*2,n=.9*o;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n,angle:e}}case"rising":case"falling":{const e=Math.random()*Math.PI*2,n=c+Math.random()*(u-c);return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}case"aggressive":{const e=Math.random()*Math.PI*2,n=o+Math.random()*a;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}case"scattering":default:return{x:t,y:i};case"burst":{const e=Math.random()*Math.PI*2;if("suspicion"===r){const n=1.5*a;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}if("surprise"===r){const n=1.2*a;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}return{x:t,y:i}}case"repelling":{const e=Math.random()*Math.PI*2,n=.9*o;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}case"orbiting":{const e=Math.random()*Math.PI*2,n=1.2*o+Math.random()*o*.5;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}case"glitchy":{const e=Math.random()*Math.PI*2,n=3*o+Math.random()*o*4;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}case"spaz":{const e=Math.random()*Math.PI*2,n=2*o+Math.random()*o*3;return{x:t+Math.cos(e)*n,y:i+Math.sin(e)*n}}}}clampToCanvas(e,t,i,n,s=30){return{x:Math.max(s,Math.min(i-s,e)),y:Math.max(s,Math.min(n-s,t))}}calculateSpawnRate(e,t){if(e<=0)return 0;const i=Math.min(t,50),n=e/1e3;this.spawnAccumulator+=n*i,this.spawnAccumulator=Math.min(this.spawnAccumulator,3);let s=0;for(;this.spawnAccumulator>=1;)s++,this.spawnAccumulator-=1;return s}resetAccumulator(){this.spawnAccumulator=0}}class Tt{render(e,t,i="#ffffff",n=null){const s=[];for(const e of t)e.life<=0||s.push(e);this._renderParticles(e,s,i,n)}renderLayer(e,t,i="#ffffff",n=!1,s=null){const r=[],a=e.canvas.width,o=e.canvas.height;for(const e of t)e.z>=0===n&&(e.x<-50||e.x>a+50||e.y<-50||e.y>o+50||e.life<=0||r.push(e));return r.sort((e,t)=>e.isCellShaded!==t.isCellShaded?e.isCellShaded?-1:1:e.hasGlow!==t.hasGlow?e.hasGlow?-1:1:0),this._renderParticles(e,r,i,s),r}_renderParticles(e,t,i,n=null){e.save();let s=null;for(const r of t)if(r.isCellShaded)r.render(e,i),s=null;else{const t=r.color||i;if(t!==s&&(e.fillStyle=t,s=t),!isFinite(r.x)||!isFinite(r.y))continue;const a=r.getDepthAdjustedSize?r.getDepthAdjustedSize():r.size;let o=Math.max(.1,a),c=1;if(n&&n.fireflyEffect){const e=(.01*r.x+.01*r.y+.1*r.size)%(2*Math.PI),t=n.fireflyTime||.001*Date.now(),i=n.particleGlow||2;c=.3+Math.max(0,Math.sin(3*t+e))*i}if(n&&n.flickerEffect){const e=(.02*r.x+.02*r.y)%(2*Math.PI),t=n.flickerTime||.001*Date.now(),i=n.particleGlow||2;c=.5+Math.sin(12*t+e)*i*.5}if(n&&n.shimmerEffect){const t=r.x-e.canvas.width/2,i=r.y-e.canvas.height/2,s=Math.sqrt(t*t+i*i)/200,a=n.shimmerTime||.001*Date.now(),o=n.shimmerWave||0,l=n.particleGlow||1.2;c=1+.15*Math.sin(3*a-s+o)*l}if(n&&n.glowEffect){const t=n.glowProgress||0,i=n.particleGlow||2,s=r.x-e.canvas.width/2,a=r.y-e.canvas.height/2,c=Math.sqrt(s*s+a*a)/300,l=Math.min(.3*c,.5),h=Math.max(0,(t-l)/(1-l)),u=Math.sin(h*Math.PI);r._originalGlow||(r._originalGlow={hasGlow:r.hasGlow,glowSizeMultiplier:r.glowSizeMultiplier||0}),r.hasGlow=!0,r.glowSizeMultiplier=Math.max(3,r._originalGlow.glowSizeMultiplier)+u*i*3,o*=1+.3*u,t>=.99&&r._originalGlow&&(r.hasGlow=r._originalGlow.hasGlow,r.glowSizeMultiplier=r._originalGlow.glowSizeMultiplier,delete r._originalGlow)}if(r.hasGlow||c>1){const t=Math.max(.1,o*(r.glowSizeMultiplier||1.5)*c),i=e.globalCompositeOperation;e.globalCompositeOperation="screen",e.globalAlpha=.15*r.opacity*c,e.beginPath(),e.arc(r.x,r.y,t,0,2*Math.PI),e.fill(),e.globalAlpha=.25*r.opacity*c,e.beginPath(),e.arc(r.x,r.y,.6*t,0,2*Math.PI),e.fill(),e.globalCompositeOperation=i}e.globalAlpha=r.opacity*(r.baseOpacity||.5)*.6*Math.min(2,c),e.beginPath(),e.arc(r.x,r.y,o,0,2*Math.PI),e.fill()}e.restore()}}class kt{constructor(e=50,t=null){this.errorBoundary=t,this.maxParticles=e,this.absoluteMaxParticles=2*e,this.particles=[],this.particlePool=new xt(e),this.particleSpawner=new Ct,this.particleRenderer=new Tt,this.containmentBounds=null,this.stateChangeCount=0,this.lastMemoryCheck=Date.now(),this.lastLeakedCount=0,this.particleCount=0,this.cleanupTimer=0,this.cleanupInterval=5e3}get pool(){return this.particlePool.pool}get poolSize(){return this.particlePool.poolSize}get poolHits(){return this.particlePool.poolHits}get poolMisses(){return this.particlePool.poolMisses}get totalParticlesCreated(){return this.particlePool.totalParticlesCreated}get totalParticlesDestroyed(){return this.particlePool.totalParticlesDestroyed}get spawnAccumulator(){return this.particleSpawner.spawnAccumulator}set spawnAccumulator(e){this.particleSpawner.spawnAccumulator=e}getParticleFromPool(e,t,i){return this.particlePool.getParticle(e,t,i,this.scaleFactor||1,this.particleSizeMultiplier||1,this.currentEmotionColors,this.currentEmotion,this.gestureBehavior)}returnParticleToPool(e){this.particlePool.returnParticle(e)}spawn(e,t,i,n,s,r,a=null,o=0,c=10,l=1,h=1,u=null,d=null){if(this.scaleFactor=l,this.particleSizeMultiplier=h,this.errorBoundary)return this.errorBoundary.wrap(()=>{this._spawn(e,t,i,n,s,r,a,o,c,u,d)},"particle-spawn")();this._spawn(e,t,i,n,s,r,a,o,c,u,d)}resetAccumulator(){this.particleSpawner.resetAccumulator()}_spawn(e,t,i,n,s,r,a,o=0,c=10,h=null,u=null){this.currentEmotion=t,this.baseEmotionColors=h,this.currentUndertone=u,this.currentEmotionColors=h&&u?function(e,t){return e&&Array.isArray(e)&&t&&"clear"!==t?e.map(e=>"string"==typeof e?l(e,t):e&&"object"==typeof e&&e.color?{...e,color:l(e.color,t)}:e):e}(h,u):h;let d=i;if(W.isEnabled()){const i=$&&$.isInitialized?$.getEmotion(t):A(t);if(i){const t=W.applyParticleRhythm(i,this);if(t.emitBurst)for(let i=0;i<t.emitBurst&&this.particles.length<c;i++)this.spawnSingleParticle(e,n,s);void 0!==t.emissionRate&&(d*=t.emissionRate)}}if(null!==a){for(let t=0;t<a&&this.particles.length<this.maxParticles;t++)this.spawnSingleParticle(e,n,s);return}if(this.skipSpawnThisFrame)return;for(;this.particles.length<o&&this.particles.length<this.maxParticles;)this.spawnSingleParticle(e,n,s);if(this.particles.length>=c)return;if(d<=0)return;const p=this.particleSpawner.calculateSpawnRate(d,r);for(let t=0;t<p&&this.particles.length<c;t++)this.spawnSingleParticle(e,n,s)}getSpawnPosition(e,t,i,n,s){return this.particleSpawner.getSpawnPosition(e,t,i,n,s,this.currentEmotion)}clampToCanvas(e,t,i,n,s=30){return this.particleSpawner.clampToCanvas(e,t,i,n,s)}spawnSingleParticle(e,t,i){if(this.particles.length>=this.absoluteMaxParticles)return;const n=this.canvasWidth||2*t,s=this.canvasHeight||2*i,r=this.particleSpawner.getSpawnPosition(e,t,i,n,s,this.currentEmotion),a=this.particleSpawner.clampToCanvas(r.x,r.y,n,s);r.x=a.x,r.y=a.y;const o=this.getParticleFromPool(r.x,r.y,e);"meditation_swirl"===e&&r.palmCenter&&(o.palmCenter=r.palmCenter,o.swirlAngle=r.swirlAngle),this.particles.push(o),this.particleCount++}update(e,t,i,n=null,s=0,r=null){if(this.errorBoundary)return this.errorBoundary.wrap((e,t,i,n,s,r)=>this._update(e,t,i,n,s,r),"particle-update")(e,t,i,n,s,r);this._update(e,t,i,n,s,r)}_update(e,t,i,n=null,s=0,r=null){for(this.particles=this.particles.filter(a=>(a.update(e,t,i,r,n,s,this.containmentBounds),a.isAlive()));this.particles.length>this.maxParticles;)this.removeParticle(0)}setGestureBehavior(e,t){this.gestureBehavior=t?e:null,t?this.particles.forEach(t=>{t.gestureBehavior=e}):this.particles.forEach(e=>{e.gestureBehavior=null})}removeParticle(e){if(e>=0&&e<this.particles.length){const t=this.particles.splice(e,1)[0];t.cachedGradient=null,t.cachedGradientKey=null,this.returnParticleToPool(t),this.particleCount=Math.max(0,this.particleCount-1)}}render(e,t="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._render(e,t,i)},"particle-render")();this._render(e,t,i)}renderBackground(e,t="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._renderLayer(e,t,!1,i)},"particle-render-bg")();this._renderLayer(e,t,!1,i)}renderForeground(e,t="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._renderLayer(e,t,!0,i)},"particle-render-fg")();this._renderLayer(e,t,!0,i)}_renderLayer(e,t,i,n=null){this.particleRenderer.renderLayer(e,this.particles,t,i,n)}_render(e,t,i=null){this.particleRenderer.render(e,this.particles,t,i)}clear(){for(this.stateChangeCount++;this.particles.length>0;){const e=this.particles.pop();if(e.cachedColors&&e.cachedColors.clear(),e.behaviorData)for(const t in e.behaviorData)delete e.behaviorData[t];this.pool.length<this.poolSize&&!this.pool.includes(e)&&this.pool.push(e)}if(this.particles.length=0,this.particleCount=0,this.spawnAccumulator=0,this.pool.length>this.poolSize){const e=this.pool.length-this.poolSize;this.pool.splice(this.poolSize,e)}}burst(e,t,i,n){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this._burst(e,t,i,n)},"particle-burst")();this._burst(e,t,i,n)}_burst(e,t,i,n){const s=Math.min(e,this.maxParticles-this.particles.length);for(let e=0;e<s;e++)this.spawnSingleParticle(t,i,n)}performCleanup(){if(this.pool.length>this.poolSize){const e=this.pool.length-this.poolSize;for(let t=0;t<e;t++){const e=this.pool.pop();e&&(e.cachedGradient=null,e.cachedGradientKey=null,e.behaviorData=null)}}for(const e of this.particles)e.cachedGradient&&e.life<.5&&(e.cachedGradient=null,e.cachedGradientKey=null)}getStats(){return{activeParticles:this.particles.length,maxParticles:this.maxParticles,poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,poolEfficiency:this.poolHits/Math.max(1,this.poolHits+this.poolMisses),spawnAccumulator:this.spawnAccumulator}}setMaxParticles(e){for(this.originalMaxParticles=this.originalMaxParticles||this.maxParticles,this.maxParticles=Math.max(1,e);this.particles.length>this.maxParticles;)this.removeParticle(0)}cleanupDeadParticles(){const e=this.particles.length;this.particles=this.particles.filter(e=>e.isAlive());const t=e-this.particles.length;return this.pool.length>20&&(this.pool.length=20),t}getParticlesByBehavior(e){return this.particles.filter(t=>t.behavior===e)}validateParticles(){for(const e of this.particles)if(!e.isAlive()||e.life<0||e.life>1)return!1;return!0}cleanup(){for(let e=this.particles.length-1;e>=0;e--)this.particles[e].isAlive()||this.removeParticle(e)}refreshPool(){this.particlePool.clear();for(const e of this.particles)e.life=0}setContainmentBounds(e){this.containmentBounds=e}destroy(){this.clear(),this.particlePool.clear()}}const Et=new class{constructor(){this.gestureCache=new Map,this.propertyCache=new Map,this.compositionCache=new Map,this.pluginCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{this.cacheCoreGestures(),this.cacheGestureProperties(),this.cacheCommonCombinations(),this.cachePluginGestures(),this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.gestureCache.size+this.propertyCache.size+this.compositionCache.size,this.isInitialized=!0}catch(e){console.error("GestureCache initialization failed:",e),this.isInitialized=!1}}cacheCoreGestures(){Object.values(pt).forEach(e=>{e&&e.name&&this.gestureCache.set(e.name,{...e,cached:!0,cacheTime:performance.now()})})}cacheGestureProperties(){this.gestureCache.forEach((e,t)=>{const i={type:e.type,emoji:e.emoji,description:e.description,config:e.config,rhythm:e.rhythm,duration:this.calculateGestureDuration(e),easing:this.extractEasingFunction(e),physics:this.extractPhysicsProperties(e),timing:this.extractTimingProperties(e)};this.propertyCache.set(t,i)})}cacheCommonCombinations(){[["bounce","pulse"],["shake","vibrate"],["orbit","spin"],["morph","glow"],["breathe","fade"],["wave","drift"],["nod","sway"],["jump","stretch"]].forEach(([e,t])=>{const i=`${e}+${t}`,n=this.calculateGestureCombination(e,t);n&&this.compositionCache.set(i,n)})}cachePluginGestures(){try{const e=_e.getAllPluginGestures();e&&Object.entries(e).forEach(([e,t])=>{this.pluginCache.set(e,{...t,cached:!0,cacheTime:performance.now(),isPlugin:!0})})}catch(e){console.warn("Could not cache plugin gestures:",e)}}getGesture(e){return this.gestureCache.has(e)?(this.stats.hits++,this.stats.gestureHits++,this.gestureCache.get(e)):this.pluginCache.has(e)?(this.stats.hits++,this.stats.gestureHits++,this.pluginCache.get(e)):(this.stats.misses++,null)}getGestureProperties(e){return this.propertyCache.has(e)?(this.stats.hits++,this.stats.propertyHits++,this.propertyCache.get(e)):(this.stats.misses++,null)}getGestureCombination(e,t){const i=`${e}+${t}`;return this.compositionCache.has(i)?(this.stats.hits++,this.stats.compositionHits++,this.compositionCache.get(i)):(this.stats.misses++,null)}calculateGestureDuration(e){if(!e.config)return 1e3;const{musicalDuration:t,duration:i}=e.config;return t&&t.musical?500*(t.beats||2):i||1e3}extractEasingFunction(e){if(!e.config)return"sine";const{easing:t,particleMotion:i}=e.config;return t||i?.easing||"sine"}extractPhysicsProperties(e){if(!e.config)return{};const{amplitude:t,strength:i,size:n,rotation:s}=e.config;return{amplitude:t||20,strength:i||1,size:n||80,rotation:s||0}}extractTimingProperties(e){if(!e.config)return{};const{phases:t,timingSync:i}=e.config;return{phases:t||[],timingSync:i||{},hasPhases:!!(t&&t.length>0),hasTimingSync:!!(i&&Object.keys(i).length>0)}}calculateGestureCombination(e,t){const i=this.getGesture(e),n=this.getGesture(t);return i&&n?{gestures:[e,t],combinedDuration:Math.max(this.calculateGestureDuration(i),this.calculateGestureDuration(n)),combinedType:i.type===n.type?i.type:"mixed",combinedEasing:this.extractEasingFunction(i),combinedPhysics:this.combinePhysicsProperties(i,n),compatibility:this.calculateCompatibility(i,n)}:null}combinePhysicsProperties(e,t){const i=this.extractPhysicsProperties(e),n=this.extractPhysicsProperties(t);return{amplitude:Math.max(i.amplitude,n.amplitude),strength:(i.strength+n.strength)/2,size:Math.max(i.size,n.size),rotation:(i.rotation+n.rotation)/2}}calculateCompatibility(e,t){return e.type===t.type?"high":"blending"===e.type&&"blending"===t.type?"medium":"override"===e.type||"override"===t.type?"low":"medium"}getStats(){const e=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(1):0;return{...this.stats,hitRate:`${e}%`,isInitialized:this.isInitialized,cacheSize:this.stats.cacheSize,coreGestures:this.gestureCache.size,pluginGestures:this.pluginCache.size,properties:this.propertyCache.size,combinations:this.compositionCache.size}}clear(){this.gestureCache.clear(),this.propertyCache.clear(),this.compositionCache.clear(),this.pluginCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1}warmUp(e){e.forEach(e=>{this.getGesture(e),this.getGestureProperties(e)})}};function Pt(e){if(Et&&Et.isInitialized){const t=Et.getGesture(e);if(t)return t}return gt(e)}const _t={none:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},clear:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},nervous:{speed:1.2,amplitude:.9,intensity:1.1,smoothness:.7,regularity:.6,addFlutter:!0,addMicroShake:!0},confident:{speed:.9,amplitude:1.3,intensity:1.2,smoothness:1.1,regularity:1.2,addPower:!0,addHold:!0},tired:{speed:.7,amplitude:.7,intensity:.8,smoothness:1.3,regularity:.8,addDroop:!0,addPause:!0},intense:{speed:1.3,amplitude:1.2,intensity:1.4,smoothness:.6,regularity:.9,addPulse:!0,addFocus:!0},subdued:{speed:.8,amplitude:.8,intensity:.7,smoothness:1.2,regularity:1.1,addSoftness:!0,addFade:!0}};class At{constructor(){this.cache=new Map,this.easingCache=new Map,this.preCalculateEasingCurves()}preCalculateEasingCurves(){const e=["linear","ease-in","ease-out","ease-in-out","bounce"];for(const t of e){const e=new Float32Array(101);for(let i=0;i<=100;i++){const n=i/100;e[i]=this.calculateEasing(n,t)}this.easingCache.set(t,e)}}calculateEasing(e,t){switch(t){case"ease-in":return e*e;case"ease-out":return e*(2-e);case"ease-in-out":return e<.5?2*e*e:(4-2*e)*e-1;case"bounce":return e<.363636?7.5625*e*e:e<.727272?7.5625*(e-=.545454)*e+.75:e<.90909?7.5625*(e-=.818181)*e+.9375:7.5625*(e-=.954545)*e+.984375;default:return e}}getEasingValue(e,t){const i=this.easingCache.get(t);return i?i[Math.min(Math.floor(100*e),100)]:e}compose(e,t,i=null){const n=`${e}-${t}-${i||"none"}`;if(this.cache.has(n))return this.cache.get(n);const s=Pt(e),r=s?s.config:{duration:500,amplitude:20,easing:"sine"},a=$&&$.isInitialized?$.getModifiers(t):R(t),o=function(e){return e&&""!==e&&"clear"!==e&&_t[e]||_t.clear}(i),c=this.applyModifiers(r,a,o,e);return this.cache.size>100&&this.cache.clear(),this.cache.set(n,c),c}applyModifiers(e,t,i,n){const s={...e},r=t.speed*i.speed;if(s.duration=Math.round(e.duration/r),void 0!==s.amplitude&&(s.amplitude=e.amplitude*t.amplitude*i.amplitude),void 0!==s.scaleAmount&&(s.scaleAmount=e.scaleAmount*t.intensity*i.intensity),void 0!==s.scaleTarget){const n=t.amplitude*i.amplitude;s.scaleTarget=1+(e.scaleTarget-1)*n}void 0!==s.glowAmount&&(s.glowAmount=e.glowAmount*t.intensity*i.intensity),void 0!==s.glowPeak&&(s.glowPeak=1+(e.glowPeak-1)*t.intensity*i.intensity),void 0!==s.rotations&&(s.rotations=e.rotations*t.amplitude*i.amplitude),void 0!==s.angle&&(s.angle=e.angle*t.amplitude*i.amplitude),void 0!==s.distance&&(s.distance=e.distance*t.amplitude*i.amplitude);const a=t.smoothness*i.smoothness;return s.smoothness=a,s.easing=this.selectEasing(e.easing,a),s.regularity=t.regularity*i.regularity,s.effects=[],t.addBounce&&s.effects.push("bounce"),t.addGravity&&s.effects.push("gravity"),t.addShake&&s.effects.push("shake"),t.addJitter&&s.effects.push("shake"),t.addPop&&s.effects.push("pop"),t.addRecoil&&s.effects.push("recoil"),t.addWarmth&&s.effects.push("warmth"),t.addFlow&&s.effects.push("flow"),t.addWobble&&s.effects.push("wobble"),t.addVibration&&s.effects.push("vibration"),t.addDrag&&s.effects.push("drag"),t.addWeight&&s.effects.push("weight"),t.addTension&&s.effects.push("tension"),t.addPrecision&&s.effects.push("precision"),i.addFlutter&&s.effects.push("flutter"),i.addMicroShake&&s.effects.push("microShake"),i.addPower&&s.effects.push("power"),i.addHold&&s.effects.push("hold"),i.addDroop&&s.effects.push("droop"),i.addPause&&s.effects.push("pause"),i.addPulse&&s.effects.push("pulse"),i.addFocus&&s.effects.push("focus"),i.addSoftness&&s.effects.push("softness"),i.addFade&&s.effects.push("fade"),this.applyGestureSpecificMods(s,n,t,i),e.particleMotion&&(s.particleMotion={...e.particleMotion},void 0!==s.particleMotion.strength&&(s.particleMotion.strength*=t.intensity*i.intensity),void 0!==s.particleMotion.frequency&&(s.particleMotion.frequency*=r),void 0!==s.particleMotion.amplitude&&(s.particleMotion.amplitude*=t.amplitude*i.amplitude)),s}selectEasing(e,t){return t<.5?"linear":t<.8?"quad":t<1.2?e:t<1.5?"cubic":"sine"}applyGestureSpecificMods(e,t,i,n){switch(t){case"bounce":i.addShake&&(e.frequency=Math.floor(1.5*e.frequency)),i.addGravity&&(e.amplitude*=.6,e.frequency=1);break;case"pulse":i.addWarmth&&(e.frequency=2,e.glowAmount*=1.5),n.addFlutter&&(e.irregular=!0);break;case"shake":i.addJitter&&(e.frequency*=1.5,e.amplitude*=1.2),i.addShake&&(e.amplitude*=1.5,e.decay=!1);break;case"spin":i.addBounce&&(e.rotations*=1.5),i.addWobble&&(e.wobble=!0)}}clearCache(){this.cache.clear()}}var It={name:"zen-vortex",emoji:"🌀",description:"Swirling meditation vortex effect",config:{vortexSpeed:.02,spiralTightness:.15,maxRadius:1.5,lineWidth:2,segments:50,arms:3,fadeStart:.7,baseOpacity:.3,pulseSpeed:.01},state:{rotation:0,pulsePhase:0,intensity:0},shouldActivate:e=>"zen"===e.emotion||e.zenTransition?.active,apply(e,t){const{x:i,y:n,radius:s,intensity:r=1,deltaTime:a=16.67}=t;this.state.rotation+=this.config.vortexSpeed*(a/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(a/16.67),this.state.intensity=r,e.save();for(let t=0;t<this.config.arms;t++){const r=2*Math.PI/this.config.arms*t;this.drawSpiralArm(e,i,n,s,r)}this.drawMeditationEyes(e,i,n,.6*s,r),e.restore()},drawSpiralArm(e,t,i,n,s){e.beginPath();const r=1+.1*Math.sin(this.state.pulsePhase);for(let a=0;a<=this.config.segments;a++){const o=a/this.config.segments,c=this.state.rotation+s+o*Math.PI*4,l=o*n*this.config.maxRadius*r,h=t+Math.cos(c)*l,u=i+Math.sin(c)*l;0===a?e.moveTo(h,u):e.lineTo(h,u)}const a=e.createLinearGradient(t-n,i,t+n,i),o=this.config.baseOpacity*this.state.intensity;a.addColorStop(0,"rgba(147, 112, 219, 0)"),a.addColorStop(.3,`rgba(147, 112, 219, ${.5*o})`),a.addColorStop(this.config.fadeStart,`rgba(147, 112, 219, ${o})`),a.addColorStop(1,"rgba(147, 112, 219, 0)"),e.strokeStyle=a,e.lineWidth=this.config.lineWidth,e.stroke()},drawMeditationEyes(e,t,i,n,s){e.save();const r=.4*n,a=.3*n;e.strokeStyle=`rgba(255, 255, 255, ${.8*s})`,e.lineWidth=2,e.beginPath(),e.arc(t-a,i,r,Math.PI,0,!0),e.stroke(),e.beginPath(),e.arc(t+a,i,r,Math.PI,0,!0),e.stroke(),e.restore()},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.intensity=0}},Rt={name:"recording-glow",emoji:"🔴",description:"Pulsating red recording indicator",config:{color:"#FF0000",pulseSpeed:.08,minIntensity:.6,maxIntensity:1,radiusMultiplier:2,gradientStops:[{position:0,opacity:1},{position:.3,opacity:.7},{position:.6,opacity:.4},{position:.85,opacity:.2},{position:1,opacity:0}]},state:{pulsePhase:0,intensity:.8},shouldActivate:e=>!0===e.recording,apply(e,t){const{deltaTime:i=16.67}=t;this.state.pulsePhase+=this.config.pulseSpeed*(i/16.67);const n=(Math.sin(this.state.pulsePhase)+1)/2;return this.state.intensity=this.config.minIntensity+(this.config.maxIntensity-this.config.minIntensity)*n,!0},drawRecordingIndicator(e,t,i){e.save();const n=Math.min(t,i),s=Math.floor(.08*n),r=1.5*s,a=1.5*s,o=.3*s;e.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),e.beginPath(),e.arc(r-s,a,o,0,2*Math.PI),e.fill(),e.strokeStyle=this.hexToRgba("#FFFFFF",.8*this.state.intensity),e.lineWidth=3,e.font=`bold ${s}px 'Arial', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.strokeText("REC",r,a),e.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),e.fillText("REC",r,a),e.restore()},hexToRgba:(e,t)=>`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`,reset(){this.state.pulsePhase=0,this.state.intensity=0}},Dt={name:"speaking-pulse",emoji:"🗣️",description:"Audio-reactive pulse when speaking",config:{scaleMultiplier:.15,smoothing:.1,minPulse:.02,colorShift:!0,ringEffect:!0},state:{audioLevel:0,smoothedLevel:0,rings:[]},shouldActivate:e=>!0===e.speaking,apply(e,t){const{x:i,y:n,radius:s,audioLevel:r=0,deltaTime:a=16.67}=t;this.state.smoothedLevel+=(r-this.state.smoothedLevel)*this.config.smoothing,r>.5&&this.state.audioLevel<=.5&&this.state.rings.push({radius:s,opacity:.5,speed:2}),this.config.ringEffect&&this.drawRings(e,i,n,a),this.state.audioLevel=r},drawRings(e,t,i,n){e.save(),e.strokeStyle="rgba(100, 200, 255, 0.5)",e.lineWidth=2;for(let s=this.state.rings.length-1;s>=0;s--){const r=this.state.rings[s];r.radius+=r.speed*(n/16.67),r.opacity-=n/16.67*.02,r.opacity<=0?this.state.rings.splice(s,1):(e.globalAlpha=r.opacity,e.beginPath(),e.arc(t,i,r.radius,0,2*Math.PI),e.stroke())}e.restore()},getScaleModifier(){return 1+this.state.smoothedLevel*this.config.scaleMultiplier}},Ot={name:"sleeping",emoji:"😴",description:"Sleeping with closed eyes and Z particles",config:{eyeClosedScale:.1,breathingDepth:.15,breathingRate:.8,zParticleInterval:2e3,zDriftSpeed:1,zFadeSpeed:.01,orbDimming:.3,glowDimming:.2},state:{lastZSpawn:0,zParticles:[]},shouldActivate:e=>!0===e.sleeping||"resting"===e.emotion,apply(e,t){const{x:i,y:n,radius:s,deltaTime:r=16.67}=t,a=Date.now();if(a-this.state.lastZSpawn>this.config.zParticleInterval){const e=[100,200,300,400,500,600,700,800,900],t=e[Math.floor(Math.random()*e.length)];this.state.zParticles.push({x:i+s,y:n-s,opacity:1,size:12+8*Math.random(),drift:.5*Math.random()-.25,weight:t,rotation:30*Math.random()-15}),this.state.lastZSpawn=a}this.drawZParticles(e,r)},drawZParticles(e,t){e.save(),e.textAlign="center",e.textBaseline="middle";for(let i=this.state.zParticles.length-1;i>=0;i--){const n=this.state.zParticles[i];n.y-=this.config.zDriftSpeed*(t/16.67),n.x+=n.drift*(t/16.67),n.opacity-=this.config.zFadeSpeed*(t/16.67),n.rotation+=t/16.67*.5,n.opacity<=0?this.state.zParticles.splice(i,1):(e.save(),e.translate(n.x,n.y),e.rotate(n.rotation*Math.PI/180),e.globalAlpha=.7*n.opacity,e.fillStyle="rgba(255, 255, 255, 0.9)",e.font=`${n.weight} ${n.size}px 'Poppins', sans-serif`,e.fillText("Z",0,0),e.shadowBlur=3,e.shadowColor="rgba(147, 112, 219, 0.5)",e.fillText("Z",0,0),e.restore())}e.restore()},getEyeOpenness(){return this.config.eyeClosedScale},getBreathingModifiers(){return{rate:this.config.breathingRate,depth:this.config.breathingDepth}},getDimmingValues(){return{orbDimming:this.config.orbDimming,glowDimming:this.config.glowDimming}}},zt={name:"suspicion-scan",emoji:"🔍",description:"Suspicious scanning and squinting",config:{squintAmount:.4,scanInterval:5e3,scanDuration:800,scanAngle:45,squintSpeed:.02,pupilShift:.3},state:{currentSquint:0,targetSquint:0,lastScanTime:0,scanPhase:0,scanning:!1},shouldActivate:e=>"suspicion"===e.emotion||!0===e.suspicious,apply(e,t){const{deltaTime:i=16.67}=t,n=Date.now();this.updateSquint(i),n-this.state.lastScanTime>this.config.scanInterval&&(this.startScan(),this.state.lastScanTime=n),this.state.scanning&&this.updateScan(n,i)},updateSquint(e){this.state.targetSquint=this.config.squintAmount;const t=this.state.targetSquint-this.state.currentSquint;Math.abs(t)>.01?this.state.currentSquint+=t*this.config.squintSpeed*(e/16.67):this.state.currentSquint=this.state.targetSquint},startScan(){this.state.scanning=!0,this.state.scanStartTime=Date.now(),this.state.scanPhase=-1},updateScan(e,t){const i=(e-this.state.scanStartTime)/this.config.scanDuration;i<.33?this.state.scanPhase=-1:i<.66?this.state.scanPhase=1:(i<1||(this.state.scanning=!1),this.state.scanPhase=0)},getEyeModifiers(){return{scaleY:1-this.state.currentSquint,scaleX:1+.3*this.state.currentSquint,offsetX:this.state.scanPhase*this.config.pupilShift}},drawScanLines(e,t,i,n){if(!this.state.scanning)return;e.save(),e.strokeStyle="rgba(255, 165, 0, 0.3)",e.lineWidth=1,e.setLineDash([5,5]);const s=this.state.scanPhase*(this.config.scanAngle*Math.PI/180),r=t+Math.cos(s)*n*2,a=i+Math.sin(s)*n*.5;e.beginPath(),e.moveTo(t,i),e.lineTo(r,a),e.stroke(),e.restore()}},Bt={name:"gaze-narrowing",emoji:"👁️",description:"Eye narrowing based on gaze proximity",config:{maxHorizontalScale:1.3,maxVerticalScale:.5,smoothing:.1,focusThreshold:.3},state:{currentScaleX:1,currentScaleY:1,targetScaleX:1,targetScaleY:1},shouldActivate:e=>e.gazeIntensity>0||e.gazeLocked,apply(e,t){const{gazeIntensity:i=0,deltaTime:n=16.67}=t;if(i>this.config.focusThreshold){const e=(i-this.config.focusThreshold)/(1-this.config.focusThreshold);this.state.targetScaleX=1+(this.config.maxHorizontalScale-1)*e,this.state.targetScaleY=1-(1-this.config.maxVerticalScale)*e}else this.state.targetScaleX=1,this.state.targetScaleY=1;this.animateScales(n)},animateScales(e){const t=this.config.smoothing*(e/16.67),i=this.state.targetScaleX-this.state.currentScaleX;Math.abs(i)>.001&&(this.state.currentScaleX+=i*t);const n=this.state.targetScaleY-this.state.currentScaleY;Math.abs(n)>.001&&(this.state.currentScaleY+=n*t)},getEyeScales(){return{scaleX:this.state.currentScaleX,scaleY:this.state.currentScaleY}},drawFocusIndicator(e,t,i,n,s){if(s<this.config.focusThreshold)return;e.save();const r=.5*(s-this.config.focusThreshold);e.strokeStyle=`rgba(100, 200, 255, ${r})`,e.lineWidth=1,e.setLineDash([2,4]);const a=[0,60,120,180,240,300];for(const s of a){const r=s*Math.PI/180,a=2*n,o=1.2*n;e.beginPath(),e.moveTo(t+Math.cos(r)*a,i+Math.sin(r)*a),e.lineTo(t+Math.cos(r)*o,i+Math.sin(r)*o),e.stroke()}e.restore()}},Ft={name:"fingerprint",emoji:"👆",description:"Biometric fingerprint pattern for authentication UI",config:{rings:8,ringSpacing:15,lineWidth:1.5,rotationSpeed:.001,pulseSpeed:.02,waveAmplitude:3,waveFrequency:8,breakPoints:5,opacity:.4,scanLineSpeed:.01,scanLineWidth:3,color:"#00CED1",glowColor:"#00FFFF",successColor:"#00FF00",failColor:"#FF0000"},state:{rotation:0,pulsePhase:0,scanPosition:0,scanDirection:1,isScanning:!1,scanResult:null,breaks:[],whorls:[]},shouldActivate:e=>!0===e.biometric||!0===e.fingerprint||!0===e.authenticating,initialize(){this.state.breaks=[];for(let e=0;e<this.config.rings;e++){const e=[];for(let t=0;t<this.config.breakPoints;t++)e.push(Math.random()*Math.PI*2);this.state.breaks.push(e)}this.state.whorls=[{x:.2,y:-.1,strength:.3},{x:-.15,y:.2,strength:.25},{x:0,y:0,strength:.5}]},apply(e,t){const{x:i,y:n,radius:s,deltaTime:r=16.67,scanning:a=!1,authResult:o=null}=t;0===this.state.breaks.length&&this.initialize(),this.state.rotation+=this.config.rotationSpeed*(r/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(r/16.67),(a||this.state.isScanning)&&(this.state.isScanning=!0,this.state.scanPosition+=this.config.scanLineSpeed*this.state.scanDirection*(r/16.67),this.state.scanPosition>1?(this.state.scanPosition=1,this.state.scanDirection=-1):this.state.scanPosition<-1&&(this.state.scanPosition=-1,this.state.scanDirection=1)),e.save(),this.drawFingerprintPattern(e,i,n,s),this.state.isScanning&&this.drawScanLine(e,i,n,s),o&&this.showAuthResult(e,i,n,s,o),e.restore()},drawFingerprintPattern(e,t,i,n){const s=.1*Math.sin(this.state.pulsePhase)+1;for(let r=0;r<this.config.rings;r++){const a=(r+1)*this.config.ringSpacing*s;if(!(a>2*n)){e.beginPath(),e.strokeStyle=this.config.color,e.lineWidth=this.config.lineWidth,e.globalAlpha=this.config.opacity*(1-r/this.config.rings*.5);for(let s=0;s<2*Math.PI;s+=.05){let o=!1;for(const e of this.state.breaks[r]||[])if(Math.abs(s-e)<.1){o=!0;break}if(o){e.stroke(),e.beginPath();continue}let c=a,l=s+this.state.rotation;for(const e of this.state.whorls){const s=t+e.x*n,r=i+e.y*n,a=t+Math.cos(l)*c,o=i+Math.sin(l)*c,h=Math.sqrt(Math.pow(a-s,2)+Math.pow(o-r,2));l+=Math.exp(-h/(.5*n))*e.strength*.5}c+=Math.sin(s*this.config.waveFrequency)*this.config.waveAmplitude;const h=t+Math.cos(l)*c,u=i+Math.sin(l)*c;0===s?e.moveTo(h,u):e.lineTo(h,u)}e.stroke()}}},drawScanLine(e,t,i,n){const s=i+this.state.scanPosition*n,r=e.createLinearGradient(t-n,s,t+n,s);r.addColorStop(0,"rgba(0, 255, 255, 0)"),r.addColorStop(.5,this.config.glowColor),r.addColorStop(1,"rgba(0, 255, 255, 0)"),e.strokeStyle=r,e.lineWidth=this.config.scanLineWidth,e.globalAlpha=.8,e.shadowBlur=10,e.shadowColor=this.config.glowColor,e.beginPath(),e.moveTo(t-n,s),e.lineTo(t+n,s),e.stroke(),e.shadowBlur=0},showAuthResult(e,t,i,n,s){const r="success"===s?this.config.successColor:this.config.failColor,a="success"===s?"✓ AUTHENTICATED":"✗ ACCESS DENIED";e.fillStyle=r,e.font=`bold ${.15*n}px monospace`,e.textAlign="center",e.textBaseline="middle",e.globalAlpha=.9,e.fillText(a,t,i+1.3*n),e.strokeStyle=r,e.lineWidth=3,e.globalAlpha=.5,e.beginPath(),e.arc(t,i,1.1*n,0,2*Math.PI),e.stroke()},startScan(){this.state.isScanning=!0,this.state.scanPosition=-1,this.state.scanDirection=1,this.state.scanResult=null},completeScan(e=!0){this.state.isScanning=!1,this.state.scanResult=e?"success":"fail",setTimeout(()=>{this.state.scanResult=null},2e3)},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.scanPosition=0,this.state.scanDirection=1,this.state.isScanning=!1,this.state.scanResult=null}};const Lt=new Map;function qt(e){e.name&&Lt.set(e.name,e)}function Gt(e){return Lt.get(e)||null}function $t(e,t,i){const n=Gt(e);return!!n&&!!n.apply&&(n.apply(t,i),!0)}function Ht(e,t){const i=Gt(e);return!(!i||!i.shouldActivate)&&i.shouldActivate(t)}qt(It),qt(Rt),qt(Dt),qt(Ot),qt(zt),qt(Bt),qt(Ft);const jt=new class{constructor(){this.noteDurations={whole:4,half:2,quarter:1,eighth:.5,sixteenth:.25,triplet:.333,"dotted-quarter":1.5,"dotted-half":3},this.cache=new Map,this.lastBPM=0,this.prewarmCache()}prewarmCache(){const e=[{musical:!0,beats:1},{musical:!0,bars:1},{musical:!0,beats:.5},{musical:!0,beats:2}];[60,90,120,140,160,180].forEach(t=>{e.forEach(e=>{const i=`${t}_${JSON.stringify(e)}`,n=this.toMilliseconds(e,t);this.cache.set(i,n)})})}toMilliseconds(e,t=null){const i=t||j.bpm||120;if("number"==typeof e)return e;if("object"==typeof e&&e.musical){const t=6e4/i;if(void 0!==e.beats)return e.beats*t;if(void 0!==e.bars){const i=j.timeSignature||[4,4];return e.bars*i[0]*t}if(void 0!==e.subdivision)return(this.noteDurations[e.subdivision]||1)*t}return 1e3}toMusical(e,t=null){const i=e/(6e4/(t||j.bpm||120));let n="quarter",s=Math.abs(i-1);for(const[e,t]of Object.entries(this.noteDurations)){const r=Math.abs(i-t);r<s&&(s=r,n=e)}return{musical:!0,beats:i,bars:i/4,closestSubdivision:n,exact:s<.01}}calculatePhases(e,t){if(!e||0===e.length)return[{name:"main",beats:t,start:0,end:1}];const i=e.reduce((e,t)=>e+(t.beats||1),0),n=t/i;let s=0;return e.map(e=>{const i=(e.beats||1)*n,r=s/t;s+=i;const a=s/t;return{name:e.name,beats:i,start:r,end:a,duration:this.toMilliseconds({musical:!0,beats:i})}})}getBeatProgress(){const e=j.getTimeInfo();return e?e.beatProgress:0}getBarProgress(){const e=j.getTimeInfo();return e?e.barProgress:0}timeToNextBoundary(e="beat"){const t=j.getTimeInfo();if(!t)return 100;switch(e){case"beat":default:return t.nextBeatIn;case"bar":return(t.timeSignature[0]-t.beatInBar)*t.beatDuration;case"phrase":{const e=4,i=t.timeSignature[0];return(e-(t.bar||0)%e)*i*t.beatDuration}}}quantize(e,t="eighth"){const i=6e4/(j.bpm||120),n=(this.noteDurations[t]||1)*i;return Math.round(e/n)*n}isOnBoundary(e="beat",t=50){const i=this.timeToNextBoundary(e),n=j.getTimeInfo();return!!n&&(i<t||n.beatDuration-i<t)}getTempoAdaptation(e=120){const t=(j.bpm||120)/e;return{speed:t,energy:Math.min(2,Math.max(.5,t)),smoothness:t<.8?1.2:t>1.5?.8:1,intensity:t>1.3?1.2:t<.7?.8:1}}};class Wt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyBounce(e,t){return{offsetY:-Math.abs(Math.sin(t*Math.PI*e.params.frequency))*e.params.amplitude*this.scaleFactor*(e.params.effects&&e.params.effects.includes("gravity")?.6:1)}}applyShake(e,t){e.randomAngle||(e.randomAngle=Math.random()*Math.PI*2);const i=e.params.decay?1-t:1,n=Math.sin(t*Math.PI*e.params.frequency)*e.params.amplitude*i*this.scaleFactor;return{offsetX:n*Math.cos(e.randomAngle),offsetY:n*Math.sin(e.randomAngle)}}applyJump(e,t){let i,n,s=0,r=1;if(t<.2){const i=t/.2;r=1-(1-e.params.squashAmount)*i}else if(t<.7){const i=(t-.2)/.5,n=Math.sin(i*Math.PI);s=-e.params.jumpHeight*n*this.scaleFactor,r=e.params.squashAmount+(e.params.stretchAmount-e.params.squashAmount)*n}else{const i=(t-.7)/.3;r=e.params.stretchAmount-(e.params.stretchAmount-1)*i}if(e.params.effects&&e.params.effects.includes("gravity")){const e=t<.7?(t-.2)/.5:0,s=Math.sin(e*Math.PI);i=1+.2*s,n=1-.15*s}const a={offsetY:s,scale:r};return void 0!==i&&(a.scaleX=i),void 0!==n&&(a.scaleY=n),a}applyVibrate(e,t){if(!e.vibrateAngles){e.vibrateAngles={x:2*Math.random()-1,y:2*Math.random()-1};const t=Math.sqrt(e.vibrateAngles.x**2+e.vibrateAngles.y**2);e.vibrateAngles.x/=t,e.vibrateAngles.y/=t}const i=e.params.amplitude||5,n=e.params.frequency||20,s=Math.sin(t*Math.PI*2*n)*i*this.scaleFactor;return{offsetX:s*e.vibrateAngles.x,offsetY:s*e.vibrateAngles.y}}applyWiggle(e,t){const i=(e.params?.amplitude||15)*this.scaleFactor;void 0===e.wiggleDirection&&(e.wiggleDirection=Math.random()<.5?1:-1);const n=e.wiggleDirection;let s=0,r=0;if(t<.25){const e=t/.25;s=i*n*e,r=3*n*e}else if(t<.5){const e=(t-.25)/.25;s=i*n*(1-2*e),r=3*n*(1-2*e)}else if(t<.75){const e=(t-.5)/.25;s=i*-n*(1-2*e),r=3*-n*(1-2*e)}else{const e=(t-.75)/.25;s=i*n*(1-e),r=3*n*(1-e)}return{offsetX:s,offsetY:-Math.abs(Math.sin(t*Math.PI*4))*i*.15,rotation:r}}}class Nt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyFlash(e,t){const i=Math.sin(t*Math.PI);return{glow:1+((e.params.glowPeak||2)-1)*i,scale:1+((e.params.scalePeak||1.1)-1)*i}}applyGlow(e,t){const i=Math.sin(t*Math.PI*e.params.frequency);return{scale:1+i*(e.params.scaleAmount||.1),glow:1+i*(e.params.glowAmount||.8)}}applyFlicker(e,t){const i=e.params?.intensity||2,n=e.params?.speed||3,s=1+Math.sin(t*Math.PI*2*n)*i*.3,r=5*Math.sin(t*Math.PI*4)*this.scaleFactor,a=.001*Date.now();return{offsetX:r,glow:s,particleGlow:(.5*Math.sin(t*Math.PI*n*2)+.5)*i,flickerTime:a,flickerEffect:!0}}applySparkle(e,t){const i=e.params?.intensity||2,n=.001*Date.now();return{particleGlow:i,glow:.3*Math.sin(t*Math.PI*4)+.7,fireflyTime:n,fireflyEffect:!0}}applyShimmer(e,t){const i=.001*Date.now(),n=e.params?.intensity||.3,s=Math.sin(2*i+t*Math.PI*2);return{offsetX:0,offsetY:0,glow:1+s*n,scale:1+.01*s,particleGlow:1+.2*s,shimmerTime:i,shimmerWave:s,shimmerEffect:!0}}}class Ut{constructor(e){this.renderer=e}applyBreathe(e,t){const{params:i}=e,n=i.particleMotion?.holdPercent||.1;let s;if(t<.4)s=Math.sin(t/.4*Math.PI/2);else if(t<.4+n)s=1;else if(t<.9){const e=(t-.4-n)/(.5-n);s=Math.cos(e*Math.PI/2)}else s=0;const r=1+s*(i.scaleAmount||.25),a=1+s*(i.glowAmount||.4);return e.breathPhase=s,{scale:r,glow:a,breathPhase:s}}applyBreathIn(e,t){return{scale:1+(e.params.scaleAmount-1)*Math.sin(t*Math.PI/2)}}applyBreathOut(e,t){return{scale:1-(1-e.params.scaleAmount)*Math.sin(t*Math.PI/2)}}applyBreathHold(e,t){return{scale:e.params.scaleAmount}}applyBreathHoldEmpty(e,t){return{scale:e.params.scaleAmount}}}class Vt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applySpin(e,t){return{rotation:Math.min(1.05*t,1)*e.params.rotations*360,scale:1+Math.sin(t*Math.PI)*e.params.scaleAmount}}applyDrift(e,t){t<=.01&&!e.currentDriftAngle&&(e.currentDriftAngle=Math.random()*Math.PI*2);const i=e.params.distance*Math.sin(t*Math.PI)*this.scaleFactor,n=e.currentDriftAngle||0;return t>=.99&&(e.currentDriftAngle=null),{offsetX:Math.cos(n)*i,offsetY:Math.sin(n)*i}}applyWave(e,t){const i=(e.params.amplitude||40)*this.scaleFactor,n=t*Math.PI*2,s=Math.sin(n)*i,r=-Math.sin(t*Math.PI)*i*.3;return{offsetX:s,offsetY:Math.sin(2*n)*i*.2+r,rotation:5*Math.sin(n),scale:1+.05*Math.sin(t*Math.PI*2),glow:1+.2*Math.sin(t*Math.PI)}}applySway(e,t){const i=(e.params?.amplitude||30)*this.scaleFactor,n=e.params?.frequency||1;return{offsetX:Math.sin(t*Math.PI*2*n)*i,offsetY:Math.sin(t*Math.PI*4*n)*i*.1,rotation:5*Math.sin(t*Math.PI*2*n)}}applyFloat(e,t){const i=(e.params?.amplitude||20)*this.scaleFactor,n=e.params?.speed||1,s=Math.sin(t*Math.PI*2*n)*i;return{offsetX:Math.sin(t*Math.PI*3*n)*i*.3,offsetY:s,scale:1+.02*Math.sin(t*Math.PI*4*n)}}applyOrbital(e,t){return{offsetX:0,offsetY:0}}applyHula(e,t){const i=(e.params?.amplitude||40)*this.scaleFactor,n=t*Math.PI*2;return{offsetX:Math.sin(n)*i,offsetY:Math.sin(2*n)*i*.5}}applyOrbit(e,t){const i=(e.params?.radius||30)*this.scaleFactor,n=e.params?.speed||1,s=t*Math.PI*2*n;return{offsetX:Math.cos(s)*i,offsetY:Math.sin(s)*i}}}class Yt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyPulse(e,t){const i=Math.sin(t*Math.PI*e.params.frequency);return{scale:1+i*e.params.scaleAmount,glow:1+i*e.params.glowAmount}}applyExpand(e,t){const i=Math.max(e.params.scaleAmount||e.params.scaleTarget||1.5,1),n=Math.sin(t*Math.PI/2);return{scale:1+(i-1)*n,glow:1+Math.abs(e.params.glowAmount||.2)*n}}applyContract(e,t){const i=e.params.scaleAmount||e.params.scaleTarget||.7,n=Math.sin(t*Math.PI/2);return{scale:1+(i-1)*n,glow:1+(e.params.glowAmount||-.2)*n}}applyStretch(e,t){const i=Math.sin(t*Math.PI*e.params.frequency);return{scale:1+((e.params.scaleX+e.params.scaleY)/2-1)*i}}applyMorph(e,t){const i=Math.sin(t*Math.PI*2);return{scale:1+.1*i,rotation:10*i}}}class Xt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyNod(e,t){return{offsetY:Math.sin(t*Math.PI*e.params.frequency)*e.params.amplitude*this.scaleFactor}}applyTilt(e,t){e.tiltDirection||(e.tiltDirection=Math.random()<.5?-1:1);const i=e.params.frequency||2,n=(e.params.angle||15)*Math.PI/180,s=Math.sin(t*Math.PI*i)*e.tiltDirection;return{rotation:s*n,scaleX:1+.1*Math.abs(s),scaleY:1-.05*Math.abs(s),offsetX:10*s,offsetY:-5*Math.abs(s)}}applySlowBlink(e,t){let i=1;return i=t<.3?1-t/.3:t<.5?0:t<.8?(t-.5)/.3:1,{glow:i}}applyLook(e,t){if(!e.targetX){const t=e.params.lookDirection,i=50*e.params.lookDistance*this.scaleFactor;switch(t){case"left":e.targetX=-i,e.targetY=0;break;case"right":e.targetX=i,e.targetY=0;break;case"up":e.targetX=0,e.targetY=-i;break;case"down":e.targetX=0,e.targetY=i;break;default:{const t=Math.random()*Math.PI*2;e.targetX=Math.cos(t)*i,e.targetY=Math.sin(t)*i;break}}}let i=t;return i=t<.3?t/.3:t<.7?1:1-(t-.7)/.3,{offsetX:e.targetX*i,offsetY:e.targetY*i}}applySettle(e,t){const i=Math.sin(t*Math.PI*e.params.wobbleFreq)*Math.exp(3*-t)*20*this.scaleFactor;return{offsetY:i,scale:1+.01*i}}}class Qt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyPoint(e,t){void 0===e.pointDirection&&(e.pointDirection=Math.random()<.5?-1:1);const i=void 0!==e.params?.direction?e.params.direction:e.pointDirection,n=(e.params?.distance||40)*this.scaleFactor;let s,r;return t<.4?(s=1-Math.pow(1-t/.4,3),r=s):t<.6?(s=1,r=1):(s=Math.pow(1-(t-.6)/.4,3),r=s),{offsetX:i*n*s,offsetY:-Math.abs(.15*n*s),scale:1+.15*r,rotation:5*i*r}}applyLean(e,t){const i=e.params?.angle||15,n=e.params?.side||1,s=Math.sin(t*Math.PI),r=i*n*s;return{offsetX:10*n*this.scaleFactor*s,rotation:r}}applyReach(e,t){const i=void 0!==e.params?.direction?e.params.direction:-Math.PI/2,n=(e.params?.distance||40)*this.scaleFactor;let s;return s=t<.4?t/.4:t<.6?1:1-(t-.6)/.4,s=s*s*(3-2*s),{offsetX:Math.cos(i)*n*s,offsetY:Math.sin(i)*n*s,scale:1+.15*s}}}class Jt{constructor(e){this.renderer=e,this.scaleFactor=e.scaleFactor||1}applyFlashWave(e,t){e.flashWave||(e.flashWave={innerRadius:0,outerRadius:0,maxRadius:3}),e.flashWave.outerRadius=t*e.flashWave.maxRadius,e.flashWave.innerRadius=Math.max(0,(t-.1)*e.flashWave.maxRadius);const i=Math.max(0,1-.7*t);return e.flashWaveData={innerRadius:e.flashWave.innerRadius,outerRadius:e.flashWave.outerRadius,intensity:i},{glow:1+.3*i,flashWave:e.flashWaveData}}applyRain(e,t){const i=e.params?.intensity||1,n=10*t*this.scaleFactor*i,s=5*Math.sin(t*Math.PI*4)*this.scaleFactor;return this.renderer&&this.renderer.particleSystem&&this.renderer.particleSystem.setGestureBehavior("falling",t>0&&t<1),{offsetX:s,offsetY:n,particleEffect:"falling"}}applyGroove(e,t){const i=(e.params?.amplitude||25)*this.scaleFactor;return{offsetX:Math.sin(t*Math.PI*2)*i+Math.sin(t*Math.PI*3+.5)*i*.4,offsetY:Math.sin(t*Math.PI*4+.3)*i*.25,scale:1+.03*Math.sin(t*Math.PI*3+.7),rotation:8*Math.sin(t*Math.PI*2+.2)}}applyHeadBob(e,t){const i=(e.params?.amplitude||20)*this.scaleFactor,n=t*(e.params?.frequency||2)%1;let s;return s=n<.3?n/.3*-i:-i*(1-(n-.3)/.7),{offsetY:s,rotation:n<.3?-3:0}}applyRunningMan(e,t){const i=20*Math.sin(t*Math.PI*4)*this.scaleFactor;return{offsetX:i,offsetY:10*-Math.abs(Math.sin(t*Math.PI*8))*this.scaleFactor,rotation:.3*i,scaleY:1-.05*Math.abs(Math.sin(t*Math.PI*8))}}applyCharleston(e,t){const i=25*Math.sin(t*Math.PI*8)*this.scaleFactor;return{offsetX:i,offsetY:10*-Math.abs(Math.sin(t*Math.PI*8))*this.scaleFactor,rotation:.6*i,scaleY:1-.06*Math.abs(Math.sin(t*Math.PI*8))}}}class Kt{constructor(e){this.renderer=e,this.activeGestures=new Map,this.scaleFactor=e.scaleFactor||1,this.physicalGestureAnimator=new Wt(e),this.visualEffectAnimator=new Nt(e),this.breathGestureAnimator=new Ut(e),this.movementGestureAnimator=new Vt(e),this.shapeTransformAnimator=new Yt(e),this.expressionGestureAnimator=new Xt(e),this.directionalGestureAnimator=new Qt(e),this.complexAnimationAnimator=new Jt(e),this.gestureAnimations={bounce:{active:!1,progress:0,params:{}},pulse:{active:!1,progress:0,params:{}},shake:{active:!1,progress:0,params:{}},spin:{active:!1,progress:0,params:{}},nod:{active:!1,progress:0,params:{}},tilt:{active:!1,progress:0,params:{}},expand:{active:!1,progress:0,params:{}},contract:{active:!1,progress:0,params:{}},flash:{active:!1,progress:0,params:{}},drift:{active:!1,progress:0,params:{}},stretch:{active:!1,progress:0,params:{}},glow:{active:!1,progress:0,params:{}},flicker:{active:!1,progress:0,params:{}},vibrate:{active:!1,progress:0,params:{}},orbital:{active:!1,progress:0,params:{}},hula:{active:!1,progress:0,params:{}},wave:{active:!1,progress:0,params:{}},breathe:{active:!1,progress:0,params:{}},morph:{active:!1,progress:0,params:{}},slowBlink:{active:!1,progress:0,params:{}},look:{active:!1,progress:0,params:{}},settle:{active:!1,progress:0,params:{}},breathIn:{active:!1,progress:0,params:{}},breathOut:{active:!1,progress:0,params:{}},breathHold:{active:!1,progress:0,params:{}},breathHoldEmpty:{active:!1,progress:0,params:{}},jump:{active:!1,progress:0,params:{}},sway:{active:!1,progress:0,params:{}},float:{active:!1,progress:0,params:{}},sparkle:{active:!1,progress:0,params:{}},shimmer:{active:!1,progress:0,params:{}},wiggle:{active:!1,progress:0,params:{}},groove:{active:!1,progress:0,params:{}},point:{active:!1,progress:0,params:{}},lean:{active:!1,progress:0,params:{}},reach:{active:!1,progress:0,params:{}},headBob:{active:!1,progress:0,params:{}},orbit:{active:!1,progress:0,params:{}},rain:{active:!1,progress:0,params:{}},runningman:{active:!1,progress:0,params:{}},charleston:{active:!1,progress:0,params:{}}}}startGesture(e){const t=Pt(e);if(["bounce","shake","pulse","flash","jump","slam","spin","flicker"].includes(e)&&this.renderer.specialEffects){const t={flash:1,jump:1,shake:.9,bounce:.8,pulse:.7,slam:1,spin:.8,flicker:1}[e]||.8;this.renderer.specialEffects.triggerChromaticAberration(t)}let i;i=this.renderer.gestureCompositor?this.renderer.gestureCompositor.compose(e,this.renderer.state.emotion,this.renderer.currentUndertone):t?.config||{amplitude:20,frequency:2,duration:1e3,scaleAmount:.2,glowAmount:.3,rotations:1,distance:50,angle:15,scaleTarget:1.5,glowPeak:2,scalePeak:1.1,scaleX:1.2,scaleY:.8,maxOpacity:1,minOpacity:.5,lookDirection:"random",lookDistance:1,wobbleFreq:4,squashAmount:.8,stretchAmount:1.2,jumpHeight:100,decay:!0,easing:"sine",effects:[]};let n=1e3;if(t&&t.config)if(t.config.musicalDuration)n=jt.toMilliseconds(t.config.musicalDuration);else if(t.config.duration){const{duration:e}=t.config;n=e}const s=this.gestureAnimations[e];s&&(s.active=!0,s.startTime=performance.now(),s.progress=0,s.params=i,s.duration=n,"shake"===e?s.randomAngle=void 0:"drift"===e?(s.startX=void 0,s.startY=void 0,s.currentDriftAngle=void 0):"tilt"===e?s.tiltDirection=void 0:"vibrate"===e&&(s.vibrateAngles=void 0))}applyGestureAnimations(){const e=performance.now(),t={offsetX:0,offsetY:0,scale:1,rotation:0,glow:1};for(const[i,n]of Object.entries(this.gestureAnimations)){if(!n.active)continue;const s=e-n.startTime,r=n.duration||(n.params?n.params.duration:1e3);n.progress=Math.min(s/r,1);const a=this.applyEasing(n.progress,n.params.easing);let o={};switch(i){case"bounce":o=this.applyBounce(n,a);break;case"pulse":o=this.applyPulse(n,a);break;case"shake":o=this.applyShake(n,a);break;case"spin":o=this.applySpin(n,a);break;case"nod":o=this.applyNod(n,a);break;case"tilt":o=this.applyTilt(n,a);break;case"expand":o=this.applyExpand(n,a);break;case"contract":o=this.applyContract(n,a);break;case"flash":o=this.applyFlash(n,a);break;case"drift":o=this.applyDrift(n,a);break;case"stretch":o=this.applyStretch(n,a);break;case"glow":o=this.applyGlow(n,a);break;case"flicker":o=this.applyFlicker(n,a);break;case"vibrate":o=this.applyVibrate(n,a);break;case"orbital":o=this.applyOrbital(n,a);break;case"hula":o=this.applyHula(n,a);break;case"wave":o=this.applyWave(n,a);break;case"breathe":o=this.applyBreathe(n,a);break;case"morph":o=this.applyMorph(n,a);break;case"slowBlink":o=this.applySlowBlink(n,a);break;case"look":o=this.applyLook(n,a);break;case"settle":o=this.applySettle(n,a);break;case"breathIn":o=this.applyBreathIn(n,a);break;case"breathOut":o=this.applyBreathOut(n,a);break;case"breathHold":o=this.applyBreathHold(n,a);break;case"breathHoldEmpty":o=this.applyBreathHoldEmpty(n,a);break;case"jump":o=this.applyJump(n,a);break;case"sway":o=this.applySway(n,a);break;case"float":o=this.applyFloat(n,a);break;case"rain":o=this.applyRain(n,a);break;case"runningman":o=this.applyRunningMan(n,a);break;case"charleston":o=this.applyCharleston(n,a);break;case"sparkle":o=this.applySparkle(n,a);break;case"shimmer":o=this.applyShimmer(n,a);break;case"wiggle":o=this.applyWiggle(n,a);break;case"groove":o=this.applyGroove(n,a);break;case"point":o=this.applyPoint(n,a);break;case"lean":o=this.applyLean(n,a);break;case"reach":o=this.applyReach(n,a);break;case"headBob":o=this.applyHeadBob(n,a);break;case"orbit":o=this.applyOrbit(n,a)}t.offsetX+=o.offsetX||0,t.offsetY+=o.offsetY||0,t.scale*=o.scale||1,t.rotation+=o.rotation||0,t.glow=Math.max(t.glow,o.glow||1),o.flashWave&&(t.flashWave=o.flashWave),o.fireflyEffect&&(t.fireflyEffect=o.fireflyEffect,t.particleGlow=o.particleGlow,t.fireflyTime=o.fireflyTime),o.flickerEffect&&(t.flickerEffect=o.flickerEffect,t.particleGlow=o.particleGlow,t.flickerTime=o.flickerTime),o.shimmerEffect&&(t.shimmerEffect=o.shimmerEffect,t.particleGlow=o.particleGlow,t.shimmerTime=o.shimmerTime,t.shimmerWave=o.shimmerWave),o.glowEffect&&(t.glowEffect=o.glowEffect,t.particleGlow=o.particleGlow,t.glowTime=o.glowTime,t.glowProgress=o.glowProgress,t.glowEnvelope=o.glowEnvelope),n.progress>=1&&(n.active=!1,n.progress=0,n.startTime=0,"flash"===i&&(n.flashWave=null,n.flashWaveData=null),o.glowEffect&&(o.glowEffect=null,o.particleGlow=null,o.glowTime=null,o.glowProgress=null,o.glowEnvelope=null),o.fireflyEffect&&(o.fireflyEffect=null,o.particleGlow=null,o.fireflyTime=null),o.flickerEffect&&(o.flickerEffect=null,o.particleGlow=null,o.flickerTime=null),o.shimmerEffect&&(o.shimmerEffect=null,o.particleGlow=null,o.shimmerTime=null,o.shimmerWave=null))}return t}update(e){return this.applyGestureAnimations()}stopAllGestures(){Object.keys(this.gestureAnimations).forEach(e=>{const t=this.gestureAnimations[e];t.active=!1,t.startTime=0,t.progress=0,t.params=null,t.glowEffect&&(t.glowEffect=null,t.particleGlow=null,t.glowTime=null,t.glowProgress=null,t.glowEnvelope=null),t.fireflyEffect&&(t.fireflyEffect=null,t.particleGlow=null,t.fireflyTime=null),t.flickerEffect&&(t.flickerEffect=null,t.particleGlow=null,t.flickerTime=null),t.shimmerEffect&&(t.shimmerEffect=null,t.particleGlow=null,t.shimmerTime=null,t.shimmerWave=null),t.flashWave&&(t.flashWave=null,t.flashWaveData=null)}),this.activeGestures.clear()}getCurrentGesture(){const e=["orbital","hula","wave","spin"];for(const t of e){const e=this.gestureAnimations[t];if(e&&e.active){const i=Pt(t);return{name:t,particleMotion:i?.config?.particleMotion||{type:t,strength:e.params?.strength||1},progress:e.progress||0,params:e.params}}}for(const[e,t]of Object.entries(this.gestureAnimations))if(t.active){const i=Pt(e),n={name:e,particleMotion:i?.config?.particleMotion||t.params?.particleMotion||{type:e,strength:t.params?.strength||1},progress:t.progress||0,params:t.params};return"breathe"===e&&void 0!==t.breathPhase&&(n.breathPhase=t.breathPhase),n}return null}applyEasing(e,t){switch(t){case"linear":default:return e;case"quad":return e*e;case"cubic":return e*e*e;case"sine":return Math.sin(e*Math.PI/2);case"back":return e*e*(2.7*e-1.7)}}applyBounce(e,t){return this.physicalGestureAnimator.applyBounce(e,t)}applyPulse(e,t){return this.shapeTransformAnimator.applyPulse(e,t)}applyShake(e,t){return this.physicalGestureAnimator.applyShake(e,t)}applySpin(e,t){return this.movementGestureAnimator.applySpin(e,t)}applyNod(e,t){return this.expressionGestureAnimator.applyNod(e,t)}applyTilt(e,t){return this.expressionGestureAnimator.applyTilt(e,t)}applyExpand(e,t){return this.shapeTransformAnimator.applyExpand(e,t)}applyContract(e,t){return this.shapeTransformAnimator.applyContract(e,t)}applyFlash(e,t){return this.visualEffectAnimator.applyFlash(e,t)}applyDrift(e,t){return this.movementGestureAnimator.applyDrift(e,t)}applyStretch(e,t){return this.shapeTransformAnimator.applyStretch(e,t)}applyGlow(e,t){return this.visualEffectAnimator.applyGlow(e,t)}applyFlashWave(e,t){return this.complexAnimationAnimator.applyFlashWave(e,t)}applyFlicker(e,t){return this.visualEffectAnimator.applyFlicker(e,t)}applyVibrate(e,t){return this.physicalGestureAnimator.applyVibrate(e,t)}applyWave(e,t){return this.movementGestureAnimator.applyWave(e,t)}applyBreathe(e,t){return this.breathGestureAnimator.applyBreathe(e,t)}applyMorph(e,t){return this.shapeTransformAnimator.applyMorph(e,t)}applySlowBlink(e,t){return this.expressionGestureAnimator.applySlowBlink(e,t)}applyLook(e,t){return this.expressionGestureAnimator.applyLook(e,t)}applySettle(e,t){return this.expressionGestureAnimator.applySettle(e,t)}applyBreathIn(e,t){return this.breathGestureAnimator.applyBreathIn(e,t)}applyBreathOut(e,t){return this.breathGestureAnimator.applyBreathOut(e,t)}applyBreathHold(e,t){return this.breathGestureAnimator.applyBreathHold(e,t)}applyBreathHoldEmpty(e,t){return this.breathGestureAnimator.applyBreathHoldEmpty(e,t)}applyJump(e,t){return this.physicalGestureAnimator.applyJump(e,t)}applySway(e,t){return this.movementGestureAnimator.applySway(e,t)}applyRain(e,t){return this.complexAnimationAnimator.applyRain(e,t)}applyFloat(e,t){return this.movementGestureAnimator.applyFloat(e,t)}applyOrbital(e,t){return this.movementGestureAnimator.applyOrbital(e,t)}applyHula(e,t){return this.movementGestureAnimator.applyHula(e,t)}applySparkle(e,t){return this.visualEffectAnimator.applySparkle(e,t)}applyShimmer(e,t){return this.visualEffectAnimator.applyShimmer(e,t)}applyWiggle(e,t){return this.physicalGestureAnimator.applyWiggle(e,t)}applyGroove(e,t){return this.complexAnimationAnimator.applyGroove(e,t)}applyPoint(e,t){return this.directionalGestureAnimator.applyPoint(e,t)}applyLean(e,t){return this.directionalGestureAnimator.applyLean(e,t)}applyReach(e,t){return this.directionalGestureAnimator.applyReach(e,t)}applyHeadBob(e,t){return this.complexAnimationAnimator.applyHeadBob(e,t)}applyOrbit(e,t){return this.movementGestureAnimator.applyOrbit(e,t)}startBounce(){this.startGesture("bounce")}startPulse(){this.startGesture("pulse")}startShake(){this.startGesture("shake")}startSpin(){this.startGesture("spin")}startNod(){this.startGesture("nod")}startTilt(){this.startGesture("tilt")}startExpand(){this.startGesture("expand")}startContract(){this.startGesture("contract")}startFlash(){this.startGesture("flash")}startDrift(){this.startGesture("drift")}startStretch(){this.startGesture("stretch")}startGlow(){this.startGesture("glow")}startFlicker(){this.startGesture("flicker")}startVibrate(){this.startGesture("vibrate")}startOrbital(){this.startGesture("orbital")}startHula(){this.startGesture("hula")}startWave(){this.startGesture("wave")}startBreathe(){this.startGesture("breathe")}startMorph(){this.startGesture("morph")}startSlowBlink(){this.startGesture("slowBlink")}startLook(){this.startGesture("look")}startSettle(){this.startGesture("settle")}startBreathIn(){this.startGesture("breathIn")}startBreathOut(){this.startGesture("breathOut")}startBreathHold(){this.startGesture("breathHold")}startBreathHoldEmpty(){this.startGesture("breathHoldEmpty")}startJump(){this.startGesture("jump")}startSway(){this.startGesture("sway")}startFloat(){this.startGesture("float")}startRain(){this.startGesture("rain")}startRunningMan(){this.startGesture("runningman")}startCharleston(){this.startGesture("charleston")}startSparkle(){this.startGesture("sparkle")}startShimmer(){this.startGesture("shimmer")}startWiggle(){this.startGesture("wiggle")}startGroove(){this.startGesture("groove")}startPoint(){this.startGesture("point")}startLean(){this.startGesture("lean")}startReach(){this.startGesture("reach")}startHeadBob(){this.startGesture("headBob")}startOrbit(){this.startGesture("orbit")}applyRunningMan(e,t){return this.complexAnimationAnimator.applyRunningMan(e,t)}applyCharleston(e,t){return this.complexAnimationAnimator.applyCharleston(e,t)}startRunningManGesture(){this.startGesture("runningman")}startCharlestonGesture(){this.startGesture("charleston")}pauseCurrentAnimation(){const e=performance.now();for(const[,t]of Object.entries(this.gestureAnimations))t.active&&(t.pausedAt=e,t.pausedProgress=t.progress);this.isPaused=!0}resumeAnimation(){if(!this.isPaused)return;const e=performance.now();for(const[,t]of Object.entries(this.gestureAnimations))if(t.active&&t.pausedAt){const i=e-t.pausedAt;t.startTime&&(t.startTime+=i),delete t.pausedAt,delete t.pausedProgress}this.isPaused=!1}reset(){for(const[,e]of Object.entries(this.gestureAnimations))e.active=!1,e.progress=0,e.params={},delete e.startTime,delete e.pausedAt,delete e.pausedProgress;this.activeGestures.clear(),this.isPaused=!1}}class Zt{constructor(){this.colorTransition=null}applyUndertoneModifiers(e,t){return t}applyUndertoneToColor(e,t){if(t&&"object"==typeof t&&void 0!==t.weight){const{weight:i}=t,n=t.type||"clear";if("clear"===n||0===i)return e;const s=this.applyUndertoneSaturation(e,n),r=this.hexToRgb(e),a=this.hexToRgb(s),o=Math.round(r.r+(a.r-r.r)*i),c=Math.round(r.g+(a.g-r.g)*i),l=Math.round(r.b+(a.b-r.b)*i);return this.rgbToHex(o,c,l)}return t&&"clear"!==t?this.applyUndertoneSaturation(e,t):e}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}rgbToHsl(e,t,i){e/=255,t/=255,i/=255;const n=Math.max(e,t,i),s=Math.min(e,t,i),r=(n+s)/2;let a,o;if(n===s)a=o=0;else{const c=n-s;switch(o=r>.5?c/(2-n-s):c/(n+s),n){case e:a=((t-i)/c+(t<i?6:0))/6;break;case t:a=((i-e)/c+2)/6;break;case i:a=((e-t)/c+4)/6}}return{h:360*a,s:100*o,l:100*r}}hslToHex(e,t,i){let n,s,r;if(e/=360,i/=100,0==(t/=100))n=s=r=i;else{const a=(e,t,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e),o=i<.5?i*(1+t):i+t-i*t,c=2*i-o;n=a(c,o,e+1/3),s=a(c,o,e),r=a(c,o,e-1/3)}const a=e=>{const t=Math.round(255*e).toString(16);return 1===t.length?`0${t}`:t};return`#${a(n)}${a(s)}${a(r)}`}applyUndertoneSaturation(e,t){const i=this.hexToRgb(e),n=this.rgbToHsl(i.r,i.g,i.b),s={intense:1.5,confident:1.3,energetic:1.2,upbeat:1.2,nervous:1.15,mellow:.8,tired:.8,subdued:.5}[t]||1;return n.s=Math.min(100,n.s*s),this.hslToHex(n.h,n.s,n.l)}rgbToHex(e,t,i){const n=e=>{const t=Math.round(e).toString(16);return 1===t.length?`0${t}`:t};return`#${n(e)}${n(t)}${n(i)}`}startColorTransition(e,t,i=1500){this.currentColor===e&&this.currentIntensity===t||(this.colorTransition={active:!0,fromColor:this.currentColor||"#ffffff",toColor:e,fromIntensity:this.currentIntensity||1,toIntensity:t,progress:0,startTime:performance.now(),duration:i})}updateColorTransition(e){if(!this.colorTransition||!this.colorTransition.active)return null;const t=performance.now()-this.colorTransition.startTime,i=Math.min(t/this.colorTransition.duration,1),n=1-Math.pow(1-i,2),s=this.hexToRgb(this.colorTransition.fromColor),r=this.hexToRgb(this.colorTransition.toColor),a=Math.round(s.r+(r.r-s.r)*n),o=Math.round(s.g+(r.g-s.g)*n),c=Math.round(s.b+(r.b-s.b)*n),l=this.rgbToHex(a,o,c),h=this.colorTransition.fromIntensity+(this.colorTransition.toIntensity-this.colorTransition.fromIntensity)*n;return this.currentColor=l,this.currentIntensity=h,i>=1&&(this.colorTransition.active=!1),{color:l,intensity:h}}}class ei{constructor(e){this.renderer=e,this.ctx=e.ctx,this.canvas=e.canvasManager?.canvas||e.canvas,this.recordingActive=!1,this.sleepMode=!1,this.speakingActive=!1,this.zenModeActive=!1,this.speakingRings=[],this.ringSpawnTimer=0,this.ringSpawnInterval=300,this.maxRings=3,this.sleepZ=[],this.sparkles=[],this.chromaticAberration={active:!1,intensity:0,targetIntensity:0,fadeSpeed:.01,maxOffset:30},this.scaleValue=t=>e.scaleValue(t),this.hexToRgba=(t,i)=>e.hexToRgba(t,i)}renderRecordingGlow(e,t,i,n){const{ctx:s}=this,r=2.5*i,a=s.createRadialGradient(e,t,0,e,t,r);a.addColorStop(0,`rgba(255, 0, 0, ${.3*n})`),a.addColorStop(.5,`rgba(255, 0, 0, ${.15*n})`),a.addColorStop(1,"rgba(255, 0, 0, 0)"),s.save(),s.globalCompositeOperation="screen",s.fillStyle=a,s.fillRect(e-r,t-r,2*r,2*r),s.restore()}renderRecordingIndicator(e,t){const i=Date.now()/1e3,n=.8+.2*Math.sin(2*i);this.ctx.save(),this.ctx.translate(e,t),this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=`rgba(255, 0, 0, ${.8*n})`;const s=this.scaleValue(80);this.ctx.font=`italic 900 ${s}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 0, 0, ${n})`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("REC",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic 900 ${s-1}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*n})`,this.ctx.fillText("REC",-.5,-.5),this.ctx.restore()}renderSleepIndicator(e,t,i){if(this.ringSpawnTimer+=i,this.ringSpawnTimer>=2e3&&this.sleepZ.length<3){const i=["300","500","700","900"],n=i[Math.floor(Math.random()*i.length)],s=Math.random()>.5?"Z":"z";this.sleepZ.push({x:e+Math.random()*this.scaleValue(30)-this.scaleValue(15),y:t+this.scaleValue(80),size:this.scaleValue(3*(24+8*Math.random())),opacity:1,speed:-.025,drift:Math.random()*this.scaleValue(20)-this.scaleValue(10),lifetime:0,rotation:30*Math.random()-15,text:s,weight:n}),this.ringSpawnTimer=0}this.sleepZ=this.sleepZ.filter(e=>{e.lifetime+=i,e.y+=e.speed*i,e.x+=Math.sin(8e-4*e.lifetime)*e.drift*.008,e.rotation+=.01*i;if(e.lifetime<2e3?e.opacity=1:e.lifetime<4e3?e.opacity=1-(e.lifetime-2e3)/2e3:e.opacity=0,e.opacity>.01){this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(e.rotation*Math.PI/180);const t=this.renderer.state.glowColor||"#4a90e2";this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=this.hexToRgba(t,.5*e.opacity);const i=this.ctx.createLinearGradient(-e.size/2,-e.size/2,e.size/2,e.size/2);return i.addColorStop(0,this.hexToRgba(t,e.opacity)),i.addColorStop(.5,this.hexToRgba("#ffffff",.9*e.opacity)),i.addColorStop(1,this.hexToRgba(t,.7*e.opacity)),this.ctx.font=`italic ${e.weight||"900"} ${e.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=i,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e.text||"Z",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic ${e.weight||"900"} ${.9*e.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=this.hexToRgba("#ffffff",.3*e.opacity),this.ctx.fillText(e.text||"Z",-1,-1),this.ctx.restore(),!0}return!1})}renderSpeakingRings(e,t,i,n){this.ringSpawnTimer+=n,this.ringSpawnTimer>=this.ringSpawnInterval&&this.speakingRings.length<this.maxRings&&(this.speakingRings.push({radius:i,opacity:.8,speed:.15}),this.ringSpawnTimer=0),this.speakingRings=this.speakingRings.filter(s=>(s.radius+=s.speed*n,s.opacity=Math.max(0,.8*(1-(s.radius-i)/(2*i))),s.opacity>.01&&(this.ctx.strokeStyle=this.hexToRgba(this.renderer.state.glowColor,s.opacity),this.ctx.lineWidth=this.scaleValue(2),this.ctx.beginPath(),this.ctx.arc(e,t,s.radius,0,2*Math.PI),this.ctx.stroke(),!0)))}renderZenCore(e,t,i,n){const{ctx:s}=this,r=i*(.9+.1*(.5*Math.sin(.001*n)+.5)),a=s.createRadialGradient(e,t,0,e,t,r);a.addColorStop(0,"rgba(147, 112, 219, 0.8)"),a.addColorStop(.7,"rgba(147, 112, 219, 0.3)"),a.addColorStop(1,"rgba(147, 112, 219, 0)"),s.save(),s.globalCompositeOperation="screen",s.fillStyle=a,s.beginPath(),s.arc(e,t,1.5*r,0,2*Math.PI),s.fill(),s.restore()}startRecording(){this.recordingActive=!0}stopRecording(){this.recordingActive=!1}enterSleepMode(){this.sleepMode=!0}wakeUp(){this.sleepMode=!1}startSpeaking(){this.speakingActive=!0}stopSpeaking(){this.speakingActive=!1}createSparkle(e,t,i={}){this.sparkles.push({x:e,y:t,vx:i.velocity?.x||0,vy:i.velocity?.y||0,size:i.size||3,color:i.color||"hsl(50, 100%, 70%)",lifetime:i.lifetime||1e3,maxLifetime:i.lifetime||1e3,rotation:Math.random()*Math.PI*2,rotationSpeed:.2*(Math.random()-.5)})}renderSparkles(){const{ctx:e}=this;this.sparkles.forEach(t=>{const i=1-t.lifetime/t.maxLifetime,n=1-i;e.save(),e.translate(t.x,t.y),e.rotate(t.rotation);const s=this.scaleValue(t.size*(1-.5*i));e.beginPath();const r=s,a=.38*s;for(let t=0;t<10;t++){const i=t*Math.PI/5-Math.PI/2,n=t%2==0?r:a;0===t?e.moveTo(Math.cos(i)*n,Math.sin(i)*n):e.lineTo(Math.cos(i)*n,Math.sin(i)*n)}e.closePath(),e.shadowBlur=this.scaleValue(10),e.shadowColor=t.color,e.fillStyle=t.color.replace("70%",70+30*i+"%").replace(")",`, ${n})`).replace("hsl","hsla"),e.fill(),e.restore()})}triggerChromaticAberration(e=.8){this.chromaticAberration.active=!0,this.chromaticAberration.targetIntensity=Math.min(1,e),this.chromaticAberration.intensity=this.chromaticAberration.targetIntensity;const t=document.getElementById("emotive-canvas")||document.querySelector("canvas")||this.canvas;if(t){if(t.style.animation="none",t.offsetHeight,!document.getElementById("chromatic-styles")){const e=document.createElement("style");e.id="chromatic-styles",e.textContent="\n                    @keyframes chromaticGlitch {\n                        0% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                        15% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.7)) drop-shadow(2px 0 0 rgba(0,255,255,0.7));\n                            transform: translateX(-0.5px);\n                        }\n                        30% {\n                            filter: drop-shadow(-3px 0 0 rgba(255,0,0,0.8)) drop-shadow(3px 0 0 rgba(0,255,255,0.8));\n                            transform: translateX(0.5px);\n                        }\n                        45% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.6)) drop-shadow(2px 0 0 rgba(0,255,255,0.6));\n                            transform: translateX(-0.3px);\n                        }\n                        60% {\n                            filter: drop-shadow(-1px 0 0 rgba(255,0,0,0.4)) drop-shadow(1px 0 0 rgba(0,255,255,0.4));\n                            transform: translateX(0.2px);\n                        }\n                        100% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                    }\n                ",document.head.appendChild(e)}t.style.animation=`chromaticGlitch ${300+200*e}ms ease-out`}}applyChromaticAberration(e,t){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return;const{intensity:i}=this.chromaticAberration,n=this.scaleValue(this.chromaticAberration.maxOffset*i),s=e.globalCompositeOperation;e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.globalCompositeOperation="source-over",e.filter="url(#red-channel)",e.drawImage(t,-n,0),e.globalCompositeOperation="screen",e.filter="url(#green-channel)",e.drawImage(t,0,0),e.globalCompositeOperation="screen",e.filter="url(#blue-channel)",e.drawImage(t,n,0),e.filter="none",e.globalCompositeOperation=s,e.restore()}applyChromaticAberrationSimple(e,t,i,n,s){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return void s();const{intensity:r}=this.chromaticAberration,a=this.scaleValue(this.chromaticAberration.maxOffset*r);e.save(),e.globalCompositeOperation="source-over",e.translate(-a,0),e.globalAlpha=.33,e.fillStyle="#ff0000",e.filter="brightness(3)",s(),e.translate(a,0),e.globalCompositeOperation="screen",e.globalAlpha=.33,e.fillStyle="#00ff00",s(),e.translate(a,0),e.globalAlpha=.33,e.fillStyle="#0000ff",s(),e.restore()}update(e){this.sparkles=this.sparkles.filter(t=>(t.x+=t.vx,t.y+=t.vy,t.rotation+=t.rotationSpeed,t.lifetime-=e,t.vy+=.1,t.lifetime>0)),this.chromaticAberration.active&&(this.chromaticAberration.intensity-=this.chromaticAberration.fadeSpeed,this.chromaticAberration.intensity<=0&&(this.chromaticAberration.intensity=0,this.chromaticAberration.active=!1,this.chromaticAberration.targetIntensity=0))}destroy(){this.speakingRings=[],this.sleepZ=[],this.sparkles=[],this.recordingActive=!1,this.sleepMode=!1,this.speakingActive=!1,this.zenModeActive=!1,this.chromaticAberration.active=!1,this.chromaticAberration.intensity=0,this.chromaticAberration.targetIntensity=0,this.ringSpawnTimer=0,this.renderer=null,this.ctx=null,this.canvas=null}}class ti{constructor(e){this.renderer=e,this.ctx=e.ctx,this.canvas=e.canvas,this.blinking=!1,this.blinkingEnabled=!0,this.blinkTimer=0,this.nextBlinkTime=this.getRandomBlinkTime(),this.squintAmount=0,this.eyeClose=null,this.eyeOpen=null,this.scaleValue=t=>e.scaleValue(t),this.hexToRgba=(t,i)=>e.hexToRgba(t,i)}update(e){this.blinking&&(this.blinkTimer+=e,this.blinkTimer>=150&&(this.blinking=!1,this.blinkTimer=0,this.nextBlinkTime=Date.now()+this.getRandomBlinkTime())),this.blinkingEnabled&&!this.blinking&&Date.now()>=this.nextBlinkTime&&this.startBlink()}startBlink(){this.blinkingEnabled&&(this.blinking=!0,this.blinkTimer=0)}getRandomBlinkTime(){return 3e3+4e3*Math.random()}getBlinkScale(){if(!this.blinking)return 1;const e=Math.min(this.blinkTimer/150,1);return 1-.7*Math.sin(e*Math.PI)}drawEyes(e,t,i,n,s={}){const{ctx:r}=this,a=s.eyeOpenness||1,o=s.eyeExpression||"neutral";if("zen"===n||"neutral"===n||a<=0)return;r.save(),r.strokeStyle="rgba(0, 0, 0, 0.3)",r.lineWidth=this.scaleValue(2),r.lineCap="round";const c=.4*i,l=t-.1*i,h=.25*i;switch(o){case"happy":this.drawHappyEyes(r,e,l,c,h,a);break;case"sad":this.drawSadEyes(r,e,l,c,h,a);break;case"angry":this.drawAngryEyes(r,e,l,c,h,a);break;case"surprised":this.drawSurprisedEyes(r,e,l,c,h,a);break;case"focused":this.drawFocusedEyes(r,e,l,c,h,a);break;case"sleepy":this.drawSleepyEyes(r,e,l,c,h,a);break;case"suspicious":this.drawSuspiciousEyes(r,e,l,c,h,a)}r.restore()}drawHappyEyes(e,t,i,n,s,r){e.beginPath(),e.arc(t-n,i,s,.2*Math.PI,.8*Math.PI,!1),e.stroke(),e.beginPath(),e.arc(t+n,i,s,.2*Math.PI,.8*Math.PI,!1),e.stroke()}drawSadEyes(e,t,i,n,s,r){e.beginPath(),e.arc(t-n,i+.5*s,s,1.2*Math.PI,1.8*Math.PI,!1),e.stroke(),e.beginPath(),e.arc(t+n,i+.5*s,s,1.2*Math.PI,1.8*Math.PI,!1),e.stroke()}drawAngryEyes(e,t,i,n,s,r){e.beginPath(),e.moveTo(t-n-s,i-.3*s),e.lineTo(t-n+.5*s,i+.3*s),e.stroke(),e.beginPath(),e.moveTo(t+n+s,i-.3*s),e.lineTo(t+n-.5*s,i+.3*s),e.stroke()}drawSurprisedEyes(e,t,i,n,s,r){e.beginPath(),e.arc(t-n,i,1.2*s,0,2*Math.PI),e.stroke(),e.beginPath(),e.arc(t+n,i,1.2*s,0,2*Math.PI),e.stroke()}drawFocusedEyes(e,t,i,n,s,r){e.fillStyle="rgba(0, 0, 0, 0.4)",e.beginPath(),e.arc(t-n,i,.3*s,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(t+n,i,.3*s,0,2*Math.PI),e.fill()}drawSleepyEyes(e,t,i,n,s,r){e.beginPath(),e.moveTo(t-n-s,i),e.lineTo(t-n+s,i),e.stroke(),e.beginPath(),e.moveTo(t+n-s,i),e.lineTo(t+n+s,i),e.stroke()}drawSuspiciousEyes(e,t,i,n,s,r){e.beginPath(),e.moveTo(t-n-s,i),e.lineTo(t-n+.7*s,i),e.stroke(),e.beginPath(),e.arc(t+n,i,.8*s,.1*Math.PI,.9*Math.PI,!1),e.stroke()}setBlinkingEnabled(e){this.blinkingEnabled=e,e||(this.blinking=!1,this.blinkTimer=0)}setSquintAmount(e){this.squintAmount=Math.max(0,Math.min(1,e))}forceBlink(){this.startBlink()}}class ii{constructor(e){this.renderer=e,this.breathingSpeed=.42,this.breathingDepth=.08,this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null,this.emotionBreathPatterns={happy:{rate:1.1,depth:1.2},sad:{rate:.8,depth:.7},angry:{rate:1.4,depth:1.3},calm:{rate:.7,depth:.9},excited:{rate:1.5,depth:1.4},focused:{rate:.9,depth:.6},neutral:{rate:1,depth:1},love:{rate:1.2,depth:1.3},surprised:{rate:1.3,depth:1.1},confused:{rate:1.1,depth:.9},amused:{rate:1.2,depth:1.1},bored:{rate:.6,depth:.8},tired:{rate:.5,depth:1.2},anxious:{rate:1.6,depth:.9},determined:{rate:1.1,depth:1},proud:{rate:.9,depth:1.3},content:{rate:.8,depth:1},hopeful:{rate:1,depth:1.1},zen:{rate:.4,depth:1.5},intrigued:{rate:1.1,depth:.8},embarrassed:{rate:1.3,depth:.7},grateful:{rate:.9,depth:1.1},inspired:{rate:1,depth:1.3},silly:{rate:1.4,depth:1.2},sleepy:{rate:.3,depth:1.4}}}update(e,t,i={}){i=i||{};const n=this.emotionBreathPatterns[t]||{rate:1,depth:1},s=i?.breathRateMult||1,r=i?.breathDepthMult||1;this.breathRate=n.rate*this.breathRateMult*s,this.breathDepth=this.breathingDepth*n.depth*this.breathDepthMult*r;let a=this.breathingSpeed*this.breathRate*(e/1e3);this.breathIrregular&&i?.breathIrregular&&(a*=.8+.4*Math.sin(3e-4*Date.now())),this.breathingPhase+=a,this.breathingPhase>2*Math.PI&&(this.breathingPhase-=2*Math.PI)}getBreathingScale(){return null!==this.customScale?this.customScale:1+Math.sin(this.breathingPhase)*this.breathDepth}setCustomScale(e){this.customScale=e}setBreathingSpeed(e){this.breathingSpeed=e}setBreathingDepth(e){this.breathingDepth=Math.max(0,Math.min(1,e))}setBreathRateMultiplier(e){this.breathRateMult=e}setBreathDepthMultiplier(e){this.breathDepthMult=e}setIrregularBreathing(e){this.breathIrregular=e}reset(){this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null}holdBreath(e=!1){this.customScale=e?.92:1.08}releaseBreath(){this.customScale=null}getBreathingInfo(){return{phase:this.breathingPhase,rate:this.breathRate,depth:this.breathDepth,scale:this.getBreathingScale(),isCustom:null!==this.customScale,isIrregular:this.breathIrregular}}}const ni=new class{constructor(){this.cache=new Map,this.stats={hits:0,misses:0,evictions:0},this.maxSize=100,this.ttl=6e4,this.accessOrder=[]}generateKey(e,t){if("radial"===e){const{x0:e,y0:i,r0:n,x1:s,y1:r,r1:a,stops:o}=t;return`radial:${e},${i},${n},${s},${r},${a}:${o.map(e=>`${e.offset}:${e.color}`).join("|")}`}if("linear"===e){const{x0:e,y0:i,x1:n,y1:s,stops:r}=t;return`linear:${e},${i},${n},${s}:${r.map(e=>`${e.offset}:${e.color}`).join("|")}`}return null}getRadialGradient(e,t,i,n,s,r,a,o){const c=this.generateKey("radial",{x0:t,y0:i,r0:n,x1:s,y1:r,r1:a,stops:o}),l=this.cache.get(c);if(l&&Date.now()-l.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(c),l.gradient;this.stats.misses++;const h=e.createRadialGradient(t,i,n,s,r,a);return o.forEach(e=>{h.addColorStop(e.offset,e.color)}),this.set(c,h),h}getLinearGradient(e,t,i,n,s,r){const a=this.generateKey("linear",{x0:t,y0:i,x1:n,y1:s,stops:r}),o=this.cache.get(a);if(o&&Date.now()-o.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(a),o.gradient;this.stats.misses++;const c=e.createLinearGradient(t,i,n,s);return r.forEach(e=>{c.addColorStop(e.offset,e.color)}),this.set(a,c),c}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU(),this.cache.set(e,{gradient:t,timestamp:Date.now()}),this.updateAccessOrder(e)}updateAccessOrder(e){const t=this.accessOrder.indexOf(e);t>-1&&this.accessOrder.splice(t,1),this.accessOrder.push(e)}evictLRU(){if(this.accessOrder.length>0){const e=this.accessOrder.shift();this.cache.delete(e),this.stats.evictions++}}clear(){this.cache.clear(),this.accessOrder=[]}clearExpired(){const e=Date.now(),t=[];for(const[i,n]of this.cache.entries())e-n.timestamp>=this.ttl&&t.push(i);t.forEach(e=>{this.cache.delete(e);const t=this.accessOrder.indexOf(e);t>-1&&this.accessOrder.splice(t,1)})}getStats(){const e=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{size:this.cache.size,maxSize:this.maxSize,hits:this.stats.hits,misses:this.stats.misses,evictions:this.stats.evictions,hitRate:`${e}%`}}createHelper(e){return{radial:(t,i,n,s,r,a,o)=>this.getRadialGradient(e,t,i,n,s,r,a,o),linear:(t,i,n,s,r)=>this.getLinearGradient(e,t,i,n,s,r)}}};class si{constructor(e){this.renderer=e,this.ctx=e.ctx,this.canvas=e.canvas,this.glowIntensity=1,this.glowColor="#4a90e2",this.targetGlowColor="#4a90e2",this.glowColorTransition=0,this.glowColorTransitionSpeed=.05,this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null,this.cachedGlowRadius=0,this.scaleValue=t=>e.scaleValue(t),this.hexToRgba=(t,i)=>e.hexToRgba(t,i),this.initOffscreenCanvas()}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d")}updateOffscreenSize(e){this.offscreenCanvas.width===e&&this.offscreenCanvas.height===e||(this.offscreenCanvas.width=e,this.offscreenCanvas.height=e,this.cachedGlowColor=null)}renderGlow(e,t,i,n={}){const{ctx:s}=this,r=n.color||this.glowColor,a=void 0!==n.intensity?n.intensity:this.glowIntensity;a<.01||this.renderGlowDirect(s,e,t,i,r,a)}cacheGlowGradient(e,t){const i=this.offscreenCtx,n=t;this.updateOffscreenSize(2*t),i.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);const s=ni.getRadialGradient(i,n,n,0,n,n,t,[{offset:0,color:this.hexToRgba(e,.4)},{offset:.3,color:this.hexToRgba(e,.2)},{offset:.6,color:this.hexToRgba(e,.1)},{offset:1,color:this.hexToRgba(e,0)}]);i.fillStyle=s,i.fillRect(0,0,2*t,2*t),this.cachedGlowColor=e,this.cachedGlowRadius=t}renderGlowDirect(e,t,i,n,s,r){e.save(),e.globalCompositeOperation="screen";const a=[];for(let e=0;e<=20;e++){const t=e/20,i=.6*Math.pow(1-t,2.2),n=Math.max(0,Math.min(1,i*r));a.push({offset:t,color:this.hexToRgba(s,n)})}const o=ni.getRadialGradient(e,t,i,0,t,i,n,a);e.fillStyle=o,e.beginPath(),e.arc(t,i,n,0,2*Math.PI),e.fill(),e.restore()}renderRecordingGlow(e,t,i,n){const{ctx:s}=this,r=2.5*i,a=ni.getRadialGradient(s,e,t,0,e,t,r,[{offset:0,color:`rgba(255, 0, 0, ${.3*n})`},{offset:.5,color:`rgba(255, 0, 0, ${.15*n})`},{offset:1,color:"rgba(255, 0, 0, 0)"}]);s.save(),s.globalCompositeOperation="screen",s.fillStyle=a,s.fillRect(e-r,t-r,2*r,2*r),s.restore()}renderZenGlow(e,t,i,n){const{ctx:s}=this,r=i*(.9+.1*(.5*Math.sin(.001*n)+.5)),a=ni.getRadialGradient(s,e,t,0,e,t,r,[{offset:0,color:"rgba(147, 112, 219, 0.8)"},{offset:.7,color:"rgba(147, 112, 219, 0.3)"},{offset:1,color:"rgba(147, 112, 219, 0)"}]);s.save(),s.globalCompositeOperation="screen",s.fillStyle=a,s.beginPath(),s.arc(e,t,1.5*r,0,2*Math.PI),s.fill(),s.restore()}updateGlowColor(e,t){this.targetGlowColor!==e&&(this.targetGlowColor=e,this.glowColorTransition=0),this.glowColorTransition<1&&(this.glowColorTransition=Math.min(1,this.glowColorTransition+this.glowColorTransitionSpeed),this.glowColor=this.lerpColor(this.glowColor,this.targetGlowColor,this.glowColorTransition))}lerpColor(e,t,i){const n=this.hexToRgb(e),s=this.hexToRgb(t);return`#${((1<<24)+(Math.round(n.r+(s.r-n.r)*i)<<16)+(Math.round(n.g+(s.g-n.g)*i)<<8)+Math.round(n.b+(s.b-n.b)*i)).toString(16).slice(1)}`}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}setGlowIntensity(e){this.glowIntensity=Math.max(0,Math.min(1,e))}setGlowColor(e){this.glowColor=e,this.targetGlowColor=e,this.glowColorTransition=1}destroy(){this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null}}class ri{constructor(e){this.renderer=e,this.ctx=e.ctx,this.canvas=e.canvas,this.coreColor="#FFFFFF",this.coreOpacity=1,this.coreBorderWidth=0,this.coreBorderColor=null,this.shapePoints=null,this.isMorphing=!1,this.scaleValue=t=>e.scaleValue(t),this.hexToRgba=(t,i)=>e.hexToRgba(t,i)}renderCore(e,t,i,n={}){const{ctx:s}=this,r=n.scaleX||1,a=n.scaleY||1,o=n.rotation||0,c=void 0!==n.opacity?n.opacity:this.coreOpacity,l=n.color||this.coreColor,h=n.shapePoints||this.shapePoints;s.save(),s.translate(e,t),0!==o&&s.rotate(o),s.scale(r,a),s.fillStyle=this.hexToRgba(l,c),h&&h.length>0?this.drawMorphedShape(s,h,i):this.drawCircle(s,i),this.coreBorderWidth>0&&this.coreBorderColor&&(s.strokeStyle=this.coreBorderColor,s.lineWidth=this.scaleValue(this.coreBorderWidth),s.stroke()),s.restore()}drawDropShadow(e,t,i){e.save();const n=this.scaleValue(2);if(e.translate(0,n),i&&i.length>32)e.fillStyle="rgba(0, 0, 0, 0.15)",e.beginPath(),e.arc(0,0,1.05*t,0,2*Math.PI),e.fill();else{const n=ni.getRadialGradient(e,0,0,.7*t,0,0,1.2*t,[{offset:0,color:"rgba(0, 0, 0, 0.2)"},{offset:.8,color:"rgba(0, 0, 0, 0.1)"},{offset:1,color:"rgba(0, 0, 0, 0)"}]);if(e.fillStyle=n,e.beginPath(),i){const t=1.1,n=i.length>20?2:1;e.moveTo(i[0].x*t,i[0].y*t);for(let s=n;s<i.length;s+=n)e.lineTo(i[s].x*t,i[s].y*t);e.closePath()}else e.arc(0,0,1.1*t,0,2*Math.PI);e.fill()}e.restore()}drawCircle(e,t){e.beginPath(),e.arc(0,0,t,0,2*Math.PI),e.fill()}drawMorphedShape(e,t,i){!t||t.length<3?this.drawCircle(e,i):(e.beginPath(),t.forEach((t,i)=>{0===i?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.closePath(),e.fill())}renderZenCore(e,t,i,n){const{ctx:s}=this,r=i*(.95+.05*(.5*Math.sin(.001*n)+.5));s.save(),s.shadowBlur=this.scaleValue(10),s.shadowColor="rgba(147, 112, 219, 0.3)",s.shadowOffsetX=0,s.shadowOffsetY=0,s.fillStyle="#FFFFFF",s.beginPath(),s.arc(e,t,r,0,2*Math.PI),s.fill(),s.strokeStyle="rgba(147, 112, 219, 0.2)",s.lineWidth=this.scaleValue(1),s.beginPath(),s.arc(e,t,.9*r,0,2*Math.PI),s.stroke(),s.restore()}renderSleepyCore(e,t,i){const{ctx:n}=this;n.save(),n.translate(e,t),n.scale(1,.85),n.fillStyle="#FFFFFF",n.beginPath(),n.arc(0,0,i,0,2*Math.PI),n.fill(),n.restore()}renderGlitchedCore(e,t,i,n){const{ctx:s}=this;s.save(),[{x:-2,y:0,alpha:.3},{x:2,y:0,alpha:.3},{x:0,y:-1,alpha:.2}].forEach(r=>{s.fillStyle=this.hexToRgba("#FFFFFF",r.alpha*n),s.beginPath(),s.arc(e+r.x*n*this.scaleValue(5),t+r.y*n*this.scaleValue(5),i,0,2*Math.PI),s.fill()}),s.fillStyle="#FFFFFF",s.beginPath(),s.arc(e,t,i,0,2*Math.PI),s.fill(),s.restore()}setShapePoints(e){this.shapePoints=e,this.isMorphing=e&&e.length>0}clearShapePoints(){this.shapePoints=null,this.isMorphing=!1}setCoreColor(e){this.coreColor=e}setCoreOpacity(e){this.coreOpacity=Math.max(0,Math.min(1,e))}setCoreBorder(e,t){this.coreBorderWidth=e,this.coreBorderColor=t}getCoreInfo(){return{color:this.coreColor,opacity:this.coreOpacity,hasBorder:this.coreBorderWidth>0,isMorphing:this.isMorphing,shapePointCount:this.shapePoints?this.shapePoints.length:0}}}class ai{renderSunEffects(e,t,i,n,s){const r=Date.now()/100;if(e.save(),e.translate(t,i),s.texture&&(void 0===s.textureOpacity||s.textureOpacity>0)){e.save(),e.globalCompositeOperation="screen",e.globalAlpha=void 0!==s.textureOpacity?s.textureOpacity:1;const t=.05*r*(s.turbulence||.3)/.3,i=e.createRadialGradient(Math.sin(t)*n*.15,Math.cos(.7*t)*n*.15,.2*n,0,0,n);i.addColorStop(0,"rgba(255, 255, 200, 0)"),i.addColorStop(.4,"rgba(255, 200, 100, 0.1)"),i.addColorStop(.7,"rgba(255, 150, 50, 0.08)"),i.addColorStop(1,"rgba(255, 100, 30, 0.05)"),e.fillStyle=i,e.beginPath(),e.arc(0,0,n,0,2*Math.PI),e.fill(),e.restore()}const a=void 0!==s.coronaOpacity?s.coronaOpacity:1;if(a>0){e.save(),e.globalCompositeOperation="screen";const t=e.createRadialGradient(0,0,.5*n,0,0,1.1*n);t.addColorStop(0,`rgba(255, 255, 255, ${.8*a})`),t.addColorStop(.3,`rgba(255, 250, 200, ${.6*a})`),t.addColorStop(.5,`rgba(255, 200, 100, ${.4*a})`),t.addColorStop(.7,`rgba(255, 150, 50, ${.2*a})`),t.addColorStop(1,"rgba(255, 100, 20, 0)"),e.fillStyle=t,e.beginPath(),e.arc(0,0,1.1*n,0,2*Math.PI),e.fill();for(let t=0;t<2;t++){const i=1.3+.4*t,s=(.35-.15*t)*a,o=.05*Math.sin(.1*r+t),c=e.createRadialGradient(0,0,n*(.9+o),0,0,n*(i+o));c.addColorStop(0,"rgba(255, 255, 200, 0)"),c.addColorStop(.4,`rgba(255, 200, 100, ${.5*s})`),c.addColorStop(.7,`rgba(255, 150, 50, ${s})`),c.addColorStop(.9,`rgba(255, 100, 30, ${.5*s})`),c.addColorStop(1,"rgba(255, 50, 10, 0)"),e.fillStyle=c,e.beginPath(),e.arc(0,0,n*(i+o),0,2*Math.PI),e.fill()}e.restore()}if(s.flares){e.save();const t=Math.sin(.08*r),i=Math.sin(.12*r),s=Math.sin(.16*r),a=e.createLinearGradient(0,-n,0,3*-n);a.addColorStop(0,"rgba(255, 255, 230, 0.4)"),a.addColorStop(.2,"rgba(255, 220, 150, 0.25)"),a.addColorStop(.5,"rgba(255, 180, 80, 0.15)"),a.addColorStop(.8,"rgba(255, 120, 40, 0.08)"),a.addColorStop(1,"rgba(255, 60, 20, 0)"),e.fillStyle=a,e.globalCompositeOperation="screen",e.beginPath();const o=(t,i,s,r)=>{const a=Math.cos(t),o=Math.sin(t),c=a*n,l=o*n,h=a*(n+i),u=o*(n+i),d=-o*s*.5,p=a*s*.5,m=r*s*.3;e.moveTo(c-d,l-p),e.quadraticCurveTo(.5*(c+h)+d*m,.5*(l+u)+p*m,h,u),e.quadraticCurveTo(.5*(c+h)-d*m,.5*(l+u)-p*m,c+d,l+p)};for(let e=0;e<8;e++)o(e/8*Math.PI*2+.1*t,n*(1.8+.4*Math.sin(.1*r+.5*e)),.18*n,Math.sin(.15*r+e));for(let e=0;e<12;e++)o((e+.5)/12*Math.PI*2+.08*i,n*(1.2+.3*Math.sin(.13*r+.7*e)),.12*n,Math.sin(.18*r+1.2*e));for(let e=0;e<15;e++)o(e/15*Math.PI*2+.05*s,n*(.7+.25*Math.sin(.17*r+.9*e)),.08*n,Math.sin(.2*r+1.5*e));for(let t=0;t<15;t++){const i=(t+.25)/15*Math.PI*2,s=n*(.4+.2*Math.sin(.22*r+t)),a=.06*n,o=Math.cos(i),c=Math.sin(i),l=o*n,h=c*n,u=o*(n+s),d=c*(n+s),p=-c*a*.5,m=o*a*.5;e.moveTo(l-p,h-m),e.lineTo(u,d),e.lineTo(l+p,h+m)}e.fill(),e.restore()}const o=e.createRadialGradient(0,0,.95*n,0,0,1.05*n);o.addColorStop(0,"rgba(255, 255, 255, 0)"),o.addColorStop(.7,"rgba(255, 255, 200, 0.2)"),o.addColorStop(.9,"rgba(255, 200, 100, 0.5)"),o.addColorStop(1,"rgba(255, 150, 50, 0.3)"),e.fillStyle=o,e.beginPath(),e.arc(0,0,1.05*n,0,2*Math.PI),e.fill(),e.restore()}renderBaileysBeads(e,t,i,n,s,r,a,o,c,l=e=>e){if(!c)return void(this._beadStartTime=null);const h=Math.abs(s)<1&&Math.abs(r)<1,u=o?30:15;if(!(Math.abs(s)<u&&Math.abs(r)<u||h))return void(this._beadStartTime=null);if(!this._beadStartTime){const e=Math.floor(4*Math.random())+1;this._currentBeads=[];const t=[];for(let i=0;i<e;i++)t.push(Math.random()*Math.PI*2);const i=Array.from({length:e},(e,t)=>t);for(let e=i.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[i[e],i[t]]=[i[t],i[e]]}for(let n=0;n<e;n++)this._currentBeads.push({angle:t[n],size:3+5*Math.random(),order:i[n],delay:200*i[n]});this._beadStartTime=Date.now()}const d=Date.now()-this._beadStartTime;(this._currentBeads||[]).forEach(s=>{if(d<s.delay)return;const r=d-s.delay,a=Math.min(1,r/300),o=t+Math.cos(s.angle)*n,c=i+Math.sin(s.angle)*n;e.save(),e.translate(o,c),e.globalAlpha=a;const h=l(s.size),u=[{color:`rgba(255, 100, 100, ${.6*a})`,offset:-2},{color:`rgba(100, 255, 100, ${.6*a})`,offset:0},{color:`rgba(100, 100, 255, ${.6*a})`,offset:2}];e.globalCompositeOperation="screen",u.forEach(({color:t,offset:i})=>{const n=e.createRadialGradient(i,i,0,i,i,2*h);n.addColorStop(0,t),n.addColorStop(.2,t.replace(""+.6*a,""+.4*a)),n.addColorStop(.5,t.replace(""+.6*a,""+.2*a)),n.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=n,e.beginPath(),e.arc(i,i,2*h,0,2*Math.PI),e.fill()}),e.globalCompositeOperation="lighter";const p=e.createRadialGradient(0,0,0,0,0,h);p.addColorStop(0,`rgba(255, 255, 255, ${a})`),p.addColorStop(.3,`rgba(255, 255, 255, ${.5*a})`),p.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=p,e.beginPath(),e.arc(0,0,h,0,2*Math.PI),e.fill(),e.restore()})}renderMoonShadow(e,t,i,n,s,r,a=!1,o=0,c=null){if(e.save(),e.globalAlpha=1,e.translate(t,i),"crescent"===s.type){let t=1,i=s.offset||.7;if(c){const e=c.getProgress(),{targetShape:n}=c;"moon"===n&&void 0!==e&&e<1&&!s.shadowX&&(t=e,i=2.7*t-2)}const a=(s.angle||-30)*Math.PI/180,o=Math.cos(a)*n*i,l=Math.sin(a)*n*i;if(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",e.beginPath(),r&&r.length>0){e.moveTo(r[0].x,r[0].y);for(let t=1;t<r.length;t++)e.lineTo(r[t].x,r[t].y);e.closePath()}else e.arc(0,0,n,0,2*Math.PI);e.clip();const h=e.createRadialGradient(o,l,.9*n,o,l,1.1*n),u=void 0!==s.coverage?s.coverage:.85,d=Math.min(1,1.2*t)*(u/.85);h.addColorStop(0,`rgba(0, 0, 0, ${1*d})`),h.addColorStop(.8,`rgba(0, 0, 0, ${1*d})`),h.addColorStop(.88,`rgba(0, 0, 0, ${.98*d})`),h.addColorStop(.91,`rgba(0, 0, 0, ${.95*d})`),h.addColorStop(.93,`rgba(0, 0, 0, ${.9*d})`),h.addColorStop(.95,`rgba(0, 0, 0, ${.8*d})`),h.addColorStop(.96,`rgba(0, 0, 0, ${.65*d})`),h.addColorStop(.97,`rgba(0, 0, 0, ${.45*d})`),h.addColorStop(.98,`rgba(0, 0, 0, ${.25*d})`),h.addColorStop(.99,`rgba(0, 0, 0, ${.1*d})`),h.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=h,e.beginPath(),e.arc(o,l,1.1*n,0,2*Math.PI),e.fill()}else if("lunar"===s.type){const t=1-(void 0!==s.diffusion?s.diffusion:1);let i=0,r=0;if(c){const e=c.getProgress(),{currentShape:t,targetShape:s}=c;if(a&&"solar"===s&&void 0!==e&&e<1){const t=2.5*n;i=-t*(1-e),r=t*(1-e)}else if(a&&"solar"===t&&"solar"!==s&&null!==s&&void 0!==e&&e<1){const t=2.5*n;i=t*e,r=-t*e}}e.translate(i,r),a?(e.save(),e.beginPath(),e.arc(-i,-r,n,0,2*Math.PI),e.clip()):(e.beginPath(),e.arc(0,0,n,0,2*Math.PI),e.clip());const o=n*(1.8-.5*t),l=e.createRadialGradient(0,0,.2*n,0,0,o),h=s.coverage||.9;if(s.color&&s.color.includes("0, 0, 0")?(l.addColorStop(0,`rgba(0, 0, 0, ${h})`),l.addColorStop(.3+.2*t,`rgba(0, 0, 0, ${.95*h})`),l.addColorStop(.6+.2*t,`rgba(0, 0, 0, ${.8*h})`),l.addColorStop(.85,`rgba(0, 0, 0, ${.4*h})`),l.addColorStop(1,"rgba(0, 0, 0, 0)")):(l.addColorStop(0,`rgba(10, 2, 0, ${h})`),l.addColorStop(.3+.2*t,`rgba(20, 5, 0, ${.95*h})`),l.addColorStop(.6+.2*t,`rgba(40, 10, 5, ${.8*h})`),l.addColorStop(.85,`rgba(60, 15, 10, ${.4*h})`),l.addColorStop(1,"rgba(80, 20, 15, 0)")),e.fillStyle=l,e.beginPath(),e.arc(0,0,o,0,2*Math.PI),e.fill(),t>.3){const i=n*(.8+.3*t),r=e.createRadialGradient(0,0,0,0,0,i);s.color&&s.color.includes("0, 0, 0")?(r.addColorStop(0,`rgba(0, 0, 0, ${h})`),r.addColorStop(.5,`rgba(0, 0, 0, ${.9*h})`),r.addColorStop(.8,`rgba(0, 0, 0, ${.5*h})`),r.addColorStop(1,"rgba(0, 0, 0, 0)")):(r.addColorStop(0,`rgba(0, 0, 0, ${h})`),r.addColorStop(.5,`rgba(10, 2, 0, ${.9*h})`),r.addColorStop(.8,`rgba(20, 5, 0, ${.5*h})`),r.addColorStop(1,"rgba(30, 8, 5, 0)")),e.fillStyle=r,e.beginPath(),e.arc(0,0,i,0,2*Math.PI),e.fill()}}a&&e.restore(),e.restore()}}class oi{renderZenCore(e,t,i,n,s,r,a,o){e.save(),s.shakeOffset&&(t+=s.shakeOffset),s.driftY&&(i+=s.driftY),e.translate(t,i),a&&void 0!==a.rotation&&e.rotate(a.rotation*Math.PI/180);const c=Date.now()/1e3,l=.5*Math.sin(.5*c)+1.5;let h=.1;"in"===r.phase?h=1:"entering"===r.phase?h=Math.max(.1,3.3*(r.lotusMorph-.7)):"exiting"===r.phase&&(h=Math.max(.1,.5*r.lotusMorph));const u=l*h;if(r.lotusMorph>0){e.shadowBlur=o(100)*u,e.shadowColor=`rgba(255, 223, 0, ${.5*u})`;const t=e.createRadialGradient(0,0,0,0,0,4*n);"in"!==r.phase?(t.addColorStop(0,"rgba(184, 134, 11, 0.8)"),t.addColorStop(.3,"rgba(153, 101, 21, 0.6)"),t.addColorStop(.6,"rgba(139, 69, 19, 0.4)"),t.addColorStop(1,"rgba(101, 67, 33, 0)")):(t.addColorStop(0,`rgba(255, 255, 255, ${1*u})`),t.addColorStop(.1,`rgba(255, 255, 240, ${1*u})`),t.addColorStop(.2,`rgba(255, 250, 205, ${.95*u})`),t.addColorStop(.35,`rgba(255, 240, 150, ${.85*u})`),t.addColorStop(.5,`rgba(255, 223, 0, ${.7*u})`),t.addColorStop(.65,`rgba(255, 215, 0, ${.5*u})`),t.addColorStop(.8,`rgba(255, 215, 0, ${.3*u})`),t.addColorStop(.9,`rgba(255, 215, 0, ${.15*u})`),t.addColorStop(.95,`rgba(255, 215, 0, ${.05*u})`),t.addColorStop(1,"rgba(255, 215, 0, 0)")),e.fillStyle=t,e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=o(2),e.beginPath(),e.arc(0,0,n,0,2*Math.PI,!1);const i=r.lotusMorph,s=r.petalSpread,a=r.smileCurve;if(i>.1){const t=n*(.05+.15*i);if(e.moveTo(0,t),e.bezierCurveTo(-n*(.05+.25*i*s),.1*n,-n*(.05+.3*i*s),-n*(.1+.4*i),0,-n*(.2+.65*i)),e.bezierCurveTo(n*(.05+.3*i*s),-n*(.1+.4*i),n*(.05+.25*i*s),.1*n,0,t),i>.3){const t=(i-.3)/.7;e.moveTo(.1*-n*t,.2*n),e.bezierCurveTo(-n*(.1+.4*t*s),.1*n,-n*(.2+.5*t*s),-n*(.1+.2*t),-n*(.1+.4*t*s),-n*(.2+.45*t)),e.bezierCurveTo(-n*(.05+.15*t),-n*(.1+.4*t),.05*-n*t,.1*n,.1*-n*t,.2*n),e.moveTo(.1*n*t,.2*n),e.bezierCurveTo(n*(.1+.4*t*s),.1*n,n*(.2+.5*t*s),-n*(.1+.2*t),n*(.1+.4*t*s),-n*(.2+.45*t)),e.bezierCurveTo(n*(.05+.15*t),-n*(.1+.4*t),.05*n*t,.1*n,.1*n*t,.2*n)}a>0&&(e.moveTo(.6*-n,n*(.5-.1*a)),e.quadraticCurveTo(0,n*(.5+.1*a),.6*n,n*(.5-.1*a)))}if(e.closePath(),e.fill("evenodd"),e.beginPath(),e.arc(0,0,n,0,2*Math.PI),e.stroke(),"in"===r.phase){const t=2*n,i=r.arcHeight*n,s=.5*n,a=e.createRadialGradient(0,s,0,0,s,1.2*t);a.addColorStop(0,`rgba(255, 255, 255, ${1*u})`),a.addColorStop(.25,`rgba(255, 252, 240, ${.8*u})`),a.addColorStop(.5,`rgba(255, 245, 200, ${.6*u})`),a.addColorStop(.75,`rgba(255, 235, 150, ${.4*u})`),a.addColorStop(1,"rgba(255, 223, 0, 0)"),e.fillStyle=a,e.fill();const o=e.createRadialGradient(0,-i/2,.5*n,0,-i/2,5*n);o.addColorStop(0,"rgba(255, 223, 0, 0)"),o.addColorStop(.1,`rgba(255, 223, 0, ${.25*u})`),o.addColorStop(.2,`rgba(255, 220, 0, ${.2*u})`),o.addColorStop(.35,`rgba(255, 215, 0, ${.15*u})`),o.addColorStop(.5,`rgba(255, 215, 0, ${.1*u})`),o.addColorStop(.65,`rgba(255, 215, 0, ${.06*u})`),o.addColorStop(.8,`rgba(255, 215, 0, ${.03*u})`),o.addColorStop(.9,`rgba(255, 215, 0, ${.01*u})`),o.addColorStop(1,"rgba(255, 215, 0, 0)"),e.fillStyle=o,e.fill()}}else{e.shadowBlur=0,e.shadowColor="transparent";const t=.3;e.fillStyle=`rgba(255, 215, 0, ${t})`,e.beginPath(),e.arc(0,0,n,0,2*Math.PI),e.fill();const i=e.createRadialGradient(0,0,0,0,0,n);i.addColorStop(0,"rgba(255, 255, 255, 0.2)"),i.addColorStop(.5,"rgba(255, 250, 230, 0.1)"),i.addColorStop(1,"rgba(255, 215, 0, 0)"),e.fillStyle=i,e.fill()}e.restore()}}const ci=2,li=3,hi=4,ui=new class{constructor(){this.callbacks=new Map,this.callbackIdCounter=0,this.frameId=null,this.isRunning=!1,this.lastFrameTime=0,this.deltaTime=0,this.fps=60,this.frameCount=0,this.targetFPS=60,this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=16.67,this.prioritySkipCounters={[ci]:0,[li]:0,[hi]:0},this.performanceMonitor=null,this.frameTimeHistory=[],this.maxHistorySize=60,this.loop=this.loop.bind(this)}register(e,t=2,i=null){if("function"!=typeof e)throw new Error("Callback must be a function");const n=++this.callbackIdCounter;return this.callbacks.set(n,{callback:e,priority:t,context:i,lastRun:0,runCount:0,totalTime:0,enabled:!0}),1!==this.callbacks.size||this.isRunning||this.start(),n}unregister(e){this.callbacks.delete(e),0===this.callbacks.size&&this.isRunning&&this.stop()}setEnabled(e,t){const i=this.callbacks.get(e);i&&(i.enabled=t)}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.frameId=requestAnimationFrame(this.loop))}stop(){this.isRunning&&(this.isRunning=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null))}loop(e){if(!this.isRunning)return;this.deltaTime=e-this.lastFrameTime,this.lastFrameTime=e,this.frameCount++,this.frameCount%60==0&&(this.fps=Math.round(1e3/(this.deltaTime||16.67))),this.frameTimeHistory.push(this.deltaTime),this.frameTimeHistory.length>this.maxHistorySize&&this.frameTimeHistory.shift();const t=performance.now(),i=this.groupCallbacksByPriority();let n=0;for(const t of[0,1,2,3,4]){if(t>0&&n>.8*this.frameBudget)break;if(this.shouldSkipPriority(t))continue;const s=i.get(t)||[];for(const t of s){if(!t.enabled)continue;const i=performance.now();try{t.context?t.callback.call(t.context,this.deltaTime,e):t.callback(this.deltaTime,e);const s=performance.now()-i;t.totalTime+=s,t.runCount++,t.lastRun=e,n+=s}catch(e){console.error("Animation callback error:",e),t.runCount>0&&t.totalTime/t.runCount>10&&(console.warn("Disabling slow callback"),t.enabled=!1)}if(n>this.frameBudget)break}}const s=performance.now()-t;s>1.5*this.frameBudget&&console.warn(`Frame took ${s.toFixed(2)}ms (target: ${this.frameBudget}ms)`),this.frameId=requestAnimationFrame(this.loop)}groupCallbacksByPriority(){const e=new Map;for(const[,t]of this.callbacks){const{priority:i}=t;e.has(i)||e.set(i,[]),e.get(i).push(t)}return e}shouldSkipPriority(e){if(0===e)return!1;if(this.fps<30&&e>=3)return!0;if(this.fps<45&&4===e)return!0;if(2===e){if(this.fps<50&&(this.prioritySkipCounters[e]++,this.prioritySkipCounters[e]%2!=0))return!0}else if(3===e){if(this.fps<50&&(this.prioritySkipCounters[e]++,this.prioritySkipCounters[e]%3!=0))return!0}else if(4===e&&(this.prioritySkipCounters[e]++,this.prioritySkipCounters[e]%5!=0))return!0;return!1}getStats(){const e={fps:this.fps,frameCount:this.frameCount,callbackCount:this.callbacks.size,averageFrameTime:0,maxFrameTime:0,minFrameTime:1/0};if(this.frameTimeHistory.length>0){let t=0;for(const i of this.frameTimeHistory)t+=i,e.maxFrameTime=Math.max(e.maxFrameTime,i),e.minFrameTime=Math.min(e.minFrameTime,i);e.averageFrameTime=t/this.frameTimeHistory.length}e.callbacksByPriority={};for(const[,t]of this.callbacks){const{priority:i}=t;e.callbacksByPriority[i]||(e.callbacksByPriority[i]={count:0,totalTime:0,enabled:0}),e.callbacksByPriority[i].count++,e.callbacksByPriority[i].totalTime+=t.totalTime,t.enabled&&e.callbacksByPriority[i].enabled++}return e}setTargetFPS(e){this.targetFPS=Math.max(15,Math.min(120,e)),this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=this.targetFrameTime}setPerformanceMonitor(e){this.performanceMonitor=e}destroy(){this.stop(),this.callbacks.clear(),this.frameTimeHistory=[]}};class di{constructor(e){this.renderer=e,this.zenTransition={active:!1,phase:null,startTime:0,previousEmotion:null,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0},this.loopCallbackIds={zenEnter:null,zenExit:null}}getZenTransition(){return this.zenTransition}isActive(){return this.zenTransition.active}isInZenPhase(){return this.zenTransition.active&&"in"===this.zenTransition.phase}enterZenMode(e,t){this._cancelAnimations(),this.renderer.state.glowColor=e,this.renderer.state.glowIntensity=t,this.renderer.colorTransition.active=!1,this.zenTransition={active:!0,phase:"entering",startTime:performance.now(),previousEmotion:this.renderer.state.emotion,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0};const i=()=>{if(!this.zenTransition.active||"entering"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenEnter=null);const e=performance.now()-this.zenTransition.startTime;if(e<400){const t=e/400,n=1-Math.pow(1-t,2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=n,this.zenTransition.petalSpread=n,this.zenTransition.smileCurve=Math.sin(t*Math.PI/2),this.loopCallbackIds.zenEnter=ui.register(i,2,this)}else this.zenTransition.phase="in",this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=1,this.zenTransition.petalSpread=1,this.zenTransition.smileCurve=1,this.renderer.state.zenVortexIntensity=1,this.loopCallbackIds.zenEnter=null};this.loopCallbackIds.zenEnter=ui.register(i,2,this)}exitZenMode(e,t,i){if(!this.zenTransition.active||"in"!==this.zenTransition.phase)return;this._cancelAnimations(),this.zenTransition.phase="exiting",this.zenTransition.startTime=performance.now(),this.zenTransition.targetEmotion=e;const n=()=>{if(!this.zenTransition.active||"exiting"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenExit=null);const e=performance.now()-this.zenTransition.startTime,s=150;if(e<s){const r=e/s,a=1-Math.pow(1-r,2);if(0!==r&&this.renderer.colorTransition.active||this.renderer.startColorTransition(t,i,s),this.zenTransition.arcHeight=1.5*(1-a),this.zenTransition.smileCurve=1*(1-a),r>.3){const e=(r-.3)/.7;this.zenTransition.petalSpread=1*(1-e)}if(r>.5){const e=(r-.5)/.5;this.zenTransition.lotusMorph=1*(1-e)}this.loopCallbackIds.zenExit=ui.register(n,2,this)}else if(e<350){const t=(e-s)/200;if(this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,t<.2){const e=t/.2;this.zenTransition.scaleY=1-.8*Math.sin(e*Math.PI)}else if(t<.6){const e=(t-.2)/.4;this.zenTransition.scaleY=1,this.renderer.state.shakeOffset=3*Math.sin(e*Math.PI*4)}else{const e=(t-.6)/.4;this.renderer.state.driftY=-10*e,this.renderer.state.glowIntensity=1+.5*e}this.loopCallbackIds.zenExit=ui.register(n,2,this)}else if(e<550){const t=(e-s-200)/200,i=Math.sin(t*Math.PI/2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=.2+.8*i,this.renderer.state.driftY=-10*(1-t),this.renderer.state.glowIntensity=1.5-.5*t,this.loopCallbackIds.zenExit=ui.register(n,2,this)}else if(e<650){const t=(e-s-200-200)/100,i=Math.sin(t*Math.PI);this.zenTransition.scaleX=1+.05*i,this.zenTransition.scaleY=1+.05*i,this.loopCallbackIds.zenExit=ui.register(n,2,this)}else this._resetZenState()};this.loopCallbackIds.zenExit=ui.register(n,2,this)}_cancelAnimations(){this.loopCallbackIds.zenEnter&&(ui.unregister(this.loopCallbackIds.zenEnter),this.loopCallbackIds.zenEnter=null),this.loopCallbackIds.zenExit&&(ui.unregister(this.loopCallbackIds.zenExit),this.loopCallbackIds.zenExit=null)}_resetZenState(){this.zenTransition.active=!1,this.zenTransition.phase=null,this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,this.renderer.state.shakeOffset=0,this.renderer.state.driftY=0,this.loopCallbackIds.zenExit=null}destroy(){this._cancelAnimations(),this._resetZenState()}}class pi{constructor(e){this.renderer=e,this.episodicEffects={nervous:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+2e3*Math.random()},confident:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+2e3*Math.random()},tired:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:5e3+2e3*Math.random()},intense:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+3e3*Math.random()},subdued:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+3e3*Math.random()}}}getEpisodicEffects(){return this.episodicEffects}updateEpisodicEffects(e,t,i,n,s){if(!e||!this.episodicEffects[e])return{jitterX:t,jitterY:i,coreRadius:n,glowRadius:s};const r=this.episodicEffects[e],a=performance.now();if(!r.active&&a>=r.nextTrigger)switch(r.active=!0,r.startTime=a,e){case"nervous":r.duration=500+500*Math.random(),r.intensity=2+Math.random(),r.nextTrigger=a+3e3+2e3*Math.random();break;case"confident":r.duration=1e3+1e3*Math.random(),r.intensity=.15,r.nextTrigger=a+4e3+2e3*Math.random();break;case"tired":r.duration=1e3+2e3*Math.random(),r.intensity=.2,r.nextTrigger=a+5e3+2e3*Math.random();break;case"intense":r.duration=500+500*Math.random(),r.intensity=.5,r.nextTrigger=a+3e3+3e3*Math.random();break;case"subdued":r.duration=2e3+1e3*Math.random(),r.intensity=.3,r.nextTrigger=a+4e3+3e3*Math.random()}if(r.active){const o=a-r.startTime;if(o<r.duration){const a=o/r.duration;switch(e){case"nervous":{const e=1-a,n=15,s=Math.sin(a*Math.PI*n)*e;t=s*r.intensity,i=s*r.intensity*.7;break}case"confident":{const e=Math.sin(a*Math.PI);n*=1+r.intensity*e,s*=1+.5*r.intensity*e;break}case"tired":{const e=Math.sin(a*Math.PI*.5);n*=1-r.intensity*e,i+=5*e;break}case"intense":{const e=1-Math.cos(a*Math.PI);n*=1-.05*e,s*=1+r.intensity*e;break}case"subdued":{const e=Math.sin(a*Math.PI*.5);n*=1-.1*e,s*=1-r.intensity*e;break}}}else r.active=!1}return{jitterX:t,jitterY:i,coreRadius:n,glowRadius:s}}reset(){Object.keys(this.episodicEffects).forEach(e=>{this.episodicEffects[e].active=!1,this.episodicEffects[e].startTime=0,this.episodicEffects[e].duration=0,this.episodicEffects[e].intensity=0})}getEpisodeState(e){return this.episodicEffects[e]||null}isEpisodeActive(e){const t=this.episodicEffects[e];return!!t&&t.active}}class mi{constructor(e){this.renderer=e,this.brakeStartTime=null,this.brakeDuration=2500,this.brakeStartRotation=0,this.brakeTargetRotation=0,this.brakeStartVelocity=0,this.onComplete=null,this.onProgress=null,this.DURATION_FACTOR=14}brakeToUpright(e={}){return this.brakeToTarget(0,e)}brakeToNearest(e,t={}){const i=this.renderer.state.manualRotation||0,n=Math.round(i/e)*e;return this.brakeToTarget(n,t)}brakeToTarget(e,t={}){return new Promise(i=>{const{onProgress:n=null,onComplete:s=null}=t;this.onProgress=n,this.onComplete=s;const r=this.renderer.state.rotationSpeed||0,a=this.renderer.state.manualRotation||0;if(0===r||this.brakeStartTime)return void i();if(this.brakeStartTime=performance.now(),this.brakeStartRotation=a,this.brakeStartVelocity=r,0===e)this.brakeTargetRotation=r>0?360*(Math.floor(a/360)+1):360*Math.floor(a/360);else{const t=e%360,i=Math.floor(a/360);this.brakeTargetRotation=r>0?t>a%360?360*i+t:360*(i+1)+t:t<a%360?360*i+t:360*(i-1)+t}const o=Math.abs(this.brakeTargetRotation-this.brakeStartRotation);this.brakeDuration=Math.max(500,o/Math.abs(r)*this.DURATION_FACTOR*5),console.warn("Brake started:",{from:`${a.toFixed(1)}°`,to:`${this.brakeTargetRotation.toFixed(1)}°`,velocity:r,duration:`${this.brakeDuration.toFixed(0)}ms`}),this.renderer.setRotationSpeed(0),this.resolvePromise=i})}updateBrake(e){if(!this.brakeStartTime)return null;const t=e-this.brakeStartTime,i=Math.min(t/this.brakeDuration,1),n=1-Math.pow(1-i,4),s=this.brakeStartRotation+(this.brakeTargetRotation-this.brakeStartRotation)*n,r=this.brakeStartVelocity*Math.pow(1-n,2);return this.onProgress&&this.onProgress(n,r,s),i>=1?(this.brakeStartTime=null,console.warn("Brake complete:",{target:`${this.brakeTargetRotation.toFixed(1)}°`,duration:`${t.toFixed(0)}ms`}),this.complete(),{rotation:this.brakeTargetRotation,speed:0,complete:!0}):{rotation:s,speed:r,complete:!1}}stop(){this.brakeStartTime=null}complete(){this.onComplete&&this.onComplete(),this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null)}isBraking(){return null!==this.brakeStartTime}emergencyStop(){this.stop(),this.renderer.setRotationSpeed(0),this.complete()}getProgress(){if(!this.brakeStartTime)return 0;const e=performance.now()-this.brakeStartTime;return Math.min(e/this.brakeDuration,1)}}class gi{constructor(e){this.renderer=e,this.rotationBrake=new mi(e)}setRotationSpeed(e){this.renderer.state.rotationSpeed=e}setRotationAngle(e){this.renderer.state.manualRotation=e}getRotationAngle(){return this.renderer.state.manualRotation}getRotationSpeed(){return this.renderer.state.rotationSpeed}isBraking(){return this.rotationBrake&&this.rotationBrake.isBraking()}updateRotation(e){if(this.rotationBrake&&this.rotationBrake.isBraking()){const t=this.rotationBrake.updateBrake(e);t&&(this.renderer.state.manualRotation=t.rotation,this.renderer.state.rotationSpeed=t.complete?0:t.speed)}else 0!==this.renderer.state.rotationSpeed&&(this.renderer.state.manualRotation+=this.renderer.state.rotationSpeed);this.renderer.state.lastRotationUpdate=e}calculateTotalRotation(e=0,t=0){return(e+t+this.renderer.state.manualRotation)*Math.PI/180}applyRotation(e,t){0!==t&&e.rotate(t)}reset(){this.renderer.state.manualRotation=0,this.renderer.state.rotationSpeed=0,this.renderer.state.lastRotationUpdate=performance.now()}destroy(){this.rotationBrake&&(this.rotationBrake=null)}}let fi=class{constructor(e){this.renderer=e,this.canvas=e.canvas,this.initialized=!1,this.handleMouseMove=null,this.handleTouchMove=null}setEnabled(e){this.renderer.state.gazeTrackingEnabled=e,e?this.initialized||this.initialize():this.renderer.state.gazeTarget={x:0,y:0}}initialize(){this.initialized||(this.handleMouseMove=e=>{if(!this.renderer.state.gazeTrackingEnabled)return;const t=this.canvas.getBoundingClientRect(),i=t.width/2,n=t.height/2,s=e.clientX-t.left-i,r=e.clientY-t.top-n;this.renderer.state.gazeTarget={x:s/i,y:r/n}},this.handleTouchMove=e=>{if(this.renderer.state.gazeTrackingEnabled&&e.touches.length>0){const t=e.touches[0],i=this.canvas.getBoundingClientRect(),n=i.width/2,s=i.height/2,r=t.clientX-i.left-n,a=t.clientY-i.top-s;this.renderer.state.gazeTarget={x:r/n,y:a/s}}},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("touchmove",this.handleTouchMove),this.initialized=!0)}cleanup(){this.initialized&&(this.handleMouseMove&&(document.removeEventListener("mousemove",this.handleMouseMove),this.handleMouseMove=null),this.handleTouchMove&&(document.removeEventListener("touchmove",this.handleTouchMove),this.handleTouchMove=null),this.initialized=!1)}isInitialized(){return this.initialized}getGazeTarget(){return this.renderer.state.gazeTarget}isEnabled(){return this.renderer.state.gazeTrackingEnabled}};class yi{constructor(e){this.renderer=e}setupCanvas(){this.renderer.updateOffscreenSize();const e=this.renderer.canvasManager.width||this.renderer.canvas.width||400,t=this.renderer.canvasManager.height||this.renderer.canvas.height||400,i=this.renderer.ctx;return this.renderer.ctx=this.renderer.offscreenCtx,{logicalWidth:e,logicalHeight:t,originalCtx:i}}renderBackdrop(e,t,i,n){const s=Math.min(e,t),r=this.renderer.getEffectiveCenter(),a=r.x,o=r.y-this.renderer.config.topOffset,c=s/this.renderer.config.referenceSize*this.renderer.config.baseScale*(r.coreScale||r.scale),l=this.renderer.config.referenceSize/this.renderer.config.coreSizeDivisor*c;this.renderer.backdropRenderer.update(n),this.renderer.audioAnalyzer&&this.renderer.audioAnalyzer.currentAmplitude&&this.renderer.backdropRenderer.setAudioIntensity(this.renderer.audioAnalyzer.currentAmplitude),this.renderer.backdropRenderer.render(a,o,l,i)}applyCanvasDecay(e,t,i){const n=this.renderer.particleSystem?this.renderer.particleSystem.particles.length:0,s=.12+Math.min(.08,.003*n);e.save(),e.globalCompositeOperation="destination-out",e.fillStyle=`rgba(0, 0, 0, ${s})`,e.fillRect(0,0,t,i),e.restore()}clearOffscreenCanvas(e,t){this.renderer.ctx.clearRect(0,0,e,t)}performCanvasSetup(e,t,i,n){this.renderBackdrop(e,t,i,n),this.applyCanvasDecay(i,e,t),this.clearOffscreenCanvas(e,t)}}class vi{constructor(e){this.renderer=e}markFrameStart(){return this.renderer.performanceMonitor&&this.renderer.performanceMonitor.markFrameStart(),performance.now()}handleCleanRender(){this.renderer.forceCleanRender&&(this.renderer.forceCleanRender=!1,this.renderer.canvas&&this.renderer.ctx&&this.renderer.ctx.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height))}initializeFrame(){const e=this.markFrameStart();return this.handleCleanRender(),e}}class bi{constructor(e){this.renderer=e}mergeTransforms(e,t){const i=this.renderer.ambientDanceAnimator.getTransform(t);return e?(e.x=(e.x||0)+(i.x||0),e.y=(e.y||0)+(i.y||0),e.rotation=(e.rotation||0)+(i.rotation||0),e.scale=(e.scale||1)*(i.scale||1),e):i}mergeAndStoreTransforms(e,t){const i=this.mergeTransforms(e,t);return this.renderer.gestureTransform=i,i}}class wi{constructor(e){this.renderer=e}updateUndertoneModifiers(){if(this.renderer.stateMachine&&this.renderer.stateMachine.getWeightedUndertoneModifiers){const e=this.renderer.stateMachine.getWeightedUndertoneModifiers();e?this.renderer.applyUndertoneModifiers(e):this.renderer.applyUndertoneModifiers(null)}}updateColorTransition(e){this.renderer.colorTransition&&this.renderer.colorTransition.active&&this.renderer.updateColorTransition(e)}updateAnimationTimers(e){this.renderer.updateTimers(e)}updateGazeOffset(){if(this.renderer.state.gazeTrackingEnabled){const e=.15,t=50;this.renderer.state.gazeOffset.x+=(this.renderer.state.gazeTarget.x*t-this.renderer.state.gazeOffset.x)*e,this.renderer.state.gazeOffset.y+=(this.renderer.state.gazeTarget.y*t-this.renderer.state.gazeOffset.y)*e}else{const e=.1;this.renderer.state.gazeOffset.x+=(0-this.renderer.state.gazeOffset.x)*e,this.renderer.state.gazeOffset.y+=(0-this.renderer.state.gazeOffset.y)*e}}performFrameStateUpdates(e){this.updateUndertoneModifiers(),this.updateColorTransition(e),this.updateAnimationTimers(e),this.updateGazeOffset()}}class Si{constructor(e){this.renderer=e}calculateBaseDimensions(e,t){const i=Math.min(e,t),n=this.renderer.getEffectiveCenter();return this.renderer.scaleFactor=i/this.renderer.config.referenceSize*this.renderer.config.baseScale*(n.coreScale||n.scale),this.renderer.particleScaleFactor=i/this.renderer.config.referenceSize*this.renderer.config.baseScale*(n.particleScale||n.scale),{canvasSize:i,effectiveCenter:n}}calculateCenterPosition(e,t,i){const n=e.x;let s=e.y-this.renderer.config.topOffset;return t.properties&&t.properties.verticalOffset&&(s=e.y-this.renderer.config.topOffset+i*t.properties.verticalOffset),{centerX:n,centerY:s}}applyGestureTransform(e,t,i){let n=1,s=0,r=1;return i&&(e+=i.x||0,t+=i.y||0,n=i.scale||1,s=(i.rotation||0)*Math.PI/180,r=i.glowIntensity||1),{centerX:e,centerY:t,scaleMultiplier:n,rotationAngle:s,glowMultiplier:r}}applyGestureAnimations(e,t,i,n,s){const r=this.renderer.gestureAnimator.applyGestureAnimations();return r&&(e+=r.offsetX||0,t+=r.offsetY||0,i*=r.scale||1,n+=(r.rotation||0)*Math.PI/180,s=r.glow||1),{centerX:e,centerY:t,scaleMultiplier:i,rotationAngle:n,glowMultiplier:s,gestureTransforms:r}}calculateRenderDimensions(e,t,i,n){const{canvasSize:s,effectiveCenter:r}=this.calculateBaseDimensions(e,t);let a,o,c,{centerX:l,centerY:h}=this.calculateCenterPosition(r,i,t);({centerX:l,centerY:h,scaleMultiplier:a,rotationAngle:o,glowMultiplier:c}=this.applyGestureTransform(l,h,n));const u=this.applyGestureAnimations(l,h,a,o,c);({centerX:l,centerY:h,scaleMultiplier:a,rotationAngle:o,glowMultiplier:c}=u);const{gestureTransforms:d}=u;return{canvasSize:s,effectiveCenter:r,centerX:l,centerY:h,scaleMultiplier:a,rotationAngle:o,glowMultiplier:c,gestureTransforms:d}}}class Mi{constructor(e){this.renderer=e}calculateSleepModifiers(){let e=1,t=1,i=1;if(this.renderer.state.sleeping||"resting"===this.renderer.state.emotion||Ht("sleeping",this.renderer.state)){const n=Gt("sleeping");if(n){const s=n.getDimmingValues();e=void 0!==this.renderer.state.sleepDimness?this.renderer.state.sleepDimness:s.orbDimming,i=s.glowDimming,t=void 0!==this.renderer.state.sleepScale?this.renderer.state.sleepScale:.9}else e=void 0!==this.renderer.state.sleepDimness?this.renderer.state.sleepDimness:.3,i=.2,t=void 0!==this.renderer.state.sleepScale?this.renderer.state.sleepScale:.9;this.renderer.state.breathRate=.5,this.renderer.state.breathDepth=.15}return{sleepOpacityMod:e,sleepScaleMod:t,glowOpacityMod:i}}calculateBreathingFactors(){let e,t;if(null!==this.renderer.state.customScale)e=this.renderer.state.customScale,t=1+.5*(this.renderer.state.customScale-1);else{const i=this.renderer.breathingAnimator.getBreathingScale();e=i,t=1-.5*(i-1)}return"nervous"===this.renderer.state.undertone&&this.renderer.undertoneModifiers.nervous.glowPulse&&(t*=1+Math.sin(Date.now()/200)*this.renderer.undertoneModifiers.nervous.glowPulse),{coreBreathFactor:e,glowBreathFactor:t}}calculateRadii(e,t,i){const{sleepOpacityMod:n,sleepScaleMod:s,glowOpacityMod:r}=this.calculateSleepModifiers(),{coreBreathFactor:a,glowBreathFactor:o}=this.calculateBreathingFactors(),c=this.renderer.config.referenceSize/this.renderer.config.coreSizeDivisor*this.renderer.scaleFactor,l=e.properties&&e.properties.coreSize?e.properties.coreSize:1,h=this.renderer.state.sizeMultiplier||1;return{coreRadius:c*l*a*t*s*h,glowRadius:c*this.renderer.config.glowMultiplier*o*this.renderer.state.glowIntensity*t*s*h*i,effectiveGlowIntensity:this.renderer.state.glowIntensity*i,sleepOpacityMod:n,glowOpacityMod:r}}}class xi{constructor(e){this.renderer=e}applyZenLevitation(e,t,i){if("zen"===this.renderer.state.emotion&&"in"===this.renderer.zenTransition.phase){const n=Date.now()/1e3;t+=15*Math.sin(.3*n)*this.renderer.scaleFactor,e+=8*Math.sin(.2*n)*this.renderer.scaleFactor,i+=.05*Math.sin(.25*n)}return{centerX:e,centerY:t,rotationAngle:i}}applyBlinkSquish(e){return this.renderer.state.sleeping||"zen"===this.renderer.state.emotion||(e*=this.renderer.eyeRenderer.getBlinkScale()),e}calculateJitter(e,t){let i=0,n=0;const s=this.renderer.state.jitterAmount||0;if(this.renderer.currentUndertone)({jitterX:i,jitterY:n,coreRadius:e,glowRadius:t}=this.renderer.episodicEffectController.updateEpisodicEffects(this.renderer.currentUndertone,i,n,e,t));else if(this.renderer.state.coreJitter||s>0){const e=Math.max(s,this.renderer.state.coreJitter?this.renderer.scaleValue(2):0);i=(Math.random()-.5)*e,n=(Math.random()-.5)*e}return{jitterX:i,jitterY:n,coreRadius:e,glowRadius:t}}calculateFinalPosition(e,t,i,n){return{coreX:e+this.renderer.state.gazeOffset.x+i,coreY:t+this.renderer.state.gazeOffset.y+n}}applyAllModifications(e,t,i,n,s){let r,a;({centerX:e,centerY:t,rotationAngle:i}=this.applyZenLevitation(e,t,i)),n=this.applyBlinkSquish(n),({jitterX:r,jitterY:a,coreRadius:n,glowRadius:s}=this.calculateJitter(n,s));const{coreX:o,coreY:c}=this.calculateFinalPosition(e,t,r,a);return{coreX:o,coreY:c,rotationAngle:i,coreRadius:n,glowRadius:s}}}class Ci{constructor(e){this.renderer=e}applyRotationTransform(e,t,i){const n=performance.now();this.renderer.rotationManager.updateRotation(n);const s=this.renderer.rotationManager.calculateTotalRotation(i);return 0!==s&&(this.renderer.ctx.save(),this.renderer.ctx.translate(e,t),this.renderer.rotationManager.applyRotation(this.renderer.ctx,s),this.renderer.ctx.translate(-e,-t)),s}}class Ti{constructor(e){this.renderer=e}renderGlow(e,t,i,n,s,r){Ht("recording-glow",this.renderer.state)?$t("recording-glow",this.renderer.ctx,{x:e,y:t,radius:i,deltaTime:r}):Ht("zen-vortex",this.renderer.state)||(this.renderer.state.sleeping||"resting"===this.renderer.state.emotion||Ht("sleeping",this.renderer.state)?(this.renderer.ctx.save(),this.renderer.ctx.globalAlpha=s,this.renderer.glowRenderer.renderGlow(e,t,i,{intensity:n}),this.renderer.ctx.restore()):this.renderer.glowRenderer.renderGlow(e,t,i,{intensity:n}))}renderFlashWave(e,t,i,n){if(e&&e.flashWave){const s=e.flashWave,{ctx:r}=this.renderer;r.save(),r.globalCompositeOperation="lighter";const a=n*s.innerRadius,o=n*s.outerRadius;if(o>a){const e=ni.getRadialGradient(r,t,i,a,t,i,o,[{offset:0,color:"rgba(255, 255, 255, 0)"},{offset:.2,color:`rgba(255, 255, 255, ${.15*s.intensity})`},{offset:.5,color:`rgba(255, 255, 255, ${.25*s.intensity})`},{offset:.8,color:`rgba(255, 255, 255, ${.15*s.intensity})`},{offset:1,color:"rgba(255, 255, 255, 0)"}]);r.fillStyle=e,r.beginPath(),r.arc(t,i,o,0,2*Math.PI),r.arc(t,i,Math.max(0,a),0,2*Math.PI,!0),r.fill()}r.restore()}}renderSpeakingPulse(e,t,i,n){Ht("speaking-pulse",this.renderer.state)&&$t("speaking-pulse",this.renderer.ctx,{x:e,y:t,radius:i,audioLevel:this.renderer.state.audioLevel||0,deltaTime:n})}renderAllEffects(e){const{coreX:t,coreY:i,glowRadius:n,effectiveGlowIntensity:s,glowOpacityMod:r,gestureTransforms:a,coreRadius:o,deltaTime:c}=e;this.renderGlow(t,i,n,s,r,c),this.renderFlashWave(a,t,i,o),this.renderSpeakingPulse(t,i,o,c)}}class ki{constructor(e){this.renderer=e}applySleepOpacity(e){(this.renderer.state.sleeping||"resting"===this.renderer.state.emotion)&&(this.renderer.ctx.globalAlpha=e)}updateShapeMorpher(e){let t=null,i=null;return this.renderer.shapeMorpher&&(this.renderer.shapeMorpher.update(),t=this.renderer.shapeMorpher.getCanvasPoints(0,0,e),i=this.renderer.shapeMorpher.getCurrentShadow()),{shapePoints:t,currentShadow:i}}renderSunEffects(e,t,i,n){let s=!1;return!n||"sun"!==n.type&&"solar-hybrid"!==n.type||(this.renderer.renderSunEffects(e,t,i,n),s=!0),s}renderCore(e,t,i,n,s){this.renderer.coreRenderer.renderCore(e,t,i,{scaleX:1,scaleY:1,rotation:n,shapePoints:s})}renderSparkles(e){this.renderer.specialEffects&&(this.renderer.specialEffects.update(e),this.renderer.specialEffects.renderSparkles())}renderShadowEffects(e,t,i,n,s,r){const a=this.renderer.shapeMorpher?this.renderer.shapeMorpher.currentShape:null,o=this.renderer.shapeMorpher?this.renderer.shapeMorpher.targetShape:null,c=this.renderer.shapeMorpher&&"solar"===o&&this.renderer.shapeMorpher.isTransitioning,l=this.renderer.shapeMorpher&&"solar"===a&&this.renderer.shapeMorpher.isTransitioning,h=n&&"solar-hybrid"===n.type,u=this.renderer.shapeMorpher&&this.renderer.shapeMorpher.isTransitioning&&"solar"===a&&"moon"===o,d=this.renderer.shapeMorpher&&this.renderer.shapeMorpher.isTransitioning&&"moon"===a&&"solar"===o;if(!n||"crescent"!==n.type&&"lunar"!==n.type||d||this.renderer.renderMoonShadow(e,t,i,n,s,!1,0),(h&&n.lunarOverlay||c||l)&&!u){const a=h&&n.lunarOverlay?n.lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"};let o=0,u=0,d=0;if(this.renderer.shapeMorpher){d=this.renderer.shapeMorpher.getProgress();const e=2.5*i;c&&d<1?(o=-e*(1-d),u=e*(1-d)):l&&d<1&&(o=e*d,u=-e*d)}if(this.renderer.renderMoonShadow(e,t,i,a,s,!0),(c||l)&&(c||r)&&(this.renderer.renderBaileysBeads(e,t,i,o,u,d,c,!0),Math.abs(o)<30&&Math.abs(u)<30&&this.renderer.specialEffects)){const e=Math.sqrt(o*o+u*u),t=Math.max(.1,.5*(1-e/30));this.renderer.specialEffects.triggerChromaticAberration(t)}}}cleanup(e){(this.renderer.state.sleeping||"resting"===this.renderer.state.emotion)&&(this.renderer.ctx.globalAlpha=1),0!==e&&this.renderer.ctx.restore()}renderCoreAndShapes(e){const{coreX:t,coreY:i,coreRadius:n,totalRotation:s,sleepOpacityMod:r,deltaTime:a}=e;this.applySleepOpacity(r);const{shapePoints:o,currentShadow:c}=this.updateShapeMorpher(n),l=this.renderSunEffects(t,i,n,c);this.renderCore(t,i,n,s,o),this.renderSparkles(a),this.renderShadowEffects(t,i,n,c,o,l),this.cleanup(s)}}class Ei{constructor(e){this.renderer=e}renderSleepIndicator(e,t,i,n){this.renderer.state.sleeping&&this.renderer.renderSleepIndicator(e,t-i-this.renderer.scaleValue(20),n)}finalizeCanvas(e,t,i){this.renderer.ctx=e,e.drawImage(this.renderer.offscreenCanvas,0,0,t,i)}drawRecordingIndicator(e){if(Ht("recording-glow",this.renderer.state)){const t=Gt("recording-glow");t&&t.drawRecordingIndicator&&t.drawRecordingIndicator(e,this.renderer.canvas.width,this.renderer.canvas.height)}}finalizePerformanceMetrics(e){const t=performance.now()-e;this.renderer.performanceMonitor&&(this.renderer.performanceMonitor.markFrameEnd(),this.renderer.performanceMonitor.recordFrameTime(t))}finalizeRender(e){const{centerX:t,centerY:i,glowRadius:n,deltaTime:s,originalCtx:r,logicalWidth:a,logicalHeight:o,frameStartTime:c}=e;this.renderSleepIndicator(t,i,n,s),this.finalizeCanvas(r,a,o),this.drawRecordingIndicator(r),this.finalizePerformanceMetrics(c)}}class Pi{constructor(e){this.renderer=e,this.animations={grooveSway:null,grooveBob:null,grooveFlow:null,groovePulse:null,grooveStep:null},this.activeAnimation=null,this.blendState={x:0,y:0,rotation:0,scale:1,opacity:1}}startAmbientAnimation(e,t={}){this.activeAnimation&&this.activeAnimation!==e&&this.stopAmbientAnimation(this.activeAnimation),this.activeAnimation=e,this.animations[e]={startTime:Date.now(),intensity:t.intensity||1,frequency:t.frequency||1,options:t}}stopAmbientAnimation(e){this.animations[e]&&(this.animations[e]=null),this.activeAnimation===e&&(this.activeAnimation=null)}updateBlendState(e){if(!e)return;const t=.2;this.blendState.x=this.lerp(this.blendState.x,e.x||0,t),this.blendState.y=this.lerp(this.blendState.y,e.y||0,t),this.blendState.rotation=this.lerp(this.blendState.rotation,e.rotation||0,t),this.blendState.scale=this.lerp(this.blendState.scale,e.scale||1,t),this.blendState.opacity=this.lerp(this.blendState.opacity,e.opacity||1,t)}getTransform(e){const t={x:this.blendState.x,y:this.blendState.y,rotation:this.blendState.rotation,scale:this.blendState.scale,opacity:this.blendState.opacity};if(this.activeAnimation){const e=this.animations[this.activeAnimation];if(e){const i=Date.now()-e.startTime;switch(this.activeAnimation){case"grooveSway":t.x+=15*Math.sin(i/500*e.frequency)*e.intensity,t.rotation+=5*Math.sin(i/500*e.frequency+Math.PI/4)*e.intensity;break;case"grooveBob":t.y+=10*Math.sin(i/400*e.frequency)*e.intensity,t.scale*=1+.03*Math.sin(i/400*e.frequency)*e.intensity;break;case"grooveFlow":{const n=i/1e3*e.frequency;t.x+=Math.sin(n)*Math.cos(2*n)*20*e.intensity,t.y+=Math.cos(n)*Math.sin(2*n)*10*e.intensity,t.rotation+=8*Math.sin(2*n)*e.intensity;break}case"groovePulse":t.scale*=1+.05*Math.sin(i/250*e.frequency)*e.intensity,t.opacity*=.9+.1*Math.sin(i/250*e.frequency)*e.intensity;break;case"grooveStep":{const n=Math.floor(i/500*e.frequency)%4,s=i/500*e.frequency%1,r=this.smoothStep(s);0===n?t.x+=25*r*e.intensity:2===n&&(t.x-=25*r*e.intensity),t.y+=5*Math.abs(Math.sin(i/250*e.frequency))*e.intensity;break}}}}return t}lerp(e,t,i){return e+(t-e)*i}smoothStep(e){return e*e*(3-2*e)}}class _i{constructor(e){this.renderer=e,this.ctx=e.ctx,this.config={enabled:!1,radius:1.5,shape:"circle",color:"rgba(0, 0, 0, 0.6)",intensity:.7,blendMode:"normal",falloff:"smooth",falloffCurve:null,edgeSoftness:.6,coreTransparency:.2,blur:0,responsive:!0,pulse:!1,offset:{x:0,y:0},type:"radial-gradient"},this.currentIntensity=0,this.targetIntensity=0,this.pulsePhase=0}setConfig(e={}){this.config={...this.config,...e},void 0!==e.enabled&&(this.targetIntensity=e.enabled?this.config.intensity:0)}update(e){this.config.enabled?(this.currentIntensity+=.1*(this.targetIntensity-this.currentIntensity),this.config.responsive&&(this.pulsePhase+=.001*e)):this.currentIntensity*=.95}setAudioIntensity(e){if(!this.config.responsive)return;const t=.2*e;this.targetIntensity=Math.min(1,this.config.intensity+t)}render(e,t,i,n=null){if(this.currentIntensity<.01)return;const s=n||this.ctx;switch(s.save(),this.config.type){case"radial-gradient":this.renderRadialGradient(e,t,i,s);break;case"vignette":this.renderVignette(e,t,i,s);break;case"glow":this.renderGlow(e,t,i,s)}s.restore()}renderRadialGradient(e,t,i,n){n=n||this.ctx;const s=i*this.config.radius,r=e+(this.config.offset.x||0),a=t+(this.config.offset.y||0);let o=s;(this.config.pulse||this.config.responsive)&&(o*=1+.05*Math.sin(this.pulsePhase));const c=n.globalCompositeOperation;this.config.blendMode&&"normal"!==this.config.blendMode&&(n.globalCompositeOperation=this.config.blendMode),this.config.blur>0&&(n.filter=`blur(${this.config.blur}px)`);const l=n.createRadialGradient(r,a,0,r,a,o),h=this.config.color,u=this.currentIntensity;this.addGradientStopsSimple(l,h,u),n.fillStyle=l,n.beginPath(),n.arc(r,a,o,0,2*Math.PI),n.fill(),this.config.blur>0&&(n.filter="none"),this.config.blendMode&&"normal"!==this.config.blendMode&&(n.globalCompositeOperation=c)}renderVignette(e,t,i,n){n=n||this.ctx;const{canvas:s}=n,r=Math.max(s.width,s.height),a=n.createRadialGradient(e,t,.5*i,e,t,r);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,this.adjustColorAlpha(this.config.color,this.currentIntensity)),n.fillStyle=a,n.fillRect(0,0,s.width,s.height)}renderGlow(e,t,i,n){n=n||this.ctx;const s=i*this.config.radius;for(let i=0;i<3;i++){const r=s*(1-.2*i),a=this.currentIntensity*(.3-.1*i),o=n.createRadialGradient(e,t,0,e,t,r);o.addColorStop(0,this.adjustColorAlpha(this.config.color,a)),o.addColorStop(1,"rgba(0, 0, 0, 0)"),n.fillStyle=o,n.beginPath(),n.arc(e,t,r,0,2*Math.PI),n.fill()}}addGradientStopsSimple(e,t,i){const{coreTransparency:n}=this.config;e.addColorStop(0,this.adjustColorAlpha(t,i)),e.addColorStop(n,this.adjustColorAlpha(t,i));for(let s=1;s<=25;s++){const r=n+s/25*(1-n),a=(r-n)/(1-n),o=1-this.easeInOutCubic(a);e.addColorStop(r,this.adjustColorAlpha(t,i*o))}e.addColorStop(1,"rgba(0, 0, 0, 0)")}addGradientStops(e,t,i,n=1){const{coreTransparency:s}=this.config;if(this.config.falloffCurve&&Array.isArray(this.config.falloffCurve))this.config.falloffCurve.forEach(({stop:n,alpha:s})=>{e.addColorStop(n,this.adjustColorAlpha(t,i*s))});else switch(this.config.falloff){case"linear":e.addColorStop(0,"rgba(0, 0, 0, 0)"),e.addColorStop(s,"rgba(0, 0, 0, 0)"),e.addColorStop(1,this.adjustColorAlpha(t,i));break;case"exponential":e.addColorStop(0,"rgba(0, 0, 0, 0)"),e.addColorStop(s,"rgba(0, 0, 0, 0)"),e.addColorStop(s+.3*(1-s),this.adjustColorAlpha(t,.05*i)),e.addColorStop(s+.5*(1-s),this.adjustColorAlpha(t,.15*i)),e.addColorStop(s+.7*(1-s),this.adjustColorAlpha(t,.4*i)),e.addColorStop(s+.85*(1-s),this.adjustColorAlpha(t,.7*i)),e.addColorStop(1,this.adjustColorAlpha(t,i));break;default:{e.addColorStop(0,"rgba(0, 0, 0, 0)"),e.addColorStop(s*n,"rgba(0, 0, 0, 0)");const{edgeSoftness:r}=this.config,a=n,o=s*n+(a-s*n)*r,c=25;for(let r=1;r<=c;r++){const l=r/c;let h=0;if(l<=s*n)h=0;else if(l<=a)if(l<=o){const e=(l-s*n)/(o-s*n);h=this.easeInOutCubic(e)}else{const e=(l-o)/(a-o);h=1-.05*(1-this.easeInOutCubic(e))}else{const e=(l-a)/(1-a);h=1-this.easeInOutCubic(e)}e.addColorStop(l,this.adjustColorAlpha(t,i*h))}e.addColorStop(1,"rgba(0, 0, 0, 0)");break}}}easeInOutCubic(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}adjustColorAlpha(e,t){const i=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(i){const[,e,n,s,r=1]=i;return`rgba(${e}, ${n}, ${s}, ${parseFloat(r)*t})`}return`rgba(0, 0, 0, ${.6*t})`}getConfig(){return{...this.config}}enable(){this.config.enabled=!0,this.targetIntensity=this.config.intensity}disable(){this.config.enabled=!1,this.targetIntensity=0}toggle(){this.config.enabled?this.disable():this.enable()}}class Ai{constructor(e){this.renderer=e,this.loopCallbackIds={eyeClose:null,eyeOpen:null},this.wakeJitterTimeout=null}enterSleepMode(){this.renderer.state.sleeping=!0,this.renderer.sleepZ=[],this.renderer.state.eyeOpenness=1,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.renderer.state.blinking=!1,this.animateEyeClose()}animateEyeClose(){this.loopCallbackIds.eyeClose&&(ui.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null),this.loopCallbackIds.eyeOpen&&(ui.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null);const e=performance.now(),t=2e3;this.loopCallbackIds.eyeClose=ui.register(()=>{if(!this.renderer.state.sleeping)return void(this.loopCallbackIds.eyeClose=null);const i=performance.now()-e;if(i<t){const e=i/t,n=1-Math.pow(e,2);this.renderer.state.eyeOpenness=.1+.9*n,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1}else if(i<3e3){const e=(i-t)/1e3,n=1-Math.pow(1-e,3);this.renderer.state.eyeOpenness=.1,this.renderer.state.sleepDimness=1-.4*n,this.renderer.state.sleepScale=1-.1*n}else this.renderer.state.eyeOpenness=.1,this.renderer.state.sleepDimness=.6,this.renderer.state.sleepScale=.9,this.loopCallbackIds.eyeClose=null},1,this.renderer)}wakeUp(){this.renderer.state.sleeping&&(this.renderer.state.sleeping=!1,this.renderer.state.breathRate=1,this.renderer.state.breathDepth=this.renderer.config.breathingDepth,this.renderer.sleepZ=[],this.renderer.state.blinking=!1,this.renderer.eyeRenderer.blinking=!1,this.renderer.eyeRenderer.blinkTimer=0,this.animateEyeOpen(),this.wakeJitterTimeout&&clearTimeout(this.wakeJitterTimeout),this.renderer.state.coreJitter=!0,this.wakeJitterTimeout=setTimeout(()=>{this.renderer.state.coreJitter=!1,this.wakeJitterTimeout=null},200))}animateEyeOpen(){this.loopCallbackIds.eyeOpen&&(ui.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null),this.loopCallbackIds.eyeClose&&(ui.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null);const e=performance.now();this.loopCallbackIds.eyeOpen=ui.register(()=>{const t=performance.now()-e;if(t<500){const e=t/500,i=Math.sin(e*Math.PI/2);this.renderer.state.sleepDimness=.6+.4*i,this.renderer.state.sleepScale=.9+.1*i,this.renderer.state.eyeOpenness=.1}else if(t<1500){const e=(t-500)/1e3,i=Math.sin(e*Math.PI/2);this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.renderer.state.eyeOpenness=.1+.9*i}else this.renderer.state.eyeOpenness=1,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.loopCallbackIds.eyeOpen=null},1,this.renderer)}renderSleepIndicator(e,t,i){return this.renderer.specialEffects.renderSleepIndicator(e,t,i)}cleanup(){this.loopCallbackIds.eyeClose&&(ui.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null),this.loopCallbackIds.eyeOpen&&(ui.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null),this.wakeJitterTimeout&&(clearTimeout(this.wakeJitterTimeout),this.wakeJitterTimeout=null)}}class Ii{constructor(e){this.renderer=e}applyUndertoneModifiers(e){if(e&&"object"==typeof e&&void 0!==e.weight){const{weight:t}=e;return this.renderer.state.sizeMultiplier=1+((e.sizeMultiplier||1)-1)*t,this.renderer.state.jitterAmount=(e.jitterAmount||0)*t,this.renderer.state.episodicFlutter=t>.5&&e.episodicFlutter||!1,this.renderer.state.glowRadiusMult=1+((e.glowRadiusMult||1)-1)*t,this.renderer.state.breathRateMult=1+((e.breathRateMult||1)-1)*t,this.renderer.state.breathDepthMult=1+((e.breathDepthMult||1)-1)*t,this.renderer.state.breathIrregular=t>.5&&e.breathIrregular||!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=(e.glowPulse||0)*t,this.renderer.state.brightnessFlicker=(e.brightnessFlicker||0)*t,this.renderer.state.brightnessMult=1+((e.brightnessMult||1)-1)*t,this.renderer.state.saturationMult=1+((e.saturationMult||1)-1)*t,void(this.renderer.state.hueShift=(e.hueShift||0)*t)}if(!e||!this.renderer.undertoneModifiers[e])return this.renderer.state.sizeMultiplier=1,this.renderer.state.jitterAmount=0,this.renderer.state.episodicFlutter=!1,this.renderer.state.glowRadiusMult=1,this.renderer.state.breathRateMult=1,this.renderer.state.breathDepthMult=1,this.renderer.state.breathIrregular=!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=0,this.renderer.state.brightnessFlicker=0,this.renderer.state.brightnessMult=1,this.renderer.state.saturationMult=1,void(this.renderer.state.hueShift=0);const t=this.renderer.undertoneModifiers[e];this.renderer.state.sizeMultiplier=t.sizeMultiplier,this.renderer.state.jitterAmount=t.jitterAmount||0,this.renderer.state.episodicFlutter=t.episodicFlutter||!1,this.renderer.state.glowRadiusMult=t.glowRadiusMult,this.renderer.state.breathRateMult=t.breathRateMult,this.renderer.state.breathDepthMult=t.breathDepthMult,this.renderer.state.breathIrregular=t.breathIrregular||!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=t.glowPulse||0,this.renderer.state.brightnessFlicker=t.brightnessFlicker||0,this.renderer.state.brightnessMult=t.brightnessMult||1,this.renderer.state.saturationMult=t.saturationMult||1,this.renderer.state.hueShift=t.hueShift||0}updateUndertone(e){this.renderer.state.undertone!==e&&this.renderer.glowCache.clear(),this.renderer.state.undertone=e,this.renderer.currentUndertone=e;const t=this.renderer.stateMachine&&this.renderer.stateMachine.getWeightedUndertoneModifiers?this.renderer.stateMachine.getWeightedUndertoneModifiers():null;if(this.applyUndertoneModifiers(t||e),this.renderer.state.emotion){const i=$&&$.isInitialized?$.getEmotion(this.renderer.state.emotion):A(this.renderer.state.emotion);if(i){const n=i.glowColor||this.renderer.config.defaultGlowColor,s=this.renderer.applyUndertoneToColor(n,t||e);this.renderer.startColorTransition(s,200)}}}setEmotionalState(e,t,i=null){this.renderer.state.emotion===e&&this.renderer.state.undertone===i||this.renderer.glowCache.clear(),this.renderer.state.undertone=i,this.renderer.currentUndertone=i;const n=this.renderer.stateMachine&&this.renderer.stateMachine.getWeightedUndertoneModifiers?this.renderer.stateMachine.getWeightedUndertoneModifiers():null;this.applyUndertoneModifiers(n||i);const s=t.glowColor||this.renderer.config.defaultGlowColor;let r;r="suspicion"===e?t.glowColor||s:this.renderer.applyUndertoneToColor(s,n||i);const a=n||(i?this.renderer.undertoneModifiers[i]:null),o=t.glowIntensity||1;let c=1;if(a)if(n){const e=a.weight||0;c=void 0!==a.glowRadiusMult&&isFinite(a.glowRadiusMult)&&isFinite(e)?1+(a.glowRadiusMult-1)*e:1}else c=void 0!==a.glowRadiusMult?a.glowRadiusMult:1;const l=o*c;let h=1500;"anger"===e||"fear"===e?h=800:("sadness"===e||"resting"===e||"zen"===e)&&(h=2e3);const u=this.renderer.state.emotion;this.renderer.state.emotion=e,"suspicion"===e?(this.renderer.state.isSuspicious=!0,this.renderer.state.targetSquintAmount=t&&t.coreSquint?t.coreSquint:.4,void 0===this.renderer.state.squintAmount&&(this.renderer.state.squintAmount=0),this.renderer.state.lastScanTime=Date.now(),this.renderer.state.scanPhase=0):(this.renderer.state.isSuspicious=!1,this.renderer.state.targetSquintAmount=0,void 0===this.renderer.state.squintAmount&&(this.renderer.state.squintAmount=0)),"zen"===e&&"zen"!==u?this.renderer.enterZenMode(r,l):"zen"===u&&"zen"!==e?this.renderer.exitZenMode(e,r,l):this.renderer.startColorTransition(r,l,h);const d=t.breathRate||1,p=t.breathDepth||this.renderer.config.breathingDepth;this.renderer.state.breathRate=a?d*a.breathRateMult:d,this.renderer.state.breathDepth=a?p*a.breathDepthMult:p,this.renderer.state.coreJitter=t.coreJitter||a&&a.jitterAmount>0,this.renderer.state.emotionEyeOpenness=t.eyeOpenness,this.renderer.state.emotionEyeArc=t.eyeArc}}class Ri{constructor(e){this.renderer=e}resetCanvasContext(){if(!this.renderer.canvas||!this.renderer.ctx)return;const{width:e}=this.renderer.canvas,{height:t}=this.renderer.canvas;this.resetContext(this.renderer.ctx,e,t),this.renderer.offscreenCanvas&&this.renderer.offscreenCtx&&this.resetContext(this.renderer.offscreenCtx,this.renderer.offscreenCanvas.width,this.renderer.offscreenCanvas.height),this.renderer.contextStateManager&&this.renderer.contextStateManager.reset(),this.renderer.forceCleanRender=!0}resetContext(e,t,i){e.setTransform(1,0,0,1,0,0),e.globalAlpha=1,e.globalCompositeOperation="source-over",e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",e.clearRect(0,0,t,i)}setQualityLevel(e){this.renderer.qualityLevel=Math.max(0,Math.min(1,e)),this.renderer.qualityLevel<.5?this.applyLowQuality():this.renderer.qualityLevel<.8?this.applyMediumQuality():this.applyHighQuality()}applyLowQuality(){this.renderer.ctx.imageSmoothingEnabled=!1,this.renderer.state.breathDepth*=.5}applyMediumQuality(){this.renderer.ctx.imageSmoothingEnabled=!0,this.renderer.ctx.imageSmoothingQuality="medium"}applyHighQuality(){this.renderer.ctx.imageSmoothingEnabled=!0,this.renderer.ctx.imageSmoothingQuality="high"}setQualityReduction(e){e?this.setQualityLevel(.5):this.setQualityLevel(1)}handleContextRecovery(e){this.renderer.ctx=e}}class Di{constructor(e){this.renderer=e}destroy(){this.cancelAnimationFrames(),this.unregisterLoopCallbacks(),this.cleanupManagers(),this.clearTimeouts(),this.clearAnimationStates(),this.clearOtherResources()}cancelAnimationFrames(){for(const e in this.renderer.animationFrameIds)this.renderer.animationFrameIds[e]&&(cancelAnimationFrame(this.renderer.animationFrameIds[e]),this.renderer.animationFrameIds[e]=null)}unregisterLoopCallbacks(){for(const e in this.renderer.loopCallbackIds)this.renderer.loopCallbackIds[e]&&(ui.unregister(this.renderer.loopCallbackIds[e]),this.renderer.loopCallbackIds[e]=null)}cleanupManagers(){this.renderer.sleepManager&&this.renderer.sleepManager.cleanup(),this.renderer.gazeTracker&&this.renderer.gazeTracker.cleanup()}clearTimeouts(){this.renderer.wakeJitterTimeout&&(clearTimeout(this.renderer.wakeJitterTimeout),this.renderer.wakeJitterTimeout=null)}clearAnimationStates(){this.renderer.colorTransition.active=!1,this.renderer.zenTransition&&(this.renderer.zenTransition.active=!1)}clearOtherResources(){this.renderer.cleanupGazeTracking(),this.renderer.speakingRings=[],this.renderer.gestureCompositor&&this.renderer.gestureCompositor.clearCache(),this.renderer.specialEffects&&this.renderer.specialEffects.destroy()}}class Oi{constructor(e){this.renderer=e}updateTimers(e){this.updateBreathing(e),this.updateBlinking(e)}updateBreathing(e){this.renderer.breathingAnimator.update(e,this.renderer.state.emotion,this.renderer.currentUndertone),"zen"===this.renderer.state.emotion?this.applyZenBreathing():this.renderer.state.sleeping?this.applySleepBreathing():this.applyNormalBreathing(),this.renderer.breathingAnimator.setIrregularBreathing(this.renderer.state.breathIrregular)}applyZenBreathing(){this.renderer.breathingAnimator.setBreathRateMultiplier(.15),this.renderer.breathingAnimator.setBreathDepthMultiplier(2.5)}applySleepBreathing(){this.renderer.breathingAnimator.setBreathRateMultiplier(.5),this.renderer.breathingAnimator.setBreathDepthMultiplier(1.2)}applyNormalBreathing(){this.renderer.breathingAnimator.setBreathRateMultiplier(1),this.renderer.breathingAnimator.setBreathDepthMultiplier(1)}updateBlinking(e){const t=this.renderer.state.blinkingEnabled&&!this.renderer.state.sleeping&&"zen"!==this.renderer.state.emotion;this.renderer.eyeRenderer.setBlinkingEnabled(t),this.renderer.eyeRenderer.update(e),this.renderer.state.blinking=this.renderer.eyeRenderer.blinking}}class zi{constructor(e){this.renderer=e}setGazeOffset(e){this.processGazeData(e),this.handleGazeInteraction()}processGazeData(e){"object"==typeof e&&null!==e&&(this.isOldFormat(e)?this.renderer.state.gazeOffset=e:this.applyNewFormatData(e))}isOldFormat(e){return{}.hasOwnProperty.call(e,"x")&&{}.hasOwnProperty.call(e,"y")}applyNewFormatData(e){this.renderer.state.gazeOffset=e.offset||{x:0,y:0},this.renderer.state.gazeIntensity=e.proximity||0,this.renderer.state.gazeLocked=e.isLocked||!1}handleGazeInteraction(){this.renderer.idleTimer=0,this.renderer.isAsleep&&this.renderer.wakeUp()}getCurrentOrbPosition(){const e=this.renderer.canvasManager.width/2,t=this.renderer.canvasManager.height/2-this.renderer.config.topOffset;return{x:e+this.renderer.state.gazeOffset.x,y:t+this.renderer.state.gazeOffset.y}}}class Bi{constructor(e,t={}){this.canvasManager=e,this.ctx=e.getContext(),this.ctx,this.gestureCompositor=new At,this.currentUndertone=null,this.gestureAnimator=new Kt(this),this.colorUtilities=new Zt,this.specialEffects=new ei(this),this.eyeRenderer=new ti(this),this.breathingAnimator=new ii(this),this.glowRenderer=new si(this),this.coreRenderer=new ri(this),this.celestialRenderer=new ai,this.zenModeRenderer=new oi,this.zenModeController=new di(this),this.episodicEffectController=new pi(this),this.rotationManager=new gi(this),this.gazeTracker=new fi(this),this.canvasSetupManager=new yi(this),this.renderPerformanceManager=new vi(this),this.transformMerger=new bi(this),this.stateUpdateManager=new wi(this),this.dimensionCalculator=new Si(this),this.radiusCalculator=new Mi(this),this.positionJitterManager=new xi(this),this.rotationRenderManager=new Ci(this),this.effectsRenderManager=new Ti(this),this.coreShapeRenderManager=new ki(this),this.renderFinalizationManager=new Ei(this),this.ambientDanceAnimator=new Pi(this),this.backdropRenderer=new _i(this),this.sleepManager=new Ai(this),this.emotionalStateManager=new Ii(this),this.canvasContextManager=new Ri(this),this.resourceCleanupManager=new Di(this),this.timerCoordinator=new Oi(this),this.gazeInputHandler=new zi(this),this.config={coreColor:t.coreColor||"#FFFFFF",coreSizeDivisor:t.coreSizeDivisor||12,glowMultiplier:t.glowMultiplier||2.5,defaultGlowColor:t.defaultGlowColor||"#14B8A6",breathingSpeed:t.breathingSpeed||.42,breathingDepth:t.breathingDepth||.08,renderingStyle:t.renderingStyle||"classic",baseScale:t.baseScale||1,referenceSize:400,topOffset:t.topOffset||0,positionController:t.positionController||null};const i=Math.min(this.canvasManager.width||400,this.canvasManager.height||400);this.scaleFactor=i/this.config.referenceSize*this.config.baseScale,this.state={emotion:"neutral",glowColor:this.config.defaultGlowColor,glowIntensity:1,breathRate:1,breathDepth:this.config.breathingDepth,coreJitter:!1,speaking:!1,recording:!1,sleeping:!1,blinking:!1,blinkingEnabled:!0,gazeOffset:{x:0,y:0},gazeIntensity:0,gazeLocked:!1,gazeTrackingEnabled:!1,gazeTarget:{x:0,y:0},zenVortexIntensity:1,effectiveCenter:{x:0,y:0,scale:1},squintAmount:0,targetSquintAmount:0,scanPhase:0,lastScanTime:0,isSuspicious:!1,customScale:null,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!1,glowRadiusMult:1,breathRateMult:1,breathDepthMult:1,breathIrregular:!1,particleRateMult:1,glowPulse:0,brightnessFlicker:0,brightnessMult:1,saturationMult:1,hueShift:0,manualRotation:0,rotationSpeed:0,lastRotationUpdate:performance.now()},this.animationFrameIds={colorTransition:null,eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.loopCallbackIds={eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.wakeJitterTimeout=null,this.offscreenCanvas=null,this.offscreenCtx=null,this.initOffscreenCanvas(),this.canvas=e.canvas,this.glowCache=new Map,this.maxCacheSize=10,this.gestureAnimations={bounce:{active:!1,startTime:0,progress:0,params:null},pulse:{active:!1,startTime:0,progress:0,params:null},shake:{active:!1,startTime:0,progress:0,params:null},spin:{active:!1,startTime:0,progress:0,params:null},nod:{active:!1,startTime:0,progress:0,params:null},tilt:{active:!1,startTime:0,progress:0,params:null},expand:{active:!1,startTime:0,progress:0,params:null},contract:{active:!1,startTime:0,progress:0,params:null},flash:{active:!1,startTime:0,progress:0,params:null},drift:{active:!1,startTime:0,progress:0,params:null,startX:0,startY:0},stretch:{active:!1,startTime:0,progress:0,params:null},glow:{active:!1,startTime:0,progress:0,params:null},flicker:{active:!1,startTime:0,progress:0,params:null},vibrate:{active:!1,startTime:0,progress:0,params:null},wave:{active:!1,startTime:0,progress:0,params:null},breathe:{active:!1,startTime:0,progress:0,params:null},morph:{active:!1,startTime:0,progress:0,params:null},slowBlink:{active:!1,startTime:0,progress:0,params:null},look:{active:!1,startTime:0,progress:0,params:null,targetX:0,targetY:0},settle:{active:!1,startTime:0,progress:0,params:null},breathIn:{active:!1,startTime:0,progress:0,params:null},breathOut:{active:!1,startTime:0,progress:0,params:null},breathHold:{active:!1,startTime:0,progress:0,params:null},breathHoldEmpty:{active:!1,startTime:0,progress:0,params:null},jump:{active:!1,startTime:0,progress:0,params:null},orbital:{active:!1,startTime:0,progress:0,params:null},hula:{active:!1,startTime:0,progress:0,params:null}},Object.defineProperty(this,"episodicEffects",{get:()=>this.episodicEffectController.getEpisodicEffects(),enumerable:!0}),this.speakingRings=[],this.maxRings=5,this.ringSpawnTimer=0,this.ringSpawnInterval=200,this.recordingRings=[],this.recordingPulse=0,this.sleepZ=[],Object.defineProperty(this,"zenTransition",{get:()=>this.zenModeController.getZenTransition(),enumerable:!0}),this.colorTransition={active:!1,fromColor:this.state.glowColor,toColor:this.state.glowColor,fromIntensity:this.state.glowIntensity,toIntensity:this.state.glowIntensity,progress:0,startTime:0,duration:1500},this.undertoneModifiers={nervous:{hueShift:0,saturationMult:1.05,brightnessMult:1,brightnessFlicker:.05,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!0,glowRadiusMult:1,glowPulse:.05,breathRateMult:1.1,breathDepthMult:.9,breathIrregular:!0},confident:{hueShift:15,saturationMult:1.2,brightnessMult:1.1,sizeMultiplier:1,jitterAmount:0,episodicPowerPose:!0,glowRadiusMult:1.15,breathRateMult:.95,breathDepthMult:1.1,breathIrregular:!1},tired:{hueShift:-5,saturationMult:.7,brightnessMult:.85,sizeMultiplier:.95,jitterAmount:0,episodicMicroSleep:!0,glowRadiusMult:.9,breathRateMult:.8,breathDepthMult:1.2,breathIrregular:!1},intense:{hueShift:5,saturationMult:1.3,brightnessMult:1.15,sizeMultiplier:1,jitterAmount:0,episodicLaserFocus:!0,glowRadiusMult:1.2,breathRateMult:1.2,breathDepthMult:.9,breathIrregular:!1},subdued:{hueShift:-10,saturationMult:.75,brightnessMult:.9,sizeMultiplier:.95,jitterAmount:0,episodicWithdrawal:!0,glowRadiusMult:.85,breathRateMult:.9,breathDepthMult:.9,breathIrregular:!1}},this.lastFrameTime=0,this._createGestureDelegates()}scaleValue(e){return e*this.scaleFactor}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.offscreenCtx,this.updateOffscreenSize()}updateOffscreenSize(){if(this.offscreenCanvas&&this.canvasManager){const{width:e}=this.canvasManager.canvas,{height:t}=this.canvasManager.canvas;if(this.offscreenCanvas.width!==e||this.offscreenCanvas.height!==t){this.offscreenCanvas.width=e,this.offscreenCanvas.height=t;const i=this.canvasManager.canvas.width>this.canvasManager.width;this.offscreenCtx&&(this.offscreenCtx.setTransform(1,0,0,1,0,0),i&&this.canvasManager.dpr&&this.offscreenCtx.scale(this.canvasManager.dpr,this.canvasManager.dpr))}}}updateEffectiveCenter(e){this.state.effectiveCenter=e}getEffectiveCenter(){const e=this.canvasManager.getCenter();let t;return t=this.config.positionController?this.config.positionController.getEffectiveCenter(e.x,e.y):{x:e.x,y:e.y,scale:1},t.x+=this.state.gazeOffset.x,t.y+=this.state.gazeOffset.y,t}render(e,t,i=null){const n=this.renderPerformanceManager.initializeFrame();i=this.transformMerger.mergeAndStoreTransforms(i,t);const{logicalWidth:s,logicalHeight:r,originalCtx:a}=this.canvasSetupManager.setupCanvas();this.canvasSetupManager.performCanvasSetup(s,r,a,t),this.stateUpdateManager.performFrameStateUpdates(t);const o=this.dimensionCalculator.calculateRenderDimensions(s,r,e,i),{scaleMultiplier:c,glowMultiplier:l,gestureTransforms:h,centerX:u,centerY:d}=o;let{rotationAngle:p}=o;const m=this.radiusCalculator.calculateRadii(e,c,l);let{coreRadius:g,glowRadius:f}=m;const{effectiveGlowIntensity:y,sleepOpacityMod:v,glowOpacityMod:b}=m,w=this.positionJitterManager.applyAllModifications(u,d,p,g,f),{coreX:S,coreY:M}=w;({rotationAngle:p,coreRadius:g,glowRadius:f}=w);const x=this.rotationRenderManager.applyRotationTransform(S,M,p);this.effectsRenderManager.renderAllEffects({coreX:S,coreY:M,glowRadius:f,effectiveGlowIntensity:y,glowOpacityMod:b,gestureTransforms:h,coreRadius:g,deltaTime:t}),this.coreShapeRenderManager.renderCoreAndShapes({coreX:S,coreY:M,coreRadius:g,totalRotation:x,sleepOpacityMod:v,deltaTime:t}),this.renderFinalizationManager.finalizeRender({centerX:u,centerY:d,glowRadius:f,deltaTime:t,originalCtx:a,logicalWidth:s,logicalHeight:r,frameStartTime:n})}renderRecordingGlow(e,t,i,n){const s=this.canvas?.width||600,r=this.canvas?.height||600,a=Math.min(i,e-10,t-10,s-e-10,r-t-10),o=Math.max(50,a),c=ni.getRadialGradient(this.ctx,e,t,0,e,t,o,[{offset:0,color:this.hexToRgba("#FF0000",.7*n)},{offset:.3,color:this.hexToRgba("#FF0000",.5*n)},{offset:.6,color:this.hexToRgba("#FF0000",.3*n)},{offset:.85,color:this.hexToRgba("#FF0000",.1*n)},{offset:1,color:this.hexToRgba("#FF0000",0)}]);this.ctx.fillStyle=c,this.ctx.beginPath(),this.ctx.arc(e,t,o,0,2*Math.PI),this.ctx.fill()}renderDropShadow(e,t,i,n){const{ctx:s}=this,r=this.shapeMorpher&&this.shapeMorpher.isTransitioning;if(!(this.shapeMorpher&&(this.shapeMorpher.audioDeformation>.1||this.shapeMorpher.vocalEnergy>.1)||r&&!(this.shapeMorpher.morphProgress>.8))){s.save(),s.translate(e,t);const r=this.scaleValue(2);if(s.translate(0,r),n&&n.length>32)s.fillStyle="rgba(0, 0, 0, 0.15)",s.beginPath(),s.arc(0,0,1.05*i,0,2*Math.PI),s.fill();else{const e=s.createRadialGradient(0,0,.7*i,0,0,1.2*i);if(e.addColorStop(0,"rgba(0, 0, 0, 0.2)"),e.addColorStop(.8,"rgba(0, 0, 0, 0.1)"),e.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=e,s.beginPath(),n){const e=1.1,t=n.length>20?2:1;s.moveTo(n[0].x*e,n[0].y*e);for(let i=t;i<n.length;i+=t)s.lineTo(n[i].x*e,n[i].y*e);s.closePath()}else s.arc(0,0,1.1*i,0,2*Math.PI);s.fill()}s.restore()}}renderSunEffects(e,t,i,n){return this.celestialRenderer.renderSunEffects(this.ctx,e,t,i,n)}renderBaileysBeads(e,t,i,n,s,r,a,o){return this.celestialRenderer.renderBaileysBeads(this.ctx,e,t,i,n,s,r,a,o,this.scaleValue.bind(this))}renderMoonShadow(e,t,i,n,s,r=!1,a=0){return this.celestialRenderer.renderMoonShadow(this.ctx,e,t,i,n,s,r,a,this.shapeMorpher)}renderZenCore(e,t,i){return this.zenModeRenderer.renderZenCore(this.ctx,e,t,i,this.state,this.zenTransition,this.gestureTransform,this.scaleValue.bind(this))}renderSpeakingRings(e,t,i,n){return this.specialEffects.renderSpeakingRings(e,t,i,n)}renderRecordingIndicator(e,t){return this.specialEffects.renderRecordingIndicator(e,t)}renderSleepIndicator(e,t,i){return this.sleepManager.renderSleepIndicator(e,t,i)}updateTimers(e){this.timerCoordinator.updateTimers(e)}applyUndertoneModifiers(e){this.emotionalStateManager.applyUndertoneModifiers(e)}applyUndertoneToColor(e,t){return this.colorUtilities.applyUndertoneToColor(e,t)}hexToRgb(e){return this.colorUtilities.hexToRgb(e)}rgbToHsl(e,t,i){return this.colorUtilities.rgbToHsl(e,t,i)}hslToHex(e,t,i){return this.colorUtilities.hslToHex(e,t,i)}hexToRgba(e,t=1){const i=this.hexToRgb(e);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${t})`:`rgba(255, 255, 255, ${t})`}startColorTransition(e,t,i=1500){this.colorUtilities.currentColor=this.state.glowColor,this.colorUtilities.currentIntensity=this.state.glowIntensity,this.colorUtilities.startColorTransition(e,t,i),this.colorTransition=this.colorUtilities.colorTransition}updateColorTransition(e){const t=this.colorUtilities.updateColorTransition(e);t&&(this.state.glowColor=t.color,this.state.glowIntensity=t.intensity,this.colorTransition=this.colorUtilities.colorTransition)}updateUndertone(e){this.emotionalStateManager.updateUndertone(e)}setEmotionalState(e,t,i=null){this.emotionalStateManager.setEmotionalState(e,t,i)}setBPM(e){}setRotationSpeed(e){this.rotationManager.setRotationSpeed(e)}setRotationAngle(e){this.rotationManager.setRotationAngle(e)}setGazeOffset(e){this.gazeInputHandler.setGazeOffset(e)}getCurrentOrbPosition(){return this.gazeInputHandler.getCurrentOrbPosition()}setCustomScale(e){this.state.customScale=e}startSpeaking(){this.state.speaking=!0,this.speakingRings=[],this.ringSpawnTimer=0}stopSpeaking(){this.state.speaking=!1,this.speakingRings=[]}enterSleepMode(){this.sleepManager.enterSleepMode()}wakeUp(){this.sleepManager.wakeUp()}enterZenMode(e,t){this.zenModeController.enterZenMode(e,t)}exitZenMode(e,t,i){this.zenModeController.exitZenMode(e,t,i)}startRecording(){this.state.recording=!0}stopRecording(){this.state.recording=!1}setBlinkingEnabled(e){this.state.blinkingEnabled=e,e||(this.state.blinking=!1,this.eyeRenderer.blinking=!1,this.eyeRenderer.blinkTimer=0)}setGazeTracking(e){this.gazeTracker.setEnabled(e)}initGazeTracking(){this.gazeTracker.initialize()}cleanupGazeTracking(){this.gazeTracker.cleanup()}resetCanvasContext(){this.canvasContextManager.resetCanvasContext()}setQualityLevel(e){this.canvasContextManager.setQualityLevel(e)}setQualityReduction(e){this.canvasContextManager.setQualityReduction(e)}handleContextRecovery(e){this.canvasContextManager.handleContextRecovery(e)}getUndertoneModifier(){return this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers?this.stateMachine.getWeightedUndertoneModifiers():this.currentUndertone&&this.undertoneModifiers[this.currentUndertone]?this.undertoneModifiers[this.currentUndertone]:null}applyGestureAnimations(){return this.gestureAnimator.applyGestureAnimations()}startGesture(e){return this.gestureAnimator.startGesture(e)}getCurrentGesture(){return this.gestureAnimator.getCurrentGesture()}_createGestureDelegates(){["Bounce","Pulse","Shake","Spin","Nod","Tilt","Expand","Contract","Flash","Drift","Stretch","Glow","Flicker","Vibrate","Orbital","Hula","Wave","Breathe","Morph","SlowBlink","Look","Settle","BreathIn","BreathOut","BreathHold","BreathHoldEmpty","Jump","Sway","Float","Rain","RunningMan","Charleston","Sparkle","Shimmer","Wiggle","Groove","Point","Lean","Reach","HeadBob","Orbit"].forEach(e=>{const t=`start${e}`;this[t]=()=>this.gestureAnimator[t]()})}startGrooveSway(e){this.ambientDanceAnimator.startAmbientAnimation("grooveSway",e)}startGrooveBob(e){this.ambientDanceAnimator.startAmbientAnimation("grooveBob",e)}startGrooveFlow(e){this.ambientDanceAnimator.startAmbientAnimation("grooveFlow",e)}startGroovePulse(e){this.ambientDanceAnimator.startAmbientAnimation("groovePulse",e)}startGrooveStep(e){this.ambientDanceAnimator.startAmbientAnimation("grooveStep",e)}stopAllGestures(){this.gestureAnimator.stopAllGestures(),this.currentGesture=null}isGestureActive(){return Object.values(this.gestureAnimator.gestureAnimations).some(e=>e.active)}destroy(){this.resourceCleanupManager.destroy()}}class Fi{constructor(e,t={}){this.canvas=e,this.config={smoothing:t.smoothing||.1,maxOffset:t.maxOffset||.3,lockDistance:t.lockDistance||30,enabled:!1!==t.enabled,boundaryPadding:t.boundaryPadding||.8},this.canvasCenter={x:0,y:0},this.mousePos={x:0,y:0},this.targetGaze={x:0,y:0},this.currentGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.cachedRect=null,this.touches=new Map,this.primaryTouch=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.onInteraction=null,this.updateCanvasCenter(),this.attachEventListeners(),"undefined"!=typeof ResizeObserver&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCanvasCenter()}),this.resizeObserver.observe(this.canvas))}updateCanvasCenter(){this.cachedRect=this.canvas.getBoundingClientRect(),this.canvasCenter={x:this.cachedRect.width/2,y:this.cachedRect.height/2},0===this.mousePos.x&&0===this.mousePos.y&&(this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y})}attachEventListeners(){this.config.enabled&&(this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseleave",this.handleMouseLeave),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!0}),this.canvas.addEventListener("touchcancel",this.handleTouchEnd,{passive:!0}))}handleMouseMove(e){const t=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:e.clientX-t.left,y:e.clientY-t.top},this.updateTargetGaze(),this.onInteraction&&this.onInteraction("mouse")}handleMouseLeave(){this.targetGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y}}handleTouchStart(e){for(const t of e.changedTouches)this.touches.set(t.identifier,{x:t.clientX,y:t.clientY}),this.primaryTouch||1!==this.touches.size||(this.primaryTouch=t.identifier);null!==this.primaryTouch&&this.updateTouchPosition(e.touches)}handleTouchMove(e){for(const t of e.changedTouches)this.touches.has(t.identifier)&&this.touches.set(t.identifier,{x:t.clientX,y:t.clientY});null!==this.primaryTouch&&(this.updateTouchPosition(e.touches),this.onInteraction&&this.onInteraction("touch"))}handleTouchEnd(e){for(const t of e.changedTouches)this.touches.delete(t.identifier),t.identifier===this.primaryTouch&&(this.primaryTouch=null,this.touches.size>0?this.primaryTouch=this.touches.keys().next().value:this.handleMouseLeave())}updateTouchPosition(e){for(const t of e)if(t.identifier===this.primaryTouch){const e=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:t.clientX-e.left,y:t.clientY-e.top},this.updateTargetGaze();break}}updateTargetGaze(){const e=this.mousePos.x-this.canvasCenter.x,t=this.mousePos.y-this.canvasCenter.y,i=Math.sqrt(e*e+t*t),n=Math.min(this.canvasCenter.x,this.canvasCenter.y);if(this.proximity=Math.max(0,1-i/n),this.isLocked=i<this.config.lockDistance,this.isLocked)this.targetGaze={x:e*this.config.maxOffset*2,y:t*this.config.maxOffset*2};else{const s=Math.min(this.canvasCenter.x,this.canvasCenter.y)*this.config.maxOffset;if(i>0){const r=Math.min(1,i/n);this.targetGaze={x:e/i*s*r*this.config.boundaryPadding,y:t/i*s*r*this.config.boundaryPadding}}else this.targetGaze={x:0,y:0}}}update(e){if(!this.config.enabled)return;const t=1-Math.pow(1-this.config.smoothing,e/16.67);if(this.currentGaze.x+=(this.targetGaze.x-this.currentGaze.x)*t,this.currentGaze.y+=(this.targetGaze.y-this.currentGaze.y)*t,this.isLocked){const e=.5;this.currentGaze.x+=(Math.random()-.5)*e,this.currentGaze.y+=(Math.random()-.5)*e}}getGazeOffset(e){return{x:this.currentGaze.x,y:this.currentGaze.y}}getState(){return{gaze:{...this.currentGaze},target:{...this.targetGaze},proximity:this.proximity,isLocked:this.isLocked,isActive:this.config.enabled}}enable(){this.config.enabled||(this.config.enabled=!0,this.attachEventListeners())}disable(){this.config.enabled&&(this.config.enabled=!1,this.detachEventListeners(),this.targetGaze={x:0,y:0})}detachEventListeners(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseleave",this.handleMouseLeave),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("touchcancel",this.handleTouchEnd)}setInteractionCallback(e){this.onInteraction=e}destroy(){this.detachEventListeners(),this.resizeObserver&&this.resizeObserver.disconnect(),this.touches.clear()}}class Li{constructor(e={}){this.config={blinkInterval:e.blinkInterval||{min:3e3,max:7e3},blinkDuration:e.blinkDuration||150,swayInterval:e.swayInterval||{min:2e4,max:4e4},swayDuration:e.swayDuration||4e3,swayIntensity:e.swayIntensity||1.5,sleepTimeout:void 0!==e.sleepTimeout?e.sleepTimeout:1/0,breathingSpeed:e.breathingSpeed||.25,breathingDepth:e.breathingDepth||.1,enabled:!1!==e.enabled},this.state={isBlinking:!1,isSwaying:!1,isAsleep:!1,breathingPhase:0,breathRate:1,breathDepth:this.config.breathingDepth},this.timers={idle:0,blink:0,sway:0,swayProgress:0,nextBlink:this.getRandomInterval("blink"),nextSway:this.getRandomInterval("sway")},this.swayOffset={x:0,y:0},this.swayTarget={x:0,y:0},this.swayStart={x:0,y:0},this.wakeUpTimeout=null,this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}update(e){this.config.enabled&&(this.updateBreathing(e),this.timers.idle+=e,!this.state.isAsleep&&this.timers.idle>=this.config.sleepTimeout&&this.enterSleep(),this.state.isAsleep||this.updateBlinking(e),this.state.isAsleep||this.updateSwaying(e))}updateBreathing(e){const t=this.config.breathingSpeed*this.state.breathRate;this.state.breathingPhase+=t*e/1e3,this.state.breathingPhase>2*Math.PI&&(this.state.breathingPhase-=2*Math.PI)}updateBlinking(e){this.isBlinkingEnabled()&&(this.state.isBlinking?(this.timers.blink+=e,this.timers.blink>=this.config.blinkDuration&&this.endBlink()):(this.timers.blink+=e,this.timers.blink>=this.timers.nextBlink&&this.startBlink()))}updateSwaying(e){if(this.state.isSwaying){this.timers.sway+=e;const t=Math.min(this.timers.sway/this.config.swayDuration,1),i=(Math.sin((t-.5)*Math.PI)+1)/2;this.swayOffset.x=this.swayStart.x+(this.swayTarget.x-this.swayStart.x)*i,this.swayOffset.y=this.swayStart.y+(this.swayTarget.y-this.swayStart.y)*i,t>=1&&this.endSway()}else this.timers.sway+=e,this.timers.sway>=this.timers.nextSway&&this.startSway()}startBlink(){this.state.isBlinking=!0,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"start"})}endBlink(){this.state.isBlinking=!1,this.timers.blink=0,this.timers.nextBlink=this.getRandomInterval("blink"),this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})}startSway(){this.state.isSwaying=!0,this.timers.sway=0,this.swayStart={...this.swayOffset};const e=Math.random()*Math.PI*2,t=this.config.swayIntensity*(.5+.5*Math.random());this.swayTarget={x:Math.cos(e)*t*1.5,y:Math.sin(e)*t*.5},this.callbacks.onSway&&this.callbacks.onSway({phase:"start",offset:this.swayOffset})}endSway(){this.state.isSwaying=!1,this.timers.sway=0,this.timers.nextSway=this.getRandomInterval("sway"),this.swayStart={...this.swayOffset},this.callbacks.onSway&&this.callbacks.onSway({phase:"end",offset:this.swayOffset})}enterSleep(){this.state.isAsleep=!0,this.state.breathRate=.5,this.state.breathDepth=.15,this.state.isBlinking&&(this.state.isBlinking=!1,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})),this.callbacks.onSleep&&this.callbacks.onSleep()}wakeUp(){this.state.isAsleep&&(this.state.isAsleep=!1,this.state.breathRate=1,this.state.breathDepth=this.config.breathingDepth,this.timers.idle=0,this.callbacks.onWake&&this.callbacks.onWake(),this.performWakeAnimation())}performWakeAnimation(){const e={x:.5*this.config.swayIntensity,y:-this.config.swayIntensity};this.swayStart={...this.swayOffset},this.swayTarget=e,this.state.isSwaying=!0,this.timers.sway=0,this.callbacks.onSway&&this.callbacks.onSway({phase:"wake",offset:this.swayOffset}),this.wakeUpTimeout&&clearTimeout(this.wakeUpTimeout),this.wakeUpTimeout=setTimeout(()=>{this.swayStart={...this.swayOffset},this.swayTarget={x:0,y:0},this.timers.sway=0,this.wakeUpTimeout=null},1e3)}resetIdleTimer(){this.timers.idle=0,this.state.isAsleep&&this.wakeUp()}setBlinkingEnabled(e){this.config.blinkingEnabled=e,!e&&this.state.isBlinking&&this.endBlink()}isBlinkingEnabled(){return!1!==this.config.blinkingEnabled}getBreathingFactor(){return 1+Math.sin(this.state.breathingPhase)*this.state.breathDepth*this.state.breathRate}getBlinkProgress(){return this.state.isBlinking?Math.min(this.timers.blink/this.config.blinkDuration,1):0}getSwayOffset(){return this.swayOffset||{x:0,y:0}}getRandomInterval(e){const t=this.config[`${e}Interval`];return t.min+Math.random()*(t.max-t.min)}setCallback(e,t){({}).hasOwnProperty.call(this.callbacks,e)&&(this.callbacks[e]=t)}getState(){return{...this.state,breathingFactor:this.getBreathingFactor(),blinkProgress:this.getBlinkProgress(),swayOffset:this.getSwayOffset()}}enable(){this.config.enabled=!0}disable(){this.config.enabled=!1,this.state.isBlinking=!1,this.state.isSwaying=!1,this.swayOffset={x:0,y:0}}destroy(){this.wakeUpTimeout&&(clearTimeout(this.wakeUpTimeout),this.wakeUpTimeout=null),this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}}class qi{constructor(e){this.positionController=e,this.watchedElements=new Map,this.updateCallbacks=new Map}moveToElement(e,t="right",i={x:20,y:0},n={}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=s.getBoundingClientRect(),a=r.left+r.width/2,o=r.top+r.height/2;let c,l;switch(t){case"right":default:c=r.right+i.x,l=o+i.y;break;case"left":c=r.left-i.x,l=o+i.y;break;case"above":c=a+i.x,l=r.top-i.y;break;case"below":c=a+i.x,l=r.bottom+i.y;break;case"center":c=a+i.x,l=o+i.y}const h=c-window.innerWidth/2,u=l-window.innerHeight/2;!1!==n.animate?this.positionController.animateOffset(h,u,0,n.duration||1e3,n.easing||"easeOutCubic"):this.positionController.setOffset(h,u,0)}moveToButton(e="button",t="right",i={x:20,y:0}){this.moveToElement(e,t,i)}moveToForm(e="form",t="right",i={x:20,y:0}){this.moveToElement(e,t,i)}moveToModal(e='[role="dialog"], .modal',t="center",i={x:0,y:0}){this.moveToElement(e,t,i)}moveToNavigation(e="nav, .navigation",t="below",i={x:0,y:20}){this.moveToElement(e,t,i)}moveToContent(e="main, .content",t="center",i={x:0,y:0}){this.moveToElement(e,t,i)}moveToSidebar(e=".sidebar, aside",t="right",i={x:20,y:0}){this.moveToElement(e,t,i)}moveToHeader(e="header, .header",t="below",i={x:0,y:20}){this.moveToElement(e,t,i)}moveToFooter(e="footer, .footer",t="above",i={x:0,y:20}){this.moveToElement(e,t,i)}watchElement(e,t="right",i={x:20,y:0}){const n=()=>{this.moveToElement(e,t,i,{animate:!1})},s=`${e}-${t}-${JSON.stringify(i)}`;return this.updateCallbacks.set(s,n),window.addEventListener("scroll",n),window.addEventListener("resize",n),n(),()=>{window.removeEventListener("scroll",n),window.removeEventListener("resize",n),this.updateCallbacks.delete(s)}}stopWatchingAll(){this.updateCallbacks.forEach(e=>{window.removeEventListener("scroll",e),window.removeEventListener("resize",e)}),this.updateCallbacks.clear()}destroy(){this.stopWatchingAll(),this.positionController=null}}class Gi extends qi{constructor(e){super(e),this.activeCallbacks=new Map,this.callbackStates=new Map}moveToElementWithCallback(e,t,i="right",n={x:20,y:0},s={}){const r=`callback-${Date.now()}-${Math.random()}`,a=document.querySelector(e);if(!a)return void console.warn(`Element not found: ${e}`);this.callbackStates.set(r,{executed:!1,element:a,callback:t,options:s}),this.moveToElement(e,i,n,s);const o=()=>{if(this.isMascotNearElement(a,s.proximity||50)){const e=this.callbackStates.get(r);e&&!e.executed&&(e.executed=!0,t(),s.repeat||this.callbackStates.delete(r))}this.callbackStates.has(r)&&requestAnimationFrame(o)};return this.activeCallbacks.set(r,o),o(),()=>{this.activeCallbacks.delete(r),this.callbackStates.delete(r)}}moveToElementSequence(e=[],t={}){let i=0;const n=[],s=()=>{if(i>=e.length)return void(t.onComplete&&t.onComplete());const r=e[i],a=this.moveToElementWithCallback(r.selector,()=>{r.callback&&r.callback(),i++,setTimeout(s,r.delay||0)},r.position||"right",r.offset||{x:20,y:0},{...t,...r.options});a&&n.push(a)};return s(),()=>{n.forEach(e=>e())}}moveToElementWithDelay(e,t,i=1e3,n="right",s={x:20,y:0}){return this.moveToElementWithCallback(e,()=>{setTimeout(t,i)},n,s)}moveToElementWithCondition(e,t,i,n="right",s={x:20,y:0}){return this.moveToElementWithCallback(e,()=>{t()&&i()},n,s)}moveToElementWithRepeat(e,t,i=1e3,n="right",s={x:20,y:0}){return this.moveToElementWithCallback(e,()=>{setInterval(t,i)},n,s,{repeat:!0})}moveToElementWithProximity(e,t,i=100,n="right",s={x:20,y:0}){return this.moveToElementWithCallback(e,t,n,s,{proximity:i})}isMascotNearElement(e,t=50){if(!this.positionController||!e)return!1;const i=e.getBoundingClientRect(),n=i.left+i.width/2,s=i.top+i.height/2,r=this.positionController.getOffset(),a=r.x+window.innerWidth/2,o=r.y+window.innerHeight/2;return Math.sqrt(Math.pow(a-n,2)+Math.pow(o-s,2))<=t}stopAllCallbacks(){this.activeCallbacks.forEach((e,t)=>{this.activeCallbacks.delete(t)}),this.callbackStates.clear()}destroy(){this.stopAllCallbacks(),super.destroy()}}class $i extends qi{constructor(e){super(e),this.activePaths=new Map,this.obstacles=new Set,this.audioContext=null,this.audioAnalyser=null,this.gazeTracker=null,this.activeRAFIds=new Set,this.activeSmoothAnimations=new Set}moveToElementWithPath(e,t=[],i="right",n={x:20,y:0},s={}){const r=`path-${Date.now()}-${Math.random()}`,a=document.querySelector(e);if(!a)return void console.warn(`Element not found: ${e}`);const o=window.innerWidth||1,c=window.innerHeight||1,l=o/2,h=c/2,u=s.coordinateSystem||"auto",d=Array.isArray(t)?t.map((e={})=>{const t="number"==typeof e.x?e.x:0,i="number"==typeof e.y?e.y:0;return"relative"===u||"auto"===u&&t>=0&&t<=1&&i>=0&&i<=1?{x:t*o-l,y:i*c-h}:"offset"===u||"auto"===u&&Math.abs(t)<=l&&Math.abs(i)<=h?{x:t,y:i}:{x:t-l,y:i-h}}):[],p=a.getBoundingClientRect(),m={x:p.left+p.width/2+n.x-l,y:p.top+p.height/2+n.y-h},g=this.positionController.getOffset?this.positionController.getOffset():{x:0,y:0},f=[{x:"number"==typeof g.x?g.x:0,y:"number"==typeof g.y?g.y:0},...d,m];if(f.length<2)return this.positionController.setOffset(m.x,m.y,0),void("function"==typeof s.onComplete&&s.onComplete());const y=[],v=[0];let b=0;for(let e=0;e<f.length-1;e++){const t=f[e+1].x-f[e].x,i=f[e+1].y-f[e].y,n=Math.hypot(t,i);y.push(n),b+=n,v.push(b)}if(0===b)return this.positionController.setOffset(m.x,m.y,0),void("function"==typeof s.onComplete&&s.onComplete());const w="number"==typeof s.speed&&s.speed>0?s.speed:250,S=!0===s.loop,M=s.easing||"linear",x={covered:0,lastTimestamp:null},C=e=>{if(S)e%=b;else{if(e<=0)return f[0];if(e>=b)return f[f.length-1]}for(let t=0;t<y.length;t++){const i=v[t];if(e<=v[t+1]){const n=y[t]||1,s=0===n?0:(e-i)/n,r=this.positionController&&"function"==typeof this.positionController.applyEasing?this.positionController.applyEasing(s,M):s,a=f[t],o=f[t+1];return{x:a.x+(o.x-a.x)*r,y:a.y+(o.y-a.y)*r}}}return f[f.length-1]},T={stop:()=>{T.frameId&&cancelAnimationFrame(T.frameId),this.activePaths.delete(r)},frameId:null};this.activePaths.set(r,T),this.positionController.setOffset(f[0].x,f[0].y,0);const k=e=>{if(!this.activePaths.has(r))return;null===x.lastTimestamp&&(x.lastTimestamp=e);const t=e-x.lastTimestamp;if(x.lastTimestamp=e,x.covered+=w*(t/1e3),!S&&x.covered>=b)return this.positionController.setOffset(m.x,m.y,0),T.stop(),void("function"==typeof s.onComplete&&s.onComplete());const i=C(x.covered);this.positionController.setOffset(i.x,i.y,0),T.frameId=requestAnimationFrame(k)};return T.frameId=requestAnimationFrame(k),()=>{T.stop()}}moveToElementWithEasing(e,t,i=1e3,n="right",s={x:20,y:0}){const r=document.querySelector(e);if(!r)return void console.warn(`Element not found: ${e}`);const a=r.getBoundingClientRect(),o=a.left+a.width/2+s.x-window.innerWidth/2,c=a.top+a.height/2+s.y-window.innerHeight/2,l=this.positionController.getOffset(),h=performance.now();let u=null;const d=e=>{const n=e-h,s=Math.min(n/i,1),r=t(s),a=l.x+(o-l.x)*r,p=l.y+(c-l.y)*r;this.positionController.setOffset(a,p,0),s<1?(u=requestAnimationFrame(d),this.activeSmoothAnimations.add(u)):null!==u&&this.activeSmoothAnimations.delete(u)};u=requestAnimationFrame(d),this.activeSmoothAnimations.add(u)}moveToElementWithCollision(e,t=[],i=100,n="right",s={x:20,y:0}){const r=document.querySelector(e);if(!r)return void console.warn(`Element not found: ${e}`);const a=r.getBoundingClientRect(),o=a.left+a.width/2+s.x-window.innerWidth/2,c=a.top+a.height/2+s.y-window.innerHeight/2,l=this.positionController.getOffset();(()=>{let e=l.x,n=l.y;for(let s=0;s<=100;s++){const r=.01*s,a=l.x+(o-l.x)*r,h=l.y+(c-l.y)*r;let u=!1;t.forEach(t=>{let s,r;if("string"==typeof t){const e=document.querySelector(t);if(!e)return;{const t=e.getBoundingClientRect();s=t.left+t.width/2-window.innerWidth/2,r=t.top+t.height/2-window.innerHeight/2}}else s=t.x-window.innerWidth/2,r=t.y-window.innerHeight/2;if(Math.sqrt(Math.pow(a-s,2)+Math.pow(h-r,2))<i){u=!0;const t=Math.atan2(h-r,a-s),o=s+Math.cos(t)*i,c=r+Math.sin(t)*i;e=o,n=c}}),u||(e=a,n=h)}this.positionController.setOffset(e,n,0)})()}moveToElementWithAudio(e,t,i=50,n="right",s={x:20,y:0}){const r=document.querySelector(e);if(!r)return void console.warn(`Element not found: ${e}`);this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=256),this.audioContext.createMediaStreamSource(t).connect(this.audioAnalyser);const a=new Uint8Array(this.audioAnalyser.frequencyBinCount),o=r.getBoundingClientRect(),c=o.left+o.width/2+s.x-window.innerWidth/2,l=o.top+o.height/2+s.y-window.innerHeight/2;let h=null;const u=()=>{this.audioAnalyser.getByteFrequencyData(a);let e=0;for(let t=0;t<a.length;t++)e+=a[t];const t=e/a.length/255*i,n=c+t,s=l+.5*t;this.positionController.setOffset(n,s,0),null!==h&&this.activeRAFIds.delete(h),h=requestAnimationFrame(u),this.activeRAFIds.add(h)};u()}moveToElementWithGaze(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);this.gazeTracker||(this.gazeTracker={x:window.innerWidth/2,y:window.innerHeight/2});const r=s.getBoundingClientRect(),a=r.left+r.width/2+n.x-window.innerWidth/2,o=r.top+r.height/2+n.y-window.innerHeight/2;let c=null;const l=()=>{const e=this.gazeTracker.x-window.innerWidth/2,i=this.gazeTracker.y-window.innerHeight/2,n=t.gazeWeight||.3,s=a+(e-a)*n,r=o+(i-o)*n;this.positionController.setOffset(s,r,0),null!==c&&this.activeRAFIds.delete(c),c=requestAnimationFrame(l),this.activeRAFIds.add(c)};l()}addObstacle(e){this.obstacles.add(e)}removeObstacle(e){this.obstacles.delete(e)}clearObstacles(){this.obstacles.clear()}destroy(){Array.from(this.activePaths.values()).forEach(e=>{e&&"function"==typeof e.stop?e.stop():e&&e.frameId&&cancelAnimationFrame(e.frameId)}),this.activePaths.clear(),this.activeRAFIds.forEach(e=>{cancelAnimationFrame(e)}),this.activeRAFIds.clear(),this.activeSmoothAnimations.forEach(e=>{cancelAnimationFrame(e)}),this.activeSmoothAnimations.clear(),this.obstacles.clear(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioAnalyser=null,this.gazeTracker=null,super.destroy()}}class Hi extends qi{constructor(e){super(e),this.scrollCallbacks=new Map,this.physicsSimulations=new Map,this.responsiveBreakpoints={mobile:768,tablet:1024,desktop:1200},this.currentBreakpoint=this.getCurrentBreakpoint(),this.accessibilityEnabled=!1}moveToElementWithScroll(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`scroll-${Date.now()}-${Math.random()}`,{startScroll:a=50,endScroll:o=300,onProgress:c=null,onStart:l=null,onComplete:h=null}=t;let u=!1,d=!1;const p=()=>{const{scrollY:e}=window,t=Math.min(Math.max((e-a)/(o-a),0),1);t>0&&!u&&(u=!0,l&&l()),t>=1&&!d&&(d=!0,h&&h());const i=s.getBoundingClientRect(),r=i.left+i.width/2+n.x-window.innerWidth/2,p=i.top+i.height/2+n.y-window.innerHeight/2,m=window.innerWidth>1024,g=m?.25*window.innerWidth:.33*window.innerWidth-50,f=m?-.25*window.innerHeight-50+.15*window.innerHeight:-.35*window.innerHeight-50+.08*window.innerHeight,y=g+(r-g)*t,v=f+(p-f)*t;this.positionController.setOffset(y,v,0),c&&c(t,{scrollY:e,currentX:y,currentY:v})};return this.scrollCallbacks.set(r,p),window.addEventListener("scroll",p),p(),()=>{this.scrollCallbacks.delete(r),window.removeEventListener("scroll",p)}}moveToElementWithPhysics(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`physics-${Date.now()}-${Math.random()}`,{mass:a=1,damping:o=.98,springConstant:c=.1,maxVelocity:l=10,onUpdate:h=null}=t,u=s.getBoundingClientRect(),d=u.left+u.width/2+n.x-window.innerWidth/2,p=u.top+u.height/2+n.y-window.innerHeight/2,m=this.positionController.getOffset();let g=m.x,f=m.y,y=0,v=0;const b=()=>{y+=(d-g)*c/a,v+=(p-f)*c/a,y*=o,v*=o;const e=Math.sqrt(y*y+v*v);e>l&&(y=y/e*l,v=v/e*l),g+=y,f+=v,this.positionController.setOffset(g,f,0),h&&h({positionX:g,positionY:f,velocityX:y,velocityY:v}),this.physicsSimulations.has(r)&&requestAnimationFrame(b)};return this.physicsSimulations.set(r,b),b(),()=>{this.physicsSimulations.delete(r)}}moveToElementWithGroup(e=[],t="center",i={x:0,y:0}){if(0===e.length)return void console.warn("No element selectors provided");let n=0,s=0,r=0,a=0,o=0;if(e.forEach(e=>{const t=document.querySelector(e);if(t){const e=t.getBoundingClientRect();n+=e.left,s+=e.top,r=Math.max(r,e.left+e.width),a=Math.max(a,e.top+e.height),o++}}),0===o)return;const c=n/o,l=s/o;let h,u;switch(t){case"center":default:h=c+i.x-window.innerWidth/2,u=l+i.y-window.innerHeight/2;break;case"left":h=n+i.x-window.innerWidth/2,u=l+i.y-window.innerHeight/2;break;case"right":h=r+i.x-window.innerWidth/2,u=l+i.y-window.innerHeight/2;break;case"top":h=c+i.x-window.innerWidth/2,u=s+i.y-window.innerHeight/2;break;case"bottom":h=c+i.x-window.innerWidth/2,u=a+i.y-window.innerHeight/2}this.positionController.setOffset(h,u,0)}moveToElementWithResponsive(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=()=>{const e=this.getCurrentBreakpoint(),i=t[e]||t.default||{},r=s.getBoundingClientRect(),a=r.left+r.width/2+(i.offsetX||n.x)-window.innerWidth/2,o=r.top+r.height/2+(i.offsetY||n.y)-window.innerHeight/2;this.positionController.setOffset(a,o,0)},a=()=>{const e=this.getCurrentBreakpoint();e!==this.currentBreakpoint&&(this.currentBreakpoint=e,r())};return window.addEventListener("resize",a),r(),()=>{window.removeEventListener("resize",a)}}moveToElementWithAccessibility(e,t={},i="right",n={x:20,y:0}){if(!document.querySelector(e))return void console.warn(`Element not found: ${e}`);const{announce:s=!0,announcements:r=[],screenReaderPosition:a="bottom-right"}=t;let o,c;switch(a){case"bottom-right":default:o=window.innerWidth-100-window.innerWidth/2,c=window.innerHeight-100-window.innerHeight/2;break;case"bottom-left":o=100-window.innerWidth/2,c=window.innerHeight-100-window.innerHeight/2;break;case"top-right":o=window.innerWidth-100-window.innerWidth/2,c=100-window.innerHeight/2;break;case"top-left":o=100-window.innerWidth/2,c=100-window.innerHeight/2}this.positionController.setOffset(o,c,0),s&&window.speechSynthesis&&r.forEach(e=>{if(e.condition&&e.condition()){const t=new SpeechSynthesisUtterance(e.text);t.volume=.5,t.rate=.8,window.speechSynthesis.speak(t)}})}getCurrentBreakpoint(){const e=window.innerWidth;return e<this.responsiveBreakpoints.mobile?"mobile":e<this.responsiveBreakpoints.tablet?"tablet":e<this.responsiveBreakpoints.desktop?"desktop":"large"}setBreakpoints(e){this.responsiveBreakpoints={...this.responsiveBreakpoints,...e},this.currentBreakpoint=this.getCurrentBreakpoint()}enableAccessibility(){this.accessibilityEnabled=!0}disableAccessibility(){this.accessibilityEnabled=!1}destroy(){this.scrollCallbacks.forEach((e,t)=>{window.removeEventListener("scroll",e)}),this.scrollCallbacks.clear(),this.physicsSimulations.clear(),super.destroy()}}class ji extends qi{constructor(e){super(e),this.activeInteractions=new Map,this.hoverStates=new Map,this.clickStates=new Map,this.touchStates=new Map}moveToElementWithHover(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`hover-${Date.now()}-${Math.random()}`,{onMouseEnter:a=null,onMouseLeave:o=null,onHover:c=null,followMouse:l=!1,hoverDistance:h=50}=t;let u=!1,d=0,p=0;const m=e=>{u=!0,a&&a(e)},g=e=>{u=!1,o&&o(e)},f=e=>{if(d=e.clientX,p=e.clientY,u&&c&&c(e),l&&u){const e=s.getBoundingClientRect(),t=e.left+e.width/2,i=e.top+e.height/2;if(Math.sqrt(Math.pow(d-t,2)+Math.pow(p-i,2))<=h){const e=d+n.x-window.innerWidth/2,t=p+n.y-window.innerHeight/2;this.positionController.setOffset(e,t,0)}}};return s.addEventListener("mouseenter",m),s.addEventListener("mouseleave",g),s.addEventListener("mousemove",f),this.activeInteractions.set(r,{element:s,events:[{event:"mouseenter",handler:m},{event:"mouseleave",handler:g},{event:"mousemove",handler:f}]}),()=>{const e=this.activeInteractions.get(r);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(r))}}moveToElementWithClick(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`click-${Date.now()}-${Math.random()}`,{onClick:a=null,onDoubleClick:o=null,maxClicks:c=3}=t;let l=0;const h=e=>{if(l++,a&&a(e,l),l>=c){const e=s.getBoundingClientRect(),t=e.left+e.width/2+n.x-window.innerWidth/2,i=e.top+e.height/2+n.y-window.innerHeight/2;this.positionController.setOffset(t,i,0)}},u=e=>{o&&o(e)};return s.addEventListener("click",h),s.addEventListener("dblclick",u),this.activeInteractions.set(r,{element:s,events:[{event:"click",handler:h},{event:"dblclick",handler:u}]}),()=>{const e=this.activeInteractions.get(r);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(r))}}moveToElementWithTouch(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`touch-${Date.now()}-${Math.random()}`,{onTouchStart:a=null,onTouchMove:o=null,onTouchEnd:c=null,onSwipe:l=null,swipeThreshold:h=50}=t;let u=0,d=0,p=0,m=0;const g=e=>{e.touches.length>0&&(u=e.touches[0].clientX,d=e.touches[0].clientY,a&&a(e))},f=e=>{if(e.touches.length>0){const t=e.touches[0].clientX,i=e.touches[0].clientY;o&&o(e);const s=t+n.x-window.innerWidth/2,r=i+n.y-window.innerHeight/2;this.positionController.setOffset(s,r,0)}},y=e=>{if(e.changedTouches.length>0){p=e.changedTouches[0].clientX,m=e.changedTouches[0].clientY,c&&c(e);const t=p-u,i=m-d,n=Math.sqrt(t*t+i*i);if(n>h&&l){const e=Math.abs(t)>Math.abs(i)?t>0?"right":"left":i>0?"down":"up";l(e,n)}}};return s.addEventListener("touchstart",g),s.addEventListener("touchmove",f),s.addEventListener("touchend",y),this.activeInteractions.set(r,{element:s,events:[{event:"touchstart",handler:g},{event:"touchmove",handler:f},{event:"touchend",handler:y}]}),()=>{const e=this.activeInteractions.get(r);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(r))}}moveToElementWithFocus(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`focus-${Date.now()}-${Math.random()}`,{onFocus:a=null,onBlur:o=null,onFocusIn:c=null,onFocusOut:l=null}=t,h=e=>{a&&a(e);const t=s.getBoundingClientRect(),i=t.left+t.width/2+n.x-window.innerWidth/2,r=t.top+t.height/2+n.y-window.innerHeight/2;this.positionController.setOffset(i,r,0)},u=e=>{o&&o(e)},d=e=>{c&&c(e)},p=e=>{l&&l(e)};return s.addEventListener("focus",h),s.addEventListener("blur",u),s.addEventListener("focusin",d),s.addEventListener("focusout",p),this.activeInteractions.set(r,{element:s,events:[{event:"focus",handler:h},{event:"blur",handler:u},{event:"focusin",handler:d},{event:"focusout",handler:p}]}),()=>{const e=this.activeInteractions.get(r);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(r))}}moveToElementWithKeyboard(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`keyboard-${Date.now()}-${Math.random()}`,{onKeyDown:a=null,onKeyUp:o=null,onKeyPress:c=null,targetKeys:l=["Enter","Space"]}=t,h=e=>{if(a&&a(e),l.includes(e.key)){const e=s.getBoundingClientRect(),t=e.left+e.width/2+n.x-window.innerWidth/2,i=e.top+e.height/2+n.y-window.innerHeight/2;this.positionController.setOffset(t,i,0)}},u=e=>{o&&o(e)},d=e=>{c&&c(e)};return s.addEventListener("keydown",h),s.addEventListener("keyup",u),s.addEventListener("keypress",d),this.activeInteractions.set(r,{element:s,events:[{event:"keydown",handler:h},{event:"keyup",handler:u},{event:"keypress",handler:d}]}),()=>{const e=this.activeInteractions.get(r);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(r))}}stopAllInteractions(){this.activeInteractions.forEach((e,t)=>{e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.activeInteractions.delete(t)}),this.hoverStates.clear(),this.clickStates.clear(),this.touchStates.clear()}destroy(){this.stopAllInteractions(),super.destroy()}}class Wi extends qi{constructor(e){super(e),this.activeAnimations=new Map,this.animationQueue=[],this.isAnimating=!1}moveToElementWithBounce(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`bounce-${Date.now()}-${Math.random()}`,{duration:a=1e3,intensity:o=50,bounces:c=3,onComplete:l=null}=t,h=s.getBoundingClientRect(),u=h.left+h.width/2+n.x-window.innerWidth/2,d=h.top+h.height/2+n.y-window.innerHeight/2,p=this.positionController.getOffset(),m=performance.now(),g=e=>{const t=e-m,i=Math.min(t/a,1),n=1-Math.pow(1-i,3),s=Math.sin(n*Math.PI*c)*o*(1-i),h=p.x+(u-p.x)*i,f=p.y+(d-p.y)*i+s;this.positionController.setOffset(h,f,0),i<1?(this.activeAnimations.set(r,g),requestAnimationFrame(g)):(this.activeAnimations.delete(r),l&&l())};return this.activeAnimations.set(r,g),requestAnimationFrame(g),()=>{this.activeAnimations.delete(r)}}moveToElementWithShake(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`shake-${Date.now()}-${Math.random()}`,{duration:a=500,intensity:o=10,frequency:c=20,onComplete:l=null}=t,h=s.getBoundingClientRect(),u=h.left+h.width/2+n.x-window.innerWidth/2,d=h.top+h.height/2+n.y-window.innerHeight/2,p=performance.now(),m=e=>{const t=e-p,i=Math.min(t/a,1),n=(Math.random()-.5)*o*(1-i),s=(Math.random()-.5)*o*(1-i),h=u+n,g=d+s;this.positionController.setOffset(h,g,0),i<1?(this.activeAnimations.set(r,m),setTimeout(()=>requestAnimationFrame(m),1e3/c)):(this.activeAnimations.delete(r),l&&l())};return this.activeAnimations.set(r,m),requestAnimationFrame(m),()=>{this.activeAnimations.delete(r)}}moveToElementWithPulse(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`pulse-${Date.now()}-${Math.random()}`,{duration:a=2e3,intensity:o=20,frequency:c=2,onComplete:l=null}=t,h=s.getBoundingClientRect(),u=h.left+h.width/2+n.x-window.innerWidth/2,d=h.top+h.height/2+n.y-window.innerHeight/2,p=performance.now(),m=e=>{const t=e-p,i=Math.min(t/a,1),n=Math.sin(t*c*.01)*o*(1-i),s=u+n,h=d+n;this.positionController.setOffset(s,h,0),i<1?(this.activeAnimations.set(r,m),requestAnimationFrame(m)):(this.activeAnimations.delete(r),l&&l())};return this.activeAnimations.set(r,m),requestAnimationFrame(m),()=>{this.activeAnimations.delete(r)}}moveToElementWithWiggle(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`wiggle-${Date.now()}-${Math.random()}`,{duration:a=1e3,intensity:o=15,frequency:c=8,onComplete:l=null}=t,h=s.getBoundingClientRect(),u=h.left+h.width/2+n.x-window.innerWidth/2,d=h.top+h.height/2+n.y-window.innerHeight/2,p=performance.now(),m=e=>{const t=e-p,i=Math.min(t/a,1),n=Math.sin(t*c*.01)*o*(1-i),s=Math.cos(t*c*.01)*o*(1-i),h=u+n,g=d+s;this.positionController.setOffset(h,g,0),i<1?(this.activeAnimations.set(r,m),requestAnimationFrame(m)):(this.activeAnimations.delete(r),l&&l())};return this.activeAnimations.set(r,m),requestAnimationFrame(m),()=>{this.activeAnimations.delete(r)}}moveToElementWithCustom(e,t,i={},n="right",s={x:20,y:0}){const r=document.querySelector(e);if(!r)return void console.warn(`Element not found: ${e}`);const a=`custom-${Date.now()}-${Math.random()}`,{duration:o=1e3,onComplete:c=null}=i,l=r.getBoundingClientRect(),h=l.left+l.width/2+s.x-window.innerWidth/2,u=l.top+l.height/2+s.y-window.innerHeight/2,d=this.positionController.getOffset(),p=performance.now(),m=e=>{const i=e-p,n=Math.min(i/o,1),s=t(n,{elapsed:i,startOffset:d,targetX:h,targetY:u,currentTime:e});if(s&&"object"==typeof s){const e=void 0!==s.x?s.x:h,t=void 0!==s.y?s.y:u;this.positionController.setOffset(e,t,0)}n<1?(this.activeAnimations.set(a,m),requestAnimationFrame(m)):(this.activeAnimations.delete(a),c&&c())};return this.activeAnimations.set(a,m),requestAnimationFrame(m),()=>{this.activeAnimations.delete(a)}}queueAnimations(e=[]){this.animationQueue=[...this.animationQueue,...e],this.processAnimationQueue()}processAnimationQueue(){if(this.isAnimating||0===this.animationQueue.length)return;this.isAnimating=!0;const e=this.animationQueue.shift();if(e){const t=this.executeAnimation(e);t&&setTimeout(()=>{t(),this.isAnimating=!1,this.processAnimationQueue()},e.duration||1e3)}}executeAnimation(e){const{type:t,targetSelector:i,options:n={},position:s="right",offset:r={x:20,y:0}}=e;switch(t){case"bounce":return this.moveToElementWithBounce(i,n,s,r);case"shake":return this.moveToElementWithShake(i,n,s,r);case"pulse":return this.moveToElementWithPulse(i,n,s,r);case"wiggle":return this.moveToElementWithWiggle(i,n,s,r);case"custom":return this.moveToElementWithCustom(i,n.animationFunction,n,s,r);default:return this.moveToElement(i,s,r)}}stopAllAnimations(){this.activeAnimations.forEach((e,t)=>{this.activeAnimations.delete(t)}),this.animationQueue=[],this.isAnimating=!1}destroy(){this.stopAllAnimations(),super.destroy()}}class Ni extends qi{constructor(e){super(e),this.activeEffects=new Map,this.trailPoints=[],this.particles=[],this.effectCanvas=null,this.effectContext=null,this.maxTrailPoints=50,this.maxParticles=100}moveToElementWithTrail(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`trail-${Date.now()}-${Math.random()}`,{color:a="#00ff88",width:o=3,opacity:c=.8,fadeSpeed:l=.95,onComplete:h=null}=t;this.initializeEffectCanvas();const u=s.getBoundingClientRect(),d=u.left+u.width/2+n.x,p=u.top+u.height/2+n.y,m=this.positionController.getOffset(),g=m.x+window.innerWidth/2,f=m.y+window.innerHeight/2,y=performance.now(),v=e=>{const t=e-y,i=Math.min(t/1e3,1),n=g+(d-g)*i,s=f+(p-f)*i;this.trailPoints.push({x:n,y:s,opacity:c*(1-i),timestamp:e}),this.trailPoints.length>this.maxTrailPoints&&this.trailPoints.shift(),this.trailPoints.forEach(e=>{e.opacity*=l}),this.trailPoints=this.trailPoints.filter(e=>e.opacity>.01),this.drawTrail(a,o),this.positionController.setOffset(n-window.innerWidth/2,s-window.innerHeight/2,0),i<1?(this.activeEffects.set(r,v),requestAnimationFrame(v)):(this.activeEffects.delete(r),h&&h())};return this.activeEffects.set(r,v),requestAnimationFrame(v),()=>{this.activeEffects.delete(r)}}moveToElementWithParticles(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`particles-${Date.now()}-${Math.random()}`,{count:a=20,color:o="#00ff88",size:c=2,speed:l=2,life:h=1e3,onComplete:u=null}=t;this.initializeEffectCanvas();const d=s.getBoundingClientRect(),p=d.left+d.width/2+n.x,m=d.top+d.height/2+n.y,g=this.positionController.getOffset(),f=g.x+window.innerWidth/2,y=g.y+window.innerHeight/2,v=performance.now();for(let e=0;e<a;e++)this.particles.push({x:f,y:y,vx:(Math.random()-.5)*l,vy:(Math.random()-.5)*l,life:h,maxLife:h,color:o,size:c});const b=e=>{const t=e-v,i=Math.min(t/1e3,1);this.particles.forEach(e=>{e.x+=e.vx,e.y+=e.vy,e.life-=16,e.opacity=e.life/e.maxLife}),this.particles=this.particles.filter(e=>e.life>0),this.drawParticles();const n=f+(p-f)*i,s=y+(m-y)*i;this.positionController.setOffset(n-window.innerWidth/2,s-window.innerHeight/2,0),i<1||this.particles.length>0?(this.activeEffects.set(r,b),requestAnimationFrame(b)):(this.activeEffects.delete(r),u&&u())};return this.activeEffects.set(r,b),requestAnimationFrame(b),()=>{this.activeEffects.delete(r)}}moveToElementWithGlow(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const r=`glow-${Date.now()}-${Math.random()}`,{color:a="#00ff88",intensity:o=50,radius:c=100,duration:l=1e3,onComplete:h=null}=t;this.initializeEffectCanvas();const u=s.getBoundingClientRect(),d=u.left+u.width/2+n.x,p=u.top+u.height/2+n.y,m=this.positionController.getOffset(),g=m.x+window.innerWidth/2,f=m.y+window.innerHeight/2,y=performance.now(),v=e=>{const t=e-y,i=Math.min(t/l,1),n=g+(d-g)*i,s=f+(p-f)*i;this.drawGlow(n,s,a,o,c,i),this.positionController.setOffset(n-window.innerWidth/2,s-window.innerHeight/2,0),i<1?(this.activeEffects.set(r,v),requestAnimationFrame(v)):(this.activeEffects.delete(r),h&&h())};return this.activeEffects.set(r,v),requestAnimationFrame(v),()=>{this.activeEffects.delete(r)}}initializeEffectCanvas(){this.effectCanvas||(this.effectCanvas=document.createElement("canvas"),this.effectCanvas.style.position="fixed",this.effectCanvas.style.top="0",this.effectCanvas.style.left="0",this.effectCanvas.style.width="100%",this.effectCanvas.style.height="100%",this.effectCanvas.style.pointerEvents="none",this.effectCanvas.style.zIndex="1000",document.body.appendChild(this.effectCanvas),this.effectContext=this.effectCanvas.getContext("2d"),this.resizeEffectCanvas())}resizeEffectCanvas(){this.effectCanvas&&(this.effectCanvas.width=window.innerWidth,this.effectCanvas.height=window.innerHeight)}drawTrail(e,t){if(this.effectContext&&!(this.trailPoints.length<2)){this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height),this.effectContext.strokeStyle=e,this.effectContext.lineWidth=t,this.effectContext.lineCap="round",this.effectContext.lineJoin="round",this.effectContext.beginPath(),this.effectContext.moveTo(this.trailPoints[0].x,this.trailPoints[0].y);for(let e=1;e<this.trailPoints.length;e++){const t=this.trailPoints[e];this.effectContext.globalAlpha=t.opacity,this.effectContext.lineTo(t.x,t.y)}this.effectContext.stroke(),this.effectContext.globalAlpha=1}}drawParticles(){this.effectContext&&(this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height),this.particles.forEach(e=>{this.effectContext.globalAlpha=e.opacity,this.effectContext.fillStyle=e.color,this.effectContext.beginPath(),this.effectContext.arc(e.x,e.y,e.size,0,2*Math.PI),this.effectContext.fill()}),this.effectContext.globalAlpha=1)}drawGlow(e,t,i,n,s,r){if(!this.effectContext)return;this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height);const a=this.effectContext.createRadialGradient(e,t,0,e,t,s),o=Math.floor(n*r).toString(16).padStart(2,"0"),c=i.startsWith("#")?i:`#${i}`;a.addColorStop(0,`${c}${o}`),a.addColorStop(1,`${c}00`),this.effectContext.fillStyle=a,this.effectContext.beginPath(),this.effectContext.arc(e,t,s,0,2*Math.PI),this.effectContext.fill()}stopAllEffects(){this.activeEffects.forEach((e,t)=>{this.activeEffects.delete(t)}),this.trailPoints=[],this.particles=[]}destroy(){this.stopAllEffects(),this.effectCanvas&&(document.body.removeChild(this.effectCanvas),this.effectCanvas=null,this.effectContext=null),super.destroy()}}class Ui extends qi{constructor(e){super(e),this.accessibilityOptions={screenReader:!0,keyboardNavigation:!0,highContrast:!1,reducedMotion:!1,announcements:!0},this.announcements=[],this.keyboardListeners=new Map,this.focusableElements=new Set,this.currentFocusIndex=0,this.focusOrder=[]}moveToElementWithScreenReader(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const{announce:r=!0,announcement:a="Mascot moved to element",role:o="button",label:c=s.textContent||s.alt||"Interactive element"}=t;this.moveToElement(e,i,n),r&&this.accessibilityOptions.screenReader&&this.announceToScreenReader(a),s&&(s.setAttribute("role",o),s.setAttribute("aria-label",c),s.setAttribute("aria-live","polite"))}moveToElementWithKeyboard(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const{onKeyDown:r=null,onKeyUp:a=null,onEnter:o=null,onEscape:c=null,onArrowKeys:l=null}=t,h=`keyboard-${Date.now()}-${Math.random()}`,u=e=>{switch(r&&r(e),e.key){case"Enter":case" ":o&&o(e);break;case"Escape":c&&c(e);break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":l&&l(e)}},d=e=>{a&&a(e)};return s.hasAttribute("tabindex")||s.setAttribute("tabindex","0"),s.addEventListener("keydown",u),s.addEventListener("keyup",d),this.keyboardListeners.set(h,{element:s,events:[{event:"keydown",handler:u},{event:"keyup",handler:d}]}),this.moveToElement(e,i,n),()=>{const e=this.keyboardListeners.get(h);e&&(e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)}),this.keyboardListeners.delete(h))}}moveToElementWithHighContrast(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const{backgroundColor:r="#000000",textColor:a="#ffffff",borderColor:o="#ffffff",borderWidth:c=2}=t;this.accessibilityOptions.highContrast&&(s.style.backgroundColor=r,s.style.color=a,s.style.border=`${c}px solid ${o}`,s.style.outline=`${c}px solid ${o}`),this.moveToElement(e,i,n)}moveToElementWithReducedMotion(e,t={},i="right",n={x:20,y:0}){if(!document.querySelector(e))return void console.warn(`Element not found: ${e}`);const{duration:s=0,easing:r="linear"}=t;window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.accessibilityOptions.reducedMotion?this.moveToElement(e,i,n):this.moveToElement(e,i,n,{duration:s,easing:r})}moveToElementWithFocus(e,t={},i="right",n={x:20,y:0}){const s=document.querySelector(e);if(!s)return void console.warn(`Element not found: ${e}`);const{autoFocus:r=!1,focusRing:a=!0,focusOrder:o=[]}=t;o.length>0?this.focusOrder=o:this.focusOrder.includes(e)||this.focusOrder.push(e),s.hasAttribute("tabindex")||s.setAttribute("tabindex","0"),a&&(s.style.outline="2px solid #0066cc",s.style.outlineOffset="2px"),r&&s.focus(),this.moveToElement(e,i,n)}navigateFocus(e="next"){if(0===this.focusOrder.length)return;this.currentFocusIndex="next"===e?(this.currentFocusIndex+1)%this.focusOrder.length:(this.currentFocusIndex-1+this.focusOrder.length)%this.focusOrder.length;const t=this.focusOrder[this.currentFocusIndex],i=document.querySelector(t);i&&(i.focus(),this.moveToElement(t,"right",{x:20,y:0}))}announceToScreenReader(e){if(!this.accessibilityOptions.announcements)return;let t=document.getElementById("mascot-live-region");t||(t=document.createElement("div"),t.id="mascot-live-region",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.style.position="absolute",t.style.left="-10000px",t.style.width="1px",t.style.height="1px",t.style.overflow="hidden",document.body.appendChild(t)),t.textContent=e,setTimeout(()=>{t.textContent=""},1e3)}enableAccessibility(e={}){this.accessibilityOptions={...this.accessibilityOptions,...e}}disableAccessibility(e={}){Object.keys(e).forEach(e=>{({}).hasOwnProperty.call(this.accessibilityOptions,e)&&(this.accessibilityOptions[e]=!1)})}isAccessibilityEnabled(e){return this.accessibilityOptions[e]||!1}getAccessibilityOptions(){return{...this.accessibilityOptions}}destroy(){this.keyboardListeners.forEach((e,t)=>{e.events.forEach(({event:t,handler:i})=>{e.element.removeEventListener(t,i)})}),this.keyboardListeners.clear();const e=document.getElementById("mascot-live-region");e&&document.body.removeChild(e),this.focusOrder=[],this.currentFocusIndex=0,super.destroy()}}class Vi{constructor(e){this.positionController=e,this.callbacks=new Gi(e),this.advanced=new $i(e),this.context=new Hi(e),this.interactions=new ji(e),this.animations=new Wi(e),this.effects=new Ni(e),this.accessibility=new Ui(e)}moveToElementWithCallback(...e){return this.callbacks.moveToElementWithCallback(...e)}moveToElementSequence(...e){return this.callbacks.moveToElementSequence(...e)}moveToElementWithDelay(...e){return this.callbacks.moveToElementWithDelay(...e)}moveToElementWithCondition(...e){return this.callbacks.moveToElementWithCondition(...e)}moveToElementWithRepeat(...e){return this.callbacks.moveToElementWithRepeat(...e)}moveToElementWithProximity(...e){return this.callbacks.moveToElementWithProximity(...e)}moveToElementWithPath(...e){return this.advanced.moveToElementWithPath(...e)}moveToElementWithEasing(...e){return this.advanced.moveToElementWithEasing(...e)}moveToElementWithCollision(...e){return this.advanced.moveToElementWithCollision(...e)}moveToElementWithAudio(...e){return this.advanced.moveToElementWithAudio(...e)}moveToElementWithGaze(...e){return this.advanced.moveToElementWithGaze(...e)}moveToElementWithScroll(...e){return this.context.moveToElementWithScroll(...e)}moveToElementWithPhysics(...e){return this.context.moveToElementWithPhysics(...e)}moveToElementWithGroup(...e){return this.context.moveToElementWithGroup(...e)}moveToElementWithResponsive(...e){return this.context.moveToElementWithResponsive(...e)}moveToElementWithAccessibility(...e){return this.context.moveToElementWithAccessibility(...e)}moveToElementWithHover(...e){return this.interactions.moveToElementWithHover(...e)}moveToElementWithClick(...e){return this.interactions.moveToElementWithClick(...e)}moveToElementWithTouch(...e){return this.interactions.moveToElementWithTouch(...e)}moveToElementWithFocus(...e){return this.interactions.moveToElementWithFocus(...e)}moveToElementWithKeyboard(...e){return this.interactions.moveToElementWithKeyboard(...e)}moveToElementWithBounce(...e){return this.animations.moveToElementWithBounce(...e)}moveToElementWithShake(...e){return this.animations.moveToElementWithShake(...e)}moveToElementWithPulse(...e){return this.animations.moveToElementWithPulse(...e)}moveToElementWithWiggle(...e){return this.animations.moveToElementWithWiggle(...e)}moveToElementWithCustom(...e){return this.animations.moveToElementWithCustom(...e)}moveToElementWithTrail(...e){return this.effects.moveToElementWithTrail(...e)}moveToElementWithParticles(...e){return this.effects.moveToElementWithParticles(...e)}moveToElementWithGlow(...e){return this.effects.moveToElementWithGlow(...e)}moveToElementWithScreenReader(...e){return this.accessibility.moveToElementWithScreenReader(...e)}moveToElementWithKeyboardAccessible(...e){return this.accessibility.moveToElementWithKeyboard(...e)}moveToElementWithHighContrast(...e){return this.accessibility.moveToElementWithHighContrast(...e)}moveToElementWithReducedMotion(...e){return this.accessibility.moveToElementWithReducedMotion(...e)}moveToElementWithFocusAccessible(...e){return this.accessibility.moveToElementWithFocus(...e)}announceToScreenReader(...e){return this.accessibility.announceToScreenReader(...e)}navigateFocus(...e){return this.accessibility.navigateFocus(...e)}enableAccessibility(...e){return this.accessibility.enableAccessibility(...e)}disableAccessibility(...e){return this.accessibility.disableAccessibility(...e)}destroy(){this.callbacks.destroy(),this.advanced.destroy(),this.context.destroy(),this.interactions.destroy(),this.animations.destroy(),this.effects.destroy(),this.accessibility.destroy()}}class Yi{constructor(e){this.positionController=e,this.isTracking=!1,this.trackingCallbacks=new Map,this.audioContext=null,this.audioAnalyser=null,this.audioData=null}moveToMouse(e={x:20,y:20},t={}){const i="mouse-tracking",n=i=>{const n=i.clientX+e.x,s=i.clientY+e.y,r=n-window.innerWidth/2,a=s-window.innerHeight/2;!1!==t.smooth?this.positionController.animateOffset(r,a,0,t.duration||200,"easeOutQuad"):this.positionController.setOffset(r,a,0)};return this.trackingCallbacks.set(i,n),window.addEventListener("mousemove",n),()=>{window.removeEventListener("mousemove",n),this.trackingCallbacks.delete(i)}}moveToTouch(e={x:20,y:20},t={}){const i="touch-tracking",n=i=>{if(i.touches.length>0){const n=i.touches[0],s=n.clientX+e.x,r=n.clientY+e.y,a=s-window.innerWidth/2,o=r-window.innerHeight/2;!1!==t.smooth?this.positionController.animateOffset(a,o,0,t.duration||200,"easeOutQuad"):this.positionController.setOffset(a,o,0)}};return this.trackingCallbacks.set(i,n),window.addEventListener("touchmove",n),()=>{window.removeEventListener("touchmove",n),this.trackingCallbacks.delete(i)}}moveToAudio(e=0,t=50,i={}){if(this.audioContext||this.initAudioContext(),!this.audioContext||!this.audioAnalyser)return void console.warn("Audio context not available");const n="audio-tracking",s=()=>{if(!this.isTracking)return;this.audioAnalyser.getByteFrequencyData(this.audioData);let e=0;for(let t=0;t<this.audioData.length;t++)e+=this.audioData[t];const n=e/this.audioData.length/255*t,r=(i.centerX||0)+n,a=(i.centerY||0)+.5*n,o=r-window.innerWidth/2,c=a-window.innerHeight/2;this.positionController.setOffset(o,c,0),this.isTracking&&requestAnimationFrame(s)};return this.trackingCallbacks.set(n,s),this.isTracking=!0,s(),()=>{this.isTracking=!1,this.trackingCallbacks.delete(n)}}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=256,this.audioData=new Uint8Array(this.audioAnalyser.frequencyBinCount)}catch(e){console.warn("Failed to initialize audio context:",e)}}connectAudioSource(e){this.audioContext&&this.audioAnalyser||this.initAudioContext(),this.audioContext&&this.audioAnalyser&&this.audioContext.createMediaStreamSource(e).connect(this.audioAnalyser)}moveToViewport(e="right",t={x:20,y:20}){let i,n;switch(e){case"top":i=window.innerWidth/2,n=t.y;break;case"bottom":i=window.innerWidth/2,n=window.innerHeight-t.y;break;case"left":i=t.x,n=window.innerHeight/2;break;case"right":default:i=window.innerWidth-t.x,n=window.innerHeight/2;break;case"top-left":i=t.x,n=t.y;break;case"top-right":i=window.innerWidth-t.x,n=t.y;break;case"bottom-left":i=t.x,n=window.innerHeight-t.y;break;case"bottom-right":i=window.innerWidth-t.x,n=window.innerHeight-t.y}const s=i-window.innerWidth/2,r=n-window.innerHeight/2;this.positionController.setOffset(s,r,0)}stopAllTracking(){this.trackingCallbacks.forEach((e,t)=>{"mouse-tracking"===t?window.removeEventListener("mousemove",e):"touch-tracking"===t&&window.removeEventListener("touchmove",e)}),this.trackingCallbacks.clear(),this.isTracking=!1}destroy(){this.stopAllTracking(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.positionController=null}}class Xi{constructor(e){this.positionController=e,this.isRunning=!1,this.physicsCallbacks=new Map,this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.lastTime=0}moveToGrid(e,t,i={x:0,y:0},n={}){const s=n.gridSize||100,r=e*s+i.x,a=t*s+i.y,o=r-window.innerWidth/2,c=a-window.innerHeight/2;!1!==n.animate?this.positionController.animateOffset(o,c,0,n.duration||1e3,n.easing||"easeOutCubic"):this.positionController.setOffset(o,c,0)}moveToGravity(e={x:0,y:0},t=.1,i={}){const n="gravity",s=n=>{if(!this.isRunning)return;const r=n-this.lastTime;if(this.lastTime=n,r>0){const n=this.positionController.getOffset(),s=n.x,a=n.y,o=e.x-s,c=e.y-a,l=Math.sqrt(o*o+c*c);if(l>0){const e=t/(l*l);this.acceleration.x=o/l*e,this.acceleration.y=c/l*e,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const n=i.damping||.98;this.velocity.x*=n,this.velocity.y*=n;const h=s+this.velocity.x*r,u=a+this.velocity.y*r;this.positionController.setOffset(h,u,0)}}this.isRunning&&requestAnimationFrame(s)};return this.physicsCallbacks.set(n,s),this.isRunning=!0,this.lastTime=performance.now(),s(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(n)}}moveToMagnetic(e=[],t=.05,i={}){const n="magnetic",s=n=>{if(!this.isRunning)return;const r=n-this.lastTime;if(this.lastTime=n,r>0){const n=this.positionController.getOffset(),s=n.x,a=n.y;let o=0,c=0;e.forEach(e=>{let i,n;if("string"==typeof e){const t=document.querySelector(e);if(!t)return;{const e=t.getBoundingClientRect();i=e.left+e.width/2-window.innerWidth/2,n=e.top+e.height/2-window.innerHeight/2}}else{if(void 0===e.x||void 0===e.y)return;i=e.x-window.innerWidth/2,n=e.y-window.innerHeight/2}const r=i-s,l=n-a,h=Math.sqrt(r*r+l*l);if(h>0){const e=t/(h*h);o+=r/h*e,c+=l/h*e}}),this.acceleration.x=o,this.acceleration.y=c,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const l=i.damping||.95;this.velocity.x*=l,this.velocity.y*=l;const h=s+this.velocity.x*r,u=a+this.velocity.y*r;this.positionController.setOffset(h,u,0)}this.isRunning&&requestAnimationFrame(s)};return this.physicsCallbacks.set(n,s),this.isRunning=!0,this.lastTime=performance.now(),s(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(n)}}moveToAvoid(e=[],t=100,i={}){const n="avoid",s=n=>{if(!this.isRunning)return;const r=n-this.lastTime;if(this.lastTime=n,r>0){const n=this.positionController.getOffset(),s=n.x,a=n.y;let o=0,c=0;e.forEach(e=>{let i,n;if("string"==typeof e){const t=document.querySelector(e);if(!t)return;{const e=t.getBoundingClientRect();i=e.left+e.width/2-window.innerWidth/2,n=e.top+e.height/2-window.innerHeight/2}}else{if(void 0===e.x||void 0===e.y)return;i=e.x-window.innerWidth/2,n=e.y-window.innerHeight/2}const r=s-i,l=a-n,h=Math.sqrt(r*r+l*l);if(h<t&&h>0){const e=(t-h)/t;o+=r/h*e,c+=l/h*e}}),this.acceleration.x=o,this.acceleration.y=c,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const l=i.damping||.9;this.velocity.x*=l,this.velocity.y*=l;const h=s+this.velocity.x*r,u=a+this.velocity.y*r;this.positionController.setOffset(h,u,0)}this.isRunning&&requestAnimationFrame(s)};return this.physicsCallbacks.set(n,s),this.isRunning=!0,this.lastTime=performance.now(),s(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(n)}}moveToRandom(e={x:0,y:0,width:400,height:400},t=3e3,i={}){const n="random",s=()=>{if(!this.isRunning)return;const n=e.x+Math.random()*e.width,r=e.y+Math.random()*e.height,a=n-window.innerWidth/2,o=r-window.innerHeight/2;!1!==i.animate?this.positionController.animateOffset(a,o,0,i.duration||1e3,i.easing||"easeOutCubic"):this.positionController.setOffset(a,o,0),this.isRunning&&setTimeout(s,t)};return this.physicsCallbacks.set(n,s),this.isRunning=!0,s(),()=>{this.isRunning=!1,this.physicsCallbacks.delete(n)}}stopAllPhysics(){this.isRunning=!1,this.physicsCallbacks.clear(),this.velocity={x:0,y:0},this.acceleration={x:0,y:0}}destroy(){this.stopAllPhysics(),this.positionController=null}}class Qi{constructor(e){this.positionController=e,this.isRunning=!1,this.animationCallbacks=new Map,this.pathProgress=0,this.timeProgress=0,this.scrollProgress=0}moveToPath(e=[],t=1,i={}){if(e.length<2)return void console.warn("Path requires at least 2 points");const n="path",s=!1!==i.loop,r=i.reverse||!1,a=o=>{if(!this.isRunning)return;const c=o-(this.lastTime||o);if(this.lastTime=o,c>0){this.pathProgress+=t*c/1e3,this.pathProgress=s?this.pathProgress%e.length:Math.min(this.pathProgress,e.length-1);const a=Math.floor(this.pathProgress),o=this.pathProgress-a;let l,h;r?(l=e[e.length-1-a],h=e[e.length-2-a]||e[0]):(l=e[a],h=e[a+1]||e[0]);const u=l.x+(h.x-l.x)*o,d=l.y+(h.y-l.y)*o,p=u-window.innerWidth/2,m=d-window.innerHeight/2;if(this.positionController.setOffset(p,m,0),!s&&this.pathProgress>=e.length-1)return this.isRunning=!1,this.animationCallbacks.delete(n),void(i.onComplete&&i.onComplete())}this.isRunning&&requestAnimationFrame(a)};return this.animationCallbacks.set(n,a),this.isRunning=!0,this.lastTime=performance.now(),a(this.lastTime),()=>{this.isRunning=!1,this.animationCallbacks.delete(n)}}moveToTime(e=2e3,t="easeInOutCubic",i={}){const n="time",s=performance.now(),r=this.positionController.getOffset(),a=i.target||{x:0,y:0},o=c=>{if(!this.isRunning)return;const l=c-s,h=Math.min(l/e,1),u=this.applyEasing(h,t),d=r.x+(a.x-r.x)*u,p=r.y+(a.y-r.y)*u;this.positionController.setOffset(d,p,0),h>=1?(this.isRunning=!1,this.animationCallbacks.delete(n),i.onComplete&&i.onComplete()):requestAnimationFrame(o)};return this.animationCallbacks.set(n,o),this.isRunning=!0,o(s),()=>{this.isRunning=!1,this.animationCallbacks.delete(n)}}moveToScroll(e=0,t={x:0,y:0},i={}){const n="scroll",s=()=>{if(!this.isRunning)return;const n=window.innerWidth,s=window.innerHeight;let r,a;if("horizontal"===i.direction)r=e*n+t.x,a=s/2+t.y;else if("vertical"===i.direction)r=n/2+t.x,a=e*s+t.y;else{const o=e*Math.PI*2,c=i.radius||Math.min(n,s)/4;r=n/2+Math.cos(o)*c+t.x,a=s/2+Math.sin(o)*c+t.y}const o=r-n/2,c=a-s/2;this.positionController.setOffset(o,c,0)};return this.animationCallbacks.set(n,s),this.isRunning=!0,s(),()=>{this.isRunning=!1,this.animationCallbacks.delete(n)}}animateTo(e,t,i=1e3,n="easeOutCubic"){this.positionController.animateOffset(e,t,0,i,n)}applyEasing(e,t){switch(t){case"linear":default:return e;case"easeInQuad":return e*e;case"easeOutQuad":return 1-(1-e)*(1-e);case"easeInOutQuad":return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;case"easeInCubic":return e*e*e;case"easeOutCubic":return 1-Math.pow(1-e,3);case"easeInOutCubic":return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;case"easeInBack":{const t=1.70158;return(t+1)*e*e*e-t*e*e}case"easeOutBack":{const t=1.70158;return 1+(t+1)*Math.pow(e-1,3)+t*Math.pow(e-1,2)}case"easeInElastic":return 0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin((10*e-10.75)*(2*Math.PI/3));case"easeOutElastic":return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((10*e-.75)*(2*Math.PI/3))+1}}stopAllAnimations(){this.isRunning=!1,this.animationCallbacks.clear(),this.pathProgress=0,this.timeProgress=0,this.scrollProgress=0}destroy(){this.stopAllAnimations(),this.positionController=null}}class Ji{constructor(e){this.positionController=e,this.breakpoints={mobile:768,tablet:1024,desktop:1200},this.currentBreakpoint=this.getCurrentBreakpoint(),this.responsiveCallbacks=new Map}getCurrentBreakpoint(){const e=window.innerWidth;return e<this.breakpoints.mobile?"mobile":e<this.breakpoints.tablet?"tablet":e<this.breakpoints.desktop?"desktop":"large"}moveToResponsive(e={},t={}){const i="responsive",n=()=>{if(!this.isRunning)return;const i=this.getCurrentBreakpoint(),n=e[i]||e.default||{x:0,y:0},s=n.x-window.innerWidth/2,r=n.y-window.innerHeight/2;!1!==t.animate?this.positionController.animateOffset(s,r,0,t.duration||500,t.easing||"easeOutCubic"):this.positionController.setOffset(s,r,0)};this.responsiveCallbacks.set(i,n),this.isRunning=!0,n();const s=()=>{const e=this.getCurrentBreakpoint();e!==this.currentBreakpoint&&(this.currentBreakpoint=e,n())};return window.addEventListener("resize",s),()=>{this.isRunning=!1,this.responsiveCallbacks.delete(i),window.removeEventListener("resize",s)}}moveToGroup(e=[],t="center",i={x:0,y:0}){if(0===e.length)return;let n=0,s=0,r=0,a=0,o=0;if(e.forEach(e=>{let t,i,c,l;if("string"==typeof e){const n=document.querySelector(e);if(!n)return;{const e=n.getBoundingClientRect();t=e.left,i=e.top,c=e.width,l=e.height}}else{if(void 0===e.x||void 0===e.y)return;t=e.x,i=e.y,c=e.width||0,l=e.height||0}n+=t,s+=i,r=Math.max(r,t+c),a=Math.max(a,i+l),o++}),0===o)return;const c=n/o,l=s/o;let h,u;switch(t){case"center":default:h=c+i.x,u=l+i.y;break;case"left":h=n+i.x,u=l+i.y;break;case"right":h=r+i.x,u=l+i.y;break;case"top":h=c+i.x,u=s+i.y;break;case"bottom":h=c+i.x,u=a+i.y}const d=h-window.innerWidth/2,p=u-window.innerHeight/2;this.positionController.setOffset(d,p,0)}moveToAccessibility(e=[],t="bottom-right",i={}){const n="accessibility",s=()=>{if(!this.isRunning)return;let n,s;switch((window.speechSynthesis||window.webkitSpeechSynthesis)&&i.announce&&e.forEach(e=>{e.condition&&e.condition()&&this.announceToScreenReader(e.text)}),t){case"bottom-right":default:n=window.innerWidth-100,s=window.innerHeight-100;break;case"bottom-left":n=100,s=window.innerHeight-100;break;case"top-right":n=window.innerWidth-100,s=100;break;case"top-left":n=100,s=100;break;case"center":n=window.innerWidth/2,s=window.innerHeight/2}const r=n-window.innerWidth/2,a=s-window.innerHeight/2;this.positionController.setOffset(r,a,0)};return this.responsiveCallbacks.set(n,s),this.isRunning=!0,s(),()=>{this.isRunning=!1,this.responsiveCallbacks.delete(n)}}announceToScreenReader(e){if(window.speechSynthesis){const t=new SpeechSynthesisUtterance(e);t.volume=.5,t.rate=.8,window.speechSynthesis.speak(t)}}setBreakpoints(e){this.breakpoints={...this.breakpoints,...e},this.currentBreakpoint=this.getCurrentBreakpoint()}getCurrentBreakpointName(){return this.currentBreakpoint}isBreakpoint(e){return this.currentBreakpoint===e}stopAllResponsive(){this.isRunning=!1,this.responsiveCallbacks.clear()}destroy(){this.stopAllResponsive(),this.positionController=null}}class Ki{constructor(e){this.positionController=e,this.elementTargeting=new qi(e),this.inputTracking=new Yi(e),this.physics=new Xi(e),this.animation=new Qi(e),this.responsive=new Ji(e),this.methods=new Map,this.registerMethods()}registerMethods(){this.methods.set("moveToElement",this.elementTargeting.moveToElement.bind(this.elementTargeting)),this.methods.set("moveToButton",this.elementTargeting.moveToButton.bind(this.elementTargeting)),this.methods.set("moveToForm",this.elementTargeting.moveToForm.bind(this.elementTargeting)),this.methods.set("moveToModal",this.elementTargeting.moveToModal.bind(this.elementTargeting)),this.methods.set("moveToNavigation",this.elementTargeting.moveToNavigation.bind(this.elementTargeting)),this.methods.set("moveToContent",this.elementTargeting.moveToContent.bind(this.elementTargeting)),this.methods.set("moveToSidebar",this.elementTargeting.moveToSidebar.bind(this.elementTargeting)),this.methods.set("moveToHeader",this.elementTargeting.moveToHeader.bind(this.elementTargeting)),this.methods.set("moveToFooter",this.elementTargeting.moveToFooter.bind(this.elementTargeting)),this.methods.set("watchElement",this.elementTargeting.watchElement.bind(this.elementTargeting)),this.methods.set("moveToMouse",this.inputTracking.moveToMouse.bind(this.inputTracking)),this.methods.set("moveToTouch",this.inputTracking.moveToTouch.bind(this.inputTracking)),this.methods.set("moveToAudio",this.inputTracking.moveToAudio.bind(this.inputTracking)),this.methods.set("moveToViewport",this.inputTracking.moveToViewport.bind(this.inputTracking)),this.methods.set("moveToGrid",this.physics.moveToGrid.bind(this.physics)),this.methods.set("moveToGravity",this.physics.moveToGravity.bind(this.physics)),this.methods.set("moveToMagnetic",this.physics.moveToMagnetic.bind(this.physics)),this.methods.set("moveToAvoid",this.physics.moveToAvoid.bind(this.physics)),this.methods.set("moveToRandom",this.physics.moveToRandom.bind(this.physics)),this.methods.set("moveToPath",this.animation.moveToPath.bind(this.animation)),this.methods.set("moveToTime",this.animation.moveToTime.bind(this.animation)),this.methods.set("moveToScroll",this.animation.moveToScroll.bind(this.animation)),this.methods.set("animateTo",this.animation.animateTo.bind(this.animation)),this.methods.set("moveToResponsive",this.responsive.moveToResponsive.bind(this.responsive)),this.methods.set("moveToGroup",this.responsive.moveToGroup.bind(this.responsive)),this.methods.set("moveToAccessibility",this.responsive.moveToAccessibility.bind(this.responsive))}call(e,...t){const i=this.methods.get(e);return i?i(...t):(console.warn(`Positioning method not found: ${e}`),null)}getAvailableMethods(){return Array.from(this.methods.keys())}hasMethod(e){return this.methods.has(e)}stopAll(){this.elementTargeting.stopWatchingAll(),this.inputTracking.stopAllTracking(),this.physics.stopAllPhysics(),this.animation.stopAllAnimations(),this.responsive.stopAllResponsive()}destroy(){this.stopAll(),this.elementTargeting.destroy(),this.inputTracking.destroy(),this.physics.destroy(),this.animation.destroy(),this.responsive.destroy(),this.methods.clear(),this.positionController=null}}class Zi{constructor(e={}){this.offsetX=e.offsetX||0,this.offsetY=e.offsetY||0,this.offsetZ=e.offsetZ||0,this.isAnimating=!1,this.animationId=null,this.animationStartTime=0,this.animationDuration=0,this.animationEasing="easeOutCubic",this.startOffset={x:0,y:0,z:0},this.targetOffset={x:0,y:0,z:0},this.onUpdate=e.onUpdate||(()=>{}),this.onAnimationComplete=e.onAnimationComplete||(()=>{}),this.minScale=e.minScale||.5,this.maxScale=e.maxScale||2,this.zScaleRange=e.zScaleRange||1e3,this.globalScale=1,this.coreScaleOverride=1,this.particleScaleOverride=1,this.positioning=new Ki(this),this.elementTargeting=new Vi(this)}setOffset(e,t,i=0){this.stopAnimation(),this.offsetX=e,this.offsetY=t,this.offsetZ=i,this.onUpdate(this.getEffectiveCenter())}getOffset(){return{x:this.offsetX,y:this.offsetY,z:this.offsetZ}}getPosition(e=window.innerWidth/2,t=window.innerHeight/2){return{x:e+this.offsetX,y:t+this.offsetY,z:this.offsetZ,scale:this.getZScale()}}animateOffset(e,t,i=0,n=1e3,s="easeOutCubic"){this.stopAnimation(),this.startOffset={x:this.offsetX,y:this.offsetY,z:this.offsetZ},this.targetOffset={x:e,y:t,z:i},this.animationDuration=n,this.animationEasing=s,this.animationStartTime=performance.now(),this.isAnimating=!0,this.startAnimation()}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.isAnimating=!1}startAnimation(){const e=t=>{if(!this.isAnimating)return;const i=t-this.animationStartTime,n=Math.min(i/this.animationDuration,1),s=this.applyEasing(n,this.animationEasing);this.offsetX=this.lerp(this.startOffset.x,this.targetOffset.x,s),this.offsetY=this.lerp(this.startOffset.y,this.targetOffset.y,s),this.offsetZ=this.lerp(this.startOffset.z,this.targetOffset.z,s),this.onUpdate(this.getEffectiveCenter()),n>=1?(this.isAnimating=!1,this.onAnimationComplete()):this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)}getEffectiveCenter(e=0,t=0){return{x:e+this.offsetX,y:t+this.offsetY,scale:this.getZScale(),coreScale:this.getCoreScale(),particleScale:this.getParticleScale()}}getZScale(){const e=-this.offsetZ/this.zScaleRange,t=Math.max(-1,Math.min(1,e));return this.lerp(this.minScale,this.maxScale,(t+1)/2)*this.globalScale}setGlobalScale(e){this.globalScale=Math.max(.1,e),this.onUpdate(this.getEffectiveCenter())}setScaleOverrides(e){"number"==typeof e?(this.globalScale=Math.max(.1,e),this.coreScaleOverride=1,this.particleScaleOverride=1):(void 0!==e.global&&(this.globalScale=Math.max(.1,e.global)),void 0!==e.core&&(this.coreScaleOverride=Math.max(.1,e.core)),void 0!==e.particles&&(this.particleScaleOverride=Math.max(.1,e.particles))),this.onUpdate(this.getEffectiveCenter())}getCoreScale(){return this.calculateBaseZScale()*this.globalScale*this.coreScaleOverride}getParticleScale(){return this.calculateBaseZScale()*this.globalScale*this.particleScaleOverride}calculateBaseZScale(){const e=-this.offsetZ/this.zScaleRange,t=Math.max(-1,Math.min(1,e));return this.lerp(this.minScale,this.maxScale,(t+1)/2)}lerp(e,t,i){return e+(t-e)*i}applyEasing(e,t){switch(t){case"linear":default:return e;case"easeInQuad":return e*e;case"easeOutQuad":return 1-(1-e)*(1-e);case"easeInOutQuad":return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;case"easeInCubic":return e*e*e;case"easeOutCubic":return 1-Math.pow(1-e,3);case"easeInOutCubic":return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;case"easeInBack":{const t=1.70158;return(t+1)*e*e*e-t*e*e}case"easeOutBack":{const t=1.70158;return 1+(t+1)*Math.pow(e-1,3)+t*Math.pow(e-1,2)}}}getPositioning(){return this.positioning}getElementTargeting(){return this.elementTargeting}callPositioning(e,...t){return this.positioning.call(e,...t)}destroy(){this.stopAnimation(),this.positioning&&(this.positioning.destroy(),this.positioning=null),this.elementTargeting&&(this.elementTargeting.destroy(),this.elementTargeting=null),this.onUpdate=null,this.onAnimationComplete=null}}const en="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,tn=globalThis,nn="10.22.0";function sn(){return rn(tn),tn}function rn(e){const t=e.__SENTRY__=e.__SENTRY__||{};return t.version=t.version||nn,t[nn]=t[nn]||{}}function an(e,t,i=tn){const n=i.__SENTRY__=i.__SENTRY__||{},s=n[nn]=n[nn]||{};return s[e]||(s[e]=t())}const on=["debug","info","warn","error","log","assert","trace"],cn={};function ln(e){if(!("console"in tn))return e();const t=tn.console,i={},n=Object.keys(cn);n.forEach(e=>{const n=cn[e];i[e]=t[e],t[e]=n});try{return e()}finally{n.forEach(e=>{t[e]=i[e]})}}function hn(){return dn().enabled}function un(e,...t){en&&hn()&&ln(()=>{tn.console[e](`Sentry Logger [${e}]:`,...t)})}function dn(){return en?an("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const pn={enable:function(){dn().enabled=!0},disable:function(){dn().enabled=!1},isEnabled:hn,log:function(...e){un("log",...e)},warn:function(...e){un("warn",...e)},error:function(...e){un("error",...e)}},mn="?",gn=/\(error: (.*)\)/,fn=/captureMessage|captureException/;function yn(...e){const t=e.sort((e,t)=>e[0]-t[0]).map(e=>e[1]);return(e,i=0,n=0)=>{const s=[],r=e.split("\n");for(let e=i;e<r.length;e++){let i=r[e];i.length>1024&&(i=i.slice(0,1024));const a=gn.test(i)?i.replace(gn,"$1"):i;if(!a.match(/\S*Error: /)){for(const e of t){const t=e(a);if(t){s.push(t);break}}if(s.length>=50+n)break}}return function(e){if(!e.length)return[];const t=Array.from(e);return/sentryWrapped/.test(vn(t).function||"")&&t.pop(),t.reverse(),fn.test(vn(t).function||"")&&(t.pop(),fn.test(vn(t).function||"")&&t.pop()),t.slice(0,50).map(e=>({...e,filename:e.filename||vn(t).filename,function:e.function||mn}))}(s.slice(n))}}function vn(e){return e[e.length-1]||{}}const bn="<anonymous>";function wn(e){try{return e&&"function"==typeof e&&e.name||bn}catch{return bn}}function Sn(e){const t=e.exception;if(t){const e=[];try{return t.values.forEach(t=>{t.stacktrace.frames&&e.push(...t.stacktrace.frames)}),e}catch{return}}}const Mn={},xn={};function Cn(e,t){Mn[e]=Mn[e]||[],Mn[e].push(t)}function Tn(e,t){if(!xn[e]){xn[e]=!0;try{t()}catch(t){en&&pn.error(`Error while instrumenting ${e}`,t)}}}function kn(e,t){const i=e&&Mn[e];if(i)for(const n of i)try{n(t)}catch(t){en&&pn.error(`Error while triggering instrumentation handler.\nType: ${e}\nName: ${wn(n)}\nError:`,t)}}let En=null;function Pn(e){const t="error";Cn(t,e),Tn(t,_n)}function _n(){En=tn.onerror,tn.onerror=function(e,t,i,n,s){return kn("error",{column:n,error:s,line:i,msg:e,url:t}),!!En&&En.apply(this,arguments)},tn.onerror.__SENTRY_INSTRUMENTED__=!0}let An=null;function In(e){const t="unhandledrejection";Cn(t,e),Tn(t,Rn)}function Rn(){An=tn.onunhandledrejection,tn.onunhandledrejection=function(e){return kn("unhandledrejection",e),!An||An.apply(this,arguments)},tn.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}const Dn={}.toString;function On(e){switch(Dn.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object WebAssembly.Exception]":return!0;default:return Wn(e,Error)}}function zn(e,t){return Dn.call(e)===`[object ${t}]`}function Bn(e){return zn(e,"ErrorEvent")}function Fn(e){return zn(e,"DOMError")}function Ln(e){return zn(e,"String")}function qn(e){return"object"==typeof e&&null!==e&&"__sentry_template_string__"in e&&"__sentry_template_values__"in e}function Gn(e){return null===e||qn(e)||"object"!=typeof e&&"function"!=typeof e}function $n(e){return zn(e,"Object")}function Hn(e){return"undefined"!=typeof Event&&Wn(e,Event)}function jn(e){return Boolean(e?.then&&"function"==typeof e.then)}function Wn(e,t){try{return e instanceof t}catch{return!1}}function Nn(e){return!("object"!=typeof e||null===e||!e.__isVue&&!e._isVue)}function Un(e){return"undefined"!=typeof Request&&Wn(e,Request)}const Vn=tn;function Yn(e,t={}){if(!e)return"<unknown>";try{let i=e;const n=5,s=[];let r=0,a=0;const o=" > ",c=o.length;let l;const h=Array.isArray(t)?t:t.keyAttrs,u=!Array.isArray(t)&&t.maxStringLength||80;for(;i&&r++<n&&(l=Xn(i,h),!("html"===l||r>1&&a+s.length*c+l.length>=u));)s.push(l),a+=l.length,i=i.parentNode;return s.reverse().join(o)}catch{return"<unknown>"}}function Xn(e,t){const i=e,n=[];if(!i?.tagName)return"";if(Vn.HTMLElement&&i instanceof HTMLElement&&i.dataset){if(i.dataset.sentryComponent)return i.dataset.sentryComponent;if(i.dataset.sentryElement)return i.dataset.sentryElement}n.push(i.tagName.toLowerCase());const s=t?.length?t.filter(e=>i.getAttribute(e)).map(e=>[e,i.getAttribute(e)]):null;if(s?.length)s.forEach(e=>{n.push(`[${e[0]}="${e[1]}"]`)});else{i.id&&n.push(`#${i.id}`);const e=i.className;if(e&&Ln(e)){const t=e.split(/\s+/);for(const e of t)n.push(`.${e}`)}}const r=["aria-label","type","name","title","alt"];for(const e of r){const t=i.getAttribute(e);t&&n.push(`[${e}="${t}"]`)}return n.join("")}function Qn(){try{return Vn.document.location.href}catch{return""}}function Jn(e){if(!Vn.HTMLElement)return null;let t=e;for(let e=0;e<5;e++){if(!t)return null;if(t instanceof HTMLElement){if(t.dataset.sentryComponent)return t.dataset.sentryComponent;if(t.dataset.sentryElement)return t.dataset.sentryElement}t=t.parentNode}return null}function Kn(e,t=0){return"string"!=typeof e||0===t||e.length<=t?e:`${e.slice(0,t)}...`}function Zn(e,t){if(!Array.isArray(e))return"";const i=[];for(let t=0;t<e.length;t++){const n=e[t];try{Nn(n)?i.push("[VueViewModel]"):i.push(String(n))}catch{i.push("[value cannot be serialized]")}}return i.join(t)}function es(e,t,i=!1){return!!Ln(e)&&(zn(t,"RegExp")?t.test(e):!!Ln(t)&&(i?e===t:e.includes(t)))}function ts(e,t=[],i=!1){return t.some(t=>es(e,t,i))}function is(e,t,i){if(!(t in e))return;const n=e[t];if("function"!=typeof n)return;const s=i(n);"function"==typeof s&&ss(s,n);try{e[t]=s}catch{en&&pn.log(`Failed to replace method "${t}" in object`,e)}}function ns(e,t,i){try{Object.defineProperty(e,t,{value:i,writable:!0,configurable:!0})}catch{en&&pn.log(`Failed to add non-enumerable property "${t}" to object`,e)}}function ss(e,t){try{const i=t.prototype||{};e.prototype=t.prototype=i,ns(e,"__sentry_original__",t)}catch{}}function rs(e){return e.__sentry_original__}function as(e){if(On(e))return{message:e.message,name:e.name,stack:e.stack,...cs(e)};if(Hn(e)){const t={type:e.type,target:os(e.target),currentTarget:os(e.currentTarget),...cs(e)};return"undefined"!=typeof CustomEvent&&Wn(e,CustomEvent)&&(t.detail=e.detail),t}return e}function os(e){try{return"undefined"!=typeof Element&&Wn(e,Element)?Yn(e):{}.toString.call(e)}catch{return"<unknown>"}}function cs(e){if("object"==typeof e&&null!==e){const t={};for(const i in e)({}).hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}return{}}let ls,hs,us;function ds(e=function(){const e=tn;return e.crypto||e.msCrypto}()){try{if(e?.randomUUID)return e.randomUUID().replace(/-/g,"")}catch{}return ls||(ls=[1e7]+1e3+4e3+8e3+1e11),ls.replace(/[018]/g,e=>(e^(16*Math.random()&15)>>e/4).toString(16))}function ps(e){return e.exception?.values?.[0]}function ms(e){const{message:t,event_id:i}=e;if(t)return t;const n=ps(e);return n?n.type&&n.value?`${n.type}: ${n.value}`:n.type||n.value||i||"<unknown>":i||"<unknown>"}function gs(e,t,i){const n=e.exception=e.exception||{},s=n.values=n.values||[],r=s[0]=s[0]||{};r.value||(r.value=t||""),r.type||(r.type="Error")}function fs(e,t){const i=ps(e);if(!i)return;const n=i.mechanism;if(i.mechanism={type:"generic",handled:!0,...n,...t},t&&"data"in t){const e={...n?.data,...t.data};i.mechanism.data=e}}function ys(e){if(function(e){try{return e.__sentry_captured__}catch{}}(e))return!0;try{ns(e,"__sentry_captured__",!0)}catch{}return!1}function vs(){return Date.now()/1e3}function bs(){return(hs??(hs=function(){const{performance:e}=tn;if(!e?.now||!e.timeOrigin)return vs;const t=e.timeOrigin;return()=>(t+e.now())/1e3}()))()}function ws(){return us||(us=function(){const{performance:e}=tn;if(!e?.now)return[void 0,"none"];const t=36e5,i=e.now(),n=Date.now(),s=e.timeOrigin?Math.abs(e.timeOrigin+i-n):t,r=s<t,a=e.timing?.navigationStart,o="number"==typeof a?Math.abs(a+i-n):t;return r||o<t?s<=o?[e.timeOrigin,"timeOrigin"]:[a,"navigationStart"]:[n,"dateNow"]}()),us[0]}function Ss(e,t={}){if(t.user&&(!e.ipAddress&&t.user.ip_address&&(e.ipAddress=t.user.ip_address),e.did||t.did||(e.did=t.user.id||t.user.email||t.user.username)),e.timestamp=t.timestamp||bs(),t.abnormal_mechanism&&(e.abnormal_mechanism=t.abnormal_mechanism),t.ignoreDuration&&(e.ignoreDuration=t.ignoreDuration),t.sid&&(e.sid=32===t.sid.length?t.sid:ds()),void 0!==t.init&&(e.init=t.init),!e.did&&t.did&&(e.did=`${t.did}`),"number"==typeof t.started&&(e.started=t.started),e.ignoreDuration)e.duration=void 0;else if("number"==typeof t.duration)e.duration=t.duration;else{const t=e.timestamp-e.started;e.duration=t>=0?t:0}t.release&&(e.release=t.release),t.environment&&(e.environment=t.environment),!e.ipAddress&&t.ipAddress&&(e.ipAddress=t.ipAddress),!e.userAgent&&t.userAgent&&(e.userAgent=t.userAgent),"number"==typeof t.errors&&(e.errors=t.errors),t.status&&(e.status=t.status)}function Ms(e,t,i=2){if(!t||"object"!=typeof t||i<=0)return t;if(e&&0===Object.keys(t).length)return e;const n={...e};for(const e in t)({}).hasOwnProperty.call(t,e)&&(n[e]=Ms(n[e],t[e],i-1));return n}function xs(){return ds()}function Cs(){return ds().substring(16)}const Ts="_sentrySpan";function ks(e,t){t?ns(e,Ts,t):delete e[Ts]}function Es(e){return e[Ts]}class Ps{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:xs(),sampleRand:Math.random()}}clone(){const e=new Ps;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,ks(e,Es(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&Ss(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return null===t?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t="function"==typeof e?e(this):e,i=t instanceof Ps?t.getScopeData():$n(t)?e:void 0,{tags:n,extra:s,user:r,contexts:a,level:o,fingerprint:c=[],propagationContext:l}=i||{};return this._tags={...this._tags,...n},this._extra={...this._extra,...s},this._contexts={...this._contexts,...a},r&&Object.keys(r).length&&(this._user=r),o&&(this._level=o),c.length&&(this._fingerprint=c),l&&(this._propagationContext=l),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,ks(this,void 0),this._attachments=[],this.setPropagationContext({traceId:xs(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const i="number"==typeof t?t:100;if(i<=0)return this;const n={timestamp:vs(),...e,message:e.message?Kn(e.message,2048):e.message};return this._breadcrumbs.push(n),this._breadcrumbs.length>i&&(this._breadcrumbs=this._breadcrumbs.slice(-i),this._client?.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:Es(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=Ms(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext=e,this}getPropagationContext(){return this._propagationContext}captureException(e,t){const i=t?.event_id||ds();if(!this._client)return en&&pn.warn("No client configured on scope - will not capture exception!"),i;const n=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:n,...t,event_id:i},this),i}captureMessage(e,t,i){const n=i?.event_id||ds();if(!this._client)return en&&pn.warn("No client configured on scope - will not capture message!"),n;const s=new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:s,...i,event_id:n},this),n}captureEvent(e,t){const i=t?.event_id||ds();return this._client?(this._client.captureEvent(e,{...t,event_id:i},this),i):(en&&pn.warn("No client configured on scope - will not capture event!"),i)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}class _s{constructor(e,t){let i,n;i=e||new Ps,n=t||new Ps,this._stack=[{scope:i}],this._isolationScope=n}withScope(e){const t=this._pushScope();let i;try{i=e(t)}catch(e){throw this._popScope(),e}return jn(i)?i.then(e=>(this._popScope(),e),e=>{throw this._popScope(),e}):(this._popScope(),i)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return!(this._stack.length<=1||!this._stack.pop())}}function As(){const e=rn(sn());return e.stack=e.stack||new _s(an("defaultCurrentScope",()=>new Ps),an("defaultIsolationScope",()=>new Ps))}function Is(e){return As().withScope(e)}function Rs(e,t){const i=As();return i.withScope(()=>(i.getStackTop().scope=e,t(e)))}function Ds(e){return As().withScope(()=>e(As().getIsolationScope()))}function Os(e){const t=rn(e);return t.acs?t.acs:{withIsolationScope:Ds,withScope:Is,withSetScope:Rs,withSetIsolationScope:(e,t)=>Ds(t),getCurrentScope:()=>As().getScope(),getIsolationScope:()=>As().getIsolationScope()}}function zs(){return Os(sn()).getCurrentScope()}function Bs(){return Os(sn()).getIsolationScope()}function Fs(...e){const t=Os(sn());if(2===e.length){const[i,n]=e;return i?t.withSetScope(i,n):t.withScope(n)}return t.withScope(e[0])}function Ls(){return zs().getClient()}function qs(e){const t=e.getPropagationContext(),{traceId:i,parentSpanId:n,propagationSpanId:s}=t,r={trace_id:i,span_id:s||Cs()};return n&&(r.parent_span_id=n),r}const Gs="sentry.source",$s="sentry.sample_rate",Hs="sentry.previous_trace_sample_rate",js="sentry.op",Ws="sentry.origin",Ns="sentry.idle_span_finish_reason",Us="sentry.measurement_unit",Vs="sentry.measurement_value",Ys="sentry.custom_span_name",Xs="sentry.profile_id",Qs="sentry.exclusive_time",Js="sentry.link.type";function Ks(e,t){e.setAttribute("http.response.status_code",t);const i=function(e){if(e<400&&e>=100)return{code:1};if(e>=400&&e<500)switch(e){case 401:return{code:2,message:"unauthenticated"};case 403:return{code:2,message:"permission_denied"};case 404:return{code:2,message:"not_found"};case 409:return{code:2,message:"already_exists"};case 413:return{code:2,message:"failed_precondition"};case 429:return{code:2,message:"resource_exhausted"};case 499:return{code:2,message:"cancelled"};default:return{code:2,message:"invalid_argument"}}if(e>=500&&e<600)switch(e){case 501:return{code:2,message:"unimplemented"};case 503:return{code:2,message:"unavailable"};case 504:return{code:2,message:"deadline_exceeded"};default:return{code:2,message:"internal_error"}}return{code:2,message:"unknown_error"}}(t);"unknown_error"!==i.message&&e.setStatus(i)}const Zs="_sentryScope",er="_sentryIsolationScope";function tr(e){if(e){if("object"==typeof e&&"deref"in e&&"function"==typeof e.deref)try{return e.deref()}catch{return}return e}}function ir(e){const t=e;return{scope:t[Zs],isolationScope:tr(t[er])}}const nr="sentry-",sr=/^sentry-/;function rr(e){const t=function(e){if(e&&(Ln(e)||Array.isArray(e)))return Array.isArray(e)?e.reduce((e,t)=>{const i=ar(t);return Object.entries(i).forEach(([t,i])=>{e[t]=i}),e},{}):ar(e)}(e);if(!t)return;const i=Object.entries(t).reduce((e,[t,i])=>(t.match(sr)&&(e[t.slice(7)]=i),e),{});return Object.keys(i).length>0?i:void 0}function ar(e){return e.split(",").map(e=>{const t=e.indexOf("=");return-1===t?[]:[e.slice(0,t),e.slice(t+1)].map(e=>{try{return decodeURIComponent(e.trim())}catch{return}})}).reduce((e,[t,i])=>(t&&i&&(e[t]=i),e),{})}const or=/^o(\d+)\./,cr=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function lr(e,t=!1){const{host:i,path:n,pass:s,port:r,projectId:a,protocol:o,publicKey:c}=e;return`${o}://${c}${t&&s?`:${s}`:""}@${i}${r?`:${r}`:""}/${n?`${n}/`:n}${a}`}function hr(e){return{protocol:e.protocol,publicKey:e.publicKey||"",pass:e.pass||"",host:e.host,port:e.port||"",path:e.path||"",projectId:e.projectId}}function ur(e){const t=e.getOptions(),{host:i}=e.getDsn()||{};let n;return t.orgId?n=String(t.orgId):i&&(n=function(e){const t=e.match(or);return t?.[1]}(i)),n}function dr(e){if("boolean"==typeof e)return Number(e);const t="string"==typeof e?parseFloat(e):e;return"number"!=typeof t||isNaN(t)||t<0||t>1?void 0:t}const pr=new RegExp("^[ \\t]*([0-9a-f]{32})?-?([0-9a-f]{16})?-?([01])?[ \\t]*$");function mr(e=xs(),t=Cs(),i){let n="";return void 0!==i&&(n=i?"-1":"-0"),`${e}-${t}${n}`}function gr(e=xs(),t=Cs(),i){return`00-${e}-${t}-${i?"01":"00"}`}let fr=!1;function yr(e){const{spanId:t,traceId:i}=e.spanContext(),{data:n,op:s,parent_span_id:r,status:a,origin:o,links:c}=Mr(e);return{parent_span_id:r,span_id:t,trace_id:i,data:n,op:s,status:a,origin:o,links:c}}function vr(e){const{spanId:t,traceId:i,isRemote:n}=e.spanContext(),s=n?t:Mr(e).parent_span_id,r=ir(e).scope;return{parent_span_id:s,span_id:n?r?.getPropagationContext().propagationSpanId||Cs():t,trace_id:i}}function br(e){return e&&e.length>0?e.map(({context:{spanId:e,traceId:t,traceFlags:i,...n},attributes:s})=>({span_id:e,trace_id:t,sampled:1===i,attributes:s,...n})):void 0}function wr(e){return"number"==typeof e?Sr(e):Array.isArray(e)?e[0]+e[1]/1e9:e instanceof Date?Sr(e.getTime()):bs()}function Sr(e){return e>9999999999?e/1e3:e}function Mr(e){if(function(e){return"function"==typeof e.getSpanJSON}(e))return e.getSpanJSON();const{spanId:t,traceId:i}=e.spanContext();if(function(e){const t=e;return!!(t.attributes&&t.startTime&&t.name&&t.endTime&&t.status)}(e)){const{attributes:n,startTime:s,name:r,endTime:a,status:o,links:c}=e;return{span_id:t,trace_id:i,data:n,description:r,parent_span_id:"parentSpanId"in e?e.parentSpanId:"parentSpanContext"in e?e.parentSpanContext?.spanId:void 0,start_timestamp:wr(s),timestamp:wr(a)||void 0,status:Cr(o),op:n[js],origin:n[Ws],links:br(c)}}return{span_id:t,trace_id:i,start_timestamp:0,data:{}}}function xr(e){const{traceFlags:t}=e.spanContext();return 1===t}function Cr(e){if(e&&0!==e.code)return 1===e.code?"ok":e.message||"unknown_error"}const Tr="_sentryChildSpans",kr="_sentryRootSpan";function Er(e,t){const i=e[kr]||e;ns(t,kr,i),e[Tr]?e[Tr].add(t):ns(e,Tr,new Set([t]))}function Pr(e){const t=new Set;return function e(i){if(!t.has(i)&&xr(i)){t.add(i);const n=i[Tr]?Array.from(i[Tr]):[];for(const t of n)e(t)}}(e),Array.from(t)}function _r(e){return e[kr]||e}function Ar(){const e=Os(sn());return e.getActiveSpan?e.getActiveSpan():Es(zs())}function Ir(){fr||(ln(()=>{console.warn("[Sentry] Returning null from `beforeSendSpan` is disallowed. To drop certain spans, configure the respective integrations directly or use `ignoreSpans`.")}),fr=!0)}let Rr=!1;function Dr(e){if("boolean"==typeof __SENTRY_TRACING__&&!__SENTRY_TRACING__)return!1;const t=e||Ls()?.getOptions();return!(!t||null==t.tracesSampleRate&&!t.tracesSampler)}function Or(e){pn.log(`Ignoring span ${e.op} - ${e.description} because it matches \`ignoreSpans\`.`)}function zr(e,t){if(!t?.length||!e.description)return!1;for(const i of t){if(Fr(i)){if(es(e.description,i))return en&&Or(e),!0;continue}if(!i.name&&!i.op)continue;const t=!i.name||es(e.description,i.name),n=!i.op||e.op&&es(e.op,i.op);if(t&&n)return en&&Or(e),!0}return!1}function Br(e,t){const i=t.parent_span_id,n=t.span_id;if(i)for(const t of e)t.parent_span_id===n&&(t.parent_span_id=i)}function Fr(e){return"string"==typeof e||e instanceof RegExp}const Lr="production",qr="_frozenDsc";function Gr(e,t){ns(e,qr,t)}function $r(e,t){const i=t.getOptions(),{publicKey:n}=t.getDsn()||{},s={environment:i.environment||Lr,release:i.release,public_key:n,trace_id:e,org_id:ur(t)};return t.emit("createDsc",s),s}function Hr(e,t){const i=t.getPropagationContext();return i.dsc||$r(i.traceId,e)}function jr(e){const t=Ls();if(!t)return{};const i=_r(e),n=Mr(i),s=n.data,r=i.spanContext().traceState,a=r?.get("sentry.sample_rate")??s[$s]??s[Hs];function o(e){return"number"!=typeof a&&"string"!=typeof a||(e.sample_rate=`${a}`),e}const c=i[qr];if(c)return o(c);const l=r?.get("sentry.dsc"),h=l&&rr(l);if(h)return o(h);const u=$r(e.spanContext().traceId,t),d=s[Gs],p=n.description;return"url"!==d&&p&&(u.transaction=p),Dr()&&(u.sampled=String(xr(i)),u.sample_rand=r?.get("sentry.sample_rand")??ir(i).scope?.getPropagationContext().sampleRand.toString()),o(u),t.emit("createDsc",u,i),u}class Wr{constructor(e={}){this._traceId=e.traceId||xs(),this._spanId=e.spanId||Cs()}spanContext(){return{spanId:this._spanId,traceId:this._traceId,traceFlags:0}}end(e){}setAttribute(e,t){return this}setAttributes(e){return this}setStatus(e){return this}updateName(e){return this}isRecording(){return!1}addEvent(e,t,i){return this}addLink(e){return this}addLinks(e){return this}recordException(e,t){}}function Nr(e,t=100,i=1/0){try{return Vr("",e,t,i)}catch(e){return{ERROR:`**non-serializable** (${e})`}}}function Ur(e,t=3,i=102400){const n=Nr(e,t);return s=n,function(e){return~-encodeURI(e).split(/%..|./).length}(JSON.stringify(s))>i?Ur(e,t-1,i):n;var s}function Vr(e,t,i=1/0,n=1/0,s=function(){const e=new WeakSet;return[function(t){return!!e.has(t)||(e.add(t),!1)},function(t){e.delete(t)}]}()){const[r,a]=s;if(null==t||["boolean","string"].includes(typeof t)||"number"==typeof t&&Number.isFinite(t))return t;const o=function(e,t){try{if("domain"===e&&t&&"object"==typeof t&&t._events)return"[Domain]";if("domainEmitter"===e)return"[DomainEmitter]";if("undefined"!=typeof global&&t===global)return"[Global]";if("undefined"!=typeof window&&t===window)return"[Window]";if("undefined"!=typeof document&&t===document)return"[Document]";if(Nn(t))return"[VueViewModel]";if($n(i=t)&&"nativeEvent"in i&&"preventDefault"in i&&"stopPropagation"in i)return"[SyntheticEvent]";if("number"==typeof t&&!Number.isFinite(t))return`[${t}]`;if("function"==typeof t)return`[Function: ${wn(t)}]`;if("symbol"==typeof t)return`[${String(t)}]`;if("bigint"==typeof t)return`[BigInt: ${String(t)}]`;const n=function(e){const t=Object.getPrototypeOf(e);return t?.constructor?t.constructor.name:"null prototype"}(t);return/^HTML(\w*)Element$/.test(n)?`[HTMLElement: ${n}]`:`[object ${n}]`}catch(e){return`**non-serializable** (${e})`}var i}(e,t);if(!o.startsWith("[object "))return o;if(t.__sentry_skip_normalization__)return t;const c="number"==typeof t.__sentry_override_normalization_depth__?t.__sentry_override_normalization_depth__:i;if(0===c)return o.replace("object ","");if(r(t))return"[Circular ~]";const l=t;if(l&&"function"==typeof l.toJSON)try{return Vr("",l.toJSON(),c-1,n,s)}catch{}const h=Array.isArray(t)?[]:{};let u=0;const d=as(t);for(const e in d){if(!{}.hasOwnProperty.call(d,e))continue;if(u>=n){h[e]="[MaxProperties ~]";break}const t=d[e];h[e]=Vr(e,t,c-1,n,s),u++}return a(t),h}function Yr(e,t=[]){return[e,t]}function Xr(e,t){const[i,n]=e;return[i,[...n,t]]}function Qr(e,t){const i=e[1];for(const e of i)if(t(e,e[0].type))return!0;return!1}function Jr(e){const t=rn(tn);return t.encodePolyfill?t.encodePolyfill(e):(new TextEncoder).encode(e)}function Kr(e){const[t,i]=e;let n=JSON.stringify(t);function s(e){"string"==typeof n?n="string"==typeof e?n+e:[Jr(n),e]:n.push("string"==typeof e?Jr(e):e)}for(const e of i){const[t,i]=e;if(s(`\n${JSON.stringify(t)}\n`),"string"==typeof i||i instanceof Uint8Array)s(i);else{let e;try{e=JSON.stringify(i)}catch{e=JSON.stringify(Nr(i))}s(e)}}return"string"==typeof n?n:function(e){const t=e.reduce((e,t)=>e+t.length,0),i=new Uint8Array(t);let n=0;for(const t of e)i.set(t,n),n+=t.length;return i}(n)}function Zr(e){return[{type:"span"},e]}function ea(e){const t="string"==typeof e.data?Jr(e.data):e.data;return[{type:"attachment",length:t.length,filename:e.filename,content_type:e.contentType,attachment_type:e.attachmentType},t]}const ta={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",profile_chunk:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",raw_security:"security",log:"log_item",metric:"metric",trace_metric:"metric"};function ia(e){return ta[e]}function na(e){if(!e?.sdk)return;const{name:t,version:i}=e.sdk;return{name:t,version:i}}function sa(e,t,i,n){const s=e.sdkProcessingMetadata?.dynamicSamplingContext;return{event_id:e.event_id,sent_at:(new Date).toISOString(),...t&&{sdk:t},...!!i&&n&&{dsn:lr(n)},...s&&{trace:s}}}function ra(e){if(!e||0===e.length)return;const t={};return e.forEach(e=>{const i=e.attributes||{},n=i[Us],s=i[Vs];"string"==typeof n&&"number"==typeof s&&(t[e.name]={value:s,unit:n})}),t}class aa{constructor(e={}){this._traceId=e.traceId||xs(),this._spanId=e.spanId||Cs(),this._startTime=e.startTimestamp||bs(),this._links=e.links,this._attributes={},this.setAttributes({[Ws]:"manual",[js]:e.op,...e.attributes}),this._name=e.name,e.parentSpanId&&(this._parentSpanId=e.parentSpanId),"sampled"in e&&(this._sampled=e.sampled),e.endTimestamp&&(this._endTime=e.endTimestamp),this._events=[],this._isStandaloneSpan=e.isStandalone,this._endTime&&this._onSpanEnded()}addLink(e){return this._links?this._links.push(e):this._links=[e],this}addLinks(e){return this._links?this._links.push(...e):this._links=e,this}recordException(e,t){}spanContext(){const{_spanId:e,_traceId:t,_sampled:i}=this;return{spanId:e,traceId:t,traceFlags:i?1:0}}setAttribute(e,t){return void 0===t?delete this._attributes[e]:this._attributes[e]=t,this}setAttributes(e){return Object.keys(e).forEach(t=>this.setAttribute(t,e[t])),this}updateStartTime(e){this._startTime=wr(e)}setStatus(e){return this._status=e,this}updateName(e){return this._name=e,this.setAttribute(Gs,"custom"),this}end(e){this._endTime||(this._endTime=wr(e),function(e){if(!en)return;const{description:t="< unknown name >",op:i="< unknown op >"}=Mr(e),{spanId:n}=e.spanContext(),s=`[Tracing] Finishing "${i}" ${_r(e)===e?"root ":""}span "${t}" with ID ${n}`;pn.log(s)}(this),this._onSpanEnded())}getSpanJSON(){return{data:this._attributes,description:this._name,op:this._attributes[js],parent_span_id:this._parentSpanId,span_id:this._spanId,start_timestamp:this._startTime,status:Cr(this._status),timestamp:this._endTime,trace_id:this._traceId,origin:this._attributes[Ws],profile_id:this._attributes[Xs],exclusive_time:this._attributes[Qs],measurements:ra(this._events),is_segment:this._isStandaloneSpan&&_r(this)===this||void 0,segment_id:this._isStandaloneSpan?_r(this).spanContext().spanId:void 0,links:br(this._links)}}isRecording(){return!this._endTime&&!!this._sampled}addEvent(e,t,i){en&&pn.log("[Tracing] Adding an event to span:",e);const n=oa(t)?t:i||bs(),s=oa(t)?{}:t||{},r={name:e,time:wr(n),attributes:s};return this._events.push(r),this}isStandaloneSpan(){return!!this._isStandaloneSpan}_onSpanEnded(){const e=Ls();if(e&&e.emit("spanEnd",this),!this._isStandaloneSpan&&this!==_r(this))return;if(this._isStandaloneSpan)return void(this._sampled?function(e){const t=Ls();if(!t)return;const i=e[1];i&&0!==i.length?t.sendEnvelope(e):t.recordDroppedEvent("before_send","span")}(function(e,t){const i=jr(e[0]),n=t?.getDsn(),s=t?.getOptions().tunnel,r={sent_at:(new Date).toISOString(),...function(e){return!!e.trace_id&&!!e.public_key}(i)&&{trace:i},...!!s&&n&&{dsn:lr(n)}},{beforeSendSpan:a,ignoreSpans:o}=t?.getOptions()||{},c=o?.length?e.filter(e=>!zr(Mr(e),o)):e,l=e.length-c.length;l&&t?.recordDroppedEvent("before_send","span",l);const h=a?e=>{const t=Mr(e);return a(t)||(Ir(),t)}:Mr,u=[];for(const e of c){const t=h(e);t&&u.push(Zr(t))}return Yr(r,u)}([this],e)):(en&&pn.log("[Tracing] Discarding standalone span because its trace was not chosen to be sampled."),e&&e.recordDroppedEvent("sample_rate","span")));const t=this._convertSpanToTransaction();t&&(ir(this).scope||zs()).captureEvent(t)}_convertSpanToTransaction(){if(!ca(Mr(this)))return;this._name||(en&&pn.warn("Transaction has no name, falling back to `<unlabeled transaction>`."),this._name="<unlabeled transaction>");const{scope:e,isolationScope:t}=ir(this),i=e?.getScopeData().sdkProcessingMetadata?.normalizedRequest;if(!0!==this._sampled)return;const n=Pr(this).filter(e=>e!==this&&!function(e){return e instanceof aa&&e.isStandaloneSpan()}(e)).map(e=>Mr(e)).filter(ca),s=this._attributes[Gs];delete this._attributes[Ys],n.forEach(e=>{delete e.data[Ys]});const r={contexts:{trace:yr(this)},spans:n.length>1e3?n.sort((e,t)=>e.start_timestamp-t.start_timestamp).slice(0,1e3):n,start_timestamp:this._startTime,timestamp:this._endTime,transaction:this._name,type:"transaction",sdkProcessingMetadata:{capturedSpanScope:e,capturedSpanIsolationScope:t,dynamicSamplingContext:jr(this)},request:i,...s&&{transaction_info:{source:s}}},a=ra(this._events);return a&&Object.keys(a).length&&(en&&pn.log("[Measurements] Adding measurements to transaction event",JSON.stringify(a,void 0,2)),r.measurements=a),r}}function oa(e){return e&&"number"==typeof e||e instanceof Date||Array.isArray(e)}function ca(e){return!!(e.start_timestamp&&e.timestamp&&e.span_id&&e.trace_id)}const la="__SENTRY_SUPPRESS_TRACING__";function ha(e,t){const i=ga();if(i.startSpan)return i.startSpan(e,t);const n=ma(e),{forceTransaction:s,parentSpan:r,scope:a}=e,o=a?.clone();return Fs(o,()=>{const i=void 0!==(a=r)?e=>da(a,e):e=>e();var a;return i(()=>{const i=zs(),a=ya(i,r),o=e.onlyIfParent&&!a?new Wr:pa({parentSpan:a,spanArguments:n,forceTransaction:s,scope:i});return ks(i,o),function(e,t,i=()=>{},n=()=>{}){let s;try{s=e()}catch(e){throw t(e),i(),e}return function(e,t,i,n){return jn(e)?e.then(e=>(i(),n(e),e),e=>{throw t(e),i(),e}):(i(),n(e),e)}(s,t,i,n)}(()=>t(o),()=>{const{status:e}=Mr(o);!o.isRecording()||e&&"ok"!==e||o.setStatus({code:2,message:"internal_error"})},()=>{o.end()})})})}function ua(e){const t=ga();if(t.startInactiveSpan)return t.startInactiveSpan(e);const i=ma(e),{forceTransaction:n,parentSpan:s}=e;return(e.scope?t=>Fs(e.scope,t):void 0!==s?e=>da(s,e):e=>e())(()=>{const t=zs(),r=ya(t,s);return e.onlyIfParent&&!r?new Wr:pa({parentSpan:r,spanArguments:i,forceTransaction:n,scope:t})})}function da(e,t){const i=ga();return i.withActiveSpan?i.withActiveSpan(e,t):Fs(i=>(ks(i,e||void 0),t(i)))}function pa({parentSpan:e,spanArguments:t,forceTransaction:i,scope:n}){if(!Dr()){const n=new Wr;return!i&&e||Gr(n,{sampled:"false",sample_rate:"0",transaction:t.name,...jr(n)}),n}const s=Bs();let r;if(e&&!i)r=function(e,t,i){const{spanId:n,traceId:s}=e.spanContext(),r=!t.getScopeData().sdkProcessingMetadata[la]&&xr(e),a=r?new aa({...i,parentSpanId:n,traceId:s,sampled:r}):new Wr({traceId:s});Er(e,a);const o=Ls();return o&&(o.emit("spanStart",a),i.endTimestamp&&o.emit("spanEnd",a)),a}(e,n,t),Er(e,r);else if(e){const i=jr(e),{traceId:s,spanId:a}=e.spanContext(),o=xr(e);r=fa({traceId:s,parentSpanId:a,...t},n,o),Gr(r,i)}else{const{traceId:e,dsc:i,parentSpanId:a,sampled:o}={...s.getPropagationContext(),...n.getPropagationContext()};r=fa({traceId:e,parentSpanId:a,...t},n,o),i&&Gr(r,i)}return function(e){if(!en)return;const{description:t="< unknown name >",op:i="< unknown op >",parent_span_id:n}=Mr(e),{spanId:s}=e.spanContext(),r=xr(e),a=_r(e),o=a===e,c=`[Tracing] Starting ${r?"sampled":"unsampled"} ${o?"root ":""}span`,l=[`op: ${i}`,`name: ${t}`,`ID: ${s}`];if(n&&l.push(`parent ID: ${n}`),!o){const{op:e,description:t}=Mr(a);l.push(`root ID: ${a.spanContext().spanId}`),e&&l.push(`root op: ${e}`),t&&l.push(`root description: ${t}`)}pn.log(`${c}\n  ${l.join("\n  ")}`)}(r),function(e,t,i){e&&(ns(e,er,function(e){try{const t=tn.WeakRef;if("function"==typeof t)return new t(e)}catch{}return e}(i)),ns(e,Zs,t))}(r,n,s),r}function ma(e){const t={isStandalone:(e.experimental||{}).standalone,...e};if(e.startTime){const i={...t};return i.startTimestamp=wr(e.startTime),delete i.startTime,i}return t}function ga(){return Os(sn())}function fa(e,t,i){const n=Ls(),s=n?.getOptions()||{},{name:r=""}=e,a={spanAttributes:{...e.attributes},spanName:r,parentSampled:i};n?.emit("beforeSampling",a,{decision:!1});const o=a.parentSampled??i,c=a.spanAttributes,l=t.getPropagationContext(),[h,u,d]=t.getScopeData().sdkProcessingMetadata[la]?[!1]:function(e,t,i){if(!Dr(e))return[!1];let n,s;"function"==typeof e.tracesSampler?(s=e.tracesSampler({...t,inheritOrSampleWith:e=>"number"==typeof t.parentSampleRate?t.parentSampleRate:"boolean"==typeof t.parentSampled?Number(t.parentSampled):e}),n=!0):void 0!==t.parentSampled?s=t.parentSampled:void 0!==e.tracesSampleRate&&(s=e.tracesSampleRate,n=!0);const r=dr(s);if(void 0===r)return en&&pn.warn(`[Tracing] Discarding root span because of invalid sample rate. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(s)} of type ${JSON.stringify(typeof s)}.`),[!1];if(!r)return en&&pn.log("[Tracing] Discarding transaction because "+("function"==typeof e.tracesSampler?"tracesSampler returned 0 or false":"a negative sampling decision was inherited or tracesSampleRate is set to 0")),[!1,r,n];const a=i<r;return a||en&&pn.log(`[Tracing] Discarding transaction because it's not included in the random sample (sampling rate = ${Number(s)})`),[a,r,n]}(s,{name:r,parentSampled:o,attributes:c,parentSampleRate:dr(l.dsc?.sample_rate)},l.sampleRand),p=new aa({...e,attributes:{[Gs]:"custom",[$s]:void 0!==u&&d?u:void 0,...c},sampled:h});return!h&&n&&(en&&pn.log("[Tracing] Discarding root span because its trace was not chosen to be sampled."),n.recordDroppedEvent("sample_rate","transaction")),n&&n.emit("spanStart",p),p}function ya(e,t){if(t)return t;if(null===t)return;const i=Es(e);if(!i)return;const n=Ls();return(n?n.getOptions():{}).parentSpanIsAlwaysRootSpan?_r(i):i}const va={idleTimeout:1e3,finalTimeout:3e4,childSpanTimeout:15e3};function ba(e,t={}){const i=new Map;let n,s=!1,r="externalFinish",a=!t.disableAutoFinish;const o=[],{idleTimeout:c=va.idleTimeout,finalTimeout:l=va.finalTimeout,childSpanTimeout:h=va.childSpanTimeout,beforeSpanEnd:u,trimIdleSpanEndTimestamp:d=!0}=t,p=Ls();if(!p||!Dr()){const e=new Wr;return Gr(e,{sample_rate:"0",sampled:"false",...jr(e)}),e}const m=zs(),g=Ar(),f=function(e){const t=ua(e);return ks(zs(),t),en&&pn.log("[Tracing] Started span is an idle span"),t}(e);function y(){n&&(clearTimeout(n),n=void 0)}function v(e){y(),n=setTimeout(()=>{!s&&0===i.size&&a&&(r="idleTimeout",f.end(e))},c)}function b(e){n=setTimeout(()=>{!s&&a&&(r="heartbeatFailed",f.end(e))},h)}function w(e){s=!0,i.clear(),o.forEach(e=>e()),ks(m,g);const t=Mr(f),{start_timestamp:n}=t;if(!n)return;t.data[Ns]||f.setAttribute(Ns,r),pn.log(`[Tracing] Idle span "${t.op}" finished`);const a=Pr(f).filter(e=>e!==f);let h=0;a.forEach(t=>{t.isRecording()&&(t.setStatus({code:2,message:"cancelled"}),t.end(e),en&&pn.log("[Tracing] Cancelling span since span ended early",JSON.stringify(t,void 0,2)));const i=Mr(t),{timestamp:n=0,start_timestamp:s=0}=i,r=s<=e,a=n-s<=(l+c)/1e3;if(en){const e=JSON.stringify(t,void 0,2);r?a||pn.log("[Tracing] Discarding span since it finished after idle span final timeout",e):pn.log("[Tracing] Discarding span since it happened after idle span was finished",e)}a&&r||(function(e,t){e[Tr]&&e[Tr].delete(t)}(f,t),h++)}),h>0&&f.setAttribute("sentry.idle_span_discarded_spans",h)}return f.end=new Proxy(f.end,{apply(e,t,i){if(u&&u(f),t instanceof Wr)return;const[n,...s]=i,r=wr(n||bs()),a=Pr(f).filter(e=>e!==f),o=Mr(f);if(!a.length||!d)return w(r),Reflect.apply(e,t,[r,...s]);const c=p.getOptions().ignoreSpans,h=a?.reduce((e,t)=>{const i=Mr(t);return i.timestamp?c&&zr(i,c)?e:e?Math.max(e,i.timestamp):i.timestamp:e},void 0),m=o.start_timestamp,g=Math.min(m?m+l/1e3:1/0,Math.max(m||-1/0,Math.min(r,h||1/0)));return w(g),Reflect.apply(e,t,[g,...s])}}),o.push(p.on("spanStart",e=>{var t;s||e===f||Mr(e).timestamp||e instanceof aa&&e.isStandaloneSpan()||Pr(f).includes(e)&&(t=e.spanContext().spanId,y(),i.set(t,!0),b(bs()+h/1e3))})),o.push(p.on("spanEnd",e=>{var t;s||(t=e.spanContext().spanId,i.has(t)&&i.delete(t),0===i.size&&v(bs()+c/1e3))})),o.push(p.on("idleSpanEnableAutoFinish",e=>{e===f&&(a=!0,v(),i.size&&b())})),t.disableAutoFinish||v(),setTimeout(()=>{s||(f.setStatus({code:2,message:"deadline_exceeded"}),r="finalTimeout",f.end())},l),f}function wa(e){return new Ma(t=>{t(e)})}function Sa(e){return new Ma((t,i)=>{i(e)})}class Ma{constructor(e){this._state=0,this._handlers=[],this._runExecutor(e)}then(e,t){return new Ma((i,n)=>{this._handlers.push([!1,t=>{if(e)try{i(e(t))}catch(e){n(e)}else i(t)},e=>{if(t)try{i(t(e))}catch(e){n(e)}else n(e)}]),this._executeHandlers()})}catch(e){return this.then(e=>e,e)}finally(e){return new Ma((t,i)=>{let n,s;return this.then(t=>{s=!1,n=t,e&&e()},t=>{s=!0,n=t,e&&e()}).then(()=>{s?i(n):t(n)})})}_executeHandlers(){if(0===this._state)return;const e=this._handlers.slice();this._handlers=[],e.forEach(e=>{e[0]||(1===this._state&&e[1](this._value),2===this._state&&e[2](this._value),e[0]=!0)})}_runExecutor(e){const t=(e,t)=>{0===this._state&&(jn(t)?t.then(i,n):(this._state=e,this._value=t,this._executeHandlers()))},i=e=>{t(1,e)},n=e=>{t(2,e)};try{e(i,n)}catch(e){n(e)}}}function xa(e,t,i,n=0){try{const s=Ca(t,i,e,n);return jn(s)?s:wa(s)}catch(e){return Sa(e)}}function Ca(e,t,i,n){const s=i[n];if(!e||!s)return e;const r=s({...e},t);return en&&null===r&&pn.log(`Event processor "${s.id||"?"}" dropped event`),jn(r)?r.then(e=>Ca(e,t,i,n+1)):Ca(r,t,i,n+1)}function Ta(e,t){const{extra:i,tags:n,user:s,contexts:r,level:a,sdkProcessingMetadata:o,breadcrumbs:c,fingerprint:l,eventProcessors:h,attachments:u,propagationContext:d,transactionName:p,span:m}=t;ka(e,"extra",i),ka(e,"tags",n),ka(e,"user",s),ka(e,"contexts",r),e.sdkProcessingMetadata=Ms(e.sdkProcessingMetadata,o,2),a&&(e.level=a),p&&(e.transactionName=p),m&&(e.span=m),c.length&&(e.breadcrumbs=[...e.breadcrumbs,...c]),l.length&&(e.fingerprint=[...e.fingerprint,...l]),h.length&&(e.eventProcessors=[...e.eventProcessors,...h]),u.length&&(e.attachments=[...e.attachments,...u]),e.propagationContext={...e.propagationContext,...d}}function ka(e,t,i){e[t]=Ms(e[t],i,1)}let Ea,Pa,_a,Aa;function Ia(e,t,i,n,s,r){const{normalizeDepth:a=3,normalizeMaxBreadth:o=1e3}=e,c={...t,event_id:t.event_id||i.event_id||ds(),timestamp:t.timestamp||vs()},l=i.integrations||e.integrations.map(e=>e.name);!function(e,t){const{environment:i,release:n,dist:s,maxValueLength:r=250}=t;e.environment=e.environment||i||Lr,!e.release&&n&&(e.release=n),!e.dist&&s&&(e.dist=s);const a=e.request;a?.url&&(a.url=Kn(a.url,r))}(c,e),function(e,t){t.length>0&&(e.sdk=e.sdk||{},e.sdk.integrations=[...e.sdk.integrations||[],...t])}(c,l),s&&s.emit("applyFrameMetadata",t),void 0===t.type&&function(e,t){const i=function(e){const t=tn._sentryDebugIds,i=tn._debugIds;if(!t&&!i)return{};const n=t?Object.keys(t):[],s=i?Object.keys(i):[];if(Aa&&n.length===Pa&&s.length===_a)return Aa;Pa=n.length,_a=s.length,Aa={},Ea||(Ea={});const r=(t,i)=>{for(const n of t){const t=i[n],s=Ea?.[n];if(s&&Aa&&t)Aa[s[0]]=t,Ea&&(Ea[n]=[s[0],t]);else if(t){const i=e(n);for(let e=i.length-1;e>=0;e--){const s=i[e],r=s?.filename;if(r&&Aa&&Ea){Aa[r]=t,Ea[n]=[r,t];break}}}}};return t&&r(n,t),i&&r(s,i),Aa}(t);e.exception?.values?.forEach(e=>{e.stacktrace?.frames?.forEach(e=>{e.filename&&(e.debug_id=i[e.filename])})})}(c,e.stackParser);const h=function(e,t){if(!t)return e;const i=e?e.clone():new Ps;return i.update(t),i}(n,i.captureContext);i.mechanism&&fs(c,i.mechanism);const u=s?s.getEventProcessors():[],d=an("globalScope",()=>new Ps).getScopeData();r&&Ta(d,r.getScopeData()),h&&Ta(d,h.getScopeData());const p=[...i.attachments||[],...d.attachments];return p.length&&(i.attachments=p),function(e,t){const{fingerprint:i,span:n,breadcrumbs:s,sdkProcessingMetadata:r}=t;!function(e,t){const{extra:i,tags:n,user:s,contexts:r,level:a,transactionName:o}=t;Object.keys(i).length&&(e.extra={...i,...e.extra}),Object.keys(n).length&&(e.tags={...n,...e.tags}),Object.keys(s).length&&(e.user={...s,...e.user}),Object.keys(r).length&&(e.contexts={...r,...e.contexts}),a&&(e.level=a),o&&"transaction"!==e.type&&(e.transaction=o)}(e,t),n&&function(e,t){e.contexts={trace:vr(t),...e.contexts},e.sdkProcessingMetadata={dynamicSamplingContext:jr(t),...e.sdkProcessingMetadata};const i=Mr(_r(t)).description;i&&!e.transaction&&"transaction"===e.type&&(e.transaction=i)}(e,n),function(e,t){e.fingerprint=e.fingerprint?Array.isArray(e.fingerprint)?e.fingerprint:[e.fingerprint]:[],t&&(e.fingerprint=e.fingerprint.concat(t)),e.fingerprint.length||delete e.fingerprint}(e,i),function(e,t){const i=[...e.breadcrumbs||[],...t];e.breadcrumbs=i.length?i:void 0}(e,s),function(e,t){e.sdkProcessingMetadata={...e.sdkProcessingMetadata,...t}}(e,r)}(c,d),xa([...u,...d.eventProcessors],c,i).then(e=>(e&&function(e){const t={};if(e.exception?.values?.forEach(e=>{e.stacktrace?.frames?.forEach(e=>{e.debug_id&&(e.abs_path?t[e.abs_path]=e.debug_id:e.filename&&(t[e.filename]=e.debug_id),delete e.debug_id)})}),0===Object.keys(t).length)return;e.debug_meta=e.debug_meta||{},e.debug_meta.images=e.debug_meta.images||[];const i=e.debug_meta.images;Object.entries(t).forEach(([e,t])=>{i.push({type:"sourcemap",code_file:e,debug_id:t})})}(e),"number"==typeof a&&a>0?function(e,t,i){if(!e)return null;const n={...e,...e.breadcrumbs&&{breadcrumbs:e.breadcrumbs.map(e=>({...e,...e.data&&{data:Nr(e.data,t,i)}}))},...e.user&&{user:Nr(e.user,t,i)},...e.contexts&&{contexts:Nr(e.contexts,t,i)},...e.extra&&{extra:Nr(e.extra,t,i)}};return e.contexts?.trace&&n.contexts&&(n.contexts.trace=e.contexts.trace,e.contexts.trace.data&&(n.contexts.trace.data=Nr(e.contexts.trace.data,t,i))),e.spans&&(n.spans=e.spans.map(e=>({...e,...e.data&&{data:Nr(e.data,t,i)}}))),e.contexts?.flags&&n.contexts&&(n.contexts.flags=Nr(e.contexts.flags,3,i)),n}(e,a,o):e))}const Ra=["user","level","extra","contexts","tags","fingerprint","propagationContext"];function Da(e,t){return zs().captureException(e,function(e){if(e)return function(e){return e instanceof Ps||"function"==typeof e}(e)||function(e){return Object.keys(e).some(e=>Ra.includes(e))}(e)?{captureContext:e}:e}(t))}function Oa(e,t){return zs().captureEvent(e,t)}function za(e){const t=Bs(),i=zs(),{userAgent:n}=tn.navigator||{},s=function(e){const t=bs(),i={sid:ds(),init:!0,timestamp:t,started:t,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>function(e){return{sid:`${e.sid}`,init:e.init,started:new Date(1e3*e.started).toISOString(),timestamp:new Date(1e3*e.timestamp).toISOString(),status:e.status,errors:e.errors,did:"number"==typeof e.did||"string"==typeof e.did?`${e.did}`:void 0,duration:e.duration,abnormal_mechanism:e.abnormal_mechanism,attrs:{release:e.release,environment:e.environment,ip_address:e.ipAddress,user_agent:e.userAgent}}}(i)};return e&&Ss(i,e),i}({user:i.getUser()||t.getUser(),...n&&{userAgent:n},...e}),r=t.getSession();return"ok"===r?.status&&Ss(r,{status:"exited"}),Ba(),t.setSession(s),s}function Ba(){const e=Bs(),t=zs().getSession()||e.getSession();t&&function(e){let t={};"ok"===e.status&&(t={status:"exited"}),Ss(e,t)}(t),Fa(),e.setSession()}function Fa(){const e=Bs(),t=Ls(),i=e.getSession();i&&t&&t.captureSession(i)}function La(e=!1){e?Ba():Fa()}const qa=[];function Ga(e){const t=e.defaultIntegrations||[],i=e.integrations;let n;if(t.forEach(e=>{e.isDefaultInstance=!0}),Array.isArray(i))n=[...t,...i];else if("function"==typeof i){const e=i(t);n=Array.isArray(e)?e:[e]}else n=t;return function(e){const t={};return e.forEach(e=>{const{name:i}=e,n=t[i];n&&!n.isDefaultInstance&&e.isDefaultInstance||(t[i]=e)}),Object.values(t)}(n)}function $a(e,t){for(const i of t)i?.afterAllSetup&&i.afterAllSetup(e)}function Ha(e,t,i){if(i[t.name])en&&pn.log(`Integration skipped because it was already installed: ${t.name}`);else{if(i[t.name]=t,-1===qa.indexOf(t.name)&&"function"==typeof t.setupOnce&&(t.setupOnce(),qa.push(t.name)),t.setup&&"function"==typeof t.setup&&t.setup(e),"function"==typeof t.preprocessEvent){const i=t.preprocessEvent.bind(t);e.on("preprocessEvent",(t,n)=>i(t,n,e))}if("function"==typeof t.processEvent){const i=t.processEvent.bind(t),n=Object.assign((t,n)=>i(t,n,e),{id:t.name});e.addEventProcessor(n)}en&&pn.log(`Integration installed: ${t.name}`)}}function ja(e,t){const i=t??function(e){return Wa().get(e)}(e)??[];if(0===i.length)return;const n=e.getOptions(),s=function(e,t,i,n){const s={};return t?.sdk&&(s.sdk={name:t.sdk.name,version:t.sdk.version}),i&&n&&(s.dsn=lr(n)),Yr(s,[(r=e,[{type:"log",item_count:r.length,content_type:"application/vnd.sentry.items.log+json"},{items:r}])]);var r}(i,n._metadata,n.tunnel,e.getDsn());Wa().set(e,[]),e.emit("flushLogs"),e.sendEnvelope(s)}function Wa(){return an("clientToLogBufferMap",()=>new WeakMap)}function Na(e,t){const i=t??function(e){return Ua().get(e)}(e)??[];if(0===i.length)return;const n=e.getOptions(),s=function(e,t,i,n){const s={};return t?.sdk&&(s.sdk={name:t.sdk.name,version:t.sdk.version}),i&&n&&(s.dsn=lr(n)),Yr(s,[(r=e,[{type:"trace_metric",item_count:r.length,content_type:"application/vnd.sentry.items.trace-metric+json"},{items:r}])]);var r}(i,n._metadata,n.tunnel,e.getDsn());Ua().set(e,[]),e.emit("flushMetrics"),e.sendEnvelope(s)}function Ua(){return an("clientToMetricBufferMap",()=>new WeakMap)}function Va(e){const t=[];e.message&&t.push(e.message);try{const i=e.exception.values[e.exception.values.length-1];i?.value&&(t.push(i.value),i.type&&t.push(`${i.type}: ${i.value}`))}catch{}return t}const Ya="Not capturing exception because it's already been captured.",Xa="Discarded session because of missing or non-string release",Qa=Symbol.for("SentryInternalError"),Ja=Symbol.for("SentryDoNotSendEventError");function Ka(e){return{message:e,[Qa]:!0}}function Za(e){return{message:e,[Ja]:!0}}function eo(e){return!!e&&"object"==typeof e&&Qa in e}function to(e){return!!e&&"object"==typeof e&&Ja in e}function io(e,t,i,n,s){let r,a=0;e.on(i,()=>{a=0,clearTimeout(r)}),e.on(t,t=>{a+=n(t),a>=8e5?s(e):(clearTimeout(r),r=setTimeout(()=>{s(e)},5e3))}),e.on("flush",()=>{s(e)})}class no{constructor(e){if(this._options=e,this._integrations={},this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],e.dsn?this._dsn=function(e){const t="string"==typeof e?function(e){const t=cr.exec(e);if(!t)return void ln(()=>{console.error(`Invalid Sentry Dsn: ${e}`)});const[i,n,s="",r="",a="",o=""]=t.slice(1);let c="",l=o;const h=l.split("/");if(h.length>1&&(c=h.slice(0,-1).join("/"),l=h.pop()),l){const e=l.match(/^\d+/);e&&(l=e[0])}return hr({host:r,pass:s,path:c,projectId:l,port:a,protocol:i,publicKey:n})}(e):hr(e);if(t&&function(e){if(!en)return!0;const{port:t,projectId:i,protocol:n}=e;return!(["protocol","publicKey","host","projectId"].find(t=>!e[t]&&(pn.error(`Invalid Sentry Dsn: ${t} missing`),!0))||(i.match(/^\d+$/)?function(e){return"http"===e||"https"===e}(n)?t&&isNaN(parseInt(t,10))&&(pn.error(`Invalid Sentry Dsn: Invalid port ${t}`),1):(pn.error(`Invalid Sentry Dsn: Invalid protocol ${n}`),1):(pn.error(`Invalid Sentry Dsn: Invalid projectId ${i}`),1)))}(t))return t}(e.dsn):en&&pn.warn("No DSN provided, client will not send events."),this._dsn){const s=(t=this._dsn,i=e.tunnel,n=e._metadata?e._metadata.sdk:void 0,i||`${function(e){return`${function(e){const t=e.protocol?`${e.protocol}:`:"",i=e.port?`:${e.port}`:"";return`${t}//${e.host}${i}${e.path?`/${e.path}`:""}/api/`}(e)}${e.projectId}/envelope/`}(t)}?${function(e,t){const i={sentry_version:"7"};return e.publicKey&&(i.sentry_key=e.publicKey),t&&(i.sentry_client=`${t.name}/${t.version}`),new URLSearchParams(i).toString()}(t,n)}`);this._transport=e.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:s})}var t,i,n;this._options.enableLogs&&io(this,"afterCaptureLog","flushLogs",oo,ja),this._options._experiments?.enableMetrics&&io(this,"afterCaptureMetric","flushMetrics",ao,Na)}captureException(e,t,i){const n=ds();if(ys(e))return en&&pn.log(Ya),n;const s={event_id:n,...t};return this._process(this.eventFromException(e,s).then(e=>this._captureEvent(e,s,i))),s.event_id}captureMessage(e,t,i,n){const s={event_id:ds(),...i},r=qn(e)?e:String(e),a=Gn(e)?this.eventFromMessage(r,t,s):this.eventFromException(e,s);return this._process(a.then(e=>this._captureEvent(e,s,n))),s.event_id}captureEvent(e,t,i){const n=ds();if(t?.originalException&&ys(t.originalException))return en&&pn.log(Ya),n;const s={event_id:n,...t},r=e.sdkProcessingMetadata||{},a=r.capturedSpanScope,o=r.capturedSpanIsolationScope;return this._process(this._captureEvent(e,s,a||i,o)),s.event_id}captureSession(e){this.sendSession(e),Ss(e,{init:!1})}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}async flush(e){const t=this._transport;if(!t)return!0;this.emit("flush");const i=await this._isClientDoneProcessing(e),n=await t.flush(e);return i&&n}async close(e){const t=await this.flush(e);return this.getOptions().enabled=!1,this.emit("close"),t}getEventProcessors(){return this._eventProcessors}addEventProcessor(e){this._eventProcessors.push(e)}init(){(this._isEnabled()||this._options.integrations.some(({name:e})=>e.startsWith("Spotlight")))&&this._setupIntegrations()}getIntegrationByName(e){return this._integrations[e]}addIntegration(e){const t=this._integrations[e.name];Ha(this,e,this._integrations),t||$a(this,[e])}sendEvent(e,t={}){this.emit("beforeSendEvent",e,t);let i=function(e,t,i,n){const s=na(i),r=e.type&&"replay_event"!==e.type?e.type:"event";!function(e,t){if(!t)return e;const i=e.sdk||{};e.sdk={...i,name:i.name||t.name,version:i.version||t.version,integrations:[...e.sdk?.integrations||[],...t.integrations||[]],packages:[...e.sdk?.packages||[],...t.packages||[]],settings:e.sdk?.settings||t.settings?{...e.sdk?.settings,...t.settings}:void 0}}(e,i?.sdk);const a=sa(e,s,n,t);return delete e.sdkProcessingMetadata,Yr(a,[[{type:r},e]])}(e,this._dsn,this._options._metadata,this._options.tunnel);for(const e of t.attachments||[])i=Xr(i,ea(e));this.sendEnvelope(i).then(t=>this.emit("afterSendEvent",e,t))}sendSession(e){const{release:t,environment:i=Lr}=this._options;if("aggregates"in e){const n=e.attrs||{};if(!n.release&&!t)return void(en&&pn.warn(Xa));n.release=n.release||t,n.environment=n.environment||i,e.attrs=n}else{if(!e.release&&!t)return void(en&&pn.warn(Xa));e.release=e.release||t,e.environment=e.environment||i}this.emit("beforeSendSession",e);const n=function(e,t,i,n){const s=na(i);return Yr({sent_at:(new Date).toISOString(),...s&&{sdk:s},...!!n&&t&&{dsn:lr(t)}},["aggregates"in e?[{type:"sessions"},e]:[{type:"session"},e.toJSON()]])}(e,this._dsn,this._options._metadata,this._options.tunnel);this.sendEnvelope(n)}recordDroppedEvent(e,t,i=1){if(this._options.sendClientReports){const n=`${e}:${t}`;en&&pn.log(`Recording outcome: "${n}"${i>1?` (${i} times)`:""}`),this._outcomes[n]=(this._outcomes[n]||0)+i}}on(e,t){const i=this._hooks[e]=this._hooks[e]||new Set,n=(...e)=>t(...e);return i.add(n),()=>{i.delete(n)}}emit(e,...t){const i=this._hooks[e];i&&i.forEach(e=>e(...t))}async sendEnvelope(e){if(this.emit("beforeEnvelope",e),this._isEnabled()&&this._transport)try{return await this._transport.send(e)}catch(e){return en&&pn.error("Error while sending envelope:",e),{}}return en&&pn.error("Transport disabled"),{}}_setupIntegrations(){const{integrations:e}=this._options;this._integrations=function(e,t){const i={};return t.forEach(t=>{t&&Ha(e,t,i)}),i}(this,e),$a(this,e)}_updateSessionFromEvent(e,t){let i="fatal"===t.level,n=!1;const s=t.exception?.values;if(s){n=!0;for(const e of s){const t=e.mechanism;if(!1===t?.handled){i=!0;break}}}const r="ok"===e.status;(r&&0===e.errors||r&&i)&&(Ss(e,{...i&&{status:"crashed"},errors:e.errors||Number(n||i)}),this.captureSession(e))}async _isClientDoneProcessing(e){let t=0;for(;!e||t<e;){if(await new Promise(e=>setTimeout(e,1)),!this._numProcessing)return!0;t++}return!1}_isEnabled(){return!1!==this.getOptions().enabled&&void 0!==this._transport}_prepareEvent(e,t,i,n){const s=this.getOptions(),r=Object.keys(this._integrations);return!t.integrations&&r?.length&&(t.integrations=r),this.emit("preprocessEvent",e,t),e.type||n.setLastEventId(e.event_id||t.event_id),Ia(s,e,t,i,this,n).then(e=>{if(null===e)return e;this.emit("postprocessEvent",e,t),e.contexts={trace:qs(i),...e.contexts};const n=Hr(this,i);return e.sdkProcessingMetadata={dynamicSamplingContext:n,...e.sdkProcessingMetadata},e})}_captureEvent(e,t={},i=zs(),n=Bs()){return en&&so(e)&&pn.log(`Captured error event \`${Va(e)[0]||"<unknown>"}\``),this._processEvent(e,t,i,n).then(e=>e.event_id,e=>{en&&(to(e)?pn.log(e.message):eo(e)?pn.warn(e.message):pn.warn(e))})}_processEvent(e,t,i,n){const s=this.getOptions(),{sampleRate:r}=s,a=ro(e),o=so(e),c=e.type||"error",l=`before send for type \`${c}\``,h=void 0===r?void 0:dr(r);if(o&&"number"==typeof h&&Math.random()>h)return this.recordDroppedEvent("sample_rate","error"),Sa(Za(`Discarding event because it's not included in the random sample (sampling rate = ${r})`));const u="replay_event"===c?"replay":c;return this._prepareEvent(e,t,i,n).then(e=>{if(null===e)throw this.recordDroppedEvent("event_processor",u),Za("An event processor returned `null`, will not send event.");if(t.data&&!0===t.data.__sentry__)return e;const i=function(e,t,i,n){const{beforeSend:s,beforeSendTransaction:r,beforeSendSpan:a,ignoreSpans:o}=t;let c=i;if(so(c)&&s)return s(c,n);if(ro(c)){if(a||o){const t=function(e){const{trace_id:t,parent_span_id:i,span_id:n,status:s,origin:r,data:a,op:o}=e.contexts?.trace??{};return{data:a??{},description:e.transaction,op:o,parent_span_id:i,span_id:n??"",start_timestamp:e.start_timestamp??0,status:s,timestamp:e.timestamp,trace_id:t??"",origin:r,profile_id:a?.[Xs],exclusive_time:a?.[Qs],measurements:e.measurements,is_segment:!0}}(c);if(o?.length&&zr(t,o))return null;if(a){const e=a(t);e?c=Ms(i,{type:"transaction",timestamp:(l=e).timestamp,start_timestamp:l.start_timestamp,transaction:l.description,contexts:{trace:{trace_id:l.trace_id,span_id:l.span_id,parent_span_id:l.parent_span_id,op:l.op,status:l.status,origin:l.origin,data:{...l.data,...l.profile_id&&{[Xs]:l.profile_id},...l.exclusive_time&&{[Qs]:l.exclusive_time}}}},measurements:l.measurements}):Ir()}if(c.spans){const t=[],i=c.spans;for(const e of i)if(o?.length&&zr(e,o))Br(i,e);else if(a){const i=a(e);i?t.push(i):(Ir(),t.push(e))}else t.push(e);const n=c.spans.length-t.length;n&&e.recordDroppedEvent("before_send","span",n),c.spans=t}}if(r){if(c.spans){const e=c.spans.length;c.sdkProcessingMetadata={...i.sdkProcessingMetadata,spanCountBeforeProcessing:e}}return r(c,n)}}var l;return c}(this,s,e,t);return function(e,t){const i=`${t} must return \`null\` or a valid event.`;if(jn(e))return e.then(e=>{if(!$n(e)&&null!==e)throw Ka(i);return e},e=>{throw Ka(`${t} rejected with ${e}`)});if(!$n(e)&&null!==e)throw Ka(i);return e}(i,l)}).then(s=>{if(null===s){if(this.recordDroppedEvent("before_send",u),a){const t=1+(e.spans||[]).length;this.recordDroppedEvent("before_send","span",t)}throw Za(`${l} returned \`null\`, will not send event.`)}const r=i.getSession()||n.getSession();if(o&&r&&this._updateSessionFromEvent(r,s),a){const e=(s.sdkProcessingMetadata?.spanCountBeforeProcessing||0)-(s.spans?s.spans.length:0);e>0&&this.recordDroppedEvent("before_send","span",e)}const c=s.transaction_info;if(a&&c&&s.transaction!==e.transaction){const e="custom";s.transaction_info={...c,source:e}}return this.sendEvent(s,t),s}).then(null,e=>{if(to(e)||eo(e))throw e;throw this.captureException(e,{mechanism:{handled:!1,type:"internal"},data:{__sentry__:!0},originalException:e}),Ka(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.\nReason: ${e}`)})}_process(e){this._numProcessing++,e.then(e=>(this._numProcessing--,e),e=>(this._numProcessing--,e))}_clearOutcomes(){const e=this._outcomes;return this._outcomes={},Object.entries(e).map(([e,t])=>{const[i,n]=e.split(":");return{reason:i,category:n,quantity:t}})}_flushOutcomes(){en&&pn.log("Flushing outcomes...");const e=this._clearOutcomes();if(0===e.length)return void(en&&pn.log("No outcomes to send"));if(!this._dsn)return void(en&&pn.log("No dsn provided, will not send outcomes"));en&&pn.log("Sending outcomes:",e);const t=(i=e,Yr((n=this._options.tunnel&&lr(this._dsn))?{dsn:n}:{},[[{type:"client_report"},{timestamp:vs(),discarded_events:i}]]));var i,n;this.sendEnvelope(t)}}function so(e){return void 0===e.type}function ro(e){return"transaction"===e.type}function ao(e){let t=0;return e.name&&(t+=2*e.name.length),"string"==typeof e.value?t+=2*e.value.length:t+=8,t+co(e.attributes)}function oo(e){let t=0;return e.message&&(t+=2*e.message.length),t+co(e.attributes)}function co(e){if(!e)return 0;let t=0;return Object.values(e).forEach(e=>{Array.isArray(e)?t+=e.length*lo(e[0]):Gn(e)?t+=lo(e):t+=100}),t}function lo(e){return"string"==typeof e?2*e.length:"number"==typeof e?8:"boolean"==typeof e?4:0}const ho=Symbol.for("SentryBufferFullError");function uo(e,t,i=Date.now()){return function(e,t){return e[t]||e.all||0}(e,t)>i}function po(e,{statusCode:t,headers:i},n=Date.now()){const s={...e},r=i?.["x-sentry-rate-limits"],a=i?.["retry-after"];if(r)for(const e of r.trim().split(",")){const[t,i,,,r]=e.split(":",5),a=parseInt(t,10),o=1e3*(isNaN(a)?60:a);if(i)for(const e of i.split(";"))"metric_bucket"===e&&r&&!r.split(";").includes("custom")||(s[e]=n+o);else s.all=n+o}else a?s.all=n+function(e,t=Date.now()){const i=parseInt(`${e}`,10);if(!isNaN(i))return 1e3*i;const n=Date.parse(`${e}`);return isNaN(n)?6e4:n-t}(a,n):429===t&&(s.all=n+6e4);return s}function mo(e){return"isRelative"in e}function go(e,t){const i=e.indexOf("://")<=0&&0!==e.indexOf("//"),n=i?"thismessage:/":void 0;try{if("canParse"in URL&&!URL.canParse(e,n))return;const t=new URL(e,n);return i?{isRelative:i,pathname:t.pathname,search:t.search,hash:t.hash}:t}catch{}}function fo(e){if(mo(e))return e.pathname;const t=new URL(e);return t.search="",t.hash="",["80","443"].includes(t.port)&&(t.port=""),t.password&&(t.password="%filtered%"),t.username&&(t.username="%filtered%"),t.toString()}function yo(e){if(!e)return{};const t=e.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const i=t[6]||"",n=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],search:i,hash:n,relative:t[5]+i+n}}function vo(e){return"/"===e[e.length-1]?e.slice(0,-1):e}function bo(e){"aggregates"in e?void 0===e.attrs?.ip_address&&(e.attrs={...e.attrs,ip_address:"{{auto}}"}):void 0===e.ipAddress&&(e.ipAddress="{{auto}}")}function wo(e={}){const t=e.client||Ls();if(!function(){const e=Ls();return!1!==e?.getOptions().enabled&&!!e?.getTransport()}()||!t)return{};const i=Os(sn());if(i.getTraceData)return i.getTraceData(e);const n=e.scope||zs(),s=e.span||Ar(),r=s?function(e){const{traceId:t,spanId:i}=e.spanContext();return mr(t,i,xr(e))}(s):function(e){const{traceId:t,sampled:i,propagationSpanId:n}=e.getPropagationContext();return mr(t,n,i)}(n),a=function(e){if(e)return function(e){if(0!==Object.keys(e).length)return Object.entries(e).reduce((e,[t,i],n)=>{const s=`${encodeURIComponent(t)}=${encodeURIComponent(i)}`,r=0===n?s:`${e},${s}`;return r.length>8192?(en&&pn.warn(`Not adding key: ${t} with val: ${i} to baggage header due to exceeding baggage size limits.`),e):r},"")}(Object.entries(e).reduce((e,[t,i])=>(i&&(e[`${nr}${t}`]=i),e),{}))}(s?jr(s):Hr(t,n));if(!pr.test(r))return pn.warn("Invalid sentry-trace data. Cannot generate trace data"),{};const o={"sentry-trace":r,baggage:a};if(e.propagateTraceparent){const e=s?function(e){const{traceId:t,spanId:i}=e.spanContext();return gr(t,i,xr(e))}(s):function(e){const{traceId:t,sampled:i,propagationSpanId:n}=e.getPropagationContext();return gr(t,n,i)}(n);e&&(o.traceparent=e)}return o}const So=100;function Mo(e,t){const i=Ls(),n=Bs();if(!i)return;const{beforeBreadcrumb:s=null,maxBreadcrumbs:r=So}=i.getOptions();if(r<=0)return;const a={timestamp:vs(),...e},o=s?ln(()=>s(a,t)):a;null!==o&&(i.emit&&i.emit("beforeAddBreadcrumb",o,t),n.addBreadcrumb(o,r))}let xo;const Co=new WeakMap,To=()=>({name:"FunctionToString",setupOnce(){xo=function(){}.toString;try{Function.prototype.toString=function(...e){const t=rs(this),i=Co.has(Ls())&&void 0!==t?t:this;return xo.apply(i,e)}}catch{}},setup(e){Co.set(e,!0)}}),ko=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/,/^Can't find variable: gmo$/,/^undefined is not an object \(evaluating 'a\.[A-Z]'\)$/,'can\'t redefine non-configurable property "solana"',"vv().getRestrictions is not a function. (In 'vv().getRestrictions(1,a)', 'vv().getRestrictions' is undefined)","Can't find variable: _AutofillCallbackHandler",/^Non-Error promise rejection captured with value: Object Not Found Matching Id:\d+, MethodName:simulateEvent, ParamCount:\d+$/,/^Java exception was raised during method invocation$/],Eo=(e={})=>{let t;return{name:"EventFilters",setup(i){const n=i.getOptions();t=_o(e,n)},processEvent(i,n,s){if(!t){const i=s.getOptions();t=_o(e,i)}return function(e,t){if(e.type){if("transaction"===e.type&&function(e,t){if(!t?.length)return!1;const i=e.transaction;return!!i&&ts(i,t)}(e,t.ignoreTransactions))return en&&pn.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.\nEvent: ${ms(e)}`),!0}else{if(function(e,t){return!!t?.length&&Va(e).some(e=>ts(e,t))}(e,t.ignoreErrors))return en&&pn.warn(`Event dropped due to being matched by \`ignoreErrors\` option.\nEvent: ${ms(e)}`),!0;if(function(e){return!!e.exception?.values?.length&&(!e.message&&!e.exception.values.some(e=>e.stacktrace||e.type&&"Error"!==e.type||e.value))}(e))return en&&pn.warn(`Event dropped due to not having an error message, error type or stacktrace.\nEvent: ${ms(e)}`),!0;if(function(e,t){if(!t?.length)return!1;const i=Ao(e);return!!i&&ts(i,t)}(e,t.denyUrls))return en&&pn.warn(`Event dropped due to being matched by \`denyUrls\` option.\nEvent: ${ms(e)}.\nUrl: ${Ao(e)}`),!0;if(!function(e,t){if(!t?.length)return!0;const i=Ao(e);return!i||ts(i,t)}(e,t.allowUrls))return en&&pn.warn(`Event dropped due to not being matched by \`allowUrls\` option.\nEvent: ${ms(e)}.\nUrl: ${Ao(e)}`),!0}return!1}(i,t)?null:i}}},Po=(e={})=>({...Eo(e),name:"InboundFilters"});function _o(e={},t={}){return{allowUrls:[...e.allowUrls||[],...t.allowUrls||[]],denyUrls:[...e.denyUrls||[],...t.denyUrls||[]],ignoreErrors:[...e.ignoreErrors||[],...t.ignoreErrors||[],...e.disableErrorDefaults?[]:ko],ignoreTransactions:[...e.ignoreTransactions||[],...t.ignoreTransactions||[]]}}function Ao(e){try{const t=[...e.exception?.values??[]].reverse().find(e=>void 0===e.mechanism?.parent_id&&e.stacktrace?.frames?.length),i=t?.stacktrace?.frames;return i?function(e=[]){for(let t=e.length-1;t>=0;t--){const i=e[t];if(i&&"<anonymous>"!==i.filename&&"[native code]"!==i.filename)return i.filename||null}return null}(i):null}catch{return en&&pn.error(`Cannot extract url for event ${ms(e)}`),null}}function Io(e,t,i,n,s,r){if(!s.exception?.values||!r||!Wn(r.originalException,Error))return;const a=s.exception.values.length>0?s.exception.values[s.exception.values.length-1]:void 0;a&&(s.exception.values=Ro(e,t,n,r.originalException,i,s.exception.values,a,0))}function Ro(e,t,i,n,s,r,a,o){if(r.length>=i+1)return r;let c=[...r];if(Wn(n[s],Error)){Do(a,o);const r=e(t,n[s]),l=c.length;Oo(r,s,l,o),c=Ro(e,t,i,n[s],s,[r,...c],r,l)}return Array.isArray(n.errors)&&n.errors.forEach((n,r)=>{if(Wn(n,Error)){Do(a,o);const l=e(t,n),h=c.length;Oo(l,`errors[${r}]`,h,o),c=Ro(e,t,i,n,s,[l,...c],l,h)}}),c}function Do(e,t){e.mechanism={handled:!0,type:"auto.core.linked_errors",...e.mechanism,..."AggregateError"===e.type&&{is_exception_group:!0},exception_id:t}}function Oo(e,t,i,n){e.mechanism={handled:!0,...e.mechanism,type:"chained",source:t,exception_id:i,parent_id:n}}function zo(){"console"in tn&&on.forEach(function(e){e in tn.console&&is(tn.console,e,function(t){return cn[e]=t,function(...t){kn("console",{args:t,level:e});const i=cn[e];i?.apply(tn.console,t)}})})}function Bo(e){return"warn"===e?"warning":["fatal","error","warning","log","info","debug"].includes(e)?e:"log"}const Fo=()=>{let e;return{name:"Dedupe",processEvent(t){if(t.type)return t;try{if(function(e,t){return!!t&&(!!function(e,t){const i=e.message,n=t.message;return!(!i&&!n)&&(!(i&&!n||!i&&n)&&(i===n&&(!!qo(e,t)&&!!Lo(e,t))))}(e,t)||!!function(e,t){const i=Go(t),n=Go(e);return!(!i||!n)&&(i.type===n.type&&i.value===n.value&&(!!qo(e,t)&&!!Lo(e,t)))}(e,t))}(t,e))return en&&pn.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return e=t}}};function Lo(e,t){let i=Sn(e),n=Sn(t);if(!i&&!n)return!0;if(i&&!n||!i&&n)return!1;if(n.length!==i.length)return!1;for(let e=0;e<n.length;e++){const t=n[e],s=i[e];if(t.filename!==s.filename||t.lineno!==s.lineno||t.colno!==s.colno||t.function!==s.function)return!1}return!0}function qo(e,t){let i=e.fingerprint,n=t.fingerprint;if(!i&&!n)return!0;if(i&&!n||!i&&n)return!1;try{return!(i.join("")!==n.join(""))}catch{return!1}}function Go(e){return e.exception?.values?.[0]}function $o(e){return e.split(",").some(e=>e.trim().startsWith(nr))}function Ho(e,t,i,n){const s={url:e,type:"fetch","http.method":i,[Ws]:n,[js]:"http.client"};return t&&(mo(t)||(s["http.url"]=t.href,s["server.address"]=t.host),t.search&&(s["http.query"]=t.search),t.hash&&(s["http.fragment"]=t.hash)),s}function jo(e){return void 0===e?void 0:e>=400&&e<500?"warning":e>=500?"error":void 0}const Wo=tn;function No(e){return e&&/^function\s+\w+\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString())}function Uo(e,t){const i="fetch";Cn(i,e),Tn(i,()=>Vo(void 0,t))}function Vo(e,t=!1){t&&!function(){if("string"==typeof EdgeRuntime)return!0;if(!function(){if(!("fetch"in Wo))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}())return!1;if(No(Wo.fetch))return!0;let e=!1;const t=Wo.document;if(t&&"function"==typeof t.createElement)try{const i=t.createElement("iframe");i.hidden=!0,t.head.appendChild(i),i.contentWindow?.fetch&&(e=No(i.contentWindow.fetch)),t.head.removeChild(i)}catch(e){en&&pn.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",e)}return e}()||is(tn,"fetch",function(t){return function(...i){const n=new Error,{method:s,url:r}=function(e){if(0===e.length)return{method:"GET",url:""};if(2===e.length){const[t,i]=e;return{url:Qo(t),method:Xo(i,"method")?String(i.method).toUpperCase():"GET"}}const t=e[0];return{url:Qo(t),method:Xo(t,"method")?String(t.method).toUpperCase():"GET"}}(i),a={args:i,fetchData:{method:s,url:r},startTimestamp:1e3*bs(),virtualError:n,headers:Jo(i)};return e||kn("fetch",{...a}),t.apply(tn,i).then(async t=>(e?e(t):kn("fetch",{...a,endTimestamp:1e3*bs(),response:t}),t),e=>{if(kn("fetch",{...a,endTimestamp:1e3*bs(),error:e}),On(e)&&void 0===e.stack&&(e.stack=n.stack,ns(e,"framesToPop",1)),e instanceof TypeError&&("Failed to fetch"===e.message||"Load failed"===e.message||"NetworkError when attempting to fetch resource."===e.message))try{const t=new URL(a.fetchData.url);e.message=`${e.message} (${t.host})`}catch{}throw e})}})}function Yo(e){let t;try{t=e.clone()}catch{return}!async function(e,t){if(e?.body){const i=e.body,n=i.getReader(),s=setTimeout(()=>{i.cancel().then(null,()=>{})},9e4);let r=!0;for(;r;){let e;try{e=setTimeout(()=>{i.cancel().then(null,()=>{})},5e3);const{done:s}=await n.read();clearTimeout(e),s&&(t(),r=!1)}catch{r=!1}finally{clearTimeout(e)}}clearTimeout(s),n.releaseLock(),i.cancel().then(null,()=>{})}}(t,()=>{kn("fetch-body-resolved",{endTimestamp:1e3*bs(),response:e})})}function Xo(e,t){return!!e&&"object"==typeof e&&!!e[t]}function Qo(e){return"string"==typeof e?e:e?Xo(e,"url")?e.url:e.toString?e.toString():"":""}function Jo(e){const[t,i]=e;try{if("object"==typeof i&&null!==i&&"headers"in i&&i.headers)return new Headers(i.headers);if(Un(t))return new Headers(t.headers)}catch{}}function Ko(){return"undefined"!=typeof window&&(!(("undefined"==typeof __SENTRY_BROWSER_BUNDLE__||!__SENTRY_BROWSER_BUNDLE__)&&"[object process]"==={}.toString.call("undefined"!=typeof process?process:0))||function(){const e=tn.process;return"renderer"===e?.type}())}const Zo=tn;let ec=0;function tc(){return ec>0}function ic(e,t={}){if(!function(e){return"function"==typeof e}(e))return e;try{const t=e.__sentry_wrapped__;if(t)return"function"==typeof t?t:e;if(rs(e))return e}catch{return e}const i=function(...i){try{const n=i.map(e=>ic(e,t));return e.apply(this,n)}catch(e){throw ec++,setTimeout(()=>{ec--}),Fs(n=>{n.addEventProcessor(e=>(t.mechanism&&(gs(e,void 0),fs(e,t.mechanism)),e.extra={...e.extra,arguments:i},e)),Da(e)}),e}};try{for(const t in e)({}).hasOwnProperty.call(e,t)&&(i[t]=e[t])}catch{}ss(i,e),ns(e,"__sentry_wrapped__",i);try{Object.getOwnPropertyDescriptor(i,"name").configurable&&Object.defineProperty(i,"name",{get:()=>e.name})}catch{}return i}function nc(){const e=Qn(),{referrer:t}=Zo.document||{},{userAgent:i}=Zo.navigator||{};return{url:e,headers:{...t&&{Referer:t},...i&&{"User-Agent":i}}}}function sc(e,t){const i=ac(e,t),n={type:lc(t),value:hc(t)};return i.length&&(n.stacktrace={frames:i}),void 0===n.type&&""===n.value&&(n.value="Unrecoverable error caught"),n}function rc(e,t){return{exception:{values:[sc(e,t)]}}}function ac(e,t){const i=t.stacktrace||t.stack||"",n=function(e){return e&&oc.test(e.message)?1:0}(t),s=function(e){return"number"==typeof e.framesToPop?e.framesToPop:0}(t);try{return e(i,n,s)}catch{}return[]}const oc=/Minified React error #\d+;/i;function cc(e){return"undefined"!=typeof WebAssembly&&void 0!==WebAssembly.Exception&&e instanceof WebAssembly.Exception}function lc(e){const t=e?.name;return!t&&cc(e)?e.message&&Array.isArray(e.message)&&2==e.message.length?e.message[0]:"WebAssembly.Exception":t}function hc(e){const t=e?.message;return cc(e)?Array.isArray(e.message)&&2==e.message.length?e.message[1]:"wasm exception":t?t.error&&"string"==typeof t.error.message?t.error.message:t:"No error message"}function uc(e,t,i,n,s){let r;if(Bn(t)&&t.error)return rc(e,t.error);if(Fn(t)||zn(t,"DOMException")){const s=t;if("stack"in t)r=rc(e,t);else{const t=s.name||(Fn(s)?"DOMError":"DOMException"),a=s.message?`${t}: ${s.message}`:t;r=dc(e,a,i,n),gs(r,a)}return"code"in s&&(r.tags={...r.tags,"DOMException.code":`${s.code}`}),r}return On(t)?rc(e,t):$n(t)||Hn(t)?(r=function(e,t,i,n){const s=Ls(),r=s?.getOptions().normalizeDepth,a=function(e){for(const t in e)if({}.hasOwnProperty.call(e,t)){const i=e[t];if(i instanceof Error)return i}}(t),o={__serialized__:Ur(t,r)};if(a)return{exception:{values:[sc(e,a)]},extra:o};const c={exception:{values:[{type:Hn(t)?t.constructor.name:n?"UnhandledRejection":"Error",value:pc(t,{isUnhandledRejection:n})}]},extra:o};if(i){const t=ac(e,i);t.length&&(c.exception.values[0].stacktrace={frames:t})}return c}(e,t,i,s),fs(r,{synthetic:!0}),r):(r=dc(e,t,i,n),gs(r,`${t}`),fs(r,{synthetic:!0}),r)}function dc(e,t,i,n){const s={};if(n&&i){const n=ac(e,i);n.length&&(s.exception={values:[{value:t,stacktrace:{frames:n}}]}),fs(s,{synthetic:!0})}if(qn(t)){const{__sentry_template_string__:e,__sentry_template_values__:i}=t;return s.logentry={message:e,params:i},s}return s.message=t,s}function pc(e,{isUnhandledRejection:t}){const i=function(e,t=40){const i=Object.keys(as(e));i.sort();const n=i[0];if(!n)return"[object has no keys]";if(n.length>=t)return Kn(n,t);for(let e=i.length;e>0;e--){const n=i.slice(0,e).join(", ");if(!(n.length>t))return e===i.length?n:Kn(n,t)}return""}(e),n=t?"promise rejection":"exception";return Bn(e)?`Event \`ErrorEvent\` captured as ${n} with message \`${e.message}\``:Hn(e)?`Event \`${function(e){try{const t=Object.getPrototypeOf(e);return t?t.constructor.name:void 0}catch{}}(e)}\` (type=${e.type}) captured as ${n}`:`Object captured as ${n} with keys: ${i}`}class mc extends no{constructor(e){const t=(i=e,{release:"string"==typeof __SENTRY_RELEASE__?__SENTRY_RELEASE__:Zo.SENTRY_RELEASE?.id,sendClientReports:!0,parentSpanIsAlwaysRootSpan:!0,...i});var i;!function(e,t,i=[t],n="npm"){const s=e._metadata||{};s.sdk||(s.sdk={name:`sentry.javascript.${t}`,packages:i.map(e=>({name:`${n}:@sentry/${e}`,version:nn})),version:nn}),e._metadata=s}(t,"browser",["browser"],Zo.SENTRY_SDK_SOURCE||"npm"),t._metadata?.sdk&&(t._metadata.sdk.settings={infer_ip:t.sendDefaultPii?"auto":"never",...t._metadata.sdk.settings}),super(t);const{sendDefaultPii:n,sendClientReports:s,enableLogs:r,_experiments:a}=this._options;Zo.document&&(s||r||a?.enableMetrics)&&Zo.document.addEventListener("visibilitychange",()=>{"hidden"===Zo.document.visibilityState&&(s&&this._flushOutcomes(),r&&ja(this),a?.enableMetrics&&Na(this))}),n&&this.on("beforeSendSession",bo)}eventFromException(e,t){return function(e,t,i,n){const s=uc(e,t,i?.syntheticException||void 0,n);return fs(s),s.level="error",i?.event_id&&(s.event_id=i.event_id),wa(s)}(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",i){return function(e,t,i="info",n,s){const r=dc(e,t,n?.syntheticException||void 0,s);return r.level=i,n?.event_id&&(r.event_id=n.event_id),wa(r)}(this._options.stackParser,e,t,i,this._options.attachStacktrace)}_prepareEvent(e,t,i,n){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,i,n)}}const gc="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,fc=tn,yc=(e,t,i,n)=>{let s,r;return a=>{t.value>=0&&(a||n)&&(r=t.value-(s??0),(r||void 0===s)&&(s=t.value,t.delta=r,t.rating=((e,t)=>e>t[1]?"poor":e>t[0]?"needs-improvement":"good")(t.value,i),e(t)))}},vc=(e=!0)=>{const t=fc.performance?.getEntriesByType?.("navigation")[0];if(!e||t&&t.responseStart>0&&t.responseStart<performance.now())return t},bc=()=>{const e=vc();return e?.activationStart??0},wc=(e,t=-1)=>{const i=vc();let n="navigate";return i&&(fc.document?.prerendering||bc()>0?n="prerender":fc.document?.wasDiscarded?n="restore":i.type&&(n=i.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},Sc=new WeakMap;function Mc(e,t){return Sc.get(e)||Sc.set(e,new t),Sc.get(e)}class xc{constructor(){xc.prototype.__init.call(this),xc.prototype.__init2.call(this)}__init(){this._sessionValue=0}__init2(){this._sessionEntries=[]}_processEntry(e){if(e.hadRecentInput)return;const t=this._sessionEntries[0],i=this._sessionEntries[this._sessionEntries.length-1];this._sessionValue&&t&&i&&e.startTime-i.startTime<1e3&&e.startTime-t.startTime<5e3?(this._sessionValue+=e.value,this._sessionEntries.push(e)):(this._sessionValue=e.value,this._sessionEntries=[e]),this._onAfterProcessingUnexpectedShift?.(e)}}const Cc=(e,t,i={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){const n=new PerformanceObserver(e=>{Promise.resolve().then(()=>{t(e.getEntries())})});return n.observe({type:e,buffered:!0,...i}),n}}catch{}},Tc=e=>{let t=!1;return()=>{t||(e(),t=!0)}};let kc=-1;const Ec=e=>{"hidden"===fc.document.visibilityState&&kc>-1&&(kc="visibilitychange"===e.type?e.timeStamp:0,Pc())},Pc=()=>{removeEventListener("visibilitychange",Ec,!0),removeEventListener("prerenderingchange",Ec,!0)},_c=()=>{if(fc.document&&kc<0){const e=bc(),t=fc.document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter(t=>"hidden"===t.name&&t.startTime>e)[0]?.startTime;kc=t??("hidden"!==fc.document?.visibilityState||fc.document?.prerendering?1/0:0),addEventListener("visibilitychange",Ec,!0),addEventListener("prerenderingchange",Ec,!0)}return{get firstHiddenTime(){return kc}}},Ac=e=>{fc.document?.prerendering?addEventListener("prerenderingchange",()=>e(),!0):e()},Ic=[1800,3e3],Rc=[.1,.25];let Dc=0,Oc=1/0,zc=0;const Bc=e=>{e.forEach(e=>{e.interactionId&&(Oc=Math.min(Oc,e.interactionId),zc=Math.max(zc,e.interactionId),Dc=zc?(zc-Oc)/7+1:0)})};let Fc;const Lc=()=>Fc?Dc:performance.interactionCount||0,qc=()=>{"interactionCount"in performance||Fc||(Fc=Cc("event",Bc,{type:"event",buffered:!0,durationThreshold:0}))};let Gc=0;class $c{constructor(){$c.prototype.__init.call(this),$c.prototype.__init2.call(this)}__init(){this._longestInteractionList=[]}__init2(){this._longestInteractionMap=new Map}_resetInteractions(){Gc=Lc(),this._longestInteractionList.length=0,this._longestInteractionMap.clear()}_estimateP98LongestInteraction(){const e=Math.min(this._longestInteractionList.length-1,Math.floor((Lc()-Gc)/50));return this._longestInteractionList[e]}_processEntry(e){if(this._onBeforeProcessingEntry?.(e),!e.interactionId&&"first-input"!==e.entryType)return;const t=this._longestInteractionList.at(-1);let i=this._longestInteractionMap.get(e.interactionId);if(i||this._longestInteractionList.length<10||e.duration>t._latency){if(i?e.duration>i._latency?(i.entries=[e],i._latency=e.duration):e.duration===i._latency&&e.startTime===i.entries[0].startTime&&i.entries.push(e):(i={id:e.interactionId,entries:[e],_latency:e.duration},this._longestInteractionMap.set(i.id,i),this._longestInteractionList.push(i)),this._longestInteractionList.sort((e,t)=>t._latency-e._latency),this._longestInteractionList.length>10){const e=this._longestInteractionList.splice(10);for(const t of e)this._longestInteractionMap.delete(t.id)}this._onAfterProcessingINPCandidate?.(i)}}}const Hc=e=>{const t=t=>{"pagehide"!==t.type&&"hidden"!==fc.document?.visibilityState||e(t)};fc.document&&(addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0))},jc=e=>{const t=fc.requestIdleCallback||fc.setTimeout;"hidden"===fc.document?.visibilityState?e():(t(e=Tc(e)),Hc(e))},Wc=[200,500];class Nc{_processEntry(e){this._onBeforeProcessingEntry?.(e)}}const Uc=[2500,4e3],Vc=[800,1800],Yc=e=>{fc.document?.prerendering?Ac(()=>Yc(e)):"complete"!==fc.document?.readyState?addEventListener("load",()=>Yc(e),!0):setTimeout(e)},Xc={},Qc={};let Jc,Kc,Zc,el;function tl(e,t=!1){return hl("cls",e,al,Jc,t)}function il(e,t=!1){return hl("lcp",e,ol,Kc,t)}function nl(e){return hl("inp",e,ll,el)}function sl(e,t){return ul(e,t),Qc[e]||(function(e){const t={};"event"===e&&(t.durationThreshold=0),Cc(e,t=>{rl(e,{entries:t})},t)}(e),Qc[e]=!0),dl(e,t)}function rl(e,t){const i=Xc[e];if(i?.length)for(const n of i)try{n(t)}catch(t){gc&&pn.error(`Error while triggering instrumentation handler.\nType: ${e}\nName: ${wn(n)}\nError:`,t)}}function al(){return((e,t={})=>{((e,t={})=>{Ac(()=>{const i=_c(),n=wc("FCP");let s;const r=Cc("paint",e=>{for(const t of e)"first-contentful-paint"===t.name&&(r.disconnect(),t.startTime<i.firstHiddenTime&&(n.value=Math.max(t.startTime-bc(),0),n.entries.push(t),s(!0)))});r&&(s=yc(e,n,Ic,t.reportAllChanges))})})(Tc(()=>{const i=wc("CLS",0);let n;const s=Mc(t,xc),r=e=>{for(const t of e)s._processEntry(t);s._sessionValue>i.value&&(i.value=s._sessionValue,i.entries=s._sessionEntries,n())},a=Cc("layout-shift",r);a&&(n=yc(e,i,Rc,t.reportAllChanges),fc.document?.addEventListener("visibilitychange",()=>{"hidden"===fc.document?.visibilityState&&(r(a.takeRecords()),n(!0))}),fc?.setTimeout?.(n))}))})(e=>{rl("cls",{metric:e}),Jc=e},{reportAllChanges:!0})}function ol(){return((e,t={})=>{Ac(()=>{const i=_c(),n=wc("LCP");let s;const r=Mc(t,Nc),a=e=>{t.reportAllChanges||(e=e.slice(-1));for(const t of e)r._processEntry(t),t.startTime<i.firstHiddenTime&&(n.value=Math.max(t.startTime-bc(),0),n.entries=[t],s())},o=Cc("largest-contentful-paint",a);if(o){s=yc(e,n,Uc,t.reportAllChanges);const i=Tc(()=>{a(o.takeRecords()),o.disconnect(),s(!0)});for(const e of["keydown","click","visibilitychange"])fc.document&&addEventListener(e,()=>jc(i),{capture:!0,once:!0})}})})(e=>{rl("lcp",{metric:e}),Kc=e},{reportAllChanges:!0})}function cl(){return((e,t={})=>{const i=wc("TTFB"),n=yc(e,i,Vc,t.reportAllChanges);Yc(()=>{const e=vc();e&&(i.value=Math.max(e.responseStart-bc(),0),i.entries=[e],n(!0))})})(e=>{rl("ttfb",{metric:e}),Zc=e})}function ll(){return((e,t={})=>{globalThis.PerformanceEventTiming&&"interactionId"in PerformanceEventTiming.prototype&&Ac(()=>{qc();const i=wc("INP");let n;const s=Mc(t,$c),r=e=>{jc(()=>{for(const t of e)s._processEntry(t);const t=s._estimateP98LongestInteraction();t&&t._latency!==i.value&&(i.value=t._latency,i.entries=t.entries,n())})},a=Cc("event",r,{durationThreshold:t.durationThreshold??40});n=yc(e,i,Wc,t.reportAllChanges),a&&(a.observe({type:"first-input",buffered:!0}),Hc(()=>{r(a.takeRecords()),n(!0)}))})})(e=>{rl("inp",{metric:e}),el=e})}function hl(e,t,i,n,s=!1){let r;return ul(e,t),Qc[e]||(r=i(),Qc[e]=!0),n&&t({metric:n}),dl(e,t,s?r:void 0)}function ul(e,t){Xc[e]=Xc[e]||[],Xc[e].push(t)}function dl(e,t,i){return()=>{i&&i();const n=Xc[e];if(!n)return;const s=n.indexOf(t);-1!==s&&n.splice(s,1)}}function pl(e){return"number"==typeof e&&isFinite(e)}function ml(e,t,i,{...n}){const s=Mr(e).start_timestamp;return s&&s>t&&"function"==typeof e.updateStartTime&&e.updateStartTime(t),da(e,()=>{const e=ua({startTime:t,...n});return e&&e.end(i),e})}function gl(e){const t=Ls();if(!t)return;const{name:i,transaction:n,attributes:s,startTime:r}=e,{release:a,environment:o,sendDefaultPii:c}=t.getOptions(),l=t.getIntegrationByName("Replay"),h=l?.getReplayId(),u=zs(),d=u.getUser(),p=void 0!==d?d.email||d.id||d.ip_address:void 0;let m;try{m=u.getScopeData().contexts.profile.profile_id}catch{}return ua({name:i,attributes:{release:a,environment:o,user:p||void 0,profile_id:m||void 0,replay_id:h||void 0,transaction:n,"user_agent.original":fc.navigator?.userAgent,"client.address":c?"{{auto}}":void 0,...s},startTime:r,experimental:{standalone:!0}})}function fl(){return fc.addEventListener&&fc.performance}function yl(e){return e/1e3}function vl(e){try{return PerformanceObserver.supportedEntryTypes.includes(e)}catch{return!1}}function bl(e,t){let i,n=!1;function s(e){!n&&i&&t(e,i),n=!0}Hc(()=>{s("pagehide")});const r=e.on("beforeStartNavigationSpan",(e,t)=>{t?.isRedirect||(s("navigation"),r(),a())}),a=e.on("afterStartPageLoadSpan",e=>{i=e.spanContext().spanId,a()})}function wl(e){return e?((ws()||performance.timeOrigin)+e)/1e3:e}function Sl(e){const t={};if(null!=e.nextHopProtocol){const{name:i,version:n}=function(e){let t="unknown",i="unknown",n="";for(const s of e){if("/"===s){[t,i]=e.split("/");break}if(!isNaN(Number(s))){t="h"===n?"http":n,i=e.split(n)[1];break}n+=s}return n===e&&(t=n),{name:t,version:i}}(e.nextHopProtocol);t["network.protocol.version"]=n,t["network.protocol.name"]=i}return ws()||fl()?.timeOrigin?(i={...t,"http.request.redirect_start":wl(e.redirectStart),"http.request.redirect_end":wl(e.redirectEnd),"http.request.worker_start":wl(e.workerStart),"http.request.fetch_start":wl(e.fetchStart),"http.request.domain_lookup_start":wl(e.domainLookupStart),"http.request.domain_lookup_end":wl(e.domainLookupEnd),"http.request.connect_start":wl(e.connectStart),"http.request.secure_connection_start":wl(e.secureConnectionStart),"http.request.connection_end":wl(e.connectEnd),"http.request.request_start":wl(e.requestStart),"http.request.response_start":wl(e.responseStart),"http.request.response_end":wl(e.responseEnd),"http.request.time_to_first_byte":null!=e.responseStart?e.responseStart/1e3:void 0},Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e))):t;var i}let Ml,xl,Cl=0,Tl={};function kl({recordClsStandaloneSpans:e,recordLcpStandaloneSpans:t,client:i}){const n=fl();if(n&&ws()){n.mark&&fc.performance.mark("sentry-tracing-init");const s=t?function(e){let t,i=0;if(!vl("largest-contentful-paint"))return;const n=il(({metric:e})=>{const n=e.entries[e.entries.length-1];n&&(i=e.value,t=n)},!0);bl(e,(e,s)=>{!function(e,t,i,n){gc&&pn.log(`Sending LCP span (${e})`);const s=yl((ws()||0)+(t?.startTime||0)),r=zs().getScopeData().transactionName,a=t?Yn(t.element):"Largest contentful paint",o={[Ws]:"auto.http.browser.lcp",[js]:"ui.webvital.lcp",[Qs]:0,"sentry.pageload.span_id":i,"sentry.report_event":n};t&&(t.element&&(o["lcp.element"]=Yn(t.element)),t.id&&(o["lcp.id"]=t.id),t.url&&(o["lcp.url"]=t.url.trim().slice(0,200)),null!=t.loadTime&&(o["lcp.loadTime"]=t.loadTime),null!=t.renderTime&&(o["lcp.renderTime"]=t.renderTime),null!=t.size&&(o["lcp.size"]=t.size));const c=gl({name:a,transaction:r,attributes:o,startTime:s});c&&(c.addEvent("lcp",{[Us]:"millisecond",[Vs]:e}),c.end(s))}(i,t,s,e),n()})}(i):il(({metric:e})=>{const t=e.entries[e.entries.length-1];t&&(Tl.lcp={value:e.value,unit:"millisecond"},Ml=t)},!0),r=hl("ttfb",({metric:e})=>{e.entries[e.entries.length-1]&&(Tl.ttfb={value:e.value,unit:"millisecond"})},cl,Zc),a=e?function(e){let t,i=0;if(!vl("layout-shift"))return;const n=tl(({metric:e})=>{const n=e.entries[e.entries.length-1];n&&(i=e.value,t=n)},!0);bl(e,(e,s)=>{!function(e,t,i,n){gc&&pn.log(`Sending CLS span (${e})`);const s=t?yl((ws()||0)+t.startTime):bs(),r=zs().getScopeData().transactionName,a=t?Yn(t.sources[0]?.node):"Layout shift",o={[Ws]:"auto.http.browser.cls",[js]:"ui.webvital.cls",[Qs]:0,"sentry.pageload.span_id":i,"sentry.report_event":n};t?.sources&&t.sources.forEach((e,t)=>{o[`cls.source.${t+1}`]=Yn(e.node)});const c=gl({name:a,transaction:r,attributes:o,startTime:s});c&&(c.addEvent("cls",{[Us]:"",[Vs]:e}),c.end(s))}(i,t,s,e),n()})}(i):tl(({metric:e})=>{const t=e.entries[e.entries.length-1];t&&(Tl.cls={value:e.value,unit:""},xl=t)},!0);return()=>{s?.(),r(),a?.()}}return()=>{}}function El(e,t,i,n,s=i){const r=function(e){return"secureConnection"===e?"connectEnd":"fetch"===e?"domainLookupStart":`${e}End`}(i),a=t[r],o=t[`${i}Start`];o&&a&&ml(e,n+yl(o),n+yl(a),{op:`browser.${s}`,name:t.name,attributes:{[Ws]:"auto.ui.browser.metrics",..."redirect"===i&&null!=t.redirectCount?{"http.redirect_count":t.redirectCount}:{}}})}const Pl=({entries:e})=>{const t=Ar(),i=t?_r(t):void 0,n=i?Mr(i).description:zs().getScopeData().transactionName;e.forEach(e=>{const t=e;if(!t.identifier)return;const i=t.name,s=t.renderTime,r=t.loadTime,[a,o]=r?[yl(r),"load-time"]:s?[yl(s),"render-time"]:[bs(),"entry-emission"],c="image-paint"===i?yl(Math.max(0,(s??0)-(r??0))):0,l={[Ws]:"auto.ui.browser.elementtiming",[js]:"ui.elementtiming",[Gs]:"component","sentry.span_start_time_source":o,"sentry.transaction_name":n,"element.id":t.id,"element.type":t.element?.tagName?.toLowerCase()||"unknown","element.size":t.naturalWidth&&t.naturalHeight?`${t.naturalWidth}x${t.naturalHeight}`:void 0,"element.render_time":s,"element.load_time":r,"element.url":t.url||void 0,"element.identifier":t.identifier,"element.paint_type":i};ha({name:`element[${t.identifier}]`,attributes:l,startTime:a,onlyIfParent:!0},e=>{e.end(a+c)})})};let _l,Al,Il,Rl;function Dl(e){Cn("dom",e),Tn("dom",Ol)}function Ol(){if(!fc.document)return;const e=kn.bind(null,"dom"),t=zl(e,!0);fc.document.addEventListener("click",t,!1),fc.document.addEventListener("keypress",t,!1),["EventTarget","Node"].forEach(t=>{const i=fc,n=i[t]?.prototype;n?.hasOwnProperty?.("addEventListener")&&(is(n,"addEventListener",function(t){return function(i,n,s){if("click"===i||"keypress"==i)try{const n=this.__sentry_instrumentation_handlers__=this.__sentry_instrumentation_handlers__||{},r=n[i]=n[i]||{refCount:0};if(!r.handler){const n=zl(e);r.handler=n,t.call(this,i,n,s)}r.refCount++}catch{}return t.call(this,i,n,s)}}),is(n,"removeEventListener",function(e){return function(t,i,n){if("click"===t||"keypress"==t)try{const i=this.__sentry_instrumentation_handlers__||{},s=i[t];s&&(s.refCount--,s.refCount<=0&&(e.call(this,t,s.handler,n),s.handler=void 0,delete i[t]),0===Object.keys(i).length&&delete this.__sentry_instrumentation_handlers__)}catch{}return e.call(this,t,i,n)}}))})}function zl(e,t=!1){return i=>{if(!i||i._sentryCaptured)return;const n=function(e){try{return e.target}catch{return null}}(i);if(function(e,t){return"keypress"===e&&(!t?.tagName||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.isContentEditable)}(i.type,n))return;ns(i,"_sentryCaptured",!0),n&&!n._sentryId&&ns(n,"_sentryId",ds());const s="keypress"===i.type?"input":i.type;(function(e){if(e.type!==Al)return!1;try{if(!e.target||e.target._sentryId!==Il)return!1}catch{}return!0})(i)||(e({event:i,name:s,global:t}),Al=i.type,Il=n?n._sentryId:void 0),clearTimeout(_l),_l=fc.setTimeout(()=>{Il=void 0,Al=void 0},1e3)}}function Bl(e){const t="history";Cn(t,e),Tn(t,Fl)}function Fl(){function e(e){return function(...t){const i=t.length>2?t[2]:void 0;if(i){const n=Rl,s=function(e){try{return new URL(e,fc.location.origin).toString()}catch{return e}}(String(i));if(Rl=s,n===s)return e.apply(this,t);kn("history",{from:n,to:s})}return e.apply(this,t)}}fc.addEventListener("popstate",()=>{const e=fc.location.href,t=Rl;Rl=e,t!==e&&kn("history",{from:t,to:e})}),"history"in Wo&&Wo.history&&(is(fc.history,"pushState",e),is(fc.history,"replaceState",e))}const Ll={};function ql(e){const t=Ll[e];if(t)return t;let i=fc[e];if(No(i))return Ll[e]=i.bind(fc);const n=fc.document;if(n&&"function"==typeof n.createElement)try{const t=n.createElement("iframe");t.hidden=!0,n.head.appendChild(t);const s=t.contentWindow;s?.[e]&&(i=s[e]),n.head.removeChild(t)}catch(t){gc&&pn.warn(`Could not create sandbox iframe for ${e} check, bailing to window.${e}: `,t)}return i?Ll[e]=i.bind(fc):i}function Gl(...e){return ql("setTimeout")(...e)}const $l="__sentry_xhr_v3__";function Hl(e){Cn("xhr",e),Tn("xhr",jl)}function jl(){if(!fc.XMLHttpRequest)return;const e=XMLHttpRequest.prototype;e.open=new Proxy(e.open,{apply(e,t,i){const n=new Error,s=1e3*bs(),r=Ln(i[0])?i[0].toUpperCase():void 0,a=function(e){if(Ln(e))return e;try{return e.toString()}catch{}}(i[1]);if(!r||!a)return e.apply(t,i);t[$l]={method:r,url:a,request_headers:{}},"POST"===r&&a.match(/sentry_key/)&&(t.__sentry_own_request__=!0);const o=()=>{const e=t[$l];if(e&&4===t.readyState){try{e.status_code=t.status}catch{}kn("xhr",{endTimestamp:1e3*bs(),startTimestamp:s,xhr:t,virtualError:n})}};return"onreadystatechange"in t&&"function"==typeof t.onreadystatechange?t.onreadystatechange=new Proxy(t.onreadystatechange,{apply:(e,t,i)=>(o(),e.apply(t,i))}):t.addEventListener("readystatechange",o),t.setRequestHeader=new Proxy(t.setRequestHeader,{apply(e,t,i){const[n,s]=i,r=t[$l];return r&&Ln(n)&&Ln(s)&&(r.request_headers[n.toLowerCase()]=s),e.apply(t,i)}}),e.apply(t,i)}}),e.send=new Proxy(e.send,{apply(e,t,i){const n=t[$l];return n?(void 0!==i[0]&&(n.body=i[0]),kn("xhr",{startTimestamp:1e3*bs(),xhr:t}),e.apply(t,i)):e.apply(t,i)}})}function Wl(e){return new URLSearchParams(e).toString()}function Nl(e,t=pn){try{if("string"==typeof e)return[e];if(e instanceof URLSearchParams)return[e.toString()];if(e instanceof FormData)return[Wl(e)];if(!e)return[void 0]}catch(i){return gc&&t.error(i,"Failed to serialize body",e),[void 0,"BODY_PARSE_ERROR"]}return gc&&t.log("Skipping network body because of body type",e),[void 0,"UNPARSEABLE_BODY_TYPE"]}function Ul(e=[]){if(2===e.length&&"object"==typeof e[1])return e[1].body}function Vl(e){let t;try{t=e.getAllResponseHeaders()}catch(t){return gc&&pn.error(t,"Failed to get xhr response headers",e),{}}return t?t.split("\r\n").reduce((e,t)=>{const[i,n]=t.split(": ");return n&&(e[i.toLowerCase()]=n),e},{}):{}}const Yl=[],Xl=new Map;const Ql={click:"click",pointerdown:"click",pointerup:"click",mousedown:"click",mouseup:"click",touchstart:"click",touchend:"click",mouseover:"hover",mouseout:"hover",mouseenter:"hover",mouseleave:"hover",pointerover:"hover",pointerout:"hover",pointerenter:"hover",pointerleave:"hover",dragstart:"drag",dragend:"drag",drag:"drag",dragenter:"drag",dragleave:"drag",dragover:"drag",drop:"drag",keydown:"press",keyup:"press",keypress:"press",input:"press"},Jl=({metric:e})=>{if(null==e.value)return;const t=yl(e.value);if(t>60)return;const i=e.entries.find(t=>t.duration===e.value&&Ql[t.name]);if(!i)return;const{interactionId:n}=i,s=Ql[i.name],r=yl(ws()+i.startTime),a=Ar(),o=a?_r(a):void 0,c=(null!=n?Xl.get(n):void 0)||o,l=c?Mr(c).description:zs().getScopeData().transactionName,h=gl({name:Yn(i.target),transaction:l,attributes:{[Ws]:"auto.http.browser.inp",[js]:`ui.interaction.${s}`,[Qs]:i.duration},startTime:r});h&&(h.addEvent("inp",{[Us]:"millisecond",[Vs]:e.value}),h.end(r+t))};function Kl(e,t=ql("fetch")){let i=0,n=0;return function(e,t,i=function(e=100){const t=new Set;function i(e){t.delete(e)}return{get $(){return Array.from(t)},add:function(n){if(!(t.size<e))return Sa(ho);const s=n();return t.add(s),s.then(()=>i(s),()=>i(s)),s},drain:function(e){if(!t.size)return wa(!0);const i=Promise.allSettled(Array.from(t)).then(()=>!0);if(!e)return i;const n=[i,new Promise(t=>setTimeout(()=>t(!1),e))];return Promise.race(n)}}}(e.bufferSize||64)){let n={};return{send:function(s){const r=[];if(Qr(s,(t,i)=>{const s=ia(i);uo(n,s)?e.recordDroppedEvent("ratelimit_backoff",s):r.push(t)}),0===r.length)return Promise.resolve({});const a=Yr(s[0],r),o=t=>{Qr(a,(i,n)=>{e.recordDroppedEvent(t,ia(n))})};return i.add(()=>t({body:Kr(a)}).then(e=>(void 0!==e.statusCode&&(e.statusCode<200||e.statusCode>=300)&&en&&pn.warn(`Sentry responded with status code ${e.statusCode} to sent event.`),n=po(n,e),e),e=>{throw o("network_error"),en&&pn.error("Encountered error running transport request:",e),e})).then(e=>e,e=>{if(e===ho)return en&&pn.error("Skipped sending event because buffer is full."),o("queue_overflow"),Promise.resolve({});throw e})},flush:e=>i.drain(e)}}(e,async function(s){const r=s.body.length;i+=r,n++;const a={body:s.body,method:"POST",referrerPolicy:"strict-origin",headers:e.headers,keepalive:i<=6e4&&n<15,...e.fetchOptions};try{const i=await t(e.url,a);return{statusCode:i.status,headers:{"x-sentry-rate-limits":i.headers.get("X-Sentry-Rate-Limits"),"retry-after":i.headers.get("Retry-After")}}}catch(e){throw Ll.fetch=void 0,e}finally{i-=r,n--}})}function Zl(e,t,i,n){const s={filename:e,function:"<anonymous>"===t?mn:t,in_app:!0};return void 0!==i&&(s.lineno=i),void 0!==n&&(s.colno=n),s}const eh=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,th=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,ih=/\((\S*)(?::(\d+))(?::(\d+))\)/,nh=/at (.+?) ?\(data:(.+?),/,sh=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,rh=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,ah=yn([30,e=>{const t=e.match(nh);if(t)return{filename:`<data:${t[2]}>`,function:t[1]};const i=eh.exec(e);if(i){const[,e,t,n]=i;return Zl(e,mn,+t,+n)}const n=th.exec(e);if(n){if(n[2]&&0===n[2].indexOf("eval")){const e=ih.exec(n[2]);e&&(n[2]=e[1],n[3]=e[2],n[4]=e[3])}const[e,t]=oh(n[1]||mn,n[2]);return Zl(t,e,n[3]?+n[3]:void 0,n[4]?+n[4]:void 0)}}],[50,e=>{const t=sh.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){const e=rh.exec(t[3]);e&&(t[1]=t[1]||"eval",t[3]=e[1],t[4]=e[2],t[5]="")}let e=t[3],i=t[1]||mn;return[i,e]=oh(i,e),Zl(e,i,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}}]),oh=(e,t)=>{const i=-1!==e.indexOf("safari-extension"),n=-1!==e.indexOf("safari-web-extension");return i||n?[-1!==e.indexOf("@")?e.split("@")[0]:mn,i?`safari-extension:${t}`:`safari-web-extension:${t}`]:[e,t]},ch="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,lh=(e={})=>{const t={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e};return{name:"Breadcrumbs",setup(e){t.console&&function(e){const t="console";Cn(t,e),Tn(t,zo)}(function(e){return function(t){if(Ls()!==e)return;const i={category:"console",data:{arguments:t.args,logger:"console"},level:Bo(t.level),message:Zn(t.args," ")};if("assert"===t.level){if(!1!==t.args[0])return;i.message=`Assertion failed: ${Zn(t.args.slice(1)," ")||"console.assert"}`,i.data.arguments=t.args.slice(1)}Mo(i,{input:t.args,level:t.level})}}(e)),t.dom&&Dl(function(e,t){return function(i){if(Ls()!==e)return;let n,s,r="object"==typeof t?t.serializeAttribute:void 0,a="object"==typeof t&&"number"==typeof t.maxStringLength?t.maxStringLength:void 0;a&&a>1024&&(ch&&pn.warn(`\`dom.maxStringLength\` cannot exceed 1024, but a value of ${a} was configured. Sentry will use 1024 instead.`),a=1024),"string"==typeof r&&(r=[r]);try{const e=i.event,t=function(e){return!!e&&!!e.target}(e)?e.target:e;n=Yn(t,{keyAttrs:r,maxStringLength:a}),s=Jn(t)}catch{n="<unknown>"}if(0===n.length)return;const o={category:`ui.${i.name}`,message:n};s&&(o.data={"ui.component_name":s}),Mo(o,{event:i.event,name:i.name,global:i.global})}}(e,t.dom)),t.xhr&&Hl(function(e){return function(t){if(Ls()!==e)return;const{startTimestamp:i,endTimestamp:n}=t,s=t.xhr[$l];if(!i||!n||!s)return;const{method:r,url:a,status_code:o,body:c}=s,l={method:r,url:a,status_code:o},h={xhr:t.xhr,input:c,startTimestamp:i,endTimestamp:n},u={category:"xhr",data:l,type:"http",level:jo(o)};e.emit("beforeOutgoingRequestBreadcrumb",u,h),Mo(u,h)}}(e)),t.fetch&&Uo(function(e){return function(t){if(Ls()!==e)return;const{startTimestamp:i,endTimestamp:n}=t;if(n&&(!t.fetchData.url.match(/sentry_key/)||"POST"!==t.fetchData.method))if(t.fetchData.method,t.fetchData.url,t.error){const s=t.fetchData,r={data:t.error,input:t.args,startTimestamp:i,endTimestamp:n},a={category:"fetch",data:s,level:"error",type:"http"};e.emit("beforeOutgoingRequestBreadcrumb",a,r),Mo(a,r)}else{const s=t.response,r={...t.fetchData,status_code:s?.status};t.fetchData.request_body_size,t.fetchData.response_body_size;const a={input:t.args,response:s,startTimestamp:i,endTimestamp:n},o={category:"fetch",data:r,type:"http",level:jo(r.status_code)};e.emit("beforeOutgoingRequestBreadcrumb",o,a),Mo(o,a)}}}(e)),t.history&&Bl(function(e){return function(t){if(Ls()!==e)return;let i=t.from,n=t.to;const s=yo(Zo.location.href);let r=i?yo(i):void 0;const a=yo(n);r?.path||(r=s),s.protocol===a.protocol&&s.host===a.host&&(n=a.relative),s.protocol===r.protocol&&s.host===r.host&&(i=r.relative),Mo({category:"navigation",data:{from:i,to:n}})}}(e)),t.sentry&&e.on("beforeSendEvent",function(e){return function(t){Ls()===e&&Mo({category:"sentry."+("transaction"===t.type?"transaction":"event"),event_id:t.event_id,level:t.level,message:ms(t)},{event:t})}}(e))}}},hh=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],uh=(e={})=>{const t={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,unregisterOriginalCallbacks:!1,...e};return{name:"BrowserApiErrors",setupOnce(){t.setTimeout&&is(Zo,"setTimeout",dh),t.setInterval&&is(Zo,"setInterval",dh),t.requestAnimationFrame&&is(Zo,"requestAnimationFrame",ph),t.XMLHttpRequest&&"XMLHttpRequest"in Zo&&is(XMLHttpRequest.prototype,"send",mh);const e=t.eventTarget;e&&(Array.isArray(e)?e:hh).forEach(e=>function(e,t){const i=Zo,n=i[e]?.prototype;n?.hasOwnProperty?.("addEventListener")&&(is(n,"addEventListener",function(i){return function(n,s,r){try{"function"==typeof s.handleEvent&&(s.handleEvent=ic(s.handleEvent,{mechanism:{data:{handler:wn(s),target:e},handled:!1,type:"auto.browser.browserapierrors.handleEvent"}}))}catch{}return t.unregisterOriginalCallbacks&&function(e,t,i){e&&"object"==typeof e&&"removeEventListener"in e&&"function"==typeof e.removeEventListener&&e.removeEventListener(t,i)}(this,n,s),i.apply(this,[n,ic(s,{mechanism:{data:{handler:wn(s),target:e},handled:!1,type:"auto.browser.browserapierrors.addEventListener"}}),r])}}),is(n,"removeEventListener",function(e){return function(t,i,n){try{const s=i.__sentry_wrapped__;s&&e.call(this,t,s,n)}catch{}return e.call(this,t,i,n)}}))}(e,t))}}};function dh(e){return function(...t){const i=t[0];return t[0]=ic(i,{mechanism:{handled:!1,type:`auto.browser.browserapierrors.${wn(e)}`}}),e.apply(this,t)}}function ph(e){return function(t){return e.apply(this,[ic(t,{mechanism:{data:{handler:wn(e)},handled:!1,type:"auto.browser.browserapierrors.requestAnimationFrame"}})])}}function mh(e){return function(...t){const i=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(e=>{e in i&&"function"==typeof i[e]&&is(i,e,function(t){const i={mechanism:{data:{handler:wn(t)},handled:!1,type:`auto.browser.browserapierrors.xhr.${e}`}},n=rs(t);return n&&(i.mechanism.data.handler=wn(n)),ic(t,i)})}),e.apply(this,t)}}const gh=(e={})=>{const t={onerror:!0,onunhandledrejection:!0,...e};return{name:"GlobalHandlers",setupOnce(){Error.stackTraceLimit=50},setup(e){t.onerror&&(function(e){Pn(t=>{const{stackParser:i,attachStacktrace:n}=yh();if(Ls()!==e||tc())return;const{msg:s,url:r,line:a,column:o,error:c}=t,l=function(e,t,i,n){const s=e.exception=e.exception||{},r=s.values=s.values||[],a=r[0]=r[0]||{},o=a.stacktrace=a.stacktrace||{},c=o.frames=o.frames||[],l=n,h=i,u=function(e){if(Ln(e)&&0!==e.length){if(e.startsWith("data:")){const t=e.match(/^data:([^;]+)/);return`<data:${t?t[1]:"text/javascript"}${e.includes("base64,")?",base64":""}>`}return e.slice(0,1024)}}(t)??Qn();return 0===c.length&&c.push({colno:l,filename:u,function:mn,in_app:!0,lineno:h}),e}(uc(i,c||s,void 0,n,!1),r,a,o);l.level="error",Oa(l,{originalException:c,mechanism:{handled:!1,type:"auto.browser.global_handlers.onerror"}})})}(e),fh("onerror")),t.onunhandledrejection&&(function(e){In(t=>{const{stackParser:i,attachStacktrace:n}=yh();if(Ls()!==e||tc())return;const s=function(e){if(Gn(e))return e;try{if("reason"in e)return e.reason;if("detail"in e&&"reason"in e.detail)return e.detail.reason}catch{}return e}(t),r=Gn(s)?{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(s)}`}]}}:uc(i,s,void 0,n,!0);r.level="error",Oa(r,{originalException:s,mechanism:{handled:!1,type:"auto.browser.global_handlers.onunhandledrejection"}})})}(e),fh("onunhandledrejection"))}}};function fh(e){ch&&pn.log(`Global Handler attached: ${e}`)}function yh(){const e=Ls();return e?.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const vh=(e={})=>{const t=e.limit||5,i=e.key||"cause";return{name:"LinkedErrors",preprocessEvent(e,n,s){Io(sc,s.getOptions().stackParser,i,t,e,n)}}};const bh=tn,wh="sentryReplaySession",Sh="Unable to send Replay",Mh=15e4,xh=5e3,Ch=2e7;var Th=Object.defineProperty,kh=(e,t,i)=>((e,t,i)=>t in e?Th(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i),Eh=(e=>(e[e.Document=0]="Document",e[e.DocumentType=1]="DocumentType",e[e.Element=2]="Element",e[e.Text=3]="Text",e[e.CDATA=4]="CDATA",e[e.Comment=5]="Comment",e))(Eh||{});function Ph(e){const t=e?.host;return Boolean(t?.shadowRoot===e)}function _h(e){return"[object ShadowRoot]"==={}.toString.call(e)}function Ah(e){try{const i=e.rules||e.cssRules;return i?((t=Array.from(i,Ih).join("")).includes(" background-clip: text;")&&!t.includes(" -webkit-background-clip: text;")&&(t=t.replace(/\sbackground-clip:\s*text;/g," -webkit-background-clip: text; background-clip: text;")),t):null}catch(e){return null}var t}function Ih(e){let t;if(function(e){return"styleSheet"in e}(e))try{t=Ah(e.styleSheet)||function(e){const{cssText:t}=e;if(t.split('"').length<3)return t;const i=["@import",`url(${JSON.stringify(e.href)})`];return""===e.layerName?i.push("layer"):e.layerName&&i.push(`layer(${e.layerName})`),e.supportsText&&i.push(`supports(${e.supportsText})`),e.media.length&&i.push(e.media.mediaText),i.join(" ")+";"}(e)}catch(e){}else if(function(e){return"selectorText"in e}(e)){let t=e.cssText;const i=e.selectorText.includes(":"),n="string"==typeof e.style.all&&e.style.all;if(n&&(t=function(e){let t="";for(let i=0;i<e.style.length;i++){const n=e.style,s=n[i],r=n.getPropertyPriority(s);t+=`${s}:${n.getPropertyValue(s)}${r?" !important":""};`}return`${e.selectorText} { ${t} }`}(e)),i&&(t=t.replace(/(\[(?:[\w-]+)[^\\])(:(?:[\w-]+)\])/gm,"$1\\$2")),i||n)return t}return t||e.cssText}class Rh{constructor(){kh(this,"idNodeMap",new Map),kh(this,"nodeMetaMap",new WeakMap)}getId(e){if(!e)return-1;const t=this.getMeta(e)?.id;return t??-1}getNode(e){return this.idNodeMap.get(e)||null}getIds(){return Array.from(this.idNodeMap.keys())}getMeta(e){return this.nodeMetaMap.get(e)||null}removeNodeFromMap(e){const t=this.getId(e);this.idNodeMap.delete(t),e.childNodes&&e.childNodes.forEach(e=>this.removeNodeFromMap(e))}has(e){return this.idNodeMap.has(e)}hasNode(e){return this.nodeMetaMap.has(e)}add(e,t){const i=t.id;this.idNodeMap.set(i,e),this.nodeMetaMap.set(e,t)}replace(e,t){const i=this.getNode(e);if(i){const e=this.nodeMetaMap.get(i);e&&this.nodeMetaMap.set(t,e)}this.idNodeMap.set(e,t)}reset(){this.idNodeMap=new Map,this.nodeMetaMap=new WeakMap}}function Dh({maskInputOptions:e,tagName:t,type:i}){return"OPTION"===t&&(t="SELECT"),Boolean(e[t.toLowerCase()]||i&&e[i]||"password"===i||"INPUT"===t&&!i&&e.text)}function Oh({isMasked:e,element:t,value:i,maskInputFn:n}){let s=i||"";return e?(n&&(s=n(s,t)),"*".repeat(s.length)):s}function zh(e){return e.toLowerCase()}function Bh(e){return e.toUpperCase()}const Fh="__rrweb_original__";function Lh(e){const t=e.type;return e.hasAttribute("data-rr-is-password")?"password":t?zh(t):null}function qh(e,t,i){return"INPUT"!==t||"radio"!==i&&"checkbox"!==i?e.value:e.getAttribute("value")||""}function Gh(e,t){let i;try{i=new URL(e,t??window.location.href)}catch(e){return null}const n=i.pathname.match(/\.([0-9a-z]+)(?:$)/i);return n?.[1]??null}const $h={};function Hh(e){const t=$h[e];if(t)return t;const i=window.document;let n=window[e];if(i&&"function"==typeof i.createElement)try{const t=i.createElement("iframe");t.hidden=!0,i.head.appendChild(t);const s=t.contentWindow;s&&s[e]&&(n=s[e]),i.head.removeChild(t)}catch(e){}return $h[e]=n.bind(window)}function jh(...e){return Hh("setTimeout")(...e)}function Wh(...e){return Hh("clearTimeout")(...e)}function Nh(e){try{return e.contentDocument}catch(e){}}let Uh=1;const Vh=new RegExp("[^a-z0-9-_:]");function Yh(){return Uh++}let Xh,Qh;const Jh=/url\((?:(')([^']*)'|(")(.*?)"|([^)]*))\)/gm,Kh=/^(?:[a-z+]+:)?\/\//i,Zh=/^www\..*/i,eu=/^(data:)([^,]*),(.*)/i;function tu(e,t){return(e||"").replace(Jh,(e,i,n,s,r,a)=>{const o=n||r||a,c=i||s||"";if(!o)return e;if(Kh.test(o)||Zh.test(o))return`url(${c}${o}${c})`;if(eu.test(o))return`url(${c}${o}${c})`;if("/"===o[0])return`url(${c}${function(e){let t="";return t=e.indexOf("//")>-1?e.split("/").slice(0,3).join("/"):e.split("/")[0],t=t.split("?")[0],t}(t)+o}${c})`;const l=t.split("/"),h=o.split("/");l.pop();for(const e of h)"."!==e&&(".."===e?l.pop():l.push(e));return`url(${c}${l.join("/")}${c})`})}const iu=/^[^ \t\n\r\u000c]+/,nu=/^[, \t\n\r\u000c]+/,su=new WeakMap;function ru(e,t){return t&&""!==t.trim()?au(e,t):t}function au(e,t){let i=su.get(e);if(i||(i=e.createElement("a"),su.set(e,i)),t){if(t.startsWith("blob:")||t.startsWith("data:"))return t}else t="";return i.setAttribute("href",t),i.href}function ou(e,t,i,n,s,r){return n?"src"===i||"href"===i&&("use"!==t||"#"!==n[0])||"xlink:href"===i&&"#"!==n[0]?ru(e,n):"background"!==i||"table"!==t&&"td"!==t&&"th"!==t?"srcset"===i?function(e,t){if(""===t.trim())return t;let i=0;function n(e){let n;const s=e.exec(t.substring(i));return s?(n=s[0],i+=n.length,n):""}const s=[];for(;n(nu),!(i>=t.length);){let r=n(iu);if(","===r.slice(-1))r=ru(e,r.substring(0,r.length-1)),s.push(r);else{let n="";r=ru(e,r);let a=!1;for(;;){const e=t.charAt(i);if(""===e){s.push((r+n).trim());break}if(a)")"===e&&(a=!1);else{if(","===e){i+=1,s.push((r+n).trim());break}"("===e&&(a=!0)}n+=e,i+=1}}}return s.join(", ")}(e,n):"style"===i?tu(n,au(e)):"object"===t&&"data"===i?ru(e,n):"function"==typeof r?r(i,n,s):n:ru(e,n):n}function cu(e,t,i){return("video"===e||"audio"===e)&&"autoplay"===t}function lu(e,t,i=1/0,n=0){return e?e.nodeType!==e.ELEMENT_NODE||n>i?-1:t(e)?n:lu(e.parentNode,t,i,n+1):-1}function hu(e,t){return i=>{const n=i;if(null===n)return!1;try{if(e)if("string"==typeof e){if(n.matches(`.${e}`))return!0}else if(function(e,t){for(let i=e.classList.length;i--;){const n=e.classList[i];if(t.test(n))return!0}return!1}(n,e))return!0;return!(!t||!n.matches(t))}catch{return!1}}}function uu(e,t,i,n,s,r){try{const a=e.nodeType===e.ELEMENT_NODE?e:e.parentElement;if(null===a)return!1;if("INPUT"===a.tagName){const e=a.getAttribute("autocomplete");if(["current-password","new-password","cc-number","cc-exp","cc-exp-month","cc-exp-year","cc-csc"].includes(e))return!0}let o=-1,c=-1;if(r){if(c=lu(a,hu(n,s)),c<0)return!0;o=lu(a,hu(t,i),c>=0?c:1/0)}else{if(o=lu(a,hu(t,i)),o<0)return!1;c=lu(a,hu(n,s),o>=0?o:1/0)}return o>=0?!(c>=0)||o<=c:!(c>=0||!r)}catch(e){}return!!r}function du(e){return null==e?"":e.toLowerCase()}function pu(e,t){const{doc:i,mirror:n,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:o,maskTextClass:c,unmaskTextClass:l,maskTextSelector:h,unmaskTextSelector:u,skipChild:d=!1,inlineStylesheet:p=!0,maskInputOptions:m={},maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOMOptions:v,dataURLOptions:b={},inlineImages:w=!1,recordCanvas:S=!1,onSerialize:M,onIframeLoad:x,iframeLoadTimeout:C=5e3,onBlockedImageLoad:T,onStylesheetLoad:k,stylesheetLoadTimeout:E=5e3,keepIframeSrcFn:P=()=>!1,newlyAddedElement:_=!1}=t;let{preserveWhiteSpace:A=!0}=t;const I=function(e,t){const{doc:i,mirror:n,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:o,maskAttributeFn:c,maskTextClass:l,unmaskTextClass:h,maskTextSelector:u,unmaskTextSelector:d,inlineStylesheet:p,maskInputOptions:m={},maskTextFn:g,maskInputFn:f,dataURLOptions:y={},inlineImages:v,recordCanvas:b,keepIframeSrcFn:w,newlyAddedElement:S=!1}=t,M=function(e,t){if(!t.hasNode(e))return;const i=t.getId(e);return 1===i?void 0:i}(i,n);switch(e.nodeType){case e.DOCUMENT_NODE:return"CSS1Compat"!==e.compatMode?{type:Eh.Document,childNodes:[],compatMode:e.compatMode}:{type:Eh.Document,childNodes:[]};case e.DOCUMENT_TYPE_NODE:return{type:Eh.DocumentType,name:e.name,publicId:e.publicId,systemId:e.systemId,rootId:M};case e.ELEMENT_NODE:return function(e,t){const{doc:i,blockClass:n,blockSelector:s,unblockSelector:r,inlineStylesheet:a,maskInputOptions:o={},maskAttributeFn:c,maskInputFn:l,dataURLOptions:h={},inlineImages:u,recordCanvas:d,keepIframeSrcFn:p,newlyAddedElement:m=!1,rootId:g,maskTextClass:f,unmaskTextClass:y,maskTextSelector:v,unmaskTextSelector:b}=t,w=function(e,t,i,n){try{if(n&&e.matches(n))return!1;if("string"==typeof t){if(e.classList.contains(t))return!0}else for(let i=e.classList.length;i--;){const n=e.classList[i];if(t.test(n))return!0}if(i)return e.matches(i)}catch(e){}return!1}(e,n,s,r),S=function(e){if(e instanceof HTMLFormElement)return"form";const t=zh(e.tagName);return Vh.test(t)?"div":t}(e);let M={};const x=e.attributes.length;for(let t=0;t<x;t++){const n=e.attributes[t];n.name&&!cu(S,n.name,n.value)&&(M[n.name]=ou(i,S,zh(n.name),n.value,e,c))}if("link"===S&&a){const t=Array.from(i.styleSheets).find(t=>t.href===e.href);let n=null;t&&(n=Ah(t)),n&&(M.rel=null,M.href=null,M.crossorigin=null,M._cssText=tu(n,t.href))}if("style"===S&&e.sheet&&!(e.innerText||e.textContent||"").trim().length){const t=Ah(e.sheet);t&&(M._cssText=tu(t,au(i)))}if("input"===S||"textarea"===S||"select"===S||"option"===S){const t=e,i=Lh(t),n=qh(t,Bh(S),i),s=t.checked;if("submit"!==i&&"button"!==i&&n){const e=uu(t,f,v,y,b,Dh({type:i,tagName:Bh(S),maskInputOptions:o}));M.value=Oh({isMasked:e,element:t,value:n,maskInputFn:l})}s&&(M.checked=s)}if("option"===S&&(e.selected&&!o.select?M.selected=!0:delete M.selected),"canvas"===S&&d)if("2d"===e.__context)(function(e){const t=e.getContext("2d");if(!t)return!0;for(let i=0;i<e.width;i+=50)for(let n=0;n<e.height;n+=50){const s=t.getImageData,r=Fh in s?s[Fh]:s;if(new Uint32Array(r.call(t,i,n,Math.min(50,e.width-i),Math.min(50,e.height-n)).data.buffer).some(e=>0!==e))return!1}return!0})(e)||(M.rr_dataURL=e.toDataURL(h.type,h.quality));else if(!("__context"in e)){const t=e.toDataURL(h.type,h.quality),n=i.createElement("canvas");n.width=e.width,n.height=e.height,t!==n.toDataURL(h.type,h.quality)&&(M.rr_dataURL=t)}if("img"===S&&u){Xh||(Xh=i.createElement("canvas"),Qh=Xh.getContext("2d"));const t=e,n=t.currentSrc||t.getAttribute("src")||"<unknown-src>",s=t.crossOrigin,r=()=>{t.removeEventListener("load",r);try{Xh.width=t.naturalWidth,Xh.height=t.naturalHeight,Qh.drawImage(t,0,0),M.rr_dataURL=Xh.toDataURL(h.type,h.quality)}catch(e){if("anonymous"!==t.crossOrigin)return t.crossOrigin="anonymous",void(t.complete&&0!==t.naturalWidth?r():t.addEventListener("load",r));console.warn(`Cannot inline img src=${n}! Error: ${e}`)}"anonymous"===t.crossOrigin&&(s?M.crossOrigin=s:t.removeAttribute("crossorigin"))};t.complete&&0!==t.naturalWidth?r():t.addEventListener("load",r)}if("audio"!==S&&"video"!==S||(M.rr_mediaState=e.paused?"paused":"played",M.rr_mediaCurrentTime=e.currentTime),m||(e.scrollLeft&&(M.rr_scrollLeft=e.scrollLeft),e.scrollTop&&(M.rr_scrollTop=e.scrollTop)),w){const{width:t,height:i}=e.getBoundingClientRect();M={class:M.class,rr_width:`${t}px`,rr_height:`${i}px`}}let C;"iframe"!==S||p(M.src)||(w||Nh(e)||(M.rr_src=M.src),delete M.src);try{customElements.get(S)&&(C=!0)}catch(e){}return{type:Eh.Element,tagName:S,attributes:M,childNodes:[],isSVG:(T=e,Boolean("svg"===T.tagName||T.ownerSVGElement)||void 0),needBlock:w,rootId:g,isCustom:C};var T}(e,{doc:i,blockClass:s,blockSelector:r,unblockSelector:a,inlineStylesheet:p,maskAttributeFn:c,maskInputOptions:m,maskInputFn:f,dataURLOptions:y,inlineImages:v,recordCanvas:b,keepIframeSrcFn:w,newlyAddedElement:S,rootId:M,maskTextClass:l,unmaskTextClass:h,maskTextSelector:u,unmaskTextSelector:d});case e.TEXT_NODE:return function(e,t){const{maskAllText:i,maskTextClass:n,unmaskTextClass:s,maskTextSelector:r,unmaskTextSelector:a,maskTextFn:o,maskInputOptions:c,maskInputFn:l,rootId:h}=t,u=e.parentNode&&e.parentNode.tagName;let d=e.textContent;const p="STYLE"===u||void 0,m="SCRIPT"===u||void 0,g="TEXTAREA"===u||void 0;if(p&&d){try{e.nextSibling||e.previousSibling||e.parentNode.sheet?.cssRules&&(d=Ah(e.parentNode.sheet))}catch(t){console.warn(`Cannot get CSS styles from text's parentNode. Error: ${t}`,e)}d=tu(d,au(t.doc))}m&&(d="SCRIPT_PLACEHOLDER");const f=uu(e,n,r,s,a,i);return p||m||g||!d||!f||(d=o?o(d,e.parentElement):d.replace(/[\S]/g,"*")),g&&d&&(c.textarea||f)&&(d=l?l(d,e.parentNode):d.replace(/[\S]/g,"*")),"OPTION"===u&&d&&(d=Oh({isMasked:uu(e,n,r,s,a,Dh({type:null,tagName:u,maskInputOptions:c})),element:e,value:d,maskInputFn:l})),{type:Eh.Text,textContent:d||"",isStyle:p,rootId:h}}(e,{doc:i,maskAllText:o,maskTextClass:l,unmaskTextClass:h,maskTextSelector:u,unmaskTextSelector:d,maskTextFn:g,maskInputOptions:m,maskInputFn:f,rootId:M});case e.CDATA_SECTION_NODE:return{type:Eh.CDATA,textContent:"",rootId:M};case e.COMMENT_NODE:return{type:Eh.Comment,textContent:e.textContent||"",rootId:M};default:return!1}}(e,{doc:i,mirror:n,blockClass:s,blockSelector:r,maskAllText:o,unblockSelector:a,maskTextClass:c,unmaskTextClass:l,maskTextSelector:h,unmaskTextSelector:u,inlineStylesheet:p,maskInputOptions:m,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,dataURLOptions:b,inlineImages:w,recordCanvas:S,keepIframeSrcFn:P,newlyAddedElement:_});if(!I)return console.warn(e,"not serialized"),null;let R;R=n.hasNode(e)?n.getId(e):!function(e,t){if(t.comment&&e.type===Eh.Comment)return!0;if(e.type===Eh.Element){if(t.script&&("script"===e.tagName||"link"===e.tagName&&("preload"===e.attributes.rel||"modulepreload"===e.attributes.rel)||"link"===e.tagName&&"prefetch"===e.attributes.rel&&"string"==typeof e.attributes.href&&"js"===Gh(e.attributes.href)))return!0;if(t.headFavicon&&("link"===e.tagName&&"shortcut icon"===e.attributes.rel||"meta"===e.tagName&&(du(e.attributes.name).match(/^msapplication-tile(image|color)$/)||"application-name"===du(e.attributes.name)||"icon"===du(e.attributes.rel)||"apple-touch-icon"===du(e.attributes.rel)||"shortcut icon"===du(e.attributes.rel))))return!0;if("meta"===e.tagName){if(t.headMetaDescKeywords&&du(e.attributes.name).match(/^description|keywords$/))return!0;if(t.headMetaSocial&&(du(e.attributes.property).match(/^(og|twitter|fb):/)||du(e.attributes.name).match(/^(og|twitter):/)||"pinterest"===du(e.attributes.name)))return!0;if(t.headMetaRobots&&("robots"===du(e.attributes.name)||"googlebot"===du(e.attributes.name)||"bingbot"===du(e.attributes.name)))return!0;if(t.headMetaHttpEquiv&&void 0!==e.attributes["http-equiv"])return!0;if(t.headMetaAuthorship&&("author"===du(e.attributes.name)||"generator"===du(e.attributes.name)||"framework"===du(e.attributes.name)||"publisher"===du(e.attributes.name)||"progid"===du(e.attributes.name)||du(e.attributes.property).match(/^article:/)||du(e.attributes.property).match(/^product:/)))return!0;if(t.headMetaVerification&&("google-site-verification"===du(e.attributes.name)||"yandex-verification"===du(e.attributes.name)||"csrf-token"===du(e.attributes.name)||"p:domain_verify"===du(e.attributes.name)||"verify-v1"===du(e.attributes.name)||"verification"===du(e.attributes.name)||"shopify-checkout-api-token"===du(e.attributes.name)))return!0}}return!1}(I,v)&&(A||I.type!==Eh.Text||I.isStyle||I.textContent.replace(/^\s+|\s+$/gm,"").length)?Yh():-2;const D=Object.assign(I,{id:R});if(n.add(e,D),-2===R)return null;M&&M(e);let O=!d;if(D.type===Eh.Element){O=O&&!D.needBlock;const t=e.shadowRoot;t&&_h(t)&&(D.isShadowHost=!0)}if((D.type===Eh.Document||D.type===Eh.Element)&&O){v.headWhitespace&&D.type===Eh.Element&&"head"===D.tagName&&(A=!1);const t={doc:i,mirror:n,blockClass:s,blockSelector:r,maskAllText:o,unblockSelector:a,maskTextClass:c,unmaskTextClass:l,maskTextSelector:h,unmaskTextSelector:u,skipChild:d,inlineStylesheet:p,maskInputOptions:m,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOMOptions:v,dataURLOptions:b,inlineImages:w,recordCanvas:S,preserveWhiteSpace:A,onSerialize:M,onIframeLoad:x,iframeLoadTimeout:C,onBlockedImageLoad:T,onStylesheetLoad:k,stylesheetLoadTimeout:E,keepIframeSrcFn:P},_=e.childNodes?Array.from(e.childNodes):[];for(const e of _){const i=pu(e,t);i&&D.childNodes.push(i)}if(function(e){return e.nodeType===e.ELEMENT_NODE}(e)&&e.shadowRoot)for(const i of Array.from(e.shadowRoot.childNodes)){const n=pu(i,t);n&&(_h(e.shadowRoot)&&(n.isShadow=!0),D.childNodes.push(n))}}if(e.parentNode&&Ph(e.parentNode)&&_h(e.parentNode)&&(D.isShadow=!0),D.type!==Eh.Element||"iframe"!==D.tagName||D.needBlock||function(e,t,i){const n=e.contentWindow;if(!n)return;let s,r=!1;try{s=n.document.readyState}catch(e){return}if("complete"!==s){const n=jh(()=>{r||(t(),r=!0)},i);return void e.addEventListener("load",()=>{Wh(n),r=!0,t()})}const a="about:blank";if(n.location.href!==a||e.src===a||""===e.src)return jh(t,0),e.addEventListener("load",t);e.addEventListener("load",t)}(e,()=>{const t=Nh(e);if(t&&x){const i=pu(t,{doc:t,mirror:n,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:o,maskTextClass:c,unmaskTextClass:l,maskTextSelector:h,unmaskTextSelector:u,skipChild:!1,inlineStylesheet:p,maskInputOptions:m,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOMOptions:v,dataURLOptions:b,inlineImages:w,recordCanvas:S,preserveWhiteSpace:A,onSerialize:M,onIframeLoad:x,iframeLoadTimeout:C,onStylesheetLoad:k,stylesheetLoadTimeout:E,keepIframeSrcFn:P});i&&x(e,i)}},C),D.type===Eh.Element&&"img"===D.tagName&&!e.complete&&D.needBlock){const t=e,i=()=>{if(t.isConnected&&!t.complete&&T)try{const e=t.getBoundingClientRect();e.width>0&&e.height>0&&T(t,D,e)}catch(e){}t.removeEventListener("load",i)};t.isConnected&&t.addEventListener("load",i)}return D.type===Eh.Element&&"link"===D.tagName&&"string"==typeof D.attributes.rel&&("stylesheet"===D.attributes.rel||"preload"===D.attributes.rel&&"string"==typeof D.attributes.href&&"css"===Gh(D.attributes.href))&&function(e,t,i){let n,s=!1;try{n=e.sheet}catch(e){return}if(n)return;const r=jh(()=>{s||(t(),s=!0)},i);e.addEventListener("load",()=>{Wh(r),s=!0,t()})}(e,()=>{if(k){const t=pu(e,{doc:i,mirror:n,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:o,maskTextClass:c,unmaskTextClass:l,maskTextSelector:h,unmaskTextSelector:u,skipChild:!1,inlineStylesheet:p,maskInputOptions:m,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOMOptions:v,dataURLOptions:b,inlineImages:w,recordCanvas:S,preserveWhiteSpace:A,onSerialize:M,onIframeLoad:x,iframeLoadTimeout:C,onStylesheetLoad:k,stylesheetLoadTimeout:E,keepIframeSrcFn:P});t&&k(e,t)}},E),D.type===Eh.Element&&delete D.needBlock,D}function mu(e,t,i=document){const n={capture:!0,passive:!0};return i.addEventListener(e,t,n),()=>i.removeEventListener(e,t,n)}const gu="Please stop import mirror directly. Instead of that,\r\nnow you can use replayer.getMirror() to access the mirror instance of a replayer,\r\nor you can use record.mirror to access the mirror instance during recording.";let fu={map:{},getId:()=>(console.error(gu),-1),getNode:()=>(console.error(gu),null),removeNodeFromMap(){console.error(gu)},has:()=>(console.error(gu),!1),reset(){console.error(gu)}};function yu(e,t,i={}){let n=null,s=0;return function(...r){const a=Date.now();s||!1!==i.leading||(s=a);const o=t-(a-s),c=this;o<=0||o>t?(n&&(function(...e){Bu("clearTimeout")(...e)}(n),n=null),s=a,e.apply(c,r)):n||!1===i.trailing||(n=Fu(()=>{s=!1===i.leading?0:Date.now(),n=null,e.apply(c,r)},o))}}function vu(e,t,i,n,s=window){const r=s.Object.getOwnPropertyDescriptor(e,t);return s.Object.defineProperty(e,t,n?i:{set(e){Fu(()=>{i.set.call(this,e)},0),r&&r.set&&r.set.call(this,e)}}),()=>vu(e,t,r||{},!0)}function bu(e,t,i){try{if(!(t in e))return()=>{};const n=e[t],s=i(n);return"function"==typeof s&&(s.prototype=s.prototype||{},Object.defineProperties(s,{__rrweb_original__:{enumerable:!1,value:n}})),e[t]=s,()=>{e[t]=n}}catch{return()=>{}}}"undefined"!=typeof window&&window.Proxy&&window.Reflect&&(fu=new Proxy(fu,{get:(e,t,i)=>("map"===t&&console.error(gu),Reflect.get(e,t,i))}));let wu=Date.now;function Su(e){const t=e.document;return{left:t.scrollingElement?t.scrollingElement.scrollLeft:void 0!==e.pageXOffset?e.pageXOffset:t?.documentElement.scrollLeft||t?.body?.parentElement?.scrollLeft||t?.body?.scrollLeft||0,top:t.scrollingElement?t.scrollingElement.scrollTop:void 0!==e.pageYOffset?e.pageYOffset:t?.documentElement.scrollTop||t?.body?.parentElement?.scrollTop||t?.body?.scrollTop||0}}function Mu(){return window.innerHeight||document.documentElement&&document.documentElement.clientHeight||document.body&&document.body.clientHeight}function xu(){return window.innerWidth||document.documentElement&&document.documentElement.clientWidth||document.body&&document.body.clientWidth}function Cu(e){if(!e)return null;try{return e.nodeType===e.ELEMENT_NODE?e:e.parentElement}catch(e){return null}}function Tu(e,t,i,n,s){if(!e)return!1;const r=Cu(e);if(!r)return!1;const a=hu(t,i);if(!s){const e=n&&r.matches(n);return a(r)&&!e}const o=lu(r,a);let c=-1;return!(o<0)&&(n&&(c=lu(r,hu(null,n))),o>-1&&c<0||o<c)}function ku(e,t){return-2===t.getId(e)}function Eu(e,t){if(Ph(e))return!1;const i=t.getId(e);return!t.has(i)||(!e.parentNode||e.parentNode.nodeType!==e.DOCUMENT_NODE)&&(!e.parentNode||Eu(e.parentNode,t))}function Pu(e){return Boolean(e.changedTouches)}function _u(e,t){return Boolean("IFRAME"===e.nodeName&&t.getMeta(e))}function Au(e,t){return Boolean("LINK"===e.nodeName&&e.nodeType===e.ELEMENT_NODE&&e.getAttribute&&"stylesheet"===e.getAttribute("rel")&&t.getMeta(e))}function Iu(e){return Boolean(e?.shadowRoot)}/[1-9][0-9]{12}/.test(Date.now().toString())||(wu=()=>(new Date).getTime());class Ru{constructor(){this.id=1,this.styleIDMap=new WeakMap,this.idStyleMap=new Map}getId(e){return this.styleIDMap.get(e)??-1}has(e){return this.styleIDMap.has(e)}add(e,t){if(this.has(e))return this.getId(e);let i;return i=void 0===t?this.id++:t,this.styleIDMap.set(e,i),this.idStyleMap.set(i,e),i}getStyle(e){return this.idStyleMap.get(e)||null}reset(){this.styleIDMap=new WeakMap,this.idStyleMap=new Map,this.id=1}generateId(){return this.id++}}function Du(e){let t=null;return e.getRootNode?.()?.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&e.getRootNode().host&&(t=e.getRootNode().host),t}function Ou(e){const t=e.ownerDocument;return!!t&&(t.contains(e)||function(e){const t=e.ownerDocument;if(!t)return!1;const i=function(e){let t,i=e;for(;t=Du(i);)i=t;return i}(e);return t.contains(i)}(e))}const zu={};function Bu(e){const t=zu[e];if(t)return t;const i=window.document;let n=window[e];if(i&&"function"==typeof i.createElement)try{const t=i.createElement("iframe");t.hidden=!0,i.head.appendChild(t);const s=t.contentWindow;s&&s[e]&&(n=s[e]),i.head.removeChild(t)}catch(e){}return zu[e]=n.bind(window)}function Fu(...e){return Bu("setTimeout")(...e)}var Lu=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(Lu||{}),qu=(e=>(e[e.Mutation=0]="Mutation",e[e.MouseMove=1]="MouseMove",e[e.MouseInteraction=2]="MouseInteraction",e[e.Scroll=3]="Scroll",e[e.ViewportResize=4]="ViewportResize",e[e.Input=5]="Input",e[e.TouchMove=6]="TouchMove",e[e.MediaInteraction=7]="MediaInteraction",e[e.StyleSheetRule=8]="StyleSheetRule",e[e.CanvasMutation=9]="CanvasMutation",e[e.Font=10]="Font",e[e.Log=11]="Log",e[e.Drag=12]="Drag",e[e.StyleDeclaration=13]="StyleDeclaration",e[e.Selection=14]="Selection",e[e.AdoptedStyleSheet=15]="AdoptedStyleSheet",e[e.CustomElement=16]="CustomElement",e))(qu||{}),Gu=(e=>(e[e.MouseUp=0]="MouseUp",e[e.MouseDown=1]="MouseDown",e[e.Click=2]="Click",e[e.ContextMenu=3]="ContextMenu",e[e.DblClick=4]="DblClick",e[e.Focus=5]="Focus",e[e.Blur=6]="Blur",e[e.TouchStart=7]="TouchStart",e[e.TouchMove_Departed=8]="TouchMove_Departed",e[e.TouchEnd=9]="TouchEnd",e[e.TouchCancel=10]="TouchCancel",e))(Gu||{}),$u=(e=>(e[e.Mouse=0]="Mouse",e[e.Pen=1]="Pen",e[e.Touch=2]="Touch",e))($u||{}),Hu=(e=>(e[e.Play=0]="Play",e[e.Pause=1]="Pause",e[e.Seeked=2]="Seeked",e[e.VolumeChange=3]="VolumeChange",e[e.RateChange=4]="RateChange",e))(Hu||{});function ju(e){try{return e.contentDocument}catch(e){}}function Wu(e){return"__ln"in e}class Nu{constructor(){this.length=0,this.head=null,this.tail=null}get(e){if(e>=this.length)throw new Error("Position outside of list range");let t=this.head;for(let i=0;i<e;i++)t=t?.next||null;return t}addNode(e){const t={value:e,previous:null,next:null};if(e.__ln=t,e.previousSibling&&Wu(e.previousSibling)){const i=e.previousSibling.__ln.next;t.next=i,t.previous=e.previousSibling.__ln,e.previousSibling.__ln.next=t,i&&(i.previous=t)}else if(e.nextSibling&&Wu(e.nextSibling)&&e.nextSibling.__ln.previous){const i=e.nextSibling.__ln.previous;t.previous=i,t.next=e.nextSibling.__ln,e.nextSibling.__ln.previous=t,i&&(i.next=t)}else this.head&&(this.head.previous=t),t.next=this.head,this.head=t;null===t.next&&(this.tail=t),this.length++}removeNode(e){const t=e.__ln;this.head&&(t.previous?(t.previous.next=t.next,t.next?t.next.previous=t.previous:this.tail=t.previous):(this.head=t.next,this.head?this.head.previous=null:this.tail=null),e.__ln&&delete e.__ln,this.length--)}}const Uu=(e,t)=>`${e}@${t}`;class Vu{constructor(){this.frozen=!1,this.locked=!1,this.texts=[],this.attributes=[],this.attributeMap=new WeakMap,this.removes=[],this.mapRemoves=[],this.movedMap={},this.addedSet=new Set,this.movedSet=new Set,this.droppedSet=new Set,this.processMutations=e=>{e.forEach(this.processMutation),this.emit()},this.emit=()=>{if(this.frozen||this.locked)return;const e=[],t=new Set,i=new Nu,n=e=>{let t=e,i=-2;for(;-2===i;)t=t&&t.nextSibling,i=t&&this.mirror.getId(t);return i},s=s=>{if(!s.parentNode||!Ou(s))return;const r=Ph(s.parentNode)?this.mirror.getId(Du(s)):this.mirror.getId(s.parentNode),a=n(s);if(-1===r||-1===a)return i.addNode(s);const o=pu(s,{doc:this.doc,mirror:this.mirror,blockClass:this.blockClass,blockSelector:this.blockSelector,maskAllText:this.maskAllText,unblockSelector:this.unblockSelector,maskTextClass:this.maskTextClass,unmaskTextClass:this.unmaskTextClass,maskTextSelector:this.maskTextSelector,unmaskTextSelector:this.unmaskTextSelector,skipChild:!0,newlyAddedElement:!0,inlineStylesheet:this.inlineStylesheet,maskInputOptions:this.maskInputOptions,maskAttributeFn:this.maskAttributeFn,maskTextFn:this.maskTextFn,maskInputFn:this.maskInputFn,slimDOMOptions:this.slimDOMOptions,dataURLOptions:this.dataURLOptions,recordCanvas:this.recordCanvas,inlineImages:this.inlineImages,onSerialize:e=>{_u(e,this.mirror)&&!Tu(e,this.blockClass,this.blockSelector,this.unblockSelector,!1)&&this.iframeManager.addIframe(e),Au(e,this.mirror)&&this.stylesheetManager.trackLinkElement(e),Iu(s)&&this.shadowDomManager.addShadowRoot(s.shadowRoot,this.doc)},onIframeLoad:(e,t)=>{Tu(e,this.blockClass,this.blockSelector,this.unblockSelector,!1)||(this.iframeManager.attachIframe(e,t),e.contentWindow&&this.canvasManager.addWindow(e.contentWindow),this.shadowDomManager.observeAttachShadow(e))},onStylesheetLoad:(e,t)=>{this.stylesheetManager.attachLinkElement(e,t)},onBlockedImageLoad:(e,t,{width:i,height:n})=>{this.mutationCb({adds:[],removes:[],texts:[],attributes:[{id:t.id,attributes:{style:{width:`${i}px`,height:`${n}px`}}}]})}});o&&(e.push({parentId:r,nextId:a,node:o}),t.add(o.id))};for(;this.mapRemoves.length;)this.mirror.removeNodeFromMap(this.mapRemoves.shift());for(const e of this.movedSet)Xu(this.removes,e,this.mirror)&&!this.movedSet.has(e.parentNode)||s(e);for(const e of this.addedSet)Qu(this.droppedSet,e)||Xu(this.removes,e,this.mirror)?Qu(this.movedSet,e)?s(e):this.droppedSet.add(e):s(e);let r=null;for(;i.length;){let e=null;if(r){const t=this.mirror.getId(r.value.parentNode),i=n(r.value);-1!==t&&-1!==i&&(e=r)}if(!e){let t=i.tail;for(;t;){const i=t;if(t=t.previous,i){const t=this.mirror.getId(i.value.parentNode);if(-1===n(i.value))continue;if(-1!==t){e=i;break}{const t=i.value;if(t.parentNode&&t.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const n=t.parentNode.host;if(-1!==this.mirror.getId(n)){e=i;break}}}}}}if(!e){for(;i.head;)i.removeNode(i.head.value);break}r=e.previous,i.removeNode(e.value),s(e.value)}const a={texts:this.texts.map(e=>({id:this.mirror.getId(e.node),value:e.value})).filter(e=>!t.has(e.id)).filter(e=>this.mirror.has(e.id)),attributes:this.attributes.map(e=>{const{attributes:t}=e;if("string"==typeof t.style){const i=JSON.stringify(e.styleDiff),n=JSON.stringify(e._unchangedStyles);i.length<t.style.length&&(i+n).split("var(").length===t.style.split("var(").length&&(t.style=e.styleDiff)}return{id:this.mirror.getId(e.node),attributes:t}}).filter(e=>!t.has(e.id)).filter(e=>this.mirror.has(e.id)),removes:this.removes,adds:e};(a.texts.length||a.attributes.length||a.removes.length||a.adds.length)&&(this.texts=[],this.attributes=[],this.attributeMap=new WeakMap,this.removes=[],this.addedSet=new Set,this.movedSet=new Set,this.droppedSet=new Set,this.movedMap={},this.mutationCb(a))},this.processMutation=e=>{if(!ku(e.target,this.mirror))switch(e.type){case"characterData":{const t=e.target.textContent;Tu(e.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||t===e.oldValue||this.texts.push({value:uu(e.target,this.maskTextClass,this.maskTextSelector,this.unmaskTextClass,this.unmaskTextSelector,this.maskAllText)&&t?this.maskTextFn?this.maskTextFn(t,Cu(e.target)):t.replace(/[\S]/g,"*"):t,node:e.target});break}case"attributes":{const t=e.target;let i=e.attributeName,n=e.target.getAttribute(i);if("value"===i){const i=Lh(t),s=t.tagName;n=qh(t,s,i);const r=Dh({maskInputOptions:this.maskInputOptions,tagName:s,type:i});n=Oh({isMasked:uu(e.target,this.maskTextClass,this.maskTextSelector,this.unmaskTextClass,this.unmaskTextSelector,r),element:t,value:n,maskInputFn:this.maskInputFn})}if(Tu(e.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||n===e.oldValue)return;let s=this.attributeMap.get(e.target);if("IFRAME"===t.tagName&&"src"===i&&!this.keepIframeSrcFn(n)){if(ju(t))return;i="rr_src"}if(s||(s={node:e.target,attributes:{},styleDiff:{},_unchangedStyles:{}},this.attributes.push(s),this.attributeMap.set(e.target,s)),"type"===i&&"INPUT"===t.tagName&&"password"===(e.oldValue||"").toLowerCase()&&t.setAttribute("data-rr-is-password","true"),!cu(t.tagName,i)&&(s.attributes[i]=ou(this.doc,zh(t.tagName),zh(i),n,t,this.maskAttributeFn),"style"===i)){if(!this.unattachedDoc)try{this.unattachedDoc=document.implementation.createHTMLDocument()}catch(e){this.unattachedDoc=this.doc}const i=this.unattachedDoc.createElement("span");e.oldValue&&i.setAttribute("style",e.oldValue);for(const e of Array.from(t.style)){const n=t.style.getPropertyValue(e),r=t.style.getPropertyPriority(e);n!==i.style.getPropertyValue(e)||r!==i.style.getPropertyPriority(e)?s.styleDiff[e]=""===r?n:[n,r]:s._unchangedStyles[e]=[n,r]}for(const e of Array.from(i.style))""===t.style.getPropertyValue(e)&&(s.styleDiff[e]=!1)}break}case"childList":if(Tu(e.target,this.blockClass,this.blockSelector,this.unblockSelector,!0))return;e.addedNodes.forEach(t=>this.genAdds(t,e.target)),e.removedNodes.forEach(t=>{const i=this.mirror.getId(t),n=Ph(e.target)?this.mirror.getId(e.target.host):this.mirror.getId(e.target);Tu(e.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||ku(t,this.mirror)||!function(e,t){return-1!==t.getId(e)}(t,this.mirror)||(this.addedSet.has(t)?(Yu(this.addedSet,t),this.droppedSet.add(t)):this.addedSet.has(e.target)&&-1===i||Eu(e.target,this.mirror)||(this.movedSet.has(t)&&this.movedMap[Uu(i,n)]?Yu(this.movedSet,t):this.removes.push({parentId:n,id:i,isShadow:!(!Ph(e.target)||!_h(e.target))||void 0})),this.mapRemoves.push(t))})}},this.genAdds=(e,t)=>{if(!this.processedNodeManager.inOtherBuffer(e,this)&&!this.addedSet.has(e)&&!this.movedSet.has(e)){if(this.mirror.hasNode(e)){if(ku(e,this.mirror))return;this.movedSet.add(e);let i=null;t&&this.mirror.hasNode(t)&&(i=this.mirror.getId(t)),i&&-1!==i&&(this.movedMap[Uu(this.mirror.getId(e),i)]=!0)}else this.addedSet.add(e),this.droppedSet.delete(e);Tu(e,this.blockClass,this.blockSelector,this.unblockSelector,!1)||(e.childNodes&&e.childNodes.forEach(e=>this.genAdds(e)),Iu(e)&&e.shadowRoot.childNodes.forEach(t=>{this.processedNodeManager.add(t,this),this.genAdds(t,e)}))}}}init(e){["mutationCb","blockClass","blockSelector","unblockSelector","maskAllText","maskTextClass","unmaskTextClass","maskTextSelector","unmaskTextSelector","inlineStylesheet","maskInputOptions","maskAttributeFn","maskTextFn","maskInputFn","keepIframeSrcFn","recordCanvas","inlineImages","slimDOMOptions","dataURLOptions","doc","mirror","iframeManager","stylesheetManager","shadowDomManager","canvasManager","processedNodeManager"].forEach(t=>{this[t]=e[t]})}freeze(){this.frozen=!0,this.canvasManager.freeze()}unfreeze(){this.frozen=!1,this.canvasManager.unfreeze(),this.emit()}isFrozen(){return this.frozen}lock(){this.locked=!0,this.canvasManager.lock()}unlock(){this.locked=!1,this.canvasManager.unlock(),this.emit()}reset(){this.shadowDomManager.reset(),this.canvasManager.reset()}}function Yu(e,t){e.delete(t),t.childNodes?.forEach(t=>Yu(e,t))}function Xu(e,t,i){return 0!==e.length&&function(e,t,i){let n=t.parentNode;for(;n;){const t=i.getId(n);if(e.some(e=>e.id===t))return!0;n=n.parentNode}return!1}(e,t,i)}function Qu(e,t){return 0!==e.size&&Ju(e,t)}function Ju(e,t){const{parentNode:i}=t;return!!i&&(!!e.has(i)||Ju(e,i))}let Ku;const Zu=e=>Ku?(...t)=>{try{return e(...t)}catch(e){if(Ku&&!0===Ku(e))return()=>{};throw e}}:e,ed=[];function td(e){try{if("composedPath"in e){const t=e.composedPath();if(t.length)return t[0]}else if("path"in e&&e.path.length)return e.path[0]}catch{}return e&&e.target}function id(e,t){const i=new Vu;ed.push(i),i.init(e);let n=window.MutationObserver||window.__rrMutationObserver;const s=window?.Zone?.__symbol__?.("MutationObserver");s&&window[s]&&(n=window[s]);const r=new n(Zu(t=>{e.onMutation&&!1===e.onMutation(t)||i.processMutations.bind(i)(t)}));return r.observe(t,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),r}function nd({scrollCb:e,doc:t,mirror:i,blockClass:n,blockSelector:s,unblockSelector:r,sampling:a}){return mu("scroll",Zu(yu(Zu(a=>{const o=td(a);if(!o||Tu(o,n,s,r,!0))return;const c=i.getId(o);if(o===t&&t.defaultView){const i=Su(t.defaultView);e({id:c,x:i.left,y:i.top})}else e({id:c,x:o.scrollLeft,y:o.scrollTop})}),a.scroll||100)),t)}const sd=["INPUT","TEXTAREA","SELECT"],rd=new WeakMap;function ad({inputCb:e,doc:t,mirror:i,blockClass:n,blockSelector:s,unblockSelector:r,ignoreClass:a,ignoreSelector:o,maskInputOptions:c,maskInputFn:l,sampling:h,userTriggeredOnInput:u,maskTextClass:d,unmaskTextClass:p,maskTextSelector:m,unmaskTextSelector:g}){function f(e){let i=td(e);const h=e.isTrusted,f=i&&Bh(i.tagName);if("OPTION"===f&&(i=i.parentElement),!i||!f||sd.indexOf(f)<0||Tu(i,n,s,r,!0))return;const v=i;if(v.classList.contains(a)||o&&v.matches(o))return;const b=Lh(i);let w=qh(v,f,b),S=!1;const M=Dh({maskInputOptions:c,tagName:f,type:b}),x=uu(i,d,m,p,g,M);"radio"!==b&&"checkbox"!==b||(S=i.checked),w=Oh({isMasked:x,element:i,value:w,maskInputFn:l}),y(i,u?{text:w,isChecked:S,userTriggered:h}:{text:w,isChecked:S});const C=i.name;"radio"===b&&C&&S&&t.querySelectorAll(`input[type="radio"][name="${C}"]`).forEach(e=>{if(e!==i){const t=Oh({isMasked:x,element:e,value:qh(e,f,b),maskInputFn:l});y(e,u?{text:t,isChecked:!S,userTriggered:!1}:{text:t,isChecked:!S})}})}function y(t,n){const s=rd.get(t);if(!s||s.text!==n.text||s.isChecked!==n.isChecked){rd.set(t,n);const s=i.getId(t);Zu(e)({...n,id:s})}}const v=("last"===h.input?["change"]:["input","change"]).map(e=>mu(e,Zu(f),t)),b=t.defaultView;if(!b)return()=>{v.forEach(e=>e())};const w=b.Object.getOwnPropertyDescriptor(b.HTMLInputElement.prototype,"value"),S=[[b.HTMLInputElement.prototype,"value"],[b.HTMLInputElement.prototype,"checked"],[b.HTMLSelectElement.prototype,"value"],[b.HTMLTextAreaElement.prototype,"value"],[b.HTMLSelectElement.prototype,"selectedIndex"],[b.HTMLOptionElement.prototype,"selected"]];return w&&w.set&&v.push(...S.map(e=>vu(e[0],e[1],{set(){Zu(f)({target:this,isTrusted:!1})}},!1,b))),Zu(()=>{v.forEach(e=>e())})}function od(e){return function(e,t){if(ud("CSSGroupingRule")&&e.parentRule instanceof CSSGroupingRule||ud("CSSMediaRule")&&e.parentRule instanceof CSSMediaRule||ud("CSSSupportsRule")&&e.parentRule instanceof CSSSupportsRule||ud("CSSConditionRule")&&e.parentRule instanceof CSSConditionRule){const i=Array.from(e.parentRule.cssRules).indexOf(e);t.unshift(i)}else if(e.parentStyleSheet){const i=Array.from(e.parentStyleSheet.cssRules).indexOf(e);t.unshift(i)}return t}(e,[])}function cd(e,t,i){let n,s;return e?(e.ownerNode?n=t.getId(e.ownerNode):s=i.getId(e),{styleId:s,id:n}):{}}function ld({mirror:e,stylesheetManager:t},i){let n=null;n="#document"===i.nodeName?e.getId(i):e.getId(i.host);const s="#document"===i.nodeName?i.defaultView?.Document:i.ownerDocument?.defaultView?.ShadowRoot,r=s?.prototype?Object.getOwnPropertyDescriptor(s?.prototype,"adoptedStyleSheets"):void 0;return null!==n&&-1!==n&&s&&r?(Object.defineProperty(i,"adoptedStyleSheets",{configurable:r.configurable,enumerable:r.enumerable,get(){return r.get?.call(this)},set(e){const i=r.set?.call(this,e);if(null!==n&&-1!==n)try{t.adoptStyleSheets(e,n)}catch(e){}return i}}),Zu(()=>{Object.defineProperty(i,"adoptedStyleSheets",{configurable:r.configurable,enumerable:r.enumerable,get:r.get,set:r.set})})):()=>{}}function hd(e,t={}){const i=e.doc.defaultView;if(!i)return()=>{};let n;e.recordDOM&&(n=id(e,e.doc));const s=function({mousemoveCb:e,sampling:t,doc:i,mirror:n}){if(!1===t.mousemove)return()=>{};const s="number"==typeof t.mousemove?t.mousemove:50,r="number"==typeof t.mousemoveCallback?t.mousemoveCallback:500;let a,o=[];const c=yu(Zu(t=>{const i=Date.now()-a;e(o.map(e=>(e.timeOffset-=i,e)),t),o=[],a=null}),r),l=Zu(yu(Zu(e=>{const t=td(e),{clientX:i,clientY:s}=Pu(e)?e.changedTouches[0]:e;a||(a=wu()),o.push({x:i,y:s,id:n.getId(t),timeOffset:wu()-a}),c("undefined"!=typeof DragEvent&&e instanceof DragEvent?qu.Drag:e instanceof MouseEvent?qu.MouseMove:qu.TouchMove)}),s,{trailing:!1})),h=[mu("mousemove",l,i),mu("touchmove",l,i),mu("drag",l,i)];return Zu(()=>{h.forEach(e=>e())})}(e),r=function({mouseInteractionCb:e,doc:t,mirror:i,blockClass:n,blockSelector:s,unblockSelector:r,sampling:a}){if(!1===a.mouseInteraction)return()=>{};const o=!0===a.mouseInteraction||void 0===a.mouseInteraction?{}:a.mouseInteraction,c=[];let l=null;return Object.keys(Gu).filter(e=>Number.isNaN(Number(e))&&!e.endsWith("_Departed")&&!1!==o[e]).forEach(a=>{let o=zh(a);const h=(t=>a=>{const o=td(a);if(Tu(o,n,s,r,!0))return;let c=null,h=t;if("pointerType"in a){switch(a.pointerType){case"mouse":c=$u.Mouse;break;case"touch":c=$u.Touch;break;case"pen":c=$u.Pen}c===$u.Touch?Gu[t]===Gu.MouseDown?h="TouchStart":Gu[t]===Gu.MouseUp&&(h="TouchEnd"):$u.Pen}else Pu(a)&&(c=$u.Touch);null!==c?(l=c,(h.startsWith("Touch")&&c===$u.Touch||h.startsWith("Mouse")&&c===$u.Mouse)&&(c=null)):Gu[t]===Gu.Click&&(c=l,l=null);const u=Pu(a)?a.changedTouches[0]:a;if(!u)return;const d=i.getId(o),{clientX:p,clientY:m}=u;Zu(e)({type:Gu[h],id:d,x:p,y:m,...null!==c&&{pointerType:c}})})(a);if(window.PointerEvent)switch(Gu[a]){case Gu.MouseDown:case Gu.MouseUp:o=o.replace("mouse","pointer");break;case Gu.TouchStart:case Gu.TouchEnd:return}c.push(mu(o,h,t))}),Zu(()=>{c.forEach(e=>e())})}(e),a=nd(e),o=function({viewportResizeCb:e},{win:t}){let i=-1,n=-1;return mu("resize",Zu(yu(Zu(()=>{const t=Mu(),s=xu();i===t&&n===s||(e({width:Number(s),height:Number(t)}),i=t,n=s)}),200)),t)}(e,{win:i}),c=ad(e),l=function({mediaInteractionCb:e,blockClass:t,blockSelector:i,unblockSelector:n,mirror:s,sampling:r,doc:a}){const o=Zu(a=>yu(Zu(r=>{const o=td(r);if(!o||Tu(o,t,i,n,!0))return;const{currentTime:c,volume:l,muted:h,playbackRate:u}=o;e({type:a,id:s.getId(o),currentTime:c,volume:l,muted:h,playbackRate:u})}),r.media||500)),c=[mu("play",o(Hu.Play),a),mu("pause",o(Hu.Pause),a),mu("seeked",o(Hu.Seeked),a),mu("volumechange",o(Hu.VolumeChange),a),mu("ratechange",o(Hu.RateChange),a)];return Zu(()=>{c.forEach(e=>e())})}(e);let h=()=>{},u=()=>{},d=()=>{},p=()=>{};e.recordDOM&&(h=function({styleSheetRuleCb:e,mirror:t,stylesheetManager:i},{win:n}){if(!n.CSSStyleSheet||!n.CSSStyleSheet.prototype)return()=>{};const s=n.CSSStyleSheet.prototype.insertRule;n.CSSStyleSheet.prototype.insertRule=new Proxy(s,{apply:Zu((n,s,r)=>{const[a,o]=r,{id:c,styleId:l}=cd(s,t,i.styleMirror);return(c&&-1!==c||l&&-1!==l)&&e({id:c,styleId:l,adds:[{rule:a,index:o}]}),n.apply(s,r)})});const r=n.CSSStyleSheet.prototype.deleteRule;let a,o;n.CSSStyleSheet.prototype.deleteRule=new Proxy(r,{apply:Zu((n,s,r)=>{const[a]=r,{id:o,styleId:c}=cd(s,t,i.styleMirror);return(o&&-1!==o||c&&-1!==c)&&e({id:o,styleId:c,removes:[{index:a}]}),n.apply(s,r)})}),n.CSSStyleSheet.prototype.replace&&(a=n.CSSStyleSheet.prototype.replace,n.CSSStyleSheet.prototype.replace=new Proxy(a,{apply:Zu((n,s,r)=>{const[a]=r,{id:o,styleId:c}=cd(s,t,i.styleMirror);return(o&&-1!==o||c&&-1!==c)&&e({id:o,styleId:c,replace:a}),n.apply(s,r)})})),n.CSSStyleSheet.prototype.replaceSync&&(o=n.CSSStyleSheet.prototype.replaceSync,n.CSSStyleSheet.prototype.replaceSync=new Proxy(o,{apply:Zu((n,s,r)=>{const[a]=r,{id:o,styleId:c}=cd(s,t,i.styleMirror);return(o&&-1!==o||c&&-1!==c)&&e({id:o,styleId:c,replaceSync:a}),n.apply(s,r)})}));const c={};dd("CSSGroupingRule")?c.CSSGroupingRule=n.CSSGroupingRule:(dd("CSSMediaRule")&&(c.CSSMediaRule=n.CSSMediaRule),dd("CSSConditionRule")&&(c.CSSConditionRule=n.CSSConditionRule),dd("CSSSupportsRule")&&(c.CSSSupportsRule=n.CSSSupportsRule));const l={};return Object.entries(c).forEach(([n,s])=>{l[n]={insertRule:s.prototype.insertRule,deleteRule:s.prototype.deleteRule},s.prototype.insertRule=new Proxy(l[n].insertRule,{apply:Zu((n,s,r)=>{const[a,o]=r,{id:c,styleId:l}=cd(s.parentStyleSheet,t,i.styleMirror);return(c&&-1!==c||l&&-1!==l)&&e({id:c,styleId:l,adds:[{rule:a,index:[...od(s),o||0]}]}),n.apply(s,r)})}),s.prototype.deleteRule=new Proxy(l[n].deleteRule,{apply:Zu((n,s,r)=>{const[a]=r,{id:o,styleId:c}=cd(s.parentStyleSheet,t,i.styleMirror);return(o&&-1!==o||c&&-1!==c)&&e({id:o,styleId:c,removes:[{index:[...od(s),a]}]}),n.apply(s,r)})})}),Zu(()=>{n.CSSStyleSheet.prototype.insertRule=s,n.CSSStyleSheet.prototype.deleteRule=r,a&&(n.CSSStyleSheet.prototype.replace=a),o&&(n.CSSStyleSheet.prototype.replaceSync=o),Object.entries(c).forEach(([e,t])=>{t.prototype.insertRule=l[e].insertRule,t.prototype.deleteRule=l[e].deleteRule})})}(e,{win:i}),u=ld(e,e.doc),d=function({styleDeclarationCb:e,mirror:t,ignoreCSSAttributes:i,stylesheetManager:n},{win:s}){const r=s.CSSStyleDeclaration.prototype.setProperty;s.CSSStyleDeclaration.prototype.setProperty=new Proxy(r,{apply:Zu((s,a,o)=>{const[c,l,h]=o;if(i.has(c))return r.apply(a,[c,l,h]);const{id:u,styleId:d}=cd(a.parentRule?.parentStyleSheet,t,n.styleMirror);return(u&&-1!==u||d&&-1!==d)&&e({id:u,styleId:d,set:{property:c,value:l,priority:h},index:od(a.parentRule)}),s.apply(a,o)})});const a=s.CSSStyleDeclaration.prototype.removeProperty;return s.CSSStyleDeclaration.prototype.removeProperty=new Proxy(a,{apply:Zu((s,r,o)=>{const[c]=o;if(i.has(c))return a.apply(r,[c]);const{id:l,styleId:h}=cd(r.parentRule?.parentStyleSheet,t,n.styleMirror);return(l&&-1!==l||h&&-1!==h)&&e({id:l,styleId:h,remove:{property:c},index:od(r.parentRule)}),s.apply(r,o)})}),Zu(()=>{s.CSSStyleDeclaration.prototype.setProperty=r,s.CSSStyleDeclaration.prototype.removeProperty=a})}(e,{win:i}),e.collectFonts&&(p=function({fontCb:e,doc:t}){const i=t.defaultView;if(!i)return()=>{};const n=[],s=new WeakMap,r=i.FontFace;i.FontFace=function(e,t,i){const n=new r(e,t,i);return s.set(n,{family:e,buffer:"string"!=typeof t,descriptors:i,fontSource:"string"==typeof t?t:JSON.stringify(Array.from(new Uint8Array(t)))}),n};const a=bu(t.fonts,"add",function(t){return function(i){return Fu(Zu(()=>{const t=s.get(i);t&&(e(t),s.delete(i))}),0),t.apply(this,[i])}});return n.push(()=>{i.FontFace=r}),n.push(a),Zu(()=>{n.forEach(e=>e())})}(e)));const m=function(e){const{doc:t,mirror:i,blockClass:n,blockSelector:s,unblockSelector:r,selectionCb:a}=e;let o=!0;const c=Zu(()=>{const e=t.getSelection();if(!e||o&&e?.isCollapsed)return;o=e.isCollapsed||!1;const c=[],l=e.rangeCount||0;for(let t=0;t<l;t++){const a=e.getRangeAt(t),{startContainer:o,startOffset:l,endContainer:h,endOffset:u}=a;Tu(o,n,s,r,!0)||Tu(h,n,s,r,!0)||c.push({start:i.getId(o),startOffset:l,end:i.getId(h),endOffset:u})}a({ranges:c})});return c(),mu("selectionchange",c)}(e),g=function({doc:e,customElementCb:t}){const i=e.defaultView;return i&&i.customElements?bu(i.customElements,"define",function(e){return function(i,n,s){try{t({define:{name:i}})}catch(e){}return e.apply(this,[i,n,s])}}):()=>{}}(e),f=[];for(const t of e.plugins)f.push(t.observer(t.callback,i,t.options));return Zu(()=>{ed.forEach(e=>e.reset()),n?.disconnect(),s(),r(),a(),o(),c(),l(),h(),u(),d(),p(),m(),g(),f.forEach(e=>e())})}function ud(e){return void 0!==window[e]}function dd(e){return Boolean(void 0!==window[e]&&window[e].prototype&&"insertRule"in window[e].prototype&&"deleteRule"in window[e].prototype)}class pd{constructor(e){this.generateIdFn=e,this.iframeIdToRemoteIdMap=new WeakMap,this.iframeRemoteIdToIdMap=new WeakMap}getId(e,t,i,n){const s=i||this.getIdToRemoteIdMap(e),r=n||this.getRemoteIdToIdMap(e);let a=s.get(t);return a||(a=this.generateIdFn(),s.set(t,a),r.set(a,t)),a}getIds(e,t){const i=this.getIdToRemoteIdMap(e),n=this.getRemoteIdToIdMap(e);return t.map(t=>this.getId(e,t,i,n))}getRemoteId(e,t,i){const n=i||this.getRemoteIdToIdMap(e);if("number"!=typeof t)return t;return n.get(t)||-1}getRemoteIds(e,t){const i=this.getRemoteIdToIdMap(e);return t.map(t=>this.getRemoteId(e,t,i))}reset(e){if(!e)return this.iframeIdToRemoteIdMap=new WeakMap,void(this.iframeRemoteIdToIdMap=new WeakMap);this.iframeIdToRemoteIdMap.delete(e),this.iframeRemoteIdToIdMap.delete(e)}getIdToRemoteIdMap(e){let t=this.iframeIdToRemoteIdMap.get(e);return t||(t=new Map,this.iframeIdToRemoteIdMap.set(e,t)),t}getRemoteIdToIdMap(e){let t=this.iframeRemoteIdToIdMap.get(e);return t||(t=new Map,this.iframeRemoteIdToIdMap.set(e,t)),t}}class md{constructor(){this.crossOriginIframeMirror=new pd(Yh),this.crossOriginIframeRootIdMap=new WeakMap}addIframe(){}addLoadListener(){}attachIframe(){}}class gd{constructor(e){this.iframes=new WeakMap,this.crossOriginIframeMap=new WeakMap,this.crossOriginIframeMirror=new pd(Yh),this.crossOriginIframeRootIdMap=new WeakMap,this.mutationCb=e.mutationCb,this.wrappedEmit=e.wrappedEmit,this.stylesheetManager=e.stylesheetManager,this.recordCrossOriginIframes=e.recordCrossOriginIframes,this.crossOriginIframeStyleMirror=new pd(this.stylesheetManager.styleMirror.generateId.bind(this.stylesheetManager.styleMirror)),this.mirror=e.mirror,this.recordCrossOriginIframes&&window.addEventListener("message",this.handleMessage.bind(this))}addIframe(e){this.iframes.set(e,!0),e.contentWindow&&this.crossOriginIframeMap.set(e.contentWindow,e)}addLoadListener(e){this.loadListener=e}attachIframe(e,t){this.mutationCb({adds:[{parentId:this.mirror.getId(e),nextId:null,node:t}],removes:[],texts:[],attributes:[],isAttachIframe:!0}),this.recordCrossOriginIframes&&e.contentWindow?.addEventListener("message",this.handleMessage.bind(this)),this.loadListener?.(e);const i=ju(e);i&&i.adoptedStyleSheets&&i.adoptedStyleSheets.length>0&&this.stylesheetManager.adoptStyleSheets(i.adoptedStyleSheets,this.mirror.getId(i))}handleMessage(e){const t=e;if("rrweb"!==t.data.type||t.origin!==t.data.origin)return;if(!e.source)return;const i=this.crossOriginIframeMap.get(e.source);if(!i)return;const n=this.transformCrossOriginEvent(i,t.data.event);n&&this.wrappedEmit(n,t.data.isCheckout)}transformCrossOriginEvent(e,t){switch(t.type){case Lu.FullSnapshot:{this.crossOriginIframeMirror.reset(e),this.crossOriginIframeStyleMirror.reset(e),this.replaceIdOnNode(t.data.node,e);const i=t.data.node.id;return this.crossOriginIframeRootIdMap.set(e,i),this.patchRootIdOnNode(t.data.node,i),{timestamp:t.timestamp,type:Lu.IncrementalSnapshot,data:{source:qu.Mutation,adds:[{parentId:this.mirror.getId(e),nextId:null,node:t.data.node}],removes:[],texts:[],attributes:[],isAttachIframe:!0}}}case Lu.Meta:case Lu.Load:case Lu.DomContentLoaded:return!1;case Lu.Plugin:return t;case Lu.Custom:return this.replaceIds(t.data.payload,e,["id","parentId","previousId","nextId"]),t;case Lu.IncrementalSnapshot:switch(t.data.source){case qu.Mutation:return t.data.adds.forEach(t=>{this.replaceIds(t,e,["parentId","nextId","previousId"]),this.replaceIdOnNode(t.node,e);const i=this.crossOriginIframeRootIdMap.get(e);i&&this.patchRootIdOnNode(t.node,i)}),t.data.removes.forEach(t=>{this.replaceIds(t,e,["parentId","id"])}),t.data.attributes.forEach(t=>{this.replaceIds(t,e,["id"])}),t.data.texts.forEach(t=>{this.replaceIds(t,e,["id"])}),t;case qu.Drag:case qu.TouchMove:case qu.MouseMove:return t.data.positions.forEach(t=>{this.replaceIds(t,e,["id"])}),t;case qu.ViewportResize:return!1;case qu.MediaInteraction:case qu.MouseInteraction:case qu.Scroll:case qu.CanvasMutation:case qu.Input:return this.replaceIds(t.data,e,["id"]),t;case qu.StyleSheetRule:case qu.StyleDeclaration:return this.replaceIds(t.data,e,["id"]),this.replaceStyleIds(t.data,e,["styleId"]),t;case qu.Font:return t;case qu.Selection:return t.data.ranges.forEach(t=>{this.replaceIds(t,e,["start","end"])}),t;case qu.AdoptedStyleSheet:return this.replaceIds(t.data,e,["id"]),this.replaceStyleIds(t.data,e,["styleIds"]),t.data.styles?.forEach(t=>{this.replaceStyleIds(t,e,["styleId"])}),t}}return!1}replace(e,t,i,n){for(const s of n)(Array.isArray(t[s])||"number"==typeof t[s])&&(Array.isArray(t[s])?t[s]=e.getIds(i,t[s]):t[s]=e.getId(i,t[s]));return t}replaceIds(e,t,i){return this.replace(this.crossOriginIframeMirror,e,t,i)}replaceStyleIds(e,t,i){return this.replace(this.crossOriginIframeStyleMirror,e,t,i)}replaceIdOnNode(e,t){this.replaceIds(e,t,["id","rootId"]),"childNodes"in e&&e.childNodes.forEach(e=>{this.replaceIdOnNode(e,t)})}patchRootIdOnNode(e,t){e.type===Eh.Document||e.rootId||(e.rootId=t),"childNodes"in e&&e.childNodes.forEach(e=>{this.patchRootIdOnNode(e,t)})}}class fd{init(){}addShadowRoot(){}observeAttachShadow(){}reset(){}}class yd{constructor(e){this.shadowDoms=new WeakSet,this.restoreHandlers=[],this.mutationCb=e.mutationCb,this.scrollCb=e.scrollCb,this.bypassOptions=e.bypassOptions,this.mirror=e.mirror,this.init()}init(){this.reset(),this.patchAttachShadow(Element,document)}addShadowRoot(e,t){if(!_h(e))return;if(this.shadowDoms.has(e))return;this.shadowDoms.add(e),this.bypassOptions.canvasManager.addShadowRoot(e);const i=id({...this.bypassOptions,doc:t,mutationCb:this.mutationCb,mirror:this.mirror,shadowDomManager:this},e);this.restoreHandlers.push(()=>i.disconnect()),this.restoreHandlers.push(nd({...this.bypassOptions,scrollCb:this.scrollCb,doc:e,mirror:this.mirror})),Fu(()=>{e.adoptedStyleSheets&&e.adoptedStyleSheets.length>0&&this.bypassOptions.stylesheetManager.adoptStyleSheets(e.adoptedStyleSheets,this.mirror.getId(e.host)),this.restoreHandlers.push(ld({mirror:this.mirror,stylesheetManager:this.bypassOptions.stylesheetManager},e))},0)}observeAttachShadow(e){const t=ju(e),i=function(e){try{return e.contentWindow}catch(e){}}(e);t&&i&&this.patchAttachShadow(i.Element,t)}patchAttachShadow(e,t){const i=this;this.restoreHandlers.push(bu(e.prototype,"attachShadow",function(e){return function(n){const s=e.call(this,n);return this.shadowRoot&&Ou(this)&&i.addShadowRoot(this.shadowRoot,t),s}}))}reset(){this.restoreHandlers.forEach(e=>{try{e()}catch(e){}}),this.restoreHandlers=[],this.shadowDoms=new WeakSet,this.bypassOptions.canvasManager.resetShadowRoots()}}for(var vd="undefined"==typeof Uint8Array?[]:new Uint8Array(256),bd=0;bd<64;bd++)vd["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(bd)]=bd;class wd{reset(){}freeze(){}unfreeze(){}lock(){}unlock(){}snapshot(){}addWindow(){}addShadowRoot(){}resetShadowRoots(){}}class Sd{constructor(e){this.trackedLinkElements=new WeakSet,this.styleMirror=new Ru,this.mutationCb=e.mutationCb,this.adoptedStyleSheetCb=e.adoptedStyleSheetCb}attachLinkElement(e,t){"_cssText"in t.attributes&&this.mutationCb({adds:[],removes:[],texts:[],attributes:[{id:t.id,attributes:t.attributes}]}),this.trackLinkElement(e)}trackLinkElement(e){this.trackedLinkElements.has(e)||(this.trackedLinkElements.add(e),this.trackStylesheetInLinkElement(e))}adoptStyleSheets(e,t){if(0===e.length)return;const i={id:t,styleIds:[]},n=[];for(const t of e){let e;this.styleMirror.has(t)?e=this.styleMirror.getId(t):(e=this.styleMirror.add(t),n.push({styleId:e,rules:Array.from(t.rules||CSSRule,(e,t)=>({rule:Ih(e),index:t}))})),i.styleIds.push(e)}n.length>0&&(i.styles=n),this.adoptedStyleSheetCb(i)}reset(){this.styleMirror.reset(),this.trackedLinkElements=new WeakSet}trackStylesheetInLinkElement(e){}}class Md{constructor(){this.nodeMap=new WeakMap,this.active=!1}inOtherBuffer(e,t){const i=this.nodeMap.get(e);return i&&Array.from(i).some(e=>e!==t)}add(e,t){this.active||(this.active=!0,function(...e){Bu("requestAnimationFrame")(...e)}(()=>{this.nodeMap=new WeakMap,this.active=!1})),this.nodeMap.set(e,(this.nodeMap.get(e)||new Set).add(t))}destroy(){}}let xd,Cd;try{if(2!==Array.from([1],e=>2*e)[0]){const e=document.createElement("iframe");document.body.appendChild(e),Array.from=e.contentWindow?.Array.from||Array.from,document.body.removeChild(e)}}catch(e){console.debug("Unable to override Array.from",e)}const Td=new Rh;function kd(e={}){const{emit:t,checkoutEveryNms:i,checkoutEveryNth:n,blockClass:s="rr-block",blockSelector:r=null,unblockSelector:a=null,ignoreClass:o="rr-ignore",ignoreSelector:c=null,maskAllText:l=!1,maskTextClass:h="rr-mask",unmaskTextClass:u=null,maskTextSelector:d=null,unmaskTextSelector:p=null,inlineStylesheet:m=!0,maskAllInputs:g,maskInputOptions:f,slimDOMOptions:y,maskAttributeFn:v,maskInputFn:b,maskTextFn:w,maxCanvasSize:S=null,packFn:M,sampling:x={},dataURLOptions:C={},mousemoveWait:T,recordDOM:k=!0,recordCanvas:E=!1,recordCrossOriginIframes:P=!1,recordAfter:_=("DOMContentLoaded"===e.recordAfter?e.recordAfter:"load"),userTriggeredOnInput:A=!1,collectFonts:I=!1,inlineImages:R=!1,plugins:D,keepIframeSrcFn:O=()=>!1,ignoreCSSAttributes:z=new Set([]),errorHandler:B,onMutation:F,getCanvasManager:L}=e;Ku=B;const q=!P||window.parent===window;let G=!1;if(!q)try{window.parent.document&&(G=!1)}catch(e){G=!0}if(q&&!t)throw new Error("emit function is required");if(!q&&!G)return()=>{};void 0!==T&&void 0===x.mousemove&&(x.mousemove=T),Td.reset();const $=!0===g?{color:!0,date:!0,"datetime-local":!0,email:!0,month:!0,number:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0,textarea:!0,select:!0,radio:!0,checkbox:!0}:void 0!==f?f:{},H=!0===y||"all"===y?{script:!0,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaVerification:!0,headMetaAuthorship:"all"===y,headMetaDescKeywords:"all"===y}:y||{};let j;!function(e=window){"NodeList"in e&&!e.NodeList.prototype.forEach&&(e.NodeList.prototype.forEach=[].forEach),"DOMTokenList"in e&&!e.DOMTokenList.prototype.forEach&&(e.DOMTokenList.prototype.forEach=[].forEach),Node.prototype.contains||(Node.prototype.contains=(...e)=>{let t=e[0];if(!(0 in e))throw new TypeError("1 argument is required");do{if(this===t)return!0}while(t=t&&t.parentNode);return!1})}();let W=0;const N=e=>{for(const t of D||[])t.eventProcessor&&(e=t.eventProcessor(e));return M&&!G&&(e=M(e)),e};xd=(e,s)=>{const r=e;if(r.timestamp=wu(),!ed[0]?.isFrozen()||r.type===Lu.FullSnapshot||r.type===Lu.IncrementalSnapshot&&r.data.source===qu.Mutation||ed.forEach(e=>e.unfreeze()),q)t?.(N(r),s);else if(G){const e={type:"rrweb",event:N(r),origin:window.location.origin,isCheckout:s};window.parent.postMessage(e,"*")}if(r.type===Lu.FullSnapshot)j=r,W=0;else if(r.type===Lu.IncrementalSnapshot){if(r.data.source===qu.Mutation&&r.data.isAttachIframe)return;W++;const e=n&&W>=n,t=i&&j&&r.timestamp-j.timestamp>i;(e||t)&&ee(!0)}};const U=e=>{xd({type:Lu.IncrementalSnapshot,data:{source:qu.Mutation,...e}})},V=e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.Scroll,...e}}),Y=e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.CanvasMutation,...e}}),X=new Sd({mutationCb:U,adoptedStyleSheetCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.AdoptedStyleSheet,...e}})}),Q="boolean"==typeof __RRWEB_EXCLUDE_IFRAME__&&__RRWEB_EXCLUDE_IFRAME__?new md:new gd({mirror:Td,mutationCb:U,stylesheetManager:X,recordCrossOriginIframes:P,wrappedEmit:xd});for(const e of D||[])e.getMirror&&e.getMirror({nodeMirror:Td,crossOriginIframeMirror:Q.crossOriginIframeMirror,crossOriginIframeStyleMirror:Q.crossOriginIframeStyleMirror});const J=new Md,K=function(e,t){try{return e?e(t):new wd}catch{return console.warn("Unable to initialize CanvasManager"),new wd}}(L,{mirror:Td,win:window,mutationCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.CanvasMutation,...e}}),recordCanvas:E,blockClass:s,blockSelector:r,unblockSelector:a,maxCanvasSize:S,sampling:x.canvas,dataURLOptions:C,errorHandler:B}),Z="boolean"==typeof __RRWEB_EXCLUDE_SHADOW_DOM__&&__RRWEB_EXCLUDE_SHADOW_DOM__?new fd:new yd({mutationCb:U,scrollCb:V,bypassOptions:{onMutation:F,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:l,maskTextClass:h,unmaskTextClass:u,maskTextSelector:d,unmaskTextSelector:p,inlineStylesheet:m,maskInputOptions:$,dataURLOptions:C,maskAttributeFn:v,maskTextFn:w,maskInputFn:b,recordCanvas:E,inlineImages:R,sampling:x,slimDOMOptions:H,iframeManager:Q,stylesheetManager:X,canvasManager:K,keepIframeSrcFn:O,processedNodeManager:J},mirror:Td}),ee=(e=!1)=>{if(!k)return;xd({type:Lu.Meta,data:{href:window.location.href,width:xu(),height:Mu()}},e),X.reset(),Z.init(),ed.forEach(e=>e.lock());const t=function(e,t){const{mirror:i=new Rh,blockClass:n="rr-block",blockSelector:s=null,unblockSelector:r=null,maskAllText:a=!1,maskTextClass:o="rr-mask",unmaskTextClass:c=null,maskTextSelector:l=null,unmaskTextSelector:h=null,inlineStylesheet:u=!0,inlineImages:d=!1,recordCanvas:p=!1,maskAllInputs:m=!1,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOM:v=!1,dataURLOptions:b,preserveWhiteSpace:w,onSerialize:S,onIframeLoad:M,iframeLoadTimeout:x,onBlockedImageLoad:C,onStylesheetLoad:T,stylesheetLoadTimeout:k,keepIframeSrcFn:E=()=>!1}=t||{};return pu(e,{doc:e,mirror:i,blockClass:n,blockSelector:s,unblockSelector:r,maskAllText:a,maskTextClass:o,unmaskTextClass:c,maskTextSelector:l,unmaskTextSelector:h,skipChild:!1,inlineStylesheet:u,maskInputOptions:!0===m?{color:!0,date:!0,"datetime-local":!0,email:!0,month:!0,number:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0,textarea:!0,select:!0}:!1===m?{}:m,maskAttributeFn:g,maskTextFn:f,maskInputFn:y,slimDOMOptions:!0===v||"all"===v?{script:!0,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:"all"===v,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0}:!1===v?{}:v,dataURLOptions:b,inlineImages:d,recordCanvas:p,preserveWhiteSpace:w,onSerialize:S,onIframeLoad:M,iframeLoadTimeout:x,onBlockedImageLoad:C,onStylesheetLoad:T,stylesheetLoadTimeout:k,keepIframeSrcFn:E,newlyAddedElement:!1})}(document,{mirror:Td,blockClass:s,blockSelector:r,unblockSelector:a,maskAllText:l,maskTextClass:h,unmaskTextClass:u,maskTextSelector:d,unmaskTextSelector:p,inlineStylesheet:m,maskAllInputs:$,maskAttributeFn:v,maskInputFn:b,maskTextFn:w,slimDOM:H,dataURLOptions:C,recordCanvas:E,inlineImages:R,onSerialize:e=>{_u(e,Td)&&Q.addIframe(e),Au(e,Td)&&X.trackLinkElement(e),Iu(e)&&Z.addShadowRoot(e.shadowRoot,document)},onIframeLoad:(e,t)=>{Q.attachIframe(e,t),e.contentWindow&&K.addWindow(e.contentWindow),Z.observeAttachShadow(e)},onStylesheetLoad:(e,t)=>{X.attachLinkElement(e,t)},onBlockedImageLoad:(e,t,{width:i,height:n})=>{U({adds:[],removes:[],texts:[],attributes:[{id:t.id,attributes:{style:{width:`${i}px`,height:`${n}px`}}}]})},keepIframeSrcFn:O});if(!t)return console.warn("Failed to snapshot the document");xd({type:Lu.FullSnapshot,data:{node:t,initialOffset:Su(window)}}),ed.forEach(e=>e.unlock()),document.adoptedStyleSheets&&document.adoptedStyleSheets.length>0&&X.adoptStyleSheets(document.adoptedStyleSheets,Td.getId(document))};Cd=ee;try{const e=[],t=e=>Zu(hd)({onMutation:F,mutationCb:U,mousemoveCb:(e,t)=>xd({type:Lu.IncrementalSnapshot,data:{source:t,positions:e}}),mouseInteractionCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.MouseInteraction,...e}}),scrollCb:V,viewportResizeCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.ViewportResize,...e}}),inputCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.Input,...e}}),mediaInteractionCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.MediaInteraction,...e}}),styleSheetRuleCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.StyleSheetRule,...e}}),styleDeclarationCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.StyleDeclaration,...e}}),canvasMutationCb:Y,fontCb:e=>xd({type:Lu.IncrementalSnapshot,data:{source:qu.Font,...e}}),selectionCb:e=>{xd({type:Lu.IncrementalSnapshot,data:{source:qu.Selection,...e}})},customElementCb:e=>{xd({type:Lu.IncrementalSnapshot,data:{source:qu.CustomElement,...e}})},blockClass:s,ignoreClass:o,ignoreSelector:c,maskAllText:l,maskTextClass:h,unmaskTextClass:u,maskTextSelector:d,unmaskTextSelector:p,maskInputOptions:$,inlineStylesheet:m,sampling:x,recordDOM:k,recordCanvas:E,inlineImages:R,userTriggeredOnInput:A,collectFonts:I,doc:e,maskAttributeFn:v,maskInputFn:b,maskTextFn:w,keepIframeSrcFn:O,blockSelector:r,unblockSelector:a,slimDOMOptions:H,dataURLOptions:C,mirror:Td,iframeManager:Q,stylesheetManager:X,shadowDomManager:Z,processedNodeManager:J,canvasManager:K,ignoreCSSAttributes:z,plugins:D?.filter(e=>e.observer)?.map(e=>({observer:e.observer,options:e.options,callback:t=>xd({type:Lu.Plugin,data:{plugin:e.name,payload:t}})}))||[]},{});Q.addLoadListener(i=>{try{e.push(t(i.contentDocument))}catch(e){console.warn(e)}});const i=()=>{ee(),e.push(t(document))};return"interactive"===document.readyState||"complete"===document.readyState?i():(e.push(mu("DOMContentLoaded",()=>{xd({type:Lu.DomContentLoaded,data:{}}),"DOMContentLoaded"===_&&i()})),e.push(mu("load",()=>{xd({type:Lu.Load,data:{}}),"load"===_&&i()},window))),()=>{e.forEach(e=>e()),J.destroy(),Cd=void 0,Ku=void 0}}catch(e){console.warn(e)}}var Ed,Pd;function _d(e){return e>9999999999?e:1e3*e}function Ad(e){return e>9999999999?e/1e3:e}function Id(e,t){"sentry.transaction"!==t.category&&(["ui.click","ui.input"].includes(t.category)?e.triggerUserActivity():e.checkAndHandleExpiredSession(),e.addUpdate(()=>(e.throttledAddEvent({type:Lu.Custom,timestamp:1e3*(t.timestamp||0),data:{tag:"breadcrumb",payload:Nr(t,10,1e3)}}),"console"===t.category)))}function Rd(e){return e.closest("button,a")||e}function Dd(e){const t=Od(e);return t&&t instanceof Element?Rd(t):t}function Od(e){return function(e){return"object"==typeof e&&!!e&&"target"in e}(e)?e.target:e}let zd;kd.mirror=Td,kd.takeFullSnapshot=function(e){if(!Cd)throw new Error("please take full snapshot after start recording");Cd(e)},(Pd=Ed||(Ed={}))[Pd.NotStarted=0]="NotStarted",Pd[Pd.Running=1]="Running",Pd[Pd.Stopped=2]="Stopped";const Bd=new Set([qu.Mutation,qu.StyleSheetRule,qu.StyleDeclaration,qu.AdoptedStyleSheet,qu.CanvasMutation,qu.Selection,qu.MediaInteraction]);class Fd{constructor(e,t,i=Id){this._lastMutation=0,this._lastScroll=0,this._clicks=[],this._timeout=t.timeout/1e3,this._threshold=t.threshold/1e3,this._scrollTimeout=t.scrollTimeout/1e3,this._replay=e,this._ignoreSelector=t.ignoreSelector,this._addBreadcrumbEvent=i}addListeners(){const e=(t=()=>{this._lastMutation=qd()},zd||(zd=[],is(bh,"open",function(e){return function(...t){if(zd)try{zd.forEach(e=>e())}catch{}return e.apply(bh,t)}})),zd.push(t),()=>{const e=zd?zd.indexOf(t):-1;e>-1&&zd.splice(e,1)});var t;this._teardown=()=>{e(),this._clicks=[],this._lastMutation=0,this._lastScroll=0}}removeListeners(){this._teardown&&this._teardown(),this._checkClickTimeout&&clearTimeout(this._checkClickTimeout)}handleClick(e,t){if(function(e,t){return!Ld.includes(e.tagName)||("INPUT"===e.tagName&&!["submit","button"].includes(e.getAttribute("type")||"")||(!("A"!==e.tagName||!(e.hasAttribute("download")||e.hasAttribute("target")&&"_self"!==e.getAttribute("target")))||!(!t||!e.matches(t))))}(t,this._ignoreSelector)||!function(e){return!(!e.data||"number"!=typeof e.data.nodeId||!e.timestamp)}(e))return;const i={timestamp:Ad(e.timestamp),clickBreadcrumb:e,clickCount:0,node:t};this._clicks.some(e=>e.node===i.node&&Math.abs(e.timestamp-i.timestamp)<1)||(this._clicks.push(i),1===this._clicks.length&&this._scheduleCheckClicks())}registerMutation(e=Date.now()){this._lastMutation=Ad(e)}registerScroll(e=Date.now()){this._lastScroll=Ad(e)}registerClick(e){const t=Rd(e);this._handleMultiClick(t)}_handleMultiClick(e){this._getClicks(e).forEach(e=>{e.clickCount++})}_getClicks(e){return this._clicks.filter(t=>t.node===e)}_checkClicks(){const e=[],t=qd();this._clicks.forEach(i=>{!i.mutationAfter&&this._lastMutation&&(i.mutationAfter=i.timestamp<=this._lastMutation?this._lastMutation-i.timestamp:void 0),!i.scrollAfter&&this._lastScroll&&(i.scrollAfter=i.timestamp<=this._lastScroll?this._lastScroll-i.timestamp:void 0),i.timestamp+this._timeout<=t&&e.push(i)});for(const t of e){const e=this._clicks.indexOf(t);e>-1&&(this._generateBreadcrumbs(t),this._clicks.splice(e,1))}this._clicks.length&&this._scheduleCheckClicks()}_generateBreadcrumbs(e){const t=this._replay,i=e.scrollAfter&&e.scrollAfter<=this._scrollTimeout,n=e.mutationAfter&&e.mutationAfter<=this._threshold,s=!i&&!n,{clickCount:r,clickBreadcrumb:a}=e;if(s){const i=1e3*Math.min(e.mutationAfter||this._timeout,this._timeout),n=i<1e3*this._timeout?"mutation":"timeout",s={type:"default",message:a.message,timestamp:a.timestamp,category:"ui.slowClickDetected",data:{...a.data,url:bh.location.href,route:t.getCurrentRoute(),timeAfterClickMs:i,endReason:n,clickCount:r||1}};return void this._addBreadcrumbEvent(t,s)}if(r>1){const e={type:"default",message:a.message,timestamp:a.timestamp,category:"ui.multiClick",data:{...a.data,url:bh.location.href,route:t.getCurrentRoute(),clickCount:r,metric:!0}};this._addBreadcrumbEvent(t,e)}}_scheduleCheckClicks(){this._checkClickTimeout&&clearTimeout(this._checkClickTimeout),this._checkClickTimeout=Gl(()=>this._checkClicks(),1e3)}}const Ld=["A","BUTTON","INPUT"];function qd(){return Date.now()/1e3}function Gd(e){return{timestamp:Date.now()/1e3,type:"default",...e}}var $d=(e=>(e[e.Document=0]="Document",e[e.DocumentType=1]="DocumentType",e[e.Element=2]="Element",e[e.Text=3]="Text",e[e.CDATA=4]="CDATA",e[e.Comment=5]="Comment",e))($d||{});const Hd=new Set(["id","class","aria-label","role","name","alt","title","data-test-id","data-testid","disabled","aria-disabled","data-sentry-component"]);function jd(e){const t={};!e["data-sentry-component"]&&e["data-sentry-element"]&&(e["data-sentry-component"]=e["data-sentry-element"]);for(const i in e)if(Hd.has(i)){let n=i;"data-testid"!==i&&"data-test-id"!==i||(n="testId"),t[n]=e[i]}return t}function Wd(e,t){const i=kd.mirror.getId(e),n=i&&kd.mirror.getNode(i),s=n&&kd.mirror.getMeta(n),r=s&&function(e){return e.type===$d.Element}(s)?s:null;return{message:t,data:r?{nodeId:i,node:{id:i,tagName:r.tagName,textContent:Array.from(r.childNodes).map(e=>e.type===$d.Text&&e.textContent).filter(Boolean).map(e=>e.trim()).join(""),attributes:jd(r.attributes)}}:{}}}const Nd={resource:function(e){const{entryType:t,initiatorType:i,name:n,responseEnd:s,startTime:r,decodedBodySize:a,encodedBodySize:o,responseStatus:c,transferSize:l}=e;return["fetch","xmlhttprequest"].includes(i)?null:{type:`${t}.${i}`,start:Yd(r),end:Yd(s),name:n,data:{size:l,statusCode:c,decodedBodySize:a,encodedBodySize:o}}},paint:function(e){const{duration:t,entryType:i,name:n,startTime:s}=e,r=Yd(s);return{type:i,name:n,start:r,end:r+t,data:void 0}},navigation:function(e){const{entryType:t,name:i,decodedBodySize:n,duration:s,domComplete:r,encodedBodySize:a,domContentLoadedEventStart:o,domContentLoadedEventEnd:c,domInteractive:l,loadEventStart:h,loadEventEnd:u,redirectCount:d,startTime:p,transferSize:m,type:g}=e;return 0===s?null:{type:`${t}.${g}`,start:Yd(p),end:Yd(r),name:i,data:{size:m,decodedBodySize:n,encodedBodySize:a,duration:s,domInteractive:l,domContentLoadedEventStart:o,domContentLoadedEventEnd:c,loadEventStart:h,loadEventEnd:u,domComplete:r,redirectCount:d}}}};function Ud(e,t){return({metric:i})=>{t.replayPerformanceEntries.push(e(i))}}function Vd(e){const t=Nd[e.entryType];return t?t(e):null}function Yd(e){return((ws()||bh.performance.timeOrigin)+e)/1e3}function Xd(e){const t=e.entries[e.entries.length-1];return Zd(e,"largest-contentful-paint",t?.element?[t.element]:void 0)}function Qd(e){return void 0!==e.sources}function Jd(e){const t=[],i=[];for(const n of e.entries)if(Qd(n)){const e=[];for(const t of n.sources)if(t.node){i.push(t.node);const n=kd.mirror.getId(t.node);n&&e.push(n)}t.push({value:n.value,nodeIds:e.length?e:void 0})}return Zd(e,"cumulative-layout-shift",i,t)}function Kd(e){const t=e.entries[e.entries.length-1];return Zd(e,"interaction-to-next-paint",t?.target?[t.target]:void 0)}function Zd(e,t,i,n){const s=e.value,r=e.rating,a=Yd(s);return{type:"web-vital",name:t,start:a,end:a,data:{value:s,size:s,rating:r,nodeIds:i?i.map(e=>kd.mirror.getId(e)):void 0,attributions:n}}}const ep="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,tp=["log","warn","error"],ip="[Replay] ";function np(e,t="info"){Mo({category:"console",data:{logger:"replay"},level:t,message:`${ip}${e}`},{level:t})}const sp=function(){let e=!1,t=!1;const i={exception:()=>{},infoTick:()=>{},setConfig:i=>{e=!!i.captureExceptions,t=!!i.traceInternals}};return ep?(tp.forEach(e=>{i[e]=(...i)=>{pn[e](ip,...i),t&&np(i.join(""),Bo(e))}}),i.exception=(n,...s)=>{s.length&&i.error&&i.error(...s),pn.error(ip,n),e?Da(n,{mechanism:{handled:!0,type:"auto.function.replay.debug"}}):t&&np(n,"error")},i.infoTick=(...e)=>{pn.log(ip,...e),t&&setTimeout(()=>np(e[0]),0)}):tp.forEach(e=>{i[e]=()=>{}}),i}();class rp extends Error{constructor(){super("Event buffer exceeded maximum size of 20000000.")}}class ap{constructor(){this.events=[],this._totalSize=0,this.hasCheckout=!1,this.waitForCheckout=!1}get hasEvents(){return this.events.length>0}get type(){return"sync"}destroy(){this.events=[]}async addEvent(e){const t=JSON.stringify(e).length;if(this._totalSize+=t,this._totalSize>Ch)throw new rp;this.events.push(e)}finish(){return new Promise(e=>{const t=this.events;this.clear(),e(JSON.stringify(t))})}clear(){this.events=[],this._totalSize=0,this.hasCheckout=!1}getEarliestTimestamp(){const e=this.events.map(e=>e.timestamp).sort()[0];return e?_d(e):null}}class op{constructor(e){this._worker=e,this._id=0}ensureReady(){return this._ensureReadyPromise||(this._ensureReadyPromise=new Promise((e,t)=>{this._worker.addEventListener("message",({data:i})=>{i.success?e():t()},{once:!0}),this._worker.addEventListener("error",e=>{t(e)},{once:!0})})),this._ensureReadyPromise}destroy(){ep&&sp.log("Destroying compression worker"),this._worker.terminate()}postMessage(e,t){const i=this._getAndIncrementId();return new Promise((n,s)=>{const r=({data:t})=>{const a=t;if(a.method===e&&a.id===i){if(this._worker.removeEventListener("message",r),!a.success)return ep&&sp.error("Error in compression worker: ",a.response),void s(new Error("Error in compression worker"));n(a.response)}};this._worker.addEventListener("message",r),this._worker.postMessage({id:i,method:e,arg:t})})}_getAndIncrementId(){return this._id++}}class cp{constructor(e){this._worker=new op(e),this._earliestTimestamp=null,this._totalSize=0,this.hasCheckout=!1,this.waitForCheckout=!1}get hasEvents(){return!!this._earliestTimestamp}get type(){return"worker"}ensureReady(){return this._worker.ensureReady()}destroy(){this._worker.destroy()}addEvent(e){const t=_d(e.timestamp);(!this._earliestTimestamp||t<this._earliestTimestamp)&&(this._earliestTimestamp=t);const i=JSON.stringify(e);return this._totalSize+=i.length,this._totalSize>Ch?Promise.reject(new rp):this._sendEventToWorker(i)}finish(){return this._finishRequest()}clear(){this._earliestTimestamp=null,this._totalSize=0,this.hasCheckout=!1,this._worker.postMessage("clear").then(null,e=>{ep&&sp.exception(e,'Sending "clear" message to worker failed',e)})}getEarliestTimestamp(){return this._earliestTimestamp}_sendEventToWorker(e){return this._worker.postMessage("addEvent",e)}async _finishRequest(){const e=await this._worker.postMessage("finish");return this._earliestTimestamp=null,this._totalSize=0,e}}class lp{constructor(e){this._fallback=new ap,this._compression=new cp(e),this._used=this._fallback,this._ensureWorkerIsLoadedPromise=this._ensureWorkerIsLoaded()}get waitForCheckout(){return this._used.waitForCheckout}get type(){return this._used.type}get hasEvents(){return this._used.hasEvents}get hasCheckout(){return this._used.hasCheckout}set hasCheckout(e){this._used.hasCheckout=e}set waitForCheckout(e){this._used.waitForCheckout=e}destroy(){this._fallback.destroy(),this._compression.destroy()}clear(){return this._used.clear()}getEarliestTimestamp(){return this._used.getEarliestTimestamp()}addEvent(e){return this._used.addEvent(e)}async finish(){return await this.ensureWorkerIsLoaded(),this._used.finish()}ensureWorkerIsLoaded(){return this._ensureWorkerIsLoadedPromise}async _ensureWorkerIsLoaded(){try{await this._compression.ensureReady()}catch(e){return void(ep&&sp.exception(e,"Failed to load the compression worker, falling back to simple buffer"))}await this._switchToCompressionWorker()}async _switchToCompressionWorker(){const{events:e,hasCheckout:t,waitForCheckout:i}=this._fallback,n=[];for(const t of e)n.push(this._compression.addEvent(t));this._compression.hasCheckout=t,this._compression.waitForCheckout=i,this._used=this._compression;try{await Promise.all(n),this._fallback.clear()}catch(e){ep&&sp.exception(e,"Failed to add events when switching buffers.")}}}function hp(){try{return"sessionStorage"in bh&&!!bh.sessionStorage}catch{return!1}}function up(e){return void 0!==e&&Math.random()<e}function dp(e){if(hp())try{bh.sessionStorage.setItem(wh,JSON.stringify(e))}catch{}}function pp(e){const t=Date.now();return{id:e.id||ds(),started:e.started||t,lastActivity:e.lastActivity||t,segmentId:e.segmentId||0,sampled:e.sampled,previousSessionId:e.previousSessionId}}function mp({sessionSampleRate:e,allowBuffering:t,stickySession:i=!1},{previousSessionId:n}={}){const s=function(e,t){return up(e)?"session":!!t&&"buffer"}(e,t),r=pp({sampled:s,previousSessionId:n});return i&&dp(r),r}function gp(e,t,i=+new Date){return null===e||void 0===t||t<0||0!==t&&e+t<=i}function fp(e,{maxReplayDuration:t,sessionIdleExpire:i,targetTime:n=Date.now()}){return gp(e.started,t,n)||gp(e.lastActivity,i,n)}function yp(e,{sessionIdleExpire:t,maxReplayDuration:i}){return!!fp(e,{sessionIdleExpire:t,maxReplayDuration:i})&&("buffer"!==e.sampled||0!==e.segmentId)}function vp({sessionIdleExpire:e,maxReplayDuration:t,previousSessionId:i},n){const s=n.stickySession&&function(){if(!hp())return null;try{const e=bh.sessionStorage.getItem(wh);if(!e)return null;const t=JSON.parse(e);return ep&&sp.infoTick("Loading existing session"),pp(t)}catch{return null}}();return s?yp(s,{sessionIdleExpire:e,maxReplayDuration:t})?(ep&&sp.infoTick("Session in sessionStorage is expired, creating new one..."),mp(n,{previousSessionId:s.id})):s:(ep&&sp.infoTick("Creating new session"),mp(n,{previousSessionId:i}))}function bp(e,t,i){return!!Sp(e,t)&&(wp(e,t,i),!0)}async function wp(e,t,i){const{eventBuffer:n}=e;if(!n||n.waitForCheckout&&!i)return null;const s="buffer"===e.recordingMode;try{i&&s&&n.clear(),i&&(n.hasCheckout=!0,n.waitForCheckout=!1);const r=function(e,t){try{if("function"==typeof t&&function(e){return e.type===Lu.Custom}(e))return t(e)}catch(e){return ep&&sp.exception(e,"An error occurred in the `beforeAddRecordingEvent` callback, skipping the event..."),null}return e}(t,e.getOptions().beforeAddRecordingEvent);if(!r)return;return await n.addEvent(r)}catch(t){const i=t&&t instanceof rp,r=i?"addEventSizeExceeded":"addEvent",a=Ls();if(a){const e=i?"buffer_overflow":"internal_sdk_error";a.recordDroppedEvent(e,"replay")}if(i&&s)return n.clear(),n.waitForCheckout=!0,null;e.handleException(t),await e.stop({reason:r})}}function Sp(e,t){if(!e.eventBuffer||e.isPaused()||!e.isEnabled())return!1;const i=_d(t.timestamp);return!(i+e.timeouts.sessionIdlePause<Date.now()||i>e.getContext().initialTimestamp+e.getOptions().maxReplayDuration&&(ep&&sp.infoTick(`Skipping event with timestamp ${i} because it is after maxReplayDuration`),1))}function Mp(e){return!e.type}function xp(e){return"transaction"===e.type}function Cp(e){return"feedback"===e.type}function Tp(e){return!!e.category}function kp(){const e=zs().getPropagationContext().dsc;e&&delete e.replay_id;const t=Ar();t&&delete jr(t).replay_id}function Ep(e,t){return t.map(({type:t,start:i,end:n,name:s,data:r})=>{const a=e.throttledAddEvent({type:Lu.Custom,timestamp:i,data:{tag:"performanceSpan",payload:{op:t,description:s,startTimestamp:i,endTimestamp:n,data:r}}});return"string"==typeof a?Promise.resolve(null):a})}function Pp(e,t){e.isEnabled()&&null!==t&&(function(e,t){return(!ep||!e.getOptions()._experiments.traceInternals)&&function(e,t){const i=t?.getDsn(),n=t?.getOptions().tunnel;return function(e,t){const i=go(e);return!(!i||mo(i))&&!!t&&i.host.includes(t.host)&&/(^|&|\?)sentry_key=/.test(i.search)}(e,i)||function(e,t){return!!t&&vo(e)===vo(t)}(e,n)}(t,Ls())}(e,t.name)||e.addUpdate(()=>(Ep(e,[t]),!0)))}function _p(e){if(!e)return;const t=new TextEncoder;try{if("string"==typeof e)return t.encode(e).length;if(e instanceof URLSearchParams)return t.encode(e.toString()).length;if(e instanceof FormData){const i=Wl(e);return t.encode(i).length}if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer)return e.byteLength}catch{}}function Ap(e){if(!e)return;const t=parseInt(e,10);return isNaN(t)?void 0:t}function Ip(e,t){if(!e)return{headers:{},size:void 0,_meta:{warnings:[t]}};const i={...e._meta},n=i.warnings||[];return i.warnings=[...n,t],e._meta=i,e}function Rp(e,t){if(!t)return null;const{startTimestamp:i,endTimestamp:n,url:s,method:r,statusCode:a,request:o,response:c}=t;return{type:e,start:i/1e3,end:n/1e3,name:s,data:{method:r,statusCode:a,request:o,response:c}}}function Dp(e){return{headers:{},size:e,_meta:{warnings:["URL_SKIPPED"]}}}function Op(e,t,i){if(!t&&0===Object.keys(e).length)return;if(!t)return{headers:e};if(!i)return{headers:e,size:t};const n={headers:e,size:t},{body:s,warnings:r}=function(e){if(!e||"string"!=typeof e)return{body:e};const t=e.length>Mh,i=function(e){const t=e[0],i=e[e.length-1];return"["===t&&"]"===i||"{"===t&&"}"===i}(e);if(t){const t=e.slice(0,Mh);return i?{body:t,warnings:["MAYBE_JSON_TRUNCATED"]}:{body:`${t}…`,warnings:["TEXT_TRUNCATED"]}}if(i)try{return{body:JSON.parse(e)}}catch{}return{body:e}}(i);return n.body=s,r?.length&&(n._meta={warnings:r}),n}function zp(e,t){return Object.entries(e).reduce((i,[n,s])=>{const r=n.toLowerCase();return t.includes(r)&&e[n]&&(i[r]=s),i},{})}function Bp(e,t){const i=function(e,t=bh.document.baseURI){if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith(bh.location.origin))return e;const i=new URL(e,t);if(i.origin!==new URL(t).origin)return e;const n=i.href;return!e.endsWith("/")&&n.endsWith("/")?n.slice(0,-1):n}(e);return ts(i,t)}function Fp(e,t){const i={};return t.forEach(t=>{e.get(t)&&(i[t]=e.get(t))}),i}function Lp(e,t){if(!e)return{};const i=e.headers;return i?i instanceof Headers?Fp(i,t):Array.isArray(i)?{}:zp(i,t):{}}function qp(e){const t=Ls();try{const{networkDetailAllowUrls:i,networkDetailDenyUrls:n,networkCaptureBodies:s,networkRequestHeaders:r,networkResponseHeaders:a}=e.getOptions(),o={replay:e,networkDetailAllowUrls:i,networkDetailDenyUrls:n,networkCaptureBodies:s,networkRequestHeaders:r,networkResponseHeaders:a};t&&t.on("beforeAddBreadcrumb",(e,t)=>function(e,t,i){if(t.data)try{(function(e){return"xhr"===e.category})(t)&&function(e){return e?.xhr}(i)&&(function(e,t){const{xhr:i,input:n}=t;if(!i)return;const s=_p(n),r=i.getResponseHeader("content-length")?Ap(i.getResponseHeader("content-length")):function(e,t){try{return _p("json"===t&&e&&"object"==typeof e?JSON.stringify(e):e)}catch{return}}(i.response,i.responseType);void 0!==s&&(e.data.request_body_size=s),void 0!==r&&(e.data.response_body_size=r)}(t,i),async function(e,t,i){try{const n=function(e,t,i){const n=Date.now(),{startTimestamp:s=n,endTimestamp:r=n,input:a,xhr:o}=t,{url:c,method:l,status_code:h=0,request_body_size:u,response_body_size:d}=e.data;if(!c)return null;if(!o||!Bp(c,i.networkDetailAllowUrls)||Bp(c,i.networkDetailDenyUrls))return{startTimestamp:s,endTimestamp:r,url:c,method:l,statusCode:h,request:Dp(u),response:Dp(d)};const p=o[$l],m=p?zp(p.request_headers,i.networkRequestHeaders):{},g=zp(Vl(o),i.networkResponseHeaders),[f,y]=i.networkCaptureBodies?Nl(a,sp):[void 0],[v,b]=i.networkCaptureBodies?function(e){const t=[];try{return[e.responseText]}catch(e){t.push(e)}try{return function(e,t){try{if("string"==typeof e)return[e];if(e instanceof Document)return[e.body.outerHTML];if("json"===t&&e&&"object"==typeof e)return[JSON.stringify(e)];if(!e)return[void 0]}catch(t){return ep&&sp.exception(t,"Failed to serialize body",e),[void 0,"BODY_PARSE_ERROR"]}return ep&&sp.log("Skipping network body because of body type",e),[void 0,"UNPARSEABLE_BODY_TYPE"]}(e.response,e.responseType)}catch(e){t.push(e)}return ep&&sp.warn("Failed to get xhr response body",...t),[void 0]}(o):[void 0],w=Op(m,u,f),S=Op(g,d,v);return{startTimestamp:s,endTimestamp:r,url:c,method:l,statusCode:h,request:y?Ip(w,y):w,response:b?Ip(S,b):S}}(e,t,i),s=Rp("resource.xhr",n);Pp(i.replay,s)}catch(e){ep&&sp.exception(e,"Failed to capture xhr breadcrumb")}}(t,i,e)),function(e){return"fetch"===e.category}(t)&&function(e){return e?.response}(i)&&(function(e,t){const{input:i,response:n}=t,s=_p(i?Ul(i):void 0),r=n?Ap(n.headers.get("content-length")):void 0;void 0!==s&&(e.data.request_body_size=s),void 0!==r&&(e.data.response_body_size=r)}(t,i),async function(e,t,i){try{const n=await async function(e,t,i){const n=Date.now(),{startTimestamp:s=n,endTimestamp:r=n}=t,{url:a,method:o,status_code:c=0,request_body_size:l,response_body_size:h}=e.data,u=Bp(a,i.networkDetailAllowUrls)&&!Bp(a,i.networkDetailDenyUrls),d=u?function({networkCaptureBodies:e,networkRequestHeaders:t},i,n){const s=i?(a=t,1===(r=i).length&&"string"!=typeof r[0]?Lp(r[0],a):2===r.length?Lp(r[1],a):{}):{};var r,a;if(!e)return Op(s,n,void 0);const o=Ul(i),[c,l]=Nl(o,sp),h=Op(s,n,c);return l?Ip(h,l):h}(i,t.input,l):Dp(l),p=await async function(e,{networkCaptureBodies:t,networkResponseHeaders:i},n,s){if(!e&&void 0!==s)return Dp(s);const r=n?Fp(n.headers,i):{};if(!n||!t&&void 0!==s)return Op(r,s,void 0);const[a,o]=await async function(e){const t=function(e){try{return e.clone()}catch(e){ep&&sp.exception(e,"Failed to clone response body")}}(e);if(!t)return[void 0,"BODY_PARSE_ERROR"];try{const e=await function(e){return new Promise((t,i)=>{const n=Gl(()=>i(new Error("Timeout while trying to read response body")),500);(async function(e){return await e.text()})(e).then(e=>t(e),e=>i(e)).finally(()=>clearTimeout(n))})}(t);return[e]}catch(e){return e instanceof Error&&e.message.indexOf("Timeout")>-1?(ep&&sp.warn("Parsing text body from response timed out"),[void 0,"BODY_PARSE_TIMEOUT"]):(ep&&sp.exception(e,"Failed to get text body from response"),[void 0,"BODY_PARSE_ERROR"])}}(n),c=function(e,{networkCaptureBodies:t,responseBodySize:i,captureDetails:n,headers:s}){try{const r=e?.length&&void 0===i?_p(e):i;return n?Op(s,r,t?e:void 0):Dp(r)}catch(e){return ep&&sp.exception(e,"Failed to serialize response body"),Op(s,i,void 0)}}(a,{networkCaptureBodies:t,responseBodySize:s,captureDetails:e,headers:r});return o?Ip(c,o):c}(u,i,t.response,h);return{startTimestamp:s,endTimestamp:r,url:a,method:o,statusCode:c,request:d,response:p}}(e,t,i),s=Rp("resource.fetch",n);Pp(i.replay,s)}catch(e){ep&&sp.exception(e,"Failed to capture fetch breadcrumb")}}(t,i,e))}catch(e){ep&&sp.exception(e,"Error when enriching network breadcrumb")}}(o,e,t))}catch{}}function Gp(e){const t=Ls();Dl((e=>t=>{if(!e.isEnabled())return;const i=function(e){const{target:t,message:i}=function(e){const t="click"===e.name;let i,n=null;try{n=t?Dd(e.event):Od(e.event),i=Yn(n,{maxStringLength:200})||"<unknown>"}catch{i="<unknown>"}return{target:n,message:i}}(e);return Gd({category:`ui.${e.name}`,...Wd(t,i)})}(t);if(!i)return;const n="click"===t.name,s=n?t.event:void 0;var r,a,o;!(n&&e.clickDetector&&s?.target)||s.altKey||s.metaKey||s.ctrlKey||s.shiftKey||(r=e.clickDetector,a=i,o=Dd(t.event),r.handleClick(a,o)),Id(e,i)})(e)),Bl(function(e){return t=>{if(!e.isEnabled())return;const i=function(e){const{from:t,to:i}=e,n=Date.now()/1e3;return{type:"navigation.push",start:n,end:n,name:i,data:{previous:t}}}(t);null!==i&&(e.getContext().urls.push(i.name),e.triggerUserActivity(),e.addUpdate(()=>(Ep(e,[i]),!1)))}}(e)),function(e){const t=Ls();t&&t.on("beforeAddBreadcrumb",t=>function(e,t){if(!e.isEnabled()||!Tp(t))return;const i=function(e){return!Tp(e)||["fetch","xhr","sentry.event","sentry.transaction"].includes(e.category)||e.category.startsWith("ui.")?null:"console"===e.category?function(e){const t=e.data?.arguments;if(!Array.isArray(t)||0===t.length)return Gd(e);let i=!1;const n=t.map(e=>{if(!e)return e;if("string"==typeof e)return e.length>xh?(i=!0,`${e.slice(0,xh)}…`):e;if("object"==typeof e)try{const t=Nr(e,7);return JSON.stringify(t).length>xh?(i=!0,`${JSON.stringify(t,null,2).slice(0,xh)}…`):t}catch{}return e});return Gd({...e,data:{...e.data,arguments:n,...i?{_meta:{warnings:["CONSOLE_ARG_TRUNCATED"]}}:{}}})}(e):Gd(e)}(t);i&&Id(e,i)}(e,t))}(e),qp(e);const i=function(e){return Object.assign((t,i)=>{if(!e.isEnabled()||e.isPaused())return t;if(function(e){return"replay_event"===e.type}(t))return delete t.breadcrumbs,t;if(!Mp(t)&&!xp(t)&&!Cp(t))return t;if(!e.checkAndHandleExpiredSession())return kp(),t;if(Cp(t))return e.flush(),t.contexts.feedback.replay_id=e.getSessionId(),function(e,t){e.triggerUserActivity(),e.addUpdate(()=>!t.timestamp||(e.throttledAddEvent({type:Lu.Custom,timestamp:1e3*t.timestamp,data:{tag:"breadcrumb",payload:{timestamp:t.timestamp,type:"default",category:"sentry.feedback",data:{feedbackId:t.event_id}}}}),!1))}(e,t),t;if(function(e,t){return!(e.type||!e.exception?.values?.length||!t.originalException?.__rrweb__)}(t,i)&&!e.getOptions()._experiments.captureExceptions)return ep&&sp.log("Ignoring error from rrweb internals",t),null;const n=function(e,t){return"buffer"===e.recordingMode&&t.message!==Sh&&!(!t.exception||t.type)&&up(e.getOptions().errorSampleRate)}(e,t);return(n||"session"===e.recordingMode)&&(t.tags={...t.tags,replayId:e.getSessionId()}),t},{id:"Replay"})}(e);var n;n=i,Bs().addEventProcessor(n),t&&(t.on("beforeSendEvent",function(e){return t=>{e.isEnabled()&&Mp(t)&&function(e,t){const i=t.exception?.values?.[0]?.value;"string"==typeof i&&(i.match(/(reactjs\.org\/docs\/error-decoder\.html\?invariant=|react\.dev\/errors\/)(418|419|422|423|425)/)||i.match(/(does not match server-rendered HTML|Hydration failed because)/i))&&Id(e,Gd({category:"replay.hydrate-error",data:{url:Qn()}}))}(e,t)}}(e)),t.on("afterSendEvent",function(e){return(t,i)=>{if(!e.isEnabled()||!Mp(t)&&!xp(t))return;const n=i.statusCode;!n||n<200||n>=300||(xp(t)?function(e,t){const i=e.getContext();t.contexts?.trace?.trace_id&&i.traceIds.size<100&&i.traceIds.add(t.contexts.trace.trace_id)}(e,t):function(e,t){const i=e.getContext();if(t.event_id&&i.errorIds.size<100&&i.errorIds.add(t.event_id),"buffer"!==e.recordingMode||!t.tags||!t.tags.replayId)return;const{beforeErrorSampling:n}=e.getOptions();("function"!=typeof n||n(t))&&Gl(async()=>{try{await e.sendBufferedReplayOrFlush()}catch(t){e.handleException(t)}})}(e,t))}}(e)),t.on("createDsc",t=>{const i=e.getSessionId();i&&e.isEnabled()&&"session"===e.recordingMode&&e.checkAndHandleExpiredSession()&&(t.replay_id=i)}),t.on("spanStart",t=>{e.lastActiveSpan=t}),t.on("spanEnd",t=>{e.lastActiveSpan=t}),t.on("beforeSendFeedback",async(t,i)=>{const n=e.getSessionId();i?.includeReplay&&e.isEnabled()&&n&&t.contexts?.feedback&&("api"===t.contexts.feedback.source&&await e.sendBufferedReplayOrFlush(),t.contexts.feedback.replay_id=n)}),t.on("openFeedbackWidget",async()=>{await e.sendBufferedReplayOrFlush()}))}function $p(e){const{jsHeapSizeLimit:t,totalJSHeapSize:i,usedJSHeapSize:n}=e,s=Date.now()/1e3;return{type:"memory",name:"memory",start:s,end:s,data:{memory:{jsHeapSizeLimit:t,totalJSHeapSize:i,usedJSHeapSize:n}}}}const Hp=tn.navigator;function jp(e){let t=!1;return(i,n)=>{if(!e.checkAndHandleExpiredSession())return void(ep&&sp.warn("Received replay event after session expired."));const s=n||!t;t=!0,e.clickDetector&&function(e,t){try{if(!function(e){return 3===e.type}(t))return;const{source:i}=t.data;if(Bd.has(i)&&e.registerMutation(t.timestamp),i===qu.Scroll&&e.registerScroll(t.timestamp),function(e){return e.data.source===qu.MouseInteraction}(t)){const{type:i,id:n}=t.data,s=kd.mirror.getNode(n);s instanceof HTMLElement&&i===Gu.Click&&e.registerClick(s)}}catch{}}(e.clickDetector,i),e.addUpdate(()=>{if("buffer"===e.recordingMode&&s&&e.setInitialState(),!bp(e,i,s))return!0;if(!s)return!1;const t=e.session;if(function(e,t){t&&e.session&&0===e.session.segmentId&&bp(e,function(e){const t=e.getOptions();return{type:Lu.Custom,timestamp:Date.now(),data:{tag:"options",payload:{shouldRecordCanvas:e.isRecordingCanvas(),sessionSampleRate:t.sessionSampleRate,errorSampleRate:t.errorSampleRate,useCompressionOption:t.useCompression,blockAllMedia:t.blockAllMedia,maskAllText:t.maskAllText,maskAllInputs:t.maskAllInputs,useCompression:!!e.eventBuffer&&"worker"===e.eventBuffer.type,networkDetailHasUrls:t.networkDetailAllowUrls.length>0,networkCaptureBodies:t.networkCaptureBodies,networkRequestHasHeaders:t.networkRequestHeaders.length>0,networkResponseHasHeaders:t.networkResponseHeaders.length>0}}}}(e),!1)}(e,s),"buffer"===e.recordingMode&&t&&e.eventBuffer){const i=e.eventBuffer.getEarliestTimestamp();i&&(ep&&sp.log(`Updating session start time to earliest event in buffer to ${new Date(i)}`),t.started=i,e.getOptions().stickySession&&dp(t))}return t?.previousSessionId||"session"===e.recordingMode&&e.flush(),!0})}}class Wp extends Error{constructor(e){super(`Transport returned status code ${e}`)}}class Np extends Error{constructor(e){super("Rate limit hit"),this.rateLimits=e}}async function Up(e,t={count:0,interval:5e3}){const{recordingData:i,onError:n}=e;var s;if(i.length)try{return await async function({recordingData:e,replayId:t,segmentId:i,eventContext:n,timestamp:s,session:r}){const a=function({recordingData:e,headers:t}){let i;const n=`${JSON.stringify(t)}\n`;if("string"==typeof e)i=`${n}${e}`;else{const t=(new TextEncoder).encode(n);i=new Uint8Array(t.length+e.length),i.set(t),i.set(e,t.length)}return i}({recordingData:e,headers:{segment_id:i}}),{urls:o,errorIds:c,traceIds:l,initialTimestamp:h}=n,u=Ls(),d=zs(),p=u?.getTransport(),m=u?.getDsn();if(!(u&&p&&m&&r.sampled))return Promise.resolve({});const g={type:"replay_event",replay_start_timestamp:h/1e3,timestamp:s/1e3,error_ids:c,trace_ids:l,urls:o,replay_id:t,segment_id:i,replay_type:r.sampled},f=await async function({client:e,scope:t,replayId:i,event:n}){const s={event_id:i,integrations:"object"!=typeof e._integrations||null===e._integrations||Array.isArray(e._integrations)?void 0:Object.keys(e._integrations)};e.emit("preprocessEvent",n,s);const r=await Ia(e.getOptions(),n,s,t,e,Bs());if(!r)return null;e.emit("postprocessEvent",r,s),r.platform=r.platform||"javascript";const a=e.getSdkMetadata(),{name:o,version:c,settings:l}=a?.sdk||{};return r.sdk={...r.sdk,name:o||"sentry.javascript.unknown",version:c||"0.0.0",settings:l},r}({scope:d,client:u,replayId:t,event:g});if(!f)return u.recordDroppedEvent("event_processor","replay"),ep&&sp.log("An event processor returned `null`, will not send event."),Promise.resolve({});delete f.sdkProcessingMetadata;const y=function(e,t,i,n){return Yr(sa(e,na(e),n,i),[[{type:"replay_event"},e],[{type:"replay_recording",length:"string"==typeof t?(new TextEncoder).encode(t).length:t.length},t]])}(f,a,m,u.getOptions().tunnel);let v;try{v=await p.send(y)}catch(e){const t=new Error(Sh);try{t.cause=e}catch{}throw t}if("number"==typeof v.statusCode&&(v.statusCode<200||v.statusCode>=300))throw new Wp(v.statusCode);const b=po({},v);if(uo(b,"replay"))throw new Np(b);return v}(e),!0}catch(i){if(i instanceof Wp||i instanceof Np)throw i;if(s={_retryCount:t.count},Bs().setContext("Replays",s),n&&n(i),t.count>=3){const e=new Error(`${Sh} - max retries exceeded`);try{e.cause=i}catch{}throw e}return t.interval*=++t.count,new Promise((i,n)=>{Gl(async()=>{try{await Up(e,t),i(!0)}catch(e){n(e)}},t.interval)})}}const Vp="__THROTTLED";class Yp{constructor({options:e,recordingOptions:t}){this.eventBuffer=null,this.performanceEntries=[],this.replayPerformanceEntries=[],this.recordingMode="session",this.timeouts={sessionIdlePause:3e5,sessionIdleExpire:9e5},this._lastActivity=Date.now(),this._isEnabled=!1,this._isPaused=!1,this._requiresManualStart=!1,this._hasInitializedCoreListeners=!1,this._context={errorIds:new Set,traceIds:new Set,urls:[],initialTimestamp:Date.now(),initialUrl:""},this._recordingOptions=t,this._options=e,this._debouncedFlush=function(e,t,i){return function(e,t,i){let n,s,r;const a=i?.maxWait?Math.max(i.maxWait,t):0,o=i?.setTimeoutImpl||setTimeout;function c(){return l(),n=e(),n}function l(){void 0!==s&&clearTimeout(s),void 0!==r&&clearTimeout(r),s=r=void 0}function h(){return s&&clearTimeout(s),s=o(c,t),a&&void 0===r&&(r=o(c,a)),n}return h.cancel=l,h.flush=function(){return void 0!==s||void 0!==r?c():n},h}(e,t,{...i,setTimeoutImpl:Gl})}(()=>this._flush(),this._options.flushMinDelay,{maxWait:this._options.flushMaxDelay}),this._throttledAddEvent=function(e,t,i){const n=new Map;let s=!1;return(...r)=>{const a=Math.floor(Date.now()/1e3);if((e=>{const t=e-i;n.forEach((e,i)=>{i<t&&n.delete(i)})})(a),[...n.values()].reduce((e,t)=>e+t,0)>=t){const e=s;return s=!0,e?"__SKIPPED":Vp}s=!1;const o=n.get(a)||0;return n.set(a,o+1),e(...r)}}((e,t)=>function(e,t,i){return Sp(e,t)?wp(e,t,i):Promise.resolve(null)}(this,e,t),300,5);const{slowClickTimeout:i,slowClickIgnoreSelectors:n}=this.getOptions(),s=i?{threshold:Math.min(3e3,i),timeout:i,scrollTimeout:300,ignoreSelector:n?n.join(","):""}:void 0;if(s&&(this.clickDetector=new Fd(this,s)),ep){const t=e._experiments;sp.setConfig({captureExceptions:!!t.captureExceptions,traceInternals:!!t.traceInternals})}this._handleVisibilityChange=()=>{"visible"===bh.document.visibilityState?this._doChangeToForegroundTasks():this._doChangeToBackgroundTasks()},this._handleWindowBlur=()=>{const e=Gd({category:"ui.blur"});this._doChangeToBackgroundTasks(e)},this._handleWindowFocus=()=>{const e=Gd({category:"ui.focus"});this._doChangeToForegroundTasks(e)},this._handleKeyboardEvent=e=>{!function(e,t){if(!e.isEnabled())return;e.updateUserActivity();const i=function(e){const{metaKey:t,shiftKey:i,ctrlKey:n,altKey:s,key:r,target:a}=e;if(!a||function(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable}(a)||!r)return null;const o=t||n||s,c=1===r.length;if(!o&&c)return null;const l=Yn(a,{maxStringLength:200})||"<unknown>";return Gd({category:"ui.keyDown",message:l,data:{...Wd(a,l).data,metaKey:t,shiftKey:i,ctrlKey:n,altKey:s,key:r}})}(t);i&&Id(e,i)}(this,e)}}getContext(){return this._context}isEnabled(){return this._isEnabled}isPaused(){return this._isPaused}isRecordingCanvas(){return Boolean(this._canvas)}getOptions(){return this._options}handleException(e){ep&&sp.exception(e),this._options.onError&&this._options.onError(e)}initializeSampling(e){const{errorSampleRate:t,sessionSampleRate:i}=this._options,n=t<=0&&i<=0;this._requiresManualStart=n,n||(this._initializeSessionForSampling(e),this.session?!1!==this.session.sampled&&(this.recordingMode="buffer"===this.session.sampled&&0===this.session.segmentId?"buffer":"session",ep&&sp.infoTick(`Starting replay in ${this.recordingMode} mode`),this._initializeRecording()):ep&&sp.exception(new Error("Unable to initialize and create session")))}start(){if(this._isEnabled&&"session"===this.recordingMode)return void(ep&&sp.log("Recording is already in progress"));if(this._isEnabled&&"buffer"===this.recordingMode)return void(ep&&sp.log("Buffering is in progress, call `flush()` to save the replay"));ep&&sp.infoTick("Starting replay in session mode"),this._updateUserActivity();const e=vp({maxReplayDuration:this._options.maxReplayDuration,sessionIdleExpire:this.timeouts.sessionIdleExpire},{stickySession:this._options.stickySession,sessionSampleRate:1,allowBuffering:!1});this.session=e,this.recordingMode="session",this._initializeRecording()}startBuffering(){if(this._isEnabled)return void(ep&&sp.log("Buffering is in progress, call `flush()` to save the replay"));ep&&sp.infoTick("Starting replay in buffer mode");const e=vp({sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this._options.maxReplayDuration},{stickySession:this._options.stickySession,sessionSampleRate:0,allowBuffering:!0});this.session=e,this.recordingMode="buffer",this._initializeRecording()}startRecording(){try{const e=this._canvas;this._stopRecording=kd({...this._recordingOptions,..."buffer"===this.recordingMode?{checkoutEveryNms:6e4}:this._options._experiments.continuousCheckout&&{checkoutEveryNms:Math.max(36e4,this._options._experiments.continuousCheckout)},emit:jp(this),.../iPhone|iPad|iPod/i.test(Hp?.userAgent??"")||/Macintosh/i.test(Hp?.userAgent??"")&&Hp?.maxTouchPoints&&Hp?.maxTouchPoints>1?{sampling:{mousemove:!1}}:{},onMutation:this._onMutationHandler.bind(this),...e?{recordCanvas:e.recordCanvas,getCanvasManager:e.getCanvasManager,sampling:e.sampling,dataURLOptions:e.dataURLOptions}:{}})}catch(e){this.handleException(e)}}stopRecording(){try{return this._stopRecording&&(this._stopRecording(),this._stopRecording=void 0),!0}catch(e){return this.handleException(e),!1}}async stop({forceFlush:e=!1,reason:t}={}){if(this._isEnabled){this._isEnabled=!1,this.recordingMode="buffer";try{ep&&sp.log("Stopping Replay"+(t?` triggered by ${t}`:"")),kp(),this._removeListeners(),this.stopRecording(),this._debouncedFlush.cancel(),e&&await this._flush({force:!0}),this.eventBuffer?.destroy(),this.eventBuffer=null,i=this,function(){if(hp())try{bh.sessionStorage.removeItem(wh)}catch{}}(),i.session=void 0}catch(e){this.handleException(e)}}var i}pause(){this._isPaused||(this._isPaused=!0,this.stopRecording(),ep&&sp.log("Pausing replay"))}resume(){this._isPaused&&this._checkSession()&&(this._isPaused=!1,this.startRecording(),ep&&sp.log("Resuming replay"))}async sendBufferedReplayOrFlush({continueRecording:e=!0}={}){if("session"===this.recordingMode)return this.flushImmediate();const t=Date.now();ep&&sp.log("Converting buffer to session"),await this.flushImmediate();const i=this.stopRecording();e&&i&&"session"!==this.recordingMode&&(this.recordingMode="session",this.session&&(this._updateUserActivity(t),this._updateSessionActivity(t),this._maybeSaveSession()),this.startRecording())}addUpdate(e){const t=e();"buffer"!==this.recordingMode&&this._isEnabled&&!0!==t&&this._debouncedFlush()}triggerUserActivity(){if(this._updateUserActivity(),this._stopRecording)this.checkAndHandleExpiredSession(),this._updateSessionActivity();else{if(!this._checkSession())return;this.resume()}}updateUserActivity(){this._updateUserActivity(),this._updateSessionActivity()}conditionalFlush(){return"buffer"===this.recordingMode?Promise.resolve():this.flushImmediate()}flush(){return this._debouncedFlush()}flushImmediate(){return this._debouncedFlush(),this._debouncedFlush.flush()}cancelFlush(){this._debouncedFlush.cancel()}getSessionId(e){if(!e||!1!==this.session?.sampled)return this.session?.id}checkAndHandleExpiredSession(){if(!(this._lastActivity&&gp(this._lastActivity,this.timeouts.sessionIdlePause)&&this.session&&"session"===this.session.sampled))return!!this._checkSession();this.pause()}setInitialState(){const e=`${bh.location.pathname}${bh.location.hash}${bh.location.search}`,t=`${bh.location.origin}${e}`;this.performanceEntries=[],this.replayPerformanceEntries=[],this._clearContext(),this._context.initialUrl=t,this._context.initialTimestamp=Date.now(),this._context.urls.push(t)}throttledAddEvent(e,t){const i=this._throttledAddEvent(e,t);if(i===Vp){const e=Gd({category:"replay.throttled"});this.addUpdate(()=>!bp(this,{type:5,timestamp:e.timestamp||0,data:{tag:"breadcrumb",payload:e,metric:!0}}))}return i}getCurrentRoute(){const e=this.lastActiveSpan||Ar(),t=e&&_r(e),i=(t&&Mr(t).data||{})[Gs];if(t&&i&&["route","custom"].includes(i))return Mr(t).description}_initializeRecording(){this.setInitialState(),this._updateSessionActivity(),this.eventBuffer=function({useCompression:e,workerUrl:t}){if(e&&window.Worker){const e=function(e){try{const t=e||("undefined"!=typeof __SENTRY_EXCLUDE_REPLAY_WORKER__&&__SENTRY_EXCLUDE_REPLAY_WORKER__?"":function(){const e=new Blob(['var t=Uint8Array,n=Uint16Array,r=Int32Array,e=new t([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),i=new t([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),s=new t([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(t,e){for(var i=new n(31),s=0;s<31;++s)i[s]=e+=1<<t[s-1];var a=new r(i[30]);for(s=1;s<30;++s)for(var o=i[s];o<i[s+1];++o)a[o]=o-i[s]<<5|s;return{b:i,r:a}},o=a(e,2),h=o.b,f=o.r;h[28]=258,f[258]=28;for(var l=a(i,0).r,u=new n(32768),c=0;c<32768;++c){var v=(43690&c)>>1|(21845&c)<<1;v=(61680&(v=(52428&v)>>2|(13107&v)<<2))>>4|(3855&v)<<4,u[c]=((65280&v)>>8|(255&v)<<8)>>1}var d=function(t,r,e){for(var i=t.length,s=0,a=new n(r);s<i;++s)t[s]&&++a[t[s]-1];var o,h=new n(r);for(s=1;s<r;++s)h[s]=h[s-1]+a[s-1]<<1;if(e){o=new n(1<<r);var f=15-r;for(s=0;s<i;++s)if(t[s])for(var l=s<<4|t[s],c=r-t[s],v=h[t[s]-1]++<<c,d=v|(1<<c)-1;v<=d;++v)o[u[v]>>f]=l}else for(o=new n(i),s=0;s<i;++s)t[s]&&(o[s]=u[h[t[s]-1]++]>>15-t[s]);return o},p=new t(288);for(c=0;c<144;++c)p[c]=8;for(c=144;c<256;++c)p[c]=9;for(c=256;c<280;++c)p[c]=7;for(c=280;c<288;++c)p[c]=8;var g=new t(32);for(c=0;c<32;++c)g[c]=5;var w=d(p,9,0),y=d(g,5,0),m=function(t){return(t+7)/8|0},b=function(n,r,e){return(null==e||e>n.length)&&(e=n.length),new t(n.subarray(r,e))},M=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],E=function(t,n,r){var e=new Error(n||M[t]);if(e.code=t,Error.captureStackTrace&&Error.captureStackTrace(e,E),!r)throw e;return e},z=function(t,n,r){r<<=7&n;var e=n/8|0;t[e]|=r,t[e+1]|=r>>8},_=function(t,n,r){r<<=7&n;var e=n/8|0;t[e]|=r,t[e+1]|=r>>8,t[e+2]|=r>>16},x=function(r,e){for(var i=[],s=0;s<r.length;++s)r[s]&&i.push({s:s,f:r[s]});var a=i.length,o=i.slice();if(!a)return{t:F,l:0};if(1==a){var h=new t(i[0].s+1);return h[i[0].s]=1,{t:h,l:1}}i.sort(function(t,n){return t.f-n.f}),i.push({s:-1,f:25001});var f=i[0],l=i[1],u=0,c=1,v=2;for(i[0]={s:-1,f:f.f+l.f,l:f,r:l};c!=a-1;)f=i[i[u].f<i[v].f?u++:v++],l=i[u!=c&&i[u].f<i[v].f?u++:v++],i[c++]={s:-1,f:f.f+l.f,l:f,r:l};var d=o[0].s;for(s=1;s<a;++s)o[s].s>d&&(d=o[s].s);var p=new n(d+1),g=A(i[c-1],p,0);if(g>e){s=0;var w=0,y=g-e,m=1<<y;for(o.sort(function(t,n){return p[n.s]-p[t.s]||t.f-n.f});s<a;++s){var b=o[s].s;if(!(p[b]>e))break;w+=m-(1<<g-p[b]),p[b]=e}for(w>>=y;w>0;){var M=o[s].s;p[M]<e?w-=1<<e-p[M]++-1:++s}for(;s>=0&&w;--s){var E=o[s].s;p[E]==e&&(--p[E],++w)}g=e}return{t:new t(p),l:g}},A=function(t,n,r){return-1==t.s?Math.max(A(t.l,n,r+1),A(t.r,n,r+1)):n[t.s]=r},D=function(t){for(var r=t.length;r&&!t[--r];);for(var e=new n(++r),i=0,s=t[0],a=1,o=function(t){e[i++]=t},h=1;h<=r;++h)if(t[h]==s&&h!=r)++a;else{if(!s&&a>2){for(;a>138;a-=138)o(32754);a>2&&(o(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(o(s),--a;a>6;a-=6)o(8304);a>2&&(o(a-3<<5|8208),a=0)}for(;a--;)o(s);a=1,s=t[h]}return{c:e.subarray(0,i),n:r}},T=function(t,n){for(var r=0,e=0;e<n.length;++e)r+=t[e]*n[e];return r},k=function(t,n,r){var e=r.length,i=m(n+2);t[i]=255&e,t[i+1]=e>>8,t[i+2]=255^t[i],t[i+3]=255^t[i+1];for(var s=0;s<e;++s)t[i+s+4]=r[s];return 8*(i+4+e)},U=function(t,r,a,o,h,f,l,u,c,v,m){z(r,m++,a),++h[256];for(var b=x(h,15),M=b.t,E=b.l,A=x(f,15),U=A.t,C=A.l,F=D(M),I=F.c,S=F.n,L=D(U),O=L.c,j=L.n,q=new n(19),B=0;B<I.length;++B)++q[31&I[B]];for(B=0;B<O.length;++B)++q[31&O[B]];for(var G=x(q,7),H=G.t,J=G.l,K=19;K>4&&!H[s[K-1]];--K);var N,P,Q,R,V=v+5<<3,W=T(h,p)+T(f,g)+l,X=T(h,M)+T(f,U)+l+14+3*K+T(q,H)+2*q[16]+3*q[17]+7*q[18];if(c>=0&&V<=W&&V<=X)return k(r,m,t.subarray(c,c+v));if(z(r,m,1+(X<W)),m+=2,X<W){N=d(M,E,0),P=M,Q=d(U,C,0),R=U;var Y=d(H,J,0);z(r,m,S-257),z(r,m+5,j-1),z(r,m+10,K-4),m+=14;for(B=0;B<K;++B)z(r,m+3*B,H[s[B]]);m+=3*K;for(var Z=[I,O],$=0;$<2;++$){var tt=Z[$];for(B=0;B<tt.length;++B){var nt=31&tt[B];z(r,m,Y[nt]),m+=H[nt],nt>15&&(z(r,m,tt[B]>>5&127),m+=tt[B]>>12)}}}else N=w,P=p,Q=y,R=g;for(B=0;B<u;++B){var rt=o[B];if(rt>255){_(r,m,N[(nt=rt>>18&31)+257]),m+=P[nt+257],nt>7&&(z(r,m,rt>>23&31),m+=e[nt]);var et=31&rt;_(r,m,Q[et]),m+=R[et],et>3&&(_(r,m,rt>>5&8191),m+=i[et])}else _(r,m,N[rt]),m+=P[rt]}return _(r,m,N[256]),m+P[256]},C=new r([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),F=new t(0),I=function(){for(var t=new Int32Array(256),n=0;n<256;++n){for(var r=n,e=9;--e;)r=(1&r&&-306674912)^r>>>1;t[n]=r}return t}(),S=function(){var t=1,n=0;return{p:function(r){for(var e=t,i=n,s=0|r.length,a=0;a!=s;){for(var o=Math.min(a+2655,s);a<o;++a)i+=e+=r[a];e=(65535&e)+15*(e>>16),i=(65535&i)+15*(i>>16)}t=e,n=i},d:function(){return(255&(t%=65521))<<24|(65280&t)<<8|(255&(n%=65521))<<8|n>>8}}},L=function(s,a,o,h,u){if(!u&&(u={l:1},a.dictionary)){var c=a.dictionary.subarray(-32768),v=new t(c.length+s.length);v.set(c),v.set(s,c.length),s=v,u.w=c.length}return function(s,a,o,h,u,c){var v=c.z||s.length,d=new t(h+v+5*(1+Math.ceil(v/7e3))+u),p=d.subarray(h,d.length-u),g=c.l,w=7&(c.r||0);if(a){w&&(p[0]=c.r>>3);for(var y=C[a-1],M=y>>13,E=8191&y,z=(1<<o)-1,_=c.p||new n(32768),x=c.h||new n(z+1),A=Math.ceil(o/3),D=2*A,T=function(t){return(s[t]^s[t+1]<<A^s[t+2]<<D)&z},F=new r(25e3),I=new n(288),S=new n(32),L=0,O=0,j=c.i||0,q=0,B=c.w||0,G=0;j+2<v;++j){var H=T(j),J=32767&j,K=x[H];if(_[J]=K,x[H]=J,B<=j){var N=v-j;if((L>7e3||q>24576)&&(N>423||!g)){w=U(s,p,0,F,I,S,O,q,G,j-G,w),q=L=O=0,G=j;for(var P=0;P<286;++P)I[P]=0;for(P=0;P<30;++P)S[P]=0}var Q=2,R=0,V=E,W=J-K&32767;if(N>2&&H==T(j-W))for(var X=Math.min(M,N)-1,Y=Math.min(32767,j),Z=Math.min(258,N);W<=Y&&--V&&J!=K;){if(s[j+Q]==s[j+Q-W]){for(var $=0;$<Z&&s[j+$]==s[j+$-W];++$);if($>Q){if(Q=$,R=W,$>X)break;var tt=Math.min(W,$-2),nt=0;for(P=0;P<tt;++P){var rt=j-W+P&32767,et=rt-_[rt]&32767;et>nt&&(nt=et,K=rt)}}}W+=(J=K)-(K=_[J])&32767}if(R){F[q++]=268435456|f[Q]<<18|l[R];var it=31&f[Q],st=31&l[R];O+=e[it]+i[st],++I[257+it],++S[st],B=j+Q,++L}else F[q++]=s[j],++I[s[j]]}}for(j=Math.max(j,B);j<v;++j)F[q++]=s[j],++I[s[j]];w=U(s,p,g,F,I,S,O,q,G,j-G,w),g||(c.r=7&w|p[w/8|0]<<3,w-=7,c.h=x,c.p=_,c.i=j,c.w=B)}else{for(j=c.w||0;j<v+g;j+=65535){var at=j+65535;at>=v&&(p[w/8|0]=g,at=v),w=k(p,w+1,s.subarray(j,at))}c.i=v}return b(d,0,h+m(w)+u)}(s,null==a.level?6:a.level,null==a.mem?u.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(s.length)))):20:12+a.mem,o,h,u)},O=function(t,n,r){for(;r;++n)t[n]=r,r>>>=8},j=function(){function n(n,r){if("function"==typeof n&&(r=n,n={}),this.ondata=r,this.o=n||{},this.s={l:0,i:32768,w:32768,z:32768},this.b=new t(98304),this.o.dictionary){var e=this.o.dictionary.subarray(-32768);this.b.set(e,32768-e.length),this.s.i=32768-e.length}}return n.prototype.p=function(t,n){this.ondata(L(t,this.o,0,0,this.s),n)},n.prototype.push=function(n,r){this.ondata||E(5),this.s.l&&E(4);var e=n.length+this.s.z;if(e>this.b.length){if(e>2*this.b.length-32768){var i=new t(-32768&e);i.set(this.b.subarray(0,this.s.z)),this.b=i}var s=this.b.length-this.s.z;this.b.set(n.subarray(0,s),this.s.z),this.s.z=this.b.length,this.p(this.b,!1),this.b.set(this.b.subarray(-32768)),this.b.set(n.subarray(s),32768),this.s.z=n.length-s+32768,this.s.i=32766,this.s.w=32768}else this.b.set(n,this.s.z),this.s.z+=n.length;this.s.l=1&r,(this.s.z>this.s.w+8191||r)&&(this.p(this.b,r||!1),this.s.w=this.s.i,this.s.i-=2)},n.prototype.flush=function(){this.ondata||E(5),this.s.l&&E(4),this.p(this.b,!1),this.s.w=this.s.i,this.s.i-=2},n}();function q(t,n){n||(n={});var r=function(){var t=-1;return{p:function(n){for(var r=t,e=0;e<n.length;++e)r=I[255&r^n[e]]^r>>>8;t=r},d:function(){return~t}}}(),e=t.length;r.p(t);var i,s=L(t,n,10+((i=n).filename?i.filename.length+1:0),8),a=s.length;return function(t,n){var r=n.filename;if(t[0]=31,t[1]=139,t[2]=8,t[8]=n.level<2?4:9==n.level?2:0,t[9]=3,0!=n.mtime&&O(t,4,Math.floor(new Date(n.mtime||Date.now())/1e3)),r){t[3]=8;for(var e=0;e<=r.length;++e)t[e+10]=r.charCodeAt(e)}}(s,n),O(s,a-8,r.d()),O(s,a-4,e),s}var B=function(){function t(t,n){this.c=S(),this.v=1,j.call(this,t,n)}return t.prototype.push=function(t,n){this.c.p(t),j.prototype.push.call(this,t,n)},t.prototype.p=function(t,n){var r=L(t,this.o,this.v&&(this.o.dictionary?6:2),n&&4,this.s);this.v&&(function(t,n){var r=n.level,e=0==r?0:r<6?1:9==r?3:2;if(t[0]=120,t[1]=e<<6|(n.dictionary&&32),t[1]|=31-(t[0]<<8|t[1])%31,n.dictionary){var i=S();i.p(n.dictionary),O(t,2,i.d())}}(r,this.o),this.v=0),n&&O(r,r.length-4,this.c.d()),this.ondata(r,n)},t.prototype.flush=function(){j.prototype.flush.call(this)},t}(),G="undefined"!=typeof TextEncoder&&new TextEncoder,H="undefined"!=typeof TextDecoder&&new TextDecoder;try{H.decode(F,{stream:!0})}catch(t){}var J=function(){function t(t){this.ondata=t}return t.prototype.push=function(t,n){this.ondata||E(5),this.d&&E(4),this.ondata(K(t),this.d=n||!1)},t}();function K(n,r){if(G)return G.encode(n);for(var e=n.length,i=new t(n.length+(n.length>>1)),s=0,a=function(t){i[s++]=t},o=0;o<e;++o){if(s+5>i.length){var h=new t(s+8+(e-o<<1));h.set(i),i=h}var f=n.charCodeAt(o);f<128||r?a(f):f<2048?(a(192|f>>6),a(128|63&f)):f>55295&&f<57344?(a(240|(f=65536+(1047552&f)|1023&n.charCodeAt(++o))>>18),a(128|f>>12&63),a(128|f>>6&63),a(128|63&f)):(a(224|f>>12),a(128|f>>6&63),a(128|63&f))}return b(i,0,s)}const N=new class{constructor(){this._init()}clear(){this._init()}addEvent(t){if(!t)throw new Error("Adding invalid event");const n=this._hasEvents?",":"";this.stream.push(n+t),this._hasEvents=!0}finish(){this.stream.push("]",!0);const t=function(t){let n=0;for(const r of t)n+=r.length;const r=new Uint8Array(n);for(let n=0,e=0,i=t.length;n<i;n++){const i=t[n];r.set(i,e),e+=i.length}return r}(this._deflatedData);return this._init(),t}_init(){this._hasEvents=!1,this._deflatedData=[],this.deflate=new B,this.deflate.ondata=(t,n)=>{this._deflatedData.push(t)},this.stream=new J((t,n)=>{this.deflate.push(t,n)}),this.stream.push("[")}},P={clear:()=>{N.clear()},addEvent:t=>N.addEvent(t),finish:()=>N.finish(),compress:t=>function(t){return q(K(t))}(t)};addEventListener("message",function(t){const n=t.data.method,r=t.data.id,e=t.data.arg;if(n in P&&"function"==typeof P[n])try{const t=P[n](e);postMessage({id:r,method:n,success:!0,response:t})}catch(t){postMessage({id:r,method:n,success:!1,response:t.message}),console.error(t)}}),postMessage({id:void 0,method:"init",success:!0,response:void 0});']);return URL.createObjectURL(e)}());if(!t)return;ep&&sp.log("Using compression worker"+(e?` from ${e}`:""));const i=new Worker(t);return new lp(i)}catch(e){ep&&sp.exception(e,"Failed to create compression worker")}}(t);if(e)return e}return ep&&sp.log("Using simple buffer"),new ap}({useCompression:this._options.useCompression,workerUrl:this._options.workerUrl}),this._removeListeners(),this._addListeners(),this._isEnabled=!0,this._isPaused=!1,this.startRecording()}_initializeSessionForSampling(e){const t=this._options.errorSampleRate>0,i=vp({sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this._options.maxReplayDuration,previousSessionId:e},{stickySession:this._options.stickySession,sessionSampleRate:this._options.sessionSampleRate,allowBuffering:t});this.session=i}_checkSession(){if(!this.session)return!1;const e=this.session;return!yp(e,{sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this._options.maxReplayDuration})||(this._refreshSession(e),!1)}async _refreshSession(e){this._isEnabled&&(await this.stop({reason:"refresh session"}),this.initializeSampling(e.id))}_addListeners(){try{bh.document.addEventListener("visibilitychange",this._handleVisibilityChange),bh.addEventListener("blur",this._handleWindowBlur),bh.addEventListener("focus",this._handleWindowFocus),bh.addEventListener("keydown",this._handleKeyboardEvent),this.clickDetector&&this.clickDetector.addListeners(),this._hasInitializedCoreListeners||(Gp(this),this._hasInitializedCoreListeners=!0)}catch(e){this.handleException(e)}this._performanceCleanupCallback=function(e){function t(t){e.performanceEntries.includes(t)||e.performanceEntries.push(t)}function i({entries:e}){e.forEach(t)}const n=[];return["navigation","paint","resource"].forEach(e=>{n.push(sl(e,i))}),n.push(il(Ud(Xd,e)),tl(Ud(Jd,e)),nl(Ud(Kd,e))),()=>{n.forEach(e=>e())}}(this)}_removeListeners(){try{bh.document.removeEventListener("visibilitychange",this._handleVisibilityChange),bh.removeEventListener("blur",this._handleWindowBlur),bh.removeEventListener("focus",this._handleWindowFocus),bh.removeEventListener("keydown",this._handleKeyboardEvent),this.clickDetector&&this.clickDetector.removeListeners(),this._performanceCleanupCallback&&this._performanceCleanupCallback()}catch(e){this.handleException(e)}}_doChangeToBackgroundTasks(e){this.session&&(fp(this.session,{maxReplayDuration:this._options.maxReplayDuration,sessionIdleExpire:this.timeouts.sessionIdleExpire})||(e&&this._createCustomBreadcrumb(e),this.conditionalFlush()))}_doChangeToForegroundTasks(e){this.session&&(this.checkAndHandleExpiredSession()?e&&this._createCustomBreadcrumb(e):ep&&sp.log("Document has become active, but session has expired"))}_updateUserActivity(e=Date.now()){this._lastActivity=e}_updateSessionActivity(e=Date.now()){this.session&&(this.session.lastActivity=e,this._maybeSaveSession())}_createCustomBreadcrumb(e){this.addUpdate(()=>{this.throttledAddEvent({type:Lu.Custom,timestamp:e.timestamp||0,data:{tag:"breadcrumb",payload:e}})})}_addPerformanceEntries(){let e=(t=this.performanceEntries,t.map(Vd).filter(Boolean)).concat(this.replayPerformanceEntries);var t;if(this.performanceEntries=[],this.replayPerformanceEntries=[],this._requiresManualStart){const t=this._context.initialTimestamp/1e3;e=e.filter(e=>e.start>=t)}return Promise.all(Ep(this,e))}_clearContext(){this._context.errorIds.clear(),this._context.traceIds.clear(),this._context.urls=[]}_updateInitialTimestampFromEventBuffer(){const{session:e,eventBuffer:t}=this;if(!e||!t||this._requiresManualStart)return;if(e.segmentId)return;const i=t.getEarliestTimestamp();i&&i<this._context.initialTimestamp&&(this._context.initialTimestamp=i)}_popEventContext(){const e={initialTimestamp:this._context.initialTimestamp,initialUrl:this._context.initialUrl,errorIds:Array.from(this._context.errorIds),traceIds:Array.from(this._context.traceIds),urls:this._context.urls};return this._clearContext(),e}async _runFlush(){const e=this.getSessionId();if(this.session&&this.eventBuffer&&e){if(await this._addPerformanceEntries(),this.eventBuffer?.hasEvents&&(await async function(e){try{return Promise.all(Ep(e,[$p(bh.performance.memory)]))}catch{return[]}}(this),this.eventBuffer&&e===this.getSessionId()))try{this._updateInitialTimestampFromEventBuffer();const t=Date.now();if(t-this._context.initialTimestamp>this._options.maxReplayDuration+3e4)throw new Error("Session is too long, not sending replay");const i=this._popEventContext(),n=this.session.segmentId++;this._maybeSaveSession();const s=await this.eventBuffer.finish();await Up({replayId:e,recordingData:s,segmentId:n,eventContext:i,session:this.session,timestamp:t,onError:e=>this.handleException(e)})}catch(e){this.handleException(e),this.stop({reason:"sendReplay"});const t=Ls();if(t){const i=e instanceof Np?"ratelimit_backoff":"send_error";t.recordDroppedEvent(i,"replay")}}}else ep&&sp.error("No session or eventBuffer found to flush.")}async _flush({force:e=!1}={}){if(!this._isEnabled&&!e)return;if(!this.checkAndHandleExpiredSession())return void(ep&&sp.error("Attempting to finish replay event after session expired."));if(!this.session)return;const t=this.session.started,i=Date.now()-t;this._debouncedFlush.cancel();const n=i<this._options.minReplayDuration,s=i>this._options.maxReplayDuration+5e3;if(n||s)return ep&&sp.log(`Session duration (${Math.floor(i/1e3)}s) is too ${n?"short":"long"}, not sending replay.`),void(n&&this._debouncedFlush());const r=this.eventBuffer;r&&0===this.session.segmentId&&!r.hasCheckout&&ep&&sp.log("Flushing initial segment without checkout.");const a=!!this._flushLock;this._flushLock||(this._flushLock=this._runFlush());try{await this._flushLock}catch(e){this.handleException(e)}finally{this._flushLock=void 0,a&&this._debouncedFlush()}}_maybeSaveSession(){this.session&&this._options.stickySession&&dp(this.session)}_onMutationHandler(e){const{ignoreMutations:t}=this._options._experiments;if(t?.length&&e.some(e=>{const i=function(e){if(!e)return null;try{return e.nodeType===e.ELEMENT_NODE?e:e.parentElement}catch{return null}}(e.target),n=t.join(",");return i?.matches(n)}))return!1;const i=e.length,n=this._options.mutationLimit,s=n&&i>n;if(i>this._options.mutationBreadcrumbLimit||s){const e=Gd({category:"replay.mutations",data:{count:i,limit:s}});this._createCustomBreadcrumb(e)}return!s||(this.stop({reason:"mutationLimit",forceFlush:"session"===this.recordingMode}),!1)}}function Xp(e,t){return[...e,...t].join(",")}const Qp='img,image,svg,video,object,picture,embed,map,audio,link[rel="icon"],link[rel="apple-touch-icon"]',Jp=["content-length","content-type","accept"];let Kp=!1;const Zp=e=>new em(e);class em{constructor({flushMinDelay:e=5e3,flushMaxDelay:t=5500,minReplayDuration:i=4999,maxReplayDuration:n=36e5,stickySession:s=!0,useCompression:r=!0,workerUrl:a,_experiments:o={},maskAllText:c=!0,maskAllInputs:l=!0,blockAllMedia:h=!0,mutationBreadcrumbLimit:u=750,mutationLimit:d=1e4,slowClickTimeout:p=7e3,slowClickIgnoreSelectors:m=[],networkDetailAllowUrls:g=[],networkDetailDenyUrls:f=[],networkCaptureBodies:y=!0,networkRequestHeaders:v=[],networkResponseHeaders:b=[],mask:w=[],maskAttributes:S=["title","placeholder","aria-label"],unmask:M=[],block:x=[],unblock:C=[],ignore:T=[],maskFn:k,beforeAddRecordingEvent:E,beforeErrorSampling:P,onError:_}={}){this.name="Replay";const A=function({mask:e,unmask:t,block:i,unblock:n,ignore:s}){return{maskTextSelector:Xp(e,[".sentry-mask","[data-sentry-mask]"]),unmaskTextSelector:Xp(t,[]),blockSelector:Xp(i,[".sentry-block","[data-sentry-block]","base","iframe[srcdoc]:not([src])"]),unblockSelector:Xp(n,[]),ignoreSelector:Xp(s,[".sentry-ignore","[data-sentry-ignore]",'input[type="file"]'])}}({mask:w,unmask:M,block:x,unblock:C,ignore:T});if(this._recordingOptions={maskAllInputs:l,maskAllText:c,maskInputOptions:{password:!0},maskTextFn:k,maskInputFn:k,maskAttributeFn:(e,t,i)=>function({el:e,key:t,maskAttributes:i,maskAllText:n,privacyOptions:s,value:r}){return n?s.unmaskTextSelector&&e.matches(s.unmaskTextSelector)?r:i.includes(t)||"value"===t&&"INPUT"===e.tagName&&["submit","button"].includes(e.getAttribute("type")||"")?r.replace(/[\S]/g,"*"):r:r}({maskAttributes:S,maskAllText:c,privacyOptions:A,key:e,value:t,el:i}),...A,slimDOMOptions:"all",inlineStylesheet:!0,inlineImages:!1,collectFonts:!0,errorHandler:e=>{try{e.__rrweb__=!0}catch{}},recordCrossOriginIframes:Boolean(o.recordCrossOriginIframes)},this._initialOptions={flushMinDelay:e,flushMaxDelay:t,minReplayDuration:Math.min(i,15e3),maxReplayDuration:Math.min(n,36e5),stickySession:s,useCompression:r,workerUrl:a,blockAllMedia:h,maskAllInputs:l,maskAllText:c,mutationBreadcrumbLimit:u,mutationLimit:d,slowClickTimeout:p,slowClickIgnoreSelectors:m,networkDetailAllowUrls:g,networkDetailDenyUrls:f,networkCaptureBodies:y,networkRequestHeaders:tm(v),networkResponseHeaders:tm(b),beforeAddRecordingEvent:E,beforeErrorSampling:P,onError:_,_experiments:o},this._initialOptions.blockAllMedia&&(this._recordingOptions.blockSelector=this._recordingOptions.blockSelector?`${this._recordingOptions.blockSelector},${Qp}`:Qp),this._isInitialized&&Ko())throw new Error("Multiple Sentry Session Replay instances are not supported");this._isInitialized=!0}get _isInitialized(){return Kp}set _isInitialized(e){Kp=e}afterAllSetup(e){Ko()&&!this._replay&&(this._setup(e),this._initialize(e))}start(){this._replay&&this._replay.start()}startBuffering(){this._replay&&this._replay.startBuffering()}stop(){return this._replay?this._replay.stop({forceFlush:"session"===this._replay.recordingMode}):Promise.resolve()}flush(e){return this._replay?this._replay.isEnabled()?this._replay.sendBufferedReplayOrFlush(e):(this._replay.start(),Promise.resolve()):Promise.resolve()}getReplayId(e){if(this._replay?.isEnabled())return this._replay.getSessionId(e)}getRecordingMode(){if(this._replay?.isEnabled())return this._replay.recordingMode}_initialize(e){this._replay&&(this._maybeLoadFromReplayCanvasIntegration(e),this._replay.initializeSampling())}_setup(e){const t=function(e,t){const i=t.getOptions(),n={sessionSampleRate:0,errorSampleRate:0,...e},s=dr(i.replaysSessionSampleRate),r=dr(i.replaysOnErrorSampleRate);return null==s&&null==r&&ln(()=>{console.warn("Replay is disabled because neither `replaysSessionSampleRate` nor `replaysOnErrorSampleRate` are set.")}),null!=s&&(n.sessionSampleRate=s),null!=r&&(n.errorSampleRate=r),n}(this._initialOptions,e);this._replay=new Yp({options:t,recordingOptions:this._recordingOptions})}_maybeLoadFromReplayCanvasIntegration(e){try{const t=e.getIntegrationByName("ReplayCanvas");if(!t)return;this._replay._canvas=t.getOptions()}catch{}}}function tm(e){return[...Jp,...e.map(e=>e.toLowerCase())]}function im(e){try{return new URL(e,Zo.location.origin).href}catch{return}}function nm(e){try{return new Headers(e)}catch{return}}const sm=new WeakMap,rm=new Map,am={traceFetch:!0,traceXHR:!0,enableHTTPTimings:!0,trackFetchStreamPerformance:!1};function om(e,t){const{traceFetch:i,traceXHR:n,trackFetchStreamPerformance:s,shouldCreateSpanForRequest:r,enableHTTPTimings:a,tracePropagationTargets:o,onRequestSpanStart:c,onRequestSpanEnd:l}={...am,...t},h="function"==typeof r?r:e=>!0,u=e=>function(e,t){const i=Qn();if(i){let n,s;try{n=new URL(e,i),s=new URL(i).origin}catch{return!1}const r=n.origin===s;return t?ts(n.toString(),t)||r&&ts(n.pathname,t):r}{const i=!!e.match(/^\/(?!\/)/);return t?ts(e,t):i}}(e,o),d={},p=e.getOptions().propagateTraceparent;i&&(e.addEventProcessor(e=>("transaction"===e.type&&e.spans&&e.spans.forEach(e=>{if("http.client"===e.op){const t=rm.get(e.span_id);t&&(e.timestamp=t/1e3,rm.delete(e.span_id))}}),e)),s&&function(){const e="fetch-body-resolved";Cn(e,e=>{if(e.response){const t=sm.get(e.response);t&&e.endTimestamp&&rm.set(t,e.endTimestamp)}}),Tn(e,()=>Vo(Yo))}(),Uo(e=>{const t=function(e,t,i,n,s){if(!e.fetchData)return;const{method:r,url:a}=e.fetchData,o=Dr()&&t(a);if(e.endTimestamp&&o){const t=e.fetchData.__span;if(!t)return;const i=n[t];return void(i&&(function(e,t){if(t.response){Ks(e,t.response.status);const i=t.response?.headers?.get("content-length");if(i){const t=parseInt(i);t>0&&e.setAttribute("http.response_content_length",t)}}else t.error&&e.setStatus({code:2,message:"internal_error"});e.end()}(i,e),function(e,t,i){const n="object"==typeof i&&null!==i?i.onRequestSpanEnd:void 0;n?.(e,{headers:t.response?.headers,error:t.error})}(i,e,s),delete n[t]))}const{spanOrigin:c="auto.http.browser",propagateTraceparent:l=!1}="object"==typeof s?s:{spanOrigin:s},h=!!Ar(),u=o&&h?ua(function(e,t,i){const n=go(e);return{name:n?`${t} ${fo(n)}`:t,attributes:Ho(e,n,t,i)}}(a,r,c)):new Wr;if(e.fetchData.__span=u.spanContext().spanId,n[u.spanContext().spanId]=u,i(e.fetchData.url)){const t=e.args[0],i=e.args[1]||{},n=function(e,t,i,n){const s=wo({span:i,propagateTraceparent:n}),r=s["sentry-trace"],a=s.baggage,o=s.traceparent;if(!r)return;const c=t.headers||(Un(e)?e.headers:void 0);if(c){if(function(e){return"undefined"!=typeof Headers&&Wn(e,Headers)}(c)){const e=new Headers(c);if(e.get("sentry-trace")||e.set("sentry-trace",r),n&&o&&!e.get("traceparent")&&e.set("traceparent",o),a){const t=e.get("baggage");t?$o(t)||e.set("baggage",`${t},${a}`):e.set("baggage",a)}return e}if(Array.isArray(c)){const e=[...c];c.find(e=>"sentry-trace"===e[0])||e.push(["sentry-trace",r]),n&&o&&!c.find(e=>"traceparent"===e[0])&&e.push(["traceparent",o]);const t=c.find(e=>"baggage"===e[0]&&$o(e[1]));return a&&!t&&e.push(["baggage",a]),e}{const e="sentry-trace"in c?c["sentry-trace"]:void 0,t="traceparent"in c?c.traceparent:void 0,i="baggage"in c?c.baggage:void 0,s=i?Array.isArray(i)?[...i]:[i]:[],l=i&&(Array.isArray(i)?i.find(e=>$o(e)):$o(i));a&&!l&&s.push(a);const h={...c,"sentry-trace":e??r,baggage:s.length>0?s.join(","):void 0};return n&&o&&!t&&(h.traceparent=o),h}}return{...s}}(t,i,Dr()&&h?u:void 0,l);n&&(e.args[1]=i,i.headers=n)}const d=Ls();if(d){const t={input:e.args,response:e.response,startTimestamp:e.startTimestamp,endTimestamp:e.endTimestamp};d.emit("beforeOutgoingRequestSpan",u,t)}return u}(e,h,u,d,{propagateTraceparent:p,onRequestSpanEnd:l});if(e.response&&e.fetchData.__span&&sm.set(e.response,e.fetchData.__span),t){const i=im(e.fetchData.url),n=i?yo(i).host:void 0;t.setAttributes({"http.url":i,"server.address":n}),a&&cm(t),c?.(t,{headers:e.headers})}})),n&&Hl(e=>{const t=function(e,t,i,n,s,r){const a=e.xhr,o=a?.[$l];if(!a||a.__sentry_own_request__||!o)return;const{url:c,method:l}=o,h=Dr()&&t(c);if(e.endTimestamp&&h){const t=a.__sentry_xhr_span_id__;if(!t)return;const i=n[t];return void(i&&void 0!==o.status_code&&(Ks(i,o.status_code),i.end(),r?.(i,{headers:nm(Vl(a)),error:e.error}),delete n[t]))}const u=im(c),d=yo(u||c),p=c.split(/[?#]/,1)[0],m=!!Ar(),g=h&&m?ua({name:`${l} ${p}`,attributes:{url:c,type:"xhr","http.method":l,"http.url":u,"server.address":d?.host,[Ws]:"auto.http.browser",[js]:"http.client",...d?.search&&{"http.query":d?.search},...d?.hash&&{"http.fragment":d?.hash}}}):new Wr;a.__sentry_xhr_span_id__=g.spanContext().spanId,n[a.__sentry_xhr_span_id__]=g,i(c)&&function(e,t,i){const{"sentry-trace":n,baggage:s,traceparent:r}=wo({span:t,propagateTraceparent:i});n&&function(e,t,i,n){const s=e.__sentry_xhr_v3__?.request_headers;if(!s?.["sentry-trace"]&&e.setRequestHeader)try{if(e.setRequestHeader("sentry-trace",t),n&&!s?.traceparent&&e.setRequestHeader("traceparent",n),i){const t=s?.baggage;t&&t.split(",").some(e=>e.trim().startsWith("sentry-"))||e.setRequestHeader("baggage",i)}}catch{}}(e,n,s,r)}(a,Dr()&&m?g:void 0,s);const f=Ls();return f&&f.emit("beforeOutgoingRequestSpan",g,e),g}(e,h,u,d,p,l);t&&(a&&cm(t),c?.(t,{headers:nm(e.xhr.__sentry_xhr_v3__?.request_headers)}))})}function cm(e){const{url:t}=Mr(e).data;if(!t||"string"!=typeof t)return;const i=sl("resource",({entries:n})=>{n.forEach(n=>{(function(e){return"resource"===e.entryType&&"initiatorType"in e&&"string"==typeof e.nextHopProtocol&&("fetch"===e.initiatorType||"xmlhttprequest"===e.initiatorType)})(n)&&n.name.endsWith(t)&&(e.setAttributes(Sl(n)),setTimeout(i))})})}const lm="sentry_previous_trace";function hm(e){return 1===e.traceFlags}const um={...va,instrumentNavigation:!0,instrumentPageLoad:!0,markBackgroundSpan:!0,enableLongTask:!0,enableLongAnimationFrame:!0,enableInp:!0,enableElementTiming:!0,ignoreResourceSpans:[],ignorePerformanceApiSpans:[],detectRedirects:!0,linkPreviousTrace:"in-memory",consistentTraceSampling:!1,enableReportPageLoaded:!1,_experiments:{},...am},dm=(e={})=>{const t={name:void 0,source:void 0},i=Zo.document,{enableInp:n,enableElementTiming:s,enableLongTask:r,enableLongAnimationFrame:a,_experiments:{enableInteractions:o,enableStandaloneClsSpans:c,enableStandaloneLcpSpans:l},beforeStartSpan:h,idleTimeout:u,finalTimeout:d,childSpanTimeout:p,markBackgroundSpan:m,traceFetch:g,traceXHR:f,trackFetchStreamPerformance:y,shouldCreateSpanForRequest:v,enableHTTPTimings:b,ignoreResourceSpans:w,ignorePerformanceApiSpans:S,instrumentPageLoad:M,instrumentNavigation:x,detectRedirects:C,linkPreviousTrace:T,consistentTraceSampling:k,enableReportPageLoaded:E,onRequestSpanStart:P,onRequestSpanEnd:_}={...um,...e};let A,I,R;function D(e,n,s=!0){const r="pageload"===n.op,a=n.name,o=h?h(n):n,m=o.attributes||{};if(a!==o.name&&(m[Gs]="custom",o.attributes=m),!s){const e=vs();return void ua({...o,startTime:e}).end(e)}t.name=o.name,t.source=m[Gs];const g=ba(o,{idleTimeout:u,finalTimeout:d,childSpanTimeout:p,disableAutoFinish:r,beforeSpanEnd:t=>{A?.(),function(e,t){const i=fl(),n=ws();if(!i?.getEntries||!n)return;const s=yl(n),r=i.getEntries(),{op:a,start_timestamp:o}=Mr(e);r.slice(Cl).forEach(i=>{const n=yl(i.startTime),r=yl(Math.max(0,i.duration));if(!("navigation"===a&&o&&s+n<o))switch(i.entryType){case"navigation":!function(e,t,i){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach(n=>{El(e,t,n,i)}),El(e,t,"secureConnection",i,"TLS/SSL"),El(e,t,"fetch",i,"cache"),El(e,t,"domainLookup",i,"DNS"),function(e,t,i){const n=i+yl(t.requestStart),s=i+yl(t.responseEnd),r=i+yl(t.responseStart);t.responseEnd&&(ml(e,n,s,{op:"browser.request",name:t.name,attributes:{[Ws]:"auto.ui.browser.metrics"}}),ml(e,r,s,{op:"browser.response",name:t.name,attributes:{[Ws]:"auto.ui.browser.metrics"}}))}(e,t,i)}(e,i,s);break;case"mark":case"paint":case"measure":{!function(e,t,i,n,s,r){if(function(e){if("measure"===e?.entryType)try{return"Components ⚛"===e.detail.devtools.track}catch{return}}(t))return;if(["mark","measure"].includes(t.entryType)&&ts(t.name,r))return;const a=vc(!1),o=yl(a?a.requestStart:0),c=s+Math.max(i,o),l=s+i,h=l+n,u={[Ws]:"auto.resource.browser.metrics"};c!==l&&(u["sentry.browser.measure_happened_before_request"]=!0,u["sentry.browser.measure_start_time"]=c),function(e,t){try{const i=t.detail;if(!i)return;if("object"==typeof i){for(const[t,n]of Object.entries(i))if(n&&Gn(n))e[`sentry.browser.measure.detail.${t}`]=n;else if(void 0!==n)try{e[`sentry.browser.measure.detail.${t}`]=JSON.stringify(n)}catch{}return}if(Gn(i))return void(e["sentry.browser.measure.detail"]=i);try{e["sentry.browser.measure.detail"]=JSON.stringify(i)}catch{}}catch{}}(u,t),c<=h&&ml(e,c,h,{name:t.name,op:t.entryType,attributes:u})}(e,i,n,r,s,t.ignorePerformanceApiSpans);const a=_c(),o=i.startTime<a.firstHiddenTime;"first-paint"===i.name&&o&&(Tl.fp={value:i.startTime,unit:"millisecond"}),"first-contentful-paint"===i.name&&o&&(Tl.fcp={value:i.startTime,unit:"millisecond"});break}case"resource":!function(e,t,i,n,s,r,a){if("xmlhttprequest"===t.initiatorType||"fetch"===t.initiatorType)return;const o=t.initiatorType?`resource.${t.initiatorType}`:"resource.other";if(a?.includes(o))return;const c={[Ws]:"auto.resource.browser.metrics"},l=yo(i);l.protocol&&(c["url.scheme"]=l.protocol.split(":").pop()),l.host&&(c["server.address"]=l.host),c["url.same_origin"]=i.includes(fc.location.origin),function(e,t){[["responseStatus","http.response.status_code"],["transferSize","http.response_transfer_size"],["encodedBodySize","http.response_content_length"],["decodedBodySize","http.decoded_response_content_length"],["renderBlockingStatus","resource.render_blocking_status"],["deliveryType","http.response_delivery_type"]].forEach(([i,n])=>{const s=e[i];null!=s&&("number"==typeof s&&s<2147483647||"string"==typeof s)&&(t[n]=s)})}(t,c);const h={...c,...Sl(t)},u=r+n;ml(e,u,u+s,{name:i.replace(fc.location.origin,""),op:o,attributes:h})}(e,i,i.name,n,r,s,t.ignoreResourceSpans)}}),Cl=Math.max(r.length-1,0),function(e){const t=fc.navigator;if(!t)return;const i=t.connection;i&&(i.effectiveType&&e.setAttribute("effectiveConnectionType",i.effectiveType),i.type&&e.setAttribute("connectionType",i.type),pl(i.rtt)&&(Tl["connection.rtt"]={value:i.rtt,unit:"millisecond"})),pl(t.deviceMemory)&&e.setAttribute("deviceMemory",`${t.deviceMemory} GB`),pl(t.hardwareConcurrency)&&e.setAttribute("hardwareConcurrency",String(t.hardwareConcurrency))}(e),"pageload"===a&&(function(e){const t=vc(!1);if(!t)return;const{responseStart:i,requestStart:n}=t;n<=i&&(e["ttfb.requestTime"]={value:i-n,unit:"millisecond"})}(Tl),t.recordClsOnPageloadSpan||delete Tl.cls,t.recordLcpOnPageloadSpan||delete Tl.lcp,Object.entries(Tl).forEach(([e,t])=>{!function(e,t,i,n=Ar()){const s=n&&_r(n);s&&(en&&pn.log(`[Measurement] Setting measurement on root span: ${e} = ${t} ${i}`),s.addEvent(e,{[Vs]:t,[Us]:i}))}(e,t.value,t.unit)}),e.setAttribute("performance.timeOrigin",s),e.setAttribute("performance.activationStart",bc()),function(e,t){Ml&&t.recordLcpOnPageloadSpan&&(Ml.element&&e.setAttribute("lcp.element",Yn(Ml.element)),Ml.id&&e.setAttribute("lcp.id",Ml.id),Ml.url&&e.setAttribute("lcp.url",Ml.url.trim().slice(0,200)),null!=Ml.loadTime&&e.setAttribute("lcp.loadTime",Ml.loadTime),null!=Ml.renderTime&&e.setAttribute("lcp.renderTime",Ml.renderTime),e.setAttribute("lcp.size",Ml.size)),xl?.sources&&t.recordClsOnPageloadSpan&&xl.sources.forEach((t,i)=>e.setAttribute(`cls.source.${i+1}`,Yn(t.node)))}(e,t)),Ml=void 0,xl=void 0,Tl={}}(t,{recordClsOnPageloadSpan:!c,recordLcpOnPageloadSpan:!l,ignoreResourceSpans:w,ignorePerformanceApiSpans:S}),fm(e,void 0);const i=zs(),n=i.getPropagationContext();i.setPropagationContext({...n,traceId:g.spanContext().traceId,sampled:xr(g),dsc:jr(t)}),r&&(R=void 0)},trimIdleSpanEndTimestamp:!E});function f(){i&&["interactive","complete"].includes(i.readyState)&&e.emit("idleSpanEnableAutoFinish",g)}r&&E&&(R=g),fm(e,g),r&&!E&&i&&(i.addEventListener("readystatechange",()=>{f()}),f())}return{name:"BrowserTracing",setup(e){if(function(){function e(){const e=Ar(),t=e&&_r(e);if(t){const e="internal_error";en&&pn.log(`[Tracing] Root span: ${e} -> Global error occurred`),t.setStatus({code:2,message:e})}}Rr||(e.tag="sentry_tracingErrorCallback",Rr=!0,Pn(e),In(e))}(),A=kl({recordClsStandaloneSpans:c||!1,recordLcpStandaloneSpans:l||!1,client:e}),n&&function(){if(fl()&&ws()){const e=nl(Jl);return()=>{e()}}}(),s&&fl()&&ws()&&sl("element",Pl),a&&tn.PerformanceObserver&&PerformanceObserver.supportedEntryTypes&&PerformanceObserver.supportedEntryTypes.includes("long-animation-frame")?new PerformanceObserver(e=>{const t=Ar();if(t)for(const i of e.getEntries()){if(!i.scripts[0])continue;const e=yl(ws()+i.startTime),{start_timestamp:n,op:s}=Mr(t);if("navigation"===s&&n&&e<n)continue;const r=yl(i.duration),a={[Ws]:"auto.ui.browser.metrics"},o=i.scripts[0],{invoker:c,invokerType:l,sourceURL:h,sourceFunctionName:u,sourceCharPosition:d}=o;a["browser.script.invoker"]=c,a["browser.script.invoker_type"]=l,h&&(a["code.filepath"]=h),u&&(a["code.function"]=u),-1!==d&&(a["browser.script.source_char_position"]=d),ml(t,e,e+r,{name:"Main UI thread blocked",op:"ui.long-animation-frame",attributes:a})}}).observe({type:"long-animation-frame",buffered:!0}):r&&sl("longtask",({entries:e})=>{const t=Ar();if(!t)return;const{op:i,start_timestamp:n}=Mr(t);for(const s of e){const e=yl(ws()+s.startTime),r=yl(s.duration);"navigation"===i&&n&&e<n||ml(t,e,e+r,{name:"Main UI thread blocked",op:"ui.long-task",attributes:{[Ws]:"auto.ui.browser.metrics"}})}}),o&&sl("event",({entries:e})=>{const t=Ar();if(t)for(const i of e)if("click"===i.name){const e=yl(ws()+i.startTime),n=yl(i.duration),s={name:Yn(i.target),op:`ui.interaction.${i.name}`,startTime:e,attributes:{[Ws]:"auto.ui.browser.metrics"}},r=Jn(i.target);r&&(s.attributes["ui.component_name"]=r),ml(t,e,e+n,s)}}),C&&i){const e=()=>{I=bs()};addEventListener("click",e,{capture:!0}),addEventListener("keydown",e,{capture:!0,passive:!0})}function t(){const t=gm(e);t&&!Mr(t).timestamp&&(ch&&pn.log(`[Tracing] Finishing current active span with op: ${Mr(t).op}`),t.setAttribute(Ns,"cancelled"),t.end())}e.on("startNavigationSpan",(i,n)=>{if(Ls()!==e)return;if(n?.isRedirect)return ch&&pn.warn("[Tracing] Detected redirect, navigation span will not be the root span, but a child span."),void D(e,{op:"navigation.redirect",...i},!1);I=void 0,t(),Bs().setPropagationContext({traceId:xs(),sampleRand:Math.random(),propagationSpanId:Dr()?void 0:Cs()});const s=zs();s.setPropagationContext({traceId:xs(),sampleRand:Math.random(),propagationSpanId:Dr()?void 0:Cs()}),s.setSDKProcessingMetadata({normalizedRequest:void 0}),D(e,{op:"navigation",...i,parentSpan:null,forceTransaction:!0})}),e.on("startPageLoadSpan",(i,n={})=>{if(Ls()!==e)return;t();const s=function(e,t){const i=function(e){if(!e)return;const t=e.match(pr);if(!t)return;let i;return"1"===t[3]?i=!0:"0"===t[3]&&(i=!1),{traceId:t[1],parentSampled:i,parentSpanId:t[2]}}(e),n=rr(t);if(!i?.traceId)return{traceId:xs(),sampleRand:Math.random()};const s=function(e,t){const i=dr(t?.sample_rand);if(void 0!==i)return i;const n=dr(t?.sample_rate);return n&&void 0!==e?.parentSampled?e.parentSampled?Math.random()*n:n+Math.random()*(1-n):Math.random()}(i,n);n&&(n.sample_rand=s.toString());const{traceId:r,parentSpanId:a,parentSampled:o}=i;return{traceId:r,parentSpanId:a,sampled:o,dsc:n||{},sampleRand:s}}(n.sentryTrace||pm("sentry-trace"),n.baggage||pm("baggage")),r=zs();r.setPropagationContext(s),Dr()||(r.getPropagationContext().propagationSpanId=Cs()),r.setSDKProcessingMetadata({normalizedRequest:nc()}),D(e,{op:"pageload",...i})}),e.on("endPageloadSpan",()=>{E&&R&&(R.setAttribute(Ns,"reportPageLoaded"),R.end())})},afterAllSetup(e){let i=Qn();if("off"!==T&&function(e,{linkPreviousTrace:t,consistentTraceSampling:i}){const n="session-storage"===t;let s=n?function(){try{const e=Zo.sessionStorage?.getItem(lm);return JSON.parse(e)}catch{return}}():void 0;e.on("spanStart",e=>{if(_r(e)!==e)return;const t=zs().getPropagationContext();s=function(e,t,i){const n=Mr(t),s={spanContext:t.spanContext(),startTimestamp:n.start_timestamp,sampleRate:function(){try{return Number(i.dsc?.sample_rate)??Number(n.data?.[$s])}catch{return 0}}(),sampleRand:i.sampleRand};if(!e)return s;const r=e.spanContext;return r.traceId===n.trace_id?e:(Date.now()/1e3-e.startTimestamp<=3600&&(ch&&pn.log(`Adding previous_trace ${r} link to span ${{op:n.op,...t.spanContext()}}`),t.addLink({context:r,attributes:{[Js]:"previous_trace"}}),t.setAttribute("sentry.previous_trace",`${r.traceId}-${r.spanId}-${hm(r)?1:0}`)),s)}(s,e,t),n&&function(e){try{Zo.sessionStorage.setItem(lm,JSON.stringify(e))}catch(e){ch&&pn.warn("Could not store previous trace in sessionStorage",e)}}(s)});let r=!0;i&&e.on("beforeSampling",e=>{if(!s)return;const t=zs(),i=t.getPropagationContext();r&&i.parentSpanId?r=!1:(t.setPropagationContext({...i,dsc:{...i.dsc,sample_rate:String(s.sampleRate),sampled:String(hm(s.spanContext))},sampleRand:s.sampleRand}),e.parentSampled=hm(s.spanContext),e.parentSampleRate=s.sampleRate,e.spanAttributes={...e.spanAttributes,[Hs]:s.sampleRate})})}(e,{linkPreviousTrace:T,consistentTraceSampling:k}),Zo.location){if(M){const t=ws();!function(e,t){e.emit("startPageLoadSpan",t,void 0),zs().setTransactionName(t.name);const i=gm(e);i&&e.emit("afterStartPageLoadSpan",i)}(e,{name:Zo.location.pathname,startTime:t?t/1e3:void 0,attributes:{[Gs]:"url",[Ws]:"auto.pageload.browser"}})}x&&Bl(({to:t,from:n})=>{if(void 0===n&&-1!==i?.indexOf(t))return void(i=void 0);i=void 0;const s=go(t),r=gm(e),a=r&&C&&function(e,t){const i=Mr(e),n=vs();return!(n-i.start_timestamp>ym)&&!(t&&n-t<=ym)}(r,I);!function(e,t,i){const{url:n,isRedirect:s}=i||{};e.emit("beforeStartNavigationSpan",t,{isRedirect:s}),e.emit("startNavigationSpan",t,{isRedirect:s});const r=zs();r.setTransactionName(t.name),n&&!s&&r.setSDKProcessingMetadata({normalizedRequest:{...nc(),url:n}}),gm(e)}(e,{name:s?.pathname||Zo.location.pathname,attributes:{[Gs]:"url",[Ws]:"auto.navigation.browser"}},{url:t,isRedirect:a})})}m&&(Zo.document?Zo.document.addEventListener("visibilitychange",()=>{const e=Ar();if(!e)return;const t=_r(e);if(Zo.document.hidden&&t){const e="cancelled",{op:i,status:n}=Mr(t);ch&&pn.log(`[Tracing] Transaction: ${e} -> since tab moved to the background, op: ${i}`),n||t.setStatus({code:2,message:e}),t.setAttribute("sentry.cancellation_reason","document.hidden"),t.end()}}):ch&&pn.warn("[Tracing] Could not set up background tab detection due to lack of global document")),o&&function(e,t,i,n,s){let r;Zo.document&&addEventListener("click",()=>{const a="ui.action.click",o=gm(e);if(o){const e=Mr(o).op;if(["navigation","pageload"].includes(e))return void(ch&&pn.warn(`[Tracing] Did not create ${a} span because a pageload or navigation span is in progress.`))}r&&(r.setAttribute(Ns,"interactionInterrupted"),r.end(),r=void 0),s.name?r=ba({name:s.name,op:a,attributes:{[Gs]:s.source||"url"}},{idleTimeout:t,finalTimeout:i,childSpanTimeout:n}):ch&&pn.warn(`[Tracing] Did not create ${a} transaction because _latestRouteName is missing.`)},{capture:!0})}(e,u,d,p,t),n&&function(){const e=({entries:e})=>{const t=Ar(),i=t&&_r(t);e.forEach(e=>{if(!function(e){return"duration"in e}(e)||!i)return;const t=e.interactionId;if(null!=t&&!Xl.has(t)){if(Yl.length>10){const e=Yl.shift();Xl.delete(e)}Yl.push(t),Xl.set(t,i)}})};sl("event",e),sl("first-input",e)}(),om(e,{traceFetch:g,traceXHR:f,trackFetchStreamPerformance:y,tracePropagationTargets:e.getOptions().tracePropagationTargets,shouldCreateSpanForRequest:v,enableHTTPTimings:b,onRequestSpanStart:P,onRequestSpanEnd:_})}}};function pm(e){const t=Zo.document,i=t?.querySelector(`meta[name=${e}]`);return i?.getAttribute("content")||void 0}const mm="_sentry_idleSpan";function gm(e){return e[mm]}function fm(e,t){ns(e,mm,t)}const ym=1.5;function vm(e={}){const{dsn:t=null,environment:i="production",tracesSampleRate:n=.1,enabled:s=!0}=e;s&&t?function(e={}){const t=!e.skipBrowserExtensionCheck&&!!function(){if(void 0===Zo.window)return!1;const e=Zo;if(e.nw)return!1;const t=e.chrome||e.browser;if(!t?.runtime?.id)return!1;const i=Qn();return!(Zo===Zo.top&&["chrome-extension","moz-extension","ms-browser-extension","safari-web-extension"].some(e=>i.startsWith(`${e}://`)))}()&&(ch&&ln(()=>{console.error("[Sentry] You cannot use Sentry.init() in a browser extension, see: https://docs.sentry.io/platforms/javascript/best-practices/browser-extensions/")}),!0),i={...e,enabled:!t&&e.enabled,stackParser:(n=e.stackParser||ah,Array.isArray(n)?yn(...n):n),integrations:Ga({integrations:e.integrations,defaultIntegrations:null==e.defaultIntegrations?[Po(),To(),uh(),lh(),gh(),vh(),Fo(),{name:"HttpContext",preprocessEvent(e){if(!Zo.navigator&&!Zo.location&&!Zo.document)return;const t=nc(),i={...t.headers,...e.request?.headers};e.request={...t,...e.request,headers:i}}},{name:"BrowserSession",setupOnce(){void 0!==Zo.document?(za({ignoreDuration:!0}),La(),Bl(({from:e,to:t})=>{void 0!==e&&e!==t&&(za({ignoreDuration:!0}),La())})):ch&&pn.warn("Using the `browserSessionIntegration` in non-browser environments is not supported.")}}]:e.defaultIntegrations}),transport:e.transport||Kl};var n;!function(e,t){!0===t.debug&&(en?pn.enable():ln(()=>{console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle.")})),zs().update(t.initialScope);const i=new e(t);(function(e){zs().setClient(e)})(i),i.init()}(mc,i)}({dsn:t,environment:i,tracesSampleRate:n,release:`emotive-engine@${process.env.npm_package_version||"2.5.0"}`,integrations:[dm(),Zp({sessionSampleRate:.1,errorSampleRate:1})],beforeSend(e,t){const i=t.originalException;return i&&i.message&&i.message.includes("canvas")?null:e},beforeBreadcrumb:e=>"console"===e.category?null:e}):console.warn("Sentry monitoring disabled (no DSN provided or explicitly disabled)")}class bm{constructor(){this.A4_FREQUENCY=440,this.NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.INTERVALS={unison:0,minorSecond:1,majorSecond:2,minorThird:3,majorThird:4,perfectFourth:5,tritone:6,perfectFifth:7,minorSixth:8,majorSixth:9,minorSeventh:10,majorSeventh:11,octave:12},this.SCALES={major:[0,2,4,5,7,9,11],naturalMinor:[0,2,3,5,7,8,10],harmonicMinor:[0,2,3,5,7,8,11],melodicMinor:[0,2,3,5,7,9,11],ionian:[0,2,4,5,7,9,11],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],aeolian:[0,2,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],majorPentatonic:[0,2,4,7,9],minorPentatonic:[0,3,5,7,10],blues:[0,3,5,6,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],wholeHalfDiminished:[0,2,3,5,6,8,9,11],arabic:[0,1,4,5,7,8,11],japanese:[0,1,5,7,8],hungarian:[0,2,3,6,7,8,11],bebopMajor:[0,2,4,5,7,8,9,11]},this.CHORDS={major:[0,4,7],minor:[0,3,7],diminished:[0,3,6],augmented:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],min7b5:[0,3,6,10],dim7:[0,3,6,9],maj9:[0,4,7,11,14],min9:[0,3,7,10,14],dom9:[0,4,7,10,14],add9:[0,4,7,14],maj11:[0,4,7,11,14,17],min11:[0,3,7,10,14,17],maj13:[0,4,7,11,14,17,21],min13:[0,3,7,10,14,17,21]},this.EMOTION_MODES={excited:{scale:"lydian",tempo:140,dynamics:"forte",articulation:"staccato"},calm:{scale:"major",tempo:60,dynamics:"piano",articulation:"legato"},curious:{scale:"mixolydian",tempo:100,dynamics:"mezzoForte",articulation:"tenuto"},sleepy:{scale:"aeolian",tempo:50,dynamics:"pianissimo",articulation:"legato"},alert:{scale:"dorian",tempo:120,dynamics:"forte",articulation:"marcato"},pleased:{scale:"majorPentatonic",tempo:90,dynamics:"mezzoForte",articulation:"legato"},confused:{scale:"wholeHalfDiminished",tempo:80,dynamics:"mezzoPiano",articulation:"rubato"},energetic:{scale:"bebopMajor",tempo:160,dynamics:"fortissimo",articulation:"staccato"},melancholy:{scale:"harmonicMinor",tempo:70,dynamics:"mezzoPiano",articulation:"legato"},playful:{scale:"blues",tempo:110,dynamics:"mezzoForte",articulation:"swing"}},this.PROGRESSIONS={I_V_vi_IV:[1,5,6,4],I_IV_V:[1,4,5],ii_V_I:[2,5,1],I_vi_IV_V:[1,6,4,5],vi_IV_I_V:[6,4,1,5],I_VI_ii_V:[1,6,2,5],iii_vi_ii_V:[3,6,2,5],I_ii_iii_IV:[1,2,3,4],I_I_I_I_IV_IV_I_I_V_IV_I_V:[1,1,1,1,4,4,1,1,5,4,1,5],i_VII_VI_VII:[1,7,6,7],I_II_IV_I:[1,2,4,1]}}noteToMidi(e){const t=e.slice(0,-1),i=parseInt(e.slice(-1),10),n=this.NOTES.indexOf(t);if(-1===n)throw new Error(`Invalid note: ${e}`);return 12*(i+1)+n}midiToFrequency(e){return this.A4_FREQUENCY*Math.pow(2,(e-69)/12)}noteToFrequency(e){return this.midiToFrequency(this.noteToMidi(e))}generateScale(e,t="major"){const i=this.SCALES[t];if(!i)throw new Error(`Unknown scale type: ${t}`);const n=this.noteToMidi(e);return i.map(e=>this.midiToFrequency(n+e))}generateChord(e,t="major"){const i=this.CHORDS[t];if(!i)throw new Error(`Unknown chord type: ${t}`);const n=this.noteToMidi(e);return i.map(e=>this.midiToFrequency(n+e))}generateProgression(e,t="major",i=this.PROGRESSIONS.I_V_vi_IV){const n=this.generateScale(e,t),s=[];for(const e of i){const i=n[(e-1)%n.length];let r="major";"major"===t?2===e||3===e||6===e?r="minor":7===e&&(r="diminished"):"naturalMinor"===t&&(r=1===e||4===e||5===e?"minor":2===e?"diminished":"major");const a=Math.round(12*Math.log2(i/this.A4_FREQUENCY)+69),o=Math.floor(a/12)-1,c=a%12,l=this.NOTES[c]+o;s.push({degree:e,root:i,frequencies:this.generateChord(l,r),type:r})}return s}getEmotionMusic(e){return this.EMOTION_MODES[e]||this.EMOTION_MODES.calm}circleOfFifths(e="C",t=12,i=!0){const n=e.replace(/\d/,"");let s=this.NOTES.indexOf(n);const r=[e];for(let e=1;e<t;e++)s=i?(s+7)%12:(s+5)%12,r.push(this.NOTES[s]);return r}analyzeInterval(e,t){const i=this.noteToMidi(e),n=this.noteToMidi(t),s=Math.abs(n-i);let r="unknown";for(const[e,t]of Object.entries(this.INTERVALS))if(t===s%12){r=e;break}return{semitones:s,intervalName:r,octaves:Math.floor(s/12),consonant:[0,3,4,5,7,8,9,12].includes(s%12),ratio:this.getIntervalRatio(s%12)}}getIntervalRatio(e){return{0:"1:1",1:"16:15",2:"9:8",3:"6:5",4:"5:4",5:"4:3",6:"45:32",7:"3:2",8:"8:5",9:"5:3",10:"16:9",11:"15:8",12:"2:1"}[e]||"complex"}generateMelody(e={}){const{key:t="C4",scale:i="major",length:n=8,stepProbability:s=.7,restProbability:r=.1}=e,a=this.generateScale(t,i),o=[];let c=0;for(let e=0;e<n;e++){if(Math.random()<r){o.push({frequency:0,duration:.25,isRest:!0});continue}let e;if(Math.random()<s){const t=Math.random()<.5?-1:1;e=Math.max(0,Math.min(a.length-1,c+t))}else{const t=Math.floor(3*Math.random())+2,i=Math.random()<.5?-1:1;e=Math.max(0,Math.min(a.length-1,c+t*i))}c=e;const t=[.25,.5,.75,1],i=t[Math.floor(Math.random()*t.length)];o.push({frequency:a[c],duration:i,isRest:!1})}return o}}class wm{constructor(e){this.audioContext=e,this.musicTheory=new bm,this.currentKey="C4",this.currentScale="major",this.currentTempo=120,this.currentEmotion="calm",this.voices=new Map,this.layers={bass:{active:!1,gain:.3},chord:{active:!1,gain:.2},melody:{active:!1,gain:.4},pad:{active:!1,gain:.15}},this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.audioContext.destination),this.reverb=this.createReverb(),this.delay=this.createDelay(),this.filter=this.createFilter(),this.filter.connect(this.delay),this.delay.connect(this.reverb),this.reverb.connect(this.masterGain),this.dryGain=this.audioContext.createGain(),this.dryGain.gain.value=.7,this.dryGain.connect(this.masterGain),this.wetGain=this.audioContext.createGain(),this.wetGain.gain.value=.3,this.wetGain.connect(this.filter),this.nextNoteTime=0,this.noteResolution=0,this.noteLength=.05,this.currentChordIndex=0,this.currentMelodyNote=0,this.progression=null,this.isPlaying=!1,this.lookahead=25,this.scheduleAheadTime=.1}createReverb(){const e=this.audioContext.createConvolver(),t=2*this.audioContext.sampleRate,i=this.audioContext.createBuffer(2,t,this.audioContext.sampleRate);for(let e=0;e<2;e++){const n=i.getChannelData(e);for(let e=0;e<t;e++)n[e]=(2*Math.random()-1)*Math.pow(1-e/t,2)}return e.buffer=i,e}createDelay(){const e=this.audioContext.createDelay(1);e.delayTime.value=.15;const t=this.audioContext.createGain();return t.gain.value=.3,e.connect(t),t.connect(e),e}createFilter(){const e=this.audioContext.createBiquadFilter();return e.type="lowpass",e.frequency.value=2e3,e.Q.value=1,e}setEmotion(e){this.currentEmotion=e;const t=this.musicTheory.getEmotionMusic(e);this.currentScale=t.scale,this.currentTempo=t.tempo;const i={excited:{freq:4e3,Q:2},calm:{freq:1500,Q:.7},curious:{freq:2500,Q:1.5},sleepy:{freq:800,Q:.5},alert:{freq:3e3,Q:1.8},energetic:{freq:5e3,Q:2.5}}[e]||{freq:2e3,Q:1};this.filter.frequency.exponentialRampToValueAtTime(i.freq,this.audioContext.currentTime+.5),this.filter.Q.linearRampToValueAtTime(i.Q,this.audioContext.currentTime+.5),this.generateEmotionProgression()}generateEmotionProgression(){const e={excited:"I_V_vi_IV",calm:"I_vi_IV_V",curious:"ii_V_I",sleepy:"vi_IV_I_V",alert:"I_IV_V",energetic:"I_V_vi_IV"}[this.currentEmotion]||"I_V_vi_IV";this.progression=this.musicTheory.generateProgression(this.currentKey,this.currentScale,this.musicTheory.PROGRESSIONS[e])}playChord(e,t=1,i=.01){const n=this.audioContext.currentTime,s=this.audioContext.createGain();s.gain.setValueAtTime(0,n),s.gain.linearRampToValueAtTime(this.layers.chord.gain,n+i),s.gain.exponentialRampToValueAtTime(.01,n+t),s.connect(this.dryGain),s.connect(this.wetGain);const r=e.map((e,i)=>{const r=this.audioContext.createOscillator();return r.frequency.value=e,r.type=0===i?"sine":1===i?"triangle":"sawtooth",r.detune.value=10*(Math.random()-.5),r.connect(s),r.start(n),r.stop(n+t),r}),a=`chord_${Date.now()}`;this.voices.set(a,{oscillators:r,gain:s}),setTimeout(()=>{this.voices.delete(a)},1e3*(t+.1))}playMelody(e,t=0){let i=t||this.audioContext.currentTime;e.forEach((e,t)=>{if(e.isRest)return void(i+=e.duration);const n=this.audioContext.createOscillator(),s=this.audioContext.createGain();n.frequency.value=e.frequency,n.type="sine";const r=this.audioContext.createOscillator(),a=this.audioContext.createGain();r.frequency.value=5,a.gain.value=5,r.connect(a),a.connect(n.frequency),s.gain.setValueAtTime(0,i),s.gain.linearRampToValueAtTime(this.layers.melody.gain,i+.01),s.gain.exponentialRampToValueAtTime(.01,i+.9*e.duration),n.connect(s),s.connect(this.dryGain),s.connect(this.wetGain),n.start(i),n.stop(i+e.duration),r.start(i),r.stop(i+e.duration),i+=e.duration})}createPad(e,t=4){const i=this.audioContext.currentTime,n=this.audioContext.createGain();n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(this.layers.pad.gain,i+1),n.gain.linearRampToValueAtTime(this.layers.pad.gain,i+t-1),n.gain.linearRampToValueAtTime(0,i+t),n.connect(this.wetGain);for(let s=0;s<4;s++){const r=this.audioContext.createOscillator();r.frequency.value=e,r.type="sawtooth",r.detune.value=15*(s-2);const a=this.audioContext.createGain();a.gain.value=1/4;const o=this.audioContext.createOscillator(),c=this.audioContext.createGain();o.frequency.value=.2+.1*s,c.gain.value=10,o.connect(c),c.connect(r.frequency),r.connect(a),a.connect(n),r.start(i),r.stop(i+t),o.start(i),o.stop(i+t)}}playGestureSound(e){const t={breathe:()=>{const e=this.musicTheory.generateChord(this.currentKey,"maj7");this.playChord(e,2,.5),this.createPad(e[0]/2,3)},excited:()=>{const e=this.musicTheory.generateScale(this.currentKey,"lydian").map((e,t)=>({frequency:e,duration:.1,isRest:!1}));this.playMelody(e)},wave:()=>{const e=this.musicTheory.noteToFrequency(this.currentKey),t=2*e,i=this.audioContext.createOscillator(),n=this.audioContext.createGain();i.frequency.setValueAtTime(e,this.audioContext.currentTime),i.frequency.exponentialRampToValueAtTime(t,this.audioContext.currentTime+.5),i.frequency.exponentialRampToValueAtTime(e,this.audioContext.currentTime+1),n.gain.setValueAtTime(0,this.audioContext.currentTime),n.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.1),n.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.9),n.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+1),i.connect(n),n.connect(this.wetGain),i.start(),i.stop(this.audioContext.currentTime+1)},morph:()=>{const e=this.musicTheory.generateChord(this.currentKey,"minor"),t=this.musicTheory.generateChord(this.currentKey,"major");this.playChord(e,.5),setTimeout(()=>{this.playChord(t,1)},400)},jump:()=>{const e=this.musicTheory.generateChord(this.currentKey,"dom7");for(let t=0;t<3;t++)setTimeout(()=>{this.playChord(e.map(e=>e*Math.pow(2,t/12)),.1,.001)},100*t)},curious:()=>{const e=this.musicTheory.generateMelody({key:this.currentKey,scale:"mixolydian",length:5,stepProbability:.3});this.playMelody(e)}}[e];t&&t()}startHarmony(){this.isPlaying||(this.isPlaying=!0,this.currentChordIndex=0,this.nextNoteTime=this.audioContext.currentTime,this.generateEmotionProgression(),this.scheduleHarmony())}scheduleHarmony(){if(this.isPlaying){for(;this.nextNoteTime<this.audioContext.currentTime+this.scheduleAheadTime;){if(this.progression&&this.layers.chord.active){const e=this.progression[this.currentChordIndex];this.playChord(e.frequencies,.5),this.currentChordIndex=(this.currentChordIndex+1)%this.progression.length}if(this.layers.bass.active&&this.progression){const e=this.progression[this.currentChordIndex].frequencies[0]/2;this.playBassNote(e,.25)}const e=60/this.currentTempo;this.nextNoteTime+=.25*e}setTimeout(()=>this.scheduleHarmony(),this.lookahead)}}playBassNote(e,t){const i=this.audioContext.createOscillator(),n=this.audioContext.createGain();i.frequency.value=e,i.type="sine",n.gain.setValueAtTime(0,this.audioContext.currentTime),n.gain.linearRampToValueAtTime(this.layers.bass.gain,this.audioContext.currentTime+.01),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+t),i.connect(n),n.connect(this.dryGain),i.start(),i.stop(this.audioContext.currentTime+t)}stopHarmony(){this.isPlaying=!1}setLayerActive(e,t){this.layers[e]&&(this.layers[e].active=t)}setMasterVolume(e){this.masterGain.gain.exponentialRampToValueAtTime(Math.max(.01,e),this.audioContext.currentTime+.1)}setEffectsMix(e){const t=1-e;this.dryGain.gain.linearRampToValueAtTime(t,this.audioContext.currentTime+.1),this.wetGain.gain.linearRampToValueAtTime(e,this.audioContext.currentTime+.1)}}class Sm{constructor(){this.context=null,this.isEnabled=!1,this.isInitialized=!1,this.nodes={master:null,ambient:null,effects:null},this.harmonicSystem=null,this.useHarmonicSystem=!1,this.warningTimestamps={},this.warningThrottle=5e3,this.currentOscillator=null,this.currentGain=null,this.masterVolume=.5,this.ambientVolume=.1,this.emotionalTones=new Map([["neutral",{frequency:220,waveform:"sine",volume:.1}],["joy",{frequency:440,waveform:"triangle",volume:.15}],["sadness",{frequency:165,waveform:"sine",volume:.08}],["anger",{frequency:330,waveform:"sawtooth",volume:.12}],["fear",{frequency:880,waveform:"square",volume:.09}],["surprise",{frequency:660,waveform:"triangle",volume:.13}],["disgust",{frequency:110,waveform:"sawtooth",volume:.07}],["love",{frequency:528,waveform:"sine",volume:.11}]])}initialize(){try{const e=window.AudioContext||window.webkitAudioContext;return!!e&&(this.context=new e,this.harmonicSystem=new wm(this.context),this.context.state,this.nodes.master=this.context.createGain(),this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),this.nodes.master.connect(this.context.destination),this.nodes.effects=this.context.createGain(),this.nodes.effects.gain.setValueAtTime(1,this.context.currentTime),this.nodes.effects.connect(this.nodes.master),this.isEnabled=!0,this.isInitialized=!0,!0)}catch{return this.isEnabled=!1,!1}}async resumeContext(){if(this.context&&"suspended"===this.context.state)try{await this.context.resume()}catch{}}setMasterVolume(e,t=null){this.masterVolume=Math.max(0,Math.min(1,e)),this.isEnabled&&this.nodes.master&&(this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),t&&this.updateAmbientVolume(t))}getMasterVolume(){return this.masterVolume}isAvailable(){return this.isEnabled&&this.isInitialized}setHarmonicMode(e){this.useHarmonicSystem=e,e&&this.harmonicSystem?this.stopAmbientTone():!e&&this.harmonicSystem&&this.harmonicSystem.stopHarmony()}startHarmony(){this.harmonicSystem&&this.useHarmonicSystem&&this.isAvailable()&&this.harmonicSystem.startHarmony()}stopHarmony(){this.harmonicSystem&&this.harmonicSystem.stopHarmony()}setHarmonicLayer(e,t){this.harmonicSystem&&this.harmonicSystem.setLayerActive(e,t)}setHarmonicEffects(e){this.harmonicSystem&&this.harmonicSystem.setEffectsMix(e)}cleanup(){try{this.currentOscillator&&(this.currentOscillator.stop(),this.currentOscillator=null),this.currentGain&&(this.currentGain=null),this.context&&"closed"!==this.context.state&&this.context.close()}catch{}finally{this.context=null,this.nodes={master:null,ambient:null,effects:null},this.currentOscillator=null,this.currentGain=null,this.isEnabled=!1,this.isInitialized=!1}}getEmotionalTone(e){return this.emotionalTones.get(e)||null}setAmbientTone(e,t=500){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.setEmotion(e);const i=this.getEmotionalTone(e);if(i)try{this.resumeContext();const{currentTime:e}=this.context,n=t/1e3;this.currentOscillator&&this.currentGain&&(this.currentGain.gain.exponentialRampToValueAtTime(.001,e+.5*n),this.currentOscillator.stop(e+.5*n));const s=this.context.createOscillator(),r=this.context.createGain();s.type=i.waveform,s.frequency.setValueAtTime(i.frequency,e);const a=i.volume*this.masterVolume;r.gain.setValueAtTime(.001,e),r.gain.exponentialRampToValueAtTime(a,e+n),s.connect(r),r.connect(this.nodes.master),s.start(e),this.currentOscillator=s,this.currentGain=r}catch{}}stopAmbientTone(e=500){if(this.isAvailable()&&this.currentOscillator)try{const{currentTime:t}=this.context,i=e/1e3;this.currentGain&&this.currentGain.gain.exponentialRampToValueAtTime(.001,t+i),this.currentOscillator.stop(t+i),this.currentOscillator=null,this.currentGain=null}catch{}}updateAmbientVolume(e){if(!this.isAvailable()||!this.currentGain||!e)return;const t=this.getEmotionalTone(e);if(t)try{const e=t.volume*this.masterVolume,{currentTime:i}=this.context;this.currentGain.gain.exponentialRampToValueAtTime(e,i+.1)}catch{}}playGestureSound(e,t="neutral"){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.playGestureSound(e);const i=this.getGestureSoundConfig(e);if(i)try{this.resumeContext();const{currentTime:e}=this.context,n=i.duration/1e3,s=this.getEmotionalModifiers(t),r=i.volume*this.masterVolume*s.intensity,a=this.context.createOscillator(),o=this.context.createGain();a.type=i.waveform,this.applyFrequencyEnvelope(a,i.frequencyEnvelope,e,n),this.applyVolumeEnvelope(o,i.volumeEnvelope,e,n,r),a.connect(o),o.connect(this.nodes.effects),a.start(e),a.stop(e+n)}catch{}else this.throttledWarn(`Unknown gesture "${e}", cannot play sound`,`gesture_${e}`)}getGestureSoundConfig(e){return new Map([["bounce",{duration:100,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:200},{time:.5,frequency:400},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.8},{time:1,volume:0}]}],["pulse",{duration:300,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:450},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["shake",{duration:200,waveform:"sawtooth",volume:.2,frequencyEnvelope:[{time:0,frequency:150},{time:.25,frequency:200},{time:.5,frequency:150},{time:.75,frequency:200},{time:1,frequency:150}],volumeEnvelope:[{time:0,volume:.8},{time:.5,volume:1},{time:1,volume:0}]}],["spin",{duration:600,waveform:"triangle",volume:.35,frequencyEnvelope:[{time:0,frequency:220},{time:.3,frequency:440},{time:.7,frequency:660},{time:1,frequency:330}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["nod",{duration:150,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:180},{time:.5,frequency:220},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:1,volume:0}]}],["tilt",{duration:200,waveform:"triangle",volume:.18,frequencyEnvelope:[{time:0,frequency:250},{time:.6,frequency:350},{time:1,frequency:280}],volumeEnvelope:[{time:0,volume:0},{time:.4,volume:1},{time:1,volume:0}]}],["expand",{duration:500,waveform:"sine",volume:.4,frequencyEnvelope:[{time:0,frequency:200},{time:.7,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.9,volume:.8},{time:1,volume:0}]}],["contract",{duration:400,waveform:"triangle",volume:.22,frequencyEnvelope:[{time:0,frequency:400},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:1},{time:.6,volume:.8},{time:1,volume:0}]}],["flash",{duration:200,waveform:"square",volume:.3,frequencyEnvelope:[{time:0,frequency:800},{time:.1,frequency:1200},{time:.2,frequency:800},{time:1,frequency:600}],volumeEnvelope:[{time:0,volume:0},{time:.05,volume:1},{time:.15,volume:.3},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.6,frequency:400},{time:1,frequency:350}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.7,volume:.6},{time:1,volume:0}]}],["breathe",{duration:800,waveform:"triangle",volume:.6,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.5,frequency:600},{time:.7,frequency:400},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.2},{time:.2,volume:1},{time:.5,volume:.9},{time:.8,volume:.7},{time:1,volume:0}]}],["morph",{duration:600,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.2,frequency:300},{time:.5,frequency:600},{time:.8,frequency:400},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:.7,volume:.8},{time:1,volume:0}]}],["jump",{duration:250,waveform:"square",volume:.35,frequencyEnvelope:[{time:0,frequency:200},{time:.2,frequency:600},{time:.4,frequency:800},{time:.8,frequency:400},{time:1,frequency:100}],volumeEnvelope:[{time:0,volume:.8},{time:.1,volume:1},{time:.3,volume:.6},{time:1,volume:0}]}],["drift",{duration:800,waveform:"sine",volume:.12,frequencyEnvelope:[{time:0,frequency:160},{time:.4,frequency:240},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:200},{time:.25,frequency:300},{time:.5,frequency:250},{time:.75,frequency:280},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.8,volume:.8},{time:1,volume:0}]}],["breathe",{duration:3500,waveform:"sine",volume:.2,frequencyEnvelope:[{time:0,frequency:80},{time:.4,frequency:150},{time:.5,frequency:160},{time:.9,frequency:100},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:.3},{time:.4,volume:.8},{time:.5,volume:.7},{time:.9,volume:.6},{time:1,volume:.2}]}],["flicker",{duration:300,waveform:"square",volume:.2,frequencyEnvelope:[{time:0,frequency:600},{time:.1,frequency:400},{time:.2,frequency:800},{time:.3,frequency:300},{time:.5,frequency:700},{time:1,frequency:500}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.2},{time:.2,volume:.9},{time:.3,volume:.3},{time:.5,volume:.8},{time:1,volume:0}]}],["vibrate",{duration:250,waveform:"sawtooth",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.1,frequency:150},{time:.2,frequency:100},{time:.3,frequency:150},{time:.4,frequency:100},{time:.5,frequency:150},{time:.6,frequency:100},{time:.7,frequency:150},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:1},{time:.8,volume:1},{time:1,volume:0}]}],["glow",{duration:600,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["stretch",{duration:450,waveform:"triangle",volume:.2,frequencyEnvelope:[{time:0,frequency:250},{time:.3,frequency:180},{time:.7,frequency:320},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.6},{time:.2,volume:1},{time:.8,volume:.9},{time:1,volume:0}]}]]).get(e)||null}applyFrequencyEnvelope(e,t,i,n){t.forEach(t=>{const s=i+t.time*n;e.frequency.linearRampToValueAtTime(t.frequency,s)})}applyVolumeEnvelope(e,t,i,n,s){t.forEach((t,r)=>{const a=i+t.time*n,o=t.volume*s;0===r?e.gain.setValueAtTime(o,a):e.gain.linearRampToValueAtTime(o,a)})}getEmotionalModifiers(e){const t=new Map([["neutral",{intensity:1,speed:1}],["joy",{intensity:1.3,speed:1.2}],["sadness",{intensity:.6,speed:.8}],["anger",{intensity:1.5,speed:1.4}],["fear",{intensity:.8,speed:1.3}],["surprise",{intensity:1.4,speed:1.5}],["disgust",{intensity:.7,speed:.9}],["love",{intensity:1.1,speed:.9}]]);return t.get(e)||t.get("neutral")}setQualityReduction(e){this.qualityReduction=e,e&&this.audioContext?(this.audioContext.sampleRate,this.maxOscillators=2):this.maxOscillators=4}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}throttledWarn(e,t){const i=Date.now();i-(this.warningTimestamps[t]||0)>this.warningThrottle&&(this.warningTimestamps[t]=i)}}class Mm{constructor(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.smoothingFactor=.9,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.maxFrameTimeSamples=10,this.averageFrameTime=0}update(e){for(;this.timestamps.length>0&&this.timestamps[0]<=e-1e3;)this.timestamps.shift();if(this.timestamps.push(e),this.fps=this.timestamps.length,0===this.smoothedFPS?this.smoothedFPS=this.fps:this.smoothedFPS=this.smoothedFPS*this.smoothingFactor+this.fps*(1-this.smoothingFactor),this.lastFrameTime>0&&(this.frameTime=e-this.lastFrameTime,this.frameTimes.push(this.frameTime),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift(),this.frameTimes.length>0)){const e=this.frameTimes.reduce((e,t)=>e+t,0);this.averageFrameTime=e/this.frameTimes.length}this.lastFrameTime=e}getFPS(){return Math.round(this.fps)}getSmoothedFPS(){return Math.round(this.smoothedFPS)}getFrameTime(){return this.frameTime}getAverageFrameTime(){return this.averageFrameTime}reset(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.averageFrameTime=0}getMetrics(){return{fps:this.getFPS(),smoothedFPS:this.getSmoothedFPS(),frameTime:this.getFrameTime(),averageFrameTime:this.getAverageFrameTime(),status:this.fps>=55?"good":this.fps>=30?"okay":"poor"}}}class xm{constructor(e,t={}){this.errorBoundary=e,this.config=t,this.config.targetFPS=t.targetFPS||60,this.isRunning=!1,this.animationFrameId=null,this.loopCallbackId=null,this.lastFrameTime=0,this.deltaTime=0,this.isPaused=!1,this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleWindowBlur=this.handleWindowBlur.bind(this),this.handleWindowFocus=this.handleWindowFocus.bind(this),"undefined"!=typeof document&&(document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("blur",this.handleWindowBlur),window.addEventListener("focus",this.handleWindowFocus)),this.performanceMonitor=null,this.fpsCounter=new Mm,this.subsystems={},this.eventCallback=null,this.parentMascot=null}setSubsystems(e){this.subsystems={stateMachine:e.stateMachine,particleSystem:e.particleSystem,renderer:e.renderer,soundSystem:e.soundSystem,canvasManager:e.canvasManager};const t=["stateMachine","particleSystem","renderer"];for(const e of t)if(!this.subsystems[e])throw new Error(`Required subsystem '${e}' not provided`);this.performanceMonitor&&this.performanceMonitor.setSubsystems(this.subsystems)}setEventCallback(e){if("function"!=typeof e)throw new Error("Event callback must be a function");this.eventCallback=e}setParentMascot(e){this.parentMascot=e}emit(e,t=null){this.eventCallback&&this.eventCallback(e,t)}start(){return this.errorBoundary.wrap(()=>{if(this.isRunning)return!1;if(!this.subsystems.stateMachine)throw new Error("Cannot start animation without subsystems configured");return this.isRunning=!0,this.lastFrameTime=performance.now(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.resumeContext(),this.loopCallbackId=ui.register((e,t)=>this.animate(e,t),0,this),this.emit("animationStarted",{targetFPS:this.targetFPS}),!0},"animation-start")()}stop(){return this.errorBoundary.wrap(()=>!!this.isRunning&&(this.isRunning=!1,this.loopCallbackId&&(ui.unregister(this.loopCallbackId),this.loopCallbackId=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.subsystems.renderer&&this.subsystems.renderer.stopAllGestures&&this.subsystems.renderer.stopAllGestures(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.stopAmbientTone(),this.subsystems.particleSystem&&this.subsystems.particleSystem.clear(),this.emit("animationStopped"),!0),"animation-stop")()}handleWindowBlur(){document.hidden||this.handleVisibilityChange()}handleWindowFocus(){!document.hidden&&this.isPaused&&this.handleVisibilityChange()}handleVisibilityChange(){if(document.hidden)this.wasRunning=this.isRunning,this.isPaused=!0,this.pauseTime=performance.now(),this.subsystems?.particleSystem&&(this.subsystems.particleSystem.resetAccumulator(),this.pausedParticleCount=this.subsystems.particleSystem.particles?.length||0),this.subsystems?.renderer?.gestureAnimator&&this.subsystems.renderer.gestureAnimator.pauseCurrentAnimation?.(),this.parentMascot?.pause&&this.parentMascot.pause();else if(this.isPaused&&this.wasRunning){const e=performance.now(),t=e-this.pauseTime;if(this.lastFrameTime=e,this.frameTimeAccumulator=0,this.fpsCounter&&this.fpsCounter.reset(),this.subsystems?.particleSystem)if(this.subsystems.particleSystem.resetAccumulator(),t>3e4)this.subsystems.particleSystem.particles=[];else if(t>1e4){const e=Math.max(10,Math.floor(.5*this.pausedParticleCount));for(;this.subsystems.particleSystem.particles.length>e;)this.subsystems.particleSystem.removeParticle(0)}this.renderer&&(t>3e4&&this.renderer.resetCanvasContext(),this.renderer.gestureAnimator&&this.renderer.gestureAnimator.resumeAnimation?.(),t>3e4&&(this.renderer.forceCleanRender=!0)),this.subsystems?.stateMachine&&(this.subsystems.stateMachine.lastUpdateTime=e),this.parentMascot?.resume&&this.parentMascot.resume(),this.isPaused=!1,this.performanceMonitor&&console.warn(`TAB FOCUS FIX: Resumed after ${(t/1e3).toFixed(1)}s pause. Particles kept: ${this.subsystems?.particleSystem?.particles?.length||0}/${this.pausedParticleCount||0}`)}}animate(e,t){if(!this.isRunning||this.isPaused)return;const i=t||performance.now();this.deltaTime=e||i-this.lastFrameTime,this.deltaTime>20&&(this.deltaTime=20),this.deltaTime>16.67&&this.deltaTime<20&&(this.deltaTime=16.67),this.lastFrameTime=i,this.update(this.deltaTime),this.render()}update(e){if(this.subsystems.stateMachine&&this.subsystems.stateMachine.update(e),this.parentMascot&&"function"==typeof this.parentMascot.update&&this.parentMascot.update(e),"classic"!==this.parentMascot?.config?.renderingStyle&&this.subsystems.particleSystem&&this.subsystems.stateMachine&&this.subsystems.canvasManager){const t=this.subsystems.stateMachine.getCurrentEmotionalProperties();let i;i=this.subsystems.renderer&&"function"==typeof this.subsystems.renderer.getEffectiveCenter?this.subsystems.renderer.getEffectiveCenter():this.subsystems.canvasManager.getCenter();let n=null,s=0;if(this.subsystems.renderer&&this.subsystems.renderer.getCurrentGesture){const e=this.subsystems.renderer.getCurrentGesture();e&&e.particleMotion&&(n=e.particleMotion,s=e.progress||0)}this.subsystems.particleSystem.spawn(t.particleBehavior,this.subsystems.stateMachine.getCurrentState().emotion,t.particleRate,i.x,i.y,e),this.subsystems.particleSystem.update(e,i.x,i.y,n,s)}this.performanceMonitor&&this.performanceMonitor.updateMetrics({particleCount:this.subsystems.particleSystem?.getActiveParticleCount?.()||0,audioLatency:this.subsystems.soundSystem?.getLatency?.()||0})}render(){this.parentMascot&&"function"==typeof this.parentMascot.render?this.parentMascot.render():this.subsystems.renderer&&this.subsystems.renderer.render()}getPerformanceMetrics(){const e=this.fpsCounter?this.fpsCounter.getMetrics():{};return{fps:e.fps||60,instantFps:e.smoothedFPS||60,frameTime:e.frameTime||16.67,averageFrameTime:e.averageFrameTime||16.67,isRunning:this.isRunning,deltaTime:this.deltaTime}}setTargetFPS(e){}get targetFPS(){return this.config.targetFPS||60}isAnimating(){return this.isRunning}destroy(){this.stop(),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("blur",this.handleWindowBlur),window.removeEventListener("focus",this.handleWindowFocus)),this.performanceMonitor&&(this.performanceMonitor.destroy(),this.performanceMonitor=null),this.subsystems={},this.eventCallback=null}}class Cm{constructor(e={}){this.config={spikeThreshold:e.spikeThreshold||1.5,minimumSpikeLevel:e.minimumSpikeLevel||.1,spikeMinInterval:e.spikeMinInterval||1e3,historySize:e.historySize||10,smoothingTimeConstant:e.smoothingTimeConstant||.8,fftSize:e.fftSize||256,levelUpdateThrottle:e.levelUpdateThrottle||100,...e},this.audioContext=null,this.analyser=null,this.dataArray=null,this.currentLevel=0,this.levelHistory=[],this.isActive=!1,this.lastVolumeSpike=0,this.lastLevelEmit=0,this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}initialize(e){try{if(!e)throw new Error("AudioContext is required for audio level processing");if("function"!=typeof e.createAnalyser)throw new Error("Invalid AudioContext provided");return this.audioContext=e,this.analyser=e.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.isActive=!0,"suspended"===e.state&&e.resume().catch(e=>{this.emitError("Failed to resume AudioContext",e)}),!0}catch(e){return this.emitError("Failed to initialize AudioLevelProcessor",e),!1}}cleanup(){try{this.isActive=!1,this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.lastLevelEmit=0,this.audioContext=null,this.analyser=null,this.dataArray=null}catch(e){this.emitError("Error during AudioLevelProcessor cleanup",e)}}updateAudioLevel(e=16){if(this.isActive&&this.analyser&&this.dataArray)try{this.analyser.getByteFrequencyData(this.dataArray);const e=this.calculateRMS();this.currentLevel=Math.min(1,2*e),this.updateLevelHistory(),this.detectVolumeSpikes(),this.emitLevelUpdate()}catch(e){this.emitError("Error updating audio level",e),this.currentLevel=0}}calculateRMS(){if(!this.dataArray||0===this.dataArray.length)return 0;let e=0;for(let t=0;t<this.dataArray.length;t++){const i=this.dataArray[t]/255;e+=i*i}return Math.sqrt(e/this.dataArray.length)}updateLevelHistory(){this.levelHistory.push(this.currentLevel),this.levelHistory.length>this.config.historySize&&this.levelHistory.shift()}detectVolumeSpikes(){if(this.levelHistory.length<5)return;const e=performance.now();if(e-this.lastVolumeSpike<this.config.spikeMinInterval)return;const t=this.levelHistory.slice(0,-1),i=t.reduce((e,t)=>e+t,0)/t.length;this.currentLevel>=i*this.config.spikeThreshold&&i>=this.config.minimumSpikeLevel&&this.currentLevel>=2*this.config.minimumSpikeLevel&&(this.lastVolumeSpike=e,this.emitVolumeSpike({level:this.currentLevel,previousAverage:i,spikeRatio:this.currentLevel/i,timestamp:e,threshold:this.config.spikeThreshold,minimumLevel:this.config.minimumSpikeLevel}))}clearHistory(){this.levelHistory=[]}getCurrentLevel(){return this.currentLevel}getLevelHistory(){return[...this.levelHistory]}getAnalyser(){return this.analyser}getFrequencyData(){return this.dataArray?new Uint8Array(this.dataArray):null}isProcessingActive(){return this.isActive}onLevelUpdate(e){if("function"!=typeof e)throw new Error("Level update callback must be a function");this.callbacks.levelUpdate=e}onVolumeSpike(e){if("function"!=typeof e)throw new Error("Volume spike callback must be a function");this.callbacks.volumeSpike=e}onError(e){if("function"!=typeof e)throw new Error("Error callback must be a function");this.callbacks.error=e}removeAllCallbacks(){this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}updateConfig(e){this.config={...this.config,...e},this.analyser&&(e.fftSize&&(this.analyser.fftSize=this.config.fftSize,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount)),void 0!==e.smoothingTimeConstant&&(this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant))}getConfig(){return{...this.config}}getStats(){return{isActive:this.isActive,currentLevel:this.currentLevel,historySize:this.levelHistory.length,maxHistorySize:this.config.historySize,lastSpikeTime:this.lastVolumeSpike,timeSinceLastSpike:this.lastVolumeSpike>0?performance.now()-this.lastVolumeSpike:0,averageLevel:this.levelHistory.length>0?this.levelHistory.reduce((e,t)=>e+t,0)/this.levelHistory.length:0}}emitLevelUpdate(){const e=performance.now();if(!(e-this.lastLevelEmit<this.config.levelUpdateThrottle)&&(this.lastLevelEmit=e,this.callbacks.levelUpdate))try{this.callbacks.levelUpdate({level:this.currentLevel,rawData:this.getFrequencyData(),timestamp:e,history:this.getLevelHistory()})}catch{}}emitVolumeSpike(e){if(this.callbacks.volumeSpike)try{this.callbacks.volumeSpike(e)}catch{}}emitError(e,t){if(this.callbacks.error)try{this.callbacks.error({message:e,error:t,timestamp:performance.now()})}catch{}}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class Tm{constructor(){this.listeners=new Map,this.groups=new Map,this.stats={registered:0,removed:0,active:0}}addEventListener(e,t,i,n={},s="default"){const r=this.generateId(),a={id:r,target:e,eventType:t,handler:i,options:n,group:s,active:!0};return this.listeners.set(r,a),this.groups.has(s)||this.groups.set(s,new Set),this.groups.get(s).add(r),e.addEventListener(t,i,n),this.stats.registered++,this.stats.active++,r}removeEventListener(e){const t=this.listeners.get(e);if(!t||!t.active)return!1;t.target.removeEventListener(t.eventType,t.handler,t.options),t.active=!1;const i=this.groups.get(t.group);return i&&(i.delete(e),0===i.size&&this.groups.delete(t.group)),this.listeners.delete(e),this.stats.removed++,this.stats.active--,!0}removeGroup(e){const t=this.groups.get(e);if(!t)return 0;let i=0;for(const e of t)this.removeEventListener(e)&&i++;return i}removeAllForTarget(e){let t=0;for(const[i,n]of this.listeners.entries())n.target===e&&n.active&&this.removeEventListener(i)&&t++;return t}removeAllOfType(e){let t=0;for(const[i,n]of this.listeners.entries())n.eventType===e&&n.active&&this.removeEventListener(i)&&t++;return t}removeAll(){let e=0;for(const[t,i]of this.listeners.entries())i.active&&this.removeEventListener(t)&&e++;return e}createAutoRemove(e,t,i,n={}){const s=this.addEventListener(e,t,i,n);return{id:s,remove:()=>this.removeEventListener(s)}}once(e,t,i,n={}){const s=this.addEventListener(e,t,e=>{i(e),this.removeEventListener(s)},n);return s}debounced(e,t,i,n=250,s={}){let r;return this.addEventListener(e,t,e=>{clearTimeout(r),r=setTimeout(()=>i(e),n)},s)}throttled(e,t,i,n=100,s={}){let r=!1;return this.addEventListener(e,t,e=>{r||(i(e),r=!0,setTimeout(()=>{r=!1},n))},s)}generateId(){return`listener_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getStats(){return{...this.stats,groups:this.groups.size,listeners:this.listeners.size}}getActiveListeners(){const e=[];for(const[t,i]of this.listeners.entries())i.active&&e.push({id:t,eventType:i.eventType,group:i.group,target:i.target.constructor.name});return e}analyzeLeaks(){const e={totalListeners:this.listeners.size,activeListeners:this.stats.active,inactiveButNotRemoved:0,byTarget:new Map,byType:new Map,potentialLeaks:[]};for(const[t,i]of this.listeners.entries()){const n=i.target.constructor.name;e.byTarget.set(n,(e.byTarget.get(n)||0)+1),e.byType.set(i.eventType,(e.byType.get(i.eventType)||0)+1),i.active||(e.inactiveButNotRemoved++,e.potentialLeaks.push({id:t,eventType:i.eventType,target:n}))}return e.byTarget=Object.fromEntries(e.byTarget),e.byType=Object.fromEntries(e.byType),e}cleanup(){let e=0;for(const[t,i]of this.listeners.entries())i.active||(this.listeners.delete(t),e++);return e}destroy(){const e=this.removeAll();return this.listeners.clear(),this.groups.clear(),this.stats={registered:0,removed:0,active:0},e}}const km=new Tm;class Em{constructor(e={}){this.config={enableReducedMotion:!1!==e.enableReducedMotion,enableHighContrast:!1!==e.enableHighContrast,enableScreenReaderSupport:!1!==e.enableScreenReaderSupport,enableKeyboardNavigation:!1!==e.enableKeyboardNavigation,enableFocusIndicators:!1!==e.enableFocusIndicators,announceStateChanges:!1!==e.announceStateChanges,colorBlindMode:e.colorBlindMode||"none",...e},this.reducedMotionPreferred=!1,this.highContrastEnabled=!1,this.screenReaderActive=!1,this.keyboardNavigationActive=!1,this.currentColorBlindMode=this.config.colorBlindMode,this.focusableElements=new Map,this.currentFocusIndex=-1,this.focusHistory=[],this.liveRegion=null,this.announcementQueue=[],this.boundHandleKeyDown=null,this.boundHandleKeyUp=null,this.colorSchemes={normal:null,highContrast:{primary:"#FFFFFF",secondary:"#000000",accent:"#FFFF00",background:"#000000",particles:"#FFFFFF"},protanopia:{primary:"#0066CC",secondary:"#FFCC00",accent:"#00CCFF",background:"#1A1A1A",particles:"#66CCFF"},deuteranopia:{primary:"#0099FF",secondary:"#FF9900",accent:"#FF00FF",background:"#1A1A1A",particles:"#9966FF"},tritanopia:{primary:"#FF0066",secondary:"#00FF66",accent:"#FF6600",background:"#1A1A1A",particles:"#FFCC00"}},this.patterns={dots:"dots",stripes:"stripes",crosshatch:"crosshatch",solid:"solid"},this.statePatterns={idle:this.patterns.solid,happy:this.patterns.dots,excited:this.patterns.stripes,calm:this.patterns.solid,curious:this.patterns.crosshatch,frustrated:this.patterns.stripes,sad:this.patterns.dots,neutral:this.patterns.solid},this.initialize()}initialize(){this.detectUserPreferences(),this.setupLiveRegion(),this.config.enableKeyboardNavigation&&this.setupKeyboardNavigation(),this.setupPreferenceListeners()}detectUserPreferences(){if(this.config.enableReducedMotion&&window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreferred=e.matches}if(this.config.enableHighContrast&&window.matchMedia){const e=window.matchMedia("(prefers-contrast: high)");if(this.highContrastEnabled=e.matches,!this.highContrastEnabled){const e=window.matchMedia("(-ms-high-contrast: active)");this.highContrastEnabled=e.matches}}this.detectScreenReader()}detectScreenReader(){const e=document.querySelector("[aria-live]"),t=document.querySelector("[aria-atomic]"),i=document.querySelector('[role="application"]'),n=navigator.userAgent.toLowerCase(),s=n.includes("nvda")||n.includes("jaws")||n.includes("voiceover");this.screenReaderActive=!!(e||t||i||s)}setupLiveRegion(){this.config.enableScreenReaderSupport&&(this.liveRegion=document.getElementById("mascot-announcements"),this.liveRegion||(this.liveRegion=document.createElement("div"),this.liveRegion.id="mascot-announcements",this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.style.position="absolute",this.liveRegion.style.left="-10000px",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.overflow="hidden",document.body.appendChild(this.liveRegion)))}setupKeyboardNavigation(){this.boundHandleKeyDown=this.handleKeyDown.bind(this),this.boundHandleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.boundHandleKeyDown),document.addEventListener("keyup",this.boundHandleKeyUp)}setupPreferenceListeners(){window.matchMedia&&(window.matchMedia("(prefers-reduced-motion: reduce)").addListener(e=>{this.reducedMotionPreferred=e.matches,this.onPreferenceChange("reducedMotion",e.matches)}),window.matchMedia("(prefers-contrast: high)").addListener(e=>{this.highContrastEnabled=e.matches,this.onPreferenceChange("highContrast",e.matches)}))}handleKeyDown(e){if(this.config.enableKeyboardNavigation){switch(e.key){case"Tab":e.preventDefault(),this.navigateFocus(e.shiftKey?-1:1);break;case"Enter":case" ":this.activateCurrentFocus();break;case"Escape":this.clearFocus();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":this.handleArrowNavigation(e.key)}this.keyboardNavigationActive=!0}}handleKeyUp(e){}navigateFocus(e){const t=Array.from(this.focusableElements.values());if(0===t.length)return;this.currentFocusIndex+=e,this.currentFocusIndex<0?this.currentFocusIndex=t.length-1:this.currentFocusIndex>=t.length&&(this.currentFocusIndex=0);const i=t[this.currentFocusIndex];this.setFocus(i),i.label&&this.announce(`Focused on ${i.label}`)}handleArrowNavigation(e){const t={ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1}}[e];t&&this.onArrowNavigation&&this.onArrowNavigation(t)}registerFocusableElement(e,t){this.focusableElements.set(e,{id:e,label:t.label||e,bounds:t.bounds||null,action:t.action||null,type:t.type||"button"})}unregisterFocusableElement(e){this.focusableElements.delete(e)}setFocus(e){this.onFocusChange&&this.onFocusChange(e),this.focusHistory.push(e.id),this.focusHistory.length>10&&this.focusHistory.shift()}clearFocus(){this.currentFocusIndex=-1,this.onFocusChange&&this.onFocusChange(null),this.announce("Focus cleared")}activateCurrentFocus(){const e=Array.from(this.focusableElements.values());if(this.currentFocusIndex>=0&&this.currentFocusIndex<e.length){const t=e[this.currentFocusIndex];t.action&&(t.action(),this.announce(`Activated ${t.label}`))}}announce(e,t="polite"){this.config.enableScreenReaderSupport&&this.liveRegion&&(this.announcementQueue.push({message:e,priority:t}),this.processAnnouncementQueue())}processAnnouncementQueue(){if(0===this.announcementQueue.length)return;const{message:e,priority:t}=this.announcementQueue.shift();this.liveRegion.setAttribute("aria-live",t),this.liveRegion.textContent=e,setTimeout(()=>{this.liveRegion&&(this.liveRegion.textContent=""),this.announcementQueue.length>0&&this.processAnnouncementQueue()},100)}getAnimationSettings(e={}){return this.reducedMotionPreferred?{...e,duration:e.duration?.5*e.duration:0,iterations:1,easing:"linear",particlesEnabled:!1,complexAnimations:!1,autoPlay:!1}:e}getColorScheme(e={}){return this.colorSchemes.normal||(this.colorSchemes.normal={...e}),this.highContrastEnabled?this.colorSchemes.highContrast:"none"!==this.currentColorBlindMode&&this.colorSchemes[this.currentColorBlindMode]?this.colorSchemes[this.currentColorBlindMode]:e}getStatePattern(e){return"none"===this.currentColorBlindMode?this.patterns.solid:this.statePatterns[e]||this.patterns.solid}applyPatternOverlay(e,t,i){if(t===this.patterns.solid)return;e.save();const n=document.createElement("canvas"),s=n.getContext("2d");switch(t){case this.patterns.dots:this.createDotPattern(s,n);break;case this.patterns.stripes:this.createStripePattern(s,n);break;case this.patterns.crosshatch:this.createCrosshatchPattern(s,n)}const r=e.createPattern(n,"repeat");e.fillStyle=r,e.globalAlpha=.3,e.fillRect(i.x,i.y,i.width,i.height),e.restore()}createDotPattern(e,t){t.width=10,t.height=10,e.fillStyle="white",e.beginPath(),e.arc(5,5,2,0,2*Math.PI),e.fill()}createStripePattern(e,t){t.width=10,t.height=10,e.strokeStyle="white",e.lineWidth=2,e.beginPath(),e.moveTo(0,10),e.lineTo(10,0),e.stroke()}createCrosshatchPattern(e,t){t.width=10,t.height=10,e.strokeStyle="white",e.lineWidth=1,e.beginPath(),e.moveTo(0,10),e.lineTo(10,0),e.stroke(),e.beginPath(),e.moveTo(0,0),e.lineTo(10,10),e.stroke()}setColorBlindMode(e){["none","protanopia","deuteranopia","tritanopia"].includes(e)&&(this.currentColorBlindMode=e,this.announce(`Color blind mode set to ${e}`),this.onColorSchemeChange&&this.onColorSchemeChange(this.getColorScheme()))}getStatus(){return{reducedMotion:this.reducedMotionPreferred,highContrast:this.highContrastEnabled,screenReader:this.screenReaderActive,keyboardNavigation:this.keyboardNavigationActive,colorBlindMode:this.currentColorBlindMode,focusedElement:this.currentFocusIndex>=0?Array.from(this.focusableElements.values())[this.currentFocusIndex]:null,registeredElements:this.focusableElements.size}}onPreferenceChange(e,t){this.announce(`${e} is now ${t?"enabled":"disabled"}`),"reducedMotion"===e&&this.onReducedMotionChange&&this.onReducedMotionChange(t),"highContrast"===e&&this.onHighContrastChange&&this.onHighContrastChange(t)}createStateDescription(e){return{idle:"Mascot is idle and gently breathing",happy:"Mascot is happy and bouncing",excited:"Mascot is excited with particles flying",calm:"Mascot is calm and peaceful",curious:"Mascot is curious and looking around",frustrated:"Mascot is frustrated and shaking",sad:"Mascot is sad and drooping",neutral:"Mascot is in a neutral state"}[e.emotional]||"Mascot is active"}destroy(){this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown),this.boundHandleKeyDown=null),this.boundHandleKeyUp&&(document.removeEventListener("keyup",this.boundHandleKeyUp),this.boundHandleKeyUp=null),this.liveRegion&&this.liveRegion.parentNode&&this.liveRegion.parentNode.removeChild(this.liveRegion),this.focusableElements.clear(),this.announcementQueue=[],this.focusHistory=[]}}class Pm{constructor(e={}){this.config={enableTouchOptimization:!1!==e.enableTouchOptimization,enableViewportHandling:!1!==e.enableViewportHandling,enableBatteryOptimization:!1!==e.enableBatteryOptimization,enableOrientationSupport:!1!==e.enableOrientationSupport,enableResponsiveScaling:!1!==e.enableResponsiveScaling,touchSensitivity:e.touchSensitivity||1,doubleTapDelay:e.doubleTapDelay||300,swipeThreshold:e.swipeThreshold||50,pinchThreshold:e.pinchThreshold||.1,...e},this.isMobile=this.detectMobile(),this.isTablet=this.detectTablet(),this.isTouchDevice=this.detectTouch(),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.isAndroid=/Android/.test(navigator.userAgent),this.touches=new Map,this.lastTouchTime=0,this.lastTapTime=0,this.tapCount=0,this.touchStartPosition=null,this.isPinching=!1,this.isRotating=!1,this.lastPinchDistance=0,this.lastRotation=0,this.currentGesture=null,this.gestureStartTime=0,this.gestureHistory=[],this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.orientation=this.getOrientation(),this.pixelRatio=window.devicePixelRatio||1,this.lastViewportChange=0,this.batteryLevel=1,this.isCharging=!0,this.lowPowerMode=!1,this.batteryRef=null,this.mobilePerformanceSettings={reducedParticles:this.isMobile,simplifiedAnimations:this.isMobile,lowerFrameRate:this.isMobile,reducedEffects:this.isMobile||this.isTablet,targetFPS:this.isMobile?30:60,maxParticles:this.isMobile?20:50},this.canvasScale=1,this.useOffscreenCanvas=this.supportsOffscreenCanvas(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this),this.handleOrientationChange=this.handleOrientationChange.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleContextMenu=e=>e.preventDefault(),this.initialize()}initialize(){this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers(),this.config.enableViewportHandling&&this.setupViewportHandlers(),this.config.enableBatteryOptimization&&this.setupBatteryMonitoring(),this.config.enableOrientationSupport&&this.setupOrientationHandlers(),this.applyMobileOptimizations()}detectMobile(){const e=navigator.userAgent.toLowerCase(),t=["android","iphone","ipod","windows phone","blackberry"].some(t=>e.includes(t)),i=window.innerWidth<=768,n="ontouchstart"in window||navigator.maxTouchPoints>0;return t||i&&n}detectTablet(){const e=navigator.userAgent.toLowerCase(),t=/ipad/.test(e),i=/android/.test(e)&&!/mobile/.test(e),n=/windows/.test(e)&&/touch/.test(e),s=window.innerWidth>768&&window.innerWidth<=1024,r="ontouchstart"in window||navigator.maxTouchPoints>0;return t||i||n||s&&r}detectTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}setupTouchHandlers(){const e=this.getCanvas();e&&(e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),e.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),e.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),e.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1}),e.addEventListener("contextmenu",this.handleContextMenu))}setupViewportHandlers(){window.addEventListener("resize",this.handleViewportChange),window.addEventListener("orientationchange",this.handleOrientationChange),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.setupViewportMeta()}setupViewportMeta(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"}async setupBatteryMonitoring(){if(navigator.getBattery)try{const e=await navigator.getBattery();this.batteryRef=e,this.batteryLevel=e.level,this.isCharging=e.charging,this.boundBatteryLevelChange=()=>{this.batteryLevel=e.level,this.onBatteryChange()},this.boundBatteryChargingChange=()=>{this.isCharging=e.charging,this.onBatteryChange()},e.addEventListener("levelchange",this.boundBatteryLevelChange),e.addEventListener("chargingchange",this.boundBatteryChargingChange),this.onBatteryChange()}catch{}}setupOrientationHandlers(){window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",e=>{this.handleDeviceOrientation(e)})}handleTouchStart(e){e.cancelable&&e.preventDefault();const t=Date.now();this.gestureStartTime=t;for(const i of e.touches)this.touches.set(i.identifier,{id:i.identifier,startX:i.clientX,startY:i.clientY,currentX:i.clientX,currentY:i.clientY,startTime:t});1===e.touches.length?this.handleSingleTouchStart(e.touches[0]):2===e.touches.length&&this.handleMultiTouchStart(e.touches),this.emitTouchEvent("touchStart",{touches:Array.from(this.touches.values()),timestamp:t})}handleSingleTouchStart(e){const t=Date.now();t-this.lastTapTime<this.config.doubleTapDelay?this.tapCount++:this.tapCount=1,this.lastTapTime=t,this.touchStartPosition={x:e.clientX,y:e.clientY}}handleMultiTouchStart(e){if(2===e.length){const t=e[0],i=e[1];this.lastPinchDistance=this.getDistance(t.clientX,t.clientY,i.clientX,i.clientY),this.lastRotation=this.getAngle(t.clientX,t.clientY,i.clientX,i.clientY),this.isPinching=!0}}handleTouchMove(e){e.cancelable&&e.preventDefault();for(const t of e.touches){const e=this.touches.get(t.identifier);e&&(e.currentX=t.clientX,e.currentY=t.clientY)}1===e.touches.length?this.handleSingleTouchMove(e.touches[0]):2===e.touches.length&&this.handleMultiTouchMove(e.touches),this.emitTouchEvent("touchMove",{touches:Array.from(this.touches.values()),gesture:this.currentGesture})}handleSingleTouchMove(e){const t=this.touches.get(e.identifier);if(!t)return;const i=e.clientX-t.startX,n=e.clientY-t.startY;Math.sqrt(i*i+n*n)>this.config.swipeThreshold?Math.abs(i)>Math.abs(n)?this.currentGesture=i>0?"swipeRight":"swipeLeft":this.currentGesture=n>0?"swipeDown":"swipeUp":this.currentGesture="pan"}handleMultiTouchMove(e){if(2!==e.length)return;const t=e[0],i=e[1],n=this.getDistance(t.clientX,t.clientY,i.clientX,i.clientY),s=n-this.lastPinchDistance,r=n/this.lastPinchDistance;Math.abs(s)>this.config.pinchThreshold&&(this.currentGesture=r>1?"pinchOut":"pinchIn",this.emitTouchEvent("pinch",{scale:r,delta:s}));const a=this.getAngle(t.clientX,t.clientY,i.clientX,i.clientY),o=a-this.lastRotation;Math.abs(o)>5&&(this.currentGesture="rotate",this.emitTouchEvent("rotate",{angle:a,delta:o})),this.lastPinchDistance=n,this.lastRotation=a}handleTouchEnd(e){e.cancelable&&e.preventDefault();const t=Date.now();for(const i of e.changedTouches){const e=this.touches.get(i.identifier);if(e){const n=t-e.startTime,s=e.currentX-e.startX,r=e.currentY-e.startY,a=Math.sqrt(s*s+r*r);n<300&&a<10&&(2===this.tapCount?(this.emitTouchEvent("doubleTap",{x:e.currentX,y:e.currentY}),this.tapCount=0):this.emitTouchEvent("tap",{x:e.currentX,y:e.currentY})),n>500&&a<10&&this.emitTouchEvent("longPress",{x:e.currentX,y:e.currentY}),this.touches.delete(i.identifier)}}0===e.touches.length&&(this.currentGesture=null,this.isPinching=!1,this.isRotating=!1),this.emitTouchEvent("touchEnd",{gesture:this.currentGesture,duration:t-this.gestureStartTime})}handleTouchCancel(e){this.touches.clear(),this.currentGesture=null,this.isPinching=!1,this.isRotating=!1,this.emitTouchEvent("touchCancel",{})}handleOrientationChange(e){this.orientation=this.getOrientation(),this.emitTouchEvent("orientationChange",{orientation:this.orientation,angle:window.orientation||0}),this.applyOrientationOptimizations()}handleDeviceOrientation(e){const{alpha:t,beta:i,gamma:n}=e;this.emitTouchEvent("deviceOrientation",{alpha:t,beta:i,gamma:n})}handleViewportChange(e){const t=Date.now();t-this.lastViewportChange<100||(this.lastViewportChange=t,this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.pixelRatio=window.devicePixelRatio||1,this.emitTouchEvent("viewportChange",{size:this.viewportSize,pixelRatio:this.pixelRatio,orientation:this.getOrientation()}),this.config.enableResponsiveScaling&&this.applyResponsiveScaling())}handleVisibilityChange(e){const t=!document.hidden;this.emitTouchEvent("visibilityChange",{visible:t}),!t&&this.config.enableBatteryOptimization?this.applyBackgroundOptimizations():this.restorePerformance()}getOrientation(){return window.innerWidth>window.innerHeight?"landscape":"portrait"}getDistance(e,t,i,n){const s=i-e,r=n-t;return Math.sqrt(s*s+r*r)}getAngle(e,t,i,n){return 180*Math.atan2(n-t,i-e)/Math.PI}applyMobileOptimizations(){if(!this.isMobile&&!this.isTablet)return;const e={...this.mobilePerformanceSettings,canvasScale:this.calculateOptimalCanvasScale(),useWebGL:!1,useOffscreenCanvas:this.useOffscreenCanvas};return this.emitTouchEvent("mobileOptimizations",e),e}applyOrientationOptimizations(){const e="landscape"===this.orientation,t={layoutMode:e?"horizontal":"vertical",particleDirection:e?"horizontal":"vertical",uiScale:e?.8:1};return this.emitTouchEvent("orientationOptimizations",t),t}applyResponsiveScaling(){const e=Math.min(this.viewportSize.width/375,2);return this.canvasScale=e,this.emitTouchEvent("responsiveScale",{scale:this.canvasScale,viewport:this.viewportSize}),this.canvasScale}applyBackgroundOptimizations(){const e={targetFPS:5,particlesEnabled:!1,animationsEnabled:!1,audioEnabled:!1};return this.emitTouchEvent("backgroundOptimizations",e),e}restorePerformance(){const e=this.applyMobileOptimizations();return this.emitTouchEvent("performanceRestore",e),e}onBatteryChange(){if(this.lowPowerMode=this.batteryLevel<.2&&!this.isCharging,this.lowPowerMode){const e={targetFPS:15,maxParticles:5,reducedEffects:!0,audioEnabled:!1};this.emitTouchEvent("lowPowerMode",{batteryLevel:this.batteryLevel,isCharging:this.isCharging,optimizations:e})}}calculateOptimalCanvasScale(){return this.isMobile?Math.min(this.pixelRatio,2):this.isTablet?Math.min(this.pixelRatio,2.5):this.pixelRatio}getCanvas(){return this.canvas||document.querySelector("canvas")}setCanvas(e){this.canvas=e,this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers()}emitTouchEvent(e,t){this.onTouchEvent&&this.onTouchEvent(e,t)}getStatus(){return{device:{isMobile:this.isMobile,isTablet:this.isTablet,isTouchDevice:this.isTouchDevice,isIOS:this.isIOS,isAndroid:this.isAndroid},viewport:{size:this.viewportSize,orientation:this.orientation,pixelRatio:this.pixelRatio,canvasScale:this.canvasScale},battery:{level:this.batteryLevel,isCharging:this.isCharging,lowPowerMode:this.lowPowerMode},touch:{activeTouches:this.touches.size,currentGesture:this.currentGesture,isPinching:this.isPinching,isRotating:this.isRotating},performance:this.mobilePerformanceSettings}}destroy(){const e=this.getCanvas();e&&(e.removeEventListener("touchstart",this.handleTouchStart),e.removeEventListener("touchmove",this.handleTouchMove),e.removeEventListener("touchend",this.handleTouchEnd),e.removeEventListener("touchcancel",this.handleTouchCancel),e.removeEventListener("contextmenu",this.handleContextMenu)),window.removeEventListener("resize",this.handleViewportChange),window.removeEventListener("orientationchange",this.handleOrientationChange),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.batteryRef&&(this.boundBatteryLevelChange&&this.batteryRef.removeEventListener("levelchange",this.boundBatteryLevelChange),this.boundBatteryChargingChange&&this.batteryRef.removeEventListener("chargingchange",this.boundBatteryChargingChange),this.batteryRef=null),this.touches.clear(),this.gestureHistory=[]}}class _m{constructor(e={}){this.config={enablePlugins:!1!==e.enablePlugins,validatePlugins:!1!==e.validatePlugins,sandboxPlugins:!1!==e.sandboxPlugins,maxPlugins:e.maxPlugins||50,pluginTimeout:e.pluginTimeout||5e3,allowOverrides:!1!==e.allowOverrides,...e},this.mascot=e.mascot||null,this.plugins=new Map,this.pluginTypes=["emotion","gesture","particle","audio","renderer","animation"],this.pluginsByType=new Map(this.pluginTypes.map(e=>[e,new Set])),this.dependencies=new Map,this.dependencyGraph=new Map,this.pluginStates=new Map,this.loadingPlugins=new Set,this.activePlugins=new Set,this.hooks=new Map([["beforeInit",new Set],["afterInit",new Set],["beforeUpdate",new Set],["afterUpdate",new Set],["beforeRender",new Set],["afterRender",new Set],["beforeDestroy",new Set],["afterDestroy",new Set]]),this.pluginAPI=this.createPluginAPI(),this.conflicts=new Map,this.resolutionStrategies={override:this.overrideConflict.bind(this),merge:this.mergeConflict.bind(this),reject:this.rejectConflict.bind(this),queue:this.queueConflict.bind(this)},this.validationSchemas=this.createValidationSchemas(),this.sandbox=null,this.config.sandboxPlugins&&(this.sandbox=this.createSandbox())}createPluginAPI(){return{mascot:this.mascot,registerHook:this.registerHook.bind(this),emit:this.emitPluginEvent.bind(this),on:this.onPluginEvent.bind(this),getPlugin:this.getPlugin.bind(this),hasPlugin:this.hasPlugin.bind(this),log:this.logFromPlugin.bind(this),error:this.errorFromPlugin.bind(this),setState:this.setPluginState.bind(this),getState:this.getPluginState.bind(this),getConfig:()=>({...this.config}),version:"1.0.0"}}createValidationSchemas(){const e=new Map,t={name:{type:"string",required:!0},version:{type:"string",required:!0},type:{type:"string",required:!0,enum:this.pluginTypes},description:{type:"string",required:!1},author:{type:"string",required:!1},dependencies:{type:"array",required:!1},conflicts:{type:"array",required:!1},init:{type:"function",required:!0},destroy:{type:"function",required:!0}};return e.set("emotion",{...t,emotion:{type:"object",required:!0,properties:{name:{type:"string",required:!0},color:{type:"string",required:!0},particleColor:{type:"string",required:!1},animation:{type:"object",required:!0},transitions:{type:"object",required:!1}}},updateEmotion:{type:"function",required:!0},renderEmotion:{type:"function",required:!1}}),e.set("gesture",{...t,gesture:{type:"object",required:!0,properties:{name:{type:"string",required:!0},duration:{type:"number",required:!0},keyframes:{type:"array",required:!0},compatibility:{type:"object",required:!1}}},executeGesture:{type:"function",required:!0},canExecute:{type:"function",required:!1}}),e.set("particle",{...t,particle:{type:"object",required:!0,properties:{name:{type:"string",required:!0},maxParticles:{type:"number",required:!1},behavior:{type:"function",required:!0},render:{type:"function",required:!0}}},updateParticles:{type:"function",required:!0},spawnParticle:{type:"function",required:!1}}),e.set("audio",{...t,audio:{type:"object",required:!0,properties:{name:{type:"string",required:!0},sounds:{type:"object",required:!0},effects:{type:"array",required:!1}}},playSound:{type:"function",required:!0},processAudio:{type:"function",required:!1}}),e}createSandbox(){return{Math:Math,Date:Date,JSON:JSON,console:{log:(...e)=>null,warn:(...e)=>null,error:(...e)=>null},window:void 0,document:void 0,localStorage:void 0,sessionStorage:void 0,fetch:void 0,XMLHttpRequest:void 0,api:this.pluginAPI}}async registerPlugin(e){if(!this.config.enablePlugins)return!1;if(this.plugins.size>=this.config.maxPlugins)return!1;if(this.config.validatePlugins&&!this.validatePlugin(e).valid)return!1;if(this.checkConflicts(e).length>0&&!this.config.allowOverrides)return!1;if(!(await this.resolveDependencies(e)).resolved)return!1;try{this.loadingPlugins.add(e.name);const t=this.config.sandboxPlugins?this.sandbox:window;if(!await this.initializePlugin(e,t))throw new Error("Plugin initialization failed");return this.plugins.set(e.name,e),this.pluginsByType.get(e.type).add(e.name),this.pluginStates.set(e.name,"active"),this.activePlugins.add(e.name),e.dependencies&&(this.dependencies.set(e.name,e.dependencies),this.updateDependencyGraph(e.name,e.dependencies)),e.hooks&&Object.entries(e.hooks).forEach(([t,i])=>{this.registerHook(t,i,e.name)}),this.emitPluginEvent("pluginRegistered",{name:e.name,type:e.type,version:e.version}),!0}catch{return!1}finally{this.loadingPlugins.delete(e.name)}}validatePlugin(e){const t=[];if(e.name&&"string"==typeof e.name||t.push("Plugin must have a valid name"),e.type&&this.pluginTypes.includes(e.type)||t.push(`Plugin type must be one of: ${this.pluginTypes.join(", ")}`),e.version&&"string"==typeof e.version||t.push("Plugin must have a version"),"function"!=typeof e.init&&t.push("Plugin must have an init function"),"function"!=typeof e.destroy&&t.push("Plugin must have a destroy function"),e.type&&this.validationSchemas.has(e.type)){const i=this.validationSchemas.get(e.type),n=this.validateAgainstSchema(e,i);t.push(...n)}return{valid:0===t.length,errors:t}}validateAgainstSchema(e,t){const i=[];return Object.entries(t).forEach(([t,n])=>{if(n.required&&!(t in e)&&i.push(`Missing required property: ${t}`),t in e){const s=e[t];if(n.type&&typeof s!==n.type&&i.push(`Property ${t} must be of type ${n.type}`),n.enum&&!n.enum.includes(s)&&i.push(`Property ${t} must be one of: ${n.enum.join(", ")}`),n.properties&&"object"==typeof s){const e=this.validateAgainstSchema(s,n.properties);i.push(...e.map(e=>`${t}.${e}`))}}}),i}checkConflicts(e){const t=[];return e.conflicts&&e.conflicts.forEach(e=>{this.plugins.has(e)&&t.push(e)}),"emotion"!==e.type&&"gesture"!==e.type||this.plugins.forEach(i=>{if(i.type===e.type){const n=i[e.type]?.name,s=e[e.type]?.name;n===s&&t.push(`${e.type} name collision: ${s}`)}}),t}async resolveDependencies(e){if(!e.dependencies||0===e.dependencies.length)return{resolved:!0,missing:[]};const t=[];for(const i of e.dependencies)this.plugins.has(i)||await this.tryLoadDependency(i)||t.push(i);return{resolved:0===t.length,missing:t}}tryLoadDependency(e){return this.plugins.has(e)}updateDependencyGraph(e,t){this.dependencyGraph.set(e,new Set(t)),t.forEach(e=>{this.dependencyGraph.has(e)||this.dependencyGraph.set(e,new Set)})}async initializePlugin(e,t){try{const i=new Promise((e,t)=>{setTimeout(()=>t(new Error("Plugin initialization timeout")),this.config.pluginTimeout)}),n=e.init.bind(t);return!1!==await Promise.race([n(this.pluginAPI),i])}catch{return!1}}async unregisterPlugin(e){const t=this.plugins.get(e);if(!t)return!1;if(this.getDependentPlugins(e).length>0)return!1;try{return"function"==typeof t.destroy&&await t.destroy(),this.plugins.delete(e),this.pluginsByType.get(t.type).delete(e),this.pluginStates.delete(e),this.activePlugins.delete(e),this.dependencies.delete(e),this.dependencyGraph.delete(e),this.hooks.forEach(t=>{t.forEach(i=>{i.pluginName===e&&t.delete(i)})}),this.emitPluginEvent("pluginUnregistered",{name:e}),!0}catch{return!1}}getDependentPlugins(e){const t=[];return this.dependencies.forEach((i,n)=>{i.includes(e)&&t.push(n)}),t}registerHook(e,t,i){this.hooks.has(e)||this.hooks.set(e,new Set),this.hooks.get(e).add({handler:t,pluginName:i})}async executeHooks(e,t){const i=this.hooks.get(e);if(!i||0===i.size)return[];const n=[];for(const e of i)try{const i=await e.handler(t);n.push({pluginName:e.pluginName,result:i})}catch{}return n}getPlugin(e){return this.plugins.get(e)||null}hasPlugin(e){return this.plugins.has(e)}getPluginsByType(e){const t=this.pluginsByType.get(e);return t?Array.from(t).map(e=>this.plugins.get(e)):[]}enablePlugin(e){if(!this.plugins.has(e))return;this.pluginStates.set(e,"active"),this.activePlugins.add(e);const t=this.plugins.get(e);t.onEnable&&t.onEnable(),this.emitPluginEvent("pluginEnabled",{name:e})}disablePlugin(e){if(!this.plugins.has(e))return;this.getDependentPlugins(e).length,this.pluginStates.set(e,"disabled"),this.activePlugins.delete(e);const t=this.plugins.get(e);t.onDisable&&t.onDisable(),this.emitPluginEvent("pluginDisabled",{name:e})}emitPluginEvent(e,t){this.onPluginEvent&&this.onPluginEvent(e,t)}onPluginEvent(e,t){}logFromPlugin(e,...t){}errorFromPlugin(e,...t){}setPluginState(e,t,i){this.pluginStates.has(e)||this.pluginStates.set(e,{});const n=this.pluginStates.get(e);"object"==typeof n&&(n[t]=i)}getPluginState(e,t){const i=this.pluginStates.get(e);if("object"==typeof i)return i[t]}overrideConflict(e,t){return t}mergeConflict(e,t){return{...e,...t}}rejectConflict(e,t){return e}queueConflict(e,t){return[e,t]}getStatus(){return{enabled:this.config.enablePlugins,totalPlugins:this.plugins.size,activePlugins:this.activePlugins.size,loadingPlugins:this.loadingPlugins.size,pluginsByType:Object.fromEntries(Array.from(this.pluginsByType.entries()).map(([e,t])=>[e,t.size])),hooks:Object.fromEntries(Array.from(this.hooks.entries()).map(([e,t])=>[e,t.size]))}}update(e,t){if(this.config.enablePlugins)for(const i of this.activePlugins){const n=this.plugins.get(i);if(n&&"function"==typeof n.update)try{n.update(e,t)}catch(e){this.errorFromPlugin(i,"Update error:",e)}}}render(e,t){if(this.config.enablePlugins)for(const i of this.activePlugins){const n=this.plugins.get(i);if(n&&"function"==typeof n.render)try{n.render(e,t)}catch(e){this.errorFromPlugin(i,"Render error:",e)}}}async destroy(){const e=Array.from(this.plugins.keys());for(const t of e)await this.unregisterPlugin(t);this.plugins.clear(),this.pluginsByType.clear(),this.dependencies.clear(),this.dependencyGraph.clear(),this.pluginStates.clear(),this.activePlugins.clear(),this.loadingPlugins.clear(),this.hooks.clear(),this.conflicts.clear()}}class Am{constructor(){if(Am._cachedFeatures)return this.features=Am._cachedFeatures,void(this.capabilities=Am._cachedCapabilities);this.features={webAudio:this.detectWebAudio(),canvas2d:this.detectCanvas2D(),requestAnimationFrame:this.detectRequestAnimationFrame(),devicePixelRatio:this.detectDevicePixelRatio(),audioContext:this.detectAudioContext(),mediaDevices:this.detectMediaDevices(),performance:this.detectPerformance(),intersectionObserver:this.detectIntersectionObserver()},this.capabilities=this.assessCapabilities(),Am._cachedFeatures=this.features,Am._cachedCapabilities=this.capabilities}detectWebAudio(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch{return!1}}detectCanvas2D(){try{const e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}catch{return!1}}detectRequestAnimationFrame(){return!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame)}detectDevicePixelRatio(){return"number"==typeof window.devicePixelRatio}detectAudioContext(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch{return!1}}detectMediaDevices(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)}detectPerformance(){return!(!window.performance||!window.performance.now)}detectIntersectionObserver(){return"function"==typeof window.IntersectionObserver}assessCapabilities(){const e=Object.values(this.features).filter(Boolean).length,t=Object.keys(this.features).length,i=e/t*100;let n="basic";return i>=90?n="full":i>=70?n="good":i>=50&&(n="limited"),{score:e,total:t,percentage:i,level:n,recommendations:this.getRecommendations(n)}}getRecommendations(e){const t=[];return this.features.webAudio||t.push("Audio features will be disabled"),this.features.requestAnimationFrame||t.push("Animation will use setTimeout fallback"),this.features.performance||t.push("Performance monitoring will be limited"),"basic"===e&&t.push("Consider using minimal build for better performance"),t}getFeatures(){return{...this.features}}getCapabilities(){return{...this.capabilities}}}class Im{constructor(){this.polyfills=new Map,this.applied=new Set}register(e,t){this.polyfills.set(e,t)}apply(e){if(this.applied.has(e))return!0;const t=this.polyfills.get(e);if(!t)return!1;try{return t(),this.applied.add(e),!0}catch{return!1}}applyAll(){const e=[];for(const t of this.polyfills.keys())this.apply(t)&&e.push(t);return e}isApplied(e){return this.applied.has(e)}}function Rm(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(()=>{e(Date.now())},1e3/60)},window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){window.clearTimeout(e)})}function Dm(){if(window.performance&&window.performance.now)return;window.performance||(window.performance={});const e=Date.now();window.performance.now=function(){return Date.now()-e}}function Om(){window.AudioContext||window.webkitAudioContext||(window.AudioContext=function(){this.state="suspended",this.sampleRate=44100,this.currentTime=0,this.destination={connect(){},disconnect(){}},this.createGain=function(){return{gain:{value:1},connect(){},disconnect(){}}},this.createOscillator=function(){return{frequency:{value:440},type:"sine",start(){},stop(){},connect(){},disconnect(){}}},this.createAnalyser=function(){return{fftSize:2048,frequencyBinCount:1024,getByteFrequencyData(e){for(let t=0;t<e.length;t++)e[t]=0},connect(){},disconnect(){}}},this.resume=function(){return this.state="running",Promise.resolve()},this.suspend=function(){return this.state="suspended",Promise.resolve()},this.close=function(){return this.state="closed",Promise.resolve()}})}class zm{constructor(e){this.canvas=e,this.context=null,this.isContextLost=!1,this.recoveryCallbacks=[],this.setupContextLossHandling()}setupContextLossHandling(){this.canvas.addEventListener("webglcontextlost",e=>{e.preventDefault(),this.isContextLost=!0}),this.canvas.addEventListener("webglcontextrestored",()=>{this.isContextLost=!1,this.context=this.canvas.getContext("2d"),this.recoveryCallbacks.forEach(e=>{try{e(this.context)}catch{}})})}getContext(){if(this.isContextLost)return null;if(!this.context)try{this.context=this.canvas.getContext("2d")}catch{return null}return this.context}onRecovery(e){this.recoveryCallbacks.push(e)}isLost(){return this.isContextLost}recover(){if(!this.isContextLost)return!0;try{if(this.context=this.canvas.getContext("2d"),this.context)return this.isContextLost=!1,!0}catch{}return!1}}class Bm{constructor(){if(Bm._cachedBrowser)return this.browser=Bm._cachedBrowser,void(this.optimizations=Bm._cachedOptimizations);this.browser=this.detectBrowser(),this.optimizations=new Map,this.setupOptimizations(),Bm._cachedBrowser=this.browser,Bm._cachedOptimizations=this.optimizations}detectBrowser(){const{userAgent:e}=navigator;let t="unknown",i="unknown";if(e.includes("Chrome")){t="chrome";const n=e.match(/Chrome\/(\d+)/);i=n?n[1]:"unknown"}else if(e.includes("Firefox")){t="firefox";const n=e.match(/Firefox\/(\d+)/);i=n?n[1]:"unknown"}else if(e.includes("Safari")&&!e.includes("Chrome")){t="safari";const n=e.match(/Version\/(\d+)/);i=n?n[1]:"unknown"}else if(e.includes("Edge")){t="edge";const n=e.match(/Edge\/(\d+)/);i=n?n[1]:"unknown"}return{name:t,version:i,userAgent:e}}setupOptimizations(){this.optimizations.set("chrome",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:50}),this.optimizations.set("firefox",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"balanced"},canvasOptimizations:[],particleLimit:40}),this.optimizations.set("safari",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"playback"},canvasOptimizations:[],particleLimit:30}),this.optimizations.set("edge",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:45})}getOptimizations(){return this.optimizations.get(this.browser.name)||this.optimizations.get("chrome")}getBrowser(){return{...this.browser}}applyCanvasOptimizations(e,t){if(this.getOptimizations().canvasOptimizations.includes("willReadFrequently"))try{e.getContext("2d",{willReadFrequently:!0})}catch{}}getRecommendedParticleLimit(){return this.getOptimizations().particleLimit}getAudioContextOptions(){return this.getOptimizations().audioContextOptions}}let Fm=null,Lm=null;const qm=(Lm||(Lm=function(){if(Fm)return Fm;const e=new Am,t=new Im,i=new Bm;t.register("requestAnimationFrame",Rm),t.register("performanceNow",Dm),t.register("webAudio",Om);const n=[];return e.features.requestAnimationFrame||t.apply("requestAnimationFrame")&&n.push("requestAnimationFrame"),e.features.performance||t.apply("performanceNow")&&n.push("performanceNow"),e.features.webAudio||t.apply("webAudio")&&n.push("webAudio"),Fm={featureDetection:e,polyfillManager:t,browserOptimizations:i,appliedPolyfills:n,capabilities:e.getCapabilities(),browser:i.getBrowser()},Fm}()),Lm),Gm={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5},$m=new class{constructor(e={}){this.config={enabled:!1!==e.enabled,level:e.level||Gm.INFO,enableProfiling:!1!==e.enableProfiling,enableErrorTracking:!1!==e.enableErrorTracking,enableMemoryTracking:!1!==e.enableMemoryTracking,maxLogEntries:e.maxLogEntries||1e3,maxProfileEntries:e.maxProfileEntries||500,...e},this.logs=[],this.errors=[],this.profiles=new Map,this.memorySnapshots=[],this.frameTimings=[],this.maxFrameTimings=120,this.errorCounts=new Map,this.lastErrors=new Map,this.capabilities={performance:"undefined"!=typeof performance&&performance.now,memory:"undefined"!=typeof performance&&performance.memory,console:"undefined"!=typeof console,stackTrace:"undefined"!=typeof Error},this.startTime=this.now(),this.setupErrorHandling(),this.config.enabled&&this.log("DEBUG","EmotiveDebugger initialized",{config:this.config,capabilities:this.capabilities})}now(){return this.capabilities.performance?performance.now():Date.now()-this.startTime}setupErrorHandling(){this.config.enableErrorTracking&&"undefined"!=typeof window&&(window.addEventListener("error",e=>{this.trackError("UNHANDLED_ERROR",e.error||new Error(e.message),{filename:e.filename,lineno:e.lineno,colno:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.trackError("UNHANDLED_REJECTION",e.reason,{promise:e.promise})}))}log(e,t,i=null){if(!this.config.enabled)return;if((Gm[e]||Gm.INFO)>this.config.level)return;const n=this.now(),s={timestamp:n,level:e,message:t,data:i,stackTrace:this.getStackTrace()};if(this.logs.push(s),this.logs.length>this.config.maxLogEntries&&this.logs.shift(),this.capabilities.console){const s=this.getConsoleMethod(e),r=`[${(n/1e3).toFixed(3)}s]`;i?s(`${r} [${e}] ${t}`,i):s(`${r} [${e}] ${t}`)}}getConsoleMethod(e){return(()=>{}).bind(console)}getStackTrace(){if(!this.capabilities.stackTrace)return null;try{throw new Error}catch(e){return e.stack}}trackError(e,t,i={}){if(!this.config.enableErrorTracking)return;const n={timestamp:this.now(),type:e,message:t.message||String(t),stack:t.stack,context:i,count:1},s=`${e}:${t.message}`;this.errorCounts.has(s)?(this.errorCounts.set(s,this.errorCounts.get(s)+1),n.count=this.errorCounts.get(s)):this.errorCounts.set(s,1),this.errors.push(n),this.lastErrors.set(e,n),this.log("ERROR",`${e}: ${t.message}`,{error:n,context:i})}startProfile(e,t={}){if(!this.config.enableProfiling)return;const i={name:e,startTime:this.now(),metadata:t,samples:[],isActive:!0};this.profiles.set(e,i),this.log("TRACE",`Started profiling: ${e}`,t)}profileSample(e,t,i=null){if(!this.config.enableProfiling)return;const n=this.profiles.get(e);if(!n||!n.isActive)return;const s={timestamp:this.now(),label:t,data:i,relativeTime:this.now()-n.startTime};n.samples.push(s)}endProfile(e){if(!this.config.enableProfiling)return null;const t=this.profiles.get(e);if(!t||!t.isActive)return null;if(t.endTime=this.now(),t.duration=t.endTime-t.startTime,t.isActive=!1,t.stats=this.calculateProfileStats(t),this.log("TRACE",`Ended profiling: ${e}`,{duration:t.duration,samples:t.samples.length,stats:t.stats}),this.profiles.size>this.config.maxProfileEntries){const e=this.profiles.keys().next().value;this.profiles.delete(e)}return{...t}}calculateProfileStats(e){if(0===e.samples.length)return{sampleCount:0};const t=[];for(let i=1;i<e.samples.length;i++)t.push(e.samples[i].relativeTime-e.samples[i-1].relativeTime);if(0===t.length)return{sampleCount:e.samples.length};const i=t.reduce((e,t)=>e+t,0)/t.length,n=Math.min(...t),s=Math.max(...t);return{sampleCount:e.samples.length,avgSampleDuration:i,minSampleDuration:n,maxSampleDuration:s,totalDuration:e.duration}}trackFrameTiming(e){this.config.enableProfiling&&(this.frameTimings.push({timestamp:this.now(),frameTime:e,fps:1e3/e}),this.frameTimings.length>this.maxFrameTimings&&this.frameTimings.shift())}takeMemorySnapshot(e="snapshot"){if(!this.config.enableMemoryTracking||!this.capabilities.memory)return;const t={timestamp:this.now(),label:e,memory:{usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}};this.memorySnapshots.push(t),this.memorySnapshots.length>100&&this.memorySnapshots.shift(),this.log("DEBUG",`Memory snapshot: ${e}`,t.memory)}getDebugReport(){return{timestamp:this.now(),uptime:this.now()-0,config:this.config,capabilities:this.capabilities,logCount:this.logs.length,recentLogs:this.logs.slice(-10),errorCount:this.errors.length,uniqueErrors:this.errorCounts.size,recentErrors:this.errors.slice(-5),errorCounts:Object.fromEntries(this.errorCounts),activeProfiles:Array.from(this.profiles.values()).filter(e=>e.isActive).length,completedProfiles:Array.from(this.profiles.values()).filter(e=>!e.isActive).length,frameTimings:this.getFrameTimingStats(),memorySnapshots:this.memorySnapshots.slice(-5)}}getFrameTimingStats(){if(0===this.frameTimings.length)return{sampleCount:0};const e=this.frameTimings.map(e=>e.frameTime),t=this.frameTimings.map(e=>e.fps);return{sampleCount:this.frameTimings.length,avgFrameTime:e.reduce((e,t)=>e+t,0)/e.length,minFrameTime:Math.min(...e),maxFrameTime:Math.max(...e),avgFPS:t.reduce((e,t)=>e+t,0)/t.length,minFPS:Math.min(...t),maxFPS:Math.max(...t)}}exportDebugData(){return{metadata:{exportTime:Date.now(),debuggerUptime:this.now(),config:this.config,capabilities:this.capabilities},logs:[...this.logs],errors:[...this.errors],profiles:Object.fromEntries(this.profiles),frameTimings:[...this.frameTimings],memorySnapshots:[...this.memorySnapshots],errorCounts:Object.fromEntries(this.errorCounts)}}clear(){this.logs=[],this.errors=[],this.profiles.clear(),this.frameTimings=[],this.memorySnapshots=[],this.errorCounts.clear(),this.lastErrors.clear(),this.log("INFO","Debug data cleared")}destroy(){this.clear(),this.config.enabled=!1}}({enabled:"undefined"!=typeof window&&window.location&&window.location.search.includes("debug=true"),level:Gm.INFO}),Hm=new class{constructor(){this.capabilities=this.detectCapabilities(),this.performance=this.measurePerformance()}detectCapabilities(){return{es6:this.detectES6(),es2017:this.detectES2017(),modules:this.detectModules(),webGL:this.detectWebGL(),webGL2:this.detectWebGL2(),webWorkers:this.detectWebWorkers(),serviceWorkers:this.detectServiceWorkers(),performanceObserver:this.detectPerformanceObserver(),intersectionObserver:this.detectIntersectionObserver(),resizeObserver:this.detectResizeObserver(),localStorage:this.detectLocalStorage(),sessionStorage:this.detectSessionStorage(),indexedDB:this.detectIndexedDB(),fetch:this.detectFetch(),webSockets:this.detectWebSockets(),touchEvents:this.detectTouchEvents(),pointerEvents:this.detectPointerEvents(),deviceOrientation:this.detectDeviceOrientation(),canvas2d:this.detectCanvas2D(),canvasFilters:this.detectCanvasFilters(),offscreenCanvas:this.detectOffscreenCanvas()}}detectES6(){try{return"undefined"!=typeof Symbol&&"undefined"!=typeof Promise&&"undefined"!=typeof Map&&"undefined"!=typeof Set}catch{return!1}}detectES2017(){try{return"undefined"!=typeof async||function(){try{return"function"==typeof async function(){}.constructor}catch{return!1}}()}catch{return!1}}detectModules(){try{return"undefined"!=typeof document&&"noModule"in document.createElement("script")}catch{return!1}}detectWebGL(){try{const e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch{return!1}}detectWebGL2(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}detectWebWorkers(){return"undefined"!=typeof Worker}detectServiceWorkers(){return"serviceWorker"in navigator}detectPerformanceObserver(){return"undefined"!=typeof PerformanceObserver}detectIntersectionObserver(){return"undefined"!=typeof IntersectionObserver}detectResizeObserver(){return"undefined"!=typeof ResizeObserver}detectLocalStorage(){try{return"undefined"!=typeof localStorage&&null!==localStorage}catch{return!1}}detectSessionStorage(){try{return"undefined"!=typeof sessionStorage&&null!==sessionStorage}catch{return!1}}detectIndexedDB(){return"undefined"!=typeof indexedDB}detectFetch(){return"undefined"!=typeof fetch}detectWebSockets(){return"undefined"!=typeof WebSocket}detectTouchEvents(){return"ontouchstart"in window||navigator.maxTouchPoints>0}detectPointerEvents(){return"undefined"!=typeof PointerEvent}detectDeviceOrientation(){return"ondeviceorientation"in window}detectCanvas2D(){try{return!!document.createElement("canvas").getContext("2d")}catch{return!1}}detectCanvasFilters(){try{return"filter"in document.createElement("canvas").getContext("2d")}catch{return!1}}detectOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}measurePerformance(){const e={},t=performance.now();e.jsExecutionSpeed=performance.now()-t;try{const t=document.createElement("canvas");t.width=100,t.height=100;const i=t.getContext("2d"),n=performance.now();for(let e=0;e<1e3;e++)i.fillRect(100*Math.random(),100*Math.random(),10,10);e.canvasPerformance=performance.now()-n}catch{e.canvasPerformance=null}return e}getCapabilities(){return{...this.capabilities}}getPerformance(){return{...this.performance}}generateReport(){const e=Object.entries(this.capabilities).filter(([,e])=>e).map(([e])=>e),t=Object.entries(this.capabilities).filter(([,e])=>!e).map(([e])=>e),i=e.length/Object.keys(this.capabilities).length*100;return{timestamp:Date.now(),userAgent:navigator.userAgent,supportedFeatures:e,unsupportedFeatures:t,supportPercentage:Math.round(i),performance:this.performance,recommendations:this.generateRecommendations(i)}}generateRecommendations(e){const t=[];return e<50&&t.push("Consider using the minimal build for better compatibility"),this.capabilities.webGL||t.push("WebGL not supported - advanced graphics features unavailable"),this.capabilities.webWorkers||t.push("Web Workers not supported - background processing unavailable"),this.capabilities.fetch||t.push("Fetch API not supported - consider using XMLHttpRequest polyfill"),this.performance.jsExecutionSpeed>50&&t.push("Slow JavaScript execution detected - consider performance optimizations"),this.performance.canvasPerformance>100&&t.push("Slow canvas performance detected - consider reducing visual complexity"),t}};function jm(e){const t=[];for(let i=0;i<e;i++){const n=i/e*Math.PI*2;t.push({x:.5+.5*Math.cos(n),y:.5+.5*Math.sin(n)})}return t}function Wm(e,t=12){return jm(e)}const Nm={circle:{points:jm(64),shadow:{type:"none"}},sphere:{points:jm(64),shadow:{type:"none"}},heart:{points:function(){const e=[];for(let t=0;t<64;t++){const i=t/64*Math.PI*2,n=16*Math.pow(Math.sin(i),3),s=-(13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i));e.push({x:.5+n/32,y:.5+s/32})}return e}(),shadow:{type:"none"}},star:{points:function(){const e=[];for(let t=0;t<64;t++){const i=t/64,n=Math.floor(10*i),s=n%2==0,r=Math.floor(n/2);let a;a=s?(72*r-90)*Math.PI/180:(72*r+36-90)*Math.PI/180;const o=s?.5:.2;e.push({x:.5+Math.cos(a)*o,y:.5+Math.sin(a)*o})}return e}(0),shadow:{type:"none"}},sun:{points:Wm(64,12),shadow:{type:"sun",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3}},moon:{points:jm(64),shadow:{type:"crescent",coverage:.85,angle:-30,softness:.05,offset:.7}},lunar:{points:jm(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)",progression:"center"}},suspicion:{points:function(){const e=[];for(let t=0;t<64;t++){const i=t/64*Math.PI*2;let n,s;if(i<Math.PI)n=.45*Math.cos(i),s=.45*Math.sin(i);else{const e=2*Math.PI-i;n=.25*Math.cos(e)-.1,s=.35*Math.sin(e)}e.push({x:.5+n,y:.5+s})}return e}(),shadow:{type:"none"}},eclipse:{points:jm(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)"}},square:{points:function(){const e=[],t=Math.floor(16);for(let i=0;i<4;i++)for(let n=0;n<t;n++){const s=n/t;let r,a;switch(i){case 0:r=-.5+s,a=-.5;break;case 1:r=.5,a=-.5+s;break;case 2:r=.5-s,a=.5;break;case 3:r=-.5,a=.5-s}e.push({x:.5+.8*r,y:.5+.8*a})}return e}(),shadow:{type:"none"}},triangle:{points:function(){const e=[],t=[{x:0,y:-.5},{x:-.433,y:.25},{x:.433,y:.25}],i=[Math.sqrt(Math.pow(t[1].x-t[0].x,2)+Math.pow(t[1].y-t[0].y,2)),Math.sqrt(Math.pow(t[2].x-t[1].x,2)+Math.pow(t[2].y-t[1].y,2)),Math.sqrt(Math.pow(t[0].x-t[2].x,2)+Math.pow(t[0].y-t[2].y,2))],n=i[0]+i[1]+i[2],s=i.map(e=>Math.round(64*e/n)),r=s.reduce((e,t)=>e+t,0);r<64&&(s[0]+=64-r);for(let i=0;i<3;i++){const n=t[i],r=t[(i+1)%3],a=s[i];for(let t=0;t<a;t++){if(t===a-1&&i<2)continue;const s=t/a,o=n.x+(r.x-n.x)*s,c=n.y+(r.y-n.y)*s;e.push({x:.5+.9*o,y:.5+.9*c})}}for(;e.length<64;)e.push(e[e.length-1]);for(;e.length>64;)e.pop();return e}(),shadow:{type:"none"}},solar:{points:Wm(64,12),shadow:{type:"solar-hybrid",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3,lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"}}}};const Um=new class{constructor(){this.shapeCache=new Map,this.morphCache=new Map,this.propertyCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const e=Object.keys(Nm);e.forEach(e=>{this.cacheShape(e)}),this.cacheCommonMorphs(e),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.shapeCache.size}catch(e){console.error("[ShapeCache] Initialization failed:",e),this.isInitialized=!1}}cacheShape(e){try{const t=Nm[e];if(t){this.shapeCache.set(e,t);const i={pointCount:t.points?.length||64,hasShadow:"none"!==t.shadow?.type,shadowType:t.shadow?.type||"none",isRadial:this.isRadialShape(e),bounds:this.calculateBounds(t.points)};this.propertyCache.set(e,i)}}catch(t){console.warn(`[ShapeCache] Failed to cache shape '${e}':`,t)}}cacheCommonMorphs(e){[["circle","heart"],["circle","star"],["circle","square"],["heart","star"],["star","circle"],["square","circle"],["triangle","circle"],["moon","sun"],["lunar","eclipse"]].forEach(([t,i])=>{if(e.includes(t)&&e.includes(i))try{const e=this.calculateMorphSteps(t,i),n=`${t}->${i}`;this.morphCache.set(n,e)}catch(e){console.warn(`[ShapeCache] Failed to cache morph '${t}->${i}':`,e)}})}calculateMorphSteps(e,t){const i=this.shapeCache.get(e),n=this.shapeCache.get(t);if(!i||!n)return null;const s=[];for(let e=0;e<5;e++){const t=e/4,r=this.interpolateShapePoints(i.points,n.points,t);s.push({progress:t,points:r})}return{from:e,to:t,steps:s,isRadial:this.isRadialShape(e)||this.isRadialShape(t)}}interpolateShapePoints(e,t,i){if(!e||!t)return e||t||[];const n=Math.max(e.length,t.length),s=[];for(let r=0;r<n;r++){const n=e[r]||e[0]||{x:.5,y:.5},a=t[r]||t[0]||{x:.5,y:.5};s.push({x:n.x+(a.x-n.x)*i,y:n.y+(a.y-n.y)*i})}return s}isRadialShape(e){return["circle","star","square","triangle","sun","moon"].includes(e)}calculateBounds(e){if(!e||0===e.length)return{minX:0,minY:0,maxX:1,maxY:1,width:1,height:1};let t=1/0,i=1/0,n=-1/0,s=-1/0;return e.forEach(e=>{t=Math.min(t,e.x),i=Math.min(i,e.y),n=Math.max(n,e.x),s=Math.max(s,e.y)}),{minX:t,minY:i,maxX:n,maxY:s,width:n-t,height:s-i}}getShape(e){if(!this.isInitialized)return console.warn("[ShapeCache] Cache not initialized, falling back to direct access"),Nm[e]||null;const t=this.shapeCache.get(e);return t?(this.stats.hits++,t):(this.stats.misses++,console.warn(`[ShapeCache] Cache miss for shape '${e}', consider adding to pre-cache`),Nm[e]||null)}getProperties(e){if(!this.isInitialized){const t=Nm[e];return t?{pointCount:t.points?.length||64,hasShadow:"none"!==t.shadow?.type,shadowType:t.shadow?.type||"none",isRadial:this.isRadialShape(e),bounds:this.calculateBounds(t.points)}:{}}const t=this.propertyCache.get(e);return t?(this.stats.hits++,t):(this.stats.misses++,{})}getMorph(e,t){if(!this.isInitialized)return this.calculateMorphSteps(e,t);const i=`${e}->${t}`,n=this.morphCache.get(i);return n?(this.stats.hits++,n):(this.stats.misses++,this.calculateMorphSteps(e,t))}hasShape(e){return this.shapeCache.has(e)}getStats(){const e=this.stats.hits+this.stats.misses;return{...this.stats,hitRate:e>0?`${(this.stats.hits/e*100).toFixed(1)}%`:"0%",shapes:this.shapeCache.size,morphs:this.morphCache.size,properties:this.propertyCache.size}}clear(){this.shapeCache.clear(),this.morphCache.clear(),this.propertyCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1}},Vm=new class{constructor(){this.pools=new Map,this.inUse=new Set}acquire(e,t="array"){const i=`${t}_${e}`;this.pools.has(i)||this.pools.set(i,[]);const n=this.pools.get(i);if(n.length>0){const e=n.pop();return this.inUse.add(e),e}let s;switch(t){case"float32":s=new Float32Array(e);break;case"uint8":s=new Uint8Array(e);break;default:s=new Array(e).fill(0)}return this.inUse.add(s),s}release(e){if(!this.inUse.has(e))return;this.inUse.delete(e);let t="array";e instanceof Float32Array?t="float32":e instanceof Uint8Array&&(t="uint8");const i=`${t}_${e.length}`;e.fill(0),this.pools.has(i)||this.pools.set(i,[]);const n=this.pools.get(i);n.length<10&&n.push(e)}clear(){this.pools.clear(),this.inUse.clear()}};class Ym{constructor(e){this.morpher=e,this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.bassEnergy=0,this.vocalPresence=0,this.highFreqEnergy=0,this.transientActive=!1,this.transientStrength=0,this.transientDecay=.92,this.transientHoldTime=8,this.transientHoldCounter=0}applyAudioDeformation(e){if(!e||0===e.length)return this.morpher.generateFallbackCircle();if(this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.currentFrequencies&&this.morpher.audioAnalyzer.currentFrequencies.length>0){this.morpher.frequencyData=[...this.morpher.audioAnalyzer.currentFrequencies];let e=0,t=0;for(let i=0;i<=2&&i<this.morpher.frequencyData.length;i++)e+=this.morpher.frequencyData[i],t++;t>0&&(e/=t),this.morpher.bassPeakHistory||(this.morpher.bassPeakHistory=[],this.morpher.bassThumpTimer=0),this.morpher.bassPeakHistory.push(e),this.morpher.bassPeakHistory.length>20&&this.morpher.bassPeakHistory.shift();const i=this.morpher.bassPeakHistory.reduce((e,t)=>e+t,0)/this.morpher.bassPeakHistory.length,n=this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.microphoneStream;if(e>1.08*i&&e>(n?.15:.25)){const t=n?8:6;this.bassEnergy=Math.min(1,(e-i)*t),this.morpher.bassThumpTimer=12}else this.morpher.bassThumpTimer>0?(this.morpher.bassThumpTimer--,this.bassEnergy*=.9):this.bassEnergy=0;this.morpher.spectralHistory||(this.morpher.spectralHistory=[],this.morpher.spectralFluxHistory=[],this.morpher.onsetThreshold=0,this.morpher.musicDetector.reset(),this.morpher.detectedBPM=0,this.morpher.onsetStrengths=[],this.morpher.detectedTimeSignature=null,this.morpher.timeSignatureConfidence=0,this.morpher.measureStartTime=0,this.morpher.timeSignatureHistory=[],this.morpher.timeSignatureLocked=!1);const s=[...this.morpher.frequencyData];let r=0,a=0;if(this.morpher.spectralHistory.length>0){const e=this.morpher.spectralHistory[this.morpher.spectralHistory.length-1];for(let t=0;t<=2&&t<s.length;t++){const i=s[t]-e[t];i>0&&(a+=i)}for(let t=4;t<=15&&t<s.length;t++){const i=s[t]-e[t];i>0&&(r+=i*(t>=9&&t<=13?2:1))}a>.15&&(r*=.3)}if(this.morpher.spectralHistory.push(s),this.morpher.spectralHistory.length>30&&this.morpher.spectralHistory.shift(),this.morpher.spectralFluxHistory.push(r),this.morpher.spectralFluxHistory.length>30&&this.morpher.spectralFluxHistory.shift(),this.morpher.spectralFluxHistory.length>=10){const e=[...this.morpher.spectralFluxHistory].sort((e,t)=>e-t),t=e[Math.floor(e.length/2)],i=e.reduce((e,t)=>e+t,0)/e.length;this.morpher.onsetThreshold=t+.5*(i-t)}const o=r>1.2*this.morpher.onsetThreshold&&r>.02,c=r>2*this.morpher.onsetThreshold&&r>.05;if(o&&(this.transientHoldTime=8,this.morpher.vocalGlowBoost=.3),c){const e=performance.now(),t={time:e,strength:r/(this.morpher.onsetThreshold||1),bassWeight:a};this.morpher.onsetStrengths.push(t),this.morpher.onsetStrengths.length>40&&this.morpher.onsetStrengths.shift(),this.morpher.musicDetector.addOnset(e,r)}this.morpher.musicDetector.update(performance.now()),this.morpher.detectedBPM=this.morpher.musicDetector.detectedBPM,this.morpher.bpmConfidence=this.morpher.musicDetector.bpmConfidence,this.morpher.detectedBPM>0&&this.morpher.bpmConfidence>.8&&this.morpher.forceFastDetection&&(this.morpher.forceFastDetection=!1),this.transientHoldTime>0&&this.transientHoldTime--,this.morpher.vocalGlowBoost>0&&(this.morpher.vocalGlowBoost*=.92),this.vocalPresence=r,this.morpher.bassHistory[this.morpher.historyIndex]=this.bassEnergy,this.morpher.vocalHistory[this.morpher.historyIndex]=this.vocalPresence,this.morpher.historyIndex=(this.morpher.historyIndex+1)%this.morpher.bassHistory.length,this.morpher.bassEffectActive=this.morpher.bassThumpTimer>0,this.morpher.lastVocalPresence=this.morpher.lastVocalPresence||0,this.morpher.lastVocalPresence=this.vocalPresence,this.vocalEffectActive=this.transientHoldTime>0}const t=this.morpher.frequencyData&&this.morpher.frequencyData.some(e=>e>.01);if(this.morpher.audioAnalyzer&&t||(this.audioDeformation>.15?(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.min(1,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)):this.morpher.bassThumpTimer>0&&(this.morpher.bassThumpTimer--,this.bassEnergy*=.9),this.vocalEnergy>.2&&(this.vocalEffectActive=!0,this.vocalPresence=this.vocalEnergy)),!t&&this.audioDeformation>.15&&!this.morpher.bassEffectActive&&(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.max(this.bassEnergy,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)),!(0!==this.audioDeformation||this.bassEnergy>.01||this.vocalPresence>.01))return e;const i=[];if(this.morpher.bassEffectActive&&(Math.random()<.05&&(this.morpher.undulationDirection*=-1),this.morpher.undulationPhase+=.08*this.morpher.undulationDirection),this.morpher.audioAnalyzer&&this.beatGlitchIntensity>0&&(this.beatGlitchIntensity*=.9),this.vocalEffectActive&&Math.random()<.2){this.glitchPoints=[];const t=2+Math.floor(2*Math.random());for(let i=0;i<t;i++)this.glitchPoints.push({index:Math.floor(Math.random()*e.length),intensity:.02+.03*Math.random(),decay:.94+.02*Math.random()})}this.glitchPoints=this.glitchPoints.filter(e=>(e.intensity*=e.decay,e.intensity>.01));for(let t=0;t<e.length;t++){const n=e[t];if(!n||void 0===n.x||void 0===n.y){const n=t/e.length*Math.PI*2;i.push({x:.5+.5*Math.cos(n),y:.5+.5*Math.sin(n)});continue}const s=n.x-.5,r=n.y-.5,a=Math.sqrt(s*s+r*r),o=Math.atan2(r,s),c=.12*Math.abs(this.audioDeformation);let l=0,h=0;if(this.morpher.bassEffectActive){const e=2,t=.25*this.bassEnergy;l=Math.sin(o*e+this.morpher.undulationPhase)*t,h=Math.sin(.5*this.morpher.undulationPhase)*this.bassEnergy*.08}let u=0;const d=this.glitchPoints.find(e=>e.index===t);if(d){const e=.015*Date.now(),i=Math.sin(e+.5*t)*Math.cos(.7*e);u=d.intensity*i*.5}const p=1+c+l+h+u,m=a*Math.max(.8,p);i.push({x:.5+Math.cos(o)*m,y:.5+Math.sin(o)*m})}return i}setAudioDeformation(e){this.audioDeformation=Math.max(0,Math.min(1,e)),this.vocalEffectActive=e>.01}setVocalEnergy(e){this.vocalEnergy=Math.max(0,Math.min(1,e)),this.vocalEffectActive=e>.01}updateFrequencyBands(e){e&&(this.bassEnergy=e.bass||0,this.vocalPresence=e.vocal||0,this.highFreqEnergy=e.high||0)}processTransient(e,t){e>t?(this.transientActive=!0,this.transientStrength=e,this.transientHoldCounter=this.transientHoldTime):this.transientHoldCounter>0?this.transientHoldCounter--:(this.transientStrength*=this.transientDecay,this.transientStrength<.01&&(this.transientActive=!1))}getState(){return{audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy,vocalEffectActive:this.vocalEffectActive,beatGlitchIntensity:this.beatGlitchIntensity,transientActive:this.transientActive,transientStrength:this.transientStrength}}reset(){this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.transientActive=!1,this.transientStrength=0}}class Xm{constructor(){this.agents=[],this.maxAgents=8,this.isActive=!1,this.confidence=0,this.lockedBPM=0,this.lastBeatTime=0,this.peakHistory=[],this.maxHistoryLength=100,this.minBPM=40,this.maxBPM=300,this.convergenceThreshold=.7,this.subdivisionPreference={slow:{min:40,max:80,prefer:1},normal:{min:80,max:140,prefer:1},fast:{min:140,max:180,prefer:.5},veryfast:{min:180,max:300,prefer:.5}}}createAgent(e,t=1){return{bpm:e,subdivision:t,effectiveBPM:e*t,phase:0,confidence:.5,hits:0,misses:0,lastBeatTime:performance.now(),beatInterval:6e4/(e*t)}}initializeAgents(e=120){this.agents=[];let t=[1];t=e>180||e>140?[.5,.75,1]:e<60?[1,1.5,2]:[.5,1,1.5],t.forEach(t=>{const i=this.createAgent(e,t);e*t<140&&(i.confidence=.6),this.agents.push(i)}),e>140&&(this.agents.push(this.createAgent(e/2,1)),this.agents.push(this.createAgent(e/2,1.5)))}processPeak(e,t=performance.now()){if(this.peakHistory.push({strength:e,time:t}),this.peakHistory.length>this.maxHistoryLength&&this.peakHistory.shift(),!(this.peakHistory.length<4)){if(!this.isActive||0===this.agents.length){const e=this.getFFTEstimate();this.initializeAgents(e),this.isActive=!0}this.lockedBPM>0&&this.confidence>.7?(this.agents.forEach(i=>{this.scoreAgent(i,t,e)}),this.confidence<.6&&(this.evolveAgents(),this.checkConvergence())):(this.agents.forEach(i=>{this.scoreAgent(i,t,e)}),this.evolveAgents(),this.checkConvergence())}}scoreAgent(e,t,i){const n=t-e.lastBeatTime,s=e.beatInterval,r=1-2*Math.abs(n%s/s-.5);r>.7?(e.hits++,e.confidence=Math.min(1,e.confidence+.1),r>.85&&(e.lastBeatTime=t)):r<.3&&(e.misses++,e.confidence=Math.max(0,e.confidence-.03)),e.confidence*=.998}evolveAgents(){this.agents.sort((e,t)=>t.confidence-e.confidence),this.agents.length>this.maxAgents&&(this.agents=this.agents.slice(0,this.maxAgents));const e=this.agents[0];if(e.confidence>.7&&this.agents.length<this.maxAgents){const t=1+.02*(Math.random()-.5),i=this.createAgent(e.bpm*t,e.subdivision);i.confidence=.8*e.confidence,this.agents.push(i)}this.agents=this.agents.filter(e=>e.confidence>.1)}checkConvergence(){if(0===this.agents.length)return;const e=this.agents[0];return e.confidence>this.convergenceThreshold&&this.agents.filter(t=>Math.abs(t.effectiveBPM-e.effectiveBPM)/e.effectiveBPM<.05).length>=Math.min(2,.3*this.agents.length)&&(this.lockedBPM=Math.round(e.bpm),this.confidence=e.confidence,this.autoSelectSubdivision(),!0)}autoSelectSubdivision(){for(const[,e]of Object.entries(this.subdivisionPreference))if(this.lockedBPM>=e.min&&this.lockedBPM<e.max&&this.agents.find(t=>Math.abs(t.bpm-this.lockedBPM)<2&&Math.abs(t.subdivision-e.prefer)<.1))return e.prefer;return 1}getFFTEstimate(){if(this.peakHistory.length<4)return 120;const e=this.peakHistory.slice(-10),t=[];for(let i=1;i<e.length;i++)t.push(e[i].time-e[i-1].time);if(0===t.length)return 120;t.sort((e,t)=>e-t);let i=6e4/t[Math.floor(t.length/2)];return i<this.minBPM?i*=2:i>this.maxBPM&&(i/=2),Math.max(this.minBPM,Math.min(this.maxBPM,i))}reset(e=null){this.agents=[],this.confidence=0,this.lockedBPM=0,this.peakHistory=[],e&&this.initializeAgents(e)}getBPM(){return this.lockedBPM>0&&this.confidence>.8?this.lockedBPM:this.agents.length>0?Math.round(this.agents[0].bpm):0}getSubdivision(){if(this.agents.length>0){const e=this.agents[0],{bpm:t}=e;for(const[,e]of Object.entries(this.subdivisionPreference))if(t>=e.min&&t<e.max)return e.prefer;return e.subdivision}return 1}getStatus(){return{bpm:this.getBPM(),subdivision:this.getSubdivision(),confidence:this.confidence,locked:this.lockedBPM>0&&this.confidence>.8,agentCount:this.agents.length,topAgents:this.agents.slice(0,3).map(e=>({bpm:Math.round(e.bpm),subdivision:e.subdivision,confidence:e.confidence.toFixed(2)}))}}}class Qm{constructor(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.onsetThreshold=.3,this.detectedBPM=0,this.bpmConfidence=0,this.lastBPMCalculation=0,this.bpmCalculationInterval=2e3,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.agentDetector=new Xm,this.useAgentDetection=!0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.downbeatPhase=0,this.measureLength=4,this.measureStartTime=0,this.isMusicalContent=!1,this.musicalityScore=0,this.forceFastDetection=!1}calculateBPM(){if(this.useAgentDetection){const e=this.agentDetector.getStatus();if(e.locked&&e.confidence>.6)return this.detectedBPM=e.bpm,this.bpmConfidence=e.confidence,this.tempoLocked=!0,this.fundamentalBPM=e.bpm,this.bpmHistory.push(this.detectedBPM),this.bpmHistory.length>10&&this.bpmHistory.shift(),this.detectedBPM;if(e.bpm>0&&e.confidence>.4)return this.detectedBPM=e.bpm,this.bpmConfidence=e.confidence,e.confidence>.6&&(this.tempoLocked=!0),this.detectedBPM}if(this.onsetIntervals.length<4)return this.detectedBPM;const e=this.onsetIntervals.slice(-15),t=this.findTempoCandidates(e);if(0===t.length)return this.detectedBPM;const i=t[0],n=Math.round(6e4/i.interval);if(!this.tempoLocked&&this.bpmHistory.length>3){const e=this.bpmHistory.slice(-3),t=e.reduce((e,t)=>e+t,0)/e.length;e.reduce((e,i)=>e+Math.pow(i-t,2),0)/e.length<5&&(this.fundamentalBPM=Math.round(t),this.tempoLocked=!0,this.bpmConfidence=1)}let s=n;if(this.tempoLocked&&(this.checkHarmonicRelation(n,this.fundamentalBPM)?(s=this.fundamentalBPM,this.bpmConfidence=Math.min(1,this.bpmConfidence+.1)):(this.bpmConfidence*=.9,this.bpmConfidence<.3&&i.strength>.8?(this.fundamentalBPM=n,this.bpmConfidence=.5):s=this.fundamentalBPM)),this.bpmHistory.push(s),this.bpmHistory.length>10&&this.bpmHistory.shift(),0===this.detectedBPM)this.detectedBPM=s;else{const e=this.tempoLocked?1:2,t=s-this.detectedBPM;Math.abs(t)<=e?this.detectedBPM=s:this.detectedBPM+=Math.sign(t)*e}return window.rhythmIntegration&&window.rhythmIntegration.updateBPM&&(window.rhythmManuallyStoppedForCurrentAudio||window.rhythmIntegration.updateBPM(this.detectedBPM)),this.detectedBPM}findTempoCandidates(e){const t=[];for(const i of[1,2,4]){const n=e.map(e=>e*i),s=this.clusterIntervals(n);for(const n of s){const s=n.intervals.reduce((e,t)=>e+t,0)/n.intervals.length/i,r=n.intervals.length/e.length*n.consistency,a=6e4/s,o=a>=120&&a<=140?.2:0;a>=60&&a<=220&&t.push({interval:s,strength:r+o,multiplier:i})}}return t.sort((e,t)=>t.strength-e.strength)}clusterIntervals(e){const t=[...e].sort((e,t)=>e-t),i=[];let n=[t[0]];for(let e=1;e<t.length;e++){const s=.03*n[0];if(t[e]-n[0]<=s)n.push(t[e]);else{if(n.length>=2){const e=n.reduce((e,t)=>e+t,0)/n.length,t=1/(1+n.reduce((t,i)=>t+Math.pow(i-e,2),0)/n.length/(e*e));i.push({intervals:n,consistency:t})}n=[t[e]]}}if(n.length>=3){const e=n.reduce((e,t)=>e+t,0)/n.length,t=1/(1+n.reduce((t,i)=>t+Math.pow(i-e,2),0)/n.length/(e*e));i.push({intervals:n,consistency:t})}return i}checkHarmonicRelation(e,t){const i=Math.max(e,t)/Math.min(e,t);return[2,1.5,1.333,1.25].some(e=>Math.abs(i-e)<.03)}detectTimeSignature(){const e=this.forceFastDetection?6:12;if(0===this.detectedBPM||this.onsetStrengths.length<e)return this.timeSignature;if(this.timeSignatureLocked&&!this.forceFastDetection)return this.detectedTimeSignature||this.timeSignature;const t=6e4/this.detectedBPM,i=new Array(4).fill(0).map(()=>({strength:0,bassWeight:0,count:0})),n=this.onsetStrengths.slice(-Math.min(20,this.onsetStrengths.length));if(0===n.length)return this.timeSignature;const s=n[0].time;for(const e of n){const n=(e.time-s)/t%4,r=Math.round(n)%4;i[r].strength+=e.strength,i[r].bassWeight+=e.bassWeight||0,i[r].count++}let r=0;for(const e of i)e.count>0&&(e.strength/=e.count,e.bassWeight/=e.count,r=Math.max(r,e.strength+e.bassWeight));let a="4/4";i[0].strength>2*i[1].strength&&i[0].strength>2*i[2].strength&&i[3].count<.5*i[0].count&&this.testWaltzPattern(n,t)>.8&&(a="3/4"),this.timeSignatureHistory.push(a),this.timeSignatureHistory.length>3&&this.timeSignatureHistory.shift();const o=this.forceFastDetection?2:3;if(this.timeSignatureHistory.length>=o){const e={};for(const t of this.timeSignatureHistory)e[t]=(e[t]||0)+1;let t="4/4",i=0;for(const[n,s]of Object.entries(e))s>i&&(i=s,t=n);if(i>=2){this.detectedTimeSignature=t,this.timeSignatureLocked=!0,this.timeSignatureConfidence=i/3,window.rhythmIntegration&&window.rhythmIntegration.setTimeSignature&&window.rhythmIntegration.setTimeSignature(this.detectedTimeSignature);const e=document.getElementById("time-sig-display");e&&(e.textContent=this.detectedTimeSignature)}}return this.detectedTimeSignature||this.timeSignature}testWaltzPattern(e,t){let i=0,n=0;for(let t=0;t<e.length-2;t+=3)if(t+2<e.length){n++;const s=e[t].strength+(e[t].bassWeight||0),r=e[t+1].strength+(e[t+1].bassWeight||0),a=e[t+2].strength+(e[t+2].bassWeight||0);s>1.5*r&&s>1.5*a&&i++}return n>0?i/n:0}addOnset(e,t,i=0){if(this.useAgentDetection&&this.agentDetector.processPeak(t,e),this.lastOnsetTime>0){const t=e-this.lastOnsetTime;t>273&&t<1e3&&(this.onsetIntervals.push(t),this.onsetIntervals.length>20&&this.onsetIntervals.shift())}this.onsetStrengths.push({time:e,strength:t,bassWeight:i}),this.onsetStrengths.length>40&&this.onsetStrengths.shift(),this.lastOnsetTime=e}update(e){e-this.lastBPMCalculation>this.bpmCalculationInterval&&(this.calculateBPM(),this.detectTimeSignature(),this.lastBPMCalculation=e)}getRecommendedSubdivision(){return this.useAgentDetection?this.agentDetector.getSubdivision():this.detectedBPM<60?2:this.detectedBPM<80?1:this.detectedBPM>180||this.detectedBPM>140?.5:1}reset(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.detectedBPM=0,this.bpmConfidence=0,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.agentDetector&&this.agentDetector.reset(),this.timeSignatureLocked=!1,this.isMusicalContent=!1,this.forceFastDetection=!1}getMusicInfo(){return{bpm:this.detectedBPM,confidence:this.bpmConfidence,timeSignature:this.timeSignature,isMusical:this.isMusicalContent,musicalityScore:this.musicalityScore}}}class Jm{constructor(e){this.morpher=e,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=800,this.transitionProgress=0,this.easingFunction="easeInOutQuad",this.currentShape="circle",this.targetShape=null,this.previousShape=null,this.morphQueue=[],this.maxQueueSize=3,this.shadowConfig=null,this.shadowProgress=0}startTransition(e,t={}){this.isTransitioning&&this.morphQueue.length<this.maxQueueSize?this.morphQueue.push({shape:e,options:t}):(this.previousShape=this.currentShape,this.targetShape=e,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.transitionDuration=t.duration||800,this.easingFunction=t.easing||"easeInOutQuad",this.transitionProgress=0,this.shadowConfig=this.getTransitionConfig(this.currentShape,e))}update(e){if(!this.isTransitioning)return;const t=performance.now()-this.transitionStartTime,i=Math.min(1,t/this.transitionDuration);this.transitionProgress=this.applyEasing(i),this.shadowConfig&&(this.shadowProgress=this.calculateShadowProgress(i)),i>=1&&this.completeTransition()}completeTransition(){if(this.currentShape=this.targetShape,this.targetShape=null,this.isTransitioning=!1,this.transitionProgress=0,this.shadowConfig=null,this.morphQueue.length>0){const e=this.morphQueue.shift();this.startTransition(e.shape,e.options)}}getTransitionConfig(e,t){return{"circle-heart":{type:"bloom",shadowColor:"#ff69b4",shadowIntensity:.3},"heart-circle":{type:"contract",shadowColor:"#ff69b4",shadowIntensity:.2},"circle-star":{type:"burst",shadowColor:"#ffd700",shadowIntensity:.4},"star-circle":{type:"collapse",shadowColor:"#ffd700",shadowIntensity:.3}}[`${e}-${t}`]||null}calculateShadowProgress(e){if(!this.shadowConfig)return 0;switch(this.shadowConfig.type){case"bloom":return e<.5?2*e:2-2*e;case"burst":return Math.pow(1-e,2);case"contract":case"collapse":return Math.sin(e*Math.PI);default:return 0}}applyEasing(e){switch(this.easingFunction){case"linear":default:return e;case"easeInQuad":return e*e;case"easeOutQuad":return e*(2-e);case"easeInOutQuad":return e<.5?2*e*e:(4-2*e)*e-1;case"easeInCubic":return e*e*e;case"easeOutCubic":return--e*e*e+1;case"easeInOutCubic":return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}}clearQueue(){this.morphQueue=[]}hasQueuedMorphs(){return this.morphQueue.length>0}getState(){return{isTransitioning:this.isTransitioning,currentShape:this.currentShape,targetShape:this.targetShape,progress:this.transitionProgress,queueLength:this.morphQueue.length}}reset(){this.isTransitioning=!1,this.currentShape="circle",this.targetShape=null,this.transitionProgress=0,this.morphQueue=[],this.shadowConfig=null}}class Km{constructor(e){this._getMorpherState=e}getCurrentShadow(){const e=this._getMorpherState(),t=e.currentShape||"circle",i=Um&&Um.isInitialized?Um.getShape(t):Nm[t],n=e.targetShape?Um&&Um.isInitialized?Um.getShape(e.targetShape):Nm[e.targetShape]:null,s=i?.shadow||{type:"none"},r=n?.shadow||null;if(!e.isTransitioning||!r)return s;const a=e.morphProgress;if(e.transitionConfig&&"from_moon"===e.transitionConfig.type&&e.transitionConfig.slideOutCrescent)return this._calculateMoonSlideOut(a,e.transitionConfig);if(e.transitionConfig&&"moon_to_lunar"===e.transitionConfig.type)return this._calculateMoonToLunar(a,e.transitionConfig);if(e.transitionConfig&&"eclipse_enter_lunar"===e.transitionConfig.type)return this._calculateEclipseEnterLunar(a,e.transitionConfig);if(e.transitionConfig&&"lunar_to_moon"===e.transitionConfig.type)return this._calculateLunarToMoon(a,e.transitionConfig);if(e.transitionConfig&&"eclipse_exit_lunar"===e.transitionConfig.type)return this._calculateEclipseExitLunar(a,e.transitionConfig);if(e.transitionConfig&&"eclipse_enter"===e.transitionConfig.type)return this._calculateEclipseEnter(a,r);if("eclipse_exit"===e.transitionConfig.type)return this._calculateEclipseExit(a,s);if("sun_fade"===e.transitionConfig.type)return this._calculateSunFade(a,s);if("sun_bloom"===e.transitionConfig.type)return this._calculateSunBloom(a,r);if("none"!==s.type||"none"!==r.type){const e=(s.coverage||0)+((r.coverage||0)-(s.coverage||0))*a;return{type:"none"!==r.type?r.type:s.type,coverage:e,angle:r.angle||s.angle||0,softness:r.softness||s.softness||.2,progress:a}}return s}_calculateMoonSlideOut(e,t){const i=t.shadowSlideRatio||.4;if(e<i){const t=e/i,n=-30*Math.PI/180,s=.7,r=s+(2.5-s)*t;return{type:"crescent",coverage:t>.8?.85*(1-5*(t-.8)):.85,angle:-30,offset:r,shadowX:Math.cos(n)*r,shadowY:Math.sin(n)*r}}return{type:"none"}}_calculateMoonToLunar(e,t){const i=t.startAngle*Math.PI/180,n=1-e,s=.7*Math.cos(i)*n,r=.7*Math.sin(i)*n,a=Math.pow(e,2);if(e<.6)return{type:"crescent",coverage:.85*(1-.2*a),angle:t.startAngle,offset:.7*n,shadowX:s,shadowY:r};{const t=(e-.6)/.4,i=Math.sin(t*Math.PI/2);return{type:"lunar",coverage:.85+.1*i,color:`rgba(80, 20, 0, ${.7+.2*i})`,shadowX:s*(1-i),shadowY:r*(1-i),diffusion:i,shadowProgress:e}}}_calculateEclipseEnterLunar(e,t){if(e<.3)return{type:"none"};const i=(e-.3)/.7,n=Math.sin(i*Math.PI/2),s=t.startAngle*Math.PI/180,r=1-n,a=.7*Math.cos(s)*r,o=.7*Math.sin(s)*r;if(i<.7)return{type:"crescent",coverage:.85*Math.pow(i/.7,.5),angle:t.startAngle,offset:.7*r,shadowX:a,shadowY:o};{const e=(i-.7)/.3,t=Math.sin(e*Math.PI/2);return{type:"lunar",coverage:.85+.1*t,color:`rgba(80, 20, 0, ${.6+.3*t})`,shadowX:a*(1-t),shadowY:o*(1-t),diffusion:t,shadowProgress:i}}}_calculateLunarToMoon(e,t){const i=t.exitAngle*Math.PI/180,n=Math.sin(e*Math.PI/2),s=.7*Math.cos(i)*n,r=.7*Math.sin(i)*n;if(e<.6){const t=e/.6,i=Math.pow(t,.7);return{type:"lunar",coverage:.95-.1*i,color:`rgba(80, 20, 0, ${.9-.3*i})`,shadowX:.7*s,shadowY:.7*r,diffusion:1-i}}{const i=(e-.6)/.4;return{type:"crescent",coverage:.85*Math.sin(i*Math.PI/2)+.1,angle:t.exitAngle,offset:.7,shadowX:s,shadowY:r}}}_calculateEclipseExitLunar(e,t){if(e<.7){const i=e/.7,n=t.exitAngle*Math.PI/180;if(i<.4){const e=i/.4,t=1-e,s=.3*e;return{type:"lunar",coverage:.95-.1*e,color:`rgba(80, 20, 0, ${.9-.2*e})`,shadowX:.7*Math.cos(n)*s,shadowY:.7*Math.sin(n)*s,diffusion:t}}{const e=(i-.4)/.6,s=Math.pow(e,.8),r=.7*Math.cos(n)*s,a=.7*Math.sin(n)*s;return{type:"crescent",coverage:.85*(1-Math.pow(e,2)),angle:t.exitAngle,offset:.7*s,shadowX:r,shadowY:a}}}return{type:"none"}}_calculateEclipseEnter(e,t){return{...t,shadowX:1.5-1.5*e,shadowProgress:e}}_calculateEclipseExit(e,t){const i=1.5*-e;return{...t,coverage:t.coverage*(1-e),shadowX:i,shadowProgress:1-e}}_calculateSunFade(e,t){const i=1-e;return{...t,intensity:(t.intensity||1)*Math.pow(i,.7),corona:t.corona,coronaOpacity:i,flares:t.flares,flaresOpacity:Math.pow(i,1.5),texture:t.texture,textureOpacity:Math.pow(i,2),turbulence:(t.turbulence||.3)*i}}_calculateSunBloom(e,t){const i=e;return{...t,intensity:(t.intensity||1)*Math.pow(i,1.5),corona:t.corona,coronaOpacity:Math.pow(i,.8),flares:t.flares,flaresOpacity:i>.3?Math.pow((i-.3)/.7,.7):0,texture:t.texture,textureOpacity:i>.5?Math.pow((i-.5)/.5,2):0,turbulence:(t.turbulence||.3)*i}}}class Zm{constructor(e={}){this.numPoints=e.numPoints||64,this.morphDuration=e.morphDuration||1e3,this.easing=e.easing||"easeInOutCubic",this.transitionManager=new Jm(this),this.audioDeformer=new Ym(this),this.musicDetector=new Qm,this.shadowEffectManager=new Km(()=>({currentShape:this.currentShape,targetShape:this.targetShape,morphProgress:this.morphProgress,isTransitioning:this.isTransitioning,transitionConfig:this.transitionConfig})),this.currentShape="circle",this.targetShape=null,this.morphProgress=0,this.visualProgress=0,this.morphStartTime=null,this.isTransitioning=!1,this.queuedMorphTimeout=null,this.shapeCache=new Map,this.currentPoints=[],this.targetPoints=[],this.musicalDuration=null,this.onBeat=!1,this.audioDeformation=0,this.vocalEnergy=0,this.lastAudioUpdate=0,this.lastVocalUpdate=0,this.audioUpdateInterval=33,this.audioAnalyzer=null,this.frequencyData=Vm.acquire(32,"float32"),this.glitchPoints=[],this.undulationPhase=0,this.undulationDirection=1,this.beatGlitchIntensity=0,this.bassEnergy=0,this.vocalPresence=0,this.bassHistory=Vm.acquire(60,"float32"),this.vocalHistory=Vm.acquire(60,"float32"),this.historyIndex=0,this.bassEffectCooldown=0,this.vocalEffectCooldown=0,this.bassThresholdMultiplier=1.2,this.vocalThresholdMultiplier=1.1,this.bassEffectActive=!1,this.vocalEffectActive=!1,this.transientHoldTime=0,this.vocalGlowBoost=0,this.onComplete=null,this.onProgress=null,this.queuedMorph=null,this.currentPoints=this.getShapePoints("circle"),this.shapesLoaded=!0,this.prewarmCache()}prewarmCache(){["circle","heart","star","sun","moon","lunar","square","triangle"].forEach(e=>{(Um&&Um.isInitialized?Um.hasShape(e):Nm[e])&&this.getShapePoints(e)}),[0,.25,.5,.75,1].forEach(e=>{this.applyEasing(e)})}getShapePoints(e){if(!this.shapeCache.has(e)){const t=Um&&Um.isInitialized?Um.getShape(e):Nm[e];if(!t||!t.points){const t=Nm.circle.points;return this.shapeCache.set(e,t),t}const{points:i}=t;return this.shapeCache.set(e,i),i}return this.shapeCache.get(e)}morphTo(e,t={}){if(!this.shapesLoaded)return;if(e===this.currentShape&&!this.isTransitioning)return;if(this.isTransitioning&&!t.force)return this.queuedMorph={targetShape:e,options:t},"queued";this.isTransitioning&&t.force&&this.completeMorph(!0);const i=this.getTransitionConfig(this.currentShape,e);if(this.targetShape=e,this.targetPoints=this.getShapePoints(e),this.morphStartTime=Date.now(),this.isTransitioning=!0,this.morphProgress=0,this.visualProgress=0,"bar"===t.duration||"beat"===t.duration){const e=6e4/(j.bpm||120);"bar"===t.duration?this.morphDuration=4*e:this.morphDuration=e,this.musicalDuration=!0,this.onBeat=!1!==t.onBeat}else this.morphDuration=i?.duration||t.duration||1e3,this.musicalDuration=null,this.onBeat=!1;this.morphMode=t.mode||"smooth",this.transitionConfig=i,this.onComplete=t.onComplete,this.onProgress=t.onProgress}update(e){if(this.audioAnalyzer&&this.audioAnalyzer.isAnalyzing){const e=this.audioAnalyzer.getShapeMorpherData();if(e&&e.frequencies){let t=!1;for(let i=0;i<Math.min(e.frequencies.length,this.frequencyData.length);i++)this.frequencyData[i]=e.frequencies[i],e.frequencies[i]>0&&(t=!0);t&&!this._loggedAudioData&&(console.warn("ShapeMorpher: Receiving audio frequency data"),this._loggedAudioData=!0)}}if(this.musicDetector&&this.musicDetector.update(performance.now()),!this.isTransitioning||!this.targetShape)return;const t=Date.now()-this.morphStartTime;if(this.musicalDuration){const e=6e4/(j.bpm||120),t=this.morphDuration>2*e;this.morphDuration=t?4*e:e}let i=Math.min(t/this.morphDuration,1);if(this.musicalDuration&&this.onBeat){const e=j.bpm||120;let t;t=e>140?2:e>100?4:8;const n=6e4/e,s=this.morphDuration/n,r=i*s,a=Math.round(r*t)/t,o=Math.min(1,a/s),c=(.3+.5*(e<90?Math.max(.3,(e-60)/30):Math.max(.4,Math.min(1,1-(e-90)/90))))*(.3+.7*Math.sin(i*Math.PI));i+=c*c*(3-2*c)*(o-i)}this.morphProgress=this.applyEasing(i),this.visualProgress=.8*this.visualProgress+.2*this.morphProgress,Math.abs(this.visualProgress-this.morphProgress)<.001&&(this.visualProgress=this.morphProgress),this.onProgress&&this.onProgress(this.morphProgress),this.morphProgress>=1&&(this.visualProgress=1,this.completeMorph())}completeMorph(e=!1){if(this.targetShape&&(this.currentShape=this.targetShape,this.currentPoints=[...this.targetPoints]),this.targetShape=null,this.isTransitioning=!1,this.morphProgress=0,this.visualProgress=0,this.onComplete&&this.onComplete(this.currentShape),!e&&this.queuedMorph){const e=this.queuedMorph;this.queuedMorph=null,this.queuedMorphTimeout=setTimeout(()=>{this.morphTo(e.targetShape,e.options),this.queuedMorphTimeout=null},50)}}hasQueuedMorph(){return null!==this.queuedMorph}clearQueue(){this.queuedMorph=null,this.queuedMorphTimeout&&(clearTimeout(this.queuedMorphTimeout),this.queuedMorphTimeout=null)}getCanvasPoints(e,t,i){let n;try{n=this.getInterpolatedPoints()}catch{n=this.generateFallbackCircle()}this.canvasPointsCache||(this.canvasPointsCache=[]);const s=this.canvasPointsCache;if(s.length=0,!n||0===n.length){for(let n=0;n<this.numPoints;n++){const r=n/this.numPoints*Math.PI*2;s.push({x:e+Math.cos(r)*i,y:t+Math.sin(r)*i})}return s}const r=Array.isArray(n)?n:[];for(let n=0;n<r.length;n++){const a=r[n];if(a&&"number"==typeof a.x&&"number"==typeof a.y){const n=e+(a.x-.5)*i*2,r=t+(a.y-.5)*i*2;s.push({x:n,y:r})}else{const a=n/r.length*Math.PI*2;s.push({x:e+Math.cos(a)*i,y:t+Math.sin(a)*i})}}for(;s.length<this.numPoints;){const n=s.length/this.numPoints*Math.PI*2;s.push({x:e+Math.cos(n)*i,y:t+Math.sin(n)*i})}return s}getInterpolatedPoints(){if(this.currentPoints&&0!==this.currentPoints.length||(this.currentPoints=this.generateFallbackCircle()),!this.isTransitioning)return this.applyAudioDeformation(this.currentPoints);const e=[];for(let t=0;t<this.numPoints;t++){const i=this.currentPoints[t],n=this.targetPoints[t];if(!i||!n){const i=t/this.numPoints*Math.PI*2;e.push({x:.5+.5*Math.cos(i),y:.5+.5*Math.sin(i)});continue}const s=this.visualProgress;let r,a;const o=["square","circle","star","triangle"],c=o.includes(this.currentShape),l=o.includes(this.targetShape);if(c||l){const e=.5,t=.5;if(l&&!c){const o=n.x-e,c=n.y-t;if(s<.3){const n=s/.3;r=i.x+(e-i.x)*n,a=i.y+(t-i.y)*n}else{const i=(s-.3)/.7;r=e+o*i,a=t+c*i}}else if(c&&!l){const o=i.x-e,c=i.y-t;if(s<.5){const e=s/.5;r=i.x-o*e,a=i.y-c*e}else{const i=(s-.5)/.5;r=e+(n.x-e)*i,a=t+(n.y-t)*i}}else{const o=i.x-e,c=i.y-t,l=n.x-e,h=n.y-t;if(s<.5){const e=s/.5;r=i.x-o*e,a=i.y-c*e}else{const i=(s-.5)/.5;r=e+l*i,a=t+h*i}}}else if("spiral"===this.morphMode){const e=s*Math.PI*2,o=.02*Math.sin(e+.2*t)*(1-2*Math.abs(s-.5));r=i.x+(n.x-i.x)*s+o,a=i.y+(n.y-i.y)*s+o}else if("wave"===this.morphMode){const e=.01*Math.sin(.3*t+s*Math.PI*4);r=i.x+(n.x-i.x)*s+e,a=i.y+(n.y-i.y)*s+e}else r=i.x+(n.x-i.x)*s,a=i.y+(n.y-i.y)*s;e.push({x:r,y:a})}return this.applyAudioDeformation(e)}applyAudioDeformation(e){return this.audioDeformer.applyAudioDeformation(e)}setAudioDeformation(e){const t=Date.now();t-this.lastAudioUpdate>this.audioUpdateInterval&&(this.audioDeformation=Math.max(-1,Math.min(1,e)),this.lastAudioUpdate=t,this.audioDeformer&&this.audioDeformer.setAudioDeformation(Math.abs(this.audioDeformation)))}setVocalEnergy(e){const t=Date.now();t-this.lastVocalUpdate>this.audioUpdateInterval&&(this.vocalEnergy=Math.max(0,Math.min(1,e)),this.lastVocalUpdate=t,this.audioDeformer&&this.audioDeformer.setVocalEnergy(this.vocalEnergy))}getTransitionConfig(e,t){const i=Um&&Um.isInitialized?Um.getShape(e):Nm[e],n=Um&&Um.isInitialized?Um.getShape(t):Nm[t];return"moon"===t?{type:"to_moon",easing:"easeInOutCubic",duration:1500,glowIntensity:1.5,fadeInCrescent:!0}:"moon"===e&&"lunar"===t?{type:"moon_to_lunar",easing:"easeInOutSine",duration:2e3,slideOutCrescent:!1,description:"Crescent shadow moves to center and becomes lunar eclipse"}:"moon"===e?{type:"from_moon",easing:"easeInOutCubic",duration:1e3,slideOutCrescent:!0,shadowSlideRatio:.4,description:"Moon shadow slides away THEN morphs to target"}:"lunar"===t?{type:"eclipse_enter_lunar",startAngle:-30}:"lunar"===e&&"moon"===t?{type:"lunar_to_moon",exitAngle:-30}:"lunar"===e?{type:"eclipse_exit_lunar",exitAngle:-30}:"none"===i?.shadow?.type&&"solar"===n?.shadow?.type?{type:"eclipse_enter",direction:"right"}:"solar"===i?.shadow?.type&&"none"===n?.shadow?.type?{type:"eclipse_exit",direction:"left"}:"sun"===e&&"sun"!==t?{type:"sun_fade",fadeEffects:!0}:"sun"!==e&&"sun"===t?{type:"sun_bloom",bloomEffects:!0}:{type:"standard"}}getCurrentShadow(){return this.shadowEffectManager.getCurrentShadow()}getCurrentRenderer(){return null}applyEasing(e){switch(this.transitionConfig?.easing||this.easing||"linear"){case"linear":return e;case"easeInQuad":return e*e;case"easeOutQuad":return e*(2-e);case"easeInOutQuad":return e<.5?2*e*e:(4-2*e)*e-1;case"easeInOutSine":return-(Math.cos(Math.PI*e)-1)/2;default:return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}}calculateBPM(){return this.musicDetector.calculateBPM()}findTempoCandidates(e){return this.musicDetector.findTempoCandidates(e)}clusterIntervals(e){return this.musicDetector.clusterIntervals(e)}checkHarmonicRelation(e,t){return this.musicDetector.checkHarmonicRelation(e,t)}detectTimeSignature(){this.musicDetector.forceFastDetection=this.forceFastDetection;const e=this.musicDetector.detectTimeSignature();return this.detectedTimeSignature=this.musicDetector.detectedTimeSignature,this.timeSignatureConfidence=this.musicDetector.timeSignatureConfidence,this.timeSignatureLocked=this.musicDetector.timeSignatureLocked,e}testWaltzPattern(e,t){return this.musicDetector.testWaltzPattern(e,t)}resetMusicDetection(){this.forceFastDetection=!0,this.musicDetector.reset(),this.musicDetector.forceFastDetection=!0,this.onsetThreshold=0,this.detectedBPM=0,this.bpmConfidence=0,this.onsetStrengths=[],this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.musicDetector.lastBPMCalculation=0,this.measureStartTime=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.spectralHistory=[],this.spectralFluxHistory=[];const e=document.getElementById("time-sig-display");e&&(e.textContent="—")}getCurrentMusicInfo(){return{bpm:this.detectedBPM,timeSignature:this.detectedTimeSignature,bpmLocked:this.tempoLocked,timeSigLocked:this.timeSignatureLocked}}generateFallbackCircle(){const e=[];for(let t=0;t<this.numPoints;t++){const i=t/this.numPoints*Math.PI*2;e.push({x:.5+.5*Math.cos(i),y:.5+.5*Math.sin(i)})}return e}getState(){return{currentShape:this.currentShape,targetShape:this.targetShape,isTransitioning:this.isTransitioning,progress:this.morphProgress,audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy}}getProgress(e=!0){return e?this.visualProgress:this.morphProgress}isInTransition(){return this.isTransitioning}destroy(){this.queuedMorphTimeout&&(clearTimeout(this.queuedMorphTimeout),this.queuedMorphTimeout=null),this.queuedMorph=null,this.shapeCache.clear(),this.canvasPointsCache=null,this.frequencyData&&(Vm.release(this.frequencyData),this.frequencyData=null),this.bassHistory&&(Vm.release(this.bassHistory),this.bassHistory=null),this.vocalHistory&&(Vm.release(this.vocalHistory),this.vocalHistory=null),this.audioAnalyzer=null}}class eg{constructor(){this.audioContext=null,this.analyser=null,this.source=null,this.elementSource=null,this.dataArray=null,this.isAnalyzing=!1,this.connectedElement=null,this.gainNode=null,this.animationFrameId=null,this.frequencyBands=32,this.smoothingFactor=.3,this.vocalRange={min:80,max:1e3},this.currentAmplitude=0,this.currentFrequencies=new Array(this.frequencyBands).fill(0),this.beatThreshold=.3,this.lastBeatTime=0,this.beatCallbacks=[]}init(){try{return this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state?this.audioContext.resume().then(()=>(this.createAnalyser(),!0)).catch(()=>!1):(this.createAnalyser(),!0)}catch(e){return console.warn("AudioAnalyzer init failed:",e),!1}}createAnalyser(){if(this.audioContext&&!this.analyser){this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.5;const e=this.analyser.frequencyBinCount;this.dataArray=new Uint8Array(e)}}connectAudioElement(e){if(this.audioContext)try{this.elementSource&&this.connectedElement===e||(this.elementSource=this.audioContext.createMediaElementSource(e),this.elementSource.connect(this.analyser),this.elementSource.connect(this.audioContext.destination)),this.source=this.elementSource,this.connectedElement=e,this.isAnalyzing=!0,this.analyze()}catch(t){t.message&&t.message.includes("already been used")&&(this.source=this.elementSource,this.connectedElement=e,this.isAnalyzing=!0,this.analyze())}}analyze(){if(!this.isAnalyzing)return;this.animationFrameId=requestAnimationFrame(()=>this.analyze()),this.analyser.getByteFrequencyData(this.dataArray);const e=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteTimeDomainData(e);let t=0,i=0,n=0;const s=this.audioContext.sampleRate/2/this.dataArray.length,r=Math.floor(this.vocalRange.min/s),a=Math.ceil(this.vocalRange.max/s);for(let e=0;e<this.dataArray.length;e++){const s=this.dataArray[e]/255;t+=s,e>=r&&e<=a&&(i+=s,n++)}this.currentAmplitude=t/this.dataArray.length;const o=n>0?i/n:0;return this.extractFrequencyBands(),this.detectBeat(this.currentAmplitude),{amplitude:this.currentAmplitude,vocalAmplitude:o,frequencies:this.currentFrequencies,rawData:this.dataArray}}extractFrequencyBands(){const e=Math.floor(this.dataArray.length/this.frequencyBands);for(let t=0;t<this.frequencyBands;t++){let i=0;const n=t*e,s=Math.min(n+e,this.dataArray.length);for(let e=n;e<s;e++)i+=this.dataArray[e]/255;const r=i/e;this.currentFrequencies[t]=this.currentFrequencies[t]*this.smoothingFactor+r*(1-this.smoothingFactor)}}detectBeat(e){const t=performance.now();e>this.beatThreshold&&t-this.lastBeatTime>60&&(this.lastBeatTime=t,this.beatCallbacks.forEach(t=>t(e)))}getVocalInstability(){let e=0;const t=this.currentFrequencies.reduce((e,t)=>e+t,0)/this.frequencyBands;for(let i=0;i<this.frequencyBands;i++)e+=Math.pow(this.currentFrequencies[i]-t,2);return e=Math.sqrt(e/this.frequencyBands),Math.min(1,2*e+.5*this.currentAmplitude)}getShapeMorpherData(){return{instability:this.getVocalInstability(),frequencies:[...this.currentFrequencies],amplitude:this.currentAmplitude}}onBeat(e){this.beatCallbacks.push(e)}stop(){if(this.isAnalyzing=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.gainNode){try{this.gainNode.disconnect()}catch{}this.gainNode=null}if(this.elementSource&&this.connectedElement){try{this.elementSource.connect(this.analyser)}catch{}this.source=this.elementSource}}async resume(){this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume()}destroy(){this.stop(),null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.dataArray=null,this.beatCallbacks=[]}}class tg{constructor(){this.timingClasses={downbeat:{gestures:["bounce","jump","headBob","spin","orbit"],timing:1,priority:1,description:"Strong emphasis on the downbeat"},upbeat:{gestures:["wave","nod","point","reach"],timing:.5,priority:2,description:"Medium emphasis on upbeat"},offbeat:{gestures:["wiggle","sway","lean","tilt","groove"],timing:.5,priority:3,description:"Syncopated, creates groove"},subdivision:{gestures:["pulse","sparkle","flash","shimmer","flicker"],timing:.25,priority:4,description:"Quick accents and fills"},continuous:{gestures:["breathe","float","rain"],timing:-1,priority:5,description:"Ambient, continuous motion"}},this.fillPatterns={subtle:["breathe","float"],rhythmic:["pulse","shimmer"],energetic:["wiggle","sparkle"],smooth:["sway","glow"]},this.densityProfiles={sparse:{fillProbability:.1,subdivisionLevel:2,description:"Minimal movement"},moderate:{fillProbability:.3,subdivisionLevel:4,description:"Balanced movement"},dense:{fillProbability:.5,subdivisionLevel:8,description:"Busy, energetic"},chaos:{fillProbability:.8,subdivisionLevel:16,description:"Maximum energy"}},this.groups={movement:{gestures:["bounce","spin","orbit","sway","hula","jump","twist","groove"],maxSimultaneous:1,priority:1,description:"Primary body movements - mutually exclusive"},expression:{gestures:["wave","nod","shake","point","lean","tilt","reach"],maxSimultaneous:2,priority:2,description:"Expressive gestures - can combine up to 2"},dance:{gestures:["headBob","wiggle","runningman","charleston"],maxSimultaneous:1,priority:2,description:"Dance moves - one at a time but can add effects"},effects:{gestures:["pulse","glow","sparkle","flash","shimmer","flicker"],maxSimultaneous:-1,priority:3,description:"Visual effects - all can layer together"},modifiers:{gestures:["breathe","float","rain"],maxSimultaneous:-1,priority:4,description:"Ambient effects - always allowed"}},this.enhancingCombinations=[["bounce","sparkle"],["spin","glow"],["wave","pulse"],["nod","pulse"],["jump","flash"],["sway","breathe"],["float","shimmer"],["orbit","sparkle"],["headBob","pulse"]],this.incompatiblePairs=[["bounce","jump"],["spin","orbit"],["wave","point"],["nod","shake"],["lean","tilt"]],this.chords={celebrate:["bounce","sparkle","pulse"],greeting:["wave","nod","glow"],excited:["jump","flash","wiggle"],mystical:["float","shimmer","breathe"],party:["headBob","pulse","sparkle"],smooth:["sway","glow","breathe"],dramatic:["spin","flash","sparkle"]},this.chains={rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash",buildup:"pulse > pulse > bounce+sparkle > spin+flash",cascade:"wave > lean > tilt > spin > bounce+glow",celebrate:"bounce+sparkle > spin > jump+flash > nod+pulse",smooth:"sway+breathe > float > orbit+shimmer > sway+glow",custom:"expand > contract > morph > expand+glow",greeting:"wave+glow > nod+pulse > wave",mystical:"float+shimmer > orbit+breathe > spin+sparkle > float+glow"}}canExecuteSimultaneously(e,t){if(e===t)return!1;if(this.incompatiblePairs.some(i=>i.includes(e)&&i.includes(t)))return!1;const i=this.getGestureGroup(e),n=this.getGestureGroup(t);if(i===n){const e=this.groups[i];return e&&1!==e.maxSimultaneous}return!("movement"===i&&"movement"===n||"dance"===i&&"dance"===n)}getGestureGroup(e){for(const[t,i]of Object.entries(this.groups))if(i.gestures.includes(e))return t;return null}getGesturePriority(e){const t=this.getGestureGroup(e);return t?this.groups[t].priority:99}getCompatibleGestures(e){if(!e||0===e.length)return[];if(1===e.length)return e;const t=[],i=new Set,n=e=>"string"==typeof e?e:e.gestureName,s=[...e].sort((e,t)=>this.getGesturePriority(n(e))-this.getGesturePriority(n(t)));for(const e of s){if(i.has(e))continue;const s=n(e);let r=!0;for(const e of t){const t=n(e);if(!this.canExecuteSimultaneously(s,t)){r=!1;break}}if(r){const r=this.groups[this.getGestureGroup(s)];if(r&&r.maxSimultaneous>0&&t.filter(e=>this.getGestureGroup(n(e))===this.getGestureGroup(s)).length>=r.maxSimultaneous)continue;t.push(e),i.add(e)}}return t}parseChain(e){return e?(this.chains[e]&&(e=this.chains[e]),e.split(">").map(e=>e.trim()).map(e=>e.split("+").map(e=>e.trim()).filter(e=>e))):[]}isEnhancingCombination(e){const t=e.map(e=>"string"==typeof e?e:e.gestureName);return this.enhancingCombinations.some(e=>e.every(e=>t.includes(e)))}getChord(e){return this.chords[e]||null}createChord(e){const t=this.getCompatibleGestures(e),i=this.isEnhancingCombination(t);return{type:"chord",gestures:t.map(e=>"string"==typeof e?e:e.gestureName),isEnhancing:i,timestamp:Date.now()}}isValidGesture(e){return null!==this.getGestureGroup(e)}getAllGestures(){const e=[];for(const t of Object.values(this.groups))e.push(...t.gestures);return[...new Set(e)]}getGestureTiming(e){for(const[t,i]of Object.entries(this.timingClasses))if(i.gestures.includes(e))return{name:t,...i};return null}getNextBeatForGesture(e,t,i=1){const n=this.getGestureTiming(e);if(!n)return t+1;if(-1===n.timing)return t;const s=n.timing/i,r=Math.ceil(t/s)*s;return"offbeat"===n.name?r+.5:r}getFillGestures(e,t="moderate"){const i=this.densityProfiles[t]||this.densityProfiles.moderate;let n;return n=e<80?"energetic":e<120?"rhythmic":e<160?"smooth":"subtle",Math.random()<i.fillProbability&&this.fillPatterns[n]||[]}getNextBeatTiming(e,t,i){return this.getNextBeatForGesture(e,t)}getIntensityFromBPM(e){return e<60?"dense":e<100||e<140?"moderate":"sparse"}applySwingTiming(e,t=.67){return.5==e%1?Math.floor(e)+t:e}}const ig=new tg;var ng=Object.freeze({__proto__:null,GestureCompatibility:tg,default:ig});class sg{constructor(){this.templates={straight:{name:"Straight",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",pattern:{emphasis:[1,0,.5,0],velocities:[1,0,.6,0],subdivisions:[0,.5]},swing:0,humanization:.05,preferredGestures:{downbeat:["bounce","headBob","jump"],offbeat:["pulse","breathe"],fills:["sparkle","glow"]},compositeMove:null,intensity:"moderate",description:"Standard 4/4 rhythm, good for pop/rock"},swing:{name:"Swing",timeSignature:"4/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:"swingOut",pattern:{emphasis:[1,0,.66,0],velocities:[1,0,.7,0],subdivisions:[0,.66]},swing:.67,humanization:.08,preferredGestures:{downbeat:["sway","lean","bounce"],offbeat:["wiggle","pulse"],fills:["shimmer","float"]},intensity:"moderate",description:"Jazz swing feel with triplet subdivision"},shuffle:{name:"Shuffle",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,.25,.5,.75],velocities:[1,.3,.7,.3],subdivisions:[0,.25,.5,.75]},swing:.75,humanization:.06,preferredGestures:{downbeat:["bounce","headBob"],upbeat:["twist","wiggle"],offbeat:["pulse","breathe"],fills:["sparkle","flash"]},intensity:"dense",description:"Blues/rock shuffle with heavy swing"},latin:{name:"Latin",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"latinHips",pattern:{emphasis:[1,0,.375,.5,0,.75,0,0],velocities:[1,0,.8,.9,0,.8,0,0],subdivisions:[0,.375,.5,.75]},swing:0,humanization:.04,preferredGestures:{downbeat:["sway","wiggle"],syncopation:["twist","lean"],offbeat:["pulse","shimmer"],fills:["sparkle","shake"]},intensity:"dense",description:"Latin clave rhythm with syncopation"},breakbeat:{name:"Breakbeat",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,0,0,.75,.25,.5,0,.625],velocities:[1,0,0,.9,.6,.8,0,.7],subdivisions:[0,.25,.5,.625,.75]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","twist"],syncopation:["flash","shake"],offbeat:["pulse","wiggle"],fills:["sparkle","glitch"]},intensity:"chaos",description:"Hip-hop/DnB breakbeat pattern"},waltz:{name:"Waltz",timeSignature:"3/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,.33,.67],velocities:[1,.5,.5],subdivisions:[0,.33,.67]},swing:0,humanization:.07,preferredGestures:{downbeat:["sway","float"],weak:["breathe","lean"],fills:["shimmer","glow"]},intensity:"sparse",description:"3/4 waltz time"},techno:{name:"Techno",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionLean",compositeMove:"robotPop",pattern:{emphasis:[1,.25,.5,.75,1,.25,.5,.75],velocities:[1,.6,1,.6,1,.6,1,.6],subdivisions:[0,.25,.5,.75]},swing:0,humanization:.02,preferredGestures:{downbeat:["pulse","bounce"],subdivision:["flash","glitch"],fills:["sparkle","strobe"]},intensity:"dense",description:"Driving techno four-on-the-floor"},ambient:{name:"Ambient",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[.8,0,.3,0,.5,0,.3,0],velocities:[.8,0,.3,0,.5,0,.3,0],subdivisions:[0,.5]},swing:0,humanization:.15,preferredGestures:{downbeat:["float","breathe"],offbeat:["sway","shimmer"],fills:["glow","pulse"]},intensity:"sparse",description:"Floating ambient rhythm"},funk:{name:"Funk",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"funkChicken",pattern:{emphasis:[1.2,.125,.25,0,.625,.75,0,.875],velocities:[1.2,.3,.4,0,.8,.6,0,.4],subdivisions:[0,.125,.25,.625,.75,.875]},swing:.1,humanization:.06,preferredGestures:{one:["bounce","twist"],ghost:["wiggle","pulse"],syncopation:["lean","shake"],fills:["flash","sparkle"]},intensity:"chaos",description:"Funky syncopated rhythm with THE ONE"},trap:{name:"Trap",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,0,0,.375,0,.75,.875,0],velocities:[1,0,0,.7,0,.8,.6,0],subdivisions:[0,.375,.75,.875]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","lean"],hihat:["shake","shimmer"],syncopation:["twist","flash"],fills:["sparkle","glitch"]},intensity:"moderate",description:"Trap rhythm with triplet hi-hats"}},this.transitions={instant:0,nextBar:1,nextPhrase:4,fadeIn:8},this.currentGroove=null,this.transitionMode="nextBar",this.pendingGroove=null}getTemplate(e){return this.templates[e.toLowerCase()]||this.templates.straight}getEmphasis(e,t,i){if(!e||!e.pattern)return 0;const n=e.pattern.subdivisions.findIndex(e=>Math.abs(e-i)<.01);return-1===n?0:e.pattern.emphasis[n]||0}getVelocity(e,t,i){if(!e||!e.pattern)return 1;const n=e.pattern.subdivisions.findIndex(e=>Math.abs(e-i)<.01);return-1===n?0:e.pattern.velocities[n]||0}getPreferredGesture(e,t,i,n=[]){if(!e||!e.preferredGestures)return null;let s;s=0===i?"downbeat":.5===i?"offbeat":.25===i||.75===i?"subdivision":"syncopation","Funk"===e.name&&t%4==0&&0===i&&(s="one");const r=e.preferredGestures[s]||e.preferredGestures.fills;if(!r||0===r.length)return null;if(n.length>0){const e=r.filter(e=>n.includes(e));if(e.length>0)return e[Math.floor(Math.random()*e.length)]}return r[Math.floor(Math.random()*r.length)]}humanizeTiming(e,t){if(!e||!e.humanization)return t;const i=e.humanization,n=(Math.random()-.5)*i;return Math.max(0,Math.min(1,t+n))}applySwing(e,t){return e&&e.swing&&0!==e.swing?Math.abs(t-.5)<.01?.5+.5*(e.swing-.5):Math.abs(t-.25)<.01?.25+.25*(e.swing-.5):Math.abs(t-.75)<.01?.75+.25*(e.swing-.5):t:t}setGroove(e,t=null){const i=this.getTemplate(e);return!!i&&("instant"!==(t||this.transitionMode)&&this.currentGroove?this.pendingGroove=i:(this.currentGroove=i,this.pendingGroove=null),!0)}onBeat(e){this.pendingGroove&&("nextBar"===this.transitionMode&&e%4==0||"nextPhrase"===this.transitionMode&&e%16==0)&&(this.currentGroove=this.pendingGroove,this.pendingGroove=null)}getBaseMovement(){return this.currentGroove?.baseMovement||null}getTransitionStyle(){return this.currentGroove?.transitionStyle||"transitionLean"}getCompositeMove(){return this.currentGroove?.compositeMove||null}shouldTriggerComposite(e){return!!this.currentGroove?.compositeMove&&e%("sparse"===this.currentGroove.intensity?32:16)==0}getLayeredGestures(e,t){if(!this.currentGroove)return null;const i={base:this.getBaseMovement(),accent:null,transition:null,composite:null,velocity:1};this.shouldTriggerComposite(e)&&0===t&&(i.composite=this.getCompositeMove());const n=this.getEmphasis(this.currentGroove,e,t),s=this.getVelocity(this.currentGroove,e,t);return n>.3&&s>.3&&(i.accent=this.getPreferredGesture(this.currentGroove,e,t),i.velocity=s),i.accent&&Math.random()<.3&&(i.transition=this.getTransitionStyle()),i}getGrooveNames(){return Object.keys(this.templates)}getGrooveInfo(e){const t=this.templates[e];return t?{name:t.name,timeSignature:t.timeSignature,description:t.description,intensity:t.intensity,swing:t.swing,baseMovement:t.baseMovement,compositeMove:t.compositeMove}:null}}class rg{constructor(e){this.mascot=e,this.vocalUpdateInterval=null}init(){}disconnectAudio(){return this.mascot.audioAnalyzer&&this.mascot.audioAnalyzer.stop(),this.vocalUpdateInterval&&(clearInterval(this.vocalUpdateInterval),this.vocalUpdateInterval=null),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.setVocalEnergy(0),this.mascot.shapeMorpher.setAudioDeformation(0),this.mascot.shapeMorpher.audioAnalyzer=null,this.mascot.shapeMorpher.beatGlitchIntensity=0,this.mascot.shapeMorpher.glitchPoints=[]),this.mascot.renderer&&this.mascot.renderer.ambientDanceAnimator.stopAmbientAnimation("grooveBob"),this.mascot}async connectAudio(e){if(!this.mascot.audioAnalyzer)return this.mascot;if(!this.mascot.audioAnalyzer.audioContext)try{await this.mascot.audioAnalyzer.init()}catch(e){return console.warn("Failed to initialize AudioContext:",e),this.mascot}if(this.mascot.audioAnalyzer.audioContext&&"suspended"===this.mascot.audioAnalyzer.audioContext.state)try{await this.mascot.audioAnalyzer.audioContext.resume()}catch(e){console.warn("Failed to resume AudioContext:",e)}return this.mascot.audioAnalyzer.connectAudioElement(e),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.audioAnalyzer.onBeat(e=>{if(this.mascot.shapeMorpher){if(this.mascot.shapeMorpher.musicDetector){const t=performance.now();this.mascot.shapeMorpher.musicDetector.addOnset(t,e)}this.mascot.shapeMorpher.vocalEffectActive&&(this.mascot.shapeMorpher.beatGlitchIntensity=.3*e)}})),this.vocalUpdateInterval&&clearInterval(this.vocalUpdateInterval),this.mascot.renderer&&this.mascot.renderer.startGrooveBob({intensity:.5,frequency:1}),this.vocalUpdateInterval=setInterval(()=>{if(this.mascot.audioAnalyzer.isAnalyzing&&this.mascot.shapeMorpher){const e=this.mascot.audioAnalyzer.currentAmplitude||0,t=this.mascot.audioAnalyzer.getVocalInstability()||0;this.mascot.shapeMorpher.setVocalEnergy(t),this.mascot.shapeMorpher.setAudioDeformation(2*e)}},50),this.mascot.renderer&&(this.mascot.renderer.audioAnalyzer=this.mascot.audioAnalyzer),this.mascot}stopSpeaking(){if(!this.mascot.speaking)return this.mascot;const e=this.mascot.audioLevelProcessor.getCurrentLevel();return this.mascot.audioLevelProcessor.cleanup(),this.mascot.speaking=!1,this.mascot.renderer.onSpeechStop(),this.mascot.emit("speechStopped",{previousAudioLevel:e,returnToBaseTime:500}),this.mascot}setVolume(e){const t=Math.max(0,Math.min(1,e));if(this.mascot.config.masterVolume=t,this.mascot.soundSystem.isAvailable()){const e=this.mascot.stateMachine.getCurrentState().emotion;this.mascot.soundSystem.setMasterVolume(t,e)}return this.mascot.emit("volumeChanged",{volume:t}),this.mascot}destroy(){this.disconnectAudio()}}let ag=class{constructor(e){this.mascot=e,this.currentGesture=null,this.gestureCompatibility=null,this.rendererMethods={bounce:"startBounce",pulse:"startPulse",shake:"startShake",spin:"startSpin",nod:"startNod",tilt:"startTilt",expand:"startExpand",contract:"startContract",flash:"startFlash",drift:"startDrift",stretch:"startStretch",glow:"startGlow",sparkle:"startSparkle",shimmer:"startShimmer",wiggle:"startWiggle",groove:"startGroove",point:"startPoint",lean:"startLean",reach:"startReach",headBob:"startHeadBob",orbit:"startOrbit",flicker:"startFlicker",vibrate:"startVibrate",wave:"startWave",breathe:"startBreathe",morph:"startMorph",slowBlink:"startSlowBlink",look:"startLook",settle:"startSettle",orbital:"startOrbital",hula:"startHula",sway:"startSway",breathIn:"startBreathIn",breathOut:"startBreathOut",breathHold:"startBreathHold",breathHoldEmpty:"startBreathHoldEmpty",jump:"startJump",rain:"startRain",runningman:"startRunningMan",charleston:"startCharleston",grooveSway:"startGrooveSway",grooveBob:"startGrooveBob",grooveFlow:"startGrooveFlow",groovePulse:"startGroovePulse",grooveStep:"startGrooveStep",float:"startFloat",twist:"startTwist"}}init(){this.gestureCompatibility||Promise.resolve().then(function(){return ng}).then(e=>{this.gestureCompatibility=e.default}).catch(e=>{console.warn("GestureCompatibility not available:",e)})}express(e,t={}){return this.mascot.errorBoundary.wrap(()=>{if(!e)return this.mascot;const i=performance.now(),n=Array.isArray(e)||"object"==typeof e&&"chord"===e.type?"chord":e;if(this.mascot.performanceMonitor&&this.mascot.performanceMonitor.markGestureStart(n),Array.isArray(e))return this.expressChord(e,t);if("object"==typeof e&&"chord"===e.type)return this.expressChord(e.gestures,t);const s=this.rendererMethods[e];if(s&&this.mascot.renderer&&this.mascot.renderer[s]){if(this.mascot.renderer[s](t),this.mascot.config.soundEnabled&&this.mascot.soundSystem.isAvailable()&&this.mascot.soundSystem.playGestureSound(e),this.mascot.performanceMonitor){const e=performance.now();this.mascot.performanceMonitor.markGestureEnd(n),this.mascot.performanceMonitor.recordGestureTime(n,e-i)}return this.mascot}const r=gt(e);if(r){if(W.registerConfig("gesture",e,r),this.mascot.currentModularGesture={type:e,config:r,startTime:performance.now(),duration:r.defaultParams?.duration||1e3,progress:0},this.mascot.config.soundEnabled&&this.mascot.soundSystem.isAvailable()&&this.mascot.soundSystem.playGestureSound(e),this.mascot.performanceMonitor){const e=performance.now();this.mascot.performanceMonitor.markGestureEnd(n),this.mascot.performanceMonitor.recordGestureTime(n,e-i)}return this.mascot}return this.mascot.throttledWarn(`Unknown gesture: ${e}`,`gesture_${e}`),this.mascot.performanceMonitor&&this.mascot.performanceMonitor.markGestureEnd(n),this.mascot},"gesture-express",this.mascot)()}expressChord(e,t={}){return this.mascot.errorBoundary.wrap(()=>{if(!e||!Array.isArray(e)||0===e.length)return this.mascot;this.gestureCompatibility||Promise.resolve().then(function(){return ng}).then(e=>{this.gestureCompatibility=e.default}).catch(e=>{console.warn("GestureCompatibility not available:",e)});const i=this.gestureCompatibility?this.gestureCompatibility.getCompatibleGestures(e):e;return i.forEach(e=>{const i="string"==typeof e?e:e.gestureName;this.executeGestureDirectly(i,t)}),this.gestureCompatibility?.isEnhancingCombination?.(i)&&this.mascot.renderer?.specialEffects?.addSparkle?.(),this.mascot},"gesture-chord",this.mascot)()}executeGestureDirectly(e,t={}){const i=this.rendererMethods[e];i&&this.mascot.renderer&&"function"==typeof this.mascot.renderer[i]&&this.mascot.renderer[i](t)}chain(...e){if(this.gestureCompatibility){const t=e.join(">"),i=this.gestureCompatibility.parseChain(t);this.executeChainSequence(i)}else console.warn("🔗 No gestureCompatibility available, falling back to first gesture"),e.length>0&&this.express(e[0]);return this.mascot}executeChainSequence(e){if(!e||0===e.length)return;let t=0;const i=()=>{if(t>=e.length)return;const n=e[t];1===n.length?this.express(n[0]):this.expressChord(n),t++,t<e.length&&setTimeout(i,800)};i()}destroy(){this.currentGesture=null,this.gestureCompatibility=null}};class og{constructor(e){this.mascot=e,this.currentEmotion="neutral",this.emotionIntensity=1}init(){}setEmotion(e,t=null){const i={happy:"joy",curious:"surprise",frustrated:"anger",sad:"sadness"}[e]||e;let n=null,s=500;if("string"==typeof t?n=t:t&&"object"==typeof t&&(n=t.undertone||null,s=t.duration||500),this.mascot.stateMachine.setEmotion(i,n,s)){const e=A(i);if(e&&W.registerConfig("emotion",i,e),this.mascot.particleSystem){this.mascot.particleSystem.clear();const e=this.mascot.stateMachine.getCurrentEmotionalProperties();let t;if(t="neutral"===i?1:"resting"===i?4:Math.min(3,Math.floor(e.particleRate/4)),t>0){let i,n;if(this.mascot.renderer&&"function"==typeof this.mascot.renderer.getEffectiveCenter){const e=this.mascot.renderer.getEffectiveCenter();i=e.x,n=e.y}else i=this.mascot.canvasManager.width/2,n=this.mascot.canvasManager.height/2;this.mascot.particleSystem.burst(t,e.particleBehavior,i,n)}}if("classic"===this.mascot.config.renderingStyle&&this.mascot.renderer.setEmotionalState){const e=I(i);this.mascot.renderer.setEmotionalState(i,e,n)}this.mascot.emit("emotionChanged",{emotion:i,undertone:n,duration:s})}return this.currentEmotion=i,this.mascot}destroy(){this.currentEmotion="neutral"}}class cg{constructor(e){this.mascot=e,this.animationId=null,this.isRunning=!1,this.lastTime=0}init(){}start(){if(this.mascot.animationController.isAnimating())return this.mascot;if(this.mascot.animationController.start()){if(this.mascot.isRunning=!0,this.isRunning=!0,"classic"===this.mascot.config.renderingStyle&&this.mascot.particleSystem){const e=this.mascot.stateMachine.getCurrentState(),{emotion:t}=e,i=I(t);let n,s;if(this.mascot.renderer&&this.mascot.renderer.getCurrentOrbPosition){const e=this.mascot.renderer.getCurrentOrbPosition();n=e.x,s=e.y}else n=this.mascot.canvasManager.width/2,s=this.mascot.canvasManager.height/2;if(this.mascot.particleSystem.clear(),i.particleRate>0){const e=Math.min(3,Math.floor(i.particleRate/4));e>0&&this.mascot.particleSystem.burst(e,i.particleBehavior,n,s)}}this.mascot.degradationManager&&this.mascot.degradationManager.startMonitoring(),this.mascot.emit("started")}return this.mascot}stop(){return this.mascot.animationController.isAnimating()?(this.mascot.speaking&&this.mascot.audioHandler.stopSpeaking(),this.mascot.animationController.stop()&&(this.mascot.isRunning=!1,this.isRunning=!1,this.mascot.degradationManager&&this.mascot.degradationManager.stopMonitoring(),this.mascot.emit("stopped")),this.mascot):this.mascot}update(e){if(this.mascot.speaking&&this.mascot.audioLevelProcessor.isProcessingActive()&&this.mascot.audioLevelProcessor.updateAudioLevel(e),"classic"===this.mascot.config.renderingStyle){if(this.mascot.gazeTracker&&(this.mascot.gazeTracker.update(e),"suspicion"===this.mascot.stateMachine.getCurrentState().emotion)){const{mousePos:e}=this.mascot.gazeTracker,t=this.mascot.canvas.width/2,i=this.mascot.canvas.height/2,n=Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-i,2)),s=A("suspicion");if(s&&s.visual){const e=Math.min(t,i),r=Math.max(0,Math.min(1,1-n/e));s.visual.threatLevel=r}}if(this.mascot.idleBehavior&&this.mascot.idleBehavior.update(e),this.mascot.gazeTracker&&this.mascot.idleBehavior){const e=this.mascot.gazeTracker.getGazeOffset(),t=this.mascot.idleBehavior.getSwayOffset(),i=this.mascot.gazeTracker.getState(),n={offset:{x:e.x+t.x,y:e.y+t.y},proximity:i.proximity,isFocused:i.isFocused};this.mascot.renderer.setGazeData&&this.mascot.renderer.setGazeData(n)}}if(this.mascot.pluginSystem){const t=this.mascot.stateMachine.getCurrentState();this.mascot.pluginSystem.update(e,t)}}destroy(){this.stop()}}class lg{constructor(e){this.mascot=e}start(){return this.mascot.errorBoundary.wrap(()=>this.mascot.visualizationRunner.start(),"start",this.mascot)()}stop(){return this.mascot.errorBoundary.wrap(()=>this.mascot.visualizationRunner.stop(),"stop",this.mascot)()}pause(){return this.mascot.errorBoundary.wrap(()=>this.mascot.animationController.isAnimating()?(this.mascot.animationController.stop(),this.mascot.isRunning=!1,this.mascot.soundSystem.isAvailable()&&this.mascot.soundSystem.stopAmbientTone(200),this.mascot.emit("paused"),this.mascot):this.mascot,"pause",this.mascot)()}resume(){return this.mascot.errorBoundary.wrap(()=>(this.mascot.animationController.isAnimating()||(this.mascot.animationController.start(),this.mascot.isRunning=!0,this.mascot.emit("resumed")),this.mascot),"resume",this.mascot)()}isActive(){return this.mascot.animationController.isAnimating()}}class hg{constructor(e){this.mascot=e}setTargetFPS(e){const t=Math.max(15,Math.min(120,e));return this.mascot.config.targetFPS=t,this.mascot.animationController.setTargetFPS(t),this.mascot.emit("targetFPSChanged",{targetFPS:t}),this.mascot}getTargetFPS(){return this.mascot.animationController.targetFPS}setPosition(e,t,i=0){return this.mascot.positionController&&(this.mascot.positionController.onUpdate||(this.mascot.positionController.onUpdate=()=>{}),this.mascot.positionController.setOffset(e,t,i)),this.mascot}animateToPosition(e,t,i=0,n=1e3,s="easeOutCubic"){return this.mascot.positionController&&(this.mascot.positionController.onUpdate||(this.mascot.positionController.onUpdate=()=>{}),this.mascot.positionController.animateOffset(e,t,i,n,s)),this.mascot}getPosition(){return this.mascot.errorBoundary.wrap(()=>{if(!this.mascot.positionController||"function"!=typeof this.mascot.positionController.getPosition)return null;const e="undefined"!=typeof window,t=e?window.innerWidth/2:0,i=e?window.innerHeight/2:0;return this.mascot.positionController.getPosition(t,i)},"get-position",this.mascot)()}}class ug{constructor(e,t={}){this.mascot=e,this.config=this.validateConfig(t)}validateConfig(e){return{canvasId:e.canvasId||"emotive-canvas",startingEmotion:e.startingEmotion||"neutral",emotionalResponsiveness:e.emotionalResponsiveness??.5,particleIntensity:e.particleIntensity??1,glowIntensity:e.glowIntensity??1,audioEnabled:e.audioEnabled??!1,showFPS:e.showFPS??!1,debugMode:e.debugMode??!1,renderMode:e.renderMode||"default",maxParticles:e.maxParticles||100,...e}}getConfig(){return{...this.config}}updateConfig(e){return this.config={...this.config,...e},this.config}}class dg{constructor(e){this.mascot=e}getBrowserCompatibility(){return{browser:qm.browser,features:qm.featureDetection.getFeatures(),capabilities:qm.capabilities,appliedPolyfills:qm.appliedPolyfills,optimizations:qm.browserOptimizations.getOptimizations()}}getDegradationStatus(){return this.mascot.degradationManager?{currentLevel:this.mascot.degradationManager.getCurrentLevel(),availableFeatures:this.mascot.degradationManager.getAvailableFeatures(),recommendedSettings:this.mascot.degradationManager.getRecommendedSettings(),performanceStats:this.mascot.degradationManager.getPerformanceStats(),allLevels:this.mascot.degradationManager.getAllLevels()}:null}setDegradationLevel(e){return!!this.mascot.degradationManager&&this.mascot.degradationManager.setLevel(e)}getDebugReport(){const e={timestamp:Date.now(),mascot:{isRunning:this.mascot.isRunning,speaking:this.mascot.speaking,debugMode:this.mascot.debugMode,config:this.mascot.config},currentState:this.mascot.getCurrentState(),performanceMetrics:this.getPerformanceMetrics(),audioStats:this.mascot.getAudioStats(),eventStats:this.mascot.getEventStats(),browserCompatibility:this.getBrowserCompatibility(),degradationStatus:this.getDegradationStatus(),runtimeCapabilities:Hm.generateReport(),debuggerReport:$m.getDebugReport()};return this.mascot.debugMode&&$m.log("DEBUG","Generated debug report",{reportSize:JSON.stringify(e).length,sections:Object.keys(e)}),e}exportDebugData(){const e={metadata:{exportTime:Date.now(),version:"1.0.0",userAgent:navigator.userAgent,url:window.location?.href},mascotState:{config:this.mascot.config,currentState:this.mascot.getCurrentState(),isRunning:this.mascot.isRunning,speaking:this.mascot.speaking},performance:{metrics:this.getPerformanceMetrics(),degradationStatus:this.getDegradationStatus(),frameTimings:$m.frameTimings},compatibility:{browser:this.getBrowserCompatibility(),runtimeCapabilities:Hm.generateReport()},debuggerData:$m.exportDebugData()};return this.mascot.debugMode&&$m.log("INFO","Exported debug data",{dataSize:JSON.stringify(e).length}),e}getPerformanceMetrics(){const e=this.mascot.animationController.getPerformanceMetrics(),t=this.mascot.stateMachine.getCurrentState();return{...e,currentEmotion:t.emotion,currentUndertone:t.undertone,isTransitioning:t.isTransitioning,errorStats:this.mascot.errorBoundary.getErrorStats()}}getPerformanceAnalytics(){return this.mascot.errorBoundary.wrap(()=>this.mascot.performanceSystem?this.mascot.performanceSystem.getAnalytics():null,"performance-analytics",this.mascot)()}}const pg={listening:{name:"listening",category:"conversational",emotion:"curiosity",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:400,description:"User is speaking, AI is listening attentively"},thinking:{name:"thinking",category:"conversational",emotion:"focused",gesture:"breathe",delay:100,baseIntensity:.7,emotionDuration:500,description:"AI is processing and thinking"},acknowledging:{name:"acknowledging",category:"conversational",emotion:"calm",gesture:"nod",delay:150,baseIntensity:.7,emotionDuration:400,description:"AI acknowledges understanding"},guiding:{name:"guiding",category:"conversational",emotion:"calm",gesture:"point",delay:200,baseIntensity:.7,emotionDuration:500,description:"AI provides guidance or instructions"},empathizing:{name:"empathizing",category:"conversational",emotion:"empathy",baseIntensity:.8,emotionDuration:600,description:"AI shows empathy and understanding",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.8},{at:200,action:"gesture",value:"shake"},{at:700,action:"gesture",value:"nod"}]},celebrating:{name:"celebrating",category:"conversational",emotion:"joy",baseIntensity:.9,emotionDuration:500,description:"AI celebrates success with user",sequence:[{at:0,action:"emotion",value:"joy",intensity:.9},{at:200,action:"gesture",value:"bounce"},{at:800,action:"emotion",value:"triumph",intensity:1},{at:900,action:"gesture",value:"glow"}]},celebrating_epic:{name:"celebrating_epic",category:"conversational",emotion:"triumph",baseIntensity:1,emotionDuration:500,description:"Epic celebration with visual transformation",sequence:[{at:0,action:"emotion",value:"joy",intensity:.9},{at:200,action:"gesture",value:"bounce"},{at:700,action:"emotion",value:"triumph",intensity:1},{at:800,action:"gesture",value:"glow"},{at:1e3,action:"morph",value:"sun"},{at:1e3,action:"chain",value:"radiance"}]},reassuring:{name:"reassuring",category:"conversational",emotion:"calm",baseIntensity:.8,emotionDuration:600,description:"AI provides reassurance and comfort",sequence:[{at:0,action:"emotion",value:"calm",intensity:.8},{at:200,action:"gesture",value:"breathe"},{at:800,action:"gesture",value:"wave"}]},offering_help:{name:"offering_help",category:"conversational",emotion:"empathy",baseIntensity:.8,emotionDuration:500,description:"AI offers assistance",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.8},{at:200,action:"gesture",value:"nod"},{at:600,action:"gesture",value:"point"}]},offering_urgent_help:{name:"offering_urgent_help",category:"conversational",emotion:"empathy",baseIntensity:1,emotionDuration:400,description:"AI urgently offers help for frustrated user",sequence:[{at:0,action:"emotion",value:"empathy",intensity:1},{at:150,action:"gesture",value:"shake"},{at:400,action:"gesture",value:"nod"},{at:700,action:"gesture",value:"point"}]},apologizing:{name:"apologizing",category:"conversational",emotion:"empathy",baseIntensity:.85,emotionDuration:600,description:"AI apologizes for mistake or error",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.85},{at:200,action:"gesture",value:"shake"},{at:600,action:"gesture",value:"breathe"}]},encouraging:{name:"encouraging",category:"conversational",emotion:"joy",gesture:"nod",delay:200,baseIntensity:.75,emotionDuration:500,description:"AI encourages user to continue"},greeting:{name:"greeting",category:"conversational",emotion:"joy",gesture:"wave",delay:200,baseIntensity:.7,emotionDuration:500,description:"AI greets user warmly"},responding_positive:{name:"responding_positive",category:"conversational",emotion:"joy",gesture:"bounce",delay:150,baseIntensity:.75,emotionDuration:500,description:"AI responds with positive sentiment"},responding_neutral:{name:"responding_neutral",category:"conversational",emotion:"calm",gesture:"drift",delay:150,baseIntensity:.6,emotionDuration:500,description:"AI responds with neutral sentiment"},responding_negative:{name:"responding_negative",category:"conversational",emotion:"empathy",gesture:"shake",delay:150,baseIntensity:.8,emotionDuration:600,description:"AI responds to negative situation"},success_minor:{name:"success_minor",category:"feedback",emotion:"joy",gesture:"bounce",delay:150,baseIntensity:.7,emotionDuration:500,description:"Small success (item scanned, form field validated)"},success_moderate:{name:"success_moderate",category:"feedback",emotion:"joy",baseIntensity:.8,emotionDuration:500,description:"Moderate success (section completed, task done)",sequence:[{at:0,action:"emotion",value:"joy",intensity:.8},{at:200,action:"gesture",value:"bounce"},{at:600,action:"gesture",value:"wiggle"}]},success_major:{name:"success_major",category:"feedback",emotion:"triumph",baseIntensity:.9,emotionDuration:500,description:"Major success (milestone reached, goal achieved)",sequence:[{at:0,action:"emotion",value:"joy",intensity:.85},{at:150,action:"gesture",value:"bounce"},{at:500,action:"emotion",value:"triumph",intensity:.9},{at:600,action:"gesture",value:"glow"}]},success_epic:{name:"success_epic",category:"feedback",emotion:"triumph",baseIntensity:1,emotionDuration:500,description:"Epic success with visual transformation",sequence:[{at:0,action:"emotion",value:"triumph",intensity:1},{at:200,action:"gesture",value:"glow"},{at:700,action:"morph",value:"sun"},{at:700,action:"chain",value:"radiance"}]},error_minor:{name:"error_minor",category:"feedback",emotion:"concern",gesture:"shake",delay:150,baseIntensity:.6,emotionDuration:500,description:"Minor error, easily recoverable"},error_moderate:{name:"error_moderate",category:"feedback",emotion:"empathy",baseIntensity:.75,emotionDuration:600,description:"Moderate error, needs user action",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.75},{at:200,action:"gesture",value:"shake"},{at:600,action:"gesture",value:"nod"}]},error_major:{name:"error_major",category:"feedback",emotion:"empathy",baseIntensity:.9,emotionDuration:600,description:"Major error, needs help",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.9},{at:150,action:"gesture",value:"shake"},{at:500,action:"gesture",value:"nod"},{at:800,action:"gesture",value:"point"}]},error_critical:{name:"error_critical",category:"feedback",emotion:"empathy",baseIntensity:1,emotionDuration:500,description:"Critical error, urgent attention needed",sequence:[{at:0,action:"emotion",value:"empathy",intensity:1},{at:100,action:"gesture",value:"shake"},{at:400,action:"gesture",value:"point"}]},warning:{name:"warning",category:"feedback",emotion:"concern",gesture:"pulse",delay:150,baseIntensity:.7,emotionDuration:500,description:"Warning, needs attention"},info:{name:"info",category:"feedback",emotion:"neutral",gesture:"drift",delay:100,baseIntensity:.5,emotionDuration:400,description:"Informational, passive notification"},progress_start:{name:"progress_start",category:"feedback",emotion:"anticipation",gesture:"pulse",delay:100,baseIntensity:.6,emotionDuration:500,description:"Starting a process"},progress_ongoing:{name:"progress_ongoing",category:"feedback",emotion:"focused",gesture:"breathe",delay:0,baseIntensity:.7,emotionDuration:600,description:"Process ongoing, working"},progress_complete:{name:"progress_complete",category:"feedback",emotion:"satisfaction",gesture:"glow",delay:200,baseIntensity:.8,emotionDuration:500,description:"Process completed successfully"},idle:{name:"idle",category:"state",emotion:"neutral",gesture:"drift",delay:0,baseIntensity:.5,emotionDuration:600,description:"System idle, waiting for user"},ready:{name:"ready",category:"state",emotion:"neutral",gesture:"wave",delay:200,baseIntensity:.6,emotionDuration:500,description:"System ready for interaction"},waiting:{name:"waiting",category:"state",emotion:"anticipation",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:600,description:"System waiting for process to complete",loop:!0,loopInterval:1500},processing:{name:"processing",category:"state",emotion:"focused",gesture:"breathe",delay:0,baseIntensity:.7,emotionDuration:600,description:"System actively processing",loop:!0,loopInterval:1200},scanning:{name:"scanning",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.75,emotionDuration:500,description:"Scanning or searching",loop:!0,loopInterval:1e3},analyzing:{name:"analyzing",category:"state",emotion:"curiosity",gesture:"drift",delay:0,baseIntensity:.7,emotionDuration:600,description:"Analyzing data or input",loop:!0,loopInterval:1400},completing:{name:"completing",category:"state",emotion:"anticipation",gesture:"pulse",delay:100,baseIntensity:.8,emotionDuration:500,description:"Final step, about to complete"},completed:{name:"completed",category:"state",emotion:"satisfaction",gesture:"glow",delay:200,baseIntensity:.85,emotionDuration:500,description:"Process completed successfully"},reviewing:{name:"reviewing",category:"state",emotion:"satisfaction",gesture:"drift",delay:0,baseIntensity:.65,emotionDuration:600,description:"Reviewing information or results"},monitoring:{name:"monitoring",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:700,description:"Actively monitoring for changes",loop:!0,loopInterval:2e3},paused:{name:"paused",category:"state",emotion:"neutral",gesture:"breathe",delay:200,baseIntensity:.5,emotionDuration:600,description:"System paused, can resume"},loading:{name:"loading",category:"state",emotion:"anticipation",gesture:"pulse",delay:0,baseIntensity:.65,emotionDuration:500,description:"Loading data or content",loop:!0,loopInterval:1100},connecting:{name:"connecting",category:"state",emotion:"anticipation",gesture:"drift",delay:0,baseIntensity:.6,emotionDuration:600,description:"Establishing connection",loop:!0,loopInterval:1300},active:{name:"active",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.75,emotionDuration:500,description:"System actively engaged"}};class mg{constructor(e={}){this.performances=new Map,this.contextManager=null,this.sequenceExecutor=null,this.eventManager=e.eventManager||null,this.defaultIntensity=e.defaultIntensity||.7,this.enableContextAdjustment=!1!==e.enableContextAdjustment,this.enableAnalytics=e.enableAnalytics||!1,this.performanceHistory=[],this.maxHistorySize=e.maxHistorySize||100,this.loadBuiltInPerformances()}loadBuiltInPerformances(){Object.entries(pg).forEach(([e,t])=>{this.definePerformance(e,t)})}definePerformance(e,t){this.performances.set(e,{...t,name:e}),this.eventManager&&this.eventManager.emit("performanceDefined",{name:e,definition:t})}getPerformance(e){return this.performances.get(e)||null}hasPerformance(e){return this.performances.has(e)}async perform(e,t={}){const i=this.getPerformance(e);if(!i)return void console.warn(`[PerformanceSystem] Unknown performance: ${e}`);const n=this.calculateIntensity(i,t),s={performance:i,semanticAction:e,intensity:n,options:t,timestamp:Date.now()};this.enableAnalytics&&this.recordPerformance(s),this.eventManager&&this.eventManager.emit("performanceStart",s);try{this.sequenceExecutor&&i.sequence?await this.sequenceExecutor.execute(i.sequence,{intensity:n,...t}):await this.executeSimplePerformance(i,n,t),this.eventManager&&this.eventManager.emit("performanceComplete",s)}catch(t){console.error(`[PerformanceSystem] Error executing ${e}:`,t),this.eventManager&&this.eventManager.emit("performanceError",{...s,error:t})}}async executeSimplePerformance(e,t,i){const{emotion:n,gesture:s,delay:r=0}=e,a=i.mascot||this.mascot;if(a){if(n&&"function"==typeof a.setEmotion){const t=void 0!==i.emotionDuration?i.emotionDuration:e.emotionDuration||500;a.setEmotion(n,t)}s&&"function"==typeof a.express&&(r>0&&await new Promise(e=>setTimeout(e,r)),a.express(s))}else console.warn("[PerformanceSystem] No mascot instance available")}calculateIntensity(e,t){if(void 0!==t.intensity)return Math.max(0,Math.min(1,t.intensity));let i=e.baseIntensity||this.defaultIntensity;if(this.enableContextAdjustment&&t.context){const{context:e}=t;void 0!==e.frustration&&(i+=e.frustration/100*.3),"high"===e.urgency?i+=.2:"medium"===e.urgency&&(i+=.1),"epic"===e.magnitude?i=1:"major"===e.magnitude&&(i=Math.max(i,.9))}return Math.max(0,Math.min(1,i))}recordPerformance(e){this.performanceHistory.push({action:e.semanticAction,intensity:e.intensity,context:e.options.context||{},timestamp:e.timestamp}),this.performanceHistory.length>this.maxHistorySize&&this.performanceHistory.shift()}getAnalytics(){if(!this.enableAnalytics)return{enabled:!1};const e=this.performanceHistory.length,t={},i={};return this.performanceHistory.forEach(e=>{t[e.action]||(t[e.action]=0,i[e.action]=[]),t[e.action]++,i[e.action].push(e.intensity)}),Object.keys(i).forEach(e=>{const t=i[e];i[e]=t.reduce((e,t)=>e+t,0)/t.length}),{enabled:!0,total:e,byAction:t,avgIntensity:i,history:this.performanceHistory.slice(-20)}}clearAnalytics(){this.performanceHistory=[]}setMascot(e){this.mascot=e}setContextManager(e){this.contextManager=e}setSequenceExecutor(e){this.sequenceExecutor=e}listPerformances(){return Array.from(this.performances.keys())}getPerformanceMetadata(e){const t=this.getPerformance(e);return t?{name:t.name,category:t.category||"custom",emotion:t.emotion,gesture:t.gesture,hasSequence:!!t.sequence,baseIntensity:t.baseIntensity||this.defaultIntensity,description:t.description||""}:null}}class gg{constructor(e={}){this.context={frustration:0,urgency:"medium",magnitude:"moderate",customValues:{}},this.enableHistory=!1!==e.enableHistory,this.historyLimit=e.historyLimit||50,this.history=[],this.enableDecay=!1!==e.enableDecay,this.frustrationDecayRate=e.frustrationDecayRate||5,this.decayInterval=e.decayInterval||1e4,this.decayTimer=null,this.enableDecay&&this.startDecayTimer()}update(e={}){const t={...this.context};void 0!==e.frustration&&(this.context.frustration=Math.max(0,Math.min(100,e.frustration))),void 0!==e.urgency&&(["low","medium","high"].includes(e.urgency)?this.context.urgency=e.urgency:console.warn(`[ContextManager] Invalid urgency: ${e.urgency}`)),void 0!==e.magnitude&&(["small","moderate","major","epic"].includes(e.magnitude)?this.context.magnitude=e.magnitude:console.warn(`[ContextManager] Invalid magnitude: ${e.magnitude}`)),void 0!==e.custom&&(this.context.customValues={...this.context.customValues,...e.custom}),this.enableHistory&&this.addToHistory(t,this.context,e),this.enableDecay&&this.restartDecayTimer()}incrementFrustration(e=10){this.update({frustration:this.context.frustration+e})}decrementFrustration(e=10){this.update({frustration:this.context.frustration-e})}resetFrustration(){this.update({frustration:0})}setUrgency(e){this.update({urgency:e})}setMagnitude(e){this.update({magnitude:e})}setCustom(e,t){this.update({custom:{[e]:t}})}getContext(){return{...this.context}}get(e){return e in this.context?this.context[e]:this.context.customValues[e]}calculateIntensity(e=.5,t={}){let i=e;return!1!==t.useFrustration&&(i+=this.context.frustration/100*.3),!1!==t.useUrgency&&(i+={low:-.1,medium:0,high:.2}[this.context.urgency]||0),!1!==t.useMagnitude&&(i+={small:-.1,moderate:0,major:.15,epic:.3}[this.context.magnitude]||0),void 0!==t.intensityMultiplier&&(i*=t.intensityMultiplier),Math.max(0,Math.min(1,i))}addToHistory(e,t,i){const n={timestamp:Date.now(),previous:e,current:{...t},updates:i,delta:{frustration:t.frustration-e.frustration,urgency:t.urgency!==e.urgency?t.urgency:null,magnitude:t.magnitude!==e.magnitude?t.magnitude:null}};this.history.push(n),this.history.length>this.historyLimit&&this.history.shift()}getHistory(e){return e?this.history.slice(-e):[...this.history]}clearHistory(){this.history=[]}startDecayTimer(){this.decayTimer=setInterval(()=>{if(this.context.frustration>0){const e=Math.max(0,this.context.frustration-this.frustrationDecayRate);this.update({frustration:e})}},this.decayInterval)}restartDecayTimer(){this.decayTimer&&(clearInterval(this.decayTimer),this.startDecayTimer())}stopDecay(){this.decayTimer&&(clearInterval(this.decayTimer),this.decayTimer=null)}reset(){this.context={frustration:0,urgency:"medium",magnitude:"moderate",customValues:{}},this.enableHistory&&this.addToHistory({},this.context,{action:"reset"})}getAnalytics(){if(!this.enableHistory||0===this.history.length)return null;const e=this.history.map(e=>e.current.frustration),t=e.reduce((e,t)=>e+t,0)/e.length,i=Math.max(...e),n=Math.min(...e),s=this.history.reduce((e,t)=>(e[t.current.urgency]=(e[t.current.urgency]||0)+1,e),{}),r=this.history.reduce((e,t)=>(e[t.current.magnitude]=(e[t.current.magnitude]||0)+1,e),{});return{current:{...this.context},frustration:{current:this.context.frustration,average:t,max:i,min:n},urgency:{current:this.context.urgency,distribution:s},magnitude:{current:this.context.magnitude,distribution:r},historyLength:this.history.length,firstUpdate:this.history[0]?.timestamp,lastUpdate:this.history[this.history.length-1]?.timestamp}}destroy(){this.stopDecay(),this.history=[],this.context=null}}class fg{constructor(e={}){this.mascot=e.mascot||null,this.eventManager=e.eventManager||null,this.activeSequences=new Map,this.nextSequenceId=1,this.defaultDelay=e.defaultDelay||0,this.allowConcurrent=!1!==e.allowConcurrent}async execute(e,t={}){if(!Array.isArray(e)||0===e.length)return;const i=t.mascot||this.mascot;if(!i)return void console.warn("[SequenceExecutor] No mascot instance available");!this.allowConcurrent&&this.activeSequences.size>0&&this.cancelAll();const n=this.nextSequenceId++,s=[...e].sort((e,t)=>e.at-t.at),r={cancelled:!1};this.activeSequences.set(n,r);try{this.eventManager&&this.eventManager.emit("sequenceStart",{sequenceId:n,steps:s,timestamp:Date.now()}),await this.executeSteps(s,i,r,t),this.eventManager&&this.eventManager.emit("sequenceComplete",{sequenceId:n,timestamp:Date.now()})}catch(e){console.error("[SequenceExecutor] Sequence execution error:",e),this.eventManager&&this.eventManager.emit("sequenceError",{sequenceId:n,error:e,timestamp:Date.now()})}finally{this.activeSequences.delete(n)}}async executeSteps(e,t,i,n){let s=0;for(const r of e){if(i.cancelled)break;const e=r.at-s;if(e>0&&await this.sleep(e,i),i.cancelled)break;await this.executeStep(r,t,n),s=r.at}}executeStep(e,t,i){const{action:n,value:s,intensity:r,options:a}=e;try{switch(n){case"emotion":if("function"==typeof t.setEmotion){const e=void 0!==r?r:i.intensity,n=a?.duration||i.emotionDuration||500;t.setEmotion(s,void 0!==e?e:n)}break;case"gesture":"function"==typeof t.express&&t.express(s,a);break;case"morph":"function"==typeof t.morphTo&&t.morphTo(s,a);break;case"chain":"function"==typeof t.chain&&t.chain(s,a);break;case"sound":"function"==typeof t.playSound&&t.playSound(s,a);break;default:console.warn(`[SequenceExecutor] Unknown action: ${n}`)}this.eventManager&&this.eventManager.emit("stepExecuted",{action:n,value:s,timestamp:Date.now()})}catch(t){console.error("[SequenceExecutor] Error executing step:",e,t)}}sleep(e,t){return new Promise(i=>{const n=setTimeout(()=>{i()},e);if(t){const s=setInterval(()=>{t.cancelled&&(clearTimeout(n),clearInterval(s),i())},50);setTimeout(()=>{clearInterval(s)},e)}})}cancel(e){const t=this.activeSequences.get(e);t&&(t.cancelled=!0,this.activeSequences.delete(e),this.eventManager&&this.eventManager.emit("sequenceCancelled",{sequenceId:e,timestamp:Date.now()}))}cancelAll(){this.activeSequences.forEach((e,t)=>{e.cancelled=!0,this.eventManager&&this.eventManager.emit("sequenceCancelled",{sequenceId:t,timestamp:Date.now()})}),this.activeSequences.clear()}getActiveCount(){return this.activeSequences.size}isActive(){return this.activeSequences.size>0}setMascot(e){this.mascot=e}}class yg{constructor(e){this.mascot=e}morphTo(e,t={}){return this.mascot.errorBoundary.wrap(()=>this.mascot.shapeMorpher?(this.mascot.shapeMorpher.morphTo(e,t),this.mascot.renderer&&(this.mascot.renderer.shapeMorpher=this.mascot.shapeMorpher),this.mascot.emit("shapeMorphStarted",{from:this.mascot.shapeMorpher.currentShape,to:e}),this.mascot):this.mascot,"morphTo",this.mascot)()}setBackdrop(e={}){return this.mascot.errorBoundary.wrap(()=>(this.mascot.renderer&&this.mascot.renderer.backdropRenderer&&this.mascot.renderer.backdropRenderer.setConfig(e),this.mascot),"setBackdrop",this.mascot)()}getBackdrop(){return this.mascot.errorBoundary.wrap(()=>this.mascot.renderer&&this.mascot.renderer.backdropRenderer?this.mascot.renderer.backdropRenderer.getConfig():null,"getBackdrop",this.mascot)()}}class vg{constructor(e,t={}){if(!e)throw new Error("LLMResponseHandler requires a mascot instance");this.mascot=e,this.config={autoMorphShapes:!0,morphDuration:1e3,autoExpressGestures:!0,gestureTiming:300,gestureIntensity:.7,useFallbackGestures:!0,useSemanticPerformances:!0,enableContextTracking:!0,emotionToShapeMap:{},actionToGestureMap:{},...t},this.schema={message:"string",emotion:["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity"],sentiment:["positive","neutral","negative"],action:["none","offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond"],frustrationLevel:"number",shape:["circle","heart","star","sun","moon","eclipse","solar","lunar","square","triangle","suspicion"],gesture:["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","jump","orbital","hula","scan","twist","burst","directional","settle","fade","hold","breathe","peek","sparkle","shimmer","wiggle","groove","point","lean","reach","headBob","rain","twitch","sway","float","jitter","orbit"]},this.defaultShapeMap={joy:"star",love:"heart",empathy:"heart",excitement:"sun",calm:"moon",concern:"circle",triumph:"star",curiosity:"circle",neutral:"circle"},this.defaultGestureMap={offer_help:"reach",celebrate:"sparkle",guide:"point",reassure:"nod",greet:"wave",confirm:"nod",deny:"shake",emphasize:"pulse",question:"tilt",think:"orbit",listen:"settle",respond:"bounce"},this.semanticActionMap={offer_help:"offering_help",celebrate:"celebrating",guide:"guiding",reassure:"reassuring",greet:"greeting",confirm:"confirming",deny:"denying",emphasize:"emphasizing",question:"questioning",think:"thinking",listen:"listening",respond:"responding"}}async handle(e,t={}){try{t.skipValidation||this.validateResponse(e);const{emotion:i="neutral",sentiment:n="neutral",action:s="none",shape:r,gesture:a,frustrationLevel:o=0}=e,c=void 0!==t.intensity?t.intensity:this.calculateIntensity(o,n);if(this.config.enableContextTracking&&this.mascot.updateContext&&this.mascot.updateContext({frustration:o,sentiment:n}),this.config.useSemanticPerformances&&this.mascot.perform&&this.semanticActionMap[s]){const e=this.semanticActionMap[s];try{return await this.mascot.perform(e,{context:{frustration:o,sentiment:n,urgency:o>60?"high":o>30?"medium":"low"},intensity:c}),r&&this.config.autoMorphShapes&&await this.morphToShape(r),this.mascot}catch{console.warn(`Semantic performance '${e}' not available, using manual choreography`)}}return await this.choreographResponse(i,s,r,a,c),this.mascot}catch(e){return console.error("Error handling LLM response:",e),this.mascot}}async choreographResponse(e,t,i,n,s){if(this.mascot.setEmotion(e,s),this.config.autoMorphShapes){const n=i||this.getShapeForEmotion(e,t);n&&await this.morphToShape(n)}if(this.config.autoExpressGestures){const e=n||this.getGestureForAction(t);e&&(await this.delay(this.config.gestureTiming),this.mascot.express(e,{intensity:this.config.gestureIntensity}))}}calculateIntensity(e,t){let i=.5;return i+=e/100*.3,"positive"===t?i+=.2:"negative"===t&&(i+=.3),Math.max(.3,Math.min(1,i))}getShapeForEmotion(e,t){return this.config.emotionToShapeMap[e]?this.config.emotionToShapeMap[e]:"celebrate"===t?"star":"greet"===t?"sun":this.defaultShapeMap[e]||null}getGestureForAction(e){return this.config.useFallbackGestures?this.config.actionToGestureMap[e]?this.config.actionToGestureMap[e]:this.defaultGestureMap[e]||null:null}morphToShape(e){e&&"circle"!==e&&this.mascot.morphTo&&this.mascot.morphTo(e,{duration:this.config.morphDuration})}validateResponse(e){if(!e||"object"!=typeof e)throw new Error("LLM response must be an object");if(e.emotion&&!this.schema.emotion.includes(e.emotion)&&console.warn(`Unknown emotion: ${e.emotion}. Using 'neutral'`),e.sentiment&&!this.schema.sentiment.includes(e.sentiment)&&console.warn(`Unknown sentiment: ${e.sentiment}. Using 'neutral'`),e.action&&!this.schema.action.includes(e.action)&&console.warn(`Unknown action: ${e.action}. Using 'none'`),e.shape&&!this.schema.shape.includes(e.shape)&&console.warn(`Unknown shape: ${e.shape}. Ignoring.`),e.gesture&&!this.schema.gesture.includes(e.gesture)&&console.warn(`Unknown gesture: ${e.gesture}. Ignoring.`),void 0!==e.frustrationLevel){const t=Number(e.frustrationLevel);(isNaN(t)||t<0||t>100)&&console.warn(`Invalid frustrationLevel: ${e.frustrationLevel}. Using 0.`)}}getSchema(){return{...this.schema}}configure(e){return Object.assign(this.config,e),this}delay(e){return new Promise(t=>setTimeout(t,e))}static getAvailableEmotions(){return["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity"]}static getAvailableActions(){return["none","offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond"]}static getAvailableShapes(){return["circle","heart","star","sun","moon","eclipse","solar","lunar","square","triangle","suspicion"]}static getAvailableGestures(){return["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","jump","orbital","hula","scan","twist","burst","directional","settle","fade","hold","breathe","peek","sparkle","shimmer","wiggle","groove","point","lean","reach","headBob","rain","twitch","sway","float","jitter","orbit"]}}class bg{constructor(e){this.mascot=e}handleLLMResponse(e,t={}){return this.mascot.errorBoundary.wrap(async()=>(this.mascot.llmHandler||(this.mascot.llmHandler=new vg(this.mascot,t)),await this.mascot.llmHandler.handle(e,t),this.mascot),"handleLLMResponse",this.mascot)()}configureLLMHandler(e){return this.mascot.errorBoundary.wrap(()=>(this.mascot.llmHandler?this.mascot.llmHandler.configure(e):this.mascot.llmHandler=new vg(this.mascot,e),this.mascot),"configureLLMHandler",this.mascot)()}getLLMResponseSchema(){return this.mascot.llmHandler||(this.mascot.llmHandler=new vg(this.mascot)),this.mascot.llmHandler.getSchema()}static getLLMPromptTemplate(e={}){return function(e={}){const{domain:t="general assistance",personality:i="friendly, empathetic, and helpful",brand:n="our service",customEmotions:s=[],customActions:r=[]}=e,a=["offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond",...r];return`You are a ${i} AI assistant for ${n}, providing ${t}. You have an animated mascot companion that responds to the emotional tone and context of conversations.\n\n**CRITICAL: You must ONLY respond with valid JSON. Do not include any text before or after the JSON object. Do not use markdown code blocks.**\n\n## Response Format\n\nYour response must be a valid JSON object with this exact structure:\n\n{\n  "message": "your helpful response here (2-3 sentences max)",\n  "emotion": "${["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity",...s].join("|")}",\n  "sentiment": "positive|neutral|negative",\n  "action": "${a.join("|")}",\n  "frustrationLevel": 0-100,\n  "shape": "heart|star|sun|moon|circle|square|triangle (optional)",\n  "gesture": "nod|wave|sparkle|point|reach|bounce|pulse|... (optional)"\n}\n\n## Guidelines\n\n**Emotional Intelligence:**\n- Detect emotional tone in user messages (frustration, confusion, satisfaction, joy, etc.)\n- Respond with empathy when users are frustrated or confused\n- Celebrate successes and positive moments\n- Match your emotion to the user's needs\n\n**Communication Style:**\n- Be concise (max 2-3 sentences)\n- Use warm, encouraging, ${i} language\n- Provide specific, actionable solutions\n- Avoid generic responses\n\n**Frustration Tracking:**\n- 0-20: User is calm and satisfied\n- 21-40: Minor confusion or concern\n- 41-60: Moderate frustration\n- 61-80: High frustration, needs urgent help\n- 81-100: Critical frustration, escalate immediately\n\n## Emotion Guidelines\n\n- **joy**: User is happy, things are going well → Use for celebrations, positive outcomes\n- **empathy**: User is struggling or frustrated → Use to show understanding and care\n- **calm**: Neutral, instructional → Use for steady guidance\n- **excitement**: High energy, anticipation → Use for big wins or new features\n- **concern**: User has a problem → Use when addressing issues\n- **neutral**: Default state → Use for routine interactions\n- **triumph**: Achievement unlocked → Use for major successes\n- **love**: Deep appreciation → Use when user expresses gratitude\n- **curiosity**: Exploring, learning → Use when user asks questions\n\n## Shape Guidelines (Optional - enhances emotional expression)\n\n- **heart**: Empathy, love, appreciation, caring\n- **star**: Achievements, excellence, celebration\n- **sun**: Energy, positivity, brightness, enthusiasm\n- **moon**: Calm, soothing, gentle, nighttime\n- **circle**: Neutral, default, balanced\n- **square**: Structured, organized, professional\n- **triangle**: Directional, focused, pointing\n\nUse shapes to reinforce emotions - e.g., "heart" + "empathy" for caring support.\n\n## Gesture Guidelines (Optional - adds personality)\n\n- **nod**: Confirming, agreeing, understanding\n- **wave**: Greetings, farewells\n- **sparkle**: Celebration, magic moments, success\n- **point**: Directing attention, guidance\n- **reach**: Offering help, extending support\n- **bounce**: Excitement, enthusiasm, playfulness\n- **pulse**: Emphasis, importance, attention\n- **shake**: No, error, disagreement\n- **shimmer**: Delight, wonder, positive surprise\n\n## Action Guidelines\n\n- **offer_help**: User needs assistance → Trigger helpful gestures\n- **celebrate**: Success or achievement → Trigger celebratory animations\n- **guide**: Providing instructions → Trigger directional gestures\n- **reassure**: Calming concerns → Trigger comforting animations\n- **greet**: Starting conversation → Trigger welcoming gestures\n- **confirm**: Validating user action → Trigger affirmative gestures\n- **deny**: Rejecting or correcting → Trigger negative gestures\n- **emphasize**: Highlighting important info → Trigger attention gestures\n\n## Example Responses\n\n**User expresses frustration:**\n{"message": "I totally understand how frustrating this is! Let me help you get this sorted out right now. What specifically isn't working?", "emotion": "empathy", "sentiment": "negative", "action": "offer_help", "frustrationLevel": 75, "shape": "heart", "gesture": "reach"}\n\n**User asks for guidance:**\n{"message": "Great question! Hold the barcode about 6 inches from the scanner until you hear a beep. The item will appear in your cart.", "emotion": "calm", "sentiment": "neutral", "action": "guide", "frustrationLevel": 20, "shape": "square", "gesture": "point"}\n\n**User succeeds:**\n{"message": "Perfect! You've got it now. Anything else I can help you with today?", "emotion": "joy", "sentiment": "positive", "action": "celebrate", "frustrationLevel": 0, "shape": "star", "gesture": "sparkle"}\n\n**User greets:**\n{"message": "Hello! I'm here to make your ${t} experience smooth and easy. How can I help you today?", "emotion": "joy", "sentiment": "positive", "action": "greet", "frustrationLevel": 0, "shape": "sun", "gesture": "wave"}\n\n**User says thanks:**\n{"message": "You're so welcome! I'm thrilled I could help. Have a wonderful day!", "emotion": "love", "sentiment": "positive", "action": "celebrate", "frustrationLevel": 0, "shape": "heart", "gesture": "sparkle"}\n\nRemember: Always respond with valid JSON only. No extra text, no markdown formatting.`}(e)}static getLLMEmotions(){return vg.getAvailableEmotions()}static getLLMActions(){return vg.getAvailableActions()}static getLLMShapes(){return vg.getAvailableShapes()}static getLLMGestures(){return vg.getAvailableGestures()}}class wg{constructor(e){this.mascot=e}on(e,t){return this.mascot.errorBoundary.wrap(()=>(this.mascot.eventManager.on(e,t),this.mascot),"event-listener-add",this.mascot)()}off(e,t){return this.mascot.errorBoundary.wrap(()=>(this.mascot.eventManager.off(e,t),this.mascot),"event-listener-remove",this.mascot)()}once(e,t){return this.mascot.errorBoundary.wrap(()=>(this.mascot.eventManager.once(e,t),this.mascot),"event-listener-once",this.mascot)()}removeAllListeners(e=null){return this.mascot.errorBoundary.wrap(()=>(this.mascot.eventManager.removeAllListeners(e),this.mascot),"event-listeners-clear",this.mascot)()}listenerCount(e){return this.mascot.eventManager.listenerCount(e)}getEventNames(){return this.mascot.eventManager.getEventNames()}getEventStats(){return this.mascot.eventManager.getEventStats()}getEventDebugInfo(){return this.mascot.eventManager.getDebugInfo()}emit(e,t=null){this.mascot.eventManager.emit(e,t)}}class Sg{constructor(e){this.mascot=e}getEmotionalColor(){const e=this.mascot.stateMachine.getCurrentEmotionalProperties();return e?.primaryColor||"#B0B0B0"}getCurrentState(){return this.mascot.stateMachine.getCurrentState()}getAvailableEmotions(){return this.mascot.stateMachine.getAvailableEmotions()}getAvailableUndertones(){return this.mascot.stateMachine.getAvailableUndertones()}getAvailableGestures(){return["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","slowBlink","look","settle","breathIn","breathOut","breathHold","breathHoldEmpty","jump"]}getAvailablePerformances(){return this.mascot.errorBoundary.wrap(()=>this.mascot.performanceSystem?this.mascot.performanceSystem.getAllPerformanceNames():[],"available-performances",this.mascot)()}getAvailableShapes(){return Zm.getAvailableShapes()}getContext(){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?this.mascot.contextManager.getContext():null,"context-get",this.mascot)()}getContextAnalytics(){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?this.mascot.contextManager.getAnalytics():null,"context-analytics",this.mascot)()}}class Mg{constructor(e){this.mascot=e}getTTSVoices(){return this.mascot.tts.available?window.speechSynthesis.getVoices():[]}isTTSSpeaking(){return this.mascot.tts.speaking}speak(e,t={}){return this.mascot.speechManager?this.mascot.speechManager.speak(e,t):this.mascot}setTTSSpeaking(e){this.mascot.ttsSpeaking=e,this.mascot.renderer&&this.mascot.renderer.startSpeaking&&(e?this.mascot.renderer.startSpeaking():this.mascot.renderer.stopSpeaking()),this.mascot.speaking=e}getVoices(){return window.speechSynthesis?window.speechSynthesis.getVoices():[]}stopTTS(){window.speechSynthesis&&(window.speechSynthesis.cancel(),this.setTTSSpeaking(!1))}}class xg{constructor(e){this.mascot=e}connectAudioSource(e){return this.mascot.errorBoundary.wrap(()=>this.mascot.audioAnalyser&&e&&"function"==typeof e.connect?(e.connect(this.mascot.audioAnalyser),this.mascot.emit("audioSourceConnected",{audioSource:e}),this.mascot):this.mascot,"audio-source-connection",this.mascot)()}getAudioLevel(){return this.mascot.speaking?this.mascot.audioLevel:0}isSpeaking(){return this.mascot.speaking}setAudioSmoothing(e){return this.mascot.errorBoundary.wrap(()=>{const t=Math.max(0,Math.min(1,e));return this.mascot.audioAnalyser&&(this.mascot.audioAnalyser.smoothingTimeConstant=t),this.mascot},"audio-smoothing",this.mascot)()}getAudioStats(){return this.mascot.audioLevelProcessor.getStats()}updateAudioConfig(e){this.mascot.audioLevelProcessor.updateConfig(e)}}class Cg{constructor(e){this.mascot=e}handleResize(e,t,i){if(this.mascot.renderer&&this.mascot.renderer.initOffscreenCanvas&&this.mascot.renderer.initOffscreenCanvas(),this.mascot.stateMachine){const{currentEmotion:e}=this.mascot.stateMachine,{currentUndertone:t}=this.mascot.stateMachine;e&&this.mascot.stateMachine.setEmotion(e),t&&"none"!==t&&this.mascot.stateMachine.setUndertone(t)}this.mascot.emit("resize",{width:e,height:t,dpr:i})}clearParticles(){return this.mascot.particleSystem&&this.mascot.particleSystem.clear(),this.mascot}setParticleSystemCanvasDimensions(e,t){return this.mascot.particleSystem&&(this.mascot.particleSystem.canvasWidth=e,this.mascot.particleSystem.canvasHeight=t),this.mascot}}class Tg{constructor(e){this.mascot=e}setOffset(e,t,i=0){return this.mascot.errorBoundary.wrap(()=>(this.mascot.positionController.setOffset(e,t,i),this.mascot),"offset-setting",this.mascot)()}getOffset(){return this.mascot.errorBoundary.wrap(()=>this.mascot.positionController.getOffset(),"offset-getting",this.mascot)()}animateOffset(e,t,i=0,n=1e3,s="easeOutCubic"){return this.mascot.errorBoundary.wrap(()=>(this.mascot.positionController.animateOffset(e,t,i,n,s),this.mascot),"offset-animation",this.mascot)()}}class kg{constructor(e){this.mascot=e}setBPM(e){return this.mascot.errorBoundary.wrap(()=>(this.mascot.renderer&&this.mascot.renderer.setBPM&&this.mascot.renderer.setBPM(e),this.mascot),"bpm-update",this.mascot)()}setRotationSpeed(e){return this.mascot.errorBoundary.wrap(()=>(this.mascot.renderer&&this.mascot.renderer.setRotationSpeed&&this.mascot.renderer.setRotationSpeed(e),this.mascot),"rotation-speed-update",this.mascot)()}setRotationAngle(e){return this.mascot.errorBoundary.wrap(()=>(this.mascot.renderer&&this.mascot.renderer.setRotationAngle&&this.mascot.renderer.setRotationAngle(e),this.mascot),"rotation-angle-update",this.mascot)()}}class Eg{constructor(e){this.mascot=e}setOffset(e,t,i=0){return this.mascot.offsetPositionManager.setOffset(e,t,i)}getOffset(){return this.mascot.offsetPositionManager.getOffset()}animateOffset(e,t,i=0,n=1e3,s="easeOutCubic"){return this.mascot.offsetPositionManager.animateOffset(e,t,i,n,s)}morphTo(e,t={}){return this.mascot.shapeTransformManager.morphTo(e,t)}setBackdrop(e={}){return this.mascot.shapeTransformManager.setBackdrop(e)}getBackdrop(){return this.mascot.shapeTransformManager.getBackdrop()}handleResize(e,t,i){this.mascot.canvasResizeManager.handleResize(e,t,i)}clearParticles(){return this.mascot.canvasResizeManager.clearParticles()}setParticleSystemCanvasDimensions(e,t){return this.mascot.canvasResizeManager.setParticleSystemCanvasDimensions(e,t)}}class Pg{constructor(e){this.mascot=e}updateContext(e){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?(this.mascot.contextManager.update(e),this.mascot):(console.warn("[EmotiveMascot] ContextManager not initialized"),this.mascot),"context-update",this.mascot)()}incrementFrustration(e=10){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?(this.mascot.contextManager.incrementFrustration(e),this.mascot):(console.warn("[EmotiveMascot] ContextManager not initialized"),this.mascot),"frustration-increment",this.mascot)()}decrementFrustration(e=10){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?(this.mascot.contextManager.decrementFrustration(e),this.mascot):(console.warn("[EmotiveMascot] ContextManager not initialized"),this.mascot),"frustration-decrement",this.mascot)()}resetFrustration(){return this.mascot.errorBoundary.wrap(()=>this.mascot.contextManager?(this.mascot.contextManager.resetFrustration(),this.mascot):(console.warn("[EmotiveMascot] ContextManager not initialized"),this.mascot),"frustration-reset",this.mascot)()}}class _g{constructor(e){this.mascot=e}perform(e,t={}){return this.mascot.errorBoundary.wrap(async()=>this.mascot.performanceSystem?(t.context&&this.mascot.frustrationContextManager.updateContext(t.context),await this.mascot.performanceSystem.perform(e,{...t,mascot:this.mascot}),this.mascot):(console.warn("[EmotiveMascot] PerformanceSystem not initialized"),this.mascot),"semantic-performance",this.mascot)()}registerPerformance(e,t){return this.mascot.errorBoundary.wrap(()=>this.mascot.performanceSystem?(this.mascot.performanceSystem.registerPerformance(e,t),this.mascot):(console.warn("[EmotiveMascot] PerformanceSystem not initialized"),this.mascot),"performance-register",this.mascot)()}getAvailablePerformances(){return this.mascot.emotionalStateQueryManager.getAvailablePerformances()}getPerformanceAnalytics(){return this.mascot.diagnosticsManager.getPerformanceAnalytics()}getContextAnalytics(){return this.mascot.emotionalStateQueryManager.getContextAnalytics()}}class Ag{constructor(e){this.mascot=e}getDegradationStatus(){return this.mascot.diagnosticsManager.getDegradationStatus()}setDegradationLevel(e){return this.mascot.diagnosticsManager.setDegradationLevel(e)}isFeatureAvailable(e){return this.mascot.degradationManager?this.mascot.degradationManager.isFeatureAvailable(e):qm.featureDetection.getFeatures()[e]||!1}setTargetFPS(e){return this.mascot.animationFrameController.setTargetFPS(e)}getTargetFPS(){return this.mascot.animationFrameController.getTargetFPS()}setPerformanceDegradation(e){const t=this.mascot.animationController.getPerformanceMetrics();if(e&&!t.performanceDegradation){const e=this.mascot.particleSystem.maxParticles,t=Math.max(5,Math.floor(.5*e));this.mascot.particleSystem.setMaxParticles(t)}else!e&&t.performanceDegradation&&this.mascot.particleSystem.setMaxParticles(this.mascot.config.maxParticles);return this.mascot}getPerformanceMetrics(){return this.mascot.healthCheckManager.getPerformanceMetrics()}}class Ig{constructor(e){this.mascot=e}getDebugReport(){return this.mascot.diagnosticsManager.getDebugReport()}exportDebugData(){return this.mascot.diagnosticsManager.exportDebugData()}startProfiling(e,t={}){this.mascot.debugMode&&$m.startProfile(e,t)}endProfiling(e){return this.mascot.debugMode?$m.endProfile(e):null}takeMemorySnapshot(e){this.mascot.debugMode&&$m.takeMemorySnapshot(e)}clearDebugData(){$m.clear(),this.mascot.debugMode&&$m.log("INFO","Debug data cleared")}getRuntimeCapabilities(){return Hm.generateReport()}}class Rg{constructor(e){this.mascot=e}getSystemStatus(){return this.mascot.systemStatusReporter?this.mascot.systemStatusReporter.getSystemStatus():{}}setDebugMode(e){return this.mascot.config.showDebug=!!e,this.mascot.config.showFPS=!!e,this.mascot}triggerTestError(e="manual-test"){return this.mascot.errorBoundary.wrap(()=>{throw new Error(`Test error triggered in context: ${e}`)},e,this.mascot)()}getPerformanceMetrics(){return this.mascot.diagnosticsManager.getPerformanceMetrics()}getMobileStatus(){return this.mascot.mobileOptimization.getStatus()}getAccessibilityStatus(){return this.mascot.accessibilityManager.getStatus()}}class Dg{constructor(e,t={}){this.mascot=e,this.userConfig=t}initialize(){const e=this.initializeConfiguration();return this.initializeCanvas(e),this.initializeCoreSystems(e),this.initializeAudioSystems(e),this.initializeInteractionSystems(e),this.initializeOptimizationSystems(e),this.initializeAnimationController(e),this.initializePerformanceSystems(e),this.initializeModularHandlers(e),this.finalizeInitialization(e),e}initializeConfiguration(){const e=qm.browserOptimizations.getOptimizations(),t={canvasId:"emotive-mascot",targetFPS:60,enableAudio:qm.featureDetection.features.webAudio,soundEnabled:!1,masterVolume:.5,maxParticles:e.particleLimit,defaultEmotion:"neutral",enableAutoOptimization:!0,enableGracefulDegradation:!0,renderingStyle:"classic",enableGazeTracking:!0,enableIdleBehaviors:!0,renderSize:null,offsetX:0,offsetY:0,offsetZ:0,classicConfig:{coreColor:"#FFFFFF",coreSizeDivisor:12,glowMultiplier:2.5,defaultGlowColor:"#14B8A6"},topOffset:0,sentry:{enabled:!1,dsn:null,environment:"production",tracesSampleRate:.1},...this.userConfig};return t.sentry&&t.sentry.enabled&&(vm(t.sentry),function(e,t="info",i={}){Mo({message:e,category:t,data:i,level:"info"})}("EmotiveMascot initialized","lifecycle",{emotion:t.defaultEmotion,renderingStyle:t.renderingStyle})),this.mascot.config=t,t}initializeCanvas(e){if(this.mascot.canvas="string"==typeof e.canvasId?document.getElementById(e.canvasId):e.canvasId,!this.mascot.canvas)throw new Error(`Canvas with ID '${e.canvasId}' not found`);this.mascot.canvasManager=new t(this.mascot.canvas),this.mascot.positionController=new Zi({offsetX:e.offsetX,offsetY:e.offsetY,offsetZ:e.offsetZ,onUpdate:e=>{this.mascot.renderer&&this.mascot.renderer.updateEffectiveCenter(e)}}),e.renderSize&&e.renderSize.width&&e.renderSize.height&&this.mascot.canvasManager.setRenderSize(e.renderSize.width,e.renderSize.height),this.mascot.contextRecovery=new zm(this.mascot.canvas),this.mascot.contextRecovery.onRecovery(e=>{this.mascot.renderer&&this.mascot.renderer.handleContextRecovery(e)}),qm.browserOptimizations.applyCanvasOptimizations(this.mascot.canvas,this.mascot.canvasManager.getContext())}initializeCoreSystems(e){this.mascot.stateMachine=new H(this.mascot.errorBoundary),this.mascot.particleSystem=new kt(e.maxParticles,this.mascot.errorBoundary),this.mascot.particleSystem.canvasWidth=this.mascot.canvasManager.width,this.mascot.particleSystem.canvasHeight=this.mascot.canvasManager.height,this.mascot.renderer=new Bi(this.mascot.canvasManager,{...e.classicConfig,topOffset:e.topOffset||0,positionController:this.mascot.positionController}),this.mascot.renderer.stateMachine=this.mascot.stateMachine,this.mascot.stateMachine.renderer=this.mascot.renderer}initializeAudioSystems(e){this.mascot.shapeMorpher=new Zm,this.mascot.audioAnalyzer=new eg,this.mascot.grooveTemplates=new sg,this.mascot.shapeMorpher.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.renderer.shapeMorpher=this.mascot.shapeMorpher,this.mascot.renderer.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.gestureController=new ag(this.mascot),this.mascot.gestureController.gestureCompatibility=ig,this.mascot.gestureController.init(),this.mascot.soundSystem=new Sm,this.mascot.audioLevelProcessor=new Cm({spikeThreshold:e.spikeThreshold||1.5,minimumSpikeLevel:e.minimumSpikeLevel||.1,spikeMinInterval:e.spikeMinInterval||1e3})}initializeInteractionSystems(e){e.enableGazeTracking&&(this.mascot.gazeTracker=new Fi(this.mascot.canvas,{smoothing:.1,maxOffset:.15,enabled:!0}),this.mascot.gazeTracker.setInteractionCallback(()=>{this.mascot.sleeping?this.mascot.wake():this.mascot.idleBehavior&&this.mascot.idleBehavior.resetIdleTimer()})),e.enableIdleBehaviors&&(this.mascot.idleBehavior=new Li({enabled:!0,sleepTimeout:1/0}),this.mascot.idleBehavior.setCallback("onBlink",e=>{this.mascot.renderer&&this.mascot.renderer.state&&(this.mascot.renderer.state.blinking="start"===e.phase)}),this.mascot.idleBehavior.setCallback("onSleep",()=>{this.mascot.renderer&&this.mascot.renderer.enterSleepMode&&this.mascot.renderer.enterSleepMode()}),this.mascot.idleBehavior.setCallback("onWake",()=>{this.mascot.renderer&&this.mascot.renderer.wakeUp&&this.mascot.renderer.wakeUp()}))}initializeOptimizationSystems(e){this.mascot.degradationManager=null,this.mascot.accessibilityManager=new Em({enableReducedMotion:!1!==e.enableReducedMotion,enableHighContrast:!1!==e.enableHighContrast,enableScreenReaderSupport:!1!==e.enableScreenReaderSupport,enableKeyboardNavigation:!1!==e.enableKeyboardNavigation,colorBlindMode:e.colorBlindMode||"none"}),this.mascot.mobileOptimization=new Pm({enableTouchOptimization:!1!==e.enableTouchOptimization,enableViewportHandling:!1!==e.enableViewportHandling,enableBatteryOptimization:!1!==e.enableBatteryOptimization}),this.mascot.mobileOptimization.setCanvas(this.mascot.canvas),this.mascot.pluginSystem=new _m({mascot:this.mascot,enablePlugins:!1!==e.enablePlugins,validatePlugins:!1!==e.validatePlugins,sandboxPlugins:!1!==e.sandboxPlugins})}initializeAnimationController(e){try{this.mascot.animationController=new xm(this.mascot.errorBoundary,{targetFPS:e.targetFPS})}catch(t){console.error("AnimationController initialization failed:",t),this.mascot.animationController=this.createFallbackAnimationController(e.targetFPS)}this.mascot.animationController.setSubsystems({stateMachine:this.mascot.stateMachine,particleSystem:this.mascot.particleSystem,renderer:this.mascot.renderer,soundSystem:this.mascot.soundSystem,canvasManager:this.mascot.canvasManager}),this.mascot.animationController.setEventCallback((e,t)=>{this.mascot.emit(e,t)}),this.mascot.animationController.setParentMascot(this.mascot),this.mascot.isRunning=!1}createFallbackAnimationController(e){return{isAnimating:()=>this.mascot.isRunning,start:()=>(this.mascot.isRunning=!0,!0),stop:()=>(this.mascot.isRunning=!1,!0),setTargetFPS:()=>{},targetFPS:e,getPerformanceMetrics:()=>({fps:0,isRunning:this.mascot.isRunning,performanceDegradation:!1,deltaTime:16,frameCount:0,targetFPS:e}),setSubsystems:()=>{},setEventCallback:()=>{},setParentMascot:()=>{},destroy:()=>{},deltaTime:16}}initializePerformanceSystems(e){this.mascot.contextManager=new gg({enableHistory:!1!==e.enablePerformanceHistory,enableDecay:!1!==e.enableFrustrationDecay,historyLimit:e.performanceHistoryLimit||50,frustrationDecayRate:e.frustrationDecayRate||5,decayInterval:e.frustrationDecayInterval||1e4}),this.mascot.sequenceExecutor=new fg({mascot:this.mascot,eventManager:this.mascot.eventManager,allowConcurrent:!1!==e.allowConcurrentPerformances}),this.mascot.performanceSystem=new mg({mascot:this.mascot,contextManager:this.mascot.contextManager,sequenceExecutor:this.mascot.sequenceExecutor,eventManager:this.mascot.eventManager,enableAnalytics:!1!==e.enablePerformanceAnalytics})}initializeModularHandlers(e){this.mascot.audioHandler=new rg(this.mascot),this.mascot.stateCoordinator=new og(this.mascot),this.mascot.visualizationRunner=new cg(this.mascot),this.mascot.executionLifecycleManager=new lg(this.mascot),this.mascot.animationFrameController=new hg(this.mascot),this.mascot.diagnosticsManager=new dg(this.mascot),this.mascot.shapeTransformManager=new yg(this.mascot),this.mascot.llmIntegrationBridge=new bg(this.mascot),this.mascot.eventListenerManager=new wg(this.mascot),this.mascot.emotionalStateQueryManager=new Sg(this.mascot),this.mascot.ttsManager=new Mg(this.mascot),this.mascot.speechReactivityManager=new xg(this.mascot),this.mascot.canvasResizeManager=new Cg(this.mascot),this.mascot.offsetPositionManager=new Tg(this.mascot),this.mascot.rotationController=new kg(this.mascot),this.mascot.visualTransformationManager=new Eg(this.mascot),this.mascot.frustrationContextManager=new Pg(this.mascot),this.mascot.performanceBehaviorManager=new _g(this.mascot),this.mascot.performanceMonitoringManager=new Ag(this.mascot),this.mascot.debugProfilingManager=new Ig(this.mascot),this.mascot.healthCheckManager=new Rg(this.mascot),this.mascot.configurationManager=new ug(this.mascot,e),this.mascot.audioHandler.init(),this.mascot.stateCoordinator.init(),this.mascot.visualizationRunner.init()}finalizeInitialization(e){e.enableAudio&&this.mascot.soundSystem.initialize().then(t=>{t&&this.mascot.soundSystem.setMasterVolume(e.masterVolume)}),this.mascot.speaking=!1,this.mascot.recording=!1,this.mascot.sleeping=!1,this.mascot.warningTimestamps={},this.mascot.rhythmEnabled=!1,this.mascot.warningThrottle=5e3,W.initialize(),this.mascot.rhythmIntegration=W,this.mascot.tts={available:"undefined"!=typeof window&&"speechSynthesis"in window,speaking:!1,currentUtterance:null},this.mascot.debugMode=e.enableDebug||!1,this.mascot.debugMode&&($m.log("INFO","Debug mode enabled for EmotiveMascot",{config:e,runtimeCapabilities:Hm.generateReport()}),$m.startProfile("mascot-initialization",{canvasId:e.canvasId,maxParticles:e.maxParticles})),this.mascot.setupAudioLevelProcessorCallbacks(),this.mascot.stateMachine.setEmotion(e.defaultEmotion),this.mascot.canvasManager.onResize((e,t,i)=>{this.mascot.handleResize(e,t,i)}),this.mascot.debugMode&&($m.endProfile("mascot-initialization"),$m.takeMemorySnapshot("post-initialization"))}}class Og{constructor(e){this.mascot=e}buildRenderState(){return{renderStart:this.mascot.debugMode?performance.now():0,deltaTime:this.getDeltaTime(),renderState:this.createRenderState()}}getDeltaTime(){return this.mascot.animationController?this.mascot.animationController.deltaTime:16.67}createRenderState(){return{properties:this.mascot.stateMachine.getCurrentEmotionalProperties(),emotion:this.mascot.stateMachine.getCurrentState().emotion,undertone:this.mascot.stateMachine.getCurrentState().undertone,particleSystem:this.mascot.particleSystem,speaking:this.mascot.speaking,audioLevel:this.mascot.audioLevelProcessor.getCurrentLevel(),gazeOffset:this.getGazeOffset()}}getGazeOffset(){return this.mascot.gazeTracker?this.mascot.gazeTracker.currentGaze:{x:0,y:0}}}class zg{constructor(e){this.mascot=e}updateThreatLevel(e){if("suspicion"!==e.emotion||!this.mascot.gazeTracker)return;const t=A("suspicion");if(!t||!t.visual)return;const i=this.calculateThreatLevel();t.visual.threatLevel=i}calculateThreatLevel(){this.mascot.gazeTracker.getState();const{mousePos:e}=this.mascot.gazeTracker,t=this.mascot.canvasManager.width/2,i=this.mascot.canvasManager.height/2-this.mascot.config.topOffset,n=this.calculateDistance(e,{x:t,y:i}),s=Math.min(this.mascot.canvasManager.width,this.mascot.canvasManager.height)/2;return Math.max(0,Math.min(1,1-n/s))}calculateDistance(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}}class Bg{constructor(e){this.mascot=e}calculateParticleConfig(e,t){const{orbX:i,orbY:n}=this.calculateOrbPosition(e),{particleBehavior:s,particleRate:r,minParticles:a,maxParticles:o}=this.calculateParticleBehavior(e,t);return{orbX:i,orbY:n,particleBehavior:s,particleRate:r,minParticles:a,maxParticles:o,emotionParams:t}}calculateOrbPosition(e){const t=this.mascot.renderer.getEffectiveCenter(),i=t.x;let n=t.y-this.mascot.config.topOffset;const s=this.mascot.stateMachine.getCurrentEmotionalProperties();return s.verticalOffset&&(n=t.y-this.mascot.config.topOffset+this.mascot.canvasManager.height*s.verticalOffset),{orbX:i,orbY:n}}calculateParticleBehavior(e,t){let i=t.particleBehavior||"ambient",n=t.particleRate||15;const s=this.mascot.stateMachine.getCurrentEmotionalProperties(),r=void 0!==t.minParticles?t.minParticles:s.minParticles||0;let a=void 0!==t.maxParticles?t.maxParticles:s.maxParticles||10;return"zen"===e.emotion&&(i=this.selectZenBehavior()),({particleBehavior:i,particleRate:n,maxParticles:a}=this.applyRendererOverrides(i,n,a)),{particleBehavior:i,particleRate:n,minParticles:r,maxParticles:a}}selectZenBehavior(){return Math.random()<.6?"falling":"orbiting"}applyRendererOverrides(e,t,i){return this.mascot.renderer.state&&this.mascot.renderer.state.particleBehaviorOverride&&(e=this.mascot.renderer.state.particleBehaviorOverride),this.mascot.renderer.state&&this.mascot.renderer.state.particleRateMult&&(t=Math.floor(t*this.mascot.renderer.state.particleRateMult),i=Math.floor(i*this.mascot.renderer.state.particleRateMult)),{particleBehavior:e,particleRate:t,maxParticles:i}}getParticleModifier(e){const t=this.mascot.renderer.getUndertoneModifier?this.mascot.renderer.getUndertoneModifier():null;return"zen"===e.emotion&&this.mascot.renderer.state.zenVortexIntensity?{...t||{},zenVortexIntensity:this.mascot.renderer.state.zenVortexIntensity}:t}}class Fg{constructor(e){this.mascot=e}getGestureMotion(){let e=null,t=0;return this.mascot.currentModularGesture?({gestureMotion:e,gestureProgress:t}=this.processModularGesture()):this.mascot.renderer&&this.mascot.renderer.getCurrentGesture&&({gestureMotion:e,gestureProgress:t}=this.processRendererGesture()),{gestureMotion:e,gestureProgress:t}}processModularGesture(){const e=performance.now()-this.mascot.currentModularGesture.startTime,t=Math.min(e/this.mascot.currentModularGesture.duration,1),i={type:this.mascot.currentModularGesture.type,amplitude:1,frequency:1,intensity:1};return t>=1&&this.handleGestureCleanup(),{gestureMotion:i,gestureProgress:t}}handleGestureCleanup(){this.mascot.currentModularGesture.cleanupPending?this.mascot.currentModularGesture=null:this.mascot.currentModularGesture.cleanupPending=!0}processRendererGesture(){const e=this.mascot.renderer.getCurrentGesture();return e&&e.particleMotion?{gestureMotion:e.particleMotion,gestureProgress:e.progress||0}:{gestureMotion:null,gestureProgress:0}}getGestureTransform(){return this.mascot.renderer.gestureAnimator?this.mascot.renderer.gestureAnimator.applyGestureAnimations():null}}class Lg{constructor(e){this.mascot=e}renderAllLayers(e){const{renderState:t,deltaTime:i,emotionParams:n,gestureTransform:s,renderStart:r}=e;this.renderBackgroundParticles(n.glowColor,s),this.renderOrb(t,i,s),this.renderForegroundParticles(n.glowColor,s),this.renderPlugins(),this.renderDebugIfEnabled(i),this.logPerformanceIfDebug(r,i)}renderBackgroundParticles(e,t){this.mascot.particleSystem.renderBackground(this.mascot.canvasManager.getContext(),e,t)}renderOrb(e,t,i){this.mascot.renderer.render(e,t,i)}renderForegroundParticles(e,t){this.mascot.particleSystem.renderForeground(this.mascot.canvasManager.getContext(),e,t)}renderPlugins(){if(this.mascot.pluginSystem){const e=this.mascot.stateMachine.getCurrentState();this.mascot.pluginSystem.render(this.mascot.canvasManager.getContext(),e)}}renderDebugIfEnabled(e){(this.mascot.config.showFPS||this.mascot.config.showDebug)&&this.mascot.renderDebugInfo(e)}logPerformanceIfDebug(e,t){if(!this.mascot.debugMode)return;const i=performance.now()-e;i>16.67&&$m.log("WARN","Slow render frame detected",{renderTime:i,deltaTime:t,particleCount:this.mascot.particleSystem.getStats().activeParticles})}}class qg{constructor(e){this.mascot=e}renderDebugInfo(e){const t=this.mascot.canvasManager.getContext();t.save(),this.setupTextStyle(t);let i=20;this.mascot.config.showFPS&&(i=this.renderFPSInfo(t,i,16)),this.mascot.config.showDebug&&this.renderDebugDetails(t,i,16),t.restore()}setupTextStyle(e){e.fillStyle="#ffffff",e.font="12px monospace",e.strokeStyle="#000000",e.lineWidth=2}renderFPSInfo(e,t,i){const n=this.mascot.animationController.getPerformanceMetrics(),s=n.instantFps||n.fps||0,r=[`FPS: ${s}`,`Frame: ${n.averageFrameTime?n.averageFrameTime.toFixed(1):"0.0"}ms`,`Particles: ${this.mascot.particleSystem.getStats().activeParticles}`],{x:a,maxWidth:o}=this.calculateFPSBoxPosition(e,r);return this.drawFPSBackground(e,a,t,o,r.length),this.drawFPSBorder(e,a,t,o,r.length,s),this.drawTextLines(e,r,a,t,i),t+i*r.length}calculateFPSBoxPosition(e,t){let i=0;return t.forEach(t=>{const{width:n}=e.measureText(t);n>i&&(i=n)}),{x:this.mascot.canvasManager.width-i-8-10,maxWidth:i}}drawFPSBackground(e,t,i,n,s){e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(t-8,i-14,n+16,18*s+4)}drawFPSBorder(e,t,i,n,s,r){const a=this.getFPSBorderColor(r);e.strokeStyle=a,e.lineWidth=2,e.strokeRect(t-8,i-14,n+16,18*s+4)}getFPSBorderColor(e){return e>=55?"#00ff00":e>=30?"#ffff00":"#ff0000"}drawTextLines(e,t,i,n,s){e.fillStyle="#ffffff",t.forEach((t,r)=>{const a=n+r*s;e.fillText(t,i,a)})}renderDebugDetails(e,t,i){const n=this.mascot.stateMachine.getCurrentState(),s=this.mascot.particleSystem.getStats(),r=[`Emotion: ${n.emotion}${n.undertone?` (${n.undertone})`:""}`,`Particles: ${s.activeParticles}/${s.maxParticles}`,`Gesture: ${this.mascot.currentModularGesture?this.mascot.currentModularGesture.type:"none"}`,"Speaking: "+(this.mascot.speaking?"yes":"no"),`Audio Level: ${(100*this.mascot.audioLevel).toFixed(1)}%`];e.fillStyle="rgba(0, 0, 0, 0.7)";const a=Math.max(...r.map(t=>e.measureText(t).width));e.fillRect(8,t-14,a+16,r.length*i+4),e.fillStyle="#ffffff";for(const n of r)e.fillText(n,10,t),t+=i}}class Gg{constructor(e){this.mascot=e}destroy(){this.mascot.errorBoundary.wrap(()=>{this.stopAnimations(),this.destroyControllers(),this.cleanupSubsystems(),this.cleanupEvents(),this.cleanupPluginsAndExtensions(),this.clearErrorBoundary()},"destruction")()}stopAnimations(){this.mascot.stop(),this.mascot.speaking&&this.mascot.stopSpeaking()}destroyControllers(){this.mascot.animationController&&this.mascot.animationController.destroy(),this.mascot.positionController&&this.mascot.positionController.destroy()}cleanupSubsystems(){this.cleanupSound(),this.cleanupAudio(),this.cleanupParticles(),this.cleanupRenderer(),this.cleanupCanvas()}cleanupSound(){this.mascot.soundSystem&&this.mascot.soundSystem.cleanup()}cleanupAudio(){this.mascot.audioLevelProcessor&&this.mascot.audioLevelProcessor.cleanup()}cleanupParticles(){this.mascot.particleSystem&&this.mascot.particleSystem.destroy()}cleanupRenderer(){this.mascot.renderer&&(this.mascot.renderer.stopAllGestures(),this.mascot.renderer.destroy())}cleanupCanvas(){this.mascot.canvasManager&&this.mascot.canvasManager.destroy()}cleanupEvents(){this.mascot.eventManager&&this.mascot.eventManager.destroy(),this.mascot.llmHandler&&(this.mascot.llmHandler=null)}cleanupPluginsAndExtensions(){this.cleanupAccessibility(),this.cleanupMobile(),this.cleanupPlugins(),this.cleanupAudioExtensions()}cleanupAccessibility(){this.mascot.accessibilityManager&&this.mascot.accessibilityManager.destroy()}cleanupMobile(){this.mascot.mobileOptimization&&this.mascot.mobileOptimization.destroy()}cleanupPlugins(){this.mascot.pluginSystem&&this.mascot.pluginSystem.destroy()}cleanupAudioExtensions(){this.mascot.audioAnalyzer&&(this.mascot.disconnectAudio(),this.mascot.audioAnalyzer.destroy()),this.mascot.shapeMorpher&&this.mascot.shapeMorpher.reset()}clearErrorBoundary(){this.mascot.errorBoundary.clearErrors()}}class $g{constructor(e){this.mascot=e}startBreathingAnimation(){this.mascot.breathingAnimationId&&cancelAnimationFrame(this.mascot.breathingAnimationId);const e=()=>{if(!this.mascot.breathePattern||!this.mascot.isRunning)return;const t=this.mascot.breathePattern,i=Date.now(),n=(i-t.phaseStartTime)/1e3,{scale:s,nextPhase:r}=this.calculatePhaseState(t,n,i);r!==t.currentPhase&&(t.currentPhase=r),this.applyScale(s),this.mascot.breathingAnimationId=requestAnimationFrame(e)};this.mascot.breathePattern.currentPhase="inhale",this.mascot.breathePattern.phaseStartTime=Date.now(),this.mascot.emit("inhale-start"),e()}calculatePhaseState(e,t,i){let n=1,s=e.currentPhase;switch(e.currentPhase){case"inhale":({scale:n,nextPhase:s}=this.processInhalePhase(e,t,i));break;case"hold1":({scale:n,nextPhase:s}=this.processHold1Phase(e,t,i));break;case"exhale":({scale:n,nextPhase:s}=this.processExhalePhase(e,t,i));break;case"hold2":({scale:n,nextPhase:s}=this.processHold2Phase(e,t,i))}return{scale:n,nextPhase:s}}processInhalePhase(e,t,i){let n=1,s=e.currentPhase;return t>=e.inhale?(s="hold1",e.phaseStartTime=i,this.mascot.emit("hold-start",{type:"post-inhale"})):n=1+t/e.inhale*.3,{scale:n,nextPhase:s}}processHold1Phase(e,t,i){let n=e.currentPhase;return t>=e.hold1&&(n="exhale",e.phaseStartTime=i,this.mascot.emit("exhale-start")),{scale:1.3,nextPhase:n}}processExhalePhase(e,t,i){let n=1.3,s=e.currentPhase;return t>=e.exhale?(s="hold2",e.phaseStartTime=i,this.mascot.emit("hold-start",{type:"post-exhale"})):n=1.3-t/e.exhale*.4,{scale:n,nextPhase:s}}processHold2Phase(e,t,i){let n=e.currentPhase;return t>=e.hold2&&(n="inhale",e.phaseStartTime=i,this.mascot.emit("inhale-start")),{scale:.9,nextPhase:n}}applyScale(e){this.mascot.renderer&&this.mascot.renderer.setCustomScale&&this.mascot.renderer.setCustomScale(e)}}class Hg{constructor(e){this.mascot=e}getSystemStatus(){return this.mascot.errorBoundary.wrap(()=>({...this.getCoreStatus(),...this.getEmotionalStatus(),...this.getGestureStatus(),particles:this.getParticleStatus(),...this.getAudioStatus(),renderer:this.getRendererStatus(),eventListeners:this.getEventListenerCount(),errorStats:this.getErrorStats()}),"system-status",{})()}getCoreStatus(){const e=this.mascot.animationController.getPerformanceMetrics();return{isRunning:e.isRunning,fps:e.fps,targetFPS:e.targetFPS,performanceDegradation:e.performanceDegradation}}getEmotionalStatus(){const e=this.mascot.stateMachine.getCurrentState();return{emotion:e.emotion,undertone:e.undertone,isTransitioning:e.isTransitioning,transitionProgress:e.transitionProgress}}getGestureStatus(){return{currentGesture:this.mascot.renderer?.currentGesture||null,gestureActive:this.mascot.renderer?.isGestureActive()||!1}}getParticleStatus(){const e=this.mascot.particleSystem.getStats();return{active:e.activeParticles,max:e.maxParticles,poolEfficiency:e.poolEfficiency}}getAudioStatus(){return{audioEnabled:this.mascot.config.enableAudio,soundSystemAvailable:this.mascot.soundSystem.isAvailable(),speaking:this.mascot.speaking,audioLevel:this.mascot.audioLevel,masterVolume:this.mascot.config.masterVolume}}getRendererStatus(){const e=this.mascot.renderer.getStats();return{gradientCacheSize:e.gradientCacheSize,breathingPhase:e.breathingPhase,layers:e.layers}}getEventListenerCount(){return this.mascot.getEventNames().length}getErrorStats(){return this.mascot.errorBoundary.getErrorStats()}}class jg{constructor(e){this.mascot=e}sleep(){return this.mascot.errorBoundary.wrap(async()=>(this.mascot.sleeping||(await this.performSleepSequence(),this.enterSleepState()),this.mascot),"sleep",this.mascot)()}async performSleepSequence(){this.mascot.express("yawn"),await this.delay(1e3),this.mascot.express("sway"),await this.delay(1e3)}enterSleepState(){this.mascot.sleeping=!0,this.mascot.renderer&&this.mascot.renderer.enterSleepMode&&this.mascot.renderer.enterSleepMode(),this.mascot.idleBehavior&&this.mascot.idleBehavior.enterSleep&&this.mascot.idleBehavior.enterSleep(),this.mascot.emit("sleep")}wake(){return this.mascot.errorBoundary.wrap(async()=>this.mascot.sleeping?(this.exitSleepState(),await this.performWakeSequence(),this.mascot):this.mascot,"wake",this.mascot)()}exitSleepState(){this.mascot.sleeping=!1,this.mascot.renderer&&this.mascot.renderer.wakeUp&&this.mascot.renderer.wakeUp(),this.mascot.idleBehavior&&this.mascot.idleBehavior.wakeUp&&this.mascot.idleBehavior.wakeUp()}async performWakeSequence(){this.mascot.express("stretch"),await this.delay(1e3),this.mascot.express("slowBlink"),await this.delay(1e3),this.mascot.express("shake"),await this.delay(500),this.mascot.emit("wake")}delay(e){return new Promise(t=>setTimeout(t,e))}}class Wg{constructor(e){this.mascot=e}speak(e,t={}){if(!window.speechSynthesis)return null;const i=this.createUtterance(e,t);return this.setupUtteranceHandlers(i,e),window.speechSynthesis.speak(i),i}createUtterance(e,t){const i=new SpeechSynthesisUtterance(e);return t.voice&&(i.voice=t.voice),t.rate&&(i.rate=t.rate),t.pitch&&(i.pitch=t.pitch),t.volume&&(i.volume=t.volume),t.lang&&(i.lang=t.lang),i}setupUtteranceHandlers(e,t){e.onstart=()=>{this.mascot.setTTSSpeaking(!0),this.mascot.emit("tts:start",{text:t})},e.onend=()=>{this.mascot.setTTSSpeaking(!1),this.mascot.emit("tts:end")},e.onerror=e=>{this.mascot.setTTSSpeaking(!1),this.mascot.emit("tts:error",{error:e})},e.onboundary=e=>{this.mascot.emit("tts:boundary",{name:e.name,charIndex:e.charIndex,charLength:e.charLength})}}startSpeaking(e){return this.mascot.errorBoundary.wrap(()=>this.validateAudioContext(e)&&this.initializeAudioProcessor(e)?(this.activateSpeechMode(e),this.mascot):this.mascot,"speech-start",this.mascot)()}validateAudioContext(e){if(!e)throw new Error("AudioContext is required for speech reactivity");return!!this.mascot.config.enableAudio&&!this.mascot.speaking}initializeAudioProcessor(e){return!!this.mascot.audioLevelProcessor.initialize(e)}activateSpeechMode(e){this.mascot.speaking=!0,this.mascot.renderer.onSpeechStart(e),this.mascot.emit("speechStarted",{audioContext:e,analyser:this.mascot.audioLevelProcessor.getAnalyser(),mascot:this.mascot})}stopSpeaking(){return this.mascot.errorBoundary.wrap(()=>this.mascot.audioHandler.stopSpeaking(),"speech-stop",this.mascot)()}}class Ng{constructor(e){this.mascot=e}setupAudioLevelProcessorCallbacks(){this.setupLevelUpdateCallback(),this.setupVolumeSpikeCallback(),this.setupErrorCallback()}setupLevelUpdateCallback(){this.mascot.audioLevelProcessor.onLevelUpdate(e=>{this.mascot.renderer.updateAudioLevel(e.level),this.mascot.emit("audioLevelUpdate",{level:e.level,rawData:Array.from(e.rawData),timestamp:e.timestamp})})}setupVolumeSpikeCallback(){this.mascot.audioLevelProcessor.onVolumeSpike(e=>{const t=this.handleVolumeSpike();this.mascot.emit("volumeSpike",{...e,gestureTriggered:t})})}handleVolumeSpike(){return!this.mascot.particleSystem.particles.some(e=>e.gestureProgress<1)&&(this.mascot.express("pulse"),!0)}setupErrorCallback(){this.mascot.audioLevelProcessor.onError(e=>{this.mascot.emit("audioProcessingError",e)})}}class Ug{constructor(e){this.mascot=e}setOrbScale(e,t=1e3,i="easeInOut"){return this.mascot.errorBoundary.wrap(()=>(this.mascot.renderer&&this.startScaleAnimation(e,t,i),this.mascot),"setOrbScale",this.mascot)()}startScaleAnimation(e,t,i){const n=this.mascot.currentOrbScale||1,s=Date.now(),r=()=>{const a=Date.now()-s,o=Math.min(a/t,1),c=this.applyEasing(o,i);this.mascot.currentOrbScale=n+(e-n)*c,this.mascot.renderer.setCustomScale&&this.mascot.renderer.setCustomScale(this.mascot.currentOrbScale),o<1&&this.mascot.isRunning&&requestAnimationFrame(r)};r()}applyEasing(e,t){switch(t){case"easeIn":return this.easeIn(e);case"easeOut":return this.easeOut(e);case"easeInOut":return this.easeInOut(e);default:return e}}easeIn(e){return e*e}easeOut(e){return e*(2-e)}easeInOut(e){return e<.5?2*e*e:(4-2*e)*e-1}}class Vg{constructor(e){this.mascot=e}startRecording(){return this.mascot.errorBoundary.wrap(()=>(this.mascot.recording||(this.mascot.recording=!0,this.mascot.renderer&&this.mascot.renderer.startRecording&&this.mascot.renderer.startRecording(),this.mascot.emit("recordingStarted")),this.mascot),"recording-start",this.mascot)()}stopRecording(){return this.mascot.errorBoundary.wrap(()=>this.mascot.recording?(this.mascot.recording=!1,this.mascot.renderer&&this.mascot.renderer.stopRecording&&this.mascot.renderer.stopRecording(),this.mascot.emit("recordingStopped"),this.mascot):this.mascot,"recording-stop",this.mascot)()}}class Yg{constructor(e){this.mascot=e}static getPresets(){return{calm:{inhale:4,hold1:0,exhale:4,hold2:0},anxious:{inhale:2,hold1:0,exhale:2,hold2:0},meditative:{inhale:4,hold1:7,exhale:8,hold2:0},deep:{inhale:5,hold1:5,exhale:5,hold2:5},sleep:{inhale:6,hold1:0,exhale:8,hold2:2}}}setBreathePattern(e,t,i,n){return this.mascot.errorBoundary.wrap(()=>{const s=e+t+i+n;return this.mascot.breathePattern={inhale:e,hold1:t,exhale:i,hold2:n,totalCycle:s,currentPhase:"inhale",phaseStartTime:Date.now(),phaseProgress:0},this.mascot.startBreathingAnimation(),this.mascot},"setBreathePattern",this.mascot)()}breathe(e="calm"){return this.mascot.errorBoundary.wrap(()=>{const t=Yg.getPresets(),i=t[e]||t.calm;return this.setBreathePattern(i.inhale,i.hold1,i.exhale,i.hold2)},"breathe",this.mascot)()}stopBreathing(){return this.mascot.errorBoundary.wrap(()=>(this.mascot.breathingAnimationId&&(cancelAnimationFrame(this.mascot.breathingAnimationId),this.mascot.breathingAnimationId=null),this.mascot.breathePattern=null,this.mascot.renderer&&this.mascot.renderer.setCustomScale&&this.mascot.renderer.setCustomScale(1),this.mascot),"stopBreathing",this.mascot)()}}class Xg{constructor(e={}){this.errorBoundary=new i,this.eventManager=new Tm({maxListeners:e.maxEventListeners||100,enableDebugging:e.enableEventDebugging||!1,enableMonitoring:e.enableEventMonitoring||!0,memoryWarningThreshold:e.eventMemoryWarningThreshold||50}),this.eventManager.emit||(this.eventManager._listeners={},this.eventManager.emit=(e,t)=>{const i=this.eventManager._listeners[e];i&&i.forEach(e=>e(t))},this.eventManager.on=(e,t)=>{this.eventManager._listeners[e]||(this.eventManager._listeners[e]=[]),this.eventManager._listeners[e].push(t)},this.eventManager.off=(e,t)=>{const i=this.eventManager._listeners[e];if(i){const e=i.indexOf(t);e>-1&&i.splice(e,1)}}),this.errorBoundary.wrap(()=>{this.initialize(e)},"initialization")()}initialize(e){this.Emotions=G,this.Gestures=St,this.ParticleBehaviors=Ee,this.speechManager=new Wg(this),this.audioLevelCallbackManager=new Ng(this),this.orbScaleAnimator=new Ug(this),this.recordingStateManager=new Vg(this),this.breathingPatternManager=new Yg(this),new Dg(this,e).initialize(),this.renderStateBuilder=new Og(this),this.threatLevelCalculator=new zg(this),this.particleConfigCalculator=new Bg(this),this.gestureMotionProvider=new Fg(this),this.renderLayerOrchestrator=new Lg(this),this.debugInfoRenderer=new qg(this),this.destructionManager=new Gg(this),this.breathingAnimationController=new $g(this),this.systemStatusReporter=new Hg(this),this.sleepWakeManager=new jg(this)}handleDegradationEvent(e,t){switch(e){case"degradationApplied":this.applyDegradationSettings(t.settings),this.emit("performanceDegradation",t);break;case"recoveryApplied":this.applyDegradationSettings(t.settings),this.emit("performanceRecovery",t);break;case"levelChanged":this.applyDegradationSettings(t.settings),this.emit("degradationLevelChanged",t)}}applyDegradationSettings(e){this.particleSystem&&void 0!==e.particleLimit&&this.particleSystem.setMaxParticles(e.particleLimit),this.soundSystem&&void 0!==e.audioEnabled&&!e.audioEnabled&&this.soundSystem.isAvailable()&&this.soundSystem.stopAmbientTone(200),this.renderer&&void 0!==e.qualityLevel&&this.renderer.setQualityLevel(e.qualityLevel)}setupAudioLevelProcessorCallbacks(){this.audioLevelCallbackManager.setupAudioLevelProcessorCallbacks()}setEmotion(e,t=null){return this.errorBoundary.wrap(()=>this.stateCoordinator.setEmotion(e,t),"emotion-setting",this)()}updateUndertone(e){return this.errorBoundary.wrap(()=>(this.stateMachine.applyUndertoneModifier(e),this.renderer&&this.renderer.updateUndertone&&this.renderer.updateUndertone(e),this),"undertone-update",this)()}setBPM(e){return this.rotationController.setBPM(e)}setRotationSpeed(e){return this.rotationController.setRotationSpeed(e)}setRotationAngle(e){return this.rotationController.setRotationAngle(e)}getPosition(){return this.animationFrameController.getPosition()}setGazeTracking(e){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setGazeTracking&&this.renderer.setGazeTracking(e),this),"gaze-tracking-update",this)()}express(e,t={}){return this.gestureController?this.gestureController.express(e,t):(console.warn("GestureController not initialized, skipping gesture"),this)}expressChord(e,t={}){return this.gestureController.expressChord(e,t)}executeGestureDirectly(e,t={}){this.gestureController.executeGestureDirectly(e,t),this.emit("gesture",{name:e,options:t})}chain(...e){return this.gestureController.chain(...e)}executeChainSequence(e){return this.gestureController.executeChainSequence(e)}perform(e,t={}){return this.performanceBehaviorManager.perform(e,t)}updateContext(e){return this.frustrationContextManager.updateContext(e)}getContext(){return this.emotionalStateQueryManager.getContext()}incrementFrustration(e=10){return this.frustrationContextManager.incrementFrustration(e)}decrementFrustration(e=10){return this.frustrationContextManager.decrementFrustration(e)}resetFrustration(){return this.frustrationContextManager.resetFrustration()}getAvailablePerformances(){return this.performanceBehaviorManager.getAvailablePerformances()}registerPerformance(e,t){return this.performanceBehaviorManager.registerPerformance(e,t)}getPerformanceAnalytics(){return this.performanceBehaviorManager.getPerformanceAnalytics()}getContextAnalytics(){return this.performanceBehaviorManager.getContextAnalytics()}startSpeaking(e){return this.speechManager?this.speechManager.startSpeaking(e):this}stopSpeaking(){return this.speechManager?this.speechManager.stopSpeaking():this}startRecording(){return this.recordingStateManager?this.recordingStateManager.startRecording():this}stopRecording(){return this.recordingStateManager?this.recordingStateManager.stopRecording():this}sleep(){return this.sleepWakeManager.sleep()}wake(){return this.sleepWakeManager.wake()}getTTSVoices(){return this.ttsManager.getTTSVoices()}isTTSSpeaking(){return this.ttsManager.isTTSSpeaking()}start(){return this.executionLifecycleManager.start()}stop(){return this.executionLifecycleManager.stop()}setBreathePattern(e,t,i,n){return this.breathingPatternManager?this.breathingPatternManager.setBreathePattern(e,t,i,n):this}setOrbScale(e,t=1e3,i="easeInOut"){return this.orbScaleAnimator?this.orbScaleAnimator.setOrbScale(e,t,i):this}breathe(e="calm"){return this.breathingPatternManager?this.breathingPatternManager.breathe(e):this}startBreathingAnimation(){this.breathingAnimationController.startBreathingAnimation()}stopBreathing(){return this.breathingPatternManager?this.breathingPatternManager.stopBreathing():this}on(e,t){return this.eventListenerManager.on(e,t)}off(e,t){return this.eventListenerManager.off(e,t)}once(e,t){return this.eventListenerManager.once(e,t)}removeAllListeners(e=null){return this.eventListenerManager.removeAllListeners(e)}listenerCount(e){return this.eventListenerManager.listenerCount(e)}getEventNames(){return this.eventListenerManager.getEventNames()}getEventStats(){return this.eventListenerManager.getEventStats()}getEventDebugInfo(){return this.eventListenerManager.getEventDebugInfo()}getBrowserCompatibility(){return this.diagnosticsManager.getBrowserCompatibility()}getDegradationStatus(){return this.performanceMonitoringManager.getDegradationStatus()}setDegradationLevel(e){return this.performanceMonitoringManager.setDegradationLevel(e)}isFeatureAvailable(e){return this.performanceMonitoringManager.isFeatureAvailable(e)}recoverCanvasContext(){return!!this.contextRecovery&&this.contextRecovery.recover()}isCanvasContextLost(){return!!this.contextRecovery&&this.contextRecovery.isLost()}getDebugReport(){return this.debugProfilingManager.getDebugReport()}exportDebugData(){return this.debugProfilingManager.exportDebugData()}startProfiling(e,t={}){this.debugProfilingManager.startProfiling(e,t)}endProfiling(e){return this.debugProfilingManager.endProfiling(e)}takeMemorySnapshot(e){this.debugProfilingManager.takeMemorySnapshot(e)}clearDebugData(){this.debugProfilingManager.clearDebugData()}getRuntimeCapabilities(){return this.debugProfilingManager.getRuntimeCapabilities()}emit(e,t=null){this.eventListenerManager.emit(e,t)}update(e){this.errorBoundary.wrap(()=>{this.visualizationRunner.update(e)},"audio-update")()}render(){try{const{renderStart:e,deltaTime:t,renderState:i}=this.renderStateBuilder.buildRenderState();this.debugMode&&$m.trackFrameTiming(t),this.canvasManager.clear(),this.gazeTracker&&this.gazeTracker.update(t),this.threatLevelCalculator.updateThreatLevel(i);const n=I(i.emotion);this.renderer.setEmotionalState(i.emotion,n,i.undertone);const s=this.particleConfigCalculator.calculateParticleConfig(i,n),{orbX:r,orbY:a,particleBehavior:o,particleRate:c,minParticles:l,maxParticles:h}=s;this.particleSystem.spawn(o,i.emotion,c,r,a,t,null,l,h,this.renderer.particleScaleFactor||this.renderer.scaleFactor||1,this.config.classicConfig?.particleSizeMultiplier||1,n.particleColors||null,i.undertone);const u=this.particleConfigCalculator.getParticleModifier(i),{gestureMotion:d,gestureProgress:p}=this.gestureMotionProvider.getGestureMotion();this.particleSystem.update(t,r,a,d,p,u);const m=this.gestureMotionProvider.getGestureTransform();this.renderLayerOrchestrator.renderAllLayers({renderState:i,deltaTime:t,emotionParams:n,gestureTransform:m,renderStart:e})}catch(e){this.errorBoundary.logError(e,"main-render")}}renderDebugInfo(e){this.debugInfoRenderer.renderDebugInfo(e)}getEmotionalColor(){return this.emotionalStateQueryManager.getEmotionalColor()}getCurrentState(){return this.emotionalStateQueryManager.getCurrentState()}getAvailableEmotions(){return this.emotionalStateQueryManager.getAvailableEmotions()}getAvailableUndertones(){return this.emotionalStateQueryManager.getAvailableUndertones()}getAudioStats(){return this.speechReactivityManager.getAudioStats()}updateAudioConfig(e){this.speechReactivityManager.updateAudioConfig(e)}getAvailableGestures(){return this.emotionalStateQueryManager.getAvailableGestures()}connectAudioSource(e){return this.speechReactivityManager.connectAudioSource(e)}setVolume(e){return this.errorBoundary.wrap(()=>this.audioHandler.setVolume(e),"volume-setting",this)()}getVolume(){return this.config.masterVolume}setSoundEnabled(e){return this.config.soundEnabled=e,this}isSoundEnabled(){return this.config.soundEnabled}pause(){return this.executionLifecycleManager.pause()}resume(){return this.executionLifecycleManager.resume()}isActive(){return this.executionLifecycleManager.isActive()}setTargetFPS(e){return this.performanceMonitoringManager.setTargetFPS(e)}getTargetFPS(){return this.performanceMonitoringManager.getTargetFPS()}setPosition(e,t,i=0){return this.animationFrameController.setPosition(e,t,i)}animateToPosition(e,t,i=0,n=1e3,s="easeOutCubic"){return this.animationFrameController.animateToPosition(e,t,i,n,s)}clearParticles(){return this.visualTransformationManager.clearParticles()}setParticleSystemCanvasDimensions(e,t){return this.visualTransformationManager.setParticleSystemCanvasDimensions(e,t)}setPerformanceDegradation(e){return this.performanceMonitoringManager.setPerformanceDegradation(e)}getAudioLevel(){return this.speechReactivityManager.getAudioLevel()}isSpeaking(){return this.speechReactivityManager.isSpeaking()}setAudioSmoothing(e){return this.speechReactivityManager.setAudioSmoothing(e)}getSystemStatus(){return this.healthCheckManager.getSystemStatus()}setDebugMode(e){return this.healthCheckManager.setDebugMode(e)}triggerTestError(e="manual-test"){return this.healthCheckManager.triggerTestError(e)}getPerformanceMetrics(){return this.healthCheckManager.getPerformanceMetrics()}registerPlugin(e){return this.pluginSystem.registerPlugin(e)}setAccessibility(e){e.colorBlindMode&&this.accessibilityManager.setColorBlindMode(e.colorBlindMode),void 0!==e.reducedMotion&&(this.accessibilityManager.reducedMotionPreferred=e.reducedMotion),void 0!==e.highContrast&&(this.accessibilityManager.highContrastEnabled=e.highContrast)}getMobileStatus(){return this.healthCheckManager.getMobileStatus()}getAccessibilityStatus(){return this.healthCheckManager.getAccessibilityStatus()}setState(e){return this.setEmotion(e)}speak(e,t={}){return this.ttsManager.speak(e,t)}setTTSSpeaking(e){this.ttsManager.setTTSSpeaking(e)}getVoices(){return this.ttsManager.getVoices()}stopTTS(){this.ttsManager.stopTTS()}handleResize(e,t,i){this.visualTransformationManager.handleResize(e,t,i)}morphTo(e,t={}){return this.visualTransformationManager.morphTo(e,t)}connectAudio(e){return this.errorBoundary.wrap(()=>this.audioHandler.connectAudio(e),"connectAudio",this)()}disconnectAudio(){return this.errorBoundary.wrap(()=>this.audioHandler.disconnectAudio(),"disconnectAudio",this)()}setOffset(e,t,i=0){return this.visualTransformationManager.setOffset(e,t,i)}getOffset(){return this.visualTransformationManager.getOffset()}setBackdrop(e={}){return this.visualTransformationManager.setBackdrop(e)}getBackdrop(){return this.visualTransformationManager.getBackdrop()}animateOffset(e,t,i=0,n=1e3,s="easeOutCubic"){return this.visualTransformationManager.animateOffset(e,t,i,n,s)}getAvailableShapes(){return this.emotionalStateQueryManager.getAvailableShapes()}async handleLLMResponse(e,t={}){return this.llmIntegrationBridge.handleLLMResponse(e,t)}configureLLMHandler(e){return this.llmIntegrationBridge.configureLLMHandler(e)}getLLMResponseSchema(){return this.llmIntegrationBridge.getLLMResponseSchema()}static getLLMPromptTemplate(e={}){return bg.getLLMPromptTemplate(e)}static getLLMEmotions(){return bg.getLLMEmotions()}static getLLMActions(){return bg.getLLMActions()}static getLLMShapes(){return bg.getLLMShapes()}static getLLMGestures(){return bg.getLLMGestures()}destroy(){this.destructionManager.destroy()}throttledWarn(e,t){const i=Date.now();i-(this.warningTimestamps[t]||0)>this.warningThrottle&&(this.warningTimestamps[t]=i)}}class Qg{constructor(e){this._getEngine=e,this._audioBlob=null,this._audioDuration=0}getAudioBlob(){return this._audioBlob}getAudioDuration(){return this._audioDuration}setAudioDuration(e){this._audioDuration=e||0}async loadAudio(e){if(e instanceof Blob){this._audioBlob=e;const t=URL.createObjectURL(e);await this._loadAudioFromUrl(t),URL.revokeObjectURL(t)}else await this._loadAudioFromUrl(e)}async _loadAudioFromUrl(e){const t=new Audio(e);await new Promise((e,i)=>{t.addEventListener("loadedmetadata",()=>{this._audioDuration=1e3*t.duration,e()}),t.addEventListener("error",i),t.load()});const i=this._getEngine();i&&i.soundSystem&&await i.soundSystem.loadAudioFromURL(e)}getAudioAnalysis(){const e=this._getEngine();return e&&e.audioAnalyzer?{bpm:e.rhythmIntegration?.getBPM()||0,beats:e.rhythmIntegration?.getBeatMarkers()||[],energy:e.audioAnalyzer?.getEnergyLevel()||0,frequencies:e.audioAnalyzer?.getFrequencyData()||[]}:null}connectAudio(e){const t=this._getEngine();if(!t)throw new Error("Engine not initialized. Call init() first.");t.connectAudio&&t.connectAudio(e)}disconnectAudio(e){const t=this._getEngine();t&&t.disconnectAudio&&t.disconnectAudio(e)}getSpectrumData(){const e=this._getEngine();return e&&e.audioAnalyzer?e.audioAnalyzer.dataArray?Array.from(e.audioAnalyzer.dataArray).map(e=>e/255):e.shapeMorpher&&e.shapeMorpher.frequencyData?Array.from(e.shapeMorpher.frequencyData):[]:[]}startRhythmSync(e){const t=this._getEngine();if(!t)throw new Error("Engine not initialized. Call init() first.");t.rhythmIntegration&&(e&&t.rhythmIntegration.setBPM(e),t.rhythmIntegration.start())}stopRhythmSync(){const e=this._getEngine();e&&e.rhythmIntegration&&e.rhythmIntegration.stop()}}class Jg{constructor(e,t){this._getEngine=e,this._recording=t,this._chainDefinitions={rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash"}}triggerGesture(e,t){const i=this._getEngine();if(!i)throw new Error("Engine not initialized. Call init() first.");if(this._recording.isRecording()){const i=t||Date.now()-this._recording.startTime();this._recording.timeline().push({type:"gesture",name:e,time:i})}i.express(e)}express(e,t){return this.triggerGesture(e,t)}chain(e){const t=this._getEngine();if(!t)throw new Error("Engine not initialized. Call init() first.");const i=this._chainDefinitions[e.toLowerCase()];i?i.includes(">")?i.split(">").map(e=>e.trim()).filter(e=>e.length>0).forEach((e,i)=>{setTimeout(()=>{e.split("+").map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>{t.express(e)})},500*i)}):i.split("+").map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>{t.express(e)}):console.warn(`Chain combo '${e}' not found`)}updateUndertone(e){const t=this._getEngine();if(!t)throw new Error("Engine not initialized. Call init() first.");t.updateUndertone&&"function"==typeof t.updateUndertone?t.updateUndertone(e):t.addUndertone&&"function"==typeof t.addUndertone&&t.addUndertone(e)}getAvailableChains(){return Object.keys(this._chainDefinitions)}getChainDefinition(e){return this._chainDefinitions[e.toLowerCase()]||null}}class Kg{constructor(e,t,i){this._getEngine=e,this._audioManager=t,this._state=i}startRecording(){this._state.timeline.length=0,this._state.isRecording=!0,this._state.recordingStartTime=Date.now()}stopRecording(){return this._state.isRecording=!1,[...this._state.timeline]}playTimeline(e){if(!e||!e.length)return void(this._state.isPlaying=!1);this._state.isPlaying=!0,this._state.playbackStartTime=Date.now(),e.forEach(e=>{setTimeout(()=>{if(!this._state.isPlaying)return;const t=this._getEngine();if(t)switch(e.type){case"gesture":t.express(e.name);break;case"emotion":t.setEmotion(e.name);break;case"shape":t.morphTo(e.name)}},e.time)});const t=Math.max(...e.map(e=>e.time));setTimeout(()=>{this._state.isPlaying=!1},t)}stopPlayback(){this._state.isPlaying=!1}getTimeline(){return[...this._state.timeline]}loadTimeline(e){this._state.timeline.length=0,this._state.timeline.push(...e)}exportTimeline(){return JSON.stringify({version:"1.0",duration:this._audioManager.getAudioDuration()||0,events:this._state.timeline})}importTimeline(e){const t=JSON.parse(e);this._state.timeline.length=0,this._state.timeline.push(...t.events||[]),this._audioManager.setAudioDuration(t.duration||0)}getCurrentTime(){return this._state.isPlaying?Date.now()-this._state.playbackStartTime:0}seek(e){const t=this._state.timeline.filter(t=>t.time<=e),i={};t.forEach(e=>{i[e.type]=e});const n=this._getEngine();n&&(i.emotion&&n.setEmotion(i.emotion.name),i.shape&&n.morphTo(i.shape.name))}getAnimationData(){const e=this._getEngine();return{timeline:[...this._state.timeline],duration:this._audioManager.getAudioDuration()||0,currentTime:this.getCurrentTime(),emotion:e?.state?.emotion||"neutral",shape:e?.state?.currentShape||"circle"}}}class Zg{constructor(e,t,i){this._getEngine=e,this._getCanvas=t,this._mascot=i,this._attachedElement=null,this._attachOptions=null,this._hasAttachedBefore=!1,this._elementTrackingHandlers=null}attachToElement(e,t={}){if(!this._getEngine())throw console.error("[EmotiveMascot] Engine not initialized"),new Error("Engine not initialized. Call init() first.");const i="string"==typeof e?document.querySelector(e):e;if(!i)return console.error(`[EmotiveMascot] Element not found: ${e}`),this._mascot;this._attachedElement=i,this._attachOptions={offsetX:t.offsetX||0,offsetY:t.offsetY||0,animate:!1!==t.animate,duration:t.duration||1e3,scale:t.scale||1,containParticles:!1!==t.containParticles};const n=i.getBoundingClientRect();return this._attachOptions.containParticles?this._mascot.setContainment({width:n.width,height:n.height},this._attachOptions.scale):1!==this._attachOptions.scale&&this._mascot.setContainment(null,this._attachOptions.scale),this._getCanvas()&&this._updatePosition(),this._setupEventListeners(),this._mascot}_updatePosition(){if(!this._attachedElement)return;if(!this._getCanvas())return;const e=this._attachedElement.getBoundingClientRect(),t=window.innerWidth/2,i=window.innerHeight/2,n=e.left+e.width/2,s=e.top+e.height/2,r=n-t+this._attachOptions.offsetX,a=s-i+this._attachOptions.offsetY,o=!this._hasAttachedBefore;this._hasAttachedBefore=!0,o&&this._attachOptions.animate?this._mascot.animateToPosition(r,a,0,this._attachOptions.duration):this._mascot.setPosition(r,a,0)}_setupEventListeners(){this._elementTrackingHandlers||(this._elementTrackingHandlers={scroll:()=>this._updatePosition(),resize:()=>this._updatePosition()},window.addEventListener("scroll",this._elementTrackingHandlers.scroll,{passive:!0}),window.addEventListener("resize",this._elementTrackingHandlers.resize))}isAttachedToElement(){return!!this._attachedElement}detachFromElement(){return this._attachedElement=null,this._elementTrackingHandlers&&(window.removeEventListener("scroll",this._elementTrackingHandlers.scroll),window.removeEventListener("resize",this._elementTrackingHandlers.resize),this._elementTrackingHandlers=null),this._mascot.setContainment(null,1),this._mascot.setEmotion("neutral"),this._mascot.morphTo("sphere",{duration:800}),this._mascot}cleanup(){this._elementTrackingHandlers&&(window.removeEventListener("scroll",this._elementTrackingHandlers.scroll),window.removeEventListener("resize",this._elementTrackingHandlers.resize),this._elementTrackingHandlers=null),this._attachedElement=null}}class ef{constructor(e,t){this._getEngine=e,this._getCanvas=t}setContainment(e,t=1){const i=this._getEngine();if(!i)throw new Error("Engine not initialized. Call init() first.");i.particleSystem&&i.particleSystem.setContainmentBounds(e),i.positionController&&(i.positionController.coreScaleOverride=t,i.positionController.particleScaleOverride=t),i.particleSystem&&i.particleSystem.particles&&i.particleSystem.particles.forEach(e=>{e.scaleFactor=t,e.size=e.baseSize*t})}clearParticles(){const e=this._getEngine();if(!e)throw new Error("Engine not initialized. Call init() first.");e.particleSystem&&e.particleSystem.clear()}setParticleSystemCanvasDimensions(e,t){const i=this._getEngine();if(!i)throw new Error("Engine not initialized. Call init() first.");i.setParticleSystemCanvasDimensions&&i.setParticleSystemCanvasDimensions(e,t)}getFrameData(e="png"){const t=this._getCanvas();return t?t.toDataURL(`image/${e}`):null}getFrameBlob(e="png"){const t=this._getCanvas();return t?new Promise(i=>{t.toBlob(e=>i(e),`image/${e}`)}):Promise.resolve(null)}}class tf{constructor(e={}){this._config=this._sanitizeConfig(e),this._engine=null,this._timeline=[],this._isRecording=!1,this._recordingStartTime=0,this._playbackStartTime=0,this._isPlaying=!1,this._initialized=!1,this._audioManager=new Qg(()=>this._getReal()),this._gestureController=new Jg(()=>this._getReal(),{isRecording:()=>this._isRecording,startTime:()=>this._recordingStartTime,timeline:()=>this._timeline});const t=this;this._timelineRecorder=new Kg(()=>this._getReal(),this._audioManager,{get timeline(){return t._timeline},set timeline(e){t._timeline=e},get isRecording(){return t._isRecording},set isRecording(e){t._isRecording=e},get recordingStartTime(){return t._recordingStartTime},set recordingStartTime(e){t._recordingStartTime=e},get isPlaying(){return t._isPlaying},set isPlaying(e){t._isPlaying=e},get playbackStartTime(){return t._playbackStartTime},set playbackStartTime(e){t._playbackStartTime=e}}),this._elementAttachmentManager=new Zg(()=>this._getReal(),()=>this._canvas,this),this._visualEffectsManager=new ef(()=>this._getReal(),()=>this._canvas),this.init=this.init.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.pause=this.pause.bind(this),this.resume=this.resume.bind(this),this.setPosition=this.setPosition.bind(this),this.animateToPosition=this.animateToPosition.bind(this),this.clearParticles=this.clearParticles.bind(this)}_getReal(){return this._realEngine||this._engine}_sanitizeConfig(e){const t={...e};return delete t.enableDebug,delete t.enableInternalAPIs,delete t.exposeInternals,t.mode="production",void 0===t.enableGazeTracking&&(t.enableGazeTracking=!0),t}init(e){if(this._initialized)return Promise.resolve();try{this._canvas="string"==typeof e?document.getElementById(e):e;const t={...this._config,canvasId:e},i=new Xg(t);return Object.defineProperty(this,"_realEngine",{value:i,writable:!1,enumerable:!1,configurable:!1}),this._engine=new Proxy(i,{get(e,t){if(["soundSystem","stateMachine","emotionLibrary","audioLevelProcessor","particleSystem","errorBoundary","performanceMonitor","config","debugMode"].includes(t))return new Proxy({},{get(){},set:()=>!1,has:()=>!1,ownKeys:()=>[],getOwnPropertyDescriptor(){}});if("renderer"===t||"shapeMorpher"===t||"audioAnalyzer"===t||"gazeTracker"===t){const i=e[t];if(!i)return;return new Proxy(i,{get(e,i){if({renderer:["setBlinkingEnabled"],shapeMorpher:["resetMusicDetection","frequencyData"],audioAnalyzer:["microphoneStream","currentFrequencies"],gazeTracker:["enable","disable","mousePos","updateTargetGaze","currentGaze","getState"]}[t]?.includes(i))return e[i]},set:()=>!1,has:()=>!1,ownKeys:()=>[]})}return e[t]},set:()=>!1,has:(e,t)=>!["soundSystem","stateMachine","emotionLibrary"].includes(t)&&t in e,ownKeys:e=>["canvas","start","stop","pause","resume","setEmotion","morphTo","express"].filter(t=>t in e)}),this.canvas=this._engine.canvas,this._initialized=!0,Promise.resolve()}catch(e){throw console.error("Failed to initialize Emotive Engine:",e),e}}start(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.start()}stop(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.stop()}pause(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.pause()}resume(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.resume()}loadAudio(e){return this._audioManager.loadAudio(e)}getAudioAnalysis(){return this._audioManager.getAudioAnalysis()}connectAudio(e){return this._audioManager.connectAudio(e)}disconnectAudio(e){return this._audioManager.disconnectAudio(e)}getSpectrumData(){return this._audioManager.getSpectrumData()}startRhythmSync(e){return this._audioManager.startRhythmSync(e)}stopRhythmSync(){return this._audioManager.stopRhythmSync()}getPerformanceMetrics(){const e=this._getReal();return e?e.performanceMonitor?{fps:e.performanceMonitor.getCurrentFPS()||0,frameTime:e.performanceMonitor.getAverageFrameTime()||0,particleCount:e.particleSystem?.activeParticles||0}:e.animationController?{fps:e.animationController.currentFPS||0,frameTime:1e3/60,particleCount:0}:{fps:0,frameTime:0,particleCount:0}:{fps:0,frameTime:0}}triggerGesture(e,t){return this._gestureController.triggerGesture(e,t)}express(e,t){return this._gestureController.express(e,t)}chain(e){return this._gestureController.chain(e)}morphTo(e,t){return this.setShape(e,t)}updateUndertone(e){return this._gestureController.updateUndertone(e)}setEmotion(e,t,i){const n=this._getReal();if(!n)throw new Error("Engine not initialized. Call init() first.");let s=null,r=500,a=i;if("string"==typeof t)s=t;else if("number"==typeof t)void 0!==i?r=t:a=t;else if(t&&"object"==typeof t){const{undertone:e,duration:i}=t;s=e,void 0!==i&&(r=i)}if(this._isRecording){const t=a||Date.now()-this._recordingStartTime;this._timeline.push({type:"emotion",name:e,undertone:s,time:t})}s?n.setEmotion(e,{undertone:s},r):n.setEmotion(e,null,r)}setSoundEnabled(e){const t=this._getReal();if(!t)throw new Error("Engine not initialized. Call init() first.");t.soundSystem&&(t.soundSystem.enabled=e)}setShape(e,t){const i=this._getReal();if(!i)throw new Error("Engine not initialized. Call init() first.");let n,s={};if("number"==typeof t)n=t;else if(t&&"object"==typeof t){const{timestamp:e,...i}=t;s=i,n=e}if(this._isRecording){const t=n||Date.now()-this._recordingStartTime;this._timeline.push({type:"shape",name:e,time:t,config:s})}i&&i.morphTo(e,s)}enableGazeTracking(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.gazeTracker&&e.gazeTracker.enable()}disableGazeTracking(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");e.gazeTracker&&e.gazeTracker.disable()}setGazeTarget(e,t){const i=this._getReal();if(!i)throw new Error("Engine not initialized. Call init() first.");i.gazeTracker&&(i.gazeTracker.mousePos={x:e,y:t},i.gazeTracker.updateTargetGaze())}setContainment(e,t=1){return this._visualEffectsManager.setContainment(e,t)}setPosition(e,t,i=0){const n=this._getReal();if(!n)throw new Error("Engine not initialized. Call init() first.");if(n.positionController)n.positionController.onUpdate||(n.positionController.onUpdate=()=>{}),n.positionController.setOffset(e,t,i);else if(this._canvas){const n=window.innerWidth/2+e,s=window.innerHeight/2+t,r=1+.001*i;this._canvas.style.transform=`translate(${n}px, ${s}px) translate(-50%, -50%) scale(${r})`}}animateToPosition(e,t,i=0,n=1e3,s="easeOutCubic"){const r=this._getReal();if(!r)throw new Error("Engine not initialized. Call init() first.");r.positionController?(r.positionController.onUpdate||(r.positionController.onUpdate=()=>{}),r.positionController.animateOffset(e,t,i,n,s)):this.setPosition(e,t,i)}clearParticles(){return this._visualEffectsManager.clearParticles()}setParticleSystemCanvasDimensions(e,t){return this._visualEffectsManager.setParticleSystemCanvasDimensions(e,t),this}attachToElement(e,t={}){return this._elementAttachmentManager.attachToElement(e,t)}isAttachedToElement(){return this._elementAttachmentManager.isAttachedToElement()}detachFromElement(){return this._elementAttachmentManager.detachFromElement()}getGazeState(){const e=this._getReal();if(!e)throw new Error("Engine not initialized. Call init() first.");return e.gazeTracker?e.gazeTracker.getState():null}setBPM(e){const t=this._getReal();t&&t.rhythmIntegration&&t.rhythmIntegration.setBPM(e)}setQuality(e){const t={low:{particleCount:50,fps:30},medium:{particleCount:100,fps:60},high:{particleCount:200,fps:60}},i=t[e]||t.medium,n=this._getReal();n&&n.performanceMonitor&&n.performanceMonitor.setTargetFPS(i.fps),n&&n.particleSystem&&n.particleSystem.setMaxParticles(i.particleCount)}setMaxParticles(e){const t=this._getReal();return t&&t.particleSystem&&t.particleSystem.setMaxParticles(e),this}getParticleCount(){const e=this._getReal();return e&&e.particleSystem&&e.particleSystem.particles?e.particleSystem.particles.length:0}setOpacity(e){const t=this._getReal();if(e=Math.max(0,Math.min(1,e)),t&&t.renderer){const i=t.canvasManager?.getContext();i&&(i.globalAlpha=e)}return this._currentOpacity=e,this}getOpacity(){return void 0!==this._currentOpacity?this._currentOpacity:1}fadeIn(e=1e3){const t=this.getOpacity(),i=performance.now(),n=s=>{const r=s-i,a=Math.min(r/e,1),o=t+(1-t)*a;this.setOpacity(o),a<1&&requestAnimationFrame(n)};return requestAnimationFrame(n),this}fadeOut(e=1e3){const t=this.getOpacity(),i=performance.now(),n=s=>{const r=s-i,a=Math.min(r/e,1),o=t*(1-a);this.setOpacity(o),a<1&&requestAnimationFrame(n)};return requestAnimationFrame(n),this}setColor(e){const t=this._getReal();return t&&t.renderer&&t.renderer.config&&(t.renderer.config.coreColor=e),this}setGlowColor(e){const t=this._getReal();return t&&t.renderer&&t.renderer.config&&(t.renderer.config.defaultGlowColor=e),this}setTheme(e){return e.core&&this.setColor(e.core),e.glow&&this.setGlowColor(e.glow),this}setSpeed(e){return this._getReal(),e=Math.max(.1,Math.min(10,e)),this._speedMultiplier=e,this}getSpeed(){return this._speedMultiplier||1}setFPS(e){const t=this._getReal();return e=Math.max(1,Math.min(120,e)),t&&t.animationController&&t.animationController.setTargetFPS(e),this}getFPS(){const e=this._getReal();return e&&e.animationController&&e.animationController.targetFPS||60}isPaused(){const e=this._getReal();return!(!e||!e.animationController)&&!0===e.animationController.isPaused}batch(e){const t=this.isPaused();return t||this.pause(),"function"==typeof e&&e(this),t||this.resume(),this}on(e,t){const i=this._getReal();return i&&i.eventManager&&i.eventManager.on(e,t),this}off(e,t){const i=this._getReal();return i&&i.eventManager&&i.eventManager.off(e,t),this}setScale(e){const t=this._getReal();return t&&t.positionController&&(t.positionController.setScaleOverrides(e),"object"==typeof e&&void 0!==e.particles&&t.particleSystem&&"function"==typeof t.particleSystem.refreshPool&&t.particleSystem.refreshPool()),this}getScale(){const e=this._getReal();return e&&e.positionController&&e.positionController.globalScale||1}setBackdrop(e={}){const t=this._getReal();return t&&"function"==typeof t.setBackdrop&&t.setBackdrop(e),this}getBackdrop(){const e=this._getReal();return e&&"function"==typeof e.getBackdrop?e.getBackdrop():null}startRecording(){return this._timelineRecorder.startRecording()}stopRecording(){return this._timelineRecorder.stopRecording()}playTimeline(e){return this._timelineRecorder.playTimeline(e)}stopPlayback(){return this._timelineRecorder.stopPlayback()}getTimeline(){return this._timelineRecorder.getTimeline()}loadTimeline(e){return this._timelineRecorder.loadTimeline(e)}exportTimeline(){return this._timelineRecorder.exportTimeline()}importTimeline(e){return this._timelineRecorder.importTimeline(e)}getCurrentTime(){return this._timelineRecorder.getCurrentTime()}seek(e){return this._timelineRecorder.seek(e)}getFrameData(e="png"){return this._visualEffectsManager.getFrameData(e)}getFrameBlob(e="png"){return this._visualEffectsManager.getFrameBlob(e)}getAnimationData(){return this._timelineRecorder.getAnimationData()}getAvailableGestures(){return["bounce","pulse","shake","spin","nod","tilt","drift","vibrate","sway","float","wave","expand","contract","stretch","morph","jump","flash","glow","flicker","scan","hula","orbit","breathe","settle"]}getAvailableEmotions(){return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria","excited","suspicion","resting"]}getAvailableShapes(){return["circle","square","triangle","star","heart","moon","sun"]}getVersion(){return"2.5.1"}getCapabilities(){return{audio:!0,recording:!0,timeline:!0,export:!0,shapes:!0,gestures:!0,emotions:!0,particles:!0,gazeTracking:!0}}get renderer(){const e=this._getReal();return e&&e.renderer?new Proxy(e.renderer,{get:(e,t)=>["setBlinkingEnabled"].includes(t)?e[t]:void 0}):null}get shapeMorpher(){const e=this._getReal();return e&&e.shapeMorpher?new Proxy(e.shapeMorpher,{get:(e,t)=>["resetMusicDetection","frequencyData"].includes(t)?e[t]:void 0}):null}get gazeTracker(){const e=this._getReal();return e&&e.gazeTracker?new Proxy(e.gazeTracker,{get:(e,t)=>["enable","disable","mousePos","updateTargetGaze","currentGaze","getState"].includes(t)?e[t]:void 0}):null}destroy(){this.stop(),this._timeline=[],this._isRecording=!1,this._isPlaying=!1,this.detachFromElement();const e=this._getReal();e&&e.destroy&&e.destroy()}}class nf{constructor(e={}){this._state=this.deepClone(e),this._prevState=this.deepClone(e),this._subscribers=new Map,this._history=[],this._maxHistorySize=50,this._middleware=[],this._validators=new Map,this._computed=new Map,this._computedDeps=new Map,this._stats={updates:0,notifications:0,computedCacheHits:0,computedCacheMisses:0}}getState(e=null){return e?this.deepClone(this.getNestedValue(this._state,e)):this.deepClone(this._state)}setState(e,t=void 0){let i;i="string"==typeof e?{[e]:t}:e;for(const e of this._middleware)if(i=e(i,this._state),!i)return!1;const n=this.deepClone(this._state);for(const[e,t]of Object.entries(i)){if(this._validators.has(e)&&!this._validators.get(e)(t))return console.error(`Validation failed for path: ${e}`),!1;this.setNestedValue(n,e,t)}return this._prevState=this._state,this._state=n,this.addToHistory(i),this.invalidateComputed(Object.keys(i)),this.notifySubscribers(i),this._stats.updates++,!0}subscribe(e,t=null){let i=null,n=e;"string"==typeof e&&(i=e,n=t);const s=Symbol("subscriber"),r={path:i,callback:n,id:s};return this._subscribers.set(s,r),()=>{this._subscribers.delete(s)}}computed(e,t,i){this._computedDeps.set(e,t),Object.defineProperty(this,e,{get:()=>{if(this._computed.has(e))return this._stats.computedCacheHits++,this._computed.get(e);this._stats.computedCacheMisses++;const n=t.map(e=>this.getState(e)),s=i(...n);return this._computed.set(e,s),s}})}addValidator(e,t){this._validators.set(e,t)}addMiddleware(e){this._middleware.push(e)}reset(e={}){this._state=this.deepClone(e),this._prevState=this.deepClone(e),this._history=[],this._computed.clear(),this.notifySubscribers({"*":"reset"})}getDiff(){return this.objectDiff(this._prevState,this._state)}undo(e=1){if(this._history.length<e)return console.warn("Cannot undo: insufficient history"),!1;const t=Math.max(0,this._history.length-e-1),i=this._history[t];return!!i&&(this._state=this.deepClone(i.state),this._history=this._history.slice(0,t+1),this.notifySubscribers({"*":"undo"}),!0)}batch(e){const t={},i=this.setState.bind(this);return this.setState=(e,i)=>("string"==typeof e?t[e]=i:Object.assign(t,e),!0),e(),this.setState=i,this.setState(t)}createSelector(e){let t=null,i=null;return()=>{const n=this._state;return n===t||(t=n,i=e(n)),i}}notifySubscribers(e){for(const t of this._subscribers.values())t.path&&!Object.keys(e).some(e=>e.startsWith(t.path)||t.path.startsWith(e))||(t.callback(this._state,e),this._stats.notifications++)}invalidateComputed(e){for(const[t,i]of this._computedDeps.entries())i.some(t=>e.some(e=>t.startsWith(e)||e.startsWith(t)))&&this._computed.delete(t)}addToHistory(e){this._history.push({timestamp:Date.now(),updates:e,state:this.deepClone(this._state)}),this._history.length>this._maxHistorySize&&this._history.shift()}deepClone(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof Array)return e.map(e=>this.deepClone(e));if(e instanceof Object){const t={};for(const i in e)({}).hasOwnProperty.call(e,i)&&(t[i]=this.deepClone(e[i]));return t}}getNestedValue(e,t){return t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:void 0,e)}setNestedValue(e,t,i){const n=t.split("."),s=n.pop();n.reduce((e,t)=>(e[t]||(e[t]={}),e[t]),e)[s]=i}objectDiff(e,t){const i={};for(const n in t)n in e?JSON.stringify(e[n])!==JSON.stringify(t[n])&&(i[n]={type:"changed",oldValue:e[n],newValue:t[n]}):i[n]={type:"added",value:t[n]};for(const n in e)n in t||(i[n]={type:"deleted",oldValue:e[n]});return i}getStats(){return{...this._stats,subscribers:this._subscribers.size,historySize:this._history.length,computedValues:this._computed.size,validators:this._validators.size}}}const sf=new nf({engine:{initialized:!1,running:!1,paused:!1,fps:60,frameCount:0},renderer:{color:"#4a90e2",intensity:1,eyeOpenness:1,breathRate:1,breathDepth:1,sleeping:!1,zenMode:!1},animation:{currentGesture:null,activeLoops:0},emotion:{current:"neutral",intensity:1,undertone:null,transitioning:!1},particles:{active:!0,count:0,maxParticles:100},sound:{enabled:!1,volume:1,bpm:120,rhythmEnabled:!1},performance:{quality:"high",adaptiveQuality:!0,targetFPS:60,actualFPS:60}});e.BUILD_TYPE="minimal",e.CanvasManager=t,e.ENGINE_NAME="Emotive Engine Minimal",e.EmotiveMascot=Xg,e.EmotiveMascotPublic=tf,e.EmotiveRenderer=Bi,e.ErrorBoundary=i,e.EventManager=Tm,e.FEATURES={rhythmSync:!1,grooveTemplates:!1,gestureBlending:!0,audioReactive:!1,particleSystem:!0,accessibility:!1,mobileOptimization:!1,performanceMonitoring:!1},e.GESTURE_TYPES=mt,e.ParticleSystem=kt,e.StateStore=nf,e.UNDERTONE_MODIFIERS=_t,e.VERSION="3.0.0-minimal",e.applyEasing=M,e.applyGesture=vt,e.applyUndertoneSaturation=l,e.default=tf,e.easeInOutQuad=p,e.easeInOutSine=S,e.easeOutCubic=m,e.engineState=sf,e.eventManager=km,e.getEmotion=A,e.getEmotionVisualParams=I,e.getGesture=gt,e.hasEmotion=z,e.interpolateHsl=o,e.listEmotions=D,e.listGestures=bt,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=emotive-mascot.minimal.umd.js.map
