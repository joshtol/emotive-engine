!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EmotiveMascotLean={})}(this,function(t){"use strict";class e{constructor(t){this.canvas=t,this.ctx=t.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.dpr=window.devicePixelRatio||1,this.width=0,this.height=0,this.centerX=0,this.centerY=0,this.renderSize=null,this.resizeCallbacks=[],this.handleResize=this.handleResize.bind(this),window.addEventListener("resize",this.handleResize),this.resize()}resize(){if(this.renderSize&&this.renderSize.width&&this.renderSize.height)this.width=this.renderSize.width,this.height=this.renderSize.height,this.canvas.width=this.width,this.canvas.height=this.height;else if(this.canvas.hasAttribute("width")&&this.canvas.hasAttribute("height")){const t=parseInt(this.canvas.getAttribute("width"),10),e=parseInt(this.canvas.getAttribute("height"),10),i=this.canvas.getBoundingClientRect(),s=i.width,n=i.height;t>1.5*s||e>1.5*n?(this.width=s,this.height=n,this.canvas.width=t,this.canvas.height=e,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)):(this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e)}else{const t=this.canvas.getBoundingClientRect();this.width=t.width,this.height=t.height,this.canvas.width=this.width*this.dpr,this.canvas.height=this.height*this.dpr,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}this.centerX=this.width/2,this.centerY=this.height/2,this.resizeCallbacks.forEach(t=>{try{t(this.width,this.height,this.dpr)}catch{}})}onResize(t){"function"==typeof t&&this.resizeCallbacks.push(t)}handleResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.renderSize&&this.renderSize.width&&this.renderSize.height||this.resize()},100)}setRenderSize(t,e){this.renderSize={width:t,height:e},this.resize()}clear(){this.ctx.clearRect(0,0,this.width,this.height)}getCenter(){return{x:this.centerX,y:this.centerY}}setTransform(t=0,e=0,i=1,s=0){this.ctx.save(),this.ctx.translate(t,e),this.ctx.rotate(s),this.ctx.scale(i,i)}restoreTransform(){this.ctx.restore()}getContext(){return this.ctx}getDimensions(){return{width:this.width,height:this.height}}destroy(){window.removeEventListener("resize",this.handleResize),clearTimeout(this.resizeTimeout)}}class i{constructor(){this.errors=[],this.maxErrors=10,this.errorCounts=new Map,this.defaults={emotion:"neutral",gesture:null,audioLevel:0,particleCount:0,glowIntensity:.7,coreSize:1,breathRate:1,color:"#B0B0B0"}}wrap(t,e,i=null){return(...s)=>{try{return t(...s)}catch(t){return this.logError(t,e),null!==i?i:this.getDefault(e)}}}logError(t,e){const i={timestamp:(new Date).toISOString(),context:e,message:t.message,stack:t.stack};this.errors.push(i);const s=this.errorCounts.get(e)||0;this.errorCounts.set(e,s+1),this.errors.length>this.maxErrors&&this.errors.shift()}getDefault(t){const e={"emotion-transition":this.defaults.emotion,"gesture-execution":this.defaults.gesture,"audio-processing":this.defaults.audioLevel,"particle-system":this.defaults.particleCount,rendering:{glowIntensity:this.defaults.glowIntensity,coreSize:this.defaults.coreSize,color:this.defaults.color},"canvas-operations":null,"state-management":this.defaults.emotion};return{}.hasOwnProperty.call(e,t)?e[t]:null}validateInput(t,e,i){try{switch(e){case"emotion":return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria"].includes(t)?t:i;case"undertone":return null===t||["nervous","confident","tired","intense","subdued"].includes(t)?t:null;case"gesture":return["bounce","pulse","shake","spin","nod","tilt","expand","contract","flash","drift"].includes(t)?t:i;case"number":return"number"!=typeof t||isNaN(t)?i:t;case"string":return"string"==typeof t?t:i;case"boolean":return"boolean"==typeof t?t:i;default:return null!=t?t:i}}catch(t){return this.logError(t,"input-validation"),i}}hasExceededThreshold(t,e=5){return(this.errorCounts.get(t)||0)>=e}getErrorStats(){return{totalErrors:this.errors.length,errorsByContext:Object.fromEntries(this.errorCounts),recentErrors:this.errors.slice(-5)}}clearErrors(){this.errors=[],this.errorCounts.clear()}async attemptRecovery(t,e,i=3){let s=0;for(;s<i;)try{return await e()}catch(e){if(s++,this.logError(e,`recovery-${t}-attempt-${s}`),s>=i)throw new Error(`Recovery failed for ${t} after ${i} attempts`);await new Promise(t=>setTimeout(t,100*Math.pow(2,s)))}}}function s(t){return 3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join("")),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}}function n(t,e,i){const s=t=>{const e=Math.round(Math.max(0,Math.min(255,t))).toString(16);return 1===e.length?`0${e}`:e};return`#${s(t)}${s(e)}${s(i)}`}function r(t,e,i){t/=255,e/=255,i/=255;const s=Math.max(t,e,i),n=Math.min(t,e,i),r=(s+n)/2;let o,a;if(s===n)o=a=0;else{const h=s-n;switch(a=r>.5?h/(2-s-n):h/(s+n),s){case t:o=(e-i)/h+(e<i?6:0);break;case e:o=(i-t)/h+2;break;case i:o=(t-e)/h+4}o/=6}return{h:360*o,s:100*a,l:100*r}}function o(t,e,i){t/=360,i/=100;const s=(t,e,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t);let n,r,o;if(0==(e/=100))n=r=o=i;else{const a=i<.5?i*(1+e):i+e-i*e,h=2*i-a;n=s(h,a,t+1/3),r=s(h,a,t),o=s(h,a,t-1/3)}return{r:Math.round(255*n),g:Math.round(255*r),b:Math.round(255*o)}}function a(t,e,i){const a=s(t),h=s(e),c=r(a.r,a.g,a.b),u=r(h.r,h.g,h.b),l=c.h;let d=u.h;const p=d-l;p>180?d-=360:p<-180&&(d+=360);const f=o(((l+(d-l)*i)%360+360)%360,c.s+(u.s-c.s)*i,c.l+(u.l-c.l)*i);return n(f.r,f.g,f.b)}const h={intense:1.6,confident:1.3,nervous:1.15,clear:1,tired:.8,subdued:.5};function c(t,e){if(!e||"clear"===e)return t;const i=h[e.toLowerCase()];return i&&1!==i?function(t,e){const i=s(t),a=r(i.r,i.g,i.b);a.s=Math.max(0,Math.min(100,a.s*e));const h=o(a.h,a.s,a.l);return n(h.r,h.g,h.b)}(t,i):t}function u(t){return t}function l(t){return t*(2-t)}function d(t){return t*t}function p(t){return t<.5?2*t*t:(4-2*t)*t-1}function f(t){return 1-Math.pow(1-t,3)}function m(t){return t*t*t}function g(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function y(t){const e=2*Math.PI/3;return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*e)+1}function b(t){const e=7.5625,i=2.75;return t<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375}function v(t){const e=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-e)/2:(Math.pow(2*t-2,2)*((e+1)*(2*t-2)+e)+2)/2}function w(t){return Math.sin(t*Math.PI/2)}function M(t){return-(Math.cos(Math.PI*t)-1)/2}function S(t,e,i,s="linear"){return e+(i-e)*("string"==typeof s?{linear:u,easeOutQuad:l,easeInQuad:d,easeInOutQuad:p,easeOutCubic:f,easeInCubic:m,easeInOutCubic:g,easeOutElastic:y,easeOutBounce:b,easeInOutBack:v,easeOutSine:w,easeInOutSine:M}[s]||u:s)(Math.max(0,Math.min(1,t)))}Object.fromEntries(Object.entries({neutral:"#B0B0B0",joy:"#FFD700",sadness:"#4169E1",anger:"#DC143C",fear:"#8B008B",surprise:"#FF8C00",disgust:"#9ACD32",love:"#FF69B4"}).map(([t,e])=>{const i=s(e);return[t,`${i.r}, ${i.g}, ${i.b}`]}));const k=new Map;var x={registerPluginEmotion:function(t,e){return!!e.color&&(e.name||(e.name=t),e.visual||(e.visual={primaryColor:e.color,particleCount:e.particleCount||15,particleSize:e.particleSize||{min:2,max:6}}),e.modifiers||(e.modifiers={speed:1,amplitude:1,intensity:1}),k.set(t,e),!0)},unregisterPluginEmotion:function(t){return!!k.has(t)&&(k.delete(t),!0)},getPluginEmotion:function(t){return k.get(t)||null},getAllPluginEmotions:function(){return Array.from(k.keys())},clearPluginEmotions:function(){k.clear()},createLegacyAdapter:function(t){return{name:t.name||"unknown",emoji:t.emoji||"🔌",color:t.primaryColor||t.color||"#7B68EE",energy:t.energy||"medium",visual:{primaryColor:t.primaryColor||t.color||"#7B68EE",secondaryColor:t.secondaryColor,particleCount:t.particleCount||t.particleRate||15,particleSize:t.particleSize||{min:2,max:6},glowIntensity:t.glowIntensity||.5,trailLength:t.trailLength||5,pulseRate:t.pulseRate||t.breathRate||1},particles:{behavior:t.particleBehavior||"ambient",density:t.particleDensity||"medium",speed:t.particleSpeed||"normal"},modifiers:{speed:t.speedMultiplier||1,amplitude:t.amplitudeMultiplier||1,intensity:t.intensityMultiplier||1,smoothness:t.smoothnessMultiplier||1},gestures:t.gestures||[],transitions:t.transitions||{}}}},T={name:"suspicion",emoji:"🤨",description:"Paranoid watchfulness with surveillance scanning",visual:{glowColor:"#6B46C1",glowIntensity:.85,particleRate:18,minParticles:6,maxParticles:12,particleBehavior:"surveillance",particleSpeed:.2,breathRate:.6,breathDepth:.04,coreJitter:.02,particleColors:[{color:"#6B46C1",weight:30},{color:"#4A5568",weight:25},{color:"#8B4789",weight:20},{color:"#9F7AEA",weight:15},{color:"#2D3748",weight:10}],threatLevel:0,getGlowIntensity(){return.3+.7*this.threatLevel},getParticleSpeed(){return.2+.8*this.threatLevel},getGlowColor(){const t=this.threatLevel||0,e=Math.round(107+113*t),i=Math.round(70+-32*t),s=Math.round(193+-66*t),n=t=>t.toString(16).padStart(2,"0");return`#${n(e)}${n(i)}${n(s)}`}},modifiers:{speed:.4,amplitude:.6,intensity:1.2,smoothness:.3,regularity:.2,focus:1.5,addWobble:!0},typicalGestures:["scan","twitch","peek","tilt","hold"],transitions:{duration:500,easing:"linear",priority:4},special:{coreSquint:.6,scanInterval:2e3,scanDuration:1200,scanAngle:60,twitchChance:.02,peekInterval:4e3,maxThreatDistance:300,alertThreshold:.7}},E={name:"calm",emoji:"😌",description:"Serene, peaceful state with gentle movements",visual:{glowColor:"#66D9CC",glowIntensity:.6,particleRate:25,minParticles:8,maxParticles:25,particleBehavior:"zen",breathRate:.4,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#66D9CC",weight:35},{color:"#99E6D9",weight:25},{color:"#40BFB3",weight:20},{color:"#B3F2E6",weight:15},{color:"#339980",weight:5}]},modifiers:{speed:.5,amplitude:.3,intensity:.4,smoothness:2,regularity:1.5,addWeight:!1,floatHeight:.2,swayAmount:.15,duration:1.5},typicalGestures:["breathe","float","drift","idle"],transitions:{duration:800,easing:"easeInOutSine",priority:1},movement:{floatPattern:"sine_slow",floatPeriod:6e3,floatAmplitude:8,swayPattern:"gentle",swayPeriod:8e3,swayAmplitude:5,microMovements:!1},getCoreParams(t){const e=t.time||Date.now(),i=.5*Math.sin(6e-4*e)+.5;return{scaleX:1-.02*i,scaleY:1-.02*i,eyeOpenness:.85,eyeExpression:"serene",pupilOffset:{x:2*Math.sin(3e-4*e),y:1*Math.cos(4e-4*e)},glowPulse:.95+.05*i}},updateParticle(t,e){t.x+=.1*Math.sin(.001*t.life),t.y-=.02*e,t.opacity=.3*Math.sin(.002*t.life)+.2,t.size=t.baseSize*(1+.2*Math.sin(.001*t.life))},renderCore:(t,e,i,s)=>!1};const C=new Map,A={happy:"joy",peaceful:"calm",curious:"surprise",frustrated:"anger",sad:"sadness"};function I(t){t.name&&C.set(t.name,t)}function F(t){const e=A[t]||t,i=C.get(e);return i||(x.getPluginEmotion(e)||null)}function _(t){const e=F(t);if(!e)return F("neutral").visual;if(!e.visual)return{};const{visual:i}=e,s={};for(const t in i)"function"!=typeof i[t]&&(s[t]=i[t]);return"function"==typeof i.getGlowIntensity&&(s.glowIntensity=i.getGlowIntensity()),"function"==typeof i.getParticleSpeed&&(s.particleSpeed=i.getParticleSpeed()),"function"==typeof i.getParticleRate&&(s.particleRate=i.getParticleRate()),"function"==typeof i.getGlowColor&&(s.glowColor=i.getGlowColor()),s}function R(t){const e=F(t);return e?e.modifiers:F("neutral").modifiers}function P(){return[...Array.from(C.keys()),...x.getAllPluginEmotions()]}function O(){const t={};return C.forEach((e,i)=>{t[i]=e}),t}function B(t){const e=A[t]||t;return C.has(e)||null!==x.getPluginEmotion(e)}function D(t,e){A[t]=e}function $(t,e){const i=F(t),s=F(e);return i&&s?s.transitions&&s.transitions[t]?s.transitions[t]:{duration:1e3,easing:"ease-in-out",gesture:s.transitions?.defaultGesture||null}:{duration:1e3,easing:"ease-in-out"}}function z(t){const e=F(t);return e?.gestures||[]}[{name:"neutral",emoji:"😐",description:"Calm, balanced emotional state",visual:{glowColor:"#00BCD4",glowIntensity:.9,particleRate:2,minParticles:8,maxParticles:10,particleBehavior:"ambient",breathRate:1,breathDepth:.08,coreJitter:!1,particleColors:[{color:"#00BCD4",weight:25},{color:"#00ACC1",weight:20},{color:"#26C6DA",weight:15},{color:"#B2EBF2",weight:15},{color:"#0097A7",weight:10},{color:"#80DEEA",weight:10},{color:"#E0F7FA",weight:5}]},modifiers:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},typicalGestures:["breathe","float","idle","blink"],transitions:{duration:500,easing:"easeInOut",priority:0},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"neutral",pupilOffset:{x:0,y:0}}),renderCore:(t,e,i,s)=>!1},{name:"joy",emoji:"😊",description:"Playful happiness and celebration",visual:{glowColor:"#FFEB3B",glowIntensity:1.6,particleRate:40,minParticles:0,maxParticles:40,particleBehavior:"popcorn",breathRate:1.5,breathDepth:.1,coreJitter:!1,particleColors:[{color:"#FFEB3B",weight:25},{color:"#FFC107",weight:20},{color:"#FFFF00",weight:15},{color:"#FFD700",weight:15},{color:"#FFF59D",weight:10},{color:"#FF9800",weight:10},{color:"#FFFDE7",weight:5}]},modifiers:{speed:1.8,amplitude:1.9,intensity:1.1,smoothness:1,regularity:.9,addBounce:!0},typicalGestures:["bounce","spin","wave","expand","shake","float"],transitions:{duration:400,easing:"easeOutBack",priority:5,burstOnEntry:!0},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"happy",pupilOffset:{x:0,y:-.1},sparkle:!0})},{name:"sadness",emoji:"😢",description:"Deep melancholic sorrow",visual:{glowColor:"#4169E1",glowIntensity:.65,particleRate:25,minParticles:0,maxParticles:25,particleBehavior:"falling",breathRate:.6,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#4169E1",weight:25},{color:"#1E90FF",weight:20},{color:"#6495ED",weight:15},{color:"#B0C4DE",weight:15},{color:"#191970",weight:10},{color:"#87CEEB",weight:10},{color:"#2F4F4F",weight:5}]},modifiers:{speed:.7,amplitude:.6,intensity:.8,smoothness:1.3,regularity:1.1,addGravity:!0},typicalGestures:["droop","sway","contract","drift","sink"],transitions:{duration:800,easing:"easeInOut",priority:3}},{name:"anger",emoji:"😠",description:"Intense rage and aggression",visual:{glowColor:"#DC143C",glowIntensity:1.8,particleRate:20,minParticles:3,maxParticles:10,particleBehavior:"aggressive",breathRate:2.2,breathDepth:.15,coreJitter:!0,particleColors:[{color:"#DC143C",weight:25},{color:"#FF0000",weight:20},{color:"#B22222",weight:15},{color:"#FF4500",weight:15},{color:"#8B0000",weight:10},{color:"#FF6347",weight:10},{color:"#660000",weight:5}]},modifiers:{speed:1.5,amplitude:1.4,intensity:1.3,smoothness:.3,regularity:.7,addShake:!0},typicalGestures:["shake","vibrate","expand","pulse","flicker","strike"],transitions:{duration:300,easing:"easeOutExpo",priority:8,shakeOnEntry:!0},special:{screenShake:!0,particleTrails:"fire",glowPulse:!0,temperatureEffect:"hot"}},{name:"fear",emoji:"😨",description:"Anxious state with fleeing particles",visual:{glowColor:"#8A2BE2",glowIntensity:.9,particleRate:18,minParticles:4,maxParticles:16,particleBehavior:"scattering",breathRate:2.5,breathDepth:.06,coreJitter:!0,particleColors:[{color:"#8A2BE2",weight:25},{color:"#4B0082",weight:20},{color:"#9400D3",weight:15},{color:"#6B46C1",weight:15},{color:"#9932CC",weight:10},{color:"#E6E6FA",weight:8},{color:"#301934",weight:7}]},modifiers:{speed:1.4,amplitude:.8,intensity:1.2,smoothness:.5,regularity:.5,addJitter:!0},typicalGestures:["shake","vibrate","contract","flicker","retreat"],transitions:{duration:400,easing:"easeOut",priority:7}},{name:"surprise",emoji:"😲",description:"Sudden shock with explosive particles",visual:{glowColor:"#FFD700",glowIntensity:1.8,particleRate:30,minParticles:0,maxParticles:15,particleBehavior:"burst",breathRate:.3,breathDepth:.18,coreJitter:!1,particleColors:[{color:"#FFD700",weight:25},{color:"#FFA500",weight:20},{color:"#FFFF00",weight:15},{color:"#FF6347",weight:15},{color:"#FFE4B5",weight:10},{color:"#FF4500",weight:10},{color:"#FFFACD",weight:5}]},modifiers:{speed:1.6,amplitude:1.5,intensity:1.4,smoothness:.7,regularity:.8,addPop:!0},typicalGestures:["expand","bounce","flash","pulse","pop"],transitions:{duration:200,easing:"easeOutBack",priority:6}},{name:"disgust",emoji:"🤢",description:"Revulsion with repelling particles",visual:{glowColor:"#9ACD32",glowIntensity:1,particleRate:15,minParticles:5,maxParticles:12,particleBehavior:"repelling",breathRate:.7,breathDepth:.04,coreJitter:!1,particleColors:[{color:"#9ACD32",weight:25},{color:"#ADFF2F",weight:20},{color:"#7FFF00",weight:15},{color:"#BDB76B",weight:15},{color:"#6B8E23",weight:10},{color:"#CCFF00",weight:8},{color:"#556B2F",weight:7}]},modifiers:{speed:.9,amplitude:.7,intensity:.9,smoothness:.8,regularity:1,addRecoil:!0},typicalGestures:["contract","shake","recoil","wobble"],transitions:{duration:600,easing:"easeIn",priority:4}},{name:"love",emoji:"💕",description:"Warm affection with orbiting particles",visual:{glowColor:"#FF1493",glowIntensity:1.8,particleRate:25,minParticles:10,maxParticles:18,particleBehavior:"orbiting",breathRate:.75,breathDepth:.15,coreJitter:!1,particleColors:[{color:"#FF1493",weight:30},{color:"#FF69B4",weight:25},{color:"#FF007F",weight:15},{color:"#FFB6C1",weight:10},{color:"#FF45A0",weight:10},{color:"#E91E63",weight:5},{color:"#FFC0CB",weight:5}]},modifiers:{speed:.9,amplitude:1.1,intensity:1.2,smoothness:1.4,regularity:1.2,addWarmth:!0},typicalGestures:["pulse","sway","orbit","glow","breathe","float"],transitions:{duration:700,easing:"easeInOut",priority:5}},T,{name:"excited",emoji:"🤩",description:"High energy with rapid particles",visual:{glowColor:"#FF6B35",glowIntensity:1.5,particleRate:25,minParticles:8,maxParticles:30,particleBehavior:"burst",breathRate:2,breathDepth:.14,coreJitter:!0,particleColors:[{color:"#FF6B35",weight:25},{color:"#FF1744",weight:20},{color:"#FFC107",weight:15},{color:"#FF9100",weight:15},{color:"#FFEB3B",weight:10},{color:"#FF5722",weight:10},{color:"#FFF59D",weight:5}]},modifiers:{speed:1.4,amplitude:1.3,intensity:1.3,smoothness:.8,regularity:.7,addVibration:!0},typicalGestures:["bounce","spin","vibrate","expand","shake","pulse"],transitions:{duration:300,easing:"easeOutElastic",priority:6}},{name:"resting",emoji:"😴",description:"Deep relaxation with slow drift",visual:{glowColor:"#9370DB",glowIntensity:.8,particleRate:10,minParticles:3,maxParticles:5,particleBehavior:"resting",breathRate:.8,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#9370DB",weight:30},{color:"#A591C4",weight:20},{color:"#B366FF",weight:20},{color:"#B8A1E6",weight:15},{color:"#674D9B",weight:15}]},modifiers:{speed:.5,amplitude:.4,intensity:.5,smoothness:1.4,regularity:.9,addWeight:!0},typicalGestures:["breathe","drift","sway","float"],transitions:{duration:1e3,easing:"easeInOut",priority:2}},{name:"euphoria",emoji:"🌟",description:"Radiant hope and new beginnings",visual:{glowColor:"#FFB6C1",glowIntensity:1.2,particleRate:35,minParticles:15,maxParticles:30,particleBehavior:"radiant",breathRate:1.3,breathDepth:.25,coreJitter:!1,particleColors:[{color:"#FFB6C1",weight:20},{color:"#FFD700",weight:18},{color:"#87CEEB",weight:15},{color:"#DDA0DD",weight:15},{color:"#98FB98",weight:12},{color:"#FFA07A",weight:10},{color:"#E6E6FA",weight:8},{color:"#FFFFFF",weight:2}]},modifiers:{speed:1.4,amplitude:1.5,intensity:1.6,smoothness:1.3,regularity:.8,addWarmth:!0,addLift:!0},typicalGestures:["expand","radiate","pulse","glow","float","bloom"],transitions:{duration:600,easing:"easeOutExpo",priority:8}},{name:"focused",emoji:"🎯",description:"Intense concentration with directed flow",visual:{glowColor:"#00CED1",glowIntensity:1.2,particleRate:10,minParticles:5,maxParticles:12,particleBehavior:"directed",breathRate:1.2,breathDepth:.08,coreJitter:!0,particleColors:[{color:"#00CED1",weight:30},{color:"#4A9FA0",weight:20},{color:"#00FFFF",weight:20},{color:"#5FE5E7",weight:15},{color:"#006B6D",weight:15}],eyeOpenness:.7,microAdjustments:!0},modifiers:{speed:1,amplitude:.9,intensity:1.1,smoothness:1.1,regularity:1.2,addPrecision:!0},typicalGestures:["track","lock","scan","pulse","vibrate"],transitions:{duration:400,easing:"easeIn",priority:5},getCoreParams:t=>({scaleX:1.1,scaleY:.7,eyeOpenness:.7,eyeExpression:"focused",pupilOffset:{x:0,y:0},microAdjustments:!0})},{name:"glitch",emoji:"🌈",description:"Surprised sadness with rainbow colors and glitch wiggle",visual:{primaryColor:"#FF6B9D",glowColor:"#4169E1",glowIntensity:1.2,particleRate:20,minParticles:5,maxParticles:15,particleBehavior:"burst",particleSpeed:1,breathRate:.4,breathDepth:.15,coreJitter:!1,coreSize:1,eyeOpenness:.8,particleColors:[{color:"#FF0080",weight:18},{color:"#00FF80",weight:18},{color:"#8000FF",weight:18},{color:"#FF8000",weight:15},{color:"#0080FF",weight:15},{color:"#FFFF00",weight:10},{color:"#FF6B9D",weight:6}],particleGlitchWiggle:!0,glitchWiggleIntensity:.3,glitchWiggleFrequency:.1},modifiers:{speed:1.1,amplitude:1,intensity:1.1,smoothness:.8,regularity:.7,focus:.6},typicalGestures:["bounce","sway","pulse","drift","flash"],transitions:{duration:300,easing:"easeInOut",priority:5}},E].forEach(t=>{t&&t.name&&C.set(t.name,t)});var q={registerEmotion:I,getEmotion:F,getEmotionVisualParams:_,getEmotionParams:_,getEmotionModifiers:R,listEmotions:P,getAllEmotions:O,hasEmotion:B,addEmotionAlias:D,getTransitionParams:$,getEmotionGestures:z,pluginAdapter:x},j=Object.freeze({__proto__:null,addEmotionAlias:D,default:q,getAllEmotions:O,getEmotion:F,getEmotionGestures:z,getEmotionModifiers:R,getEmotionVisualParams:_,getTransitionParams:$,hasEmotion:B,listEmotions:P,pluginAdapter:x,registerEmotion:I});const L=new class{constructor(){this.emotionCache=new Map,this.visualParamsCache=new Map,this.modifiersCache=new Map,this.transitionCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const t=P();t.forEach(t=>{this.cacheEmotion(t)}),this.cacheCommonTransitions(t),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.emotionCache.size}catch(t){this.isInitialized=!1}}cacheEmotion(t){try{const e=F(t);e&&this.emotionCache.set(t,e);const i=_(t);this.visualParamsCache.set(t,i);const s=R(t);this.modifiersCache.set(t,s)}catch(t){}}cacheCommonTransitions(t){[["neutral","joy"],["neutral","sadness"],["neutral","anger"],["joy","sadness"],["sadness","joy"],["anger","calm"],["calm","anger"]].forEach(([e,i])=>{if(t.includes(e)&&t.includes(i))try{const t=$(e,i),s=`${e}->${i}`;this.transitionCache.set(s,t)}catch(t){}})}getEmotion(t){if(!this.isInitialized)return F(t);const e=this.emotionCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,F(t))}getVisualParams(t){if(!this.isInitialized)return _(t);const e=this.visualParamsCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,_(t))}getModifiers(t){if(!this.isInitialized)return R(t);const e=this.modifiersCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,R(t))}getTransitionParams(t,e){if(!this.isInitialized)return $(t,e);const i=`${t}->${e}`,s=this.transitionCache.get(i);return s?(this.stats.hits++,s):(this.stats.misses++,$(t,e))}hasEmotion(t){return this.emotionCache.has(t)}getStats(){const t=this.stats.hits+this.stats.misses,e=t>0?(this.stats.hits/t*100).toFixed(2):0;return{isInitialized:this.isInitialized,loadTime:this.stats.loadTime,cacheSize:this.stats.cacheSize,hits:this.stats.hits,misses:this.stats.misses,hitRate:`${e}%`,emotions:this.emotionCache.size,visualParams:this.visualParamsCache.size,modifiers:this.modifiersCache.size,transitions:this.transitionCache.size}}clear(){this.emotionCache.clear(),this.visualParamsCache.clear(),this.modifiersCache.clear(),this.transitionCache.clear(),this.isInitialized=!1,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0}}reinitialize(){this.clear(),this.initialize()}};class N{constructor(t){this.errorBoundary=t,this.state={emotion:"neutral",undertone:null,gesture:null,speaking:!1,audioLevel:0},this.transitions={emotional:{current:"neutral",target:null,progress:0,duration:500,startTime:0,isActive:!1},undertone:{current:null,target:null,progress:0,duration:300,startTime:0,isActive:!1,currentWeight:0,targetWeight:0}},this.interpolationCache={lastUpdate:0,cacheInterval:100,cachedProperties:null,cachedRenderState:null},this.initializeEmotionalStates(),this.initializeUndertoneModifiers()}initializeEmotionalStates(){this.emotionalStates=this.loadEmotionalStatesFromCache()}loadEmotionalStatesFromCache(){const t={};return["neutral","joy","sadness","anger","fear","surprise","disgust","love","suspicion","excited","resting","euphoria","focused","glitch","calm"].forEach(e=>{const i=L.getVisualParams(e);i&&(t[e]={primaryColor:i.primaryColor||"#B0B0B0",glowIntensity:i.glowIntensity||.7,particleRate:i.particleRate||1,minParticles:i.minParticles||3,maxParticles:i.maxParticles||4,particleBehavior:i.particleBehavior||"ambient",coreSize:i.coreSize||1,breathRate:i.breathRate||1,breathDepth:i.breathDepth||.1})}),t}initializeUndertoneModifiers(){this.undertoneModifiers={nervous:{jitterAmount:.3,breathRateMultiplier:1.2,glowIntensityMultiplier:.9,particleRateMultiplier:1.1},confident:{coreSizeMultiplier:1.1,glowIntensityMultiplier:1.2,breathRateMultiplier:.9,particleRateMultiplier:1},tired:{breathRateMultiplier:.7,particleRateMultiplier:.5,glowIntensityMultiplier:.8,coreSizeMultiplier:.95},intense:{amplificationFactor:1.3},subdued:{dampeningFactor:.7}}}setEmotion(t,e=null,i=500){return this.errorBoundary.wrap(()=>{if(this.interpolationCache.cachedProperties=null,this.interpolationCache.cachedRenderState=null,!B(t)&&!{}.hasOwnProperty.call(this.emotionalStates,t)){const e=[...Object.keys(this.emotionalStates),...P()],i=[...new Set(e)];throw new Error(`Invalid emotion: ${t}. Valid emotions: ${i.join(", ")}`)}if(null!==e&&!{}.hasOwnProperty.call(this.undertoneModifiers,e))throw new Error(`Invalid undertone: ${e}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.emotion===t&&this.state.undertone===e||(this.state.emotion!==t&&(i>0?(this.transitions.emotional={current:this.state.emotion,target:t,progress:0,duration:Math.max(100,i),startTime:performance.now(),isActive:!0},void 0!==this.t&&(this.t=0)):this.transitions.emotional={current:t,target:null,progress:1,duration:0,startTime:performance.now(),isActive:!1},this.state.emotion=t),this.state.undertone!==e&&(this.transitions.undertone={current:this.state.undertone,target:e,progress:0,duration:300,startTime:performance.now(),isActive:!0,currentWeight:this.state.undertone?1:0,targetWeight:e?1:0},this.state.undertone=e)),!0},"emotion-setting",!1)()}applyUndertone(t,e){if(!e||!{}.hasOwnProperty.call(this.undertoneModifiers,e))return{...t};const i=this.undertoneModifiers[e],s={...t};if(void 0!==i.glowIntensityMultiplier&&(s.glowIntensity*=i.glowIntensityMultiplier),void 0!==i.breathRateMultiplier&&(s.breathRate*=i.breathRateMultiplier),void 0!==i.particleRateMultiplier&&(s.particleRate=Math.round(s.particleRate*i.particleRateMultiplier)),void 0!==i.coreSizeMultiplier&&(s.coreSize*=i.coreSizeMultiplier),void 0!==i.amplificationFactor){const t=i.amplificationFactor;s.glowIntensity*=t,s.breathRate*=t,s.particleRate=Math.round(s.particleRate*t),s.coreSize*=t}if(void 0!==i.dampeningFactor){const t=i.dampeningFactor;s.glowIntensity*=t,s.breathRate*=t,s.particleRate=Math.round(s.particleRate*t),s.coreSize*=t}return void 0!==i.jitterAmount&&(s.jitterAmount=i.jitterAmount),s}update(t){this.errorBoundary.wrap(()=>{this.transitions.emotional.isActive&&this.updateEmotionalTransition(t),this.transitions.undertone.isActive&&this.updateUndertoneTransition(t)},"state-machine-update")()}updateUndertoneTransition(t){const e=this.transitions.undertone,i=performance.now()-e.startTime,s=Math.min(i/e.duration,1),n=g(s);e.current&&e.target?(e.currentWeight=1-n,e.targetWeight=n):e.current&&!e.target?(e.currentWeight=1-n,e.targetWeight=0):!e.current&&e.target&&(e.currentWeight=0,e.targetWeight=n),e.progress=s,s>=1&&(e.isActive=!1,e.current=e.target,e.currentWeight=e.target?1:0,e.targetWeight=0)}updateEmotionalTransition(t){const e=this.transitions.emotional;let i;void 0!==this.t?(this.t+=t,i=this.t):i=performance.now()-e.startTime,e.progress=Math.min(1,i/e.duration),e.progress>=1&&(e.isActive=!1,e.current=e.target,e.target=null,e.progress=1)}getCurrentEmotionalProperties(){return this.errorBoundary.wrap(()=>{const t=performance.now();if(this.interpolationCache.cachedProperties&&t-this.interpolationCache.lastUpdate<this.interpolationCache.cacheInterval)return this.interpolationCache.cachedProperties;const e=this.transitions.emotional;let i;return i=e.isActive&&e.target?this.interpolateEmotionalProperties(e.current,e.target,e.progress):{...this.emotionalStates[this.state.emotion]||this.emotionalStates.neutral},i=this.applyUndertone(i,this.state.undertone),this.interpolationCache.cachedProperties=i,this.interpolationCache.lastUpdate=t,i},"emotional-properties",()=>this.emotionalStates.neutral)()}interpolateEmotionalProperties(t,e,i){const s=this.emotionalStates[t]||this.emotionalStates.neutral,n=this.emotionalStates[e]||this.emotionalStates.neutral,r=S(i,0,1,"easeOutCubic");return{primaryColor:a(s.primaryColor,n.primaryColor,r),glowIntensity:s.glowIntensity+(n.glowIntensity-s.glowIntensity)*r,particleRate:Math.round(s.particleRate+(n.particleRate-s.particleRate)*r),coreSize:s.coreSize+(n.coreSize-s.coreSize)*r,breathRate:s.breathRate+(n.breathRate-s.breathRate)*r,breathDepth:s.breathDepth+(n.breathDepth-s.breathDepth)*r,particleBehavior:r>.5?n.particleBehavior:s.particleBehavior}}getCurrentState(){return{emotion:this.state.emotion,undertone:this.state.undertone,isTransitioning:this.transitions.emotional.isActive,transitionProgress:this.transitions.emotional.progress,properties:this.getCurrentEmotionalProperties()}}applyUndertoneModifier(t){return this.errorBoundary.wrap(()=>{if(null!==t&&!{}.hasOwnProperty.call(this.undertoneModifiers,t))throw new Error(`Invalid undertone: ${t}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.undertone=t,!0},"undertone-application",!1)()}clearUndertone(){this.state.undertone=null}getUndertoneModifier(t){return this.errorBoundary.wrap(()=>{if(this.renderer&&this.renderer.undertoneModifiers&&this.renderer.undertoneModifiers[t])return{...this.renderer.undertoneModifiers[t]};if(!t||!{}.hasOwnProperty.call(this.undertoneModifiers,t))return null;const e={...this.undertoneModifiers[t]};return e.glowRadiusMult||(e.glowRadiusMult=1),e},"undertone-retrieval",null)()}getWeightedUndertoneModifiers(){const t=this.transitions.undertone;if(!t.isActive){if(this.state.undertone){const t=this.getUndertoneModifier(this.state.undertone);if(t)return{...t,weight:1,type:this.state.undertone}}return null}if(t.target){const e=this.getUndertoneModifier(t.target);if(e)return{...e,weight:t.targetWeight,type:t.target}}if(t.current&&t.currentWeight>0){const e=this.getUndertoneModifier(t.current);if(e)return{...e,weight:t.currentWeight,type:t.current}}return null}reset(t=500){this.setEmotion("neutral",null,t)}isValidEmotion(t){return{}.hasOwnProperty.call(this.emotionalStates,t)}isValidUndertone(t){return null===t||{}.hasOwnProperty.call(this.undertoneModifiers,t)}getAvailableEmotions(){return Object.keys(this.emotionalStates)}getAvailableUndertones(){return Object.keys(this.undertoneModifiers)}isTransitioning(){return this.transitions.emotional.isActive}getTransitionProgress(){return this.transitions.emotional.isActive?this.transitions.emotional.progress:1}completeTransition(){this.transitions.emotional.isActive&&(this.transitions.emotional.progress=1,this.transitions.emotional.isActive=!1,this.transitions.emotional.current=this.transitions.emotional.target,this.transitions.emotional.target=null)}interpolateProperty(t,e,i,s="easeOutCubic"){return t+(e-t)*S(i,0,1,s)}enableSimulatedTime(t=!0){t?this.t=0:delete this.t}}const G=new class{constructor(){this.bpm=120,this.timeSignature=[4,4],this.isPlaying=!1,this.startTime=0,this.currentBeat=0,this.currentBar=0,this.beatProgress=0,this.barProgress=0,this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.lastBeatTime=0,this.nextBeatTime=0,this.listeners=new Map,this.beatCallbacks=new Set,this.barCallbacks=new Set,this.subdivisions={sixteenth:0,eighth:0,triplet:0,swing:0},this.audioSync=null,this.syncOffset=0,this.autoSync=!1,this.intensity=1,this.groove=0,this.humanize=.05,this.patterns=new Map,this.currentPattern=null,this.initializePatterns()}initializePatterns(){this.patterns.set("4/4",{name:"4/4",description:"Common time - 4 beats per bar",timeSignature:[4,4],groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("straight",{name:"straight",description:"Straight, even timing",groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("swing",{name:"swing",description:"Swing/shuffle timing",groove:.67,accents:[1,.3,.8,.3]}),this.patterns.set("3/4",{name:"3/4",description:"Waltz time - 3 beats per bar",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("waltz",{name:"waltz",description:"3/4 waltz timing",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("6/8",{name:"6/8",description:"Compound duple time",timeSignature:[6,8],accents:[1,.3,.3,.7,.3,.3]}),this.patterns.set("5/4",{name:"5/4",description:"Complex meter - 5 beats per bar",timeSignature:[5,4],accents:[1,.5,.6,.5,.7]}),this.patterns.set("7/8",{name:"7/8",description:"Irregular meter",timeSignature:[7,8],accents:[1,.5,.5,.7,.5,.5,.6]}),this.patterns.set("dubstep",{name:"dubstep",description:"Dubstep half-time feel",accents:[.2,.2,1,.2],subdivisions:{wobble:!0}}),this.patterns.set("breakbeat",{name:"breakbeat",description:"Broken beat pattern",accents:[1,.2,.7,.9,.2,.8,.4,.2]})}start(){this.isPlaying||(this.isPlaying=!0,this.isRunning=!0,this.startTime=performance.now(),this.lastBeatTime=this.startTime,this.nextBeatTime=this.startTime+this.beatDuration,this.currentBeat=0,this.currentBar=0,this.emit("start",{bpm:this.bpm,timeSignature:this.timeSignature,pattern:this.currentPattern}),this.update())}stop(){this.isPlaying&&(this.isPlaying=!1,this.emit("stop",{totalBeats:this.currentBeat,totalBars:this.currentBar}))}update(){if(!this.isPlaying)return;const t=(performance.now()-this.startTime)/this.beatDuration,e=Math.floor(t);this.beatProgress=t%1,e>this.currentBeat&&this.onBeat(e);const i=Math.floor(e/this.timeSignature[0]);i>this.currentBar&&this.onBar(i),this.currentBeat=e,this.currentBar=i,this.barProgress=e%this.timeSignature[0]/this.timeSignature[0],this.updateSubdivisions(),this.emit("update",this.getTimeInfo()),this.isPlaying&&requestAnimationFrame(()=>this.update())}onBeat(t){const e=t%this.timeSignature[0],i=this.getAccent(e),s=this.humanize*(Math.random()-.5)*this.beatDuration,n={beat:t,beatInBar:e,bar:this.currentBar,accent:i,intensity:this.intensity*i,humanTiming:s,timestamp:performance.now()};this.emit("beat",n),this.beatCallbacks.forEach(t=>t(n)),this.lastBeatTime=performance.now(),this.nextBeatTime=this.lastBeatTime+this.beatDuration}onBar(t){const e={bar:t,timeSignature:this.timeSignature,pattern:this.currentPattern,timestamp:performance.now()};this.emit("bar",e),this.barCallbacks.forEach(t=>t(e))}updateSubdivisions(){if(this.subdivisions.sixteenth=4*this.beatProgress%1,this.subdivisions.eighth=2*this.beatProgress%1,this.subdivisions.triplet=3*this.beatProgress%1,this.groove>0){const t=.5+.17*this.groove;this.subdivisions.eighth<.5?this.subdivisions.swing=this.subdivisions.eighth/t:this.subdivisions.swing=.5+(this.subdivisions.eighth-.5)/(1-t)}else this.subdivisions.swing=this.subdivisions.eighth}getAccent(t){if(this.currentPattern&&this.patterns.has(this.currentPattern)){const e=this.patterns.get(this.currentPattern);if(e.accents&&void 0!==e.accents[t])return e.accents[t]}return 0===t?1:2===t&&4===this.timeSignature[0]?.7:.5}getTimeInfo(){return{elapsed:performance.now()-this.startTime,beat:this.currentBeat,bar:this.currentBar,beatInBar:this.currentBeat%this.timeSignature[0],beatProgress:this.beatProgress,barProgress:this.barProgress,subdivisions:{...this.subdivisions},bpm:this.bpm,beatDuration:this.beatDuration,timeSignature:[...this.timeSignature],intensity:this.intensity,groove:this.groove,pattern:this.currentPattern,nextBeatIn:this.nextBeatTime-performance.now(),accent:this.getAccent(this.currentBeat%this.timeSignature[0])}}setBPM(t){this.bpm=Math.max(20,Math.min(360,t)),this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.emit("tempoChange",{bpm:this.bpm})}setTimeSignature(t,e){this.timeSignature=[t,e],this.barDuration=this.beatDuration*t,this.emit("timeSignatureChange",{timeSignature:this.timeSignature})}setPattern(t){if(!this.patterns.has(t))return;const e=this.patterns.get(t);this.currentPattern=t,e.timeSignature&&this.setTimeSignature(...e.timeSignature),void 0!==e.groove&&(this.groove=e.groove),this.emit("patternChange",{pattern:t})}onBeatCallback(t){return this.beatCallbacks.add(t),()=>this.beatCallbacks.delete(t)}onBarCallback(t){return this.barCallbacks.add(t),()=>this.barCallbacks.delete(t)}emit(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(t=>t(e))}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.has(t)&&this.listeners.get(t).delete(e)}}syncToAudio(t,e){this.audioSync={context:t,source:e}}getAdapter(){return{getTimeInfo:()=>this.getTimeInfo(),isOnBeat:(t=.1)=>this.beatProgress<t||this.beatProgress>1-t,isOnSubdivision:(t,e=.1)=>{const i=this.subdivisions[t]||0;return i<e||i>1-e},getBeatSync:(t=0,e=1,i="linear")=>{let s=this.beatProgress;switch(i){case"ease":s=.5-Math.cos(s*Math.PI)/2;break;case"bounce":s=Math.abs(Math.sin(s*Math.PI));break;case"pulse":s=Math.pow(Math.sin(s*Math.PI),2)}return t+(e-t)*s},getAccentedValue:(t,e=2)=>t*(1+(this.getAccent(this.currentBeat%this.timeSignature[0])-.5)*e),onBeat:t=>this.onBeatCallback(t),onBar:t=>this.onBarCallback(t),beatsToMs:t=>t*this.beatDuration,msToBeats:t=>t/this.beatDuration,isPlaying:()=>this.isPlaying,getBPM:()=>this.bpm,getPattern:()=>this.currentPattern}}},U=new class{constructor(){this.enabled=!1,this.adapter=null,this.subsystemConfigs=new Map,this.activeModulations=new Map}initialize(){this.adapter=G.getAdapter(),this.enabled=!0,this.adapter.onBeat(this.handleBeat.bind(this)),this.adapter.onBar(this.handleBar.bind(this))}updateBPM(t){if(t>=60&&t<=220){if(window.rhythmManuallyStoppedForCurrentAudio)return;if(!G.isRunning)return this.start(t,"straight"),void(window.rhythmSyncVisualizer&&!window.rhythmSyncVisualizer.state.active&&window.rhythmSyncVisualizer.start());G.setBPM(t)}}registerConfig(t,e,i){if(!i.rhythm||!i.rhythm.enabled)return;const s=`${t}:${e}`;this.subsystemConfigs.set(s,{type:t,name:e,rhythmConfig:i.rhythm,originalConfig:i})}applyGestureRhythm(t,e,i,s){if(!this.enabled||!t.rhythm?.enabled)return{};const n=t.rhythm,r={};if(n.amplitudeSync){const t=n.amplitudeSync,e=this.adapter.getBeatSync(t.offBeat||.8,t.onBeat||1.5,t.curve||"linear");r.amplitudeMultiplier=e}if(n.wobbleSync){const t=n.wobbleSync;this.adapter.isOnSubdivision(t.subdivision,.1)?r.wobbleMultiplier=1+t.intensity:r.wobbleMultiplier=1}if(n.accentResponse?.enabled){const t=this.adapter.getAccentedValue(1,n.accentResponse.multiplier||1.5);r.accentMultiplier=t}const o=this.adapter.getPattern();return o&&n.patternOverrides?.[o]&&Object.assign(r,n.patternOverrides[o]),r}applyParticleRhythm(t,e){if(!this.enabled||!t.rhythm?.enabled)return{};const i=this.adapter.getTimeInfo(),s=t.rhythm,n={};if(s.particleEmission){const t=s.particleEmission;"beat"===t.syncMode&&this.adapter.isOnBeat(.1)?n.emitBurst=t.burstSize||3:void 0!==t.offBeatRate&&(n.emissionRate=t.offBeatRate)}if(s.glowSync){const t=s.glowSync,e=this.adapter.getBeatSync(t.intensityRange[0]||1,t.intensityRange[1]||2,"pulse");n.glowIntensity=e}if("bars"===s.breathSync?.mode){const t=s.breathSync,e=i.bar%t.barsPerBreath/t.barsPerBreath;n.breathPhase=e*Math.PI*2}return n}applyBehaviorRhythm(t,e,i){if(!this.enabled||!t.rhythm?.enabled)return{};const s=this.adapter.getTimeInfo(),n=t.rhythm,r={};if(n.glitchTiming){const t=n.glitchTiming;if(this.adapter.isOnSubdivision(t.subdivision,.05)&&Math.random()<t.probability){const e=this.adapter.isOnBeat()?t.intensityOnBeat:t.intensityOffBeat;r.triggerGlitch=!0,r.glitchIntensity=e}}if(n.orbitRhythm){const t=n.orbitRhythm;"tempo"===t.baseSpeed&&(r.speedMultiplier=this.adapter.getBPM()/120),t.beatAcceleration&&this.adapter.isOnBeat(.1)&&(r.speedBoost=t.beatAcceleration),t.barReset&&0===s.beatInBar&&(r.resetOrbit=!0)}if(n.stutterSync){const t=n.stutterSync,e=this.adapter.getPattern();if(e&&t.patterns?.[e]){const i=t.patterns[e];i.freezeOnDrop&&2===s.beatInBar?(r.freeze=!0,r.freezeDuration=i.dropDuration):i.randomFreeze&&Math.random()<i.randomFreeze&&(r.freeze=!0,r.freezeDuration=i.duration)}}return r}handleBeat(t){this.lastBeatInfo=t}handleBar(t){this.lastBarInfo=t}getMusicalDuration(t,e){if(!this.enabled||!t?.durationSync)return e;const i=t.durationSync;return"bars"===i.mode?this.adapter.beatsToMs(4*i.bars):"beats"===i.mode?this.adapter.beatsToMs(i.beats):e}isEnabled(){return this.enabled&&this.adapter.isPlaying()}start(t=120,e="straight"){t&&G.setBPM(t),e&&G.setPattern(e),G.start(),this.enabled=!0}stop(){G.stop(),this.enabled=!1,this.bpmLocked=!1,this.lockedBPM=null}setPattern(t){G.setPattern(t)}setBPM(t){G.setBPM(t),this.bpmLocked&&(this.lockedBPM=t)}resampleBPM(){this.bpmLocked=!1,this.lockedBPM=null}setTimeSignature(t){this.timeSignature=t;const e=document.getElementById("time-sig-display");e&&(e.textContent=t),"3/4"===t&&G.getPattern()}syncToAudio(t,e){G.syncToAudio(t,e)}};function W(t){if(!t||0===t.length)return"#FFFFFF";let e=0,i=0;const s=[];for(const n of t)"string"==typeof n?(s.push({color:n,weight:null}),i++):n&&"object"==typeof n&&n.color&&(s.push({color:n.color,weight:n.weight||null}),n.weight?e+=n.weight:i++);const n=Math.max(0,100-e),r=i>0?n/i:0,o=[];let a=0;for(const t of s)a+=null!==t.weight?t.weight:r,o.push({color:t.color,threshold:a});const h=Math.random()*a;for(const t of o)if(h<=t.threshold)return t.color;return s[s.length-1].color}var H={name:"ambient",emoji:"☁️",description:"Gentle upward drift like smoke",initialize:function(t){t.vx=0,t.vy=-.04-.02*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={upwardSpeed:5e-4,waviness:0,friction:.998}},update:function(t,e,i,s){const n=t.behaviorData;t.vy*=Math.pow(n.friction,e),t.vy-=n.upwardSpeed*e,t.vx=0}};const V=2*Math.PI;var Y={name:"orbiting",emoji:"💕",description:"Romantic firefly dance around the orb",initialize:function(t){t.lifeDecay=.001+.002*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.isSparkle="#FFE4E1"===t.color||"#FFCCCB"===t.color||"#FFC0CB"===t.color;const e=40*(t.scaleFactor||1)*(1.3+.9*Math.random());t.blinkPhase=Math.random()*V,t.blinkSpeed=.3+1.2*Math.random(),t.blinkIntensity=.6+.4*Math.random(),t.fadePhase=Math.random()*V,t.fadeSpeed=.1+.3*Math.random(),t.minOpacity=.2+.2*Math.random(),t.maxOpacity=.8+.2*Math.random(),t.isSparkle&&(t.blinkSpeed*=2,t.blinkIntensity=1,t.minOpacity=0,t.maxOpacity=1),t.behaviorData={angle:Math.random()*V,radius:e,baseRadius:e,angularVelocity:8e-4+.0017*Math.random(),swayAmount:3+7*Math.random(),swaySpeed:.2+.5*Math.random(),floatOffset:Math.random()*V,floatSpeed:.3+.7*Math.random(),floatAmount:2+6*Math.random(),twinklePhase:Math.random()*V,twinkleSpeed:2+3*Math.random()}},update:function(t,e,i,s){const n=t.behaviorData;n.angle+=n.angularVelocity*e;const r=Math.sin(n.angle*n.swaySpeed)*n.swayAmount,o=6*Math.sin(1.5*n.angle),a=(n.radius||n.baseRadius)+o+.2*r,h=i+Math.cos(n.angle)*a,c=s+Math.sin(n.angle)*a;n.floatOffset+=n.floatSpeed*e*.001;const u=Math.sin(n.floatOffset)*n.floatAmount;t.vx=.1*(h-t.x),t.vy=.1*(c+u-t.y),t.fadePhase+=t.fadeSpeed*e*.001;const l=.5*Math.sin(t.fadePhase)+.5,d=t.minOpacity+(t.maxOpacity-t.minOpacity)*l;let p;t.blinkPhase+=t.blinkSpeed*e*.002,t.isSparkle?(n.twinklePhase+=n.twinkleSpeed*e*.001,p=.7*Math.pow(Math.sin(n.twinklePhase),16)+.2*Math.sin(5*t.blinkPhase)+.1):p=.4*Math.sin(t.blinkPhase)+.3*Math.sin(3*t.blinkPhase)+.2*Math.sin(7*t.blinkPhase)+.1*Math.sin(11*t.blinkPhase);const f=.5*(p+1),m=.2+f*t.blinkIntensity*.8;t.opacity=t.baseOpacity*d*m,t.isSparkle?t.size=t.baseSize*(.5+1*f):t.size=t.baseSize*(.8+.3*f),t.isSparkle&&(t.tempColor=f>.85?"#FFFFFF":t.color)}},X={name:"rising",emoji:"🎈",description:"Buoyant upward movement like balloons",initialize:function(t){t.vx=.02*(Math.random()-.5),t.vy=-.05-.03*Math.random(),t.lifeDecay=.002,t.baseOpacity=.7+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={buoyancy:.001,driftAmount:.005}},update:function(t,e,i,s){const n=t.behaviorData;t.vy-=n.buoyancy*e,t.vx+=(Math.random()-.5)*n.driftAmount*e,t.vx*=Math.pow(.995,e),t.vy*=Math.pow(.998,e)}},J={name:"falling",emoji:"💧",description:"Heavy downward drift like tears",initialize:function(t){t.vx=.03*(Math.random()-.5),t.vy=.05+.05*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={gravity:.002,drag:.995}},update:function(t,e,i,s){const n=t.behaviorData;t.vy+=n.gravity*e,t.vx*=Math.pow(n.drag,e),t.vy*=Math.pow(n.drag,e),t.vy>2&&(t.vy=2)}};var K={name:"popcorn",emoji:"🍿",description:"Spontaneous popping with gravity and bounces",initialize:function(t){if(t.vx=.1*(Math.random()-.5),t.vy=.1*(Math.random()-.5),t.lifeDecay=.008+.012*Math.random(),t.emotionColors&&t.emotionColors.length>0)t.color=W(t.emotionColors);else{const e=["#FFFFFF","#FFFACD","#FFF8DC","#FFFFE0","#FAFAD2"];t.color=W(e)}t.size=Math.random()<.3?(8+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier:(2+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier,t.baseSize=t.size,t.hasGlow=Math.random()<.2,t.glowSizeMultiplier=t.hasGlow?1.2:0,t.behaviorData={popDelay:2e3*Math.random(),hasPopped:!1,popStrength:3+5*Math.random(),gravity:.098,bounceDamping:.7,bounceCount:0,maxBounces:2+Math.floor(2*Math.random()),spinRate:10*(Math.random()-.5),lifetime:0}},update:function(t,e,i,s){const n=t.behaviorData;if(n.lifetime+=16.67*e,!n.hasPopped&&n.lifetime>n.popDelay){n.hasPopped=!0;const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*n.popStrength*1.5,t.vy=Math.sin(e)*n.popStrength-.3,t.size=1.25*t.baseSize}if(n.hasPopped){t.vy+=n.gravity*e;const i=s+100*t.scaleFactor;t.y>i&&n.bounceCount<n.maxBounces&&(t.y=i,t.vy=-Math.abs(t.vy)*n.bounceDamping,t.vx*=.9,n.bounceCount++,t.size=t.baseSize*(1.5-.1*n.bounceCount)),n.bounceCount>=n.maxBounces&&(t.lifeDecay=.03+.02*Math.random(),t.size*=.95),Math.sqrt(t.vx*t.vx+t.vy*t.vy)<.5&&(t.lifeDecay*=1.5)}}},Q={name:"burst",emoji:"💥",description:"Explosive expansion from center",initialize:function(t){const e="suspicion"===t.emotion,i="surprise"===t.emotion,s="glitch"===t.emotion,n=Math.random()*V,r=e?1+.8*Math.random():i?7+5*Math.random():s?2+1.5*Math.random():3.5+2.5*Math.random();t.vx=Math.cos(n)*r,t.vy=Math.sin(n)*r,t.lifeDecay=e?.01:i?.006+.008*Math.random():s?.012:.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),e&&(t.size=(6+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.opacity=1,t.baseOpacity=t.opacity),t.behaviorData={isSuspicion:e,isSurprise:i,isGlitch:s,age:0,fadeStart:e?.3:.2,glitchPhase:Math.random()*Math.PI*2,glitchIntensity:s?.3:0,glitchFrequency:s?.1:0}},update:function(t,e,i,s){const n=t.behaviorData;if(n.isSurprise)if(n.age+=.016*e,n.age<.15){const i=.98;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}else if(n.age<.25){const i=.85;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}else{const i=.99;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e),t.vx+=.01*(Math.random()-.5)*e,t.vy+=.01*(Math.random()-.5)*e}else{const i=n.isSuspicion?.99:n.isGlitch?.97:.95;t.vx*=Math.pow(i,e),t.vy*=Math.pow(i,e)}if(n.isSuspicion){const i=.001*Date.now();t.vx+=.01*Math.sin(2*i+t.id)*e}if(n.isGlitch){n.age+=.016*e,n.glitchPhase+=n.glitchFrequency*e;const i=Math.sin(n.glitchPhase)*n.glitchIntensity*e,s=Math.cos(1.3*n.glitchPhase)*n.glitchIntensity*e;if(t.vx+=i,t.vy+=s,Math.random()<.02){const e=Math.random()*Math.PI*2,i=.5+.5*Math.random();t.vx+=Math.cos(e)*i,t.vy+=Math.sin(e)*i}}}},Z={name:"aggressive",emoji:"⚡",description:"Sharp, chaotic movement with violent bursts",initialize:function(t){const e=Math.random()*V,i=1.5+2*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={acceleration:.05,jitter:.3,speedDecay:.95}},update:function(t,e,i,s){const n=t.behaviorData;if(t.vx+=(Math.random()-.5)*n.jitter*e,t.vy+=(Math.random()-.5)*n.jitter*e,t.vx*=Math.pow(n.speedDecay,e),t.vy*=Math.pow(n.speedDecay,e),Math.random()<Math.min(.05*e,.5)){const e=Math.random()*V;t.vx+=Math.cos(e)*n.acceleration,t.vy+=Math.sin(e)*n.acceleration}}},tt={name:"scattering",emoji:"😨",description:"Particles flee from center in panic",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.008,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={fleeSpeed:2,panicFactor:1.2,initialized:!1}},update:function(t,e,i,s){const n=t.behaviorData;if(!n.initialized){const e=t.x-i,r=t.y-s,o=Math.sqrt(e*e+r*r);if(o>0)t.vx=e/o*n.fleeSpeed,t.vy=r/o*n.fleeSpeed;else{const e=Math.random()*V;t.vx=Math.cos(e)*n.fleeSpeed,t.vy=Math.sin(e)*n.fleeSpeed}n.initialized=!0}const r=t.x-i,o=t.y-s,a=Math.sqrt(r*r+o*o);a>0&&(t.vx+=r/a*n.panicFactor*.01*e,t.vy+=o/a*n.panicFactor*.01*e),t.vx+=.1*(Math.random()-.5)*e,t.vy+=.1*(Math.random()-.5)*e,t.vx*=Math.pow(.98,e),t.vy*=Math.pow(.98,e)}},et={name:"repelling",emoji:"🚫",description:"Particles pushed away from center, maintaining distance",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.01,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={repelStrength:.8,minDistance:50,initialized:!1}},update:function(t,e,i,s){const n=t.behaviorData,r=t.x-i,o=t.y-s,a=Math.sqrt(r*r+o*o);if(!n.initialized||a<n.minDistance){if(a>0){const i=n.repelStrength/Math.max(a,5);t.vx+=r/a*i*e,t.vy+=o/a*i*e}n.initialized=!0}t.vx*=Math.pow(.99,e),t.vy*=Math.pow(.99,e)}},it={name:"connecting",emoji:"🔗",description:"Chaotic movement with center attraction for social states",initialize:function(t){const e=Math.random()*V,i=2+5*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.012,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={attractionForce:.008,chaosFactor:1,friction:.95}},update:function(t,e,i,s){const n=t.behaviorData;t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e);const r=(i-t.x)*n.attractionForce,o=(s-t.y)*n.attractionForce,a=(Math.random()-.5)*n.chaosFactor,h=(Math.random()-.5)*n.chaosFactor;t.vx+=r+a,t.vy+=o+h}},st={name:"resting",emoji:"😴",description:"Ultra-slow vertical drift for deep rest states",initialize:function(t){t.vx=0,t.vy=-.01,t.lifeDecay=.001,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={upwardSpeed:2e-5,friction:.999}},update:function(t,e,i,s){const n=t.behaviorData;t.vy*=Math.pow(n.friction,e),t.vy-=n.upwardSpeed*e,t.vx=0}},nt={name:"radiant",emoji:"☀️",description:"Particles radiate outward like sunbeams",initialize:function(t){const e=Math.random()*V,i=.8+.4*Math.random();if(t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.006,t.emotionColors&&t.emotionColors.length>0)t.color=W(t.emotionColors);else{const e=["#FFD700","#FFB347","#FFA500","#FF69B4"];t.color=W(e)}t.hasGlow=Math.random()<.7,t.glowSizeMultiplier=t.hasGlow?1.5+.5*Math.random():0,t.behaviorData={radialSpeed:.02,shimmer:Math.random()*V,shimmerSpeed:.1,friction:.99}},update:function(t,e,i,s){const n=t.behaviorData,r=t.x-i,o=t.y-s,a=Math.sqrt(r*r+o*o);if(a>0){const i=r/a,s=o/a;t.vx+=i*n.radialSpeed*e,t.vy+=s*n.radialSpeed*e}n.shimmer+=n.shimmerSpeed*e;const h=Math.sin(n.shimmer);t.size=t.baseSize*(1+.2*h),t.opacity=t.baseOpacity*(1+.3*h),t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e)}};function rt(t){t.vx=.02*(Math.random()-.5),t.vy=-.03-.02*Math.random(),t.lifeDecay=8e-4,t.size=(6+6*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1)*1.33,t.baseSize=t.size,t.baseOpacity=.2+.2*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={ascensionSpeed:3e-4,waveFactor:.5,waveFrequency:.001,friction:.998,fadeStartDistance:100}}var ot={name:"ascending",emoji:"🧘",description:"Slow steady upward float like incense smoke",initialize:rt,update:function(t,e,i,s){const n=t.behaviorData;if(!n)return void rt(t);t.vx*=Math.pow(n.friction,e),t.vy*=Math.pow(n.friction,e),t.vy-=n.ascensionSpeed*e;const r=Math.sin(t.age*n.waveFrequency*1e3)*n.waveFactor;t.vx+=.001*r*e,void 0===t.initialY&&(t.initialY=t.y);const o=t.initialY-t.y;if(o>n.fadeStartDistance){const e=(o-n.fadeStartDistance)/100,i=Math.max(0,1-e);t.baseOpacity*=.995,i<.5&&(t.lifeDecay*=1.02)}Math.abs(t.vx)>.05&&(t.vx*=Math.pow(.95,e)),t.vy<-.1&&(t.vy=-.1)}},at={name:"erratic",emoji:"😰",description:"Nervous jittery movement for anxious states",initialize:function(t){const e=Math.random()*V,i=.1+.15*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.004,t.size=(2+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.4+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={jitterStrength:.02,directionChangeRate:.1,speedVariation:.3,spinRate:.05+.1*Math.random()}},update:function(t,e){const i=t.behaviorData;if(t.vx+=(Math.random()-.5)*i.jitterStrength*e,t.vy+=(Math.random()-.5)*i.jitterStrength*e,Math.random()<Math.min(i.directionChangeRate*e,.5)){const e=Math.random()*V,i=Math.sqrt(t.vx*t.vx+t.vy*t.vy);t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i}const s=1+(Math.random()-.5)*i.speedVariation*e;t.vx*=s,t.vy*=s;const n=t.age*i.spinRate*1e3;t.size=t.baseSize*(1+.2*Math.sin(n)),t.opacity=t.baseOpacity*(.8+.4*Math.random()),t.vx*=Math.pow(.98,e),t.vy*=Math.pow(.98,e);const r=Math.sqrt(t.vx*t.vx+t.vy*t.vy);r>.5&&(t.vx=t.vx/r*.5,t.vy=t.vy/r*.5)}},ht={name:"cautious",emoji:"🤨",description:"Slow careful movement with watchful pauses",initialize:function(t){const e=Math.random()*V,i=.02+.03*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,t.lifeDecay=.001,t.life=1,t.size=(4+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.8+.2*Math.random(),t.opacity=t.baseOpacity,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={pauseTimer:2*Math.random(),pauseDuration:.5+.5*Math.random(),moveDuration:1+.5*Math.random(),isMoving:Math.random()>.5,moveTimer:0,originalVx:t.vx,originalVy:t.vy,watchRadius:50+30*Math.random()}},update:function(t,e,i,s){const n=t.behaviorData;if(n.moveTimer+=e,n.isMoving)n.moveTimer>n.moveDuration?(n.isMoving=!1,n.moveTimer=0,t.vx=0,t.vy=0):(t.vx=n.originalVx,t.vy=n.originalVy);else if(n.moveTimer>n.pauseDuration){n.isMoving=!0,n.moveTimer=0;const e=Math.random()*V,i=.02+.03*Math.random();t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,n.originalVx=t.vx,n.originalVy=t.vy}const r=t.x-i,o=t.y-s,a=Math.sqrt(r*r+o*o);if(a>n.watchRadius){const i=.02;t.vx-=r/a*i*e,t.vy-=o/a*i*e}t.vx*=Math.pow(.995,e),t.vy*=Math.pow(.995,e),n.isMoving?t.opacity=t.baseOpacity:t.opacity=t.baseOpacity*(.9+.1*Math.sin(5*t.age))}},ct={name:"surveillance",emoji:"👁️",description:"Searchlight scanning with paranoid watchfulness",initialize(t,e){t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorState={scanAngle:Math.random()*Math.PI-Math.PI/2,scanDirection:Math.random()<.5?1:-1,scanSpeed:.3+.2*Math.random(),scanRange:Math.PI/3+Math.random()*Math.PI/4,scanCenter:Math.random()*Math.PI*2,pauseTimer:0,pauseDuration:500+500*Math.random(),mode:"scanning",modeTimer:0,nextModeChange:2e3+3e3*Math.random(),dartTarget:{x:0,y:0},dartSpeed:0,patrolRadius:150+100*Math.random(),patrolAngle:Math.random()*Math.PI*2,alertLevel:0,lastPosition:{x:t.x,y:t.y}};const i=Math.random();i<.7?t.behaviorState.primaryRole="scanner":i<.9?(t.behaviorState.primaryRole="patroller",t.behaviorState.mode="patrolling"):(t.behaviorState.primaryRole="watcher",t.behaviorState.mode="frozen")},update(t,e,i){const s=t.behaviorState;if(s){switch(s.modeTimer+=16*e,s.modeTimer>s.nextModeChange&&(this.changeMode(t,s),s.modeTimer=0,s.nextModeChange=2e3+4e3*Math.random()),s.mode){case"scanning":this.updateScanning(t,e,s,i);break;case"darting":this.updateDarting(t,e,s,i);break;case"frozen":this.updateFrozen(t,e,s,i);break;case"patrolling":this.updatePatrolling(t,e,s,i)}t.vy+=.05*e,t.x+=t.vx*e,t.y+=t.vy*e,s.lastPosition.x=t.x,s.lastPosition.y=t.y}},updateScanning(t,e,i,s){i.pauseTimer>0?(i.pauseTimer-=16*e,t.vx*=.9,t.vy*=.9):(i.scanAngle+=i.scanDirection*i.scanSpeed*e*.02,Math.abs(i.scanAngle)>i.scanRange/2&&(i.scanDirection*=-1,i.pauseTimer=i.pauseDuration,i.scanAngle=Math.sign(i.scanAngle)*i.scanRange/2));const n=i.scanCenter+i.scanAngle,r=.8+.5*i.alertLevel;t.vx=Math.cos(n)*r,t.vy=Math.sin(n)*r*.3},updateDarting(t,e,i,s){const n=i.dartTarget.x-t.x,r=i.dartTarget.y-t.y,o=Math.sqrt(n*n+r*r);o>5?(t.vx=n/o*i.dartSpeed,t.vy=r/o*i.dartSpeed):(i.mode="scanning",i.modeTimer=0)},updateFrozen(t,e,i,s){t.vx*=.95,t.vy*=.95,Math.random()<.01&&(t.vx+=.5*(Math.random()-.5),t.vy+=.5*(Math.random()-.5))},updatePatrolling(t,e,i,s){i.patrolAngle+=.01*e;const n=Math.cos(i.patrolAngle)*i.patrolRadius,r=Math.sin(i.patrolAngle)*i.patrolRadius,o=n-t.x,a=r-t.y;t.vx=.02*o,t.vy=.02*a},changeMode(t,e){const i=Math.random();"scanner"===e.primaryRole?i<.1?(e.mode="darting",e.dartTarget={x:200*(Math.random()-.5),y:200*(Math.random()-.5)},e.dartSpeed=3+2*Math.random()):e.mode=i<.2?"frozen":"scanning":"patroller"===e.primaryRole?e.mode=i<.1?"frozen":"patrolling":e.mode=i<.3?"scanning":"frozen"}},ut={name:"glitchy",emoji:"⚡",description:"Digital glitch with stuttering orbits and corruption",rhythm:{enabled:!0,glitchTiming:{mode:"subdivision",subdivision:"sixteenth",probability:.3,intensityOnBeat:2,intensityOffBeat:.5},stutterSync:{mode:"pattern",patterns:{dubstep:{freezeOnDrop:!0,dropDuration:100},breakbeat:{randomFreeze:.1,duration:50}}},orbitRhythm:{baseSpeed:"tempo",wobbleSync:"eighth",beatAcceleration:1.5,barReset:!0},rgbSync:{enabled:!0,amount:"intensity",direction:"beat",maxSplit:10},noiseRhythm:{trigger:"accent",duration:50,intensity:"drop"}},initialize(t,e,i,s){t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorState={orbitAngle:Math.random()*Math.PI*2,orbitRadius:300+400*Math.random(),orbitSpeed:.01+.02*Math.random(),glitchTimer:0,nextGlitch:500*Math.random()+100,isGlitching:!1,glitchDuration:0,glitchOffset:{x:0,y:0},stutterTimer:0,nextStutter:200*Math.random()+50,isFrozen:!1,frozenPosition:{x:0,y:0},frozenVelocity:{x:0,y:0},hasGhost:Math.random()<.3,ghostOffset:20*Math.random()+10,ghostAngle:Math.random()*Math.PI*2,rgbSplit:Math.random()<.4,rgbPhase:Math.random()*Math.PI*2,noiseLevel:0,noiseBurst:!1,beatPhase:Math.random()*Math.PI*2,beatFrequency:.05+.03*Math.random(),dropIntensity:0},t.lifeDecay=.0015,t.hasGlow=!0,t.glowSizeMultiplier=3+2*Math.random()},update(t,e,i,s){const n=t.behaviorState;if(!n)return;n.glitchTimer+=16*e,n.stutterTimer+=16*e,n.stutterTimer>n.nextStutter&&(n.isFrozen?(n.isFrozen=!1,n.stutterTimer=0,n.nextStutter=100+300*Math.random(),Math.random()<.3&&(t.x+=60*(Math.random()-.5),t.y+=60*(Math.random()-.5))):(n.isFrozen=!0,n.frozenPosition={x:t.x,y:t.y},n.frozenVelocity={x:t.vx,y:t.vy},n.stutterTimer=0,n.nextStutter=20+40*Math.random())),n.glitchTimer>n.nextGlitch&&!n.isGlitching&&(n.isGlitching=!0,n.glitchDuration=50+100*Math.random(),n.glitchOffset={x:80*(Math.random()-.5),y:80*(Math.random()-.5)},n.glitchTimer=0,Math.random()<.5&&t.emotionColors&&(t.color=W(t.emotionColors))),n.isGlitching&&n.glitchTimer>n.glitchDuration&&(n.isGlitching=!1,n.glitchTimer=0,n.nextGlitch=200+800*Math.random(),n.glitchOffset={x:0,y:0}),n.beatPhase+=n.beatFrequency*e;const r=.5*Math.sin(n.beatPhase)+.5;if(n.beatPhase%(4*Math.PI)<.5*Math.PI?n.dropIntensity=Math.min(1,n.dropIntensity+.1*e):n.dropIntensity=Math.max(0,n.dropIntensity-.05*e),n.isFrozen)t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5);else{n.orbitAngle+=n.orbitSpeed*e*(1+.5*r);const o=n.orbitRadius*(1+.3*n.dropIntensity*Math.sin(4*n.beatPhase));let a=i+Math.cos(n.orbitAngle)*o,h=s+Math.sin(n.orbitAngle)*o*.6;if(n.isGlitching&&(a+=n.glitchOffset.x*Math.random()*.8,h+=n.glitchOffset.y*Math.random()*.8),n.rgbSplit){const t=3*(1+n.dropIntensity);a+=Math.sin(n.rgbPhase)*t,h+=Math.cos(n.rgbPhase)*t,n.rgbPhase+=.1*e}n.dropIntensity>.8&&Math.random()<.1&&(a+=30*(Math.random()-.5),h+=30*(Math.random()-.5));const c=n.isGlitching?.02:.03;t.vx=(a-t.x)*c,t.vy=(h-t.y)*c,t.vx+=(Math.random()-.5)*r*2,t.vy+=(Math.random()-.5)*r*2}t.x+=t.vx*e,t.y+=t.vy*e,Math.random()<.02&&(t.opacity=.1+.9*Math.random()),t.size=t.baseSize*(1+.3*r+.5*n.dropIntensity)}},lt={name:"spaz",description:"Ultra-aggressive particles with explosive spread and chaotic motion",initialize(t,e,i,s){t.x=i,t.y=s,t.life=1,t.size=3+4*Math.random();const n=Math.random()*Math.PI*2,r=200+300*Math.random();t.vx=Math.cos(n)*r,t.vy=Math.sin(n)*r,t.behaviorState={explosionPhase:0,explosionTimer:0,explosionDuration:1e3+2e3*Math.random(),chaosTimer:0,nextChaosChange:100+200*Math.random(),chaosAngle:n,chaosSpeed:50+100*Math.random(),spazIntensity:.8+.4*Math.random(),zigzagPattern:Math.random()<.5,spiralPattern:Math.random()<.3,teleportChance:.02,sizePulse:!0,sizePulseSpeed:.1+.05*Math.random(),sizePulsePhase:Math.random()*Math.PI*2,colorShift:Math.random()<.3,colorShiftSpeed:.05+.03*Math.random()},t.lifeDecay=8e-4,t.hasGlow=!0,t.glowSizeMultiplier=4+3*Math.random(),t.glowIntensity=1.5+.5*Math.random()},update(t,e,i,s){const n=t.behaviorState;if(n.explosionTimer+=e,n.chaosTimer+=e,0===n.explosionPhase&&n.explosionTimer<500)t.vx*=.98,t.vy*=.98,Math.random()<.1&&(t.vx+=100*(Math.random()-.5),t.vy+=100*(Math.random()-.5));else if(0===n.explosionPhase&&n.explosionTimer>=500)n.explosionPhase=1,n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=30+70*Math.random();else if(1===n.explosionPhase){n.chaosTimer>=n.nextChaosChange&&(n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=20+80*Math.random(),n.nextChaosChange=50+150*Math.random(),n.chaosTimer=0);const e=Math.cos(n.chaosAngle)*n.chaosSpeed,i=Math.sin(n.chaosAngle)*n.chaosSpeed;if(t.vx=.7*t.vx+.3*e,t.vy=.7*t.vy+.3*i,n.zigzagPattern){const e=.01*n.chaosTimer;t.vx+=20*Math.sin(e),t.vy+=20*Math.cos(e)}if(n.spiralPattern){const e=.005*n.chaosTimer,i=50+30*Math.sin(.003*n.chaosTimer);t.vx+=Math.cos(e)*i*.1,t.vy+=Math.sin(e)*i*.1}}if(Math.random()<n.teleportChance){const e=Math.random()*Math.PI*2,n=200+400*Math.random();t.x=i+Math.cos(e)*n,t.y=s+Math.sin(e)*n,t.vx=200*(Math.random()-.5),t.vy=200*(Math.random()-.5)}if(t.x+=t.vx*(e/1e3),t.y+=t.vy*(e/1e3),n.sizePulse){n.sizePulsePhase+=n.sizePulseSpeed*e;const i=1+.5*Math.sin(n.sizePulsePhase);t.size=(3+4*Math.random())*i}n.colorShift&&(n.colorShiftPhase=(n.colorShiftPhase||0)+n.colorShiftSpeed*e),t.vx*=.995,t.vy*=.995,t.life-=t.lifeDecay*e,(t.life<=0||Math.abs(t.x-i)>2e3||Math.abs(t.y-s)>2e3)&&(t.life=0)},getSpawnPosition(t,e){const i=Math.random()*Math.PI*2,s=100+200*Math.random();return{x:t+Math.cos(i)*s,y:e+Math.sin(i)*s}},getVisualProperties:()=>({glowColor:"#FF00AA",glowIntensity:2,particleColors:[{color:"#FF00AA",weight:30},{color:"#00FFAA",weight:25},{color:"#FFAA00",weight:20},{color:"#AA00FF",weight:15},{color:"#00AAFF",weight:10}]})},dt={name:"directed",emoji:"🎯",description:"Focused, straight-line movement toward target",config:{speed:3,acceleration:.15,focusStrength:.8,randomness:.1,edgeBuffer:50},initialize(t,e,i,s,n){const r=e-t.x,o=i-t.y,a=Math.sqrt(r*r+o*o);if(a>0)t.vx=r/a*this.config.speed,t.vy=o/a*this.config.speed;else{const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*this.config.speed,t.vy=Math.sin(e)*this.config.speed}t.targetX=e,t.targetY=i,t.directedPhase=0},update(t,e,i,s,n,r){t.directedPhase+=.05*e;const o=t.targetX-t.x,a=t.targetY-t.y,h=Math.sqrt(o*o+a*a);if(h>10){const i=o/h*this.config.speed,s=a/h*this.config.speed;t.vx+=(i-t.vx)*this.config.acceleration*e,t.vy+=(s-t.vy)*this.config.acceleration*e,t.vx+=(Math.random()-.5)*this.config.randomness,t.vy+=(Math.random()-.5)*this.config.randomness}else{const e=Math.random()*Math.PI*2,o=100+200*Math.random();t.targetX=i+Math.cos(e)*o,t.targetY=s+Math.sin(e)*o,t.targetX=Math.max(this.config.edgeBuffer,Math.min(n-this.config.edgeBuffer,t.targetX)),t.targetY=Math.max(this.config.edgeBuffer,Math.min(r-this.config.edgeBuffer,t.targetY))}t.x+=t.vx*e,t.y+=t.vy*e,(t.x<=0||t.x>=n)&&(t.vx*=-.8,t.x=Math.max(0,Math.min(n,t.x)),t.targetX=i+300*(Math.random()-.5)),(t.y<=0||t.y>=r)&&(t.vy*=-.8,t.y=Math.max(0,Math.min(r,t.y)),t.targetY=s+300*(Math.random()-.5))},visuals:{trailLength:"medium",opacity:.9,sizeMultiplier:1,blurAmount:.2}},pt={name:"fizzy",emoji:"🫧",description:"Bubbly, effervescent movement like carbonation",config:{baseRiseSpeed:2.5,wobbleAmplitude:30,wobbleFrequency:.15,popChance:.002,popForce:8,fizziness:.3,gravity:-.05},initialize(t,e,i,s,n){t.vx=2*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.wobblePhase=Math.random()*Math.PI*2,t.wobbleSpeed=this.config.wobbleFrequency*(.8+.4*Math.random()),t.bubbleSize=.5+.5*Math.random(),t.popTimer=0,t.isFizzing=!0},update(t,e,i,s,n,r){t.wobblePhase+=t.wobbleSpeed*e;const o=Math.sin(t.wobblePhase)*this.config.wobbleAmplitude;if(t.vx=.05*o+(Math.random()-.5)*this.config.fizziness,t.vy+=this.config.gravity*e,t.vy+=(Math.random()-.5)*this.config.fizziness,Math.random()<this.config.popChance){const e=Math.random()*Math.PI*2;t.vx=Math.cos(e)*this.config.popForce,t.vy=Math.sin(e)*this.config.popForce*.7,t.popTimer=1,t.bubbleSize=.3+.7*Math.random()}t.popTimer>0&&(t.popTimer-=.05*e,t.vx*=.95,t.vy*=.95),t.x+=t.vx*e,t.y+=t.vy*e,t.y<-50&&(t.y=r+50,t.x=i+300*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.bubbleSize=.5+.5*Math.random()),(t.x<=0||t.x>=n)&&(t.vx*=-.5,t.x=Math.max(0,Math.min(n,t.x))),t.y>r+50&&(t.y=r,t.vy=1.5*-this.config.baseRiseSpeed),t.size=t.baseSize*t.bubbleSize*(1+.1*Math.sin(2*t.wobblePhase))},visuals:{trailLength:"short",opacity:.6,sizeMultiplier:1.2,blurAmount:.5,sparkle:!0}},ft={name:"zen",emoji:"☯️",description:"Peaceful orbital movement like a hovering aura",initialize:function(t){t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5),t.lifeDecay=.003,t.emotionColors&&t.emotionColors.length>0&&(t.color=W(t.emotionColors)),t.behaviorData={orbitAngle:Math.random()*Math.PI*2,orbitRadius:40+60*Math.random(),orbitSpeed:8e-4+6e-4*Math.random(),floatOffset:Math.random()*Math.PI*2,breathingOffset:Math.random()*Math.PI*2,lifetime:0}},update:function(t,e,i,s){const n=t.behaviorData;if(!n)return;n.lifetime+=e;const r=(n.lifetime+8e3*n.breathingOffset)/8e3,o=.5*Math.sin(r*Math.PI*2)+.5;t.size=t.baseSize*(.95+.05*o),n.orbitAngle+=n.orbitSpeed*e;const a=10*Math.sin(1e-4*n.lifetime+n.floatOffset),h=n.orbitRadius+a,c=i+Math.cos(n.orbitAngle)*h,u=s+Math.sin(n.orbitAngle)*h,l=15*Math.sin(3e-4*n.lifetime+n.breathingOffset),d=c-t.x,p=u+l-t.y;t.vx=.03*d,t.vy=.03*p,t.vx+=.02*(Math.random()-.5),t.vy+=.02*(Math.random()-.5),t.vx*=.98,t.vy*=.98}};const mt=new Map;var gt={registerPluginBehavior:function(t,e){return mt.has(t),!(!e.initialize||"function"!=typeof e.initialize||!e.update||"function"!=typeof e.update||(mt.set(t,{name:t,emoji:e.emoji||"🔌",description:e.description||`Plugin behavior: ${t}`,initialize:e.initialize,update:e.update,isPlugin:!0}),0))},unregisterPluginBehavior:function(t){return!!mt.has(t)&&(mt.delete(t),!0)},getPluginBehavior:function(t){return mt.get(t)||null},getAllPluginBehaviors:function(){return Array.from(mt.keys())},createLegacyAdapter:function(t){return{name:t.name||"legacy",emoji:"🔄",description:t.description||"Legacy plugin behavior",initialize(e){if(t.size&&(e.size="object"==typeof t.size?t.size.min+Math.random()*(t.size.max-t.size.min):t.size,e.baseSize=e.size),t.speed){const i="object"==typeof t.speed?t.speed.min+Math.random()*(t.speed.max-t.speed.min):t.speed,s=Math.random()*Math.PI*2;e.vx=Math.cos(s)*i,e.vy=Math.sin(s)*i}if(t.lifespan){const i="object"==typeof t.lifespan?t.lifespan.min+Math.random()*(t.lifespan.max-t.lifespan.min):t.lifespan;e.lifeDecay=1e3/i}t.color&&(e.color=Array.isArray(t.color)?W(t.color):t.color),t.opacity&&(e.life="object"==typeof t.opacity?t.opacity.min+Math.random()*(t.opacity.max-t.opacity.min):t.opacity),e.behaviorData={movementType:t.movementType||"linear",turbulence:t.turbulence||0,drift:t.drift||0,acceleration:t.acceleration||0,...t.customData}},update(e,i,s,n){const r=e.behaviorData;switch(r.movementType){case"wander":e.vx+=(Math.random()-.5)*r.turbulence*i,e.vy+=(Math.random()-.5)*r.turbulence*i;break;case"fall":e.vy+=.1*i,e.vx+=(Math.random()-.5)*r.drift*i;break;case"rain":e.vy+=r.acceleration*i;break;case"orbit":{const t=e.x-s,r=e.y-n,o=Math.sqrt(t*t+r*r);if(o>0){const a=Math.atan2(r,t)+.02*i;e.x=s+Math.cos(a)*o,e.y=n+Math.sin(a)*o}break}}t.customUpdate&&t.customUpdate(e,i,s,n)}}}};const yt={};function bt(t){return yt[t]?yt[t]:gt.getPluginBehavior(t)||null}function vt(t,e){const i=bt(e);return i&&i.initialize?(i.initialize(t),!0):"ambient"!==e&&vt(t,"ambient")}function wt(t,e,i,s,n){const r=bt(e);return!(!r||!r.update||(r.update(t,i,s,n),0))}function Mt(){return[...Object.values(yt).map(t=>({name:t.name,emoji:t.emoji||"🎯",description:t.description||"No description",type:"core"})),...gt.getAllPluginBehaviors().map(t=>{const e=gt.getPluginBehavior(t);return{name:e.name,emoji:e.emoji||"🔌",description:e.description||"Plugin behavior",type:"plugin"}})]}[H,dt,pt,Y,X,J,K,Q,Z,tt,et,it,st,nt,ot,at,ht,ct,ut,lt,ft].forEach(t=>{yt[t.name]=t}),"undefined"!=typeof window&&window.DEBUG_PARTICLES&&(window.ParticleBehaviors={registry:yt,list:Mt,get:bt});var St={BEHAVIOR_REGISTRY:yt,getBehavior:bt,initializeBehavior:vt,updateBehavior:wt,listBehaviors:Mt,pluginAdapter:gt},kt=Object.freeze({__proto__:null,BEHAVIOR_REGISTRY:yt,default:St,getBehavior:bt,initializeBehavior:vt,listBehaviors:Mt,pluginAdapter:gt,updateBehavior:wt});const xt=new Map;var Tt={registerPluginGesture:function(t,e){return!(!e.apply&&!e.type||(e.name||(e.name=t),e.type||(e.type="blending"),xt.set(t,e),0))},unregisterPluginGesture:function(t){return!!xt.has(t)&&(xt.delete(t),!0)},getPluginGesture:function(t){return xt.get(t)||null},getAllPluginGestures:function(){return Array.from(xt.keys())},clearPluginGestures:function(){xt.clear()},createLegacyAdapter:function(t){return{name:t.name||"unknown",type:t.type||"blending",emoji:t.emoji||"🔌",description:t.description||"Plugin gesture",config:t.config||{},apply(e,i,s,n,r,o){t.animate?t.animate(e,i,s,n,r,o):t.apply&&t.apply(e,i,s,n,r,o)},cleanup:t.cleanup||function(t){t.gestureData&&t.gestureData[this.name]&&delete t.gestureData[this.name]}}}},Et={name:"bounce",emoji:"⬆️",type:"blending",description:"Vertical oscillation with smooth easing",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:30,frequency:2,axis:"vertical",damping:!0,easing:"sine",strength:.6,particleMotion:{type:"bounce",axis:"vertical",strength:.6,frequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"bounce"},frequencySync:{mode:"tempo",multiplier:1},durationSync:{mode:"beats",beats:4},accentResponse:{enabled:!0,multiplier:1.5},patternOverrides:{waltz:{frequencySync:{multiplier:.75},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:2,offBeat:.4,curve:"ease"}},dubstep:{amplitudeSync:{onBeat:1.5,dropBeat:3,curve:"pulse"}},breakbeat:{frequencySync:{multiplier:1.5},amplitudeSync:{onBeat:2.2,offBeat:.3}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.bounce={startY:t.y,startX:t.x,startVx:t.vx,startVy:t.vy,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.bounce?.initialized||this.initialize(t,i);const o={...this.config,...i},a=o.strength||this.config.strength||1,h=this.easeInOutCubic(e);let{frequency:c}=o;const u=i.phase||0;let l=o.amplitude*a*t.scaleFactor;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,l*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(c*=i.rhythmModulation.frequencyMultiplier));const d=Math.sin((h+u)*Math.PI*2*c);if(o.damping&&e>.7&&(l*=1-(e-.7)/.3*.8),"vertical"===o.axis?(t.vy+=d*l*.01*s,e>.9&&(t.vx*=.98)):"horizontal"===o.axis&&(t.vx+=d*l*.01*s,e>.9&&(t.vy*=.98)),e>.9){const i=1-10*(e-.9);t.vx=t.vx*(.95+.05*i),t.vy=t.vy*(.95+.05*i)}},cleanup(t){t.gestureData?.bounce&&delete t.gestureData.bounce},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},Ct={name:"pulse",emoji:"💗",type:"blending",description:"Radial expansion and contraction from center",config:{duration:600,amplitude:30,frequency:1,holdPeak:.1,easing:"sine",scaleAmount:.2,glowAmount:.3,strength:.15,direction:"outward",particleMotion:{type:"pulse",strength:.15,direction:"outward",frequency:1}},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.6,offBeat:.8,curve:"pulse"},frequencySync:{mode:"locked",subdivision:"quarter"},durationSync:{mode:"beats",beats:1},accentResponse:{enabled:!0,multiplier:2},patternOverrides:{waltz:{amplitudeSync:{onBeat:2,offBeat:.5},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"ease"},frequencySync:{subdivision:"swing"}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:4,curve:"pulse"}},breakbeat:{frequencySync:{mode:"random",range:[.5,2]},amplitudeSync:{onBeat:2.5,offBeat:.3}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s,o=Math.sqrt(n*n+r*r),a=Math.atan2(r,n);t.gestureData.pulse={baseDistance:o,angle:a,startX:t.x,startY:t.y,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.pulse?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.pulse,a={...this.config,...i},h=i.strength||1,c=this.easeInOutSine(e);let u,{frequency:l}=a,{amplitude:d}=a;i.rhythmModulation&&(d*=i.rhythmModulation.amplitudeMultiplier||1,d*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(l*=i.rhythmModulation.frequencyMultiplier));const p=c*l*2%2;u=a.holdPeak>0&&p>1-a.holdPeak&&p<1+a.holdPeak?1:Math.sin(c*Math.PI*2*l);const f=u*d*h*t.scaleFactor,m=o.baseDistance+f,g=n+Math.cos(o.angle)*m,y=r+Math.sin(o.angle)*m,b=.15*s;if(t.vx+=(g-t.x)*b*.1,t.vy+=(y-t.y)*b*.1,e>.9){const i=1-10*(e-.9);t.vx*=.9+.1*i,t.vy*=.9+.1*i}},cleanup(t){t.gestureData?.pulse&&delete t.gestureData.pulse},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},At={name:"shake",emoji:"🫨",type:"blending",description:"Random jitter movement for vibration effects",config:{duration:400,amplitude:15,frequency:15,decay:.9,smoothing:.1,axes:"both",easing:"linear",strength:3,particleMotion:{type:"shake",strength:3,frequency:15,decay:!1}},rhythm:{enabled:!0,syncMode:"subdivision",amplitudeSync:{subdivision:"sixteenth",onBeat:2.5,offBeat:.7,curve:"pulse"},frequencySync:{mode:"tempo",baseFrequency:15,scaling:"linear"},durationSync:{mode:"beats",beats:2},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.2},frequencySync:{mode:"random",range:[8,20]}},dubstep:{amplitudeSync:{subdivision:"eighth",onBeat:4,dropBeat:6,curve:"pulse"}},swing:{amplitudeSync:{onBeat:1.8,offBeat:1,curve:"ease"}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.shake={originalX:t.x,originalY:t.y,randomAngle:Math.random()*Math.PI*2,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.shake?.initialized||this.initialize(t,i);const o=t.gestureData.shake,a={...this.config,...i},h=a.strength||this.config.strength||1;let{amplitude:c}=a,{frequency:u}=a;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(u*=i.rhythmModulation.frequencyMultiplier));const l=a.decay?1-e:1,d=Math.sin(e*Math.PI*u)*c*l*h*t.scaleFactor,p=d*Math.cos(o.randomAngle),f=d*Math.sin(o.randomAngle);t.x=o.originalX+p,t.y=o.originalY+f},pseudoRandom(t){const e=1e4*Math.sin(t);return e-Math.floor(e)},cleanup(t){t.gestureData?.shake&&(t.x=t.gestureData.shake.originalX,t.y=t.gestureData.shake.originalY,delete t.gestureData.shake)}},It={name:"nod",emoji:"🙂",type:"blending",description:"Vertical nodding motion",config:{duration:500,amplitude:15,frequency:2,easing:"sine",strength:.4,particleMotion:{type:"bounce",axis:"vertical",strength:.4,frequency:2,phase:0}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!1,priority:5,blendable:!1,minDuration:"halfBar",frequencySync:{mode:"subdivision",subdivision:"half",multiplier:1},amplitudeSync:{onBeat:1.4,offBeat:.8,curve:"ease"},durationSync:{mode:"beats",beats:2},patternOverrides:{waltz:{frequencySync:{subdivision:"quarter"},amplitudeSync:{onBeat:1.6,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.5,offBeat:.9}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:3,curve:"pulse"}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.nod={startY:t.y,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.nod?.initialized||this.initialize(t,i);const o={...this.config,...i},a=o.strength||this.config.strength||1;let{frequency:h}=o,{amplitude:c}=o;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(h*=i.rhythmModulation.frequencyMultiplier));const u=Math.sin(e*Math.PI*2*h);c=c*a*t.scaleFactor,t.vy+=u*c*.01*s,e>.9&&(t.vy*=.95)},cleanup(t){t.gestureData?.nod&&delete t.gestureData.nod}},Ft={name:"vibrate",emoji:"📳",type:"blending",description:"High frequency vibration",config:{duration:500,frequency:20,amplitude:8,easing:"linear",strength:2,particleMotion:{type:"shake",strength:2,frequency:20,amplitude:8}},rhythm:{enabled:!0,syncMode:"subdivision",frequencySync:{subdivision:"thirty-second",baseFrequency:20,tempoScaling:!0},amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"pulse"},durationSync:{mode:"beats",beats:1},patternOverrides:{dubstep:{frequencySync:{subdivision:"sixteenth"},amplitudeSync:{onBeat:2,dropBeat:3}},breakbeat:{frequencySync:{mode:"random",range:[15,30]}}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.vibrate={timer:0,seed:1e3*Math.random(),initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.vibrate?.initialized||this.initialize(t,i);const o=t.gestureData.vibrate,a={...this.config,...i},h=a.strength||this.config.strength||1;let{amplitude:c}=a,{frequency:u}=a;i.rhythmModulation&&(c*=i.rhythmModulation.amplitudeMultiplier||1,c*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(u*=i.rhythmModulation.frequencyMultiplier)),o.timer+=s*u;const l=(Math.random()-.5)*c*h,d=(Math.random()-.5)*c*h;if(t.vx+=.5*l*s,t.vy+=.5*d*s,t.vx*=.9,t.vy*=.9,e>.8){const i=1-5*(e-.8);t.vx*=i,t.vy*=i}},cleanup(t){t.gestureData?.vibrate&&delete t.gestureData.vibrate}},_t={name:"orbit",emoji:"🪐",description:"3D orbital motion around center",type:"override",config:{speed:1,rotations:1,zRotations:1,smoothness:.15,verticalOscillation:0,centripetal:!1},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:1,scaling:"linear"},rotationSync:{mode:"bars",rotationsPerBar:1,zSync:!0},radiusSync:{subdivision:"quarter",pulsAmount:.1,curve:"ease"},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{pulsAmount:.15}},swing:{speedSync:{mode:"swing",ratio:.67},verticalOscillation:.2},dubstep:{radiusSync:{subdivision:"eighth",pulsAmount:.3,dropMultiplier:2}},breakbeat:{speedSync:{mode:"random",range:[.5,2]},centripetal:!0}}},apply:function(t,e,i,s,n,r,o){if(!e.initialized){e.originalX=t.x,e.originalY=t.y,e.originalZ=t.z||0,e.originalVx=t.vx||0,e.originalVy=t.vy||0;const s=t.x-r,n=t.y-o;e.radius=Math.sqrt(s*s+n*n),e.radius<50&&(e.radius=50+100*Math.random()),e.initialAngle=Math.atan2(n,s),e.orbitSpeed=i.speed*(.8+.4*Math.random()),e.orbitTilt=.3*Math.random(),e.initialized=!0}let{rotations:a}=i,h=.05;i.rhythmModulation&&(i.rhythmModulation.speedMultiplier&&(e.orbitSpeed*=i.rhythmModulation.speedMultiplier),i.rhythmModulation.rotationMultiplier&&(a*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusPulse&&(h=i.rhythmModulation.radiusPulse));let c=1,u=1;s<.15?(c=s/.15,c=c*c*(3-2*c),u=c):s>.85&&(c=(1-s)/.15,c=c*c*(3-2*c),u=c);const l=e.initialAngle+s*Math.PI*2*a*c,d=1+Math.sin(s*Math.PI*4)*h*c,p=e.radius*n*d*c,f=r+Math.cos(l)*p,m=o+Math.sin(l)*p,g=l*i.zRotations;if(t.z=.8*Math.sin(g)*c+e.originalZ*(1-c),s<.15){const i=.3*c;t.x=e.originalX+(f-e.originalX)*i,t.y=e.originalY+(m-e.originalY)*i;const s=-Math.sin(l)*p*e.orbitSpeed,n=Math.cos(l)*p*e.orbitSpeed;t.vx=e.originalVx+(s-e.originalVx)*u,t.vy=e.originalVy+(n-e.originalVy)*u}else if(s>.85){t.x=f+(e.originalX-f)*(1-c),t.y=m+(e.originalY-m)*(1-c);const i=-Math.sin(l)*p*e.orbitSpeed,s=Math.cos(l)*p*e.orbitSpeed;t.vx=i*u+e.originalVx*(1-u),t.vy=s*u+e.originalVy*(1-u)}else{if(i.verticalOscillation>0){const e=Math.sin(2*l)*i.verticalOscillation*n;t.y=m+e,t.x=f}else{const e=i.smoothness||.1;t.x+=(f-t.x)*e,t.y+=(m-t.y)*e}t.vx=-Math.sin(l)*p*e.orbitSpeed,t.vy=Math.cos(l)*p*e.orbitSpeed}if(i.centripetal){const n=1+.3*(1-Math.abs(t.z)),a=e.initialAngle+s*Math.PI*2*i.rotations*n;t.x=r+Math.cos(a)*p,t.y=o+Math.sin(a)*p}},emotions:["zen","love","excited","surprise"],features:{uses3D:!0,smooth:!0,looping:!0,dramatic:!0}},Rt={name:"twitch",emoji:"⚡",type:"blending",description:"Nervous, paranoid twitching",config:{intensity:8,frequency:.08,duration:100,recovery:200,maxOffset:15,sharpness:.9},rhythm:{enabled:!0,syncMode:"subdivision",probabilitySync:{subdivision:"sixteenth",onBeat:.3,offBeat:.05,accentBoost:2},intensitySync:{onBeat:2,offBeat:.8,curve:"pulse"},patternOverrides:{breakbeat:{probabilitySync:{onBeat:.5,offBeat:.1},intensitySync:{onBeat:3,offBeat:.5}},dubstep:{intensitySync:{onBeat:1.5,dropBeat:5,curve:"pulse"}}}},apply(t,e,i,s,n,r){t.gestureData||(t.gestureData={}),t.gestureData.twitch||(t.gestureData.twitch={twitchOffset:{x:0,y:0},targetOffset:{x:0,y:0},isTwitching:!1,twitchTimer:0,cooldownTimer:0,lastTwitch:0});const o=t.gestureData.twitch,{config:a}=this;let h=i.intensity||a.intensity;i.rhythmModulation&&(h*=i.rhythmModulation.amplitudeMultiplier||1,h*=i.rhythmModulation.accentMultiplier||1);const c=Date.now();if(!o.isTwitching&&o.cooldownTimer<=0&&Math.random()<(i.frequency||a.frequency)){o.isTwitching=!0,o.twitchTimer=a.duration,o.cooldownTimer=a.recovery;const t=Math.random()*Math.PI*2,e=.5*a.maxOffset+Math.random()*(.5*a.maxOffset);o.targetOffset={x:Math.cos(t)*e*h/8,y:Math.sin(t)*e*h/8},o.lastTwitch=c}if(o.cooldownTimer>0&&(o.cooldownTimer-=16*s),o.isTwitching)if(o.twitchTimer-=16*s,o.twitchTimer>0){const{sharpness:t}=a;o.twitchOffset.x+=(o.targetOffset.x-o.twitchOffset.x)*t,o.twitchOffset.y+=(o.targetOffset.y-o.twitchOffset.y)*t}else o.isTwitching=!1;else o.twitchOffset.x*=.85,o.twitchOffset.y*=.85;t.vx+=o.twitchOffset.x*s*.5,t.vy+=o.twitchOffset.y*s*.5,Math.random()<.1&&(t.vx+=(Math.random()-.5)*h*.3,t.vy+=(Math.random()-.5)*h*.3)},cleanup(t){t.gestureData?.twitch&&delete t.gestureData.twitch}},Pt={name:"sway",type:"blending",emoji:"🌊",description:"Gentle side-to-side swaying motion",config:{duration:2e3,amplitude:20,frequency:1,strength:.5},rhythm:{enabled:!0,syncMode:"bar",amplitudeSync:{onBeat:1.2,offBeat:.9,curve:"ease"},durationSync:{mode:"bars",bars:1},patternOverrides:{waltz:{durationSync:{bars:1},amplitudeSync:{onBeat:1.5,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.3,offBeat:.7,curve:"bounce"}}}},apply(t,e,i,s,n,r){const o={...this.config,...i},a=o.amplitude||this.config.amplitude,h=o.frequency||this.config.frequency,c=o.strength||this.config.strength,u=Math.sin(e*Math.PI*2*h)*a;t.vx+=.01*u*s*c,t.vy+=.5*Math.cos(e*Math.PI*4)*s*c},cleanup(t){}},Ot={name:"float",type:"blending",emoji:"🎈",description:"Gentle floating upward motion",config:{duration:2e3,amplitude:80,wobbleAmount:20,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"bounce"},wobbleSync:{subdivision:"eighth",intensity:.7},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:1.3},patternOverrides:{waltz:{wobbleSync:{subdivision:"quarter",intensity:.9}},dubstep:{amplitudeSync:{onBeat:2,curve:"pulse"}}}},apply(t,e,i,s,n,r){t.gestureData||(t.gestureData={}),t.gestureData.float||(t.gestureData.float={originalSize:t.size,originalOpacity:t.opacity||1});const o={...this.config,...i};let a=o.amplitude||this.config.amplitude,h=o.wobbleAmount||this.config.wobbleAmount;const c=o.strength||this.config.strength;i.rhythmModulation&&(a*=i.rhythmModulation.amplitudeMultiplier||1,a*=i.rhythmModulation.accentMultiplier||1,h*=i.rhythmModulation.wobbleMultiplier||1);const u=Math.sin(e*Math.PI*4)*h;t.vy-=.01*a*s*c*(1-.5*e),t.vx+=.01*u*s*c,t.size=t.baseSize*(1+.1*e),t.opacity=1-.3*e},cleanup(t){t.gestureData?.float?(t.opacity=t.gestureData.float.originalOpacity,t.size=t.gestureData.float.originalSize,delete t.gestureData.float):(t.opacity=1,t.size=t.baseSize),t.vx*=.5,t.vy*=.5}},Bt={name:"jitter",type:"blending",emoji:"🫨",description:"Nervous jittery movement",config:{duration:1e3,intensity:15,frequency:30,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:2,offBeat:.5,curve:"pulse"},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.3}},dubstep:{amplitudeSync:{onBeat:5,offBeat:.1,curve:"pulse"}}}},apply(t,e,i,s,n,r){t.gestureData||(t.gestureData={}),t.gestureData.jitter||(t.gestureData.jitter={originalSize:t.size});const o={...this.config,...i};let a=o.intensity||this.config.intensity;const h=o.strength||this.config.strength;i.rhythmModulation&&(a*=i.rhythmModulation.amplitudeMultiplier||1,a*=i.rhythmModulation.accentMultiplier||1);const c=(Math.random()-.5)*a*h,u=(Math.random()-.5)*a*h,l=1-.5*e;t.vx+=.1*c*s*l,t.vy+=.1*u*s*l,t.size=t.baseSize*(1+.1*(Math.random()-.5))},cleanup(t){t.gestureData?.jitter?(t.size=t.gestureData.jitter.originalSize,delete t.gestureData.jitter):t.size=t.baseSize,t.vx*=.7,t.vy*=.7}},Dt={name:"spin",emoji:"🌀",type:"override",description:"Orbital rotation around center point",config:{duration:600,musicalDuration:{musical:!0,beats:1},rotations:1,direction:"random",radiusMultiplier:1,spiralOut:!1,accelerate:!0,maintainDistance:!0,scaleAmount:.1,easing:"linear",strength:.7,particleMotion:{type:"spin",strength:.7,rotations:1,radius:1}},rhythm:{enabled:!0,syncMode:"bar",rotationSync:{mode:"bars",rotationsPerBar:1,accelerateOnBeat:!0},radiusSync:{subdivision:"quarter",expandOnBeat:1.2,contractOffBeat:.9,curve:"bounce"},durationSync:{mode:"beats",beats:4},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{curve:"ease"}},swing:{rotationSync:{accelerateOnBeat:!1},direction:"alternating"},dubstep:{radiusSync:{subdivision:"eighth",expandOnBeat:1.5,dropMultiplier:2},spiralOut:!0},breakbeat:{rotationSync:{mode:"random",range:[.5,2]},direction:"random"}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;let o=e.direction||this.config.direction;"random"===o&&(o=Math.random()<.5?"clockwise":"counter-clockwise"),t.gestureData.spin={startAngle:Math.atan2(r,n),startRadius:Math.sqrt(n*n+r*r)||30,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,direction:o,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.spin?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.spin,a={...this.config,...i},h=i.strength||1;let{rotations:c}=a,{radiusMultiplier:u}=a;i.rhythmModulation&&(i.rhythmModulation.rotationMultiplier&&(c*=i.rhythmModulation.rotationMultiplier),i.rhythmModulation.radiusMultiplier&&(u*=i.rhythmModulation.radiusMultiplier));let l=e;a.accelerate&&(l=e<.5?.5*this.easeInQuad(2*e):.5+.5*this.easeOutQuad(2*(e-.5)));const d=c*Math.PI*2*h,p="counter-clockwise"===o.direction?-1:1,f=o.startAngle+d*l*p;let m=o.startRadius;a.spiralOut&&(m*=1+.5*e),1!==u&&(m*=1+(u-1)*Math.sin(e*Math.PI));const g=n+Math.cos(f)*m,y=r+Math.sin(f)*m;if(t.x+=.25*(g-t.x),t.y+=.25*(y-t.y),t.vx=.5*(g-t.x),t.vy=.5*(y-t.y),e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.spin){const e=t.gestureData.spin;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.spin}},easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t)},$t={name:"jump",emoji:"🦘",type:"override",description:"Squash, leap, and land with classic animation principles",config:{duration:800,jumpHeight:60,squashAmount:.8,stretchAmount:1.2,anticipation:.2,hangTime:.1,landingImpact:!0,driftOutward:!0,easing:"quad",particleMotion:{type:"jump",strength:.9,jumpHeight:60,squash:.8,stretch:1.2}},rhythm:{enabled:!0,syncMode:"beat",phaseSync:{anticipation:"eighth",jump:"beat",landing:"sixteenth"},heightSync:{onBeat:1.5,offBeat:.8,accent:2,curve:"exponential"},deformationSync:{squashOnBeat:.6,stretchOnBeat:1.4,timing:"anticipatory"},hangTimeSync:{mode:"tempo",baseDuration:.1,scaling:"inverse"},dynamics:{forte:{jumpHeight:80,stretch:1.3},piano:{jumpHeight:30,stretch:1.1}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={}),t.gestureData.jump={startX:t.x,startY:t.y,startSize:t.size,originalVx:t.vx,originalVy:t.vy,driftDirection:.1*(t.x-i),initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.jump?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.jump,a={...this.config,...i},h=i.strength||1,c=a.jumpHeight*h*t.scaleFactor,u=a.squashAmount,l=a.stretchAmount,d=a.anticipation,p=1-.5*a.anticipation;if(e<d){const i=e/d,s=this.easeOutQuad(i);t.size=o.startSize*(1-(1-u)*s),t.y=o.startY+5*s*t.scaleFactor,t.vx=0,t.vy=0}else if(e<p){const i=(e-d)/(p-d);let s=Math.sin(i*Math.PI);if(a.hangTime>0&&i>.4&&i<.6){const t=(i-.4)/.2;s=.95+.05*this.easeInOutCubic(t)}if(t.y=o.startY-s*c,a.driftOutward&&(t.x=o.startX+s*o.driftDirection),i<.5){const e=2*i;t.size=o.startSize*(u+(l-u)*e)}else{const e=2*(i-.5);t.size=o.startSize*(l-(l-1)*e*.8)}t.vx=.5*o.driftDirection,t.vy=-Math.cos(i*Math.PI)*c*.1}else{const i=(e-p)/(1-p),s=this.easeOutBounce(i);if(t.y=o.startY,a.landingImpact)if(i<.3){const e=i/.3;t.size=o.startSize*(1-(1-.8*u)*(1-e))}else{const e=(i-.3)/.7;t.size=o.startSize*(.8*u+(1-.8*u)*e)}else t.size=o.startSize*(u+(1-u)*s);t.vx=o.originalVx*s,t.vy=o.originalVy*s}},cleanup(t){if(t.gestureData?.jump){const e=t.gestureData.jump;t.size=e.startSize,t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.jump}},easeOutQuad:t=>t*(2-t),easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutBounce(t){const e=7.5625,i=2.75;return t<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375}},zt={name:"morph",emoji:"✨",type:"override",description:"Form geometric patterns and shapes",config:{musicalDuration:{musical:!0,beats:2,minBeats:1,maxBeats:8},phases:[{name:"gather",beats:.25},{name:"form",beats:.75},{name:"hold",beats:.5},{name:"dissolve",beats:.5}],morphType:"fluid",pattern:"star",points:5,innerRadius:.4,size:80,amplitude:20,rotation:0,smooth:!0,randomizeOrder:!1,easing:"sine",strength:1.2,particleMotion:{type:"morph",pattern:"star",strength:1.2,smooth:!0,points:5}},rhythm:{enabled:!0,syncMode:"phrase",patternSync:{verse:"circle",chorus:"star",bridge:"heart",drop:"explosion"},timingSync:{formationBeat:1,holdBeats:2,dissolveBeat:4,curve:"anticipatory"},sizeSync:{onBeat:1.2,offBeat:.95,subdivision:"quarter",curve:"elastic"},rotationSync:{mode:"continuous",degreesPerBar:90,direction:"clockwise"},dynamics:{forte:{points:8,size:100},piano:{points:3,size:60}}},initialize(t,e,i,s,n){t.gestureData||(t.gestureData={});const r={...this.config,...e},o=t.x,a=t.y,h=Math.atan2(t.y-s,t.x-i),c=Math.random()<.5?1:-1;let u,l;const d=r.size*t.scaleFactor,p=(r.rotation||0)*Math.PI/180*c;switch(r.pattern){case"star":u=i,l=s,this.calculateStarPosition(t,h,d,r.points,r.innerRadius,p,i,s);break;case"heart":this.calculateHeartPosition(t,h,d,p,i,s);break;case"square":this.calculateSquarePosition(t,h,d,p,i,s);break;case"triangle":this.calculateTrianglePosition(t,h,d,p,i,s);break;default:{const t=d;u=i+Math.cos(h+p)*t,l=s+Math.sin(h+p)*t;break}}t.gestureData.morph={startX:o,startY:a,targetX:t.gestureData.morphTargetX||u,targetY:t.gestureData.morphTargetY||l,originalVx:t.vx,originalVy:t.vy,rotationDirection:c,initialized:!0}},calculateStarPosition(t,e,i,s,n,r,o,a){const h=((e+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI),c=Math.floor(h/(2*Math.PI)*10),u=c%2==0,l=Math.floor(c/2);let d;d=u?72*l*Math.PI/180:(72*l+36)*Math.PI/180,d+=r;const p=u?i:i*n;t.gestureData.morphTargetX=o+Math.cos(d)*p,t.gestureData.morphTargetY=a+Math.sin(d)*p},calculateHeartPosition(t,e,i,s,n,r){const o=(e+Math.PI)/(2*Math.PI),a=.05*i,h=16*Math.pow(Math.sin(o*Math.PI*2),3),c=-(13*Math.cos(o*Math.PI*2)-5*Math.cos(2*o*Math.PI*2)-2*Math.cos(3*o*Math.PI*2)-Math.cos(4*o*Math.PI*2)),u=Math.cos(s),l=Math.sin(s),d=h*u-c*l,p=h*l+c*u;t.gestureData.morphTargetX=n+d*a,t.gestureData.morphTargetY=r+p*a},calculateSquarePosition(t,e,i,s,n,r){const o=((e+s)%(2*Math.PI)+2*Math.PI)%(2*Math.PI);let a,h;const c=i;o<Math.PI/4||o>=7*Math.PI/4?(a=c,h=c*Math.tan(o)):o<3*Math.PI/4?(a=c/Math.tan(o),h=c):o<5*Math.PI/4?(a=-c,h=-c*Math.tan(o)):(a=-c/Math.tan(o),h=-c);const u=Math.cos(s),l=Math.sin(s),d=a*u-h*l,p=a*l+h*u;t.gestureData.morphTargetX=n+d,t.gestureData.morphTargetY=r+p},calculateTrianglePosition(t,e,i,s,n,r){const o=[{x:0,y:-i},{x:.866*-i,y:.5*i},{x:.866*i,y:.5*i}],a=Math.floor((e+Math.PI)/(2*Math.PI)*3)%3,h=(a+1)%3,c=Math.random(),u=o[a].x+(o[h].x-o[a].x)*c,l=o[a].y+(o[h].y-o[a].y)*c,d=Math.cos(s),p=Math.sin(s),f=u*d-l*p,m=u*p+l*d;t.gestureData.morphTargetX=n+f,t.gestureData.morphTargetY=r+m},apply(t,e,i,s,n,r){t.gestureData?.morph?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.morph,a={...this.config,...i};let h,c,u=e;if(a.holdTime>0){const t=.5-a.holdTime/2,i=.5+a.holdTime/2;u=e<t?e/t*.5:e<i?.5:.5+(e-i)/(1-i)*.5}if(u<=.5){const t=2*u;h=o.startX+(o.targetX-o.startX)*this.easeOutQuad(t),c=o.startY+(o.targetY-o.startY)*this.easeOutQuad(t)}else{const t=2*(u-.5);h=o.targetX+(o.startX-o.targetX)*this.easeInQuad(t),c=o.targetY+(o.startY-o.targetY)*this.easeInQuad(t)}if(a.smooth){const e=.2;t.x+=(h-t.x)*e,t.y+=(c-t.y)*e}else t.x=h,t.y=c;if(t.vx=.5*(h-t.x),t.vy=.5*(c-t.y),e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.morph){const e=t.gestureData.morph;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.morph,delete t.gestureData.morphTargetX,delete t.gestureData.morphTargetY}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t),easeInQuad:t=>t*t},qt={name:"stretch",emoji:"↔️",type:"override",description:"Scale particles along X and Y axes",config:{duration:2e3,scaleX:1.3,scaleY:.9,alternate:!1,elastic:!0,overshoot:.1,frequency:1,easing:"sine",strength:1,particleMotion:{type:"stretch",scaleX:1.8,scaleY:.6,strength:1},centerBased:!0,preserveArea:!1},rhythm:{enabled:!0,syncMode:"beat",scaleSync:{onBeat:{x:1.5,y:.7},offBeat:{x:.8,y:1.3},subdivision:"eighth",curve:"elastic"},alternateSync:{pattern:"XYXY",beatsPerChange:1,overlap:.1},overshootSync:{normal:.1,accent:.3,downbeat:.2,curve:"spring"},preservationSync:{verse:!0,chorus:!1,bridge:!0},dynamics:{forte:{scaleX:2,scaleY:.5,overshoot:.4},piano:{scaleX:1.1,scaleY:.95,overshoot:.05}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;t.gestureData.stretch={offsetX:n,offsetY:r,startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.stretch?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.stretch,a={...this.config,...i},h=i.strength||1;let c,u,{scaleX:l}=a,{scaleY:d}=a;if(a.preserveArea&&1!==l&&1!==d){const t=l*d,e=Math.sqrt(1/t);l*=e,d*=e}if(a.alternate)if(e<.5){const t=2*e;l=1+(l-1)*this.getElasticProgress(t,a),d=1+(1/l-1)*(a.preserveArea?1:0)}else{const t=2*(e-.5);l+=(1-l)*this.getElasticProgress(t,a),d=1+(d-1)*this.getElasticProgress(t,a)}else{const t=this.getElasticProgress(e,a);l=1+(l-1)*t*h,d=1+(d-1)*t*h}if(a.centerBased?(c=n+o.offsetX*l,u=r+o.offsetY*d):(c=o.startX*l,u=o.startY*d),t.x=c,t.y=u,t.vx=o.offsetX*(l-1)*h*.1,t.vy=o.offsetY*(d-1)*h*.1,e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},getElasticProgress(t,e){if(!e.elastic)return this.easeInOutCubic(t);if(0===t)return 0;if(1===t)return 1;const i=e.overshoot||.1;if(t<.5){const e=2*t;return.5*this.easeInElastic(e,i)}{const e=2*(t-.5);return.5+.5*this.easeOutElastic(e,i)}},cleanup(t){if(t.gestureData?.stretch){const e=t.gestureData.stretch;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.stretch}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeInElastic:(t,e)=>0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1-.075)*(2*Math.PI)/.3)*(1+e),easeOutElastic:(t,e)=>0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)*(1+e)+1},jt={name:"tilt",emoji:"🤔",type:"override",description:"Gather particles then tilt as unified group",config:{duration:500,gatherPhase:.2,tiltAngle:45,swayAmount:80,liftAmount:60,frequency:3,homeRadius:20,easing:"sine",strength:2.5,particleMotion:{type:"tilt",strength:2.5,frequency:3,swayAmount:80,liftAmount:60},smoothness:.25},rhythm:{enabled:!0,syncMode:"swing",angleSync:{onBeat:45,offBeat:-30,swing:15,subdivision:"triplet",curve:"ease-in-out"},gatherSync:{beatsBefore:.5,releaseAfter:.25,intensity:"dynamic"},swaySync:{verse:60,chorus:100,bridge:80,syncopated:!0},liftSync:{upOnTilt:!0,heightOnAccent:80,normalHeight:40,curve:"bounce"},dynamics:{forte:{tiltAngle:60,swayAmount:120,frequency:4},piano:{tiltAngle:20,swayAmount:40,frequency:2}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s,o=Math.atan2(r,n),a=Math.sqrt(n*n+r*r),h=Math.random(),c=({...this.config,...e}.homeRadius+20*Math.random())*t.scaleFactor;t.gestureData.tilt={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,angle:o,distance:a,homeRadius:c,homeX:i+Math.cos(o)*c,homeY:s+Math.sin(o)*c,role:h,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.tilt?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.tilt,a={...this.config,...i},h=i.strength||1;let c,u;if(e<a.gatherPhase){const i=e/a.gatherPhase,s=this.easeInOutCubic(i);c=o.startX+(o.homeX-o.startX)*s,u=o.startY+(o.homeY-o.startY)*s;const n=.6;t.x+=(c-t.x)*n,t.y+=(u-t.y)*n}else{const i=(e-a.gatherPhase)/(1-a.gatherPhase)*Math.PI*a.frequency,s=Math.sin(i),l=a.tiltAngle*Math.PI/180*h,d=o.angle+s*l,p=Math.abs(s)*a.liftAmount*t.scaleFactor,f=o.homeRadius+p;c=n+Math.cos(d)*f,u=r+Math.sin(d)*f-.3*p;const m=a.smoothness+.1*o.role;t.x+=(c-t.x)*m,t.y+=(u-t.y)*m;const g=-Math.sin(d),y=Math.cos(d);t.vx=g*s*2,t.vy=y*s*2}if(e<a.gatherPhase&&(t.vx=.25*(c-t.x),t.vy=.25*(u-t.y)),e>.9){const i=10*(1-e),s=o.startX+(t.x-o.startX)*i,n=o.startY+(t.y-o.startY)*i;t.x=s,t.y=n,t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.tilt){const e=t.gestureData.tilt;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.tilt}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},Lt={name:"orbital",emoji:"🪐",type:"override",description:"Orbital motion around center",config:{speed:.02,maintainRadius:!0,elliptical:!1,use3D:!0,zPhaseOffset:0,verticalOscillation:0,duration:3e3,particleMotion:{type:"orbital",strength:1}},rhythm:{enabled:!0,syncMode:"harmonic",speedSync:{tonic:.02,fifth:.03,octave:.04,third:.025,curve:"smooth"},radiusSync:{bass:150,mid:100,treble:50,scaling:"logarithmic"},depthSync:{major:{z:1,phase:0},minor:{z:-1,phase:Math.PI},diminished:{z:.5,phase:Math.PI/2},augmented:{z:.8,phase:-Math.PI/2}},phaseSync:{mode:"harmonic",intervals:[1,1.5,2],drift:.05},dynamics:{forte:{speed:.04,maintainRadius:!1},piano:{speed:.01,maintainRadius:!0}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s,o=Math.sqrt(n*n+r*r),a=Math.random()<.5?1:-1,h=Math.max(o,100+180*Math.random());t.gestureData.orbital={radius:h,targetRadius:h,angle:o<5?Math.random()*Math.PI*2:Math.atan2(r,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,direction:a}},apply(t,e,i,s,n,r){t.gestureData?.orbital||this.initialize(t,i,n,r);const o=t.gestureData.orbital,a=(i.speed||this.config.speed)*(i.strength||1);o.angle+=a*s*o.direction;let{radius:h}=o;if(i.maintainRadius||(h=o.radius*(1+.1*Math.sin(e*Math.PI*2))),t.x=n+Math.cos(o.angle)*h,t.y=r+Math.sin(o.angle)*h,!1!==i.use3D){const e=o.angle+o.zPhase+(i.zPhaseOffset||0);if(t.z=.8*Math.sin(e),i.verticalOscillation){const s=Math.cos(e)*i.verticalOscillation*h*.1;t.y+=s}}if(t.vx=-Math.sin(o.angle)*h*a,t.vy=Math.cos(o.angle)*h*a,e>.9){const i=10*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i)}},cleanup(t){if(t.gestureData?.orbital){const e=t.gestureData.orbital;t.vx=e.originalVx,t.vy=e.originalVy,t.z=e.originalZ,delete t.gestureData.orbital}}},Nt={name:"hula",emoji:"🌀",type:"override",description:"Hula-hoop motion with vertical waves",config:{speed:.015,maintainRadius:!1,elliptical:!0,use3D:!0,zPhaseOffset:Math.PI/4,verticalOscillation:.3,wobbleAmount:.15,duration:2500,particleMotion:{type:"hula",strength:1,verticalOscillation:.3}},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:.015,scaling:"proportional"},wobbleSync:{onBeat:.25,offBeat:.1,curve:"sine"},verticalSync:{subdivision:"quarter",amplitude:.4,phase:"sequential"},dynamics:{forte:{wobbleAmount:.3,speed:1.2},piano:{wobbleAmount:.05,speed:.8}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s,o=Math.sqrt(n*n+r*r),a=Math.random()<.5?1:-1,h=Math.max(o,100+180*Math.random());t.gestureData.hula={radius:h,angle:o<5?Math.random()*Math.PI*2:Math.atan2(r,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,wobblePhase:Math.random()*Math.PI*2,direction:a}},apply(t,e,i,s,n,r){t.gestureData?.hula||this.initialize(t,i,n,r);const o=t.gestureData.hula,a=(i.speed||this.config.speed)*(i.strength||1);let h=1;e<.1?(h=e/.1,h=Math.sin(h*Math.PI*.5)):e>.9&&(h=(1-e)/.1,h=Math.sin(h*Math.PI*.5)),o.angle+=a*s*o.direction*h;const c=Math.sin(2*o.angle+o.wobblePhase)*(i.wobbleAmount||this.config.wobbleAmount)*h,u=o.radius*(1+c)*h,l=o.radius*(.7+c)*h,d=n+Math.cos(o.angle)*u,p=r+Math.sin(o.angle)*l;if(e<.1){const e=t.x-n,i=t.y-r;Math.sqrt(e*e+i*i)<50?(t.x=n+Math.cos(o.angle)*u,t.y=r+Math.sin(o.angle)*l):(t.x=t.x+(d-t.x)*h*.5,t.y=t.y+(p-t.y)*h*.5)}else t.x=d,t.y=p;const f=o.angle+o.zPhase+(i.zPhaseOffset||this.config.zPhaseOffset);t.z=.9*Math.sin(f)*h;const m=i.verticalOscillation||this.config.verticalOscillation,g=Math.cos(2*f)*m*o.radius*.2*h;t.y+=g;const y=t.z*o.radius*.1;t.y-=y;const b=-Math.sin(o.angle)*u*a,v=Math.cos(o.angle)*l*a;e<.1?(t.vx=o.originalVx+(b-o.originalVx)*h,t.vy=o.originalVy+(v-o.originalVy)*h):e>.9?(t.vx=b*h+o.originalVx*(1-h),t.vy=v*h+o.originalVy*(1-h),t.z=t.z*h+o.originalZ*(1-h)):(t.vx=b,t.vy=v)},cleanup(t){if(t.gestureData?.hula){const e=t.gestureData.hula;t.vx=e.originalVx,t.vy=e.originalVy,t.z=e.originalZ,delete t.gestureData.hula}}},Gt={name:"scan",emoji:"🔍",type:"override",description:"Searchlight scanning motion",config:{scanSpeed:.008,scanWidth:120,pauseDuration:300,scanHeight:40,layers:3,duration:3e3},rhythm:{enabled:!0,syncMode:"measure",sweepSync:{beatsPerSweep:4,pauseOnDownbeat:!0,reverseOnBar:!0,curve:"linear"},layerSync:{quiet:1,moderate:2,loud:3,stagger:"sequential"},pauseSync:{onBeat:500,offBeat:100,accent:800,subdivision:"quarter"},widthSync:{verse:80,chorus:140,bridge:100,transition:"smooth"},dynamics:{forte:{scanSpeed:.012,layers:4},piano:{scanSpeed:.004,layers:1}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=Math.floor(Math.random()*this.config.layers);t.gestureData.scan={layer:n,phase:Math.random()*Math.PI*2,direction:Math.random()<.5?1:-1,pauseTimer:0,isPaused:!1,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,scanOffset:20*(Math.random()-.5),verticalOffset:30*n-30,initialized:!0,startTime:Date.now()}},apply(t,e,i,s,n,r){t.gestureData?.scan||this.initialize(t,i,n,r);const o=t.gestureData.scan,a=i.scanSpeed||this.config.scanSpeed,h=i.scanWidth||this.config.scanWidth,c=i.pauseDuration||this.config.pauseDuration;if(o.isPaused)o.pauseTimer-=16*s,o.pauseTimer<=0&&(o.isPaused=!1,o.direction*=-1);else{o.phase+=a*o.direction*s;const t=Math.sin(o.phase);Math.abs(t)>.95&&(o.isPaused=!0,o.pauseTimer=c)}const u=Math.sin(o.phase)*h,l=Math.cos(.5*o.phase)*(this.config.scanHeight/2);let d=1;e<.15?(d=e/.15,d*=d):e>.85&&(d=(1-e)/.15,d*=d);const p=n+u+o.scanOffset,f=r+l+o.verticalOffset;t.x=o.originalX+(p-o.originalX)*d,t.y=o.originalY+(f-o.originalY)*d,o.isPaused?(t.vx*=.85,t.vy*=.85):(t.vx=-Math.cos(o.phase)*h*a*60,t.vy=-Math.sin(.5*o.phase)*this.config.scanHeight*a*30),Math.random()<.02&&(t.vx+=2*(Math.random()-.5),t.vy+=2*(Math.random()-.5))},cleanup(t){if(t.gestureData?.scan){const e=t.gestureData.scan;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.scan}}},Ut={name:"twist",emoji:"🌀",type:"override",description:"Twisting dance motion with alternating rotation",config:{duration:1200,rotationAngle:45,contractionFactor:.8,twistFrequency:2,easing:"smooth",strength:.8,particleMotion:{type:"twist",rotationAngle:45,contractionFactor:.8,twistFrequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:4,blendable:!1,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.5,offBeat:.7,curve:"elastic"},patternOverrides:{funk:{rotationAngle:60,contractionFactor:.7},disco:{twistFrequency:3,rotationAngle:50},latin:{rotationAngle:35,contractionFactor:.85,twistFrequency:2.5}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.twist={startX:t.x,startY:t.y,startAngle:Math.atan2(t.y-e.centerY,t.x-e.centerX),startDistance:Math.sqrt(Math.pow(t.x-e.centerX,2)+Math.pow(t.y-e.centerY,2)),initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.twist?.initialized||this.initialize(t,{...i,centerX:n,centerY:r});const o={...this.config,...i},a=t.gestureData.twist,h=o.strength||this.config.strength||1,c=e*o.twistFrequency*Math.PI*2,u=Math.sin(c)*h;let{rotationAngle:l}=o,{contractionFactor:d}=o;i.rhythmModulation&&(l*=i.rhythmModulation.amplitudeMultiplier||1,d=1-(1-d)*(i.rhythmModulation.amplitudeMultiplier||1));const p=l*Math.PI/180*u,f=1-(1-d)*Math.abs(u),m=a.startAngle+p,g=a.startDistance*f,y=n+Math.cos(m)*g,b=r+Math.sin(m)*g,v=.15*h;t.x+=(y-t.x)*v,t.y+=(b-t.y)*v,t.vx=.05*(y-t.x),t.vy=.05*(b-t.y);const w=5*Math.sin(e*Math.PI*4)*h;if(t.y+=.1*w,e>.9){const i=1-10*(e-.9);t.vx*=i,t.vy*=i}},cleanup(t){t.gestureData?.twist&&delete t.gestureData.twist}},Wt={name:"wave",emoji:"🌊",type:"override",description:"Infinity pattern flow with phasing",config:{musicalDuration:{musical:!0,bars:1,minBeats:4,maxBeats:16},phases:[{name:"gather",beats:.5},{name:"rise",beats:.5},{name:"waveLeft",beats:1},{name:"waveRight",beats:1},{name:"settle",beats:1}],amplitude:40,frequency:1,phaseShift:.3,liftHeight:20,fadeInOut:!0,smoothness:.1,easing:"sine",strength:1,particleMotion:{type:"wave",strength:1,amplitude:50}},rhythm:{enabled:!0,syncMode:"wave",amplitudeSync:{onWave:65,onStatic:25,curve:"flowing"},frequencySync:{mode:"phrase",slow:.7,fast:1.8,curve:"melodic"},durationSync:{mode:"bars",adaptToPhrase:!0,sustain:!0},phaseSync:{enabled:!0,multiplier:.5,type:"ensemble"},melodicResponse:{enabled:!0,multiplier:1.4,type:"amplitude"},patternOverrides:{ambient:{amplitudeSync:{onWave:80,onStatic:40,curve:"hypnotic"},frequencySync:{slow:.5,fast:1.2},durationSync:{minBeats:16,maxBeats:64}},ocean:{amplitudeSync:{onWave:90,onStatic:20,curve:"natural"},phaseSync:{multiplier:.8},melodicResponse:{multiplier:1.8}},electronic:{amplitudeSync:{onWave:70,onStatic:30,curve:"digital"},frequencySync:{slow:.8,fast:2.5,curve:"precise"}},orchestral:{amplitudeSync:{onWave:75,onStatic:35},phaseSync:{multiplier:.7},melodicResponse:{multiplier:2}}},dynamics:{forte:{amplitudeSync:{onWave:{multiplier:1.8},onStatic:{multiplier:1.4}},frequencySync:{multiplier:1.3},melodicResponse:{multiplier:2.2}},piano:{amplitudeSync:{onWave:{multiplier:.6},onStatic:{multiplier:.4}},frequencySync:{multiplier:.7},melodicResponse:{multiplier:1.1}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s,o=Math.atan2(r,n),a=Math.sqrt(n*n+r*r),h=Math.random()<.5?1:-1;t.gestureData.wave={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,angle:o,radius:a,offset:Math.random()*Math.PI*2,role:Math.random(),direction:h,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.wave?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.wave,a={...this.config,...i},h=i.strength||1,c=this.easeInOutSine(e),u=o.role*a.phaseShift,l=Math.max(0,c-u),d=l*Math.PI*2*a.frequency*o.direction+o.offset,p=.5+o.radius/100*.5,f=a.amplitude*p*h*t.scaleFactor,m=n+Math.sin(d)*f,g=r+Math.sin(2*d)*f*.3+-Math.abs(Math.sin(c*Math.PI))*a.liftHeight*t.scaleFactor,y=a.smoothness+.12*o.role;if(t.x+=(m-t.x)*y,t.y+=(g-t.y)*y,t.vx=.3*(m-t.x),t.vy=.3*(g-t.y),a.fadeInOut){let e;e=l<.1?l/.1:l>.9?(1-l)/.1:.5+.5*Math.sin(l*Math.PI),t.opacity=o.baseOpacity*(.3+.7*e),void 0!==t.life&&(t.life=t.opacity)}if(e>=.95){const i=20*(1-e);t.vx=t.vx*i+o.originalVx*(1-i),t.vy=t.vy*i+o.originalVy*(1-i),a.fadeInOut&&(t.opacity=o.baseOpacity*i,void 0!==t.life&&(t.life=t.opacity))}},cleanup(t){if(t.gestureData?.wave){const e=t.gestureData.wave;t.vx=e.originalVx,t.vy=e.originalVy,t.opacity=e.baseOpacity,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.wave}},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},Ht={name:"drift",emoji:"☁️",type:"override",description:"Controlled floating with fade effects",config:{duration:800,distance:50,angle:45,returnToOrigin:!0,fadeOut:!1,holdTime:.2,turbulence:.1,angleSpread:45,smoothness:.08,easing:"ease",strength:1,particleMotion:{type:"drift",strength:1,distance:60}},rhythm:{enabled:!0,syncMode:"ambient",distanceSync:{quiet:30,loud:80,crescendo:"expand",diminuendo:"contract"},angleSync:{major:45,minor:225,modulation:"smooth",cadence:"return"},holdSync:{shortPhrase:.1,longPhrase:.4,fermata:"sustain"},accentResponse:{enabled:!0,multiplier:1.3,type:"distance"},patternOverrides:{ambient:{distanceSync:{quiet:40,loud:100},holdSync:{shortPhrase:.3,longPhrase:.6}},classical:{angleSync:{major:30,minor:210},distanceSync:{quiet:25,loud:60}},jazz:{angleSync:{major:60,minor:240,swing:!0,syncopated:!0}},new_age:{distanceSync:{quiet:35,loud:70},holdSync:{shortPhrase:.4,longPhrase:.8},angleSync:{modulation:"gradual"}}},dynamics:{forte:{distanceSync:{quiet:{multiplier:1.5},loud:{multiplier:1.8}},holdSync:{multiplier:1.2},accentResponse:{multiplier:1.6}},piano:{distanceSync:{quiet:{multiplier:.6},loud:{multiplier:.8}},holdSync:{multiplier:.8},accentResponse:{multiplier:1.1}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;let o=Math.atan2(r,n);const a={...this.config,...e}.angleSpread*Math.PI/180,h=(Math.random()-.5)*a;o+=h;const c=30+30*Math.random();t.gestureData.drift={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,driftAngle:o,angleOffset:h,homeRadius:c*t.scaleFactor,homeX:i+Math.cos(o)*c,homeY:s+Math.sin(o)*c,role:Math.random(),turbulencePhase:Math.random()*Math.PI*2,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.drift?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.drift,a={...this.config,...i},h=i.strength||1,c=this.easeInOutCubic(e),u=Math.max(0,c-.1*o.role);let l,d,p;if(a.returnToOrigin)if(u<.4){const t=u/.4,e=this.easeOutQuad(t);l=o.startX+(o.homeX-o.startX)*e,d=o.startY+(o.homeY-o.startY)*e}else if(u<.6+a.holdTime){const e=(u-.4)/(.2+a.holdTime);p=o.homeRadius+Math.sin(e*Math.PI*.5)*a.distance*h*t.scaleFactor}else{const e=(u-.6-a.holdTime)/(.4-a.holdTime);p=o.homeRadius+Math.cos(e*Math.PI*.5)*a.distance*h*t.scaleFactor}else{const e=u;p=o.homeRadius+e*a.distance*h*t.scaleFactor}if(void 0!==p){o.turbulencePhase+=a.turbulence*s;const t=Math.sin(o.turbulencePhase)*a.turbulence*10,e=Math.cos(1.3*o.turbulencePhase)*a.turbulence*10,i=o.driftAngle+o.angleOffset;l=n+Math.cos(i)*p+t,d=r+Math.sin(i)*p+e}const f=a.smoothness+.08*o.role;if(t.x+=(l-t.x)*f,t.y+=(d-t.y)*f,t.vx=.25*(l-t.x),t.vy=.25*(d-t.y),a.fadeOut){let i;i=e<.25?.3+e/.25*.7:e<.75?.7+.3*Math.sin((e-.25)*Math.PI/.5):4*(1-e),t.opacity=o.baseOpacity*i,void 0!==t.life&&(t.life=t.opacity)}e>=.99&&(t.vx=.1*o.originalVx,t.vy=.1*o.originalVy,a.fadeOut&&(t.opacity=o.baseOpacity,void 0!==t.life&&(t.life=o.baseOpacity)))},cleanup(t){if(t.gestureData?.drift){const e=t.gestureData.drift;t.vx=e.originalVx,t.vy=e.originalVy,t.opacity=e.baseOpacity,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.drift}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t)},Vt={name:"flicker",emoji:"⚡",type:"blending",description:"Rapid opacity changes with motion jitter",config:{duration:800,flickerRate:15,frequency:6,minOpacity:.3,maxOpacity:1,jitterAmount:2,colorShift:!1,strobe:!1,pulseMode:!1,groupFlicker:.3,easing:"linear",strength:.7,particleMotion:{type:"flicker",strength:.7,frequency:6}},rhythm:{enabled:!0,syncMode:"subdivision",rateSync:{subdivision:"sixteenth",onBeat:30,offBeat:10,triplet:20,curve:"step"},opacitySync:{pattern:"HLMH",subdivision:"eighth",onAccent:.1,regular:.5},jitterSync:{onBeat:5,offBeat:1,accent:10,curve:"random"},strobeSync:{verse:!1,chorus:!0,drop:"intense",pattern:"XOXO"},dynamics:{forte:{flickerRate:25,jitterAmount:5,minOpacity:.1},piano:{flickerRate:8,jitterAmount:1,minOpacity:.5}}},initialize(t,e){t.gestureData||(t.gestureData={});const i={...this.config,...e},s=Math.random()<i.groupFlicker;t.gestureData.flicker={baseOpacity:t.opacity||t.life||1,baseColor:t.color,baseX:t.x,baseY:t.y,flickerTimer:0,lastFlicker:0,flickerState:!0,isGrouped:s,groupId:s?Math.floor(3*Math.random()):-1,phase:Math.random()*Math.PI*2,colorHue:0,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.flicker?.initialized||this.initialize(t,i);const o=t.gestureData.flicker,a={...this.config,...i},h=i.strength||1;let c;if(o.flickerTimer+=s*a.flickerRate,a.strobe)c=(o.flickerTimer+o.phase)%1<.5?1:a.minOpacity;else if(a.pulseMode){const t=o.flickerTimer+o.phase;c=a.minOpacity+(a.maxOpacity-a.minOpacity)*(.5*Math.sin(t)+.5)}else{if(o.flickerTimer-o.lastFlicker>1)if(o.lastFlicker=o.flickerTimer,o.isGrouped){const t=Math.floor(o.flickerTimer)%3;o.flickerState=t===o.groupId}else o.flickerState=Math.random()>.3;const e=o.flickerState?a.maxOpacity:a.minOpacity+.3*Math.random(),i=t.opacity/o.baseOpacity;c=i+.3*(e-i)}const u=o.baseOpacity*(1+(c-1)*h);if(t.opacity=Math.max(0,Math.min(1,u)),void 0!==t.life&&(t.life=t.opacity),a.jitterAmount>0&&c>a.minOpacity){const e=a.jitterAmount*h*t.scaleFactor,i=(Math.random()-.5)*e*c,n=(Math.random()-.5)*e*c;t.vx+=.1*i*s,t.vy+=.1*n*s}if(a.colorShift&&t.color){o.colorHue+=.01*s;const e=30*Math.sin(o.colorHue);t.color=this.shiftHue(o.baseColor,e*h)}let l=1;e<.1?l=e/.1:e>.9&&(l=(1-e)/.1),t.opacity*=l,void 0!==t.life&&(t.life=t.opacity),e>.8&&(t.vx*=.95,t.vy*=.95)},shiftHue(t,e){if(!t||!t.startsWith("#"))return t;const i=t.slice(1),s=parseInt(i.substr(0,2),16)/255,n=parseInt(i.substr(2,2),16)/255,r=parseInt(i.substr(4,2),16)/255,o=e*Math.PI/180,a=Math.cos(o),h=Math.sin(o),c=s*h+n*a,u=r,l=t=>Math.max(0,Math.min(255,Math.round(255*t))).toString(16).padStart(2,"0");return`#${l(s*a-n*h)}${l(c)}${l(u)}`},cleanup(t){if(t.gestureData?.flicker){const e=t.gestureData.flicker;t.opacity=e.baseOpacity,t.color=e.baseColor,void 0!==t.life&&(t.life=e.baseOpacity),delete t.gestureData.flicker}}},Yt={name:"burst",emoji:"💥",type:"blending",description:"Explosive outward burst from center",config:{decay:.5,strength:2},rhythm:{enabled:!0,syncMode:"beat",strengthSync:{onBeat:3.5,offBeat:1,curve:"explosion"},decaySync:{mode:"tempo",fast:.8,slow:.3,curve:"exponential"},durationSync:{mode:"beats",beats:.5,sustain:!1},accentResponse:{enabled:!0,multiplier:2.5,type:"strength"},patternOverrides:{rock:{strengthSync:{onBeat:4,offBeat:1.5},decaySync:{fast:.6,slow:.4}},electronic:{strengthSync:{onBeat:3.8,offBeat:.8,curve:"sharp"},decaySync:{fast:.9,slow:.7}},jazz:{strengthSync:{onBeat:2.8,offBeat:1.8,swing:!0},decaySync:{fast:.5,slow:.2}},orchestral:{strengthSync:{onBeat:3.2,offBeat:.5},accentResponse:{multiplier:3}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:2},offBeat:{multiplier:1.5}},decaySync:{multiplier:.7},accentResponse:{multiplier:3.5}},piano:{strengthSync:{onBeat:{multiplier:.6},offBeat:{multiplier:.3}},decaySync:{multiplier:1.3},accentResponse:{multiplier:1.8}}}},apply(t,e,i,s,n,r){const o=i.decay||this.config.decay,a=(i.strength||this.config.strength)*(1-e*o),h=t.x-n,c=t.y-r,u=Math.sqrt(h*h+c*c);u>1&&(t.vx+=h/u*a*2*s,t.vy+=c/u*a*2*s)}},Xt={name:"directional",emoji:"➡️",type:"blending",description:"Move particles in a specific direction",config:{angle:0,returnToOrigin:!1,strength:1},rhythm:{enabled:!0,syncMode:"flow",angleSync:{verse:0,chorus:90,bridge:180,outro:270,transition:"smooth"},strengthSync:{onBeat:1.8,offBeat:.6,curve:"wave"},returnSync:{enabled:!0,onSectionChange:!0,duration:"transition",strength:1.2},accentResponse:{enabled:!0,multiplier:2,type:"strength"},patternOverrides:{march:{angleSync:{verse:0,chorus:0},strengthSync:{onBeat:2.5,offBeat:1}},waltz:{angleSync:{verse:45,chorus:135,bridge:225,outro:315,transition:"circular"}},swing:{strengthSync:{onBeat:1.6,offBeat:1.4,swing:!0}},electronic:{angleSync:{transition:"instant"},strengthSync:{onBeat:2.2,offBeat:.4,curve:"sharp"}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:1.6},offBeat:{multiplier:1.2}},angleSync:{transition:"sharp"},accentResponse:{multiplier:2.5}},piano:{strengthSync:{onBeat:{multiplier:.7},offBeat:{multiplier:.8}},angleSync:{transition:"gradual"},accentResponse:{multiplier:1.4}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.directional={initialX:t.x,initialY:t.y}},apply(t,e,i,s,n,r){t.gestureData?.directional||this.initialize(t);const o=(i.angle||this.config.angle)*Math.PI/180,a=i.strength||this.config.strength;if(t.vx+=Math.cos(o)*a*.3*s,t.vy+=Math.sin(o)*a*.3*s,i.returnToOrigin&&e>.5){const i=2*(e-.5),n=t.gestureData.directional,r=n.initialX-t.x,o=n.initialY-t.y;t.vx+=r*i*.02*s,t.vy+=o*i*.02*s}}},Jt={name:"settle",emoji:"🍃",type:"blending",description:"Gradually settle particles to rest",config:{damping:.02,threshold:.01},rhythm:{enabled:!0,syncMode:"resolution",dampingSync:{onResolution:.035,onTension:.015,curve:"gradual"},thresholdSync:{mode:"dynamics",forte:.02,piano:.005,curve:"exponential"},durationSync:{mode:"phrase",minBeats:2,maxBeats:12,sustain:!0},cadenceResponse:{enabled:!0,multiplier:1.6,type:"damping"},patternOverrides:{ambient:{dampingSync:{onResolution:.025,onTension:.008,curve:"atmospheric"},durationSync:{minBeats:8,maxBeats:32}},jazz:{dampingSync:{onResolution:.04,onTension:.02},cadenceResponse:{multiplier:1.8}},classical:{dampingSync:{onResolution:.045,onTension:.012,curve:"expressive"},cadenceResponse:{multiplier:2}},minimalist:{dampingSync:{onResolution:.02,onTension:.005},durationSync:{minBeats:16,maxBeats:64}}},dynamics:{forte:{dampingSync:{onResolution:{multiplier:1.4},onTension:{multiplier:.8}},thresholdSync:{multiplier:2},cadenceResponse:{multiplier:2.2}},piano:{dampingSync:{onResolution:{multiplier:.7},onTension:{multiplier:1.2}},thresholdSync:{multiplier:.5},cadenceResponse:{multiplier:1.3}}}},apply(t,e,i,s,n,r){const o=i.damping||this.config.damping,a=i.threshold||this.config.threshold;t.vx*=Math.max(0,1-o*s*60),t.vy*=Math.max(0,1-o*s*60),Math.abs(t.vx)<a&&(t.vx=0),Math.abs(t.vy)<a&&(t.vy=0)}},Kt={name:"fade",emoji:"👻",type:"blending",description:"Fade particle opacity",config:{fadeIn:!1,fadeOut:!0,minOpacity:0,maxOpacity:1},rhythm:{enabled:!0,syncMode:"dynamic",opacitySync:{onBeat:.9,offBeat:.3,subdivision:"eighth",curve:"exponential"},fadePhaseSync:{verse:{fadeIn:!0,fadeOut:!1},chorus:{fadeIn:!1,fadeOut:!1},bridge:{fadeIn:!0,fadeOut:!0},outro:{fadeIn:!1,fadeOut:!0}},pulseSync:{enabled:!0,frequency:"quarter",intensity:.2,onAccent:.4},dynamics:{forte:{minOpacity:.5,maxOpacity:1},piano:{minOpacity:0,maxOpacity:.4}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.fade={baseOpacity:t.opacity||t.life||1}},apply(t,e,i,s,n,r){t.gestureData?.fade||this.initialize(t);const o=t.gestureData.fade,a={...this.config,...i};let h;h=a.fadeIn&&!a.fadeOut?a.minOpacity+(a.maxOpacity-a.minOpacity)*e:a.fadeOut&&!a.fadeIn?a.maxOpacity-(a.maxOpacity-a.minOpacity)*e:e<.5?a.minOpacity+(a.maxOpacity-a.minOpacity)*(2*e):a.maxOpacity-(a.maxOpacity-a.minOpacity)*(2*(e-.5)),t.opacity=o.baseOpacity*h,void 0!==t.life&&(t.life=t.opacity)},cleanup(t){t.gestureData?.fade&&(t.opacity=t.gestureData.fade.baseOpacity,void 0!==t.life&&(t.life=t.opacity),delete t.gestureData.fade)}},Qt={name:"hold",emoji:"⏸️",type:"override",description:"Hold particles in current position",config:{holdStrength:.95,allowDrift:!1},rhythm:{enabled:!0,syncMode:"rest",holdSync:{onRest:.98,onSound:.8,curve:"immediate"},durationSync:{mode:"rests",minBeats:.5,maxBeats:8,sustain:!0},pauseResponse:{enabled:!0,multiplier:1.5,type:"strength"},patternOverrides:{classical:{holdSync:{onRest:.99,onSound:.75,curve:"dramatic"},pauseResponse:{multiplier:2}},minimal:{holdSync:{onRest:.95,onSound:.85},durationSync:{minBeats:2,maxBeats:16}},jazz:{holdSync:{onRest:.9,onSound:.7},allowDrift:!0},electronic:{holdSync:{onRest:.99,onSound:.6,curve:"digital"},pauseResponse:{multiplier:1.2}}},dynamics:{forte:{holdSync:{onRest:{multiplier:1.02},onSound:{multiplier:.9}},pauseResponse:{multiplier:2.2}},piano:{holdSync:{onRest:{multiplier:.97},onSound:{multiplier:.85}},pauseResponse:{multiplier:1.3}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.hold={holdX:t.x,holdY:t.y,originalVx:t.vx,originalVy:t.vy}},apply(t,e,i,s,n,r){t.gestureData?.hold||this.initialize(t);const o=t.gestureData.hold,a=i.holdStrength||this.config.holdStrength;if(i.allowDrift?(t.vx*=a,t.vy*=a):(t.x+=(o.holdX-t.x)*(1-a),t.y+=(o.holdY-t.y)*(1-a),t.vx=0,t.vy=0),e>.9){const i=10*(e-.9);t.vx=t.vx*(1-i)+o.originalVx*i,t.vy=t.vy*(1-i)+o.originalVy*i}},cleanup(t){if(t.gestureData?.hold){const e=t.gestureData.hold;t.vx=e.originalVx,t.vy=e.originalVy,delete t.gestureData.hold}}},Zt={name:"breathe",emoji:"🫁",type:"blending",description:"Breathing rhythm with inhale and exhale",config:{musicalDuration:{musical:!0,bars:1,minBeats:2,maxBeats:16},phases:[{name:"inhale",beats:1.5},{name:"hold_in",beats:.5},{name:"exhale",beats:1.5},{name:"hold_out",beats:.5}],inhaleRadius:1.5,exhaleRadius:.3,breathRate:.3,spiralStrength:.002,scaleAmount:.25,glowAmount:.4,frequency:1,easing:"sine",strength:.8,particleMotion:{type:"breathe",strength:.8,inhaleRadius:1.5,exhaleRadius:.3}},rhythm:{enabled:!0,syncMode:"phrase",breathRateSync:{mode:"tempo",bpm:"auto",subdivision:"whole",curve:"sine"},radiusSync:{inhale:{onUpbeat:1.8,onDownbeat:1.4,curve:"ease-in"},exhale:{onUpbeat:.2,onDownbeat:.4,curve:"ease-out"}},durationSync:{mode:"phrases",phrases:2,hold:"fermata"},accentResponse:{enabled:!0,multiplier:1.5,type:"expansion"},patternOverrides:{ballad:{breathRateSync:{subdivision:"double-whole"},radiusSync:{inhale:{onUpbeat:2.2,onDownbeat:1.8},exhale:{onUpbeat:.1,onDownbeat:.2}}},uptempo:{breathRateSync:{subdivision:"half"},radiusSync:{inhale:{onUpbeat:1.4,onDownbeat:1.2},exhale:{onUpbeat:.3,onDownbeat:.4}}},ambient:{breathRateSync:{subdivision:"whole",curve:"ease"},radiusSync:{inhale:{onUpbeat:1.6,onDownbeat:1.6},exhale:{onUpbeat:.2,onDownbeat:.2}}}},dynamics:{forte:{radiusSync:{inhale:{multiplier:1.8},exhale:{multiplier:.5}},spiralStrength:.004,scaleAmount:.4},piano:{radiusSync:{inhale:{multiplier:1.2},exhale:{multiplier:.8}},spiralStrength:.001,scaleAmount:.1}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;t.gestureData.breathe={startX:t.x,startY:t.y,angle:Math.atan2(r,n),baseRadius:Math.sqrt(n*n+r*r),phaseOffset:.2*Math.random()-.1}},apply(t,e,i,s,n,r){t.gestureData?.breathe||this.initialize(t,i,n,r);const o={...this.config,...i},a=(Math.sin(e*Math.PI*2*o.breathRate)+1)/2,h=100*(t.scaleFactor||1),c=o.inhaleRadius*h,u=o.exhaleRadius*h,l=u+(c-u)*a,d=t.x-n,p=t.y-r,f=Math.sqrt(d*d+p*p),m=l-f,g=.05*(i.strength||.8)*s;if(f>0){const e=d/f*m*g,n=p/f*m*g;t.vx+=e,t.vy+=n;const r=o.spiralStrength*s*(i.strength||1),h=-p/f,c=d/f;t.vx+=h*r*a,t.vy+=c*r*a}t.vx*=.98,t.vy*=.98},cleanup(t){t.gestureData?.breathe&&delete t.gestureData.breathe}},te={name:"expand",emoji:"💫",type:"blending",description:"Radial expansion from center",config:{duration:600,scaleAmount:3,scaleTarget:3,glowAmount:.5,easing:"back",strength:3,particleMotion:{type:"pulse",strength:3,direction:"outward",persist:!0}},rhythm:{enabled:!0,syncMode:"crescendo",strengthSync:{pianissimo:1.5,fortissimo:5,crescendo:"build",sforzando:"burst"},scaleTargetSync:{verse:2,chorus:4.5,climax:6,curve:"exponential"},durationSync:{mode:"phrases",build:1.2,release:.8,sustain:"hold"},accentResponse:{enabled:!0,multiplier:2.8,type:"strength"},patternOverrides:{orchestral:{strengthSync:{pianissimo:2,fortissimo:6.5,crescendo:"dramatic"},scaleTargetSync:{climax:8}},rock:{strengthSync:{pianissimo:1.8,fortissimo:5.5,curve:"power"},accentResponse:{multiplier:3.2}},ambient:{strengthSync:{pianissimo:1.2,fortissimo:3.5,crescendo:"organic"},durationSync:{build:1.8,release:1.2}},electronic:{strengthSync:{pianissimo:1.6,fortissimo:4.8,curve:"digital"},scaleTargetSync:{curve:"linear"}}},dynamics:{forte:{strengthSync:{pianissimo:{multiplier:1.4},fortissimo:{multiplier:1.8}},scaleTargetSync:{multiplier:1.6},accentResponse:{multiplier:3.5}},piano:{strengthSync:{pianissimo:{multiplier:.8},fortissimo:{multiplier:1.2}},scaleTargetSync:{multiplier:.7},accentResponse:{multiplier:2}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;t.gestureData.expand={startX:t.x,startY:t.y,angle:Math.atan2(r,n),baseRadius:Math.sqrt(n*n+r*r),initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.expand?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.expand,a={...this.config,...i},h=a.strength||1,c=1+(a.scaleTarget-1)*e*h,u=o.baseRadius*c,l=n+Math.cos(o.angle)*u,d=r+Math.sin(o.angle)*u,p=l-t.x,f=d-t.y;t.vx+=.8*p*s,t.vy+=.8*f*s,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.expand&&delete t.gestureData.expand}},ee={name:"contract",emoji:"🌀",type:"blending",description:"Radial contraction toward center",config:{duration:600,scaleAmount:.2,scaleTarget:.2,glowAmount:-.2,easing:"cubic",strength:2.5,particleMotion:{type:"pulse",strength:2.5,direction:"inward",persist:!0}},rhythm:{enabled:!0,syncMode:"tension",strengthSync:{onTension:4,onRelease:1.5,curve:"magnetic"},scaleTargetSync:{forte:.1,piano:.4,crescendo:"gradual",diminuendo:"ease"},durationSync:{mode:"phrases",shortPhrase:.8,longPhrase:1.5,hold:"sustain"},accentResponse:{enabled:!0,multiplier:2.2,type:"strength"},patternOverrides:{classical:{strengthSync:{onTension:3.5,onRelease:1.8},scaleTargetSync:{forte:.15,piano:.35}},metal:{strengthSync:{onTension:5,onRelease:2,curve:"sharp"},scaleTargetSync:{forte:.05,piano:.25}},ambient:{strengthSync:{onTension:2.8,onRelease:1.2,curve:"ease"},durationSync:{shortPhrase:1.2,longPhrase:2}},trap:{strengthSync:{onTension:4.5,onRelease:1,dropBeat:6},scaleTargetSync:{forte:.08,piano:.3}}},dynamics:{forte:{strengthSync:{onTension:{multiplier:1.8},onRelease:{multiplier:1.4}},scaleTargetSync:{multiplier:.6},accentResponse:{multiplier:2.8}},piano:{strengthSync:{onTension:{multiplier:.7},onRelease:{multiplier:.8}},scaleTargetSync:{multiplier:1.4},accentResponse:{multiplier:1.6}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={});const n=t.x-i,r=t.y-s;t.gestureData.contract={startX:t.x,startY:t.y,angle:Math.atan2(r,n),baseRadius:Math.sqrt(n*n+r*r),initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.contract?.initialized||this.initialize(t,i,n,r);const o=t.gestureData.contract,a={...this.config,...i},h=a.strength||1,c=1-(1-a.scaleTarget)*e*h,u=o.baseRadius*c,l=n+Math.cos(o.angle)*u,d=r+Math.sin(o.angle)*u,p=l-t.x,f=d-t.y;t.vx+=.5*p*s,t.vy+=.5*f*s,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.contract&&delete t.gestureData.contract}},ie={name:"flash",emoji:"⚡",type:"blending",description:"Bright flash burst effect",config:{duration:400,glowAmount:2.5,glowPeak:3,scalePeak:1.1,easing:"cubic",strength:1,particleMotion:{type:"burst",strength:1,decay:.3}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"immediate",interruptible:!0,priority:8,blendable:!0,intensitySync:{onBeat:3.5,offBeat:1,accent:5,subdivision:"quarter",curve:"exponential"},durationSync:{mode:"tempo",baseDuration:400,scaling:"inverse"},scaleSync:{onBeat:1.2,offBeat:1,accent:1.4,curve:"elastic"},strobeSync:{enabled:!1,pattern:"XXOX",subdivision:"sixteenth"},dynamics:{forte:{glowPeak:4,scalePeak:1.3,duration:300},piano:{glowPeak:2,scalePeak:1.05,duration:500}}},initialize(t,e){t.gestureData||(t.gestureData={}),t.gestureData.flash={originalOpacity:t.opacity,originalSize:t.size,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.flash?.initialized||this.initialize(t,i);const o=t.gestureData.flash,a={...this.config,...i},h=a.strength||1;let c;if(c=e<.3?e/.3*a.glowPeak:a.glowPeak*(1-(e-.3)/.7),t.opacity=Math.min(1,o.originalOpacity*(1+c*h)),t.size=o.originalSize*(1+(a.scalePeak-1)*c*h*.1),e<.2){const i=(1-e/.2)*h,o=Math.atan2(t.y-r,t.x-n);t.vx+=Math.cos(o)*i*2*s,t.vy+=Math.sin(o)*i*2*s}t.vx*=1-.1*a.particleMotion.decay,t.vy*=1-.1*a.particleMotion.decay},cleanup(t){t.gestureData?.flash&&(t.opacity=t.gestureData.flash.originalOpacity,t.size=t.gestureData.flash.originalSize,delete t.gestureData.flash)}},se={name:"glow",emoji:"✨",type:"blending",description:"Pure luminous glow without movement",config:{duration:1500,amplitude:0,frequency:1,holdPeak:.3,easing:"sine",scaleAmount:.1,glowAmount:.8,strength:0,direction:"none",particleMotion:{type:"glow",strength:0,direction:"none",frequency:1}},rhythm:{enabled:!0,syncMode:"phrase",amplitudeSync:{onBeat:2,offBeat:1.2,curve:"smooth"},frequencySync:{mode:"phrase",subdivision:"bar"},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:2.5},patternOverrides:{ambient:{amplitudeSync:{onBeat:2.5,offBeat:1.8},durationSync:{bars:4}},electronic:{amplitudeSync:{onBeat:3,offBeat:.5,curve:"sharp"},frequencySync:{subdivision:"quarter"}}}},initialize(t,e,i,s){t.gestureData||(t.gestureData={}),t.gestureData.glow={startOpacity:t.opacity,startGlow:t.glowSizeMultiplier||0,initialized:!0}},apply(t,e,i,s,n,r){t.gestureData?.glow?.initialized||this.initialize(t,i,n,r);const o={...this.config,...i},a=this.easeInOutSine(e);let h,{frequency:c}=o,{glowAmount:u}=o;i.rhythmModulation&&(u*=i.rhythmModulation.amplitudeMultiplier||1,u*=i.rhythmModulation.accentMultiplier||1,i.rhythmModulation.frequencyMultiplier&&(c*=i.rhythmModulation.frequencyMultiplier));const l=a*c*2%2;h=o.holdPeak>0&&l>1-o.holdPeak&&l<1+o.holdPeak?1:Math.sin(a*Math.PI*2*c);let d=1;e>.9&&(d=.5+.5*(1-10*(e-.9))),t.glowIntensity=1+h*u*d},cleanup(t){t.gestureData?.glow&&(t.glowIntensity=1,delete t.gestureData.glow)},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},ne={name:"peek",emoji:"👀",type:"effect",description:"Quick peek and hide motion",config:{peekDistance:40,peekSpeed:.15,holdDuration:200,hideSpeed:.25,stagger:!0,duration:1500},rhythm:{enabled:!0,syncMode:"accent",distanceSync:{onAccent:60,offAccent:25,curve:"quick"},speedSync:{mode:"tempo",fast:.25,slow:.1,hideMultiplier:1.8},durationSync:{mode:"subdivision",beats:.25,staggerBeats:.125,sustain:!1},syncopationResponse:{enabled:!0,multiplier:1.8,type:"distance"},patternOverrides:{funk:{distanceSync:{onAccent:70,offAccent:35,curve:"funky"},syncopationResponse:{multiplier:2.2}},latin:{speedSync:{fast:.3,slow:.12},durationSync:{beats:.5,staggerBeats:.25}},breakbeat:{distanceSync:{onAccent:55,offAccent:40},syncopationResponse:{multiplier:2.5}},classical:{distanceSync:{onAccent:45,offAccent:20,curve:"elegant"},speedSync:{fast:.18,slow:.08}}},dynamics:{forte:{distanceSync:{onAccent:{multiplier:1.6},offAccent:{multiplier:1.3}},speedSync:{multiplier:1.4},syncopationResponse:{multiplier:2.8}},piano:{distanceSync:{onAccent:{multiplier:.6},offAccent:{multiplier:.4}},speedSync:{multiplier:.7},syncopationResponse:{multiplier:1.2}}}},apply(t,e,i,s,n,r){if(t.gestureData||(t.gestureData={}),!t.gestureData.peek){const e=t.x-n,i=t.y-r,s=Math.atan2(i,e),o=Math.sqrt(e*e+i*i);t.gestureData.peek={originalX:t.x,originalY:t.y,peekAngle:s,originalDistance:o,staggerDelay:this.config.stagger?.3*Math.random():0,phase:"waiting",phaseTimer:0,peekOffset:{x:0,y:0}}}const o=t.gestureData.peek,{config:a}=this,h=Math.max(0,Math.min(1,(e-o.staggerDelay)/(1-o.staggerDelay)));0===h?o.phase="waiting":h<.3?o.phase="peeking":h<.6?o.phase="holding":h<1&&(o.phase="hiding");let c=0;switch(o.phase){case"peeking":{const t=h/.3;c=this.easeOutCubic(t)*a.peekDistance;break}case"holding":c=a.peekDistance,Math.random()<.1&&(o.peekOffset.x+=2*(Math.random()-.5),o.peekOffset.y+=2*(Math.random()-.5));break;case"hiding":{const t=(h-.6)/.4;c=(1-this.easeInCubic(t))*a.peekDistance;break}}if("waiting"!==o.phase){const e=Math.cos(o.peekAngle)*c,i=Math.sin(o.peekAngle)*c;o.peekOffset.x+=(e-o.peekOffset.x)*a.peekSpeed,o.peekOffset.y+=(i-o.peekOffset.y)*a.peekSpeed,t.x=o.originalX+o.peekOffset.x,t.y=o.originalY+o.peekOffset.y}void 0!==t.alpha&&("peeking"===o.phase||"holding"===o.phase?t.alpha=.7+.3*Math.random():t.alpha=1)},easeOutCubic:t=>1-Math.pow(1-t,3),easeInCubic:t=>t*t*t,cleanup(t){t.gestureData?.peek&&(t.x=t.gestureData.peek.originalX,t.y=t.gestureData.peek.originalY,void 0!==t.alpha&&(t.alpha=1),delete t.gestureData.peek)}};const re=(t,e="✨")=>({name:t,emoji:e,type:"blending",description:`${t} animation`,config:{duration:1e3,musicalDuration:{musical:!0,beats:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply:(t,e,i)=>!1,blend:(t,e,i)=>!1}),oe=[Et,Ct,At,It,Ft,_t,Rt,Pt,Ot,Bt,re("sparkle","✨"),{name:"shimmer",emoji:"🌟",type:"particle",description:"Shimmer effect with sparkling particles",config:{duration:2e3,musicalDuration:{musical:!0,bars:1},particleMotion:"radiant"},rhythm:{enabled:!0,syncType:"beat",durationSync:{mode:"bars",bars:1},intensity:.8},override:(t,e,i)=>(t.shimmerEffect=!0,t.shimmerProgress=e,!0),blend:(t,e,i)=>!1},re("wiggle","〰️"),re("groove","🎵"),re("point","👉"),re("lean","↗️"),re("reach","🤚"),re("headBob","🎧"),{name:"rain",emoji:"🌧️",type:"particle",description:"Rain effect with falling particles",config:{duration:3e3,musicalDuration:{musical:!0,bars:2},particleMotion:"falling"},rhythm:{enabled:!0,syncType:"off-beat",durationSync:{mode:"bars",bars:2},intensity:.8},apply:(t,e,i)=>(t.rainEffect=!0,t.rainProgress=e,!0),blend:(t,e,i)=>!1}],ae=[Dt,$t,zt,qt,jt,Lt,Nt,Gt,Ut],he=[Wt,Ht,Vt,Yt,Xt,Jt,Kt,Qt,Zt,te,ee,ie,se,ne,{name:"runningman",emoji:"🏃",type:"effect",description:"Hip-hop running man shuffle",config:{duration:2e3,slideDistance:30,stepHeight:15,speed:1.2,strength:.8,particleMotion:{type:"runningman",strength:.7}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:1,accentBeats:[1,3]},apply:(t,e,i,s,n,r)=>!1,blend:(t,e,i)=>!1},{name:"charleston",emoji:"🕺",type:"effect",description:"Hip-hop Charleston shuffle with crisscross",config:{duration:2500,kickDistance:35,swivelRange:40,bounceHeight:12,strength:.9,particleMotion:{type:"charleston",strength:.8}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:2,accentBeats:[1,2.5,3,4.5]},apply:(t,e,i,s,n,r)=>!1,blend:(t,e,i)=>!1}],ce={};[...oe,...ae,...he].forEach(t=>{ce[t.name]=t});const ue={blending:oe.map(t=>t.name),override:ae.map(t=>t.name),effect:he.map(t=>t.name)};function le(t){return ce[t]?ce[t]:Tt.getPluginGesture(t)||null}function de(t){const e=le(t);return!!e&&"blending"===e.type}function pe(t){const e=le(t);return!!e&&"override"===e.type}function fe(t,e,i,s,n,r,o){const a=le(e);return!!a&&(a.apply&&a.apply(t,i,s,n,r,o),i>=1&&a.cleanup&&a.cleanup(t),!0)}function me(){const t=[];return Object.values(ce).forEach(e=>{t.push({name:e.name,emoji:e.emoji||"🎭",type:e.type,description:e.description||"No description",source:"core"})}),Tt.getAllPluginGestures().forEach(e=>{const i=Tt.getPluginGesture(e);t.push({name:i.name,emoji:i.emoji||"🔌",type:i.type,description:i.description||"Plugin gesture",source:"plugin"})}),t}var ge={GESTURE_REGISTRY:ce,GESTURE_TYPES:ue,getGesture:le,isBlendingGesture:de,isOverrideGesture:pe,applyGesture:fe,listGestures:me,pluginAdapter:Tt},ye=Object.freeze({__proto__:null,GESTURE_REGISTRY:ce,GESTURE_TYPES:ue,applyGesture:fe,default:ge,getGesture:le,isBlendingGesture:de,isOverrideGesture:pe,listGestures:me,pluginAdapter:Tt});class be{constructor(t,e,i="ambient",s=1,n=1,r=null){const o=Math.random();this.z=o<1/13?.5+.5*Math.random():.9*Math.random()-1;const a=this.z>0?(20+20*Math.random())*s:3*s,h=Math.random()*Math.PI*2;this.x=t+Math.cos(h)*a,this.y=e+Math.sin(h)*a,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.maxLife=1,this.lifeDecay=.01,this.fadeInTime=.15,this.fadeOutTime=.3,this.isFadingOut=!1,this.age=0,this.scaleFactor=s,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*s*n,this.baseSize=this.size,this.emotionColors=r,this.color="#ffffff",this.opacity=1,this.hasGlow=Math.random()<.333,this.glowSizeMultiplier=this.hasGlow?1.33+.33*Math.random():0,this.isCellShaded=Math.random()<.333,this.baseOpacity=.3+.4*Math.random(),this.cachedColors=new Map,this.lastColor=null,this.lastOpacity=-1,this.behavior=i,this.behaviorData={},this.gestureData={initialX:t,initialY:e},vt(this,i)}update(t,e,i,s=null,n=null,r=0,o=null){const a=Math.min(t,50)/16.67,h=n&&n.type&&r>0&&pe(n.type);let c,u;if(h?this.applyGestureMotion(n,r,a,e,i):"falling"===this.gestureBehavior?wt(this,"falling",a,e,i):"radiant"===this.gestureBehavior?wt(this,"radiant",a,e,i):(wt(this,this.behavior,a,e,i),n&&r>0&&this.applyGestureMotion(n,r,a,e,i)),h||(this.x+=this.vx*a,this.y+=this.vy*a),o)c=o.width,u=o.height;else{const t=document.getElementById("card-mascot")||document.getElementById("cherokee-guide-mascot")||document.querySelector("canvas");c=t?t.width:2*e,u=t?t.height:2*i}const l=e-c/2+20,d=e+c/2-20,p=i-u/2+20,f=i+u/2-20;this.x-this.size<l?(this.x=l+this.size,this.vx=.5*Math.abs(this.vx)):this.x+this.size>d&&(this.x=d-this.size,this.vx=.5*-Math.abs(this.vx)),this.y-this.size<p?(this.y=p+this.size,this.vy=.5*Math.abs(this.vy)):this.y+this.size>f&&(this.y=f-this.size,this.vy=.5*-Math.abs(this.vy)),this.age+=this.lifeDecay*a,this.age<this.fadeInTime?this.life=this.age/this.fadeInTime:this.age<1-this.fadeOutTime?this.life=1:(this.life=(1-this.age)/this.fadeOutTime,this.isFadingOut=!0,"popcorn"===this.behavior&&(this.size=this.baseSize*(.5+.5*this.life))),this.life=Math.max(0,Math.min(1,this.life)),this.opacity=this.easeInOutCubic(this.life),"burst"===this.behavior&&this.behaviorData&&this.life<this.behaviorData.fadeStart&&(this.size=this.baseSize*(this.life/this.behaviorData.fadeStart))}applyUndertoneModifier(t,e){}applyGestureMotion(t,e,i,s,n){!function(t,e,i,s,n,r){if(!i||!i.type||s>=1)return;t.gestureData||(t.gestureData={originalVx:t.vx,originalVy:t.vy,initialX:t.x,initialY:t.y,startAngle:Math.atan2(t.y-r,t.x-n),startRadius:Math.sqrt(Math.pow(t.x-n,2)+Math.pow(t.y-r,2))});const o=le(i.type);if(!o)return;let a=i;if(U.isEnabled()&&o.rhythm?.enabled){const n=U.applyGestureRhythm(o,t,s,e);a={...i,amplitude:(i.amplitude||1)*(n.amplitudeMultiplier||1)*(n.accentMultiplier||1),wobbleAmount:(i.wobbleAmount||0)*(n.wobbleMultiplier||1),rhythmModulation:n}}o.apply&&o.apply(t,s,a,e,n,r),s>=.99&&o.cleanup&&(o.cleanup(t),t.gestureData=null)}(this,i,t,e,s,n)}isOutOfBounds(t,e){return this.x<-50||this.x>t+50||this.y<-50||this.y>e+50}isAlive(){return this.life>0}setOutwardVelocity(t){if(this.behaviorData&&void 0!==this.behaviorData.outwardSpeed){const e=this.behaviorData.outwardSpeed;this.vx=Math.cos(t)*e,this.vy=Math.sin(t)*e+(this.behaviorData.upwardBias||0)}}getDepthAdjustedSize(){const t=1+.2*this.z;return this.size*t}getState(){return{position:{x:this.x,y:this.y,z:this.z},velocity:{x:this.vx,y:this.vy,z:this.vz},life:this.life,behavior:this.behavior,size:this.size,opacity:this.opacity}}reset(t,e,i="ambient",s=1,n=1,r=null){const o=Math.random();this.z=o<1/13?.5+.5*Math.random():.9*Math.random()-1;const a=this.z>0?(20+20*Math.random())*s:3*s,h=Math.random()*Math.PI*2;if(this.x=t+Math.cos(h)*a,this.y=e+Math.sin(h)*a,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.age=0,this.scaleFactor=s,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*s*n,this.baseSize=this.size,this.emotionColors=r,this.cachedColors.clear(),this.opacity=0,this.isFadingOut=!1,this.baseOpacity=.3+.4*Math.random(),this.color="#ffffff",this.behavior=i,this.gestureData=null,this.behaviorData)for(const t in this.behaviorData)delete this.behaviorData[t];else this.behaviorData={};vt(this,i)}getCachedColor(t,e){const i=Math.round(100*e)/100,s=`${t}_${i}`;return this.cachedColors.has(s)||this.cachedColors.set(s,this.hexToRgba(t,i)),this.cachedColors.get(s)}hexToRgba(t,e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?`rgba(${parseInt(i[1],16)}, ${parseInt(i[2],16)}, ${parseInt(i[3],16)}, ${e})`:`rgba(255, 255, 255, ${e})`}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}render(t,e="#ffffff"){if(this.life<=0)return;if(!isFinite(this.x)||!isFinite(this.y))return;const i=this.x,s=this.y,n=Math.max(.1,this.size),r=this.tempColor||this.color||e;if(t.save(),this.isCellShaded){t.strokeStyle=this.getCachedColor(r,.9*this.opacity),t.lineWidth=2,t.beginPath(),t.arc(i,s,n,0,2*Math.PI),t.stroke();const e=Math.floor(3*this.opacity)/3;t.fillStyle=this.getCachedColor(r,e*(this.baseOpacity||.5)*.5),t.beginPath(),t.arc(i,s,Math.max(.1,n-1),0,2*Math.PI),t.fill(),e>.5&&(t.fillStyle=this.getCachedColor("#FFFFFF",.3),t.beginPath(),t.arc(i-.3*n,s-.3*n,.3*n,0,2*Math.PI),t.fill())}else{const e=t.createRadialGradient(i,s,0,i,s,n);if(e.addColorStop(0,this.getCachedColor(r,this.opacity*(this.baseOpacity||.5))),e.addColorStop(.5,this.getCachedColor(r,this.opacity*(this.baseOpacity||.5)*.5)),e.addColorStop(1,this.getCachedColor(r,0)),t.fillStyle=e,t.beginPath(),t.arc(i,s,n,0,2*Math.PI),t.fill(),this.hasGlow&&this.glowSizeMultiplier>0){const e=n*this.glowSizeMultiplier,o=t.createRadialGradient(i,s,.5*n,i,s,e),a=.3,h=Math.max(a,this.opacity),c=Math.min(1,this.glowSizeMultiplier/3);o.addColorStop(0,this.getCachedColor(r,Math.max(.5,.8*h)*c)),o.addColorStop(.25,this.getCachedColor(r,Math.max(.3,.6*h)*c)),o.addColorStop(.5,this.getCachedColor(r,Math.max(.2,.4*h)*c)),o.addColorStop(.75,this.getCachedColor(r,Math.max(.1,.2*h)*c)),o.addColorStop(1,this.getCachedColor(r,0)),t.save(),t.globalCompositeOperation="screen",t.fillStyle=o,t.beginPath(),t.arc(i,s,e,0,2*Math.PI),t.fill(),t.restore()}}t.restore()}}class ve{constructor(t=50){this.poolSize=Math.min(t,50),this.pool=[],this.totalParticlesCreated=0,this.totalParticlesDestroyed=0,this.poolHits=0,this.poolMisses=0}getParticle(t,e,i,s,n,r,o,a=null){let h;return this.pool.length>0?(h=this.pool.pop(),h.reset(t,e,i,s,n,r),this.poolHits++):(h=new be(t,e,i,s,n,r),this.poolMisses++,this.totalParticlesCreated++),h.emotion=o,a&&(h.gestureBehavior=a),h}returnParticle(t){if(this.pool.length<this.poolSize){if(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData)for(const e in t.behaviorData)delete t.behaviorData[e];this.pool.push(t)}else this.totalParticlesDestroyed++}refreshPool(){const t=this.pool.length-this.poolSize;t>0&&(this.pool.splice(this.poolSize),this.totalParticlesDestroyed+=t)}getStats(){return{poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,totalCreated:this.totalParticlesCreated,totalDestroyed:this.totalParticlesDestroyed}}clear(){this.pool=[],this.poolHits=0,this.poolMisses=0,this.totalParticlesCreated=0,this.totalParticlesDestroyed=0}}class we{constructor(){this.spawnAccumulator=0}getSpawnPosition(t,e,i,s,n,r=null){const o=Math.min(s,n)/12,a=2.5*o,h=1.1*a,c=Math.min(e-30,s-e-30),u=Math.min(i-30,n-i-30),l=Math.min(1.5*a,c,u);switch(t){case"ambient":case"resting":{const t=Math.random()*Math.PI*2,s=.9*a;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s,angle:t}}case"rising":case"falling":{const t=Math.random()*Math.PI*2,s=h+Math.random()*(l-h);return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}case"aggressive":{const t=Math.random()*Math.PI*2,s=a+Math.random()*o;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}case"scattering":default:return{x:e,y:i};case"burst":{const t=Math.random()*Math.PI*2;if("suspicion"===r){const s=1.5*o;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}if("surprise"===r){const s=1.2*o;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}return{x:e,y:i}}case"repelling":{const t=Math.random()*Math.PI*2,s=.9*a;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}case"orbiting":{const t=Math.random()*Math.PI*2,s=1.2*a+Math.random()*a*.5;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}case"glitchy":{const t=Math.random()*Math.PI*2,s=3*a+Math.random()*a*4;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}case"spaz":{const t=Math.random()*Math.PI*2,s=2*a+Math.random()*a*3;return{x:e+Math.cos(t)*s,y:i+Math.sin(t)*s}}}}clampToCanvas(t,e,i,s,n=30){return{x:Math.max(n,Math.min(i-n,t)),y:Math.max(n,Math.min(s-n,e))}}calculateSpawnRate(t,e){if(t<=0)return 0;const i=Math.min(e,50),s=t/1e3;this.spawnAccumulator+=s*i,this.spawnAccumulator=Math.min(this.spawnAccumulator,3);let n=0;for(;this.spawnAccumulator>=1;)n++,this.spawnAccumulator-=1;return n}resetAccumulator(){this.spawnAccumulator=0}}class Me{render(t,e,i="#ffffff",s=null){const n=[];for(const t of e)t.life<=0||n.push(t);this.i(t,n,i,s)}renderLayer(t,e,i="#ffffff",s=!1,n=null){const r=[],o=t.canvas.width,a=t.canvas.height;for(const t of e)t.z>=0===s&&(t.x<-50||t.x>o+50||t.y<-50||t.y>a+50||t.life<=0||r.push(t));return r.sort((t,e)=>t.isCellShaded!==e.isCellShaded?t.isCellShaded?-1:1:t.hasGlow!==e.hasGlow?t.hasGlow?-1:1:0),this.i(t,r,i,n),r}i(t,e,i,s=null){t.save();let n=null;for(const r of e)if(r.isCellShaded)r.render(t,i),n=null;else{const e=r.color||i;if(e!==n&&(t.fillStyle=e,n=e),!isFinite(r.x)||!isFinite(r.y))continue;const o=r.getDepthAdjustedSize?r.getDepthAdjustedSize():r.size;let a=Math.max(.1,o),h=1;if(s&&s.fireflyEffect){const t=(.01*r.x+.01*r.y+.1*r.size)%(2*Math.PI),e=s.fireflyTime||.001*Date.now(),i=s.particleGlow||2;h=.3+Math.max(0,Math.sin(3*e+t))*i}if(s&&s.flickerEffect){const t=(.02*r.x+.02*r.y)%(2*Math.PI),e=s.flickerTime||.001*Date.now(),i=s.particleGlow||2;h=.5+Math.sin(12*e+t)*i*.5}if(s&&s.shimmerEffect){const e=r.x-t.canvas.width/2,i=r.y-t.canvas.height/2,n=Math.sqrt(e*e+i*i)/200,o=s.shimmerTime||.001*Date.now(),a=s.shimmerWave||0,c=s.particleGlow||1.2;h=1+.15*Math.sin(3*o-n+a)*c}if(s&&s.glowEffect){const e=s.glowProgress||0,i=s.particleGlow||2,n=r.x-t.canvas.width/2,o=r.y-t.canvas.height/2,h=Math.sqrt(n*n+o*o)/300,c=Math.min(.3*h,.5),u=Math.max(0,(e-c)/(1-c)),l=Math.sin(u*Math.PI);r.o||(r.o={hasGlow:r.hasGlow,glowSizeMultiplier:r.glowSizeMultiplier||0}),r.hasGlow=!0,r.glowSizeMultiplier=Math.max(3,r.o.glowSizeMultiplier)+l*i*3,a*=1+.3*l,e>=.99&&r.o&&(r.hasGlow=r.o.hasGlow,r.glowSizeMultiplier=r.o.glowSizeMultiplier,delete r.o)}if(r.hasGlow||h>1){const e=Math.max(.1,a*(r.glowSizeMultiplier||1.5)*h),i=t.globalCompositeOperation;t.globalCompositeOperation="screen",t.globalAlpha=.15*r.opacity*h,t.beginPath(),t.arc(r.x,r.y,e,0,2*Math.PI),t.fill(),t.globalAlpha=.25*r.opacity*h,t.beginPath(),t.arc(r.x,r.y,.6*e,0,2*Math.PI),t.fill(),t.globalCompositeOperation=i}t.globalAlpha=r.opacity*(r.baseOpacity||.5)*.6*Math.min(2,h),t.beginPath(),t.arc(r.x,r.y,a,0,2*Math.PI),t.fill()}t.restore()}}class Se{constructor(t=50,e=null){this.errorBoundary=e,this.maxParticles=t,this.absoluteMaxParticles=2*t,this.particles=[],this.particlePool=new ve(t),this.particleSpawner=new we,this.particleRenderer=new Me,this.containmentBounds=null,this.stateChangeCount=0,this.lastMemoryCheck=Date.now(),this.lastLeakedCount=0,this.particleCount=0,this.cleanupTimer=0,this.cleanupInterval=5e3}get pool(){return this.particlePool.pool}get poolSize(){return this.particlePool.poolSize}get poolHits(){return this.particlePool.poolHits}get poolMisses(){return this.particlePool.poolMisses}get totalParticlesCreated(){return this.particlePool.totalParticlesCreated}get totalParticlesDestroyed(){return this.particlePool.totalParticlesDestroyed}get spawnAccumulator(){return this.particleSpawner.spawnAccumulator}set spawnAccumulator(t){this.particleSpawner.spawnAccumulator=t}getParticleFromPool(t,e,i){return this.particlePool.getParticle(t,e,i,this.scaleFactor||1,this.particleSizeMultiplier||1,this.currentEmotionColors,this.currentEmotion,this.gestureBehavior)}returnParticleToPool(t){this.particlePool.returnParticle(t)}spawn(t,e,i,s,n,r,o=null,a=0,h=10,c=1,u=1,l=null,d=null){if(this.scaleFactor=c,this.particleSizeMultiplier=u,this.errorBoundary)return this.errorBoundary.wrap(()=>{this.u(t,e,i,s,n,r,o,a,h,l,d)},"particle-spawn")();this.u(t,e,i,s,n,r,o,a,h,l,d)}resetAccumulator(){this.particleSpawner.resetAccumulator()}u(t,e,i,s,n,r,o,a=0,h=10,u=null,l=null){this.currentEmotion=e,this.baseEmotionColors=u,this.currentUndertone=l,this.currentEmotionColors=u&&l?function(t,e){return t&&Array.isArray(t)&&e&&"clear"!==e?t.map(t=>"string"==typeof t?c(t,e):t&&"object"==typeof t&&t.color?{...t,color:c(t.color,e)}:t):t}(u,l):u;let d=i;if(U.isEnabled()){const i=L&&L.isInitialized?L.getEmotion(e):F(e);if(i){const e=U.applyParticleRhythm(i,this);if(e.emitBurst)for(let i=0;i<e.emitBurst&&this.particles.length<h;i++)this.spawnSingleParticle(t,s,n);void 0!==e.emissionRate&&(d*=e.emissionRate)}}if(null!==o){for(let e=0;e<o&&this.particles.length<this.maxParticles;e++)this.spawnSingleParticle(t,s,n);return}if(this.skipSpawnThisFrame)return;for(;this.particles.length<a&&this.particles.length<this.maxParticles;)this.spawnSingleParticle(t,s,n);if(this.particles.length>=h)return;if(d<=0)return;const p=this.particleSpawner.calculateSpawnRate(d,r);for(let e=0;e<p&&this.particles.length<h;e++)this.spawnSingleParticle(t,s,n)}getSpawnPosition(t,e,i,s,n){return this.particleSpawner.getSpawnPosition(t,e,i,s,n,this.currentEmotion)}clampToCanvas(t,e,i,s,n=30){return this.particleSpawner.clampToCanvas(t,e,i,s,n)}spawnSingleParticle(t,e,i){if(this.particles.length>=this.absoluteMaxParticles)return;const s=this.canvasWidth||2*e,n=this.canvasHeight||2*i,r=this.particleSpawner.getSpawnPosition(t,e,i,s,n,this.currentEmotion),o=this.particleSpawner.clampToCanvas(r.x,r.y,s,n);r.x=o.x,r.y=o.y;const a=this.getParticleFromPool(r.x,r.y,t);"meditation_swirl"===t&&r.palmCenter&&(a.palmCenter=r.palmCenter,a.swirlAngle=r.swirlAngle),this.particles.push(a),this.particleCount++}update(t,e,i,s=null,n=0,r=null){if(this.errorBoundary)return this.errorBoundary.wrap((t,e,i,s,n,r)=>this.p(t,e,i,s,n,r),"particle-update")(t,e,i,s,n,r);this.p(t,e,i,s,n,r)}p(t,e,i,s=null,n=0,r=null){for(this.particles=this.particles.filter(o=>(o.update(t,e,i,r,s,n,this.containmentBounds),o.isAlive()));this.particles.length>this.maxParticles;)this.removeParticle(0)}setGestureBehavior(t,e){this.gestureBehavior=e?t:null,e?this.particles.forEach(e=>{e.gestureBehavior=t}):this.particles.forEach(t=>{t.gestureBehavior=null})}removeParticle(t){if(t>=0&&t<this.particles.length){const e=this.particles.splice(t,1)[0];e.cachedGradient=null,e.cachedGradientKey=null,this.returnParticleToPool(e),this.particleCount=Math.max(0,this.particleCount-1)}}render(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.m(t,e,i)},"particle-render")();this.m(t,e,i)}renderBackground(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.v(t,e,!1,i)},"particle-render-bg")();this.v(t,e,!1,i)}renderForeground(t,e="#ffffff",i=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.v(t,e,!0,i)},"particle-render-fg")();this.v(t,e,!0,i)}v(t,e,i,s=null){this.particleRenderer.renderLayer(t,this.particles,e,i,s)}m(t,e,i=null){this.particleRenderer.render(t,this.particles,e,i)}clear(){for(this.stateChangeCount++;this.particles.length>0;){const t=this.particles.pop();if(t.cachedColors&&t.cachedColors.clear(),t.behaviorData)for(const e in t.behaviorData)delete t.behaviorData[e];this.pool.length<this.poolSize&&!this.pool.includes(t)&&this.pool.push(t)}if(this.particles.length=0,this.particleCount=0,this.spawnAccumulator=0,this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;this.pool.splice(this.poolSize,t)}}burst(t,e,i,s){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.M(t,e,i,s)},"particle-burst")();this.M(t,e,i,s)}M(t,e,i,s){const n=Math.min(t,this.maxParticles-this.particles.length);for(let t=0;t<n;t++)this.spawnSingleParticle(e,i,s)}performCleanup(){if(this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;for(let e=0;e<t;e++){const t=this.pool.pop();t&&(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData=null)}}for(const t of this.particles)t.cachedGradient&&t.life<.5&&(t.cachedGradient=null,t.cachedGradientKey=null)}getStats(){return{activeParticles:this.particles.length,maxParticles:this.maxParticles,poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,poolEfficiency:this.poolHits/Math.max(1,this.poolHits+this.poolMisses),spawnAccumulator:this.spawnAccumulator}}setMaxParticles(t){for(this.originalMaxParticles=this.originalMaxParticles||this.maxParticles,this.maxParticles=Math.max(1,t);this.particles.length>this.maxParticles;)this.removeParticle(0)}cleanupDeadParticles(){const t=this.particles.length;this.particles=this.particles.filter(t=>t.isAlive());const e=t-this.particles.length;return this.pool.length>20&&(this.pool.length=20),e}getParticlesByBehavior(t){return this.particles.filter(e=>e.behavior===t)}validateParticles(){for(const t of this.particles)if(!t.isAlive()||t.life<0||t.life>1)return!1;return!0}cleanup(){for(let t=this.particles.length-1;t>=0;t--)this.particles[t].isAlive()||this.removeParticle(t)}refreshPool(){this.particlePool.clear();for(const t of this.particles)t.life=0}setContainmentBounds(t){this.containmentBounds=t}destroy(){this.clear(),this.particlePool.clear()}}const ke=new class{constructor(){this.gestureCache=new Map,this.propertyCache=new Map,this.compositionCache=new Map,this.pluginCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{this.cacheCoreGestures(),this.cacheGestureProperties(),this.cacheCommonCombinations(),this.cachePluginGestures(),this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.gestureCache.size+this.propertyCache.size+this.compositionCache.size,this.isInitialized=!0}catch(t){this.isInitialized=!1}}cacheCoreGestures(){Object.values(ce).forEach(t=>{t&&t.name&&this.gestureCache.set(t.name,{...t,cached:!0,cacheTime:performance.now()})})}cacheGestureProperties(){this.gestureCache.forEach((t,e)=>{const i={type:t.type,emoji:t.emoji,description:t.description,config:t.config,rhythm:t.rhythm,duration:this.calculateGestureDuration(t),easing:this.extractEasingFunction(t),physics:this.extractPhysicsProperties(t),timing:this.extractTimingProperties(t)};this.propertyCache.set(e,i)})}cacheCommonCombinations(){[["bounce","pulse"],["shake","vibrate"],["orbit","spin"],["morph","glow"],["breathe","fade"],["wave","drift"],["nod","sway"],["jump","stretch"]].forEach(([t,e])=>{const i=`${t}+${e}`,s=this.calculateGestureCombination(t,e);s&&this.compositionCache.set(i,s)})}cachePluginGestures(){try{const t=Tt.getAllPluginGestures();t&&Object.entries(t).forEach(([t,e])=>{this.pluginCache.set(t,{...e,cached:!0,cacheTime:performance.now(),isPlugin:!0})})}catch(t){}}getGesture(t){return this.gestureCache.has(t)?(this.stats.hits++,this.stats.gestureHits++,this.gestureCache.get(t)):this.pluginCache.has(t)?(this.stats.hits++,this.stats.gestureHits++,this.pluginCache.get(t)):(this.stats.misses++,null)}getGestureProperties(t){return this.propertyCache.has(t)?(this.stats.hits++,this.stats.propertyHits++,this.propertyCache.get(t)):(this.stats.misses++,null)}getGestureCombination(t,e){const i=`${t}+${e}`;return this.compositionCache.has(i)?(this.stats.hits++,this.stats.compositionHits++,this.compositionCache.get(i)):(this.stats.misses++,null)}calculateGestureDuration(t){if(!t.config)return 1e3;const{musicalDuration:e,duration:i}=t.config;return e&&e.musical?500*(e.beats||2):i||1e3}extractEasingFunction(t){if(!t.config)return"sine";const{easing:e,particleMotion:i}=t.config;return e||i?.easing||"sine"}extractPhysicsProperties(t){if(!t.config)return{};const{amplitude:e,strength:i,size:s,rotation:n}=t.config;return{amplitude:e||20,strength:i||1,size:s||80,rotation:n||0}}extractTimingProperties(t){if(!t.config)return{};const{phases:e,timingSync:i}=t.config;return{phases:e||[],timingSync:i||{},hasPhases:!!(e&&e.length>0),hasTimingSync:!!(i&&Object.keys(i).length>0)}}calculateGestureCombination(t,e){const i=this.getGesture(t),s=this.getGesture(e);return i&&s?{gestures:[t,e],combinedDuration:Math.max(this.calculateGestureDuration(i),this.calculateGestureDuration(s)),combinedType:i.type===s.type?i.type:"mixed",combinedEasing:this.extractEasingFunction(i),combinedPhysics:this.combinePhysicsProperties(i,s),compatibility:this.calculateCompatibility(i,s)}:null}combinePhysicsProperties(t,e){const i=this.extractPhysicsProperties(t),s=this.extractPhysicsProperties(e);return{amplitude:Math.max(i.amplitude,s.amplitude),strength:(i.strength+s.strength)/2,size:Math.max(i.size,s.size),rotation:(i.rotation+s.rotation)/2}}calculateCompatibility(t,e){return t.type===e.type?"high":"blending"===t.type&&"blending"===e.type?"medium":"override"===t.type||"override"===e.type?"low":"medium"}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(1):0;return{...this.stats,hitRate:`${t}%`,isInitialized:this.isInitialized,cacheSize:this.stats.cacheSize,coreGestures:this.gestureCache.size,pluginGestures:this.pluginCache.size,properties:this.propertyCache.size,combinations:this.compositionCache.size}}clear(){this.gestureCache.clear(),this.propertyCache.clear(),this.compositionCache.clear(),this.pluginCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1}warmUp(t){t.forEach(t=>{this.getGesture(t),this.getGestureProperties(t)})}};function xe(t){if(ke&&ke.isInitialized){const e=ke.getGesture(t);if(e)return e}return le(t)}const Te={none:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},clear:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},nervous:{speed:1.2,amplitude:.9,intensity:1.1,smoothness:.7,regularity:.6,addFlutter:!0,addMicroShake:!0},confident:{speed:.9,amplitude:1.3,intensity:1.2,smoothness:1.1,regularity:1.2,addPower:!0,addHold:!0},tired:{speed:.7,amplitude:.7,intensity:.8,smoothness:1.3,regularity:.8,addDroop:!0,addPause:!0},intense:{speed:1.3,amplitude:1.2,intensity:1.4,smoothness:.6,regularity:.9,addPulse:!0,addFocus:!0},subdued:{speed:.8,amplitude:.8,intensity:.7,smoothness:1.2,regularity:1.1,addSoftness:!0,addFade:!0}};class Ee{constructor(){this.cache=new Map,this.easingCache=new Map,this.preCalculateEasingCurves()}preCalculateEasingCurves(){const t=["linear","ease-in","ease-out","ease-in-out","bounce"];for(const e of t){const t=new Float32Array(101);for(let i=0;i<=100;i++){const s=i/100;t[i]=this.calculateEasing(s,e)}this.easingCache.set(e,t)}}calculateEasing(t,e){switch(e){case"ease-in":return t*t;case"ease-out":return t*(2-t);case"ease-in-out":return t<.5?2*t*t:(4-2*t)*t-1;case"bounce":return t<.363636?7.5625*t*t:t<.727272?7.5625*(t-=.545454)*t+.75:t<.90909?7.5625*(t-=.818181)*t+.9375:7.5625*(t-=.954545)*t+.984375;default:return t}}getEasingValue(t,e){const i=this.easingCache.get(e);return i?i[Math.min(Math.floor(100*t),100)]:t}compose(t,e,i=null){const s=`${t}-${e}-${i||"none"}`;if(this.cache.has(s))return this.cache.get(s);const n=xe(t),r=n?n.config:{duration:500,amplitude:20,easing:"sine"},o=L&&L.isInitialized?L.getModifiers(e):R(e),a=function(t){return t&&""!==t&&"clear"!==t&&Te[t]||Te.clear}(i),h=this.applyModifiers(r,o,a,t);return this.cache.size>100&&this.cache.clear(),this.cache.set(s,h),h}applyModifiers(t,e,i,s){const n={...t},r=e.speed*i.speed;if(n.duration=Math.round(t.duration/r),void 0!==n.amplitude&&(n.amplitude=t.amplitude*e.amplitude*i.amplitude),void 0!==n.scaleAmount&&(n.scaleAmount=t.scaleAmount*e.intensity*i.intensity),void 0!==n.scaleTarget){const s=e.amplitude*i.amplitude;n.scaleTarget=1+(t.scaleTarget-1)*s}void 0!==n.glowAmount&&(n.glowAmount=t.glowAmount*e.intensity*i.intensity),void 0!==n.glowPeak&&(n.glowPeak=1+(t.glowPeak-1)*e.intensity*i.intensity),void 0!==n.rotations&&(n.rotations=t.rotations*e.amplitude*i.amplitude),void 0!==n.angle&&(n.angle=t.angle*e.amplitude*i.amplitude),void 0!==n.distance&&(n.distance=t.distance*e.amplitude*i.amplitude);const o=e.smoothness*i.smoothness;return n.smoothness=o,n.easing=this.selectEasing(t.easing,o),n.regularity=e.regularity*i.regularity,n.effects=[],e.addBounce&&n.effects.push("bounce"),e.addGravity&&n.effects.push("gravity"),e.addShake&&n.effects.push("shake"),e.addJitter&&n.effects.push("shake"),e.addPop&&n.effects.push("pop"),e.addRecoil&&n.effects.push("recoil"),e.addWarmth&&n.effects.push("warmth"),e.addFlow&&n.effects.push("flow"),e.addWobble&&n.effects.push("wobble"),e.addVibration&&n.effects.push("vibration"),e.addDrag&&n.effects.push("drag"),e.addWeight&&n.effects.push("weight"),e.addTension&&n.effects.push("tension"),e.addPrecision&&n.effects.push("precision"),i.addFlutter&&n.effects.push("flutter"),i.addMicroShake&&n.effects.push("microShake"),i.addPower&&n.effects.push("power"),i.addHold&&n.effects.push("hold"),i.addDroop&&n.effects.push("droop"),i.addPause&&n.effects.push("pause"),i.addPulse&&n.effects.push("pulse"),i.addFocus&&n.effects.push("focus"),i.addSoftness&&n.effects.push("softness"),i.addFade&&n.effects.push("fade"),this.applyGestureSpecificMods(n,s,e,i),t.particleMotion&&(n.particleMotion={...t.particleMotion},void 0!==n.particleMotion.strength&&(n.particleMotion.strength*=e.intensity*i.intensity),void 0!==n.particleMotion.frequency&&(n.particleMotion.frequency*=r),void 0!==n.particleMotion.amplitude&&(n.particleMotion.amplitude*=e.amplitude*i.amplitude)),n}selectEasing(t,e){return e<.5?"linear":e<.8?"quad":e<1.2?t:e<1.5?"cubic":"sine"}applyGestureSpecificMods(t,e,i,s){switch(e){case"bounce":i.addShake&&(t.frequency=Math.floor(1.5*t.frequency)),i.addGravity&&(t.amplitude*=.6,t.frequency=1);break;case"pulse":i.addWarmth&&(t.frequency=2,t.glowAmount*=1.5),s.addFlutter&&(t.irregular=!0);break;case"shake":i.addJitter&&(t.frequency*=1.5,t.amplitude*=1.2),i.addShake&&(t.amplitude*=1.5,t.decay=!1);break;case"spin":i.addBounce&&(t.rotations*=1.5),i.addWobble&&(t.wobble=!0)}}clearCache(){this.cache.clear()}}var Ce={name:"zen-vortex",emoji:"🌀",description:"Swirling meditation vortex effect",config:{vortexSpeed:.02,spiralTightness:.15,maxRadius:1.5,lineWidth:2,segments:50,arms:3,fadeStart:.7,baseOpacity:.3,pulseSpeed:.01},state:{rotation:0,pulsePhase:0,intensity:0},shouldActivate:t=>"zen"===t.emotion||t.zenTransition?.active,apply(t,e){const{x:i,y:s,radius:n,intensity:r=1,deltaTime:o=16.67}=e;this.state.rotation+=this.config.vortexSpeed*(o/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(o/16.67),this.state.intensity=r,t.save();for(let e=0;e<this.config.arms;e++){const r=2*Math.PI/this.config.arms*e;this.drawSpiralArm(t,i,s,n,r)}this.drawMeditationEyes(t,i,s,.6*n,r),t.restore()},drawSpiralArm(t,e,i,s,n){t.beginPath();const r=1+.1*Math.sin(this.state.pulsePhase);for(let o=0;o<=this.config.segments;o++){const a=o/this.config.segments,h=this.state.rotation+n+a*Math.PI*4,c=a*s*this.config.maxRadius*r,u=e+Math.cos(h)*c,l=i+Math.sin(h)*c;0===o?t.moveTo(u,l):t.lineTo(u,l)}const o=t.createLinearGradient(e-s,i,e+s,i),a=this.config.baseOpacity*this.state.intensity;o.addColorStop(0,"rgba(147, 112, 219, 0)"),o.addColorStop(.3,`rgba(147, 112, 219, ${.5*a})`),o.addColorStop(this.config.fadeStart,`rgba(147, 112, 219, ${a})`),o.addColorStop(1,"rgba(147, 112, 219, 0)"),t.strokeStyle=o,t.lineWidth=this.config.lineWidth,t.stroke()},drawMeditationEyes(t,e,i,s,n){t.save();const r=.4*s,o=.3*s;t.strokeStyle=`rgba(255, 255, 255, ${.8*n})`,t.lineWidth=2,t.beginPath(),t.arc(e-o,i,r,Math.PI,0,!0),t.stroke(),t.beginPath(),t.arc(e+o,i,r,Math.PI,0,!0),t.stroke(),t.restore()},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.intensity=0}},Ae={name:"recording-glow",emoji:"🔴",description:"Pulsating red recording indicator",config:{color:"#FF0000",pulseSpeed:.08,minIntensity:.6,maxIntensity:1,radiusMultiplier:2,gradientStops:[{position:0,opacity:1},{position:.3,opacity:.7},{position:.6,opacity:.4},{position:.85,opacity:.2},{position:1,opacity:0}]},state:{pulsePhase:0,intensity:.8},shouldActivate:t=>!0===t.recording,apply(t,e){const{deltaTime:i=16.67}=e;this.state.pulsePhase+=this.config.pulseSpeed*(i/16.67);const s=(Math.sin(this.state.pulsePhase)+1)/2;return this.state.intensity=this.config.minIntensity+(this.config.maxIntensity-this.config.minIntensity)*s,!0},drawRecordingIndicator(t,e,i){t.save();const s=Math.min(e,i),n=Math.floor(.08*s),r=1.5*n,o=1.5*n,a=.3*n;t.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),t.beginPath(),t.arc(r-n,o,a,0,2*Math.PI),t.fill(),t.strokeStyle=this.hexToRgba("#FFFFFF",.8*this.state.intensity),t.lineWidth=3,t.font=`bold ${n}px 'Arial', sans-serif`,t.textAlign="left",t.textBaseline="middle",t.strokeText("REC",r,o),t.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),t.fillText("REC",r,o),t.restore()},hexToRgba:(t,e)=>`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, ${e})`,reset(){this.state.pulsePhase=0,this.state.intensity=0}},Ie={name:"speaking-pulse",emoji:"🗣️",description:"Audio-reactive pulse when speaking",config:{scaleMultiplier:.15,smoothing:.1,minPulse:.02,colorShift:!0,ringEffect:!0},state:{audioLevel:0,smoothedLevel:0,rings:[]},shouldActivate:t=>!0===t.speaking,apply(t,e){const{x:i,y:s,radius:n,audioLevel:r=0,deltaTime:o=16.67}=e;this.state.smoothedLevel+=(r-this.state.smoothedLevel)*this.config.smoothing,r>.5&&this.state.audioLevel<=.5&&this.state.rings.push({radius:n,opacity:.5,speed:2}),this.config.ringEffect&&this.drawRings(t,i,s,o),this.state.audioLevel=r},drawRings(t,e,i,s){t.save(),t.strokeStyle="rgba(100, 200, 255, 0.5)",t.lineWidth=2;for(let n=this.state.rings.length-1;n>=0;n--){const r=this.state.rings[n];r.radius+=r.speed*(s/16.67),r.opacity-=s/16.67*.02,r.opacity<=0?this.state.rings.splice(n,1):(t.globalAlpha=r.opacity,t.beginPath(),t.arc(e,i,r.radius,0,2*Math.PI),t.stroke())}t.restore()},getScaleModifier(){return 1+this.state.smoothedLevel*this.config.scaleMultiplier}},Fe={name:"sleeping",emoji:"😴",description:"Sleeping with closed eyes and Z particles",config:{eyeClosedScale:.1,breathingDepth:.15,breathingRate:.8,zParticleInterval:2e3,zDriftSpeed:1,zFadeSpeed:.01,orbDimming:.3,glowDimming:.2},state:{lastZSpawn:0,zParticles:[]},shouldActivate:t=>!0===t.sleeping||"resting"===t.emotion,apply(t,e){const{x:i,y:s,radius:n,deltaTime:r=16.67}=e,o=Date.now();if(o-this.state.lastZSpawn>this.config.zParticleInterval){const t=[100,200,300,400,500,600,700,800,900],e=t[Math.floor(Math.random()*t.length)];this.state.zParticles.push({x:i+n,y:s-n,opacity:1,size:12+8*Math.random(),drift:.5*Math.random()-.25,weight:e,rotation:30*Math.random()-15}),this.state.lastZSpawn=o}this.drawZParticles(t,r)},drawZParticles(t,e){t.save(),t.textAlign="center",t.textBaseline="middle";for(let i=this.state.zParticles.length-1;i>=0;i--){const s=this.state.zParticles[i];s.y-=this.config.zDriftSpeed*(e/16.67),s.x+=s.drift*(e/16.67),s.opacity-=this.config.zFadeSpeed*(e/16.67),s.rotation+=e/16.67*.5,s.opacity<=0?this.state.zParticles.splice(i,1):(t.save(),t.translate(s.x,s.y),t.rotate(s.rotation*Math.PI/180),t.globalAlpha=.7*s.opacity,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`${s.weight} ${s.size}px 'Poppins', sans-serif`,t.fillText("Z",0,0),t.shadowBlur=3,t.shadowColor="rgba(147, 112, 219, 0.5)",t.fillText("Z",0,0),t.restore())}t.restore()},getEyeOpenness(){return this.config.eyeClosedScale},getBreathingModifiers(){return{rate:this.config.breathingRate,depth:this.config.breathingDepth}},getDimmingValues(){return{orbDimming:this.config.orbDimming,glowDimming:this.config.glowDimming}}},_e={name:"suspicion-scan",emoji:"🔍",description:"Suspicious scanning and squinting",config:{squintAmount:.4,scanInterval:5e3,scanDuration:800,scanAngle:45,squintSpeed:.02,pupilShift:.3},state:{currentSquint:0,targetSquint:0,lastScanTime:0,scanPhase:0,scanning:!1},shouldActivate:t=>"suspicion"===t.emotion||!0===t.suspicious,apply(t,e){const{deltaTime:i=16.67}=e,s=Date.now();this.updateSquint(i),s-this.state.lastScanTime>this.config.scanInterval&&(this.startScan(),this.state.lastScanTime=s),this.state.scanning&&this.updateScan(s,i)},updateSquint(t){this.state.targetSquint=this.config.squintAmount;const e=this.state.targetSquint-this.state.currentSquint;Math.abs(e)>.01?this.state.currentSquint+=e*this.config.squintSpeed*(t/16.67):this.state.currentSquint=this.state.targetSquint},startScan(){this.state.scanning=!0,this.state.scanStartTime=Date.now(),this.state.scanPhase=-1},updateScan(t,e){const i=(t-this.state.scanStartTime)/this.config.scanDuration;i<.33?this.state.scanPhase=-1:i<.66?this.state.scanPhase=1:(i<1||(this.state.scanning=!1),this.state.scanPhase=0)},getEyeModifiers(){return{scaleY:1-this.state.currentSquint,scaleX:1+.3*this.state.currentSquint,offsetX:this.state.scanPhase*this.config.pupilShift}},drawScanLines(t,e,i,s){if(!this.state.scanning)return;t.save(),t.strokeStyle="rgba(255, 165, 0, 0.3)",t.lineWidth=1,t.setLineDash([5,5]);const n=this.state.scanPhase*(this.config.scanAngle*Math.PI/180),r=e+Math.cos(n)*s*2,o=i+Math.sin(n)*s*.5;t.beginPath(),t.moveTo(e,i),t.lineTo(r,o),t.stroke(),t.restore()}},Re={name:"gaze-narrowing",emoji:"👁️",description:"Eye narrowing based on gaze proximity",config:{maxHorizontalScale:1.3,maxVerticalScale:.5,smoothing:.1,focusThreshold:.3},state:{currentScaleX:1,currentScaleY:1,targetScaleX:1,targetScaleY:1},shouldActivate:t=>t.gazeIntensity>0||t.gazeLocked,apply(t,e){const{gazeIntensity:i=0,deltaTime:s=16.67}=e;if(i>this.config.focusThreshold){const t=(i-this.config.focusThreshold)/(1-this.config.focusThreshold);this.state.targetScaleX=1+(this.config.maxHorizontalScale-1)*t,this.state.targetScaleY=1-(1-this.config.maxVerticalScale)*t}else this.state.targetScaleX=1,this.state.targetScaleY=1;this.animateScales(s)},animateScales(t){const e=this.config.smoothing*(t/16.67),i=this.state.targetScaleX-this.state.currentScaleX;Math.abs(i)>.001&&(this.state.currentScaleX+=i*e);const s=this.state.targetScaleY-this.state.currentScaleY;Math.abs(s)>.001&&(this.state.currentScaleY+=s*e)},getEyeScales(){return{scaleX:this.state.currentScaleX,scaleY:this.state.currentScaleY}},drawFocusIndicator(t,e,i,s,n){if(n<this.config.focusThreshold)return;t.save();const r=.5*(n-this.config.focusThreshold);t.strokeStyle=`rgba(100, 200, 255, ${r})`,t.lineWidth=1,t.setLineDash([2,4]);const o=[0,60,120,180,240,300];for(const n of o){const r=n*Math.PI/180,o=2*s,a=1.2*s;t.beginPath(),t.moveTo(e+Math.cos(r)*o,i+Math.sin(r)*o),t.lineTo(e+Math.cos(r)*a,i+Math.sin(r)*a),t.stroke()}t.restore()}},Pe={name:"fingerprint",emoji:"👆",description:"Biometric fingerprint pattern for authentication UI",config:{rings:8,ringSpacing:15,lineWidth:1.5,rotationSpeed:.001,pulseSpeed:.02,waveAmplitude:3,waveFrequency:8,breakPoints:5,opacity:.4,scanLineSpeed:.01,scanLineWidth:3,color:"#00CED1",glowColor:"#00FFFF",successColor:"#00FF00",failColor:"#FF0000"},state:{rotation:0,pulsePhase:0,scanPosition:0,scanDirection:1,isScanning:!1,scanResult:null,breaks:[],whorls:[]},shouldActivate:t=>!0===t.biometric||!0===t.fingerprint||!0===t.authenticating,initialize(){this.state.breaks=[];for(let t=0;t<this.config.rings;t++){const t=[];for(let e=0;e<this.config.breakPoints;e++)t.push(Math.random()*Math.PI*2);this.state.breaks.push(t)}this.state.whorls=[{x:.2,y:-.1,strength:.3},{x:-.15,y:.2,strength:.25},{x:0,y:0,strength:.5}]},apply(t,e){const{x:i,y:s,radius:n,deltaTime:r=16.67,scanning:o=!1,authResult:a=null}=e;0===this.state.breaks.length&&this.initialize(),this.state.rotation+=this.config.rotationSpeed*(r/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(r/16.67),(o||this.state.isScanning)&&(this.state.isScanning=!0,this.state.scanPosition+=this.config.scanLineSpeed*this.state.scanDirection*(r/16.67),this.state.scanPosition>1?(this.state.scanPosition=1,this.state.scanDirection=-1):this.state.scanPosition<-1&&(this.state.scanPosition=-1,this.state.scanDirection=1)),t.save(),this.drawFingerprintPattern(t,i,s,n),this.state.isScanning&&this.drawScanLine(t,i,s,n),a&&this.showAuthResult(t,i,s,n,a),t.restore()},drawFingerprintPattern(t,e,i,s){const n=.1*Math.sin(this.state.pulsePhase)+1;for(let r=0;r<this.config.rings;r++){const o=(r+1)*this.config.ringSpacing*n;if(!(o>2*s)){t.beginPath(),t.strokeStyle=this.config.color,t.lineWidth=this.config.lineWidth,t.globalAlpha=this.config.opacity*(1-r/this.config.rings*.5);for(let n=0;n<2*Math.PI;n+=.05){let a=!1;for(const t of this.state.breaks[r]||[])if(Math.abs(n-t)<.1){a=!0;break}if(a){t.stroke(),t.beginPath();continue}let h=o,c=n+this.state.rotation;for(const t of this.state.whorls){const n=e+t.x*s,r=i+t.y*s,o=e+Math.cos(c)*h,a=i+Math.sin(c)*h,u=Math.sqrt(Math.pow(o-n,2)+Math.pow(a-r,2));c+=Math.exp(-u/(.5*s))*t.strength*.5}h+=Math.sin(n*this.config.waveFrequency)*this.config.waveAmplitude;const u=e+Math.cos(c)*h,l=i+Math.sin(c)*h;0===n?t.moveTo(u,l):t.lineTo(u,l)}t.stroke()}}},drawScanLine(t,e,i,s){const n=i+this.state.scanPosition*s,r=t.createLinearGradient(e-s,n,e+s,n);r.addColorStop(0,"rgba(0, 255, 255, 0)"),r.addColorStop(.5,this.config.glowColor),r.addColorStop(1,"rgba(0, 255, 255, 0)"),t.strokeStyle=r,t.lineWidth=this.config.scanLineWidth,t.globalAlpha=.8,t.shadowBlur=10,t.shadowColor=this.config.glowColor,t.beginPath(),t.moveTo(e-s,n),t.lineTo(e+s,n),t.stroke(),t.shadowBlur=0},showAuthResult(t,e,i,s,n){const r="success"===n?this.config.successColor:this.config.failColor,o="success"===n?"✓ AUTHENTICATED":"✗ ACCESS DENIED";t.fillStyle=r,t.font=`bold ${.15*s}px monospace`,t.textAlign="center",t.textBaseline="middle",t.globalAlpha=.9,t.fillText(o,e,i+1.3*s),t.strokeStyle=r,t.lineWidth=3,t.globalAlpha=.5,t.beginPath(),t.arc(e,i,1.1*s,0,2*Math.PI),t.stroke()},startScan(){this.state.isScanning=!0,this.state.scanPosition=-1,this.state.scanDirection=1,this.state.scanResult=null},completeScan(t=!0){this.state.isScanning=!1,this.state.scanResult=t?"success":"fail",setTimeout(()=>{this.state.scanResult=null},2e3)},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.scanPosition=0,this.state.scanDirection=1,this.state.isScanning=!1,this.state.scanResult=null}};const Oe=new Map;function Be(t){t.name&&Oe.set(t.name,t)}function De(t){return Oe.get(t)||null}function $e(t,e,i){const s=De(t);return!!s&&!!s.apply&&(s.apply(e,i),!0)}function ze(t,e){const i=De(t);return!(!i||!i.shouldActivate)&&i.shouldActivate(e)}Be(Ce),Be(Ae),Be(Ie),Be(Fe),Be(_e),Be(Re),Be(Pe);const qe=new class{constructor(){this.noteDurations={whole:4,half:2,quarter:1,eighth:.5,sixteenth:.25,triplet:.333,"dotted-quarter":1.5,"dotted-half":3},this.cache=new Map,this.lastBPM=0,this.prewarmCache()}prewarmCache(){const t=[{musical:!0,beats:1},{musical:!0,bars:1},{musical:!0,beats:.5},{musical:!0,beats:2}];[60,90,120,140,160,180].forEach(e=>{t.forEach(t=>{const i=`${e}_${JSON.stringify(t)}`,s=this.toMilliseconds(t,e);this.cache.set(i,s)})})}toMilliseconds(t,e=null){const i=e||G.bpm||120;if("number"==typeof t)return t;if("object"==typeof t&&t.musical){const e=6e4/i;if(void 0!==t.beats)return t.beats*e;if(void 0!==t.bars){const i=G.timeSignature||[4,4];return t.bars*i[0]*e}if(void 0!==t.subdivision)return(this.noteDurations[t.subdivision]||1)*e}return 1e3}toMusical(t,e=null){const i=t/(6e4/(e||G.bpm||120));let s="quarter",n=Math.abs(i-1);for(const[t,e]of Object.entries(this.noteDurations)){const r=Math.abs(i-e);r<n&&(n=r,s=t)}return{musical:!0,beats:i,bars:i/4,closestSubdivision:s,exact:n<.01}}calculatePhases(t,e){if(!t||0===t.length)return[{name:"main",beats:e,start:0,end:1}];const i=t.reduce((t,e)=>t+(e.beats||1),0),s=e/i;let n=0;return t.map(t=>{const i=(t.beats||1)*s,r=n/e;n+=i;const o=n/e;return{name:t.name,beats:i,start:r,end:o,duration:this.toMilliseconds({musical:!0,beats:i})}})}getBeatProgress(){const t=G.getTimeInfo();return t?t.beatProgress:0}getBarProgress(){const t=G.getTimeInfo();return t?t.barProgress:0}timeToNextBoundary(t="beat"){const e=G.getTimeInfo();if(!e)return 100;switch(t){case"beat":default:return e.nextBeatIn;case"bar":return(e.timeSignature[0]-e.beatInBar)*e.beatDuration;case"phrase":{const t=4,i=e.timeSignature[0];return(t-(e.bar||0)%t)*i*e.beatDuration}}}quantize(t,e="eighth"){const i=6e4/(G.bpm||120),s=(this.noteDurations[e]||1)*i;return Math.round(t/s)*s}isOnBoundary(t="beat",e=50){const i=this.timeToNextBoundary(t),s=G.getTimeInfo();return!!s&&(i<e||s.beatDuration-i<e)}getTempoAdaptation(t=120){const e=(G.bpm||120)/t;return{speed:e,energy:Math.min(2,Math.max(.5,e)),smoothness:e<.8?1.2:e>1.5?.8:1,intensity:e>1.3?1.2:e<.7?.8:1}}};class je{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyBounce(t,e){return{offsetY:-Math.abs(Math.sin(e*Math.PI*t.params.frequency))*t.params.amplitude*this.scaleFactor*(t.params.effects&&t.params.effects.includes("gravity")?.6:1)}}applyShake(t,e){t.randomAngle||(t.randomAngle=Math.random()*Math.PI*2);const i=t.params.decay?1-e:1,s=Math.sin(e*Math.PI*t.params.frequency)*t.params.amplitude*i*this.scaleFactor;return{offsetX:s*Math.cos(t.randomAngle),offsetY:s*Math.sin(t.randomAngle)}}applyJump(t,e){let i,s,n=0,r=1;if(e<.2){const i=e/.2;r=1-(1-t.params.squashAmount)*i}else if(e<.7){const i=(e-.2)/.5,s=Math.sin(i*Math.PI);n=-t.params.jumpHeight*s*this.scaleFactor,r=t.params.squashAmount+(t.params.stretchAmount-t.params.squashAmount)*s}else{const i=(e-.7)/.3;r=t.params.stretchAmount-(t.params.stretchAmount-1)*i}if(t.params.effects&&t.params.effects.includes("gravity")){const t=e<.7?(e-.2)/.5:0,n=Math.sin(t*Math.PI);i=1+.2*n,s=1-.15*n}const o={offsetY:n,scale:r};return void 0!==i&&(o.scaleX=i),void 0!==s&&(o.scaleY=s),o}applyVibrate(t,e){if(!t.vibrateAngles){t.vibrateAngles={x:2*Math.random()-1,y:2*Math.random()-1};const e=Math.sqrt(t.vibrateAngles.x**2+t.vibrateAngles.y**2);t.vibrateAngles.x/=e,t.vibrateAngles.y/=e}const i=t.params.amplitude||5,s=t.params.frequency||20,n=Math.sin(e*Math.PI*2*s)*i*this.scaleFactor;return{offsetX:n*t.vibrateAngles.x,offsetY:n*t.vibrateAngles.y}}applyWiggle(t,e){const i=(t.params?.amplitude||15)*this.scaleFactor;void 0===t.wiggleDirection&&(t.wiggleDirection=Math.random()<.5?1:-1);const s=t.wiggleDirection;let n=0,r=0;if(e<.25){const t=e/.25;n=i*s*t,r=3*s*t}else if(e<.5){const t=(e-.25)/.25;n=i*s*(1-2*t),r=3*s*(1-2*t)}else if(e<.75){const t=(e-.5)/.25;n=i*-s*(1-2*t),r=3*-s*(1-2*t)}else{const t=(e-.75)/.25;n=i*s*(1-t),r=3*s*(1-t)}return{offsetX:n,offsetY:-Math.abs(Math.sin(e*Math.PI*4))*i*.15,rotation:r}}}class Le{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyFlash(t,e){const i=Math.sin(e*Math.PI);return{glow:1+((t.params.glowPeak||2)-1)*i,scale:1+((t.params.scalePeak||1.1)-1)*i}}applyGlow(t,e){const i=Math.sin(e*Math.PI*t.params.frequency);return{scale:1+i*(t.params.scaleAmount||.1),glow:1+i*(t.params.glowAmount||.8)}}applyFlicker(t,e){const i=t.params?.intensity||2,s=t.params?.speed||3,n=1+Math.sin(e*Math.PI*2*s)*i*.3,r=5*Math.sin(e*Math.PI*4)*this.scaleFactor,o=.001*Date.now();return{offsetX:r,glow:n,particleGlow:(.5*Math.sin(e*Math.PI*s*2)+.5)*i,flickerTime:o,flickerEffect:!0}}applySparkle(t,e){const i=t.params?.intensity||2,s=.001*Date.now();return{particleGlow:i,glow:.3*Math.sin(e*Math.PI*4)+.7,fireflyTime:s,fireflyEffect:!0}}applyShimmer(t,e){const i=.001*Date.now(),s=t.params?.intensity||.3,n=Math.sin(2*i+e*Math.PI*2);return{offsetX:0,offsetY:0,glow:1+n*s,scale:1+.01*n,particleGlow:1+.2*n,shimmerTime:i,shimmerWave:n,shimmerEffect:!0}}}class Ne{constructor(t){this.renderer=t}applyBreathe(t,e){const{params:i}=t,s=i.particleMotion?.holdPercent||.1;let n;if(e<.4)n=Math.sin(e/.4*Math.PI/2);else if(e<.4+s)n=1;else if(e<.9){const t=(e-.4-s)/(.5-s);n=Math.cos(t*Math.PI/2)}else n=0;const r=1+n*(i.scaleAmount||.25),o=1+n*(i.glowAmount||.4);return t.breathPhase=n,{scale:r,glow:o,breathPhase:n}}applyBreathIn(t,e){return{scale:1+(t.params.scaleAmount-1)*Math.sin(e*Math.PI/2)}}applyBreathOut(t,e){return{scale:1-(1-t.params.scaleAmount)*Math.sin(e*Math.PI/2)}}applyBreathHold(t,e){return{scale:t.params.scaleAmount}}applyBreathHoldEmpty(t,e){return{scale:t.params.scaleAmount}}}class Ge{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applySpin(t,e){return{rotation:Math.min(1.05*e,1)*t.params.rotations*360,scale:1+Math.sin(e*Math.PI)*t.params.scaleAmount}}applyDrift(t,e){e<=.01&&!t.currentDriftAngle&&(t.currentDriftAngle=Math.random()*Math.PI*2);const i=t.params.distance*Math.sin(e*Math.PI)*this.scaleFactor,s=t.currentDriftAngle||0;return e>=.99&&(t.currentDriftAngle=null),{offsetX:Math.cos(s)*i,offsetY:Math.sin(s)*i}}applyWave(t,e){const i=(t.params.amplitude||40)*this.scaleFactor,s=e*Math.PI*2,n=Math.sin(s)*i,r=-Math.sin(e*Math.PI)*i*.3;return{offsetX:n,offsetY:Math.sin(2*s)*i*.2+r,rotation:5*Math.sin(s),scale:1+.05*Math.sin(e*Math.PI*2),glow:1+.2*Math.sin(e*Math.PI)}}applySway(t,e){const i=(t.params?.amplitude||30)*this.scaleFactor,s=t.params?.frequency||1;return{offsetX:Math.sin(e*Math.PI*2*s)*i,offsetY:Math.sin(e*Math.PI*4*s)*i*.1,rotation:5*Math.sin(e*Math.PI*2*s)}}applyFloat(t,e){const i=(t.params?.amplitude||20)*this.scaleFactor,s=t.params?.speed||1,n=Math.sin(e*Math.PI*2*s)*i;return{offsetX:Math.sin(e*Math.PI*3*s)*i*.3,offsetY:n,scale:1+.02*Math.sin(e*Math.PI*4*s)}}applyOrbital(t,e){return{offsetX:0,offsetY:0}}applyHula(t,e){const i=(t.params?.amplitude||40)*this.scaleFactor,s=e*Math.PI*2;return{offsetX:Math.sin(s)*i,offsetY:Math.sin(2*s)*i*.5}}applyOrbit(t,e){const i=(t.params?.radius||30)*this.scaleFactor,s=t.params?.speed||1,n=e*Math.PI*2*s;return{offsetX:Math.cos(n)*i,offsetY:Math.sin(n)*i}}}class Ue{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyPulse(t,e){const i=Math.sin(e*Math.PI*t.params.frequency);return{scale:1+i*t.params.scaleAmount,glow:1+i*t.params.glowAmount}}applyExpand(t,e){const i=Math.max(t.params.scaleAmount||t.params.scaleTarget||1.5,1),s=Math.sin(e*Math.PI/2);return{scale:1+(i-1)*s,glow:1+Math.abs(t.params.glowAmount||.2)*s}}applyContract(t,e){const i=t.params.scaleAmount||t.params.scaleTarget||.7,s=Math.sin(e*Math.PI/2);return{scale:1+(i-1)*s,glow:1+(t.params.glowAmount||-.2)*s}}applyStretch(t,e){const i=Math.sin(e*Math.PI*t.params.frequency);return{scale:1+((t.params.scaleX+t.params.scaleY)/2-1)*i}}applyMorph(t,e){const i=Math.sin(e*Math.PI*2);return{scale:1+.1*i,rotation:10*i}}}class We{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyNod(t,e){return{offsetY:Math.sin(e*Math.PI*t.params.frequency)*t.params.amplitude*this.scaleFactor}}applyTilt(t,e){t.tiltDirection||(t.tiltDirection=Math.random()<.5?-1:1);const i=t.params.frequency||2,s=(t.params.angle||15)*Math.PI/180,n=Math.sin(e*Math.PI*i)*t.tiltDirection;return{rotation:n*s,scaleX:1+.1*Math.abs(n),scaleY:1-.05*Math.abs(n),offsetX:10*n,offsetY:-5*Math.abs(n)}}applySlowBlink(t,e){let i=1;return i=e<.3?1-e/.3:e<.5?0:e<.8?(e-.5)/.3:1,{glow:i}}applyLook(t,e){if(!t.targetX){const e=t.params.lookDirection,i=50*t.params.lookDistance*this.scaleFactor;switch(e){case"left":t.targetX=-i,t.targetY=0;break;case"right":t.targetX=i,t.targetY=0;break;case"up":t.targetX=0,t.targetY=-i;break;case"down":t.targetX=0,t.targetY=i;break;default:{const e=Math.random()*Math.PI*2;t.targetX=Math.cos(e)*i,t.targetY=Math.sin(e)*i;break}}}let i=e;return i=e<.3?e/.3:e<.7?1:1-(e-.7)/.3,{offsetX:t.targetX*i,offsetY:t.targetY*i}}applySettle(t,e){const i=Math.sin(e*Math.PI*t.params.wobbleFreq)*Math.exp(3*-e)*20*this.scaleFactor;return{offsetY:i,scale:1+.01*i}}}class He{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyPoint(t,e){void 0===t.pointDirection&&(t.pointDirection=Math.random()<.5?-1:1);const i=void 0!==t.params?.direction?t.params.direction:t.pointDirection,s=(t.params?.distance||40)*this.scaleFactor;let n,r;return e<.4?(n=1-Math.pow(1-e/.4,3),r=n):e<.6?(n=1,r=1):(n=Math.pow(1-(e-.6)/.4,3),r=n),{offsetX:i*s*n,offsetY:-Math.abs(.15*s*n),scale:1+.15*r,rotation:5*i*r}}applyLean(t,e){const i=t.params?.angle||15,s=t.params?.side||1,n=Math.sin(e*Math.PI),r=i*s*n;return{offsetX:10*s*this.scaleFactor*n,rotation:r}}applyReach(t,e){const i=void 0!==t.params?.direction?t.params.direction:-Math.PI/2,s=(t.params?.distance||40)*this.scaleFactor;let n;return n=e<.4?e/.4:e<.6?1:1-(e-.6)/.4,n=n*n*(3-2*n),{offsetX:Math.cos(i)*s*n,offsetY:Math.sin(i)*s*n,scale:1+.15*n}}}class Ve{constructor(t){this.renderer=t,this.scaleFactor=t.scaleFactor||1}applyFlashWave(t,e){t.flashWave||(t.flashWave={innerRadius:0,outerRadius:0,maxRadius:3}),t.flashWave.outerRadius=e*t.flashWave.maxRadius,t.flashWave.innerRadius=Math.max(0,(e-.1)*t.flashWave.maxRadius);const i=Math.max(0,1-.7*e);return t.flashWaveData={innerRadius:t.flashWave.innerRadius,outerRadius:t.flashWave.outerRadius,intensity:i},{glow:1+.3*i,flashWave:t.flashWaveData}}applyRain(t,e){const i=t.params?.intensity||1,s=10*e*this.scaleFactor*i,n=5*Math.sin(e*Math.PI*4)*this.scaleFactor;return this.renderer&&this.renderer.particleSystem&&this.renderer.particleSystem.setGestureBehavior("falling",e>0&&e<1),{offsetX:n,offsetY:s,particleEffect:"falling"}}applyGroove(t,e){const i=(t.params?.amplitude||25)*this.scaleFactor;return{offsetX:Math.sin(e*Math.PI*2)*i+Math.sin(e*Math.PI*3+.5)*i*.4,offsetY:Math.sin(e*Math.PI*4+.3)*i*.25,scale:1+.03*Math.sin(e*Math.PI*3+.7),rotation:8*Math.sin(e*Math.PI*2+.2)}}applyHeadBob(t,e){const i=(t.params?.amplitude||20)*this.scaleFactor,s=e*(t.params?.frequency||2)%1;let n;return n=s<.3?s/.3*-i:-i*(1-(s-.3)/.7),{offsetY:n,rotation:s<.3?-3:0}}applyRunningMan(t,e){const i=20*Math.sin(e*Math.PI*4)*this.scaleFactor;return{offsetX:i,offsetY:10*-Math.abs(Math.sin(e*Math.PI*8))*this.scaleFactor,rotation:.3*i,scaleY:1-.05*Math.abs(Math.sin(e*Math.PI*8))}}applyCharleston(t,e){const i=25*Math.sin(e*Math.PI*8)*this.scaleFactor;return{offsetX:i,offsetY:10*-Math.abs(Math.sin(e*Math.PI*8))*this.scaleFactor,rotation:.6*i,scaleY:1-.06*Math.abs(Math.sin(e*Math.PI*8))}}}class Ye{constructor(t){this.renderer=t,this.activeGestures=new Map,this.scaleFactor=t.scaleFactor||1,this.physicalGestureAnimator=new je(t),this.visualEffectAnimator=new Le(t),this.breathGestureAnimator=new Ne(t),this.movementGestureAnimator=new Ge(t),this.shapeTransformAnimator=new Ue(t),this.expressionGestureAnimator=new We(t),this.directionalGestureAnimator=new He(t),this.complexAnimationAnimator=new Ve(t),this.gestureAnimations={bounce:{active:!1,progress:0,params:{}},pulse:{active:!1,progress:0,params:{}},shake:{active:!1,progress:0,params:{}},spin:{active:!1,progress:0,params:{}},nod:{active:!1,progress:0,params:{}},tilt:{active:!1,progress:0,params:{}},expand:{active:!1,progress:0,params:{}},contract:{active:!1,progress:0,params:{}},flash:{active:!1,progress:0,params:{}},drift:{active:!1,progress:0,params:{}},stretch:{active:!1,progress:0,params:{}},glow:{active:!1,progress:0,params:{}},flicker:{active:!1,progress:0,params:{}},vibrate:{active:!1,progress:0,params:{}},orbital:{active:!1,progress:0,params:{}},hula:{active:!1,progress:0,params:{}},wave:{active:!1,progress:0,params:{}},breathe:{active:!1,progress:0,params:{}},morph:{active:!1,progress:0,params:{}},slowBlink:{active:!1,progress:0,params:{}},look:{active:!1,progress:0,params:{}},settle:{active:!1,progress:0,params:{}},breathIn:{active:!1,progress:0,params:{}},breathOut:{active:!1,progress:0,params:{}},breathHold:{active:!1,progress:0,params:{}},breathHoldEmpty:{active:!1,progress:0,params:{}},jump:{active:!1,progress:0,params:{}},sway:{active:!1,progress:0,params:{}},float:{active:!1,progress:0,params:{}},sparkle:{active:!1,progress:0,params:{}},shimmer:{active:!1,progress:0,params:{}},wiggle:{active:!1,progress:0,params:{}},groove:{active:!1,progress:0,params:{}},point:{active:!1,progress:0,params:{}},lean:{active:!1,progress:0,params:{}},reach:{active:!1,progress:0,params:{}},headBob:{active:!1,progress:0,params:{}},orbit:{active:!1,progress:0,params:{}},rain:{active:!1,progress:0,params:{}},runningman:{active:!1,progress:0,params:{}},charleston:{active:!1,progress:0,params:{}}}}startGesture(t){const e=xe(t);if(["bounce","shake","pulse","flash","jump","slam","spin","flicker"].includes(t)&&this.renderer.specialEffects){const e={flash:1,jump:1,shake:.9,bounce:.8,pulse:.7,slam:1,spin:.8,flicker:1}[t]||.8;this.renderer.specialEffects.triggerChromaticAberration(e)}let i;i=this.renderer.gestureCompositor?this.renderer.gestureCompositor.compose(t,this.renderer.state.emotion,this.renderer.currentUndertone):e?.config||{amplitude:20,frequency:2,duration:1e3,scaleAmount:.2,glowAmount:.3,rotations:1,distance:50,angle:15,scaleTarget:1.5,glowPeak:2,scalePeak:1.1,scaleX:1.2,scaleY:.8,maxOpacity:1,minOpacity:.5,lookDirection:"random",lookDistance:1,wobbleFreq:4,squashAmount:.8,stretchAmount:1.2,jumpHeight:100,decay:!0,easing:"sine",effects:[]};let s=1e3;if(e&&e.config)if(e.config.musicalDuration)s=qe.toMilliseconds(e.config.musicalDuration);else if(e.config.duration){const{duration:t}=e.config;s=t}const n=this.gestureAnimations[t];n&&(n.active=!0,n.startTime=performance.now(),n.progress=0,n.params=i,n.duration=s,"shake"===t?n.randomAngle=void 0:"drift"===t?(n.startX=void 0,n.startY=void 0,n.currentDriftAngle=void 0):"tilt"===t?n.tiltDirection=void 0:"vibrate"===t&&(n.vibrateAngles=void 0))}applyGestureAnimations(){const t=performance.now(),e={offsetX:0,offsetY:0,scale:1,rotation:0,glow:1};for(const[i,s]of Object.entries(this.gestureAnimations)){if(!s.active)continue;const n=t-s.startTime,r=s.duration||(s.params?s.params.duration:1e3);s.progress=Math.min(n/r,1);const o=this.applyEasing(s.progress,s.params.easing);let a={};switch(i){case"bounce":a=this.applyBounce(s,o);break;case"pulse":a=this.applyPulse(s,o);break;case"shake":a=this.applyShake(s,o);break;case"spin":a=this.applySpin(s,o);break;case"nod":a=this.applyNod(s,o);break;case"tilt":a=this.applyTilt(s,o);break;case"expand":a=this.applyExpand(s,o);break;case"contract":a=this.applyContract(s,o);break;case"flash":a=this.applyFlash(s,o);break;case"drift":a=this.applyDrift(s,o);break;case"stretch":a=this.applyStretch(s,o);break;case"glow":a=this.applyGlow(s,o);break;case"flicker":a=this.applyFlicker(s,o);break;case"vibrate":a=this.applyVibrate(s,o);break;case"orbital":a=this.applyOrbital(s,o);break;case"hula":a=this.applyHula(s,o);break;case"wave":a=this.applyWave(s,o);break;case"breathe":a=this.applyBreathe(s,o);break;case"morph":a=this.applyMorph(s,o);break;case"slowBlink":a=this.applySlowBlink(s,o);break;case"look":a=this.applyLook(s,o);break;case"settle":a=this.applySettle(s,o);break;case"breathIn":a=this.applyBreathIn(s,o);break;case"breathOut":a=this.applyBreathOut(s,o);break;case"breathHold":a=this.applyBreathHold(s,o);break;case"breathHoldEmpty":a=this.applyBreathHoldEmpty(s,o);break;case"jump":a=this.applyJump(s,o);break;case"sway":a=this.applySway(s,o);break;case"float":a=this.applyFloat(s,o);break;case"rain":a=this.applyRain(s,o);break;case"runningman":a=this.applyRunningMan(s,o);break;case"charleston":a=this.applyCharleston(s,o);break;case"sparkle":a=this.applySparkle(s,o);break;case"shimmer":a=this.applyShimmer(s,o);break;case"wiggle":a=this.applyWiggle(s,o);break;case"groove":a=this.applyGroove(s,o);break;case"point":a=this.applyPoint(s,o);break;case"lean":a=this.applyLean(s,o);break;case"reach":a=this.applyReach(s,o);break;case"headBob":a=this.applyHeadBob(s,o);break;case"orbit":a=this.applyOrbit(s,o)}e.offsetX+=a.offsetX||0,e.offsetY+=a.offsetY||0,e.scale*=a.scale||1,e.rotation+=a.rotation||0,e.glow=Math.max(e.glow,a.glow||1),a.flashWave&&(e.flashWave=a.flashWave),a.fireflyEffect&&(e.fireflyEffect=a.fireflyEffect,e.particleGlow=a.particleGlow,e.fireflyTime=a.fireflyTime),a.flickerEffect&&(e.flickerEffect=a.flickerEffect,e.particleGlow=a.particleGlow,e.flickerTime=a.flickerTime),a.shimmerEffect&&(e.shimmerEffect=a.shimmerEffect,e.particleGlow=a.particleGlow,e.shimmerTime=a.shimmerTime,e.shimmerWave=a.shimmerWave),a.glowEffect&&(e.glowEffect=a.glowEffect,e.particleGlow=a.particleGlow,e.glowTime=a.glowTime,e.glowProgress=a.glowProgress,e.glowEnvelope=a.glowEnvelope),s.progress>=1&&(s.active=!1,s.progress=0,s.startTime=0,"flash"===i&&(s.flashWave=null,s.flashWaveData=null),a.glowEffect&&(a.glowEffect=null,a.particleGlow=null,a.glowTime=null,a.glowProgress=null,a.glowEnvelope=null),a.fireflyEffect&&(a.fireflyEffect=null,a.particleGlow=null,a.fireflyTime=null),a.flickerEffect&&(a.flickerEffect=null,a.particleGlow=null,a.flickerTime=null),a.shimmerEffect&&(a.shimmerEffect=null,a.particleGlow=null,a.shimmerTime=null,a.shimmerWave=null))}return e}update(t){return this.applyGestureAnimations()}stopAllGestures(){Object.keys(this.gestureAnimations).forEach(t=>{const e=this.gestureAnimations[t];e.active=!1,e.startTime=0,e.progress=0,e.params=null,e.glowEffect&&(e.glowEffect=null,e.particleGlow=null,e.glowTime=null,e.glowProgress=null,e.glowEnvelope=null),e.fireflyEffect&&(e.fireflyEffect=null,e.particleGlow=null,e.fireflyTime=null),e.flickerEffect&&(e.flickerEffect=null,e.particleGlow=null,e.flickerTime=null),e.shimmerEffect&&(e.shimmerEffect=null,e.particleGlow=null,e.shimmerTime=null,e.shimmerWave=null),e.flashWave&&(e.flashWave=null,e.flashWaveData=null)}),this.activeGestures.clear()}getCurrentGesture(){const t=["orbital","hula","wave","spin"];for(const e of t){const t=this.gestureAnimations[e];if(t&&t.active){const i=xe(e);return{name:e,particleMotion:i?.config?.particleMotion||{type:e,strength:t.params?.strength||1},progress:t.progress||0,params:t.params}}}for(const[t,e]of Object.entries(this.gestureAnimations))if(e.active){const i=xe(t),s={name:t,particleMotion:i?.config?.particleMotion||e.params?.particleMotion||{type:t,strength:e.params?.strength||1},progress:e.progress||0,params:e.params};return"breathe"===t&&void 0!==e.breathPhase&&(s.breathPhase=e.breathPhase),s}return null}applyEasing(t,e){switch(e){case"linear":default:return t;case"quad":return t*t;case"cubic":return t*t*t;case"sine":return Math.sin(t*Math.PI/2);case"back":return t*t*(2.7*t-1.7)}}applyBounce(t,e){return this.physicalGestureAnimator.applyBounce(t,e)}applyPulse(t,e){return this.shapeTransformAnimator.applyPulse(t,e)}applyShake(t,e){return this.physicalGestureAnimator.applyShake(t,e)}applySpin(t,e){return this.movementGestureAnimator.applySpin(t,e)}applyNod(t,e){return this.expressionGestureAnimator.applyNod(t,e)}applyTilt(t,e){return this.expressionGestureAnimator.applyTilt(t,e)}applyExpand(t,e){return this.shapeTransformAnimator.applyExpand(t,e)}applyContract(t,e){return this.shapeTransformAnimator.applyContract(t,e)}applyFlash(t,e){return this.visualEffectAnimator.applyFlash(t,e)}applyDrift(t,e){return this.movementGestureAnimator.applyDrift(t,e)}applyStretch(t,e){return this.shapeTransformAnimator.applyStretch(t,e)}applyGlow(t,e){return this.visualEffectAnimator.applyGlow(t,e)}applyFlashWave(t,e){return this.complexAnimationAnimator.applyFlashWave(t,e)}applyFlicker(t,e){return this.visualEffectAnimator.applyFlicker(t,e)}applyVibrate(t,e){return this.physicalGestureAnimator.applyVibrate(t,e)}applyWave(t,e){return this.movementGestureAnimator.applyWave(t,e)}applyBreathe(t,e){return this.breathGestureAnimator.applyBreathe(t,e)}applyMorph(t,e){return this.shapeTransformAnimator.applyMorph(t,e)}applySlowBlink(t,e){return this.expressionGestureAnimator.applySlowBlink(t,e)}applyLook(t,e){return this.expressionGestureAnimator.applyLook(t,e)}applySettle(t,e){return this.expressionGestureAnimator.applySettle(t,e)}applyBreathIn(t,e){return this.breathGestureAnimator.applyBreathIn(t,e)}applyBreathOut(t,e){return this.breathGestureAnimator.applyBreathOut(t,e)}applyBreathHold(t,e){return this.breathGestureAnimator.applyBreathHold(t,e)}applyBreathHoldEmpty(t,e){return this.breathGestureAnimator.applyBreathHoldEmpty(t,e)}applyJump(t,e){return this.physicalGestureAnimator.applyJump(t,e)}applySway(t,e){return this.movementGestureAnimator.applySway(t,e)}applyRain(t,e){return this.complexAnimationAnimator.applyRain(t,e)}applyFloat(t,e){return this.movementGestureAnimator.applyFloat(t,e)}applyOrbital(t,e){return this.movementGestureAnimator.applyOrbital(t,e)}applyHula(t,e){return this.movementGestureAnimator.applyHula(t,e)}applySparkle(t,e){return this.visualEffectAnimator.applySparkle(t,e)}applyShimmer(t,e){return this.visualEffectAnimator.applyShimmer(t,e)}applyWiggle(t,e){return this.physicalGestureAnimator.applyWiggle(t,e)}applyGroove(t,e){return this.complexAnimationAnimator.applyGroove(t,e)}applyPoint(t,e){return this.directionalGestureAnimator.applyPoint(t,e)}applyLean(t,e){return this.directionalGestureAnimator.applyLean(t,e)}applyReach(t,e){return this.directionalGestureAnimator.applyReach(t,e)}applyHeadBob(t,e){return this.complexAnimationAnimator.applyHeadBob(t,e)}applyOrbit(t,e){return this.movementGestureAnimator.applyOrbit(t,e)}startBounce(){this.startGesture("bounce")}startPulse(){this.startGesture("pulse")}startShake(){this.startGesture("shake")}startSpin(){this.startGesture("spin")}startNod(){this.startGesture("nod")}startTilt(){this.startGesture("tilt")}startExpand(){this.startGesture("expand")}startContract(){this.startGesture("contract")}startFlash(){this.startGesture("flash")}startDrift(){this.startGesture("drift")}startStretch(){this.startGesture("stretch")}startGlow(){this.startGesture("glow")}startFlicker(){this.startGesture("flicker")}startVibrate(){this.startGesture("vibrate")}startOrbital(){this.startGesture("orbital")}startHula(){this.startGesture("hula")}startWave(){this.startGesture("wave")}startBreathe(){this.startGesture("breathe")}startMorph(){this.startGesture("morph")}startSlowBlink(){this.startGesture("slowBlink")}startLook(){this.startGesture("look")}startSettle(){this.startGesture("settle")}startBreathIn(){this.startGesture("breathIn")}startBreathOut(){this.startGesture("breathOut")}startBreathHold(){this.startGesture("breathHold")}startBreathHoldEmpty(){this.startGesture("breathHoldEmpty")}startJump(){this.startGesture("jump")}startSway(){this.startGesture("sway")}startFloat(){this.startGesture("float")}startRain(){this.startGesture("rain")}startRunningMan(){this.startGesture("runningman")}startCharleston(){this.startGesture("charleston")}startSparkle(){this.startGesture("sparkle")}startShimmer(){this.startGesture("shimmer")}startWiggle(){this.startGesture("wiggle")}startGroove(){this.startGesture("groove")}startPoint(){this.startGesture("point")}startLean(){this.startGesture("lean")}startReach(){this.startGesture("reach")}startHeadBob(){this.startGesture("headBob")}startOrbit(){this.startGesture("orbit")}applyRunningMan(t,e){return this.complexAnimationAnimator.applyRunningMan(t,e)}applyCharleston(t,e){return this.complexAnimationAnimator.applyCharleston(t,e)}startRunningManGesture(){this.startGesture("runningman")}startCharlestonGesture(){this.startGesture("charleston")}pauseCurrentAnimation(){const t=performance.now();for(const[,e]of Object.entries(this.gestureAnimations))e.active&&(e.pausedAt=t,e.pausedProgress=e.progress);this.isPaused=!0}resumeAnimation(){if(!this.isPaused)return;const t=performance.now();for(const[,e]of Object.entries(this.gestureAnimations))if(e.active&&e.pausedAt){const i=t-e.pausedAt;e.startTime&&(e.startTime+=i),delete e.pausedAt,delete e.pausedProgress}this.isPaused=!1}reset(){for(const[,t]of Object.entries(this.gestureAnimations))t.active=!1,t.progress=0,t.params={},delete t.startTime,delete t.pausedAt,delete t.pausedProgress;this.activeGestures.clear(),this.isPaused=!1}}class Xe{constructor(){this.colorTransition=null}applyUndertoneModifiers(t,e){return e}applyUndertoneToColor(t,e){if(e&&"object"==typeof e&&void 0!==e.weight){const{weight:i}=e,s=e.type||"clear";if("clear"===s||0===i)return t;const n=this.applyUndertoneSaturation(t,s),r=this.hexToRgb(t),o=this.hexToRgb(n),a=Math.round(r.r+(o.r-r.r)*i),h=Math.round(r.g+(o.g-r.g)*i),c=Math.round(r.b+(o.b-r.b)*i);return this.rgbToHex(a,h,c)}return e&&"clear"!==e?this.applyUndertoneSaturation(t,e):t}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}rgbToHsl(t,e,i){t/=255,e/=255,i/=255;const s=Math.max(t,e,i),n=Math.min(t,e,i),r=(s+n)/2;let o,a;if(s===n)o=a=0;else{const h=s-n;switch(a=r>.5?h/(2-s-n):h/(s+n),s){case t:o=((e-i)/h+(e<i?6:0))/6;break;case e:o=((i-t)/h+2)/6;break;case i:o=((t-e)/h+4)/6}}return{h:360*o,s:100*a,l:100*r}}hslToHex(t,e,i){let s,n,r;if(t/=360,i/=100,0==(e/=100))s=n=r=i;else{const o=(t,e,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t),a=i<.5?i*(1+e):i+e-i*e,h=2*i-a;s=o(h,a,t+1/3),n=o(h,a,t),r=o(h,a,t-1/3)}const o=t=>{const e=Math.round(255*t).toString(16);return 1===e.length?`0${e}`:e};return`#${o(s)}${o(n)}${o(r)}`}applyUndertoneSaturation(t,e){const i=this.hexToRgb(t),s=this.rgbToHsl(i.r,i.g,i.b),n={intense:1.5,confident:1.3,energetic:1.2,upbeat:1.2,nervous:1.15,mellow:.8,tired:.8,subdued:.5}[e]||1;return s.s=Math.min(100,s.s*n),this.hslToHex(s.h,s.s,s.l)}rgbToHex(t,e,i){const s=t=>{const e=Math.round(t).toString(16);return 1===e.length?`0${e}`:e};return`#${s(t)}${s(e)}${s(i)}`}startColorTransition(t,e,i=1500){this.currentColor===t&&this.currentIntensity===e||(this.colorTransition={active:!0,fromColor:this.currentColor||"#ffffff",toColor:t,fromIntensity:this.currentIntensity||1,toIntensity:e,progress:0,startTime:performance.now(),duration:i})}updateColorTransition(t){if(!this.colorTransition||!this.colorTransition.active)return null;const e=performance.now()-this.colorTransition.startTime,i=Math.min(e/this.colorTransition.duration,1),s=1-Math.pow(1-i,2),n=this.hexToRgb(this.colorTransition.fromColor),r=this.hexToRgb(this.colorTransition.toColor),o=Math.round(n.r+(r.r-n.r)*s),a=Math.round(n.g+(r.g-n.g)*s),h=Math.round(n.b+(r.b-n.b)*s),c=this.rgbToHex(o,a,h),u=this.colorTransition.fromIntensity+(this.colorTransition.toIntensity-this.colorTransition.fromIntensity)*s;return this.currentColor=c,this.currentIntensity=u,i>=1&&(this.colorTransition.active=!1),{color:c,intensity:u}}}class Je{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvasManager?.canvas||t.canvas,this.recordingActive=!1,this.sleepMode=!1,this.speakingActive=!1,this.zenModeActive=!1,this.speakingRings=[],this.ringSpawnTimer=0,this.ringSpawnInterval=300,this.maxRings=3,this.sleepZ=[],this.sparkles=[],this.chromaticAberration={active:!1,intensity:0,targetIntensity:0,fadeSpeed:.01,maxOffset:30},this.scaleValue=e=>t.scaleValue(e),this.hexToRgba=(e,i)=>t.hexToRgba(e,i)}renderRecordingGlow(t,e,i,s){const{ctx:n}=this,r=2.5*i,o=n.createRadialGradient(t,e,0,t,e,r);o.addColorStop(0,`rgba(255, 0, 0, ${.3*s})`),o.addColorStop(.5,`rgba(255, 0, 0, ${.15*s})`),o.addColorStop(1,"rgba(255, 0, 0, 0)"),n.save(),n.globalCompositeOperation="screen",n.fillStyle=o,n.fillRect(t-r,e-r,2*r,2*r),n.restore()}renderRecordingIndicator(t,e){const i=Date.now()/1e3,s=.8+.2*Math.sin(2*i);this.ctx.save(),this.ctx.translate(t,e),this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=`rgba(255, 0, 0, ${.8*s})`;const n=this.scaleValue(80);this.ctx.font=`italic 900 ${n}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 0, 0, ${s})`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("REC",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic 900 ${n-1}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*s})`,this.ctx.fillText("REC",-.5,-.5),this.ctx.restore()}renderSleepIndicator(t,e,i){if(this.ringSpawnTimer+=i,this.ringSpawnTimer>=2e3&&this.sleepZ.length<3){const i=["300","500","700","900"],s=i[Math.floor(Math.random()*i.length)],n=Math.random()>.5?"Z":"z";this.sleepZ.push({x:t+Math.random()*this.scaleValue(30)-this.scaleValue(15),y:e+this.scaleValue(80),size:this.scaleValue(3*(24+8*Math.random())),opacity:1,speed:-.025,drift:Math.random()*this.scaleValue(20)-this.scaleValue(10),lifetime:0,rotation:30*Math.random()-15,text:n,weight:s}),this.ringSpawnTimer=0}this.sleepZ=this.sleepZ.filter(t=>{if(t.lifetime+=i,t.y+=t.speed*i,t.x+=Math.sin(8e-4*t.lifetime)*t.drift*.008,t.rotation+=.01*i,t.lifetime<2e3?t.opacity=1:t.lifetime<4e3?t.opacity=1-(t.lifetime-2e3)/2e3:t.opacity=0,t.opacity>.01){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation*Math.PI/180);const e=this.renderer.state.glowColor||"#4a90e2";this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=this.hexToRgba(e,.5*t.opacity);const i=this.ctx.createLinearGradient(-t.size/2,-t.size/2,t.size/2,t.size/2);return i.addColorStop(0,this.hexToRgba(e,t.opacity)),i.addColorStop(.5,this.hexToRgba("#ffffff",.9*t.opacity)),i.addColorStop(1,this.hexToRgba(e,.7*t.opacity)),this.ctx.font=`italic ${t.weight||"900"} ${t.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=i,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.text||"Z",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic ${t.weight||"900"} ${.9*t.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=this.hexToRgba("#ffffff",.3*t.opacity),this.ctx.fillText(t.text||"Z",-1,-1),this.ctx.restore(),!0}return!1})}renderSpeakingRings(t,e,i,s){this.ringSpawnTimer+=s,this.ringSpawnTimer>=this.ringSpawnInterval&&this.speakingRings.length<this.maxRings&&(this.speakingRings.push({radius:i,opacity:.8,speed:.15}),this.ringSpawnTimer=0),this.speakingRings=this.speakingRings.filter(n=>(n.radius+=n.speed*s,n.opacity=Math.max(0,.8*(1-(n.radius-i)/(2*i))),n.opacity>.01&&(this.ctx.strokeStyle=this.hexToRgba(this.renderer.state.glowColor,n.opacity),this.ctx.lineWidth=this.scaleValue(2),this.ctx.beginPath(),this.ctx.arc(t,e,n.radius,0,2*Math.PI),this.ctx.stroke(),!0)))}renderZenCore(t,e,i,s){const{ctx:n}=this,r=i*(.9+.1*(.5*Math.sin(.001*s)+.5)),o=n.createRadialGradient(t,e,0,t,e,r);o.addColorStop(0,"rgba(147, 112, 219, 0.8)"),o.addColorStop(.7,"rgba(147, 112, 219, 0.3)"),o.addColorStop(1,"rgba(147, 112, 219, 0)"),n.save(),n.globalCompositeOperation="screen",n.fillStyle=o,n.beginPath(),n.arc(t,e,1.5*r,0,2*Math.PI),n.fill(),n.restore()}startRecording(){this.recordingActive=!0}stopRecording(){this.recordingActive=!1}enterSleepMode(){this.sleepMode=!0}wakeUp(){this.sleepMode=!1}startSpeaking(){this.speakingActive=!0}stopSpeaking(){this.speakingActive=!1}createSparkle(t,e,i={}){this.sparkles.push({x:t,y:e,vx:i.velocity?.x||0,vy:i.velocity?.y||0,size:i.size||3,color:i.color||"hsl(50, 100%, 70%)",lifetime:i.lifetime||1e3,maxLifetime:i.lifetime||1e3,rotation:Math.random()*Math.PI*2,rotationSpeed:.2*(Math.random()-.5)})}renderSparkles(){const{ctx:t}=this;this.sparkles.forEach(e=>{const i=1-e.lifetime/e.maxLifetime,s=1-i;t.save(),t.translate(e.x,e.y),t.rotate(e.rotation);const n=this.scaleValue(e.size*(1-.5*i));t.beginPath();const r=n,o=.38*n;for(let e=0;e<10;e++){const i=e*Math.PI/5-Math.PI/2,s=e%2==0?r:o;0===e?t.moveTo(Math.cos(i)*s,Math.sin(i)*s):t.lineTo(Math.cos(i)*s,Math.sin(i)*s)}t.closePath(),t.shadowBlur=this.scaleValue(10),t.shadowColor=e.color,t.fillStyle=e.color.replace("70%",70+30*i+"%").replace(")",`, ${s})`).replace("hsl","hsla"),t.fill(),t.restore()})}triggerChromaticAberration(t=.8){this.chromaticAberration.active=!0,this.chromaticAberration.targetIntensity=Math.min(1,t),this.chromaticAberration.intensity=this.chromaticAberration.targetIntensity;const e=document.getElementById("emotive-canvas")||document.querySelector("canvas")||this.canvas;if(e){if(e.style.animation="none",!document.getElementById("chromatic-styles")){const t=document.createElement("style");t.id="chromatic-styles",t.textContent="\n                    @keyframes chromaticGlitch {\n                        0% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                        15% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.7)) drop-shadow(2px 0 0 rgba(0,255,255,0.7));\n                            transform: translateX(-0.5px);\n                        }\n                        30% {\n                            filter: drop-shadow(-3px 0 0 rgba(255,0,0,0.8)) drop-shadow(3px 0 0 rgba(0,255,255,0.8));\n                            transform: translateX(0.5px);\n                        }\n                        45% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.6)) drop-shadow(2px 0 0 rgba(0,255,255,0.6));\n                            transform: translateX(-0.3px);\n                        }\n                        60% {\n                            filter: drop-shadow(-1px 0 0 rgba(255,0,0,0.4)) drop-shadow(1px 0 0 rgba(0,255,255,0.4));\n                            transform: translateX(0.2px);\n                        }\n                        100% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                    }\n                ",document.head.appendChild(t)}e.style.animation=`chromaticGlitch ${300+200*t}ms ease-out`}}applyChromaticAberration(t,e){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return;const{intensity:i}=this.chromaticAberration,s=this.scaleValue(this.chromaticAberration.maxOffset*i),n=t.globalCompositeOperation;t.save(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation="source-over",t.filter="url(#red-channel)",t.drawImage(e,-s,0),t.globalCompositeOperation="screen",t.filter="url(#green-channel)",t.drawImage(e,0,0),t.globalCompositeOperation="screen",t.filter="url(#blue-channel)",t.drawImage(e,s,0),t.filter="none",t.globalCompositeOperation=n,t.restore()}applyChromaticAberrationSimple(t,e,i,s,n){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return void n();const{intensity:r}=this.chromaticAberration,o=this.scaleValue(this.chromaticAberration.maxOffset*r);t.save(),t.globalCompositeOperation="source-over",t.translate(-o,0),t.globalAlpha=.33,t.fillStyle="#ff0000",t.filter="brightness(3)",n(),t.translate(o,0),t.globalCompositeOperation="screen",t.globalAlpha=.33,t.fillStyle="#00ff00",n(),t.translate(o,0),t.globalAlpha=.33,t.fillStyle="#0000ff",n(),t.restore()}update(t){this.sparkles=this.sparkles.filter(e=>(e.x+=e.vx,e.y+=e.vy,e.rotation+=e.rotationSpeed,e.lifetime-=t,e.vy+=.1,e.lifetime>0)),this.chromaticAberration.active&&(this.chromaticAberration.intensity-=this.chromaticAberration.fadeSpeed,this.chromaticAberration.intensity<=0&&(this.chromaticAberration.intensity=0,this.chromaticAberration.active=!1,this.chromaticAberration.targetIntensity=0))}destroy(){this.speakingRings=[],this.sleepZ=[],this.sparkles=[],this.recordingActive=!1,this.sleepMode=!1,this.speakingActive=!1,this.zenModeActive=!1,this.chromaticAberration.active=!1,this.chromaticAberration.intensity=0,this.chromaticAberration.targetIntensity=0,this.ringSpawnTimer=0,this.renderer=null,this.ctx=null,this.canvas=null}}class Ke{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.blinking=!1,this.blinkingEnabled=!0,this.blinkTimer=0,this.nextBlinkTime=this.getRandomBlinkTime(),this.squintAmount=0,this.eyeClose=null,this.eyeOpen=null,this.scaleValue=e=>t.scaleValue(e),this.hexToRgba=(e,i)=>t.hexToRgba(e,i)}update(t){this.blinking&&(this.blinkTimer+=t,this.blinkTimer>=150&&(this.blinking=!1,this.blinkTimer=0,this.nextBlinkTime=Date.now()+this.getRandomBlinkTime())),this.blinkingEnabled&&!this.blinking&&Date.now()>=this.nextBlinkTime&&this.startBlink()}startBlink(){this.blinkingEnabled&&(this.blinking=!0,this.blinkTimer=0)}getRandomBlinkTime(){return 3e3+4e3*Math.random()}getBlinkScale(){if(!this.blinking)return 1;const t=Math.min(this.blinkTimer/150,1);return 1-.7*Math.sin(t*Math.PI)}drawEyes(t,e,i,s,n={}){const{ctx:r}=this,o=n.eyeOpenness||1,a=n.eyeExpression||"neutral";if("zen"===s||"neutral"===s||o<=0)return;r.save(),r.strokeStyle="rgba(0, 0, 0, 0.3)",r.lineWidth=this.scaleValue(2),r.lineCap="round";const h=.4*i,c=e-.1*i,u=.25*i;switch(a){case"happy":this.drawHappyEyes(r,t,c,h,u,o);break;case"sad":this.drawSadEyes(r,t,c,h,u,o);break;case"angry":this.drawAngryEyes(r,t,c,h,u,o);break;case"surprised":this.drawSurprisedEyes(r,t,c,h,u,o);break;case"focused":this.drawFocusedEyes(r,t,c,h,u,o);break;case"sleepy":this.drawSleepyEyes(r,t,c,h,u,o);break;case"suspicious":this.drawSuspiciousEyes(r,t,c,h,u,o)}r.restore()}drawHappyEyes(t,e,i,s,n,r){t.beginPath(),t.arc(e-s,i,n,.2*Math.PI,.8*Math.PI,!1),t.stroke(),t.beginPath(),t.arc(e+s,i,n,.2*Math.PI,.8*Math.PI,!1),t.stroke()}drawSadEyes(t,e,i,s,n,r){t.beginPath(),t.arc(e-s,i+.5*n,n,1.2*Math.PI,1.8*Math.PI,!1),t.stroke(),t.beginPath(),t.arc(e+s,i+.5*n,n,1.2*Math.PI,1.8*Math.PI,!1),t.stroke()}drawAngryEyes(t,e,i,s,n,r){t.beginPath(),t.moveTo(e-s-n,i-.3*n),t.lineTo(e-s+.5*n,i+.3*n),t.stroke(),t.beginPath(),t.moveTo(e+s+n,i-.3*n),t.lineTo(e+s-.5*n,i+.3*n),t.stroke()}drawSurprisedEyes(t,e,i,s,n,r){t.beginPath(),t.arc(e-s,i,1.2*n,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(e+s,i,1.2*n,0,2*Math.PI),t.stroke()}drawFocusedEyes(t,e,i,s,n,r){t.fillStyle="rgba(0, 0, 0, 0.4)",t.beginPath(),t.arc(e-s,i,.3*n,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(e+s,i,.3*n,0,2*Math.PI),t.fill()}drawSleepyEyes(t,e,i,s,n,r){t.beginPath(),t.moveTo(e-s-n,i),t.lineTo(e-s+n,i),t.stroke(),t.beginPath(),t.moveTo(e+s-n,i),t.lineTo(e+s+n,i),t.stroke()}drawSuspiciousEyes(t,e,i,s,n,r){t.beginPath(),t.moveTo(e-s-n,i),t.lineTo(e-s+.7*n,i),t.stroke(),t.beginPath(),t.arc(e+s,i,.8*n,.1*Math.PI,.9*Math.PI,!1),t.stroke()}setBlinkingEnabled(t){this.blinkingEnabled=t,t||(this.blinking=!1,this.blinkTimer=0)}setSquintAmount(t){this.squintAmount=Math.max(0,Math.min(1,t))}forceBlink(){this.startBlink()}}class Qe{constructor(t){this.renderer=t,this.breathingSpeed=.42,this.breathingDepth=.08,this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null,this.emotionBreathPatterns={happy:{rate:1.1,depth:1.2},sad:{rate:.8,depth:.7},angry:{rate:1.4,depth:1.3},calm:{rate:.7,depth:.9},excited:{rate:1.5,depth:1.4},focused:{rate:.9,depth:.6},neutral:{rate:1,depth:1},love:{rate:1.2,depth:1.3},surprised:{rate:1.3,depth:1.1},confused:{rate:1.1,depth:.9},amused:{rate:1.2,depth:1.1},bored:{rate:.6,depth:.8},tired:{rate:.5,depth:1.2},anxious:{rate:1.6,depth:.9},determined:{rate:1.1,depth:1},proud:{rate:.9,depth:1.3},content:{rate:.8,depth:1},hopeful:{rate:1,depth:1.1},zen:{rate:.4,depth:1.5},intrigued:{rate:1.1,depth:.8},embarrassed:{rate:1.3,depth:.7},grateful:{rate:.9,depth:1.1},inspired:{rate:1,depth:1.3},silly:{rate:1.4,depth:1.2},sleepy:{rate:.3,depth:1.4}}}update(t,e,i={}){i=i||{};const s=this.emotionBreathPatterns[e]||{rate:1,depth:1},n=i?.breathRateMult||1,r=i?.breathDepthMult||1;this.breathRate=s.rate*this.breathRateMult*n,this.breathDepth=this.breathingDepth*s.depth*this.breathDepthMult*r;let o=this.breathingSpeed*this.breathRate*(t/1e3);this.breathIrregular&&i?.breathIrregular&&(o*=.8+.4*Math.sin(3e-4*Date.now())),this.breathingPhase+=o,this.breathingPhase>2*Math.PI&&(this.breathingPhase-=2*Math.PI)}getBreathingScale(){return null!==this.customScale?this.customScale:1+Math.sin(this.breathingPhase)*this.breathDepth}setCustomScale(t){this.customScale=t}setBreathingSpeed(t){this.breathingSpeed=t}setBreathingDepth(t){this.breathingDepth=Math.max(0,Math.min(1,t))}setBreathRateMultiplier(t){this.breathRateMult=t}setBreathDepthMultiplier(t){this.breathDepthMult=t}setIrregularBreathing(t){this.breathIrregular=t}reset(){this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null}holdBreath(t=!1){this.customScale=t?.92:1.08}releaseBreath(){this.customScale=null}getBreathingInfo(){return{phase:this.breathingPhase,rate:this.breathRate,depth:this.breathDepth,scale:this.getBreathingScale(),isCustom:null!==this.customScale,isIrregular:this.breathIrregular}}}const Ze=new class{constructor(){this.cache=new Map,this.stats={hits:0,misses:0,evictions:0},this.maxSize=100,this.ttl=6e4,this.accessOrder=[]}generateKey(t,e){if("radial"===t){const{x0:t,y0:i,r0:s,x1:n,y1:r,r1:o,stops:a}=e;return`radial:${t},${i},${s},${n},${r},${o}:${a.map(t=>`${t.offset}:${t.color}`).join("|")}`}if("linear"===t){const{x0:t,y0:i,x1:s,y1:n,stops:r}=e;return`linear:${t},${i},${s},${n}:${r.map(t=>`${t.offset}:${t.color}`).join("|")}`}return null}getRadialGradient(t,e,i,s,n,r,o,a){const h=this.generateKey("radial",{x0:e,y0:i,r0:s,x1:n,y1:r,r1:o,stops:a}),c=this.cache.get(h);if(c&&Date.now()-c.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(h),c.gradient;this.stats.misses++;const u=t.createRadialGradient(e,i,s,n,r,o);return a.forEach(t=>{u.addColorStop(t.offset,t.color)}),this.set(h,u),u}getLinearGradient(t,e,i,s,n,r){const o=this.generateKey("linear",{x0:e,y0:i,x1:s,y1:n,stops:r}),a=this.cache.get(o);if(a&&Date.now()-a.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(o),a.gradient;this.stats.misses++;const h=t.createLinearGradient(e,i,s,n);return r.forEach(t=>{h.addColorStop(t.offset,t.color)}),this.set(o,h),h}set(t,e){this.cache.size>=this.maxSize&&!this.cache.has(t)&&this.evictLRU(),this.cache.set(t,{gradient:e,timestamp:Date.now()}),this.updateAccessOrder(t)}updateAccessOrder(t){const e=this.accessOrder.indexOf(t);e>-1&&this.accessOrder.splice(e,1),this.accessOrder.push(t)}evictLRU(){if(this.accessOrder.length>0){const t=this.accessOrder.shift();this.cache.delete(t),this.stats.evictions++}}clear(){this.cache.clear(),this.accessOrder=[]}clearExpired(){const t=Date.now(),e=[];for(const[i,s]of this.cache.entries())t-s.timestamp>=this.ttl&&e.push(i);e.forEach(t=>{this.cache.delete(t);const e=this.accessOrder.indexOf(t);e>-1&&this.accessOrder.splice(e,1)})}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{size:this.cache.size,maxSize:this.maxSize,hits:this.stats.hits,misses:this.stats.misses,evictions:this.stats.evictions,hitRate:`${t}%`}}createHelper(t){return{radial:(e,i,s,n,r,o,a)=>this.getRadialGradient(t,e,i,s,n,r,o,a),linear:(e,i,s,n,r)=>this.getLinearGradient(t,e,i,s,n,r)}}};class ti{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.glowIntensity=1,this.glowColor="#4a90e2",this.targetGlowColor="#4a90e2",this.glowColorTransition=0,this.glowColorTransitionSpeed=.05,this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null,this.cachedGlowRadius=0,this.scaleValue=e=>t.scaleValue(e),this.hexToRgba=(e,i)=>t.hexToRgba(e,i),this.initOffscreenCanvas()}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d")}updateOffscreenSize(t){this.offscreenCanvas.width===t&&this.offscreenCanvas.height===t||(this.offscreenCanvas.width=t,this.offscreenCanvas.height=t,this.cachedGlowColor=null)}renderGlow(t,e,i,s={}){const{ctx:n}=this,r=s.color||this.glowColor,o=void 0!==s.intensity?s.intensity:this.glowIntensity;o<.01||this.renderGlowDirect(n,t,e,i,r,o)}cacheGlowGradient(t,e){const i=this.offscreenCtx,s=e;this.updateOffscreenSize(2*e),i.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);const n=Ze.getRadialGradient(i,s,s,0,s,s,e,[{offset:0,color:this.hexToRgba(t,.4)},{offset:.3,color:this.hexToRgba(t,.2)},{offset:.6,color:this.hexToRgba(t,.1)},{offset:1,color:this.hexToRgba(t,0)}]);i.fillStyle=n,i.fillRect(0,0,2*e,2*e),this.cachedGlowColor=t,this.cachedGlowRadius=e}renderGlowDirect(t,e,i,s,n,r){t.save(),t.globalCompositeOperation="screen";const o=[];for(let t=0;t<=20;t++){const e=t/20,i=.6*Math.pow(1-e,2.2),s=Math.max(0,Math.min(1,i*r));o.push({offset:e,color:this.hexToRgba(n,s)})}const a=Ze.getRadialGradient(t,e,i,0,e,i,s,o);t.fillStyle=a,t.beginPath(),t.arc(e,i,s,0,2*Math.PI),t.fill(),t.restore()}renderRecordingGlow(t,e,i,s){const{ctx:n}=this,r=2.5*i,o=Ze.getRadialGradient(n,t,e,0,t,e,r,[{offset:0,color:`rgba(255, 0, 0, ${.3*s})`},{offset:.5,color:`rgba(255, 0, 0, ${.15*s})`},{offset:1,color:"rgba(255, 0, 0, 0)"}]);n.save(),n.globalCompositeOperation="screen",n.fillStyle=o,n.fillRect(t-r,e-r,2*r,2*r),n.restore()}renderZenGlow(t,e,i,s){const{ctx:n}=this,r=i*(.9+.1*(.5*Math.sin(.001*s)+.5)),o=Ze.getRadialGradient(n,t,e,0,t,e,r,[{offset:0,color:"rgba(147, 112, 219, 0.8)"},{offset:.7,color:"rgba(147, 112, 219, 0.3)"},{offset:1,color:"rgba(147, 112, 219, 0)"}]);n.save(),n.globalCompositeOperation="screen",n.fillStyle=o,n.beginPath(),n.arc(t,e,1.5*r,0,2*Math.PI),n.fill(),n.restore()}updateGlowColor(t,e){this.targetGlowColor!==t&&(this.targetGlowColor=t,this.glowColorTransition=0),this.glowColorTransition<1&&(this.glowColorTransition=Math.min(1,this.glowColorTransition+this.glowColorTransitionSpeed),this.glowColor=this.lerpColor(this.glowColor,this.targetGlowColor,this.glowColorTransition))}lerpColor(t,e,i){const s=this.hexToRgb(t),n=this.hexToRgb(e);return`#${((1<<24)+(Math.round(s.r+(n.r-s.r)*i)<<16)+(Math.round(s.g+(n.g-s.g)*i)<<8)+Math.round(s.b+(n.b-s.b)*i)).toString(16).slice(1)}`}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}}setGlowIntensity(t){this.glowIntensity=Math.max(0,Math.min(1,t))}setGlowColor(t){this.glowColor=t,this.targetGlowColor=t,this.glowColorTransition=1}destroy(){this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null}}class ei{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.coreColor="#FFFFFF",this.coreOpacity=1,this.coreBorderWidth=0,this.coreBorderColor=null,this.shapePoints=null,this.isMorphing=!1,this.scaleValue=e=>t.scaleValue(e),this.hexToRgba=(e,i)=>t.hexToRgba(e,i)}renderCore(t,e,i,s={}){const{ctx:n}=this,r=s.scaleX||1,o=s.scaleY||1,a=s.rotation||0,h=void 0!==s.opacity?s.opacity:this.coreOpacity,c=s.color||this.coreColor,u=s.shapePoints||this.shapePoints;n.save(),n.translate(t,e),0!==a&&n.rotate(a),n.scale(r,o),n.fillStyle=this.hexToRgba(c,h),u&&u.length>0?this.drawMorphedShape(n,u,i):this.drawCircle(n,i),this.coreBorderWidth>0&&this.coreBorderColor&&(n.strokeStyle=this.coreBorderColor,n.lineWidth=this.scaleValue(this.coreBorderWidth),n.stroke()),n.restore()}drawDropShadow(t,e,i){t.save();const s=this.scaleValue(2);if(t.translate(0,s),i&&i.length>32)t.fillStyle="rgba(0, 0, 0, 0.15)",t.beginPath(),t.arc(0,0,1.05*e,0,2*Math.PI),t.fill();else{const s=Ze.getRadialGradient(t,0,0,.7*e,0,0,1.2*e,[{offset:0,color:"rgba(0, 0, 0, 0.2)"},{offset:.8,color:"rgba(0, 0, 0, 0.1)"},{offset:1,color:"rgba(0, 0, 0, 0)"}]);if(t.fillStyle=s,t.beginPath(),i){const e=1.1,s=i.length>20?2:1;t.moveTo(i[0].x*e,i[0].y*e);for(let n=s;n<i.length;n+=s)t.lineTo(i[n].x*e,i[n].y*e);t.closePath()}else t.arc(0,0,1.1*e,0,2*Math.PI);t.fill()}t.restore()}drawCircle(t,e){t.beginPath(),t.arc(0,0,e,0,2*Math.PI),t.fill()}drawMorphedShape(t,e,i){!e||e.length<3?this.drawCircle(t,i):(t.beginPath(),e.forEach((e,i)=>{0===i?t.moveTo(e.x,e.y):t.lineTo(e.x,e.y)}),t.closePath(),t.fill())}renderZenCore(t,e,i,s){const{ctx:n}=this,r=i*(.95+.05*(.5*Math.sin(.001*s)+.5));n.save(),n.shadowBlur=this.scaleValue(10),n.shadowColor="rgba(147, 112, 219, 0.3)",n.shadowOffsetX=0,n.shadowOffsetY=0,n.fillStyle="#FFFFFF",n.beginPath(),n.arc(t,e,r,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(147, 112, 219, 0.2)",n.lineWidth=this.scaleValue(1),n.beginPath(),n.arc(t,e,.9*r,0,2*Math.PI),n.stroke(),n.restore()}renderSleepyCore(t,e,i){const{ctx:s}=this;s.save(),s.translate(t,e),s.scale(1,.85),s.fillStyle="#FFFFFF",s.beginPath(),s.arc(0,0,i,0,2*Math.PI),s.fill(),s.restore()}renderGlitchedCore(t,e,i,s){const{ctx:n}=this;n.save(),[{x:-2,y:0,alpha:.3},{x:2,y:0,alpha:.3},{x:0,y:-1,alpha:.2}].forEach(r=>{n.fillStyle=this.hexToRgba("#FFFFFF",r.alpha*s),n.beginPath(),n.arc(t+r.x*s*this.scaleValue(5),e+r.y*s*this.scaleValue(5),i,0,2*Math.PI),n.fill()}),n.fillStyle="#FFFFFF",n.beginPath(),n.arc(t,e,i,0,2*Math.PI),n.fill(),n.restore()}setShapePoints(t){this.shapePoints=t,this.isMorphing=t&&t.length>0}clearShapePoints(){this.shapePoints=null,this.isMorphing=!1}setCoreColor(t){this.coreColor=t}setCoreOpacity(t){this.coreOpacity=Math.max(0,Math.min(1,t))}setCoreBorder(t,e){this.coreBorderWidth=t,this.coreBorderColor=e}getCoreInfo(){return{color:this.coreColor,opacity:this.coreOpacity,hasBorder:this.coreBorderWidth>0,isMorphing:this.isMorphing,shapePointCount:this.shapePoints?this.shapePoints.length:0}}}class ii{renderSunEffects(t,e,i,s,n){const r=Date.now()/100;if(t.save(),t.translate(e,i),n.texture&&(void 0===n.textureOpacity||n.textureOpacity>0)){t.save(),t.globalCompositeOperation="screen",t.globalAlpha=void 0!==n.textureOpacity?n.textureOpacity:1;const e=.05*r*(n.turbulence||.3)/.3,i=t.createRadialGradient(Math.sin(e)*s*.15,Math.cos(.7*e)*s*.15,.2*s,0,0,s);i.addColorStop(0,"rgba(255, 255, 200, 0)"),i.addColorStop(.4,"rgba(255, 200, 100, 0.1)"),i.addColorStop(.7,"rgba(255, 150, 50, 0.08)"),i.addColorStop(1,"rgba(255, 100, 30, 0.05)"),t.fillStyle=i,t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.fill(),t.restore()}const o=void 0!==n.coronaOpacity?n.coronaOpacity:1;if(o>0){t.save(),t.globalCompositeOperation="screen";const e=t.createRadialGradient(0,0,.5*s,0,0,1.1*s);e.addColorStop(0,`rgba(255, 255, 255, ${.8*o})`),e.addColorStop(.3,`rgba(255, 250, 200, ${.6*o})`),e.addColorStop(.5,`rgba(255, 200, 100, ${.4*o})`),e.addColorStop(.7,`rgba(255, 150, 50, ${.2*o})`),e.addColorStop(1,"rgba(255, 100, 20, 0)"),t.fillStyle=e,t.beginPath(),t.arc(0,0,1.1*s,0,2*Math.PI),t.fill();for(let e=0;e<2;e++){const i=1.3+.4*e,n=(.35-.15*e)*o,a=.05*Math.sin(.1*r+e),h=t.createRadialGradient(0,0,s*(.9+a),0,0,s*(i+a));h.addColorStop(0,"rgba(255, 255, 200, 0)"),h.addColorStop(.4,`rgba(255, 200, 100, ${.5*n})`),h.addColorStop(.7,`rgba(255, 150, 50, ${n})`),h.addColorStop(.9,`rgba(255, 100, 30, ${.5*n})`),h.addColorStop(1,"rgba(255, 50, 10, 0)"),t.fillStyle=h,t.beginPath(),t.arc(0,0,s*(i+a),0,2*Math.PI),t.fill()}t.restore()}if(n.flares){t.save();const e=Math.sin(.08*r),i=Math.sin(.12*r),n=Math.sin(.16*r),o=t.createLinearGradient(0,-s,0,3*-s);o.addColorStop(0,"rgba(255, 255, 230, 0.4)"),o.addColorStop(.2,"rgba(255, 220, 150, 0.25)"),o.addColorStop(.5,"rgba(255, 180, 80, 0.15)"),o.addColorStop(.8,"rgba(255, 120, 40, 0.08)"),o.addColorStop(1,"rgba(255, 60, 20, 0)"),t.fillStyle=o,t.globalCompositeOperation="screen",t.beginPath();const a=(e,i,n,r)=>{const o=Math.cos(e),a=Math.sin(e),h=o*s,c=a*s,u=o*(s+i),l=a*(s+i),d=-a*n*.5,p=o*n*.5,f=r*n*.3;t.moveTo(h-d,c-p),t.quadraticCurveTo(.5*(h+u)+d*f,.5*(c+l)+p*f,u,l),t.quadraticCurveTo(.5*(h+u)-d*f,.5*(c+l)-p*f,h+d,c+p)};for(let t=0;t<8;t++)a(t/8*Math.PI*2+.1*e,s*(1.8+.4*Math.sin(.1*r+.5*t)),.18*s,Math.sin(.15*r+t));for(let t=0;t<12;t++)a((t+.5)/12*Math.PI*2+.08*i,s*(1.2+.3*Math.sin(.13*r+.7*t)),.12*s,Math.sin(.18*r+1.2*t));for(let t=0;t<15;t++)a(t/15*Math.PI*2+.05*n,s*(.7+.25*Math.sin(.17*r+.9*t)),.08*s,Math.sin(.2*r+1.5*t));for(let e=0;e<15;e++){const i=(e+.25)/15*Math.PI*2,n=s*(.4+.2*Math.sin(.22*r+e)),o=.06*s,a=Math.cos(i),h=Math.sin(i),c=a*s,u=h*s,l=a*(s+n),d=h*(s+n),p=-h*o*.5,f=a*o*.5;t.moveTo(c-p,u-f),t.lineTo(l,d),t.lineTo(c+p,u+f)}t.fill(),t.restore()}const a=t.createRadialGradient(0,0,.95*s,0,0,1.05*s);a.addColorStop(0,"rgba(255, 255, 255, 0)"),a.addColorStop(.7,"rgba(255, 255, 200, 0.2)"),a.addColorStop(.9,"rgba(255, 200, 100, 0.5)"),a.addColorStop(1,"rgba(255, 150, 50, 0.3)"),t.fillStyle=a,t.beginPath(),t.arc(0,0,1.05*s,0,2*Math.PI),t.fill(),t.restore()}renderBaileysBeads(t,e,i,s,n,r,o,a,h,c=t=>t){if(!h)return void(this.S=null);const u=Math.abs(n)<1&&Math.abs(r)<1,l=a?30:15;if(!(Math.abs(n)<l&&Math.abs(r)<l||u))return void(this.S=null);if(!this.S){const t=Math.floor(4*Math.random())+1;this.k=[];const e=[];for(let i=0;i<t;i++)e.push(Math.random()*Math.PI*2);const i=Array.from({length:t},(t,e)=>e);for(let t=i.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[i[t],i[e]]=[i[e],i[t]]}for(let s=0;s<t;s++)this.k.push({angle:e[s],size:3+5*Math.random(),order:i[s],delay:200*i[s]});this.S=Date.now()}const d=Date.now()-this.S;(this.k||[]).forEach(n=>{if(d<n.delay)return;const r=d-n.delay,o=Math.min(1,r/300),a=e+Math.cos(n.angle)*s,h=i+Math.sin(n.angle)*s;t.save(),t.translate(a,h),t.globalAlpha=o;const u=c(n.size),l=[{color:`rgba(255, 100, 100, ${.6*o})`,offset:-2},{color:`rgba(100, 255, 100, ${.6*o})`,offset:0},{color:`rgba(100, 100, 255, ${.6*o})`,offset:2}];t.globalCompositeOperation="screen",l.forEach(({color:e,offset:i})=>{const s=t.createRadialGradient(i,i,0,i,i,2*u);s.addColorStop(0,e),s.addColorStop(.2,e.replace(""+.6*o,""+.4*o)),s.addColorStop(.5,e.replace(""+.6*o,""+.2*o)),s.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=s,t.beginPath(),t.arc(i,i,2*u,0,2*Math.PI),t.fill()}),t.globalCompositeOperation="lighter";const p=t.createRadialGradient(0,0,0,0,0,u);p.addColorStop(0,`rgba(255, 255, 255, ${o})`),p.addColorStop(.3,`rgba(255, 255, 255, ${.5*o})`),p.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=p,t.beginPath(),t.arc(0,0,u,0,2*Math.PI),t.fill(),t.restore()})}renderMoonShadow(t,e,i,s,n,r,o=!1,a=0,h=null){if(t.save(),t.globalAlpha=1,t.translate(e,i),"crescent"===n.type){let e=1,i=n.offset||.7;if(h){const t=h.getProgress(),{targetShape:s}=h;"moon"===s&&void 0!==t&&t<1&&!n.shadowX&&(e=t,i=2.7*e-2)}const o=(n.angle||-30)*Math.PI/180,a=Math.cos(o)*s*i,c=Math.sin(o)*s*i;if(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.beginPath(),r&&r.length>0){t.moveTo(r[0].x,r[0].y);for(let e=1;e<r.length;e++)t.lineTo(r[e].x,r[e].y);t.closePath()}else t.arc(0,0,s,0,2*Math.PI);t.clip();const u=t.createRadialGradient(a,c,.9*s,a,c,1.1*s),l=void 0!==n.coverage?n.coverage:.85,d=Math.min(1,1.2*e)*(l/.85);u.addColorStop(0,`rgba(0, 0, 0, ${1*d})`),u.addColorStop(.8,`rgba(0, 0, 0, ${1*d})`),u.addColorStop(.88,`rgba(0, 0, 0, ${.98*d})`),u.addColorStop(.91,`rgba(0, 0, 0, ${.95*d})`),u.addColorStop(.93,`rgba(0, 0, 0, ${.9*d})`),u.addColorStop(.95,`rgba(0, 0, 0, ${.8*d})`),u.addColorStop(.96,`rgba(0, 0, 0, ${.65*d})`),u.addColorStop(.97,`rgba(0, 0, 0, ${.45*d})`),u.addColorStop(.98,`rgba(0, 0, 0, ${.25*d})`),u.addColorStop(.99,`rgba(0, 0, 0, ${.1*d})`),u.addColorStop(1,"rgba(0, 0, 0, 0)"),t.fillStyle=u,t.beginPath(),t.arc(a,c,1.1*s,0,2*Math.PI),t.fill()}else if("lunar"===n.type){const e=1-(void 0!==n.diffusion?n.diffusion:1);let i=0,r=0;if(h){const t=h.getProgress(),{currentShape:e,targetShape:n}=h;if(o&&"solar"===n&&void 0!==t&&t<1){const e=2.5*s;i=-e*(1-t),r=e*(1-t)}else if(o&&"solar"===e&&"solar"!==n&&null!==n&&void 0!==t&&t<1){const e=2.5*s;i=e*t,r=-e*t}}t.translate(i,r),o?(t.save(),t.beginPath(),t.arc(-i,-r,s,0,2*Math.PI),t.clip()):(t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.clip());const a=s*(1.8-.5*e),c=t.createRadialGradient(0,0,.2*s,0,0,a),u=n.coverage||.9;if(n.color&&n.color.includes("0, 0, 0")?(c.addColorStop(0,`rgba(0, 0, 0, ${u})`),c.addColorStop(.3+.2*e,`rgba(0, 0, 0, ${.95*u})`),c.addColorStop(.6+.2*e,`rgba(0, 0, 0, ${.8*u})`),c.addColorStop(.85,`rgba(0, 0, 0, ${.4*u})`),c.addColorStop(1,"rgba(0, 0, 0, 0)")):(c.addColorStop(0,`rgba(10, 2, 0, ${u})`),c.addColorStop(.3+.2*e,`rgba(20, 5, 0, ${.95*u})`),c.addColorStop(.6+.2*e,`rgba(40, 10, 5, ${.8*u})`),c.addColorStop(.85,`rgba(60, 15, 10, ${.4*u})`),c.addColorStop(1,"rgba(80, 20, 15, 0)")),t.fillStyle=c,t.beginPath(),t.arc(0,0,a,0,2*Math.PI),t.fill(),e>.3){const i=s*(.8+.3*e),r=t.createRadialGradient(0,0,0,0,0,i);n.color&&n.color.includes("0, 0, 0")?(r.addColorStop(0,`rgba(0, 0, 0, ${u})`),r.addColorStop(.5,`rgba(0, 0, 0, ${.9*u})`),r.addColorStop(.8,`rgba(0, 0, 0, ${.5*u})`),r.addColorStop(1,"rgba(0, 0, 0, 0)")):(r.addColorStop(0,`rgba(0, 0, 0, ${u})`),r.addColorStop(.5,`rgba(10, 2, 0, ${.9*u})`),r.addColorStop(.8,`rgba(20, 5, 0, ${.5*u})`),r.addColorStop(1,"rgba(30, 8, 5, 0)")),t.fillStyle=r,t.beginPath(),t.arc(0,0,i,0,2*Math.PI),t.fill()}}o&&t.restore(),t.restore()}}class si{renderZenCore(t,e,i,s,n,r,o,a){t.save(),n.shakeOffset&&(e+=n.shakeOffset),n.driftY&&(i+=n.driftY),t.translate(e,i),o&&void 0!==o.rotation&&t.rotate(o.rotation*Math.PI/180);const h=Date.now()/1e3,c=.5*Math.sin(.5*h)+1.5;let u=.1;"in"===r.phase?u=1:"entering"===r.phase?u=Math.max(.1,3.3*(r.lotusMorph-.7)):"exiting"===r.phase&&(u=Math.max(.1,.5*r.lotusMorph));const l=c*u;if(r.lotusMorph>0){t.shadowBlur=a(100)*l,t.shadowColor=`rgba(255, 223, 0, ${.5*l})`;const e=t.createRadialGradient(0,0,0,0,0,4*s);"in"!==r.phase?(e.addColorStop(0,"rgba(184, 134, 11, 0.8)"),e.addColorStop(.3,"rgba(153, 101, 21, 0.6)"),e.addColorStop(.6,"rgba(139, 69, 19, 0.4)"),e.addColorStop(1,"rgba(101, 67, 33, 0)")):(e.addColorStop(0,`rgba(255, 255, 255, ${1*l})`),e.addColorStop(.1,`rgba(255, 255, 240, ${1*l})`),e.addColorStop(.2,`rgba(255, 250, 205, ${.95*l})`),e.addColorStop(.35,`rgba(255, 240, 150, ${.85*l})`),e.addColorStop(.5,`rgba(255, 223, 0, ${.7*l})`),e.addColorStop(.65,`rgba(255, 215, 0, ${.5*l})`),e.addColorStop(.8,`rgba(255, 215, 0, ${.3*l})`),e.addColorStop(.9,`rgba(255, 215, 0, ${.15*l})`),e.addColorStop(.95,`rgba(255, 215, 0, ${.05*l})`),e.addColorStop(1,"rgba(255, 215, 0, 0)")),t.fillStyle=e,t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=a(2),t.beginPath(),t.arc(0,0,s,0,2*Math.PI,!1);const i=r.lotusMorph,n=r.petalSpread,o=r.smileCurve;if(i>.1){const e=s*(.05+.15*i);if(t.moveTo(0,e),t.bezierCurveTo(-s*(.05+.25*i*n),.1*s,-s*(.05+.3*i*n),-s*(.1+.4*i),0,-s*(.2+.65*i)),t.bezierCurveTo(s*(.05+.3*i*n),-s*(.1+.4*i),s*(.05+.25*i*n),.1*s,0,e),i>.3){const e=(i-.3)/.7;t.moveTo(.1*-s*e,.2*s),t.bezierCurveTo(-s*(.1+.4*e*n),.1*s,-s*(.2+.5*e*n),-s*(.1+.2*e),-s*(.1+.4*e*n),-s*(.2+.45*e)),t.bezierCurveTo(-s*(.05+.15*e),-s*(.1+.4*e),.05*-s*e,.1*s,.1*-s*e,.2*s),t.moveTo(.1*s*e,.2*s),t.bezierCurveTo(s*(.1+.4*e*n),.1*s,s*(.2+.5*e*n),-s*(.1+.2*e),s*(.1+.4*e*n),-s*(.2+.45*e)),t.bezierCurveTo(s*(.05+.15*e),-s*(.1+.4*e),.05*s*e,.1*s,.1*s*e,.2*s)}o>0&&(t.moveTo(.6*-s,s*(.5-.1*o)),t.quadraticCurveTo(0,s*(.5+.1*o),.6*s,s*(.5-.1*o)))}if(t.closePath(),t.fill("evenodd"),t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.stroke(),"in"===r.phase){const e=2*s,i=r.arcHeight*s,n=.5*s,o=t.createRadialGradient(0,n,0,0,n,1.2*e);o.addColorStop(0,`rgba(255, 255, 255, ${1*l})`),o.addColorStop(.25,`rgba(255, 252, 240, ${.8*l})`),o.addColorStop(.5,`rgba(255, 245, 200, ${.6*l})`),o.addColorStop(.75,`rgba(255, 235, 150, ${.4*l})`),o.addColorStop(1,"rgba(255, 223, 0, 0)"),t.fillStyle=o,t.fill();const a=t.createRadialGradient(0,-i/2,.5*s,0,-i/2,5*s);a.addColorStop(0,"rgba(255, 223, 0, 0)"),a.addColorStop(.1,`rgba(255, 223, 0, ${.25*l})`),a.addColorStop(.2,`rgba(255, 220, 0, ${.2*l})`),a.addColorStop(.35,`rgba(255, 215, 0, ${.15*l})`),a.addColorStop(.5,`rgba(255, 215, 0, ${.1*l})`),a.addColorStop(.65,`rgba(255, 215, 0, ${.06*l})`),a.addColorStop(.8,`rgba(255, 215, 0, ${.03*l})`),a.addColorStop(.9,`rgba(255, 215, 0, ${.01*l})`),a.addColorStop(1,"rgba(255, 215, 0, 0)"),t.fillStyle=a,t.fill()}}else{t.shadowBlur=0,t.shadowColor="transparent";const e=.3;t.fillStyle=`rgba(255, 215, 0, ${e})`,t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.fill();const i=t.createRadialGradient(0,0,0,0,0,s);i.addColorStop(0,"rgba(255, 255, 255, 0.2)"),i.addColorStop(.5,"rgba(255, 250, 230, 0.1)"),i.addColorStop(1,"rgba(255, 215, 0, 0)"),t.fillStyle=i,t.fill()}t.restore()}}const ni=2,ri=3,oi=4,ai=new class{constructor(){this.callbacks=new Map,this.callbackIdCounter=0,this.frameId=null,this.isRunning=!1,this.lastFrameTime=0,this.deltaTime=0,this.fps=60,this.frameCount=0,this.targetFPS=60,this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=16.67,this.prioritySkipCounters={[ni]:0,[ri]:0,[oi]:0},this.performanceMonitor=null,this.frameTimeHistory=[],this.maxHistorySize=60,this.loop=this.loop.bind(this)}register(t,e=2,i=null){if("function"!=typeof t)throw new Error("Callback must be a function");const s=++this.callbackIdCounter;return this.callbacks.set(s,{callback:t,priority:e,context:i,lastRun:0,runCount:0,totalTime:0,enabled:!0}),1!==this.callbacks.size||this.isRunning||this.start(),s}unregister(t){this.callbacks.delete(t),0===this.callbacks.size&&this.isRunning&&this.stop()}setEnabled(t,e){const i=this.callbacks.get(t);i&&(i.enabled=e)}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.frameId=requestAnimationFrame(this.loop))}stop(){this.isRunning&&(this.isRunning=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null))}loop(t){if(!this.isRunning)return;this.deltaTime=t-this.lastFrameTime,this.lastFrameTime=t,this.frameCount++,this.frameCount%60==0&&(this.fps=Math.round(1e3/(this.deltaTime||16.67))),this.frameTimeHistory.push(this.deltaTime),this.frameTimeHistory.length>this.maxHistorySize&&this.frameTimeHistory.shift(),performance.now();const e=this.groupCallbacksByPriority();let i=0;for(const s of[0,1,2,3,4]){if(s>0&&i>.8*this.frameBudget)break;if(this.shouldSkipPriority(s))continue;const n=e.get(s)||[];for(const e of n){if(!e.enabled)continue;const s=performance.now();try{e.context?e.callback.call(e.context,this.deltaTime,t):e.callback(this.deltaTime,t);const n=performance.now()-s;e.totalTime+=n,e.runCount++,e.lastRun=t,i+=n}catch(t){e.runCount>0&&e.totalTime/e.runCount>10&&(e.enabled=!1)}if(i>this.frameBudget)break}}performance.now(),this.frameBudget,this.frameId=requestAnimationFrame(this.loop)}groupCallbacksByPriority(){const t=new Map;for(const[,e]of this.callbacks){const{priority:i}=e;t.has(i)||t.set(i,[]),t.get(i).push(e)}return t}shouldSkipPriority(t){if(0===t)return!1;if(this.fps<30&&t>=3)return!0;if(this.fps<45&&4===t)return!0;if(2===t){if(this.fps<50&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%2!=0))return!0}else if(3===t){if(this.fps<50&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%3!=0))return!0}else if(4===t&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%5!=0))return!0;return!1}getStats(){const t={fps:this.fps,frameCount:this.frameCount,callbackCount:this.callbacks.size,averageFrameTime:0,maxFrameTime:0,minFrameTime:1/0};if(this.frameTimeHistory.length>0){let e=0;for(const i of this.frameTimeHistory)e+=i,t.maxFrameTime=Math.max(t.maxFrameTime,i),t.minFrameTime=Math.min(t.minFrameTime,i);t.averageFrameTime=e/this.frameTimeHistory.length}t.callbacksByPriority={};for(const[,e]of this.callbacks){const{priority:i}=e;t.callbacksByPriority[i]||(t.callbacksByPriority[i]={count:0,totalTime:0,enabled:0}),t.callbacksByPriority[i].count++,t.callbacksByPriority[i].totalTime+=e.totalTime,e.enabled&&t.callbacksByPriority[i].enabled++}return t}setTargetFPS(t){this.targetFPS=Math.max(15,Math.min(120,t)),this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=this.targetFrameTime}setPerformanceMonitor(t){this.performanceMonitor=t}destroy(){this.stop(),this.callbacks.clear(),this.frameTimeHistory=[]}};class hi{constructor(t){this.renderer=t,this.zenTransition={active:!1,phase:null,startTime:0,previousEmotion:null,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0},this.loopCallbackIds={zenEnter:null,zenExit:null}}getZenTransition(){return this.zenTransition}isActive(){return this.zenTransition.active}isInZenPhase(){return this.zenTransition.active&&"in"===this.zenTransition.phase}enterZenMode(t,e){this.T(),this.renderer.state.glowColor=t,this.renderer.state.glowIntensity=e,this.renderer.colorTransition.active=!1,this.zenTransition={active:!0,phase:"entering",startTime:performance.now(),previousEmotion:this.renderer.state.emotion,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0};const i=()=>{if(!this.zenTransition.active||"entering"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenEnter=null);const t=performance.now()-this.zenTransition.startTime;if(t<400){const e=t/400,s=1-Math.pow(1-e,2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=s,this.zenTransition.petalSpread=s,this.zenTransition.smileCurve=Math.sin(e*Math.PI/2),this.loopCallbackIds.zenEnter=ai.register(i,2,this)}else this.zenTransition.phase="in",this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=1,this.zenTransition.petalSpread=1,this.zenTransition.smileCurve=1,this.renderer.state.zenVortexIntensity=1,this.loopCallbackIds.zenEnter=null};this.loopCallbackIds.zenEnter=ai.register(i,2,this)}exitZenMode(t,e,i){if(!this.zenTransition.active||"in"!==this.zenTransition.phase)return;this.T(),this.zenTransition.phase="exiting",this.zenTransition.startTime=performance.now(),this.zenTransition.targetEmotion=t;const s=()=>{if(!this.zenTransition.active||"exiting"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenExit=null);const t=performance.now()-this.zenTransition.startTime,n=150;if(t<n){const r=t/n,o=1-Math.pow(1-r,2);if(0!==r&&this.renderer.colorTransition.active||this.renderer.startColorTransition(e,i,n),this.zenTransition.arcHeight=1.5*(1-o),this.zenTransition.smileCurve=1*(1-o),r>.3){const t=(r-.3)/.7;this.zenTransition.petalSpread=1*(1-t)}if(r>.5){const t=(r-.5)/.5;this.zenTransition.lotusMorph=1*(1-t)}this.loopCallbackIds.zenExit=ai.register(s,2,this)}else if(t<350){const e=(t-n)/200;if(this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,e<.2){const t=e/.2;this.zenTransition.scaleY=1-.8*Math.sin(t*Math.PI)}else if(e<.6){const t=(e-.2)/.4;this.zenTransition.scaleY=1,this.renderer.state.shakeOffset=3*Math.sin(t*Math.PI*4)}else{const t=(e-.6)/.4;this.renderer.state.driftY=-10*t,this.renderer.state.glowIntensity=1+.5*t}this.loopCallbackIds.zenExit=ai.register(s,2,this)}else if(t<550){const e=(t-n-200)/200,i=Math.sin(e*Math.PI/2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=.2+.8*i,this.renderer.state.driftY=-10*(1-e),this.renderer.state.glowIntensity=1.5-.5*e,this.loopCallbackIds.zenExit=ai.register(s,2,this)}else if(t<650){const e=(t-n-200-200)/100,i=Math.sin(e*Math.PI);this.zenTransition.scaleX=1+.05*i,this.zenTransition.scaleY=1+.05*i,this.loopCallbackIds.zenExit=ai.register(s,2,this)}else this.C()};this.loopCallbackIds.zenExit=ai.register(s,2,this)}T(){this.loopCallbackIds.zenEnter&&(ai.unregister(this.loopCallbackIds.zenEnter),this.loopCallbackIds.zenEnter=null),this.loopCallbackIds.zenExit&&(ai.unregister(this.loopCallbackIds.zenExit),this.loopCallbackIds.zenExit=null)}C(){this.zenTransition.active=!1,this.zenTransition.phase=null,this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,this.renderer.state.shakeOffset=0,this.renderer.state.driftY=0,this.loopCallbackIds.zenExit=null}destroy(){this.T(),this.C()}}class ci{constructor(t){this.renderer=t,this.episodicEffects={nervous:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+2e3*Math.random()},confident:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+2e3*Math.random()},tired:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:5e3+2e3*Math.random()},intense:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+3e3*Math.random()},subdued:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+3e3*Math.random()}}}getEpisodicEffects(){return this.episodicEffects}updateEpisodicEffects(t,e,i,s,n){if(!t||!this.episodicEffects[t])return{jitterX:e,jitterY:i,coreRadius:s,glowRadius:n};const r=this.episodicEffects[t],o=performance.now();if(!r.active&&o>=r.nextTrigger)switch(r.active=!0,r.startTime=o,t){case"nervous":r.duration=500+500*Math.random(),r.intensity=2+Math.random(),r.nextTrigger=o+3e3+2e3*Math.random();break;case"confident":r.duration=1e3+1e3*Math.random(),r.intensity=.15,r.nextTrigger=o+4e3+2e3*Math.random();break;case"tired":r.duration=1e3+2e3*Math.random(),r.intensity=.2,r.nextTrigger=o+5e3+2e3*Math.random();break;case"intense":r.duration=500+500*Math.random(),r.intensity=.5,r.nextTrigger=o+3e3+3e3*Math.random();break;case"subdued":r.duration=2e3+1e3*Math.random(),r.intensity=.3,r.nextTrigger=o+4e3+3e3*Math.random()}if(r.active){const a=o-r.startTime;if(a<r.duration){const o=a/r.duration;switch(t){case"nervous":{const t=1-o,s=15,n=Math.sin(o*Math.PI*s)*t;e=n*r.intensity,i=n*r.intensity*.7;break}case"confident":{const t=Math.sin(o*Math.PI);s*=1+r.intensity*t,n*=1+.5*r.intensity*t;break}case"tired":{const t=Math.sin(o*Math.PI*.5);s*=1-r.intensity*t,i+=5*t;break}case"intense":{const t=1-Math.cos(o*Math.PI);s*=1-.05*t,n*=1+r.intensity*t;break}case"subdued":{const t=Math.sin(o*Math.PI*.5);s*=1-.1*t,n*=1-r.intensity*t;break}}}else r.active=!1}return{jitterX:e,jitterY:i,coreRadius:s,glowRadius:n}}reset(){Object.keys(this.episodicEffects).forEach(t=>{this.episodicEffects[t].active=!1,this.episodicEffects[t].startTime=0,this.episodicEffects[t].duration=0,this.episodicEffects[t].intensity=0})}getEpisodeState(t){return this.episodicEffects[t]||null}isEpisodeActive(t){const e=this.episodicEffects[t];return!!e&&e.active}}class ui{constructor(t){this.renderer=t,this.brakeStartTime=null,this.brakeDuration=2500,this.brakeStartRotation=0,this.brakeTargetRotation=0,this.brakeStartVelocity=0,this.onComplete=null,this.onProgress=null,this.DURATION_FACTOR=14}brakeToUpright(t={}){return this.brakeToTarget(0,t)}brakeToNearest(t,e={}){const i=this.renderer.state.manualRotation||0,s=Math.round(i/t)*t;return this.brakeToTarget(s,e)}brakeToTarget(t,e={}){return new Promise(i=>{const{onProgress:s=null,onComplete:n=null}=e;this.onProgress=s,this.onComplete=n;const r=this.renderer.state.rotationSpeed||0,o=this.renderer.state.manualRotation||0;if(0===r||this.brakeStartTime)return void i();if(this.brakeStartTime=performance.now(),this.brakeStartRotation=o,this.brakeStartVelocity=r,0===t)this.brakeTargetRotation=r>0?360*(Math.floor(o/360)+1):360*Math.floor(o/360);else{const e=t%360,i=Math.floor(o/360);this.brakeTargetRotation=r>0?e>o%360?360*i+e:360*(i+1)+e:e<o%360?360*i+e:360*(i-1)+e}const a=Math.abs(this.brakeTargetRotation-this.brakeStartRotation);this.brakeDuration=Math.max(500,a/Math.abs(r)*this.DURATION_FACTOR*5),this.renderer.setRotationSpeed(0),this.resolvePromise=i})}updateBrake(t){if(!this.brakeStartTime)return null;const e=t-this.brakeStartTime,i=Math.min(e/this.brakeDuration,1),s=1-Math.pow(1-i,4),n=this.brakeStartRotation+(this.brakeTargetRotation-this.brakeStartRotation)*s,r=this.brakeStartVelocity*Math.pow(1-s,2);return this.onProgress&&this.onProgress(s,r,n),i>=1?(this.brakeStartTime=null,this.complete(),{rotation:this.brakeTargetRotation,speed:0,complete:!0}):{rotation:n,speed:r,complete:!1}}stop(){this.brakeStartTime=null}complete(){this.onComplete&&this.onComplete(),this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null)}isBraking(){return null!==this.brakeStartTime}emergencyStop(){this.stop(),this.renderer.setRotationSpeed(0),this.complete()}getProgress(){if(!this.brakeStartTime)return 0;const t=performance.now()-this.brakeStartTime;return Math.min(t/this.brakeDuration,1)}}class li{constructor(t){this.renderer=t,this.rotationBrake=new ui(t)}setRotationSpeed(t){this.renderer.state.rotationSpeed=t}setRotationAngle(t){this.renderer.state.manualRotation=t}getRotationAngle(){return this.renderer.state.manualRotation}getRotationSpeed(){return this.renderer.state.rotationSpeed}isBraking(){return this.rotationBrake&&this.rotationBrake.isBraking()}updateRotation(t){if(this.rotationBrake&&this.rotationBrake.isBraking()){const e=this.rotationBrake.updateBrake(t);e&&(this.renderer.state.manualRotation=e.rotation,this.renderer.state.rotationSpeed=e.complete?0:e.speed)}else 0!==this.renderer.state.rotationSpeed&&(this.renderer.state.manualRotation+=this.renderer.state.rotationSpeed);this.renderer.state.lastRotationUpdate=t}calculateTotalRotation(t=0,e=0){return(t+e+this.renderer.state.manualRotation)*Math.PI/180}applyRotation(t,e){0!==e&&t.rotate(e)}reset(){this.renderer.state.manualRotation=0,this.renderer.state.rotationSpeed=0,this.renderer.state.lastRotationUpdate=performance.now()}destroy(){this.rotationBrake&&(this.rotationBrake=null)}}let di=class{constructor(t){this.renderer=t,this.canvas=t.canvas,this.initialized=!1,this.handleMouseMove=null,this.handleTouchMove=null}setEnabled(t){this.renderer.state.gazeTrackingEnabled=t,t?this.initialized||this.initialize():this.renderer.state.gazeTarget={x:0,y:0}}initialize(){this.initialized||(this.handleMouseMove=t=>{if(!this.renderer.state.gazeTrackingEnabled)return;const e=this.canvas.getBoundingClientRect(),i=e.width/2,s=e.height/2,n=t.clientX-e.left-i,r=t.clientY-e.top-s;this.renderer.state.gazeTarget={x:n/i,y:r/s}},this.handleTouchMove=t=>{if(this.renderer.state.gazeTrackingEnabled&&t.touches.length>0){const e=t.touches[0],i=this.canvas.getBoundingClientRect(),s=i.width/2,n=i.height/2,r=e.clientX-i.left-s,o=e.clientY-i.top-n;this.renderer.state.gazeTarget={x:r/s,y:o/n}}},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("touchmove",this.handleTouchMove),this.initialized=!0)}cleanup(){this.initialized&&(this.handleMouseMove&&(document.removeEventListener("mousemove",this.handleMouseMove),this.handleMouseMove=null),this.handleTouchMove&&(document.removeEventListener("touchmove",this.handleTouchMove),this.handleTouchMove=null),this.initialized=!1)}isInitialized(){return this.initialized}getGazeTarget(){return this.renderer.state.gazeTarget}isEnabled(){return this.renderer.state.gazeTrackingEnabled}};class pi{constructor(t){this.renderer=t}setupCanvas(){this.renderer.updateOffscreenSize();const t=this.renderer.canvasManager.width||this.renderer.canvas.width||400,e=this.renderer.canvasManager.height||this.renderer.canvas.height||400,i=this.renderer.ctx;return this.renderer.ctx=this.renderer.offscreenCtx,{logicalWidth:t,logicalHeight:e,originalCtx:i}}renderBackdrop(t,e,i,s){const n=Math.min(t,e),r=this.renderer.getEffectiveCenter(),o=r.x,a=r.y-this.renderer.config.topOffset,h=n/this.renderer.config.referenceSize*this.renderer.config.baseScale*(r.coreScale||r.scale),c=this.renderer.config.referenceSize/this.renderer.config.coreSizeDivisor*h;this.renderer.backdropRenderer.update(s),this.renderer.audioAnalyzer&&this.renderer.audioAnalyzer.currentAmplitude&&this.renderer.backdropRenderer.setAudioIntensity(this.renderer.audioAnalyzer.currentAmplitude),this.renderer.backdropRenderer.render(o,a,c,i)}applyCanvasDecay(t,e,i){const s=this.renderer.particleSystem?this.renderer.particleSystem.particles.length:0,n=.12+Math.min(.08,.003*s);t.save(),t.globalCompositeOperation="destination-out",t.fillStyle=`rgba(0, 0, 0, ${n})`,t.fillRect(0,0,e,i),t.restore()}clearOffscreenCanvas(t,e){this.renderer.ctx.clearRect(0,0,t,e)}performCanvasSetup(t,e,i,s){this.renderBackdrop(t,e,i,s),this.applyCanvasDecay(i,t,e),this.clearOffscreenCanvas(t,e)}}class fi{constructor(t){this.renderer=t}markFrameStart(){return this.renderer.performanceMonitor&&this.renderer.performanceMonitor.markFrameStart(),performance.now()}handleCleanRender(){this.renderer.forceCleanRender&&(this.renderer.forceCleanRender=!1,this.renderer.canvas&&this.renderer.ctx&&this.renderer.ctx.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height))}initializeFrame(){const t=this.markFrameStart();return this.handleCleanRender(),t}}class mi{constructor(t){this.renderer=t}mergeTransforms(t,e){const i=this.renderer.ambientDanceAnimator.getTransform(e);return t?(t.x=(t.x||0)+(i.x||0),t.y=(t.y||0)+(i.y||0),t.rotation=(t.rotation||0)+(i.rotation||0),t.scale=(t.scale||1)*(i.scale||1),t):i}mergeAndStoreTransforms(t,e){const i=this.mergeTransforms(t,e);return this.renderer.gestureTransform=i,i}}class gi{constructor(t){this.renderer=t,this.animations={grooveSway:null,grooveBob:null,grooveFlow:null,groovePulse:null,grooveStep:null},this.activeAnimation=null,this.blendState={x:0,y:0,rotation:0,scale:1,opacity:1}}startAmbientAnimation(t,e={}){this.activeAnimation&&this.activeAnimation!==t&&this.stopAmbientAnimation(this.activeAnimation),this.activeAnimation=t,this.animations[t]={startTime:Date.now(),intensity:e.intensity||1,frequency:e.frequency||1,options:e}}stopAmbientAnimation(t){this.animations[t]&&(this.animations[t]=null),this.activeAnimation===t&&(this.activeAnimation=null)}updateBlendState(t){if(!t)return;const e=.2;this.blendState.x=this.lerp(this.blendState.x,t.x||0,e),this.blendState.y=this.lerp(this.blendState.y,t.y||0,e),this.blendState.rotation=this.lerp(this.blendState.rotation,t.rotation||0,e),this.blendState.scale=this.lerp(this.blendState.scale,t.scale||1,e),this.blendState.opacity=this.lerp(this.blendState.opacity,t.opacity||1,e)}getTransform(t){const e={x:this.blendState.x,y:this.blendState.y,rotation:this.blendState.rotation,scale:this.blendState.scale,opacity:this.blendState.opacity};if(this.activeAnimation){const t=this.animations[this.activeAnimation];if(t){const i=Date.now()-t.startTime;switch(this.activeAnimation){case"grooveSway":e.x+=15*Math.sin(i/500*t.frequency)*t.intensity,e.rotation+=5*Math.sin(i/500*t.frequency+Math.PI/4)*t.intensity;break;case"grooveBob":e.y+=10*Math.sin(i/400*t.frequency)*t.intensity,e.scale*=1+.03*Math.sin(i/400*t.frequency)*t.intensity;break;case"grooveFlow":{const s=i/1e3*t.frequency;e.x+=Math.sin(s)*Math.cos(2*s)*20*t.intensity,e.y+=Math.cos(s)*Math.sin(2*s)*10*t.intensity,e.rotation+=8*Math.sin(2*s)*t.intensity;break}case"groovePulse":e.scale*=1+.05*Math.sin(i/250*t.frequency)*t.intensity,e.opacity*=.9+.1*Math.sin(i/250*t.frequency)*t.intensity;break;case"grooveStep":{const s=Math.floor(i/500*t.frequency)%4,n=i/500*t.frequency%1,r=this.smoothStep(n);0===s?e.x+=25*r*t.intensity:2===s&&(e.x-=25*r*t.intensity),e.y+=5*Math.abs(Math.sin(i/250*t.frequency))*t.intensity;break}}}}return e}lerp(t,e,i){return t+(e-t)*i}smoothStep(t){return t*t*(3-2*t)}}class yi{constructor(t){this.renderer=t,this.ctx=t.ctx,this.config={enabled:!1,radius:1.5,shape:"circle",color:"rgba(0, 0, 0, 0.6)",intensity:.7,blendMode:"normal",falloff:"smooth",falloffCurve:null,edgeSoftness:.6,coreTransparency:.2,blur:0,responsive:!0,pulse:!1,offset:{x:0,y:0},type:"radial-gradient"},this.currentIntensity=0,this.targetIntensity=0,this.pulsePhase=0}setConfig(t={}){this.config={...this.config,...t},void 0!==t.enabled&&(this.targetIntensity=t.enabled?this.config.intensity:0)}update(t){this.config.enabled?(this.currentIntensity+=.1*(this.targetIntensity-this.currentIntensity),this.config.responsive&&(this.pulsePhase+=.001*t)):this.currentIntensity*=.95}setAudioIntensity(t){if(!this.config.responsive)return;const e=.2*t;this.targetIntensity=Math.min(1,this.config.intensity+e)}render(t,e,i,s=null){if(this.currentIntensity<.01)return;const n=s||this.ctx;switch(n.save(),this.config.type){case"radial-gradient":this.renderRadialGradient(t,e,i,n);break;case"vignette":this.renderVignette(t,e,i,n);break;case"glow":this.renderGlow(t,e,i,n)}n.restore()}renderRadialGradient(t,e,i,s){s=s||this.ctx;const n=i*this.config.radius,r=t+(this.config.offset.x||0),o=e+(this.config.offset.y||0);let a=n;(this.config.pulse||this.config.responsive)&&(a*=1+.05*Math.sin(this.pulsePhase));const h=s.globalCompositeOperation;this.config.blendMode&&"normal"!==this.config.blendMode&&(s.globalCompositeOperation=this.config.blendMode),this.config.blur>0&&(s.filter=`blur(${this.config.blur}px)`);const c=s.createRadialGradient(r,o,0,r,o,a),u=this.config.color,l=this.currentIntensity;this.addGradientStopsSimple(c,u,l),s.fillStyle=c,s.beginPath(),s.arc(r,o,a,0,2*Math.PI),s.fill(),this.config.blur>0&&(s.filter="none"),this.config.blendMode&&"normal"!==this.config.blendMode&&(s.globalCompositeOperation=h)}renderVignette(t,e,i,s){s=s||this.ctx;const{canvas:n}=s,r=Math.max(n.width,n.height),o=s.createRadialGradient(t,e,.5*i,t,e,r);o.addColorStop(0,"rgba(0, 0, 0, 0)"),o.addColorStop(1,this.adjustColorAlpha(this.config.color,this.currentIntensity)),s.fillStyle=o,s.fillRect(0,0,n.width,n.height)}renderGlow(t,e,i,s){s=s||this.ctx;const n=i*this.config.radius;for(let i=0;i<3;i++){const r=n*(1-.2*i),o=this.currentIntensity*(.3-.1*i),a=s.createRadialGradient(t,e,0,t,e,r);a.addColorStop(0,this.adjustColorAlpha(this.config.color,o)),a.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=a,s.beginPath(),s.arc(t,e,r,0,2*Math.PI),s.fill()}}addGradientStopsSimple(t,e,i){const{coreTransparency:s}=this.config;t.addColorStop(0,this.adjustColorAlpha(e,i)),t.addColorStop(s,this.adjustColorAlpha(e,i));for(let n=1;n<=25;n++){const r=s+n/25*(1-s),o=(r-s)/(1-s),a=1-this.easeInOutCubic(o);t.addColorStop(r,this.adjustColorAlpha(e,i*a))}t.addColorStop(1,"rgba(0, 0, 0, 0)")}addGradientStops(t,e,i,s=1){const{coreTransparency:n}=this.config;if(this.config.falloffCurve&&Array.isArray(this.config.falloffCurve))this.config.falloffCurve.forEach(({stop:s,alpha:n})=>{t.addColorStop(s,this.adjustColorAlpha(e,i*n))});else switch(this.config.falloff){case"linear":t.addColorStop(0,"rgba(0, 0, 0, 0)"),t.addColorStop(n,"rgba(0, 0, 0, 0)"),t.addColorStop(1,this.adjustColorAlpha(e,i));break;case"exponential":t.addColorStop(0,"rgba(0, 0, 0, 0)"),t.addColorStop(n,"rgba(0, 0, 0, 0)"),t.addColorStop(n+.3*(1-n),this.adjustColorAlpha(e,.05*i)),t.addColorStop(n+.5*(1-n),this.adjustColorAlpha(e,.15*i)),t.addColorStop(n+.7*(1-n),this.adjustColorAlpha(e,.4*i)),t.addColorStop(n+.85*(1-n),this.adjustColorAlpha(e,.7*i)),t.addColorStop(1,this.adjustColorAlpha(e,i));break;default:{t.addColorStop(0,"rgba(0, 0, 0, 0)"),t.addColorStop(n*s,"rgba(0, 0, 0, 0)");const{edgeSoftness:r}=this.config,o=s,a=n*s+(o-n*s)*r,h=25;for(let r=1;r<=h;r++){const c=r/h;let u=0;if(c<=n*s)u=0;else if(c<=o)if(c<=a){const t=(c-n*s)/(a-n*s);u=this.easeInOutCubic(t)}else{const t=(c-a)/(o-a);u=1-.05*(1-this.easeInOutCubic(t))}else{const t=(c-o)/(1-o);u=1-this.easeInOutCubic(t)}t.addColorStop(c,this.adjustColorAlpha(e,i*u))}t.addColorStop(1,"rgba(0, 0, 0, 0)");break}}}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}adjustColorAlpha(t,e){const i=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(i){const[,t,s,n,r=1]=i;return`rgba(${t}, ${s}, ${n}, ${parseFloat(r)*e})`}return`rgba(0, 0, 0, ${.6*e})`}getConfig(){return{...this.config}}enable(){this.config.enabled=!0,this.targetIntensity=this.config.intensity}disable(){this.config.enabled=!1,this.targetIntensity=0}toggle(){this.config.enabled?this.disable():this.enable()}}class bi{constructor(t){this.renderer=t,this.loopCallbackIds={eyeClose:null,eyeOpen:null},this.wakeJitterTimeout=null}enterSleepMode(){this.renderer.state.sleeping=!0,this.renderer.sleepZ=[],this.renderer.state.eyeOpenness=1,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.renderer.state.blinking=!1,this.animateEyeClose()}animateEyeClose(){this.loopCallbackIds.eyeClose&&(ai.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null),this.loopCallbackIds.eyeOpen&&(ai.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null);const t=performance.now(),e=2e3;this.loopCallbackIds.eyeClose=ai.register(()=>{if(!this.renderer.state.sleeping)return void(this.loopCallbackIds.eyeClose=null);const i=performance.now()-t;if(i<e){const t=i/e,s=1-Math.pow(t,2);this.renderer.state.eyeOpenness=.1+.9*s,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1}else if(i<3e3){const t=(i-e)/1e3,s=1-Math.pow(1-t,3);this.renderer.state.eyeOpenness=.1,this.renderer.state.sleepDimness=1-.4*s,this.renderer.state.sleepScale=1-.1*s}else this.renderer.state.eyeOpenness=.1,this.renderer.state.sleepDimness=.6,this.renderer.state.sleepScale=.9,this.loopCallbackIds.eyeClose=null},1,this.renderer)}wakeUp(){this.renderer.state.sleeping&&(this.renderer.state.sleeping=!1,this.renderer.state.breathRate=1,this.renderer.state.breathDepth=this.renderer.config.breathingDepth,this.renderer.sleepZ=[],this.renderer.state.blinking=!1,this.renderer.eyeRenderer.blinking=!1,this.renderer.eyeRenderer.blinkTimer=0,this.animateEyeOpen(),this.wakeJitterTimeout&&clearTimeout(this.wakeJitterTimeout),this.renderer.state.coreJitter=!0,this.wakeJitterTimeout=setTimeout(()=>{this.renderer.state.coreJitter=!1,this.wakeJitterTimeout=null},200))}animateEyeOpen(){this.loopCallbackIds.eyeOpen&&(ai.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null),this.loopCallbackIds.eyeClose&&(ai.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null);const t=performance.now();this.loopCallbackIds.eyeOpen=ai.register(()=>{const e=performance.now()-t;if(e<500){const t=e/500,i=Math.sin(t*Math.PI/2);this.renderer.state.sleepDimness=.6+.4*i,this.renderer.state.sleepScale=.9+.1*i,this.renderer.state.eyeOpenness=.1}else if(e<1500){const t=(e-500)/1e3,i=Math.sin(t*Math.PI/2);this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.renderer.state.eyeOpenness=.1+.9*i}else this.renderer.state.eyeOpenness=1,this.renderer.state.sleepDimness=1,this.renderer.state.sleepScale=1,this.loopCallbackIds.eyeOpen=null},1,this.renderer)}renderSleepIndicator(t,e,i){return this.renderer.specialEffects.renderSleepIndicator(t,e,i)}cleanup(){this.loopCallbackIds.eyeClose&&(ai.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null),this.loopCallbackIds.eyeOpen&&(ai.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null),this.wakeJitterTimeout&&(clearTimeout(this.wakeJitterTimeout),this.wakeJitterTimeout=null)}}class vi{constructor(t){this.renderer=t}applyUndertoneModifiers(t){if(t&&"object"==typeof t&&void 0!==t.weight){const{weight:e}=t;return this.renderer.state.sizeMultiplier=1+((t.sizeMultiplier||1)-1)*e,this.renderer.state.jitterAmount=(t.jitterAmount||0)*e,this.renderer.state.episodicFlutter=e>.5&&t.episodicFlutter||!1,this.renderer.state.glowRadiusMult=1+((t.glowRadiusMult||1)-1)*e,this.renderer.state.breathRateMult=1+((t.breathRateMult||1)-1)*e,this.renderer.state.breathDepthMult=1+((t.breathDepthMult||1)-1)*e,this.renderer.state.breathIrregular=e>.5&&t.breathIrregular||!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=(t.glowPulse||0)*e,this.renderer.state.brightnessFlicker=(t.brightnessFlicker||0)*e,this.renderer.state.brightnessMult=1+((t.brightnessMult||1)-1)*e,this.renderer.state.saturationMult=1+((t.saturationMult||1)-1)*e,void(this.renderer.state.hueShift=(t.hueShift||0)*e)}if(!t||!this.renderer.undertoneModifiers[t])return this.renderer.state.sizeMultiplier=1,this.renderer.state.jitterAmount=0,this.renderer.state.episodicFlutter=!1,this.renderer.state.glowRadiusMult=1,this.renderer.state.breathRateMult=1,this.renderer.state.breathDepthMult=1,this.renderer.state.breathIrregular=!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=0,this.renderer.state.brightnessFlicker=0,this.renderer.state.brightnessMult=1,this.renderer.state.saturationMult=1,void(this.renderer.state.hueShift=0);const e=this.renderer.undertoneModifiers[t];this.renderer.state.sizeMultiplier=e.sizeMultiplier,this.renderer.state.jitterAmount=e.jitterAmount||0,this.renderer.state.episodicFlutter=e.episodicFlutter||!1,this.renderer.state.glowRadiusMult=e.glowRadiusMult,this.renderer.state.breathRateMult=e.breathRateMult,this.renderer.state.breathDepthMult=e.breathDepthMult,this.renderer.state.breathIrregular=e.breathIrregular||!1,this.renderer.state.particleRateMult=1,this.renderer.state.glowPulse=e.glowPulse||0,this.renderer.state.brightnessFlicker=e.brightnessFlicker||0,this.renderer.state.brightnessMult=e.brightnessMult||1,this.renderer.state.saturationMult=e.saturationMult||1,this.renderer.state.hueShift=e.hueShift||0}updateUndertone(t){this.renderer.state.undertone!==t&&this.renderer.glowCache.clear(),this.renderer.state.undertone=t,this.renderer.currentUndertone=t;const e=this.renderer.stateMachine&&this.renderer.stateMachine.getWeightedUndertoneModifiers?this.renderer.stateMachine.getWeightedUndertoneModifiers():null;if(this.applyUndertoneModifiers(e||t),this.renderer.state.emotion){const i=L&&L.isInitialized?L.getEmotion(this.renderer.state.emotion):F(this.renderer.state.emotion);if(i){const s=i.glowColor||this.renderer.config.defaultGlowColor,n=this.renderer.applyUndertoneToColor(s,e||t);this.renderer.startColorTransition(n,200)}}}setEmotionalState(t,e,i=null){this.renderer.state.emotion===t&&this.renderer.state.undertone===i||this.renderer.glowCache.clear(),this.renderer.state.undertone=i,this.renderer.currentUndertone=i;const s=this.renderer.stateMachine&&this.renderer.stateMachine.getWeightedUndertoneModifiers?this.renderer.stateMachine.getWeightedUndertoneModifiers():null;this.applyUndertoneModifiers(s||i);const n=e.glowColor||this.renderer.config.defaultGlowColor;let r;r="suspicion"===t?e.glowColor||n:this.renderer.applyUndertoneToColor(n,s||i);const o=s||(i?this.renderer.undertoneModifiers[i]:null),a=e.glowIntensity||1;let h=1;if(o)if(s){const t=o.weight||0;h=void 0!==o.glowRadiusMult&&isFinite(o.glowRadiusMult)&&isFinite(t)?1+(o.glowRadiusMult-1)*t:1}else h=void 0!==o.glowRadiusMult?o.glowRadiusMult:1;const c=a*h;let u=1500;"anger"===t||"fear"===t?u=800:("sadness"===t||"resting"===t||"zen"===t)&&(u=2e3);const l=this.renderer.state.emotion;this.renderer.state.emotion=t,"suspicion"===t?(this.renderer.state.isSuspicious=!0,this.renderer.state.targetSquintAmount=e&&e.coreSquint?e.coreSquint:.4,void 0===this.renderer.state.squintAmount&&(this.renderer.state.squintAmount=0),this.renderer.state.lastScanTime=Date.now(),this.renderer.state.scanPhase=0):(this.renderer.state.isSuspicious=!1,this.renderer.state.targetSquintAmount=0,void 0===this.renderer.state.squintAmount&&(this.renderer.state.squintAmount=0)),"zen"===t&&"zen"!==l?this.renderer.enterZenMode(r,c):"zen"===l&&"zen"!==t?this.renderer.exitZenMode(t,r,c):this.renderer.startColorTransition(r,c,u);const d=e.breathRate||1,p=e.breathDepth||this.renderer.config.breathingDepth;this.renderer.state.breathRate=o?d*o.breathRateMult:d,this.renderer.state.breathDepth=o?p*o.breathDepthMult:p,this.renderer.state.coreJitter=e.coreJitter||o&&o.jitterAmount>0,this.renderer.state.emotionEyeOpenness=e.eyeOpenness,this.renderer.state.emotionEyeArc=e.eyeArc}}class wi{constructor(t,e={}){this.canvasManager=t,this.ctx=t.getContext(),this.gestureCompositor=new Ee,this.currentUndertone=null,this.gestureAnimator=new Ye(this),this.colorUtilities=new Xe,this.specialEffects=new Je(this),this.eyeRenderer=new Ke(this),this.breathingAnimator=new Qe(this),this.glowRenderer=new ti(this),this.coreRenderer=new ei(this),this.celestialRenderer=new ii,this.zenModeRenderer=new si,this.zenModeController=new hi(this),this.episodicEffectController=new ci(this),this.rotationManager=new li(this),this.gazeTracker=new di(this),this.canvasSetupManager=new pi(this),this.renderPerformanceManager=new fi(this),this.transformMerger=new mi(this),this.ambientDanceAnimator=new gi(this),this.backdropRenderer=new yi(this),this.sleepManager=new bi(this),this.emotionalStateManager=new vi(this),this.config={coreColor:e.coreColor||"#FFFFFF",coreSizeDivisor:e.coreSizeDivisor||12,glowMultiplier:e.glowMultiplier||2.5,defaultGlowColor:e.defaultGlowColor||"#14B8A6",breathingSpeed:e.breathingSpeed||.42,breathingDepth:e.breathingDepth||.08,renderingStyle:e.renderingStyle||"classic",baseScale:e.baseScale||1,referenceSize:400,topOffset:e.topOffset||0,positionController:e.positionController||null};const i=Math.min(this.canvasManager.width||400,this.canvasManager.height||400);this.scaleFactor=i/this.config.referenceSize*this.config.baseScale,this.state={emotion:"neutral",glowColor:this.config.defaultGlowColor,glowIntensity:1,breathRate:1,breathDepth:this.config.breathingDepth,coreJitter:!1,speaking:!1,recording:!1,sleeping:!1,blinking:!1,blinkingEnabled:!0,gazeOffset:{x:0,y:0},gazeIntensity:0,gazeLocked:!1,gazeTrackingEnabled:!1,gazeTarget:{x:0,y:0},zenVortexIntensity:1,effectiveCenter:{x:0,y:0,scale:1},squintAmount:0,targetSquintAmount:0,scanPhase:0,lastScanTime:0,isSuspicious:!1,customScale:null,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!1,glowRadiusMult:1,breathRateMult:1,breathDepthMult:1,breathIrregular:!1,particleRateMult:1,glowPulse:0,brightnessFlicker:0,brightnessMult:1,saturationMult:1,hueShift:0,manualRotation:0,rotationSpeed:0,lastRotationUpdate:performance.now()},this.animationFrameIds={colorTransition:null,eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.loopCallbackIds={eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.wakeJitterTimeout=null,this.offscreenCanvas=null,this.offscreenCtx=null,this.initOffscreenCanvas(),this.canvas=t.canvas,this.glowCache=new Map,this.maxCacheSize=10,this.gestureAnimations={bounce:{active:!1,startTime:0,progress:0,params:null},pulse:{active:!1,startTime:0,progress:0,params:null},shake:{active:!1,startTime:0,progress:0,params:null},spin:{active:!1,startTime:0,progress:0,params:null},nod:{active:!1,startTime:0,progress:0,params:null},tilt:{active:!1,startTime:0,progress:0,params:null},expand:{active:!1,startTime:0,progress:0,params:null},contract:{active:!1,startTime:0,progress:0,params:null},flash:{active:!1,startTime:0,progress:0,params:null},drift:{active:!1,startTime:0,progress:0,params:null,startX:0,startY:0},stretch:{active:!1,startTime:0,progress:0,params:null},glow:{active:!1,startTime:0,progress:0,params:null},flicker:{active:!1,startTime:0,progress:0,params:null},vibrate:{active:!1,startTime:0,progress:0,params:null},wave:{active:!1,startTime:0,progress:0,params:null},breathe:{active:!1,startTime:0,progress:0,params:null},morph:{active:!1,startTime:0,progress:0,params:null},slowBlink:{active:!1,startTime:0,progress:0,params:null},look:{active:!1,startTime:0,progress:0,params:null,targetX:0,targetY:0},settle:{active:!1,startTime:0,progress:0,params:null},breathIn:{active:!1,startTime:0,progress:0,params:null},breathOut:{active:!1,startTime:0,progress:0,params:null},breathHold:{active:!1,startTime:0,progress:0,params:null},breathHoldEmpty:{active:!1,startTime:0,progress:0,params:null},jump:{active:!1,startTime:0,progress:0,params:null},orbital:{active:!1,startTime:0,progress:0,params:null},hula:{active:!1,startTime:0,progress:0,params:null}},Object.defineProperty(this,"episodicEffects",{get:()=>this.episodicEffectController.getEpisodicEffects(),enumerable:!0}),this.speakingRings=[],this.maxRings=5,this.ringSpawnTimer=0,this.ringSpawnInterval=200,this.recordingRings=[],this.recordingPulse=0,this.sleepZ=[],Object.defineProperty(this,"zenTransition",{get:()=>this.zenModeController.getZenTransition(),enumerable:!0}),this.colorTransition={active:!1,fromColor:this.state.glowColor,toColor:this.state.glowColor,fromIntensity:this.state.glowIntensity,toIntensity:this.state.glowIntensity,progress:0,startTime:0,duration:1500},this.undertoneModifiers={nervous:{hueShift:0,saturationMult:1.05,brightnessMult:1,brightnessFlicker:.05,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!0,glowRadiusMult:1,glowPulse:.05,breathRateMult:1.1,breathDepthMult:.9,breathIrregular:!0},confident:{hueShift:15,saturationMult:1.2,brightnessMult:1.1,sizeMultiplier:1,jitterAmount:0,episodicPowerPose:!0,glowRadiusMult:1.15,breathRateMult:.95,breathDepthMult:1.1,breathIrregular:!1},tired:{hueShift:-5,saturationMult:.7,brightnessMult:.85,sizeMultiplier:.95,jitterAmount:0,episodicMicroSleep:!0,glowRadiusMult:.9,breathRateMult:.8,breathDepthMult:1.2,breathIrregular:!1},intense:{hueShift:5,saturationMult:1.3,brightnessMult:1.15,sizeMultiplier:1,jitterAmount:0,episodicLaserFocus:!0,glowRadiusMult:1.2,breathRateMult:1.2,breathDepthMult:.9,breathIrregular:!1},subdued:{hueShift:-10,saturationMult:.75,brightnessMult:.9,sizeMultiplier:.95,jitterAmount:0,episodicWithdrawal:!0,glowRadiusMult:.85,breathRateMult:.9,breathDepthMult:.9,breathIrregular:!1}},this.lastFrameTime=0,this.A()}scaleValue(t){return t*this.scaleFactor}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.updateOffscreenSize()}updateOffscreenSize(){if(this.offscreenCanvas&&this.canvasManager){const{width:t}=this.canvasManager.canvas,{height:e}=this.canvasManager.canvas;if(this.offscreenCanvas.width!==t||this.offscreenCanvas.height!==e){this.offscreenCanvas.width=t,this.offscreenCanvas.height=e;const i=this.canvasManager.canvas.width>this.canvasManager.width;this.offscreenCtx&&(this.offscreenCtx.setTransform(1,0,0,1,0,0),i&&this.canvasManager.dpr&&this.offscreenCtx.scale(this.canvasManager.dpr,this.canvasManager.dpr))}}}updateEffectiveCenter(t){this.state.effectiveCenter=t}getEffectiveCenter(){const t=this.canvasManager.getCenter();let e;return e=this.config.positionController?this.config.positionController.getEffectiveCenter(t.x,t.y):{x:t.x,y:t.y,scale:1},e.x+=this.state.gazeOffset.x,e.y+=this.state.gazeOffset.y,e}render(t,e,i=null){const s=this.renderPerformanceManager.initializeFrame();i=this.transformMerger.mergeAndStoreTransforms(i,e);const{logicalWidth:n,logicalHeight:r,originalCtx:o}=this.canvasSetupManager.setupCanvas();if(this.canvasSetupManager.performCanvasSetup(n,r,o,e),this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers){const t=this.stateMachine.getWeightedUndertoneModifiers();t?this.applyUndertoneModifiers(t):this.applyUndertoneModifiers(null)}if(this.colorTransition&&this.colorTransition.active&&this.updateColorTransition(e),this.updateTimers(e),this.state.gazeTrackingEnabled){const t=.15,e=50;this.state.gazeOffset.x+=(this.state.gazeTarget.x*e-this.state.gazeOffset.x)*t,this.state.gazeOffset.y+=(this.state.gazeTarget.y*e-this.state.gazeOffset.y)*t}else{const t=.1;this.state.gazeOffset.x+=(0-this.state.gazeOffset.x)*t,this.state.gazeOffset.y+=(0-this.state.gazeOffset.y)*t}const a=Math.min(n,r),h=this.getEffectiveCenter();let c=h.x,u=h.y-this.config.topOffset;t.properties&&t.properties.verticalOffset&&(u=h.y-this.config.topOffset+r*t.properties.verticalOffset),this.scaleFactor=a/this.config.referenceSize*this.config.baseScale*(h.coreScale||h.scale),this.particleScaleFactor=a/this.config.referenceSize*this.config.baseScale*(h.particleScale||h.scale);let l=1,d=0,p=1;i&&(c+=i.x||0,u+=i.y||0,l=i.scale||1,d=(i.rotation||0)*Math.PI/180,p=i.glowIntensity||1);const f=this.gestureAnimator.applyGestureAnimations();if(f&&(c+=f.offsetX||0,u+=f.offsetY||0,l*=f.scale||1,d+=(f.rotation||0)*Math.PI/180,p=f.glow||1),"zen"===this.state.emotion&&"in"===this.zenTransition.phase){const t=Date.now()/1e3;u+=15*Math.sin(.3*t)*this.scaleFactor,c+=8*Math.sin(.2*t)*this.scaleFactor,d+=.05*Math.sin(.25*t)}let m,g,y=1,b=1,v=1;if(this.state.sleeping||"resting"===this.state.emotion||ze("sleeping",this.state)){const t=De("sleeping");if(t){const e=t.getDimmingValues();y=void 0!==this.state.sleepDimness?this.state.sleepDimness:e.orbDimming,v=e.glowDimming,b=void 0!==this.state.sleepScale?this.state.sleepScale:.9}else y=void 0!==this.state.sleepDimness?this.state.sleepDimness:.3,v=.2,b=void 0!==this.state.sleepScale?this.state.sleepScale:.9;this.state.breathRate=.5,this.state.breathDepth=.15}if(null!==this.state.customScale)m=this.state.customScale,g=1+.5*(this.state.customScale-1);else{const t=this.breathingAnimator.getBreathingScale();m=t,g=1-.5*(t-1)}"nervous"===this.state.undertone&&this.undertoneModifiers.nervous.glowPulse&&(g*=1+Math.sin(Date.now()/200)*this.undertoneModifiers.nervous.glowPulse);const w=this.config.referenceSize/this.config.coreSizeDivisor*this.scaleFactor,M=t.properties&&t.properties.coreSize?t.properties.coreSize:1,S=this.state.sizeMultiplier||1;let k=w*M*m*l*b*S,x=w*this.config.glowMultiplier*g*this.state.glowIntensity*l*b*S*p;const T=this.state.glowIntensity*p;this.state.sleeping||"zen"===this.state.emotion||(k*=this.eyeRenderer.getBlinkScale());let E=0,C=0;const A=this.state.jitterAmount||0;if(this.currentUndertone)({jitterX:E,jitterY:C,coreRadius:k,glowRadius:x}=this.episodicEffectController.updateEpisodicEffects(this.currentUndertone,E,C,k,x));else if(this.state.coreJitter||A>0){const t=Math.max(A,this.state.coreJitter?this.scaleValue(2):0);E=(Math.random()-.5)*t,C=(Math.random()-.5)*t}const I=c+this.state.gazeOffset.x+E,F=u+this.state.gazeOffset.y+C,_=performance.now();this.rotationManager.updateRotation(_);const R=this.rotationManager.calculateTotalRotation(d);if(0!==R&&(this.ctx.save(),this.ctx.translate(I,F),this.rotationManager.applyRotation(this.ctx,R),this.ctx.translate(-I,-F)),ze("recording-glow",this.state)?$e("recording-glow",this.ctx,{x:I,y:F,radius:x,deltaTime:e}):ze("zen-vortex",this.state)||(this.state.sleeping||"resting"===this.state.emotion||ze("sleeping",this.state)?(this.ctx.save(),this.ctx.globalAlpha=v,this.glowRenderer.renderGlow(I,F,x,{intensity:T}),this.ctx.restore()):this.glowRenderer.renderGlow(I,F,x,{intensity:T})),f&&f.flashWave){const t=f.flashWave,{ctx:e}=this;e.save(),e.globalCompositeOperation="lighter";const i=k*t.innerRadius,s=k*t.outerRadius;if(s>i){const n=Ze.getRadialGradient(e,I,F,i,I,F,s,[{offset:0,color:"rgba(255, 255, 255, 0)"},{offset:.2,color:`rgba(255, 255, 255, ${.15*t.intensity})`},{offset:.5,color:`rgba(255, 255, 255, ${.25*t.intensity})`},{offset:.8,color:`rgba(255, 255, 255, ${.15*t.intensity})`},{offset:1,color:"rgba(255, 255, 255, 0)"}]);e.fillStyle=n,e.beginPath(),e.arc(I,F,s,0,2*Math.PI),e.arc(I,F,Math.max(0,i),0,2*Math.PI,!0),e.fill()}e.restore()}ze("speaking-pulse",this.state)&&$e("speaking-pulse",this.ctx,{x:I,y:F,radius:k,audioLevel:this.state.audioLevel||0,deltaTime:e}),(this.state.sleeping||"resting"===this.state.emotion)&&(this.ctx.globalAlpha=y);let P=null,O=null;this.shapeMorpher&&(this.shapeMorpher.update(),P=this.shapeMorpher.getCanvasPoints(0,0,k),O=this.shapeMorpher.getCurrentShadow());let B=!1;!O||"sun"!==O.type&&"solar-hybrid"!==O.type||(this.renderSunEffects(I,F,k,O),B=!0),this.coreRenderer.renderCore(I,F,k,{scaleX:1,scaleY:1,rotation:R,shapePoints:P}),this.specialEffects&&(this.specialEffects.update(e),this.specialEffects.renderSparkles());const D=this.shapeMorpher?this.shapeMorpher.currentShape:null,$=this.shapeMorpher?this.shapeMorpher.targetShape:null,z=this.shapeMorpher&&"solar"===$&&this.shapeMorpher.isTransitioning,q=this.shapeMorpher&&"solar"===D&&this.shapeMorpher.isTransitioning,j=O&&"solar-hybrid"===O.type,L=this.shapeMorpher&&this.shapeMorpher.isTransitioning&&"solar"===D&&"moon"===$,N=this.shapeMorpher&&this.shapeMorpher.isTransitioning&&"moon"===D&&"solar"===$;if(!O||"crescent"!==O.type&&"lunar"!==O.type||N||this.renderMoonShadow(I,F,k,O,P,!1,0),(j&&O.lunarOverlay||z||q)&&!L){const t=j&&O.lunarOverlay?O.lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"};let e=0,i=0,s=0;if(this.shapeMorpher){s=this.shapeMorpher.getProgress();const t=2.5*k;z&&s<1?(e=-t*(1-s),i=t*(1-s)):q&&s<1&&(e=t*s,i=-t*s)}if(this.renderMoonShadow(I,F,k,t,P,!0),(z||q)&&(z||B)&&(this.renderBaileysBeads(I,F,k,e,i,s,z,!0),Math.abs(e)<30&&Math.abs(i)<30&&this.specialEffects)){const t=Math.sqrt(e*e+i*i),s=Math.max(.1,.5*(1-t/30));this.specialEffects.triggerChromaticAberration(s)}}if((this.state.sleeping||"resting"===this.state.emotion)&&(this.ctx.globalAlpha=1),0!==R&&this.ctx.restore(),this.state.sleeping&&this.renderSleepIndicator(c,u-x-this.scaleValue(20),e),this.ctx=o,o.drawImage(this.offscreenCanvas,0,0,n,r),ze("recording-glow",this.state)){const t=De("recording-glow");t&&t.drawRecordingIndicator&&t.drawRecordingIndicator(o,this.canvas.width,this.canvas.height)}const G=performance.now()-s;this.performanceMonitor&&(this.performanceMonitor.markFrameEnd(),this.performanceMonitor.recordFrameTime(G))}renderRecordingGlow(t,e,i,s){const n=this.canvas?.width||600,r=this.canvas?.height||600,o=Math.min(i,t-10,e-10,n-t-10,r-e-10),a=Math.max(50,o),h=Ze.getRadialGradient(this.ctx,t,e,0,t,e,a,[{offset:0,color:this.hexToRgba("#FF0000",.7*s)},{offset:.3,color:this.hexToRgba("#FF0000",.5*s)},{offset:.6,color:this.hexToRgba("#FF0000",.3*s)},{offset:.85,color:this.hexToRgba("#FF0000",.1*s)},{offset:1,color:this.hexToRgba("#FF0000",0)}]);this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.arc(t,e,a,0,2*Math.PI),this.ctx.fill()}renderDropShadow(t,e,i,s){const{ctx:n}=this,r=this.shapeMorpher&&this.shapeMorpher.isTransitioning;if(!(this.shapeMorpher&&(this.shapeMorpher.audioDeformation>.1||this.shapeMorpher.vocalEnergy>.1)||r&&!(this.shapeMorpher.morphProgress>.8))){n.save(),n.translate(t,e);const r=this.scaleValue(2);if(n.translate(0,r),s&&s.length>32)n.fillStyle="rgba(0, 0, 0, 0.15)",n.beginPath(),n.arc(0,0,1.05*i,0,2*Math.PI),n.fill();else{const t=n.createRadialGradient(0,0,.7*i,0,0,1.2*i);if(t.addColorStop(0,"rgba(0, 0, 0, 0.2)"),t.addColorStop(.8,"rgba(0, 0, 0, 0.1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),n.fillStyle=t,n.beginPath(),s){const t=1.1,e=s.length>20?2:1;n.moveTo(s[0].x*t,s[0].y*t);for(let i=e;i<s.length;i+=e)n.lineTo(s[i].x*t,s[i].y*t);n.closePath()}else n.arc(0,0,1.1*i,0,2*Math.PI);n.fill()}n.restore()}}renderSunEffects(t,e,i,s){return this.celestialRenderer.renderSunEffects(this.ctx,t,e,i,s)}renderBaileysBeads(t,e,i,s,n,r,o,a){return this.celestialRenderer.renderBaileysBeads(this.ctx,t,e,i,s,n,r,o,a,this.scaleValue.bind(this))}renderMoonShadow(t,e,i,s,n,r=!1,o=0){return this.celestialRenderer.renderMoonShadow(this.ctx,t,e,i,s,n,r,o,this.shapeMorpher)}renderZenCore(t,e,i){return this.zenModeRenderer.renderZenCore(this.ctx,t,e,i,this.state,this.zenTransition,this.gestureTransform,this.scaleValue.bind(this))}renderSpeakingRings(t,e,i,s){return this.specialEffects.renderSpeakingRings(t,e,i,s)}renderRecordingIndicator(t,e){return this.specialEffects.renderRecordingIndicator(t,e)}renderSleepIndicator(t,e,i){return this.sleepManager.renderSleepIndicator(t,e,i)}updateTimers(t){this.breathingAnimator.update(t,this.state.emotion,this.currentUndertone),"zen"===this.state.emotion?(this.breathingAnimator.setBreathRateMultiplier(.15),this.breathingAnimator.setBreathDepthMultiplier(2.5)):this.state.sleeping?(this.breathingAnimator.setBreathRateMultiplier(.5),this.breathingAnimator.setBreathDepthMultiplier(1.2)):(this.breathingAnimator.setBreathRateMultiplier(1),this.breathingAnimator.setBreathDepthMultiplier(1)),this.breathingAnimator.setIrregularBreathing(this.state.breathIrregular),this.eyeRenderer.setBlinkingEnabled(this.state.blinkingEnabled&&!this.state.sleeping&&"zen"!==this.state.emotion),this.eyeRenderer.update(t),this.state.blinking=this.eyeRenderer.blinking}applyUndertoneModifiers(t){this.emotionalStateManager.applyUndertoneModifiers(t)}applyUndertoneToColor(t,e){return this.colorUtilities.applyUndertoneToColor(t,e)}hexToRgb(t){return this.colorUtilities.hexToRgb(t)}rgbToHsl(t,e,i){return this.colorUtilities.rgbToHsl(t,e,i)}hslToHex(t,e,i){return this.colorUtilities.hslToHex(t,e,i)}hexToRgba(t,e=1){const i=this.hexToRgb(t);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${e})`:`rgba(255, 255, 255, ${e})`}startColorTransition(t,e,i=1500){this.colorUtilities.currentColor=this.state.glowColor,this.colorUtilities.currentIntensity=this.state.glowIntensity,this.colorUtilities.startColorTransition(t,e,i),this.colorTransition=this.colorUtilities.colorTransition}updateColorTransition(t){const e=this.colorUtilities.updateColorTransition(t);e&&(this.state.glowColor=e.color,this.state.glowIntensity=e.intensity,this.colorTransition=this.colorUtilities.colorTransition)}updateUndertone(t){this.emotionalStateManager.updateUndertone(t)}setEmotionalState(t,e,i=null){this.emotionalStateManager.setEmotionalState(t,e,i)}setBPM(t){}setRotationSpeed(t){this.rotationManager.setRotationSpeed(t)}setRotationAngle(t){this.rotationManager.setRotationAngle(t)}setGazeOffset(t){"object"==typeof t&&null!==t&&({}.hasOwnProperty.call(t,"x")&&{}.hasOwnProperty.call(t,"y")?this.state.gazeOffset=t:(this.state.gazeOffset=t.offset||{x:0,y:0},this.state.gazeIntensity=t.proximity||0,this.state.gazeLocked=t.isLocked||!1)),this.idleTimer=0,this.isAsleep&&this.wakeUp()}getCurrentOrbPosition(){const t=this.canvasManager.width/2,e=this.canvasManager.height/2-this.config.topOffset;return{x:t+this.state.gazeOffset.x,y:e+this.state.gazeOffset.y}}setCustomScale(t){this.state.customScale=t}startSpeaking(){this.state.speaking=!0,this.speakingRings=[],this.ringSpawnTimer=0}stopSpeaking(){this.state.speaking=!1,this.speakingRings=[]}enterSleepMode(){this.sleepManager.enterSleepMode()}wakeUp(){this.sleepManager.wakeUp()}enterZenMode(t,e){this.zenModeController.enterZenMode(t,e)}exitZenMode(t,e,i){this.zenModeController.exitZenMode(t,e,i)}startRecording(){this.state.recording=!0}stopRecording(){this.state.recording=!1}setBlinkingEnabled(t){this.state.blinkingEnabled=t,t||(this.state.blinking=!1,this.eyeRenderer.blinking=!1,this.eyeRenderer.blinkTimer=0)}setGazeTracking(t){this.gazeTracker.setEnabled(t)}initGazeTracking(){this.gazeTracker.initialize()}cleanupGazeTracking(){this.gazeTracker.cleanup()}resetCanvasContext(){if(!this.canvas||!this.ctx)return;const{width:t}=this.canvas,{height:e}=this.canvas;this.ctx.setTransform(1,0,0,1,0,0),this.ctx.globalAlpha=1,this.ctx.globalCompositeOperation="source-over",this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.ctx.clearRect(0,0,t,e),this.offscreenCanvas&&this.offscreenCtx&&(this.offscreenCtx.setTransform(1,0,0,1,0,0),this.offscreenCtx.globalAlpha=1,this.offscreenCtx.globalCompositeOperation="source-over",this.offscreenCtx.imageSmoothingEnabled=!0,this.offscreenCtx.imageSmoothingQuality="high",this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)),this.contextStateManager&&this.contextStateManager.reset(),this.forceCleanRender=!0}setQualityLevel(t){this.qualityLevel=Math.max(0,Math.min(1,t)),this.qualityLevel<.5?(this.ctx.imageSmoothingEnabled=!1,this.state.breathDepth*=.5):this.qualityLevel<.8?(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="medium"):(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high")}setQualityReduction(t){t?this.setQualityLevel(.5):this.setQualityLevel(1)}handleContextRecovery(t){this.ctx=t}getUndertoneModifier(){return this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers?this.stateMachine.getWeightedUndertoneModifiers():this.currentUndertone&&this.undertoneModifiers[this.currentUndertone]?this.undertoneModifiers[this.currentUndertone]:null}applyGestureAnimations(){return this.gestureAnimator.applyGestureAnimations()}startGesture(t){return this.gestureAnimator.startGesture(t)}getCurrentGesture(){return this.gestureAnimator.getCurrentGesture()}A(){["Bounce","Pulse","Shake","Spin","Nod","Tilt","Expand","Contract","Flash","Drift","Stretch","Glow","Flicker","Vibrate","Orbital","Hula","Wave","Breathe","Morph","SlowBlink","Look","Settle","BreathIn","BreathOut","BreathHold","BreathHoldEmpty","Jump","Sway","Float","Rain","RunningMan","Charleston","Sparkle","Shimmer","Wiggle","Groove","Point","Lean","Reach","HeadBob","Orbit"].forEach(t=>{const e=`start${t}`;this[e]=()=>this.gestureAnimator[e]()})}startGrooveSway(t){this.ambientDanceAnimator.startAmbientAnimation("grooveSway",t)}startGrooveBob(t){this.ambientDanceAnimator.startAmbientAnimation("grooveBob",t)}startGrooveFlow(t){this.ambientDanceAnimator.startAmbientAnimation("grooveFlow",t)}startGroovePulse(t){this.ambientDanceAnimator.startAmbientAnimation("groovePulse",t)}startGrooveStep(t){this.ambientDanceAnimator.startAmbientAnimation("grooveStep",t)}stopAllGestures(){this.gestureAnimator.stopAllGestures(),this.currentGesture=null}isGestureActive(){return Object.values(this.gestureAnimator.gestureAnimations).some(t=>t.active)}destroy(){for(const t in this.animationFrameIds)this.animationFrameIds[t]&&(cancelAnimationFrame(this.animationFrameIds[t]),this.animationFrameIds[t]=null);for(const t in this.loopCallbackIds)this.loopCallbackIds[t]&&(ai.unregister(this.loopCallbackIds[t]),this.loopCallbackIds[t]=null);this.sleepManager&&this.sleepManager.cleanup(),this.gazeTracker&&this.gazeTracker.cleanup(),this.wakeJitterTimeout&&(clearTimeout(this.wakeJitterTimeout),this.wakeJitterTimeout=null),this.colorTransition.active=!1,this.zenTransition&&(this.zenTransition.active=!1),this.cleanupGazeTracking(),this.speakingRings=[],this.gestureCompositor&&this.gestureCompositor.clearCache(),this.specialEffects&&this.specialEffects.destroy()}}class Mi{constructor(t,e={}){this.canvas=t,this.config={smoothing:e.smoothing||.1,maxOffset:e.maxOffset||.3,lockDistance:e.lockDistance||30,enabled:!1!==e.enabled,boundaryPadding:e.boundaryPadding||.8},this.canvasCenter={x:0,y:0},this.mousePos={x:0,y:0},this.targetGaze={x:0,y:0},this.currentGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.cachedRect=null,this.touches=new Map,this.primaryTouch=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.onInteraction=null,this.updateCanvasCenter(),this.attachEventListeners(),this.resizeObserver=new ResizeObserver(()=>{this.updateCanvasCenter()}),this.resizeObserver.observe(this.canvas)}updateCanvasCenter(){this.cachedRect=this.canvas.getBoundingClientRect(),this.canvasCenter={x:this.cachedRect.width/2,y:this.cachedRect.height/2},0===this.mousePos.x&&0===this.mousePos.y&&(this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y})}attachEventListeners(){this.config.enabled&&(this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseleave",this.handleMouseLeave),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!0}),this.canvas.addEventListener("touchcancel",this.handleTouchEnd,{passive:!0}))}handleMouseMove(t){const e=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:t.clientX-e.left,y:t.clientY-e.top},this.updateTargetGaze(),this.onInteraction&&this.onInteraction("mouse")}handleMouseLeave(){this.targetGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y}}handleTouchStart(t){for(const e of t.changedTouches)this.touches.set(e.identifier,{x:e.clientX,y:e.clientY}),this.primaryTouch||1!==this.touches.size||(this.primaryTouch=e.identifier);null!==this.primaryTouch&&this.updateTouchPosition(t.touches)}handleTouchMove(t){for(const e of t.changedTouches)this.touches.has(e.identifier)&&this.touches.set(e.identifier,{x:e.clientX,y:e.clientY});null!==this.primaryTouch&&(this.updateTouchPosition(t.touches),this.onInteraction&&this.onInteraction("touch"))}handleTouchEnd(t){for(const e of t.changedTouches)this.touches.delete(e.identifier),e.identifier===this.primaryTouch&&(this.primaryTouch=null,this.touches.size>0?this.primaryTouch=this.touches.keys().next().value:this.handleMouseLeave())}updateTouchPosition(t){for(const e of t)if(e.identifier===this.primaryTouch){const t=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:e.clientX-t.left,y:e.clientY-t.top},this.updateTargetGaze();break}}updateTargetGaze(){const t=this.mousePos.x-this.canvasCenter.x,e=this.mousePos.y-this.canvasCenter.y,i=Math.sqrt(t*t+e*e),s=Math.min(this.canvasCenter.x,this.canvasCenter.y);if(this.proximity=Math.max(0,1-i/s),this.isLocked=i<this.config.lockDistance,this.isLocked)this.targetGaze={x:t*this.config.maxOffset*2,y:e*this.config.maxOffset*2};else{const n=Math.min(this.canvasCenter.x,this.canvasCenter.y)*this.config.maxOffset;if(i>0){const r=Math.min(1,i/s);this.targetGaze={x:t/i*n*r*this.config.boundaryPadding,y:e/i*n*r*this.config.boundaryPadding}}else this.targetGaze={x:0,y:0}}}update(t){if(!this.config.enabled)return;const e=1-Math.pow(1-this.config.smoothing,t/16.67);if(this.currentGaze.x+=(this.targetGaze.x-this.currentGaze.x)*e,this.currentGaze.y+=(this.targetGaze.y-this.currentGaze.y)*e,this.isLocked){const t=.5;this.currentGaze.x+=(Math.random()-.5)*t,this.currentGaze.y+=(Math.random()-.5)*t}}getGazeOffset(t){return{x:this.currentGaze.x,y:this.currentGaze.y}}getState(){return{gaze:{...this.currentGaze},target:{...this.targetGaze},proximity:this.proximity,isLocked:this.isLocked,isActive:this.config.enabled}}enable(){this.config.enabled||(this.config.enabled=!0,this.attachEventListeners())}disable(){this.config.enabled&&(this.config.enabled=!1,this.detachEventListeners(),this.targetGaze={x:0,y:0})}detachEventListeners(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseleave",this.handleMouseLeave),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("touchcancel",this.handleTouchEnd)}setInteractionCallback(t){this.onInteraction=t}destroy(){this.detachEventListeners(),this.resizeObserver&&this.resizeObserver.disconnect(),this.touches.clear()}}class Si{constructor(t={}){this.config={blinkInterval:t.blinkInterval||{min:3e3,max:7e3},blinkDuration:t.blinkDuration||150,swayInterval:t.swayInterval||{min:2e4,max:4e4},swayDuration:t.swayDuration||4e3,swayIntensity:t.swayIntensity||1.5,sleepTimeout:void 0!==t.sleepTimeout?t.sleepTimeout:1/0,breathingSpeed:t.breathingSpeed||.25,breathingDepth:t.breathingDepth||.1,enabled:!1!==t.enabled},this.state={isBlinking:!1,isSwaying:!1,isAsleep:!1,breathingPhase:0,breathRate:1,breathDepth:this.config.breathingDepth},this.timers={idle:0,blink:0,sway:0,swayProgress:0,nextBlink:this.getRandomInterval("blink"),nextSway:this.getRandomInterval("sway")},this.swayOffset={x:0,y:0},this.swayTarget={x:0,y:0},this.swayStart={x:0,y:0},this.wakeUpTimeout=null,this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}update(t){this.config.enabled&&(this.updateBreathing(t),this.timers.idle+=t,!this.state.isAsleep&&this.timers.idle>=this.config.sleepTimeout&&this.enterSleep(),this.state.isAsleep||this.updateBlinking(t),this.state.isAsleep||this.updateSwaying(t))}updateBreathing(t){const e=this.config.breathingSpeed*this.state.breathRate;this.state.breathingPhase+=e*t/1e3,this.state.breathingPhase>2*Math.PI&&(this.state.breathingPhase-=2*Math.PI)}updateBlinking(t){this.isBlinkingEnabled()&&(this.state.isBlinking?(this.timers.blink+=t,this.timers.blink>=this.config.blinkDuration&&this.endBlink()):(this.timers.blink+=t,this.timers.blink>=this.timers.nextBlink&&this.startBlink()))}updateSwaying(t){if(this.state.isSwaying){this.timers.sway+=t;const e=Math.min(this.timers.sway/this.config.swayDuration,1),i=(Math.sin((e-.5)*Math.PI)+1)/2;this.swayOffset.x=this.swayStart.x+(this.swayTarget.x-this.swayStart.x)*i,this.swayOffset.y=this.swayStart.y+(this.swayTarget.y-this.swayStart.y)*i,e>=1&&this.endSway()}else this.timers.sway+=t,this.timers.sway>=this.timers.nextSway&&this.startSway()}startBlink(){this.state.isBlinking=!0,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"start"})}endBlink(){this.state.isBlinking=!1,this.timers.blink=0,this.timers.nextBlink=this.getRandomInterval("blink"),this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})}startSway(){this.state.isSwaying=!0,this.timers.sway=0,this.swayStart={...this.swayOffset};const t=Math.random()*Math.PI*2,e=this.config.swayIntensity*(.5+.5*Math.random());this.swayTarget={x:Math.cos(t)*e*1.5,y:Math.sin(t)*e*.5},this.callbacks.onSway&&this.callbacks.onSway({phase:"start",offset:this.swayOffset})}endSway(){this.state.isSwaying=!1,this.timers.sway=0,this.timers.nextSway=this.getRandomInterval("sway"),this.swayStart={...this.swayOffset},this.callbacks.onSway&&this.callbacks.onSway({phase:"end",offset:this.swayOffset})}enterSleep(){this.state.isAsleep=!0,this.state.breathRate=.5,this.state.breathDepth=.15,this.state.isBlinking&&(this.state.isBlinking=!1,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})),this.callbacks.onSleep&&this.callbacks.onSleep()}wakeUp(){this.state.isAsleep&&(this.state.isAsleep=!1,this.state.breathRate=1,this.state.breathDepth=this.config.breathingDepth,this.timers.idle=0,this.callbacks.onWake&&this.callbacks.onWake(),this.performWakeAnimation())}performWakeAnimation(){const t={x:.5*this.config.swayIntensity,y:-this.config.swayIntensity};this.swayStart={...this.swayOffset},this.swayTarget=t,this.state.isSwaying=!0,this.timers.sway=0,this.callbacks.onSway&&this.callbacks.onSway({phase:"wake",offset:this.swayOffset}),this.wakeUpTimeout&&clearTimeout(this.wakeUpTimeout),this.wakeUpTimeout=setTimeout(()=>{this.swayStart={...this.swayOffset},this.swayTarget={x:0,y:0},this.timers.sway=0,this.wakeUpTimeout=null},1e3)}resetIdleTimer(){this.timers.idle=0,this.state.isAsleep&&this.wakeUp()}setBlinkingEnabled(t){this.config.blinkingEnabled=t,!t&&this.state.isBlinking&&this.endBlink()}isBlinkingEnabled(){return!1!==this.config.blinkingEnabled}getBreathingFactor(){return 1+Math.sin(this.state.breathingPhase)*this.state.breathDepth*this.state.breathRate}getBlinkProgress(){return this.state.isBlinking?Math.min(this.timers.blink/this.config.blinkDuration,1):0}getSwayOffset(){return this.swayOffset||{x:0,y:0}}getRandomInterval(t){const e=this.config[`${t}Interval`];return e.min+Math.random()*(e.max-e.min)}setCallback(t,e){({}).hasOwnProperty.call(this.callbacks,t)&&(this.callbacks[t]=e)}getState(){return{...this.state,breathingFactor:this.getBreathingFactor(),blinkProgress:this.getBlinkProgress(),swayOffset:this.getSwayOffset()}}enable(){this.config.enabled=!0}disable(){this.config.enabled=!1,this.state.isBlinking=!1,this.state.isSwaying=!1,this.swayOffset={x:0,y:0}}destroy(){this.wakeUpTimeout&&(clearTimeout(this.wakeUpTimeout),this.wakeUpTimeout=null),this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}}class ki{constructor(t){this.positionController=t,this.watchedElements=new Map,this.updateCallbacks=new Map}moveToElement(t,e="right",i={x:20,y:0},s={}){const n=document.querySelector(t);if(!n)return;const r=n.getBoundingClientRect(),o=r.left+r.width/2,a=r.top+r.height/2;let h,c;switch(e){case"right":default:h=r.right+i.x,c=a+i.y;break;case"left":h=r.left-i.x,c=a+i.y;break;case"above":h=o+i.x,c=r.top-i.y;break;case"below":h=o+i.x,c=r.bottom+i.y;break;case"center":h=o+i.x,c=a+i.y}const u=h-window.innerWidth/2,l=c-window.innerHeight/2;!1!==s.animate?this.positionController.animateOffset(u,l,0,s.duration||1e3,s.easing||"easeOutCubic"):this.positionController.setOffset(u,l,0)}moveToButton(t="button",e="right",i={x:20,y:0}){this.moveToElement(t,e,i)}moveToForm(t="form",e="right",i={x:20,y:0}){this.moveToElement(t,e,i)}moveToModal(t='[role="dialog"], .modal',e="center",i={x:0,y:0}){this.moveToElement(t,e,i)}moveToNavigation(t="nav, .navigation",e="below",i={x:0,y:20}){this.moveToElement(t,e,i)}moveToContent(t="main, .content",e="center",i={x:0,y:0}){this.moveToElement(t,e,i)}moveToSidebar(t=".sidebar, aside",e="right",i={x:20,y:0}){this.moveToElement(t,e,i)}moveToHeader(t="header, .header",e="below",i={x:0,y:20}){this.moveToElement(t,e,i)}moveToFooter(t="footer, .footer",e="above",i={x:0,y:20}){this.moveToElement(t,e,i)}watchElement(t,e="right",i={x:20,y:0}){const s=()=>{this.moveToElement(t,e,i,{animate:!1})},n=`${t}-${e}-${JSON.stringify(i)}`;return this.updateCallbacks.set(n,s),window.addEventListener("scroll",s),window.addEventListener("resize",s),s(),()=>{window.removeEventListener("scroll",s),window.removeEventListener("resize",s),this.updateCallbacks.delete(n)}}stopWatchingAll(){this.updateCallbacks.forEach(t=>{window.removeEventListener("scroll",t),window.removeEventListener("resize",t)}),this.updateCallbacks.clear()}destroy(){this.stopWatchingAll(),this.positionController=null}}class xi extends ki{constructor(t){super(t),this.activeCallbacks=new Map,this.callbackStates=new Map}moveToElementWithCallback(t,e,i="right",s={x:20,y:0},n={}){const r=`callback-${Date.now()}-${Math.random()}`,o=document.querySelector(t);if(!o)return;this.callbackStates.set(r,{executed:!1,element:o,callback:e,options:n}),this.moveToElement(t,i,s,n);const a=()=>{if(this.isMascotNearElement(o,n.proximity||50)){const t=this.callbackStates.get(r);t&&!t.executed&&(t.executed=!0,e(),n.repeat||this.callbackStates.delete(r))}this.callbackStates.has(r)&&requestAnimationFrame(a)};return this.activeCallbacks.set(r,a),a(),()=>{this.activeCallbacks.delete(r),this.callbackStates.delete(r)}}moveToElementSequence(t=[],e={}){let i=0;const s=[],n=()=>{if(i>=t.length)return void(e.onComplete&&e.onComplete());const r=t[i],o=this.moveToElementWithCallback(r.selector,()=>{r.callback&&r.callback(),i++,setTimeout(n,r.delay||0)},r.position||"right",r.offset||{x:20,y:0},{...e,...r.options});o&&s.push(o)};return n(),()=>{s.forEach(t=>t())}}moveToElementWithDelay(t,e,i=1e3,s="right",n={x:20,y:0}){return this.moveToElementWithCallback(t,()=>{setTimeout(e,i)},s,n)}moveToElementWithCondition(t,e,i,s="right",n={x:20,y:0}){return this.moveToElementWithCallback(t,()=>{e()&&i()},s,n)}moveToElementWithRepeat(t,e,i=1e3,s="right",n={x:20,y:0}){return this.moveToElementWithCallback(t,()=>{setInterval(e,i)},s,n,{repeat:!0})}moveToElementWithProximity(t,e,i=100,s="right",n={x:20,y:0}){return this.moveToElementWithCallback(t,e,s,n,{proximity:i})}isMascotNearElement(t,e=50){if(!this.positionController||!t)return!1;const i=t.getBoundingClientRect(),s=i.left+i.width/2,n=i.top+i.height/2,r=this.positionController.getOffset(),o=r.x+window.innerWidth/2,a=r.y+window.innerHeight/2;return Math.sqrt(Math.pow(o-s,2)+Math.pow(a-n,2))<=e}stopAllCallbacks(){this.activeCallbacks.forEach((t,e)=>{this.activeCallbacks.delete(e)}),this.callbackStates.clear()}destroy(){this.stopAllCallbacks(),super.destroy()}}class Ti extends ki{constructor(t){super(t),this.activePaths=new Map,this.obstacles=new Set,this.audioContext=null,this.audioAnalyser=null,this.gazeTracker=null,this.activeRAFIds=new Set,this.activeSmoothAnimations=new Set}moveToElementWithPath(t,e=[],i="right",s={x:20,y:0},n={}){const r=`path-${Date.now()}-${Math.random()}`,o=document.querySelector(t);if(!o)return;const a=window.innerWidth||1,h=window.innerHeight||1,c=a/2,u=h/2,l=n.coordinateSystem||"auto",d=Array.isArray(e)?e.map((t={})=>{const e="number"==typeof t.x?t.x:0,i="number"==typeof t.y?t.y:0;return"relative"===l||"auto"===l&&e>=0&&e<=1&&i>=0&&i<=1?{x:e*a-c,y:i*h-u}:"offset"===l||"auto"===l&&Math.abs(e)<=c&&Math.abs(i)<=u?{x:e,y:i}:{x:e-c,y:i-u}}):[],p=o.getBoundingClientRect(),f={x:p.left+p.width/2+s.x-c,y:p.top+p.height/2+s.y-u},m=this.positionController.getOffset?this.positionController.getOffset():{x:0,y:0},g=[{x:"number"==typeof m.x?m.x:0,y:"number"==typeof m.y?m.y:0},...d,f];if(g.length<2)return this.positionController.setOffset(f.x,f.y,0),void("function"==typeof n.onComplete&&n.onComplete());const y=[],b=[0];let v=0;for(let t=0;t<g.length-1;t++){const e=g[t+1].x-g[t].x,i=g[t+1].y-g[t].y,s=Math.hypot(e,i);y.push(s),v+=s,b.push(v)}if(0===v)return this.positionController.setOffset(f.x,f.y,0),void("function"==typeof n.onComplete&&n.onComplete());const w="number"==typeof n.speed&&n.speed>0?n.speed:250,M=!0===n.loop,S=n.easing||"linear",k={covered:0,lastTimestamp:null},x=t=>{if(M)t%=v;else{if(t<=0)return g[0];if(t>=v)return g[g.length-1]}for(let e=0;e<y.length;e++){const i=b[e];if(t<=b[e+1]){const s=y[e]||1,n=0===s?0:(t-i)/s,r=this.positionController&&"function"==typeof this.positionController.applyEasing?this.positionController.applyEasing(n,S):n,o=g[e],a=g[e+1];return{x:o.x+(a.x-o.x)*r,y:o.y+(a.y-o.y)*r}}}return g[g.length-1]},T={stop:()=>{T.frameId&&cancelAnimationFrame(T.frameId),this.activePaths.delete(r)},frameId:null};this.activePaths.set(r,T),this.positionController.setOffset(g[0].x,g[0].y,0);const E=t=>{if(!this.activePaths.has(r))return;null===k.lastTimestamp&&(k.lastTimestamp=t);const e=t-k.lastTimestamp;if(k.lastTimestamp=t,k.covered+=w*(e/1e3),!M&&k.covered>=v)return this.positionController.setOffset(f.x,f.y,0),T.stop(),void("function"==typeof n.onComplete&&n.onComplete());const i=x(k.covered);this.positionController.setOffset(i.x,i.y,0),T.frameId=requestAnimationFrame(E)};return T.frameId=requestAnimationFrame(E),()=>{T.stop()}}moveToElementWithEasing(t,e,i=1e3,s="right",n={x:20,y:0}){const r=document.querySelector(t);if(!r)return;const o=r.getBoundingClientRect(),a=o.left+o.width/2+n.x-window.innerWidth/2,h=o.top+o.height/2+n.y-window.innerHeight/2,c=this.positionController.getOffset(),u=performance.now();let l=null;const d=t=>{const s=t-u,n=Math.min(s/i,1),r=e(n),o=c.x+(a-c.x)*r,p=c.y+(h-c.y)*r;this.positionController.setOffset(o,p,0),n<1?(l=requestAnimationFrame(d),this.activeSmoothAnimations.add(l)):null!==l&&this.activeSmoothAnimations.delete(l)};l=requestAnimationFrame(d),this.activeSmoothAnimations.add(l)}moveToElementWithCollision(t,e=[],i=100,s="right",n={x:20,y:0}){const r=document.querySelector(t);if(!r)return;const o=r.getBoundingClientRect(),a=o.left+o.width/2+n.x-window.innerWidth/2,h=o.top+o.height/2+n.y-window.innerHeight/2,c=this.positionController.getOffset();(()=>{let t=c.x,s=c.y;for(let n=0;n<=100;n++){const r=.01*n,o=c.x+(a-c.x)*r,u=c.y+(h-c.y)*r;let l=!1;e.forEach(e=>{let n,r;if("string"==typeof e){const t=document.querySelector(e);if(!t)return;{const e=t.getBoundingClientRect();n=e.left+e.width/2-window.innerWidth/2,r=e.top+e.height/2-window.innerHeight/2}}else n=e.x-window.innerWidth/2,r=e.y-window.innerHeight/2;if(Math.sqrt(Math.pow(o-n,2)+Math.pow(u-r,2))<i){l=!0;const e=Math.atan2(u-r,o-n),a=n+Math.cos(e)*i,h=r+Math.sin(e)*i;t=a,s=h}}),l||(t=o,s=u)}this.positionController.setOffset(t,s,0)})()}moveToElementWithAudio(t,e,i=50,s="right",n={x:20,y:0}){const r=document.querySelector(t);if(!r)return;this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=256),this.audioContext.createMediaStreamSource(e).connect(this.audioAnalyser);const o=new Uint8Array(this.audioAnalyser.frequencyBinCount),a=r.getBoundingClientRect(),h=a.left+a.width/2+n.x-window.innerWidth/2,c=a.top+a.height/2+n.y-window.innerHeight/2;let u=null;const l=()=>{this.audioAnalyser.getByteFrequencyData(o);let t=0;for(let e=0;e<o.length;e++)t+=o[e];const e=t/o.length/255*i,s=h+e,n=c+.5*e;this.positionController.setOffset(s,n,0),null!==u&&this.activeRAFIds.delete(u),u=requestAnimationFrame(l),this.activeRAFIds.add(u)};l()}moveToElementWithGaze(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;this.gazeTracker||(this.gazeTracker={x:window.innerWidth/2,y:window.innerHeight/2});const r=n.getBoundingClientRect(),o=r.left+r.width/2+s.x-window.innerWidth/2,a=r.top+r.height/2+s.y-window.innerHeight/2;let h=null;const c=()=>{const t=this.gazeTracker.x-window.innerWidth/2,i=this.gazeTracker.y-window.innerHeight/2,s=e.gazeWeight||.3,n=o+(t-o)*s,r=a+(i-a)*s;this.positionController.setOffset(n,r,0),null!==h&&this.activeRAFIds.delete(h),h=requestAnimationFrame(c),this.activeRAFIds.add(h)};c()}addObstacle(t){this.obstacles.add(t)}removeObstacle(t){this.obstacles.delete(t)}clearObstacles(){this.obstacles.clear()}destroy(){Array.from(this.activePaths.values()).forEach(t=>{t&&"function"==typeof t.stop?t.stop():t&&t.frameId&&cancelAnimationFrame(t.frameId)}),this.activePaths.clear(),this.activeRAFIds.forEach(t=>{cancelAnimationFrame(t)}),this.activeRAFIds.clear(),this.activeSmoothAnimations.forEach(t=>{cancelAnimationFrame(t)}),this.activeSmoothAnimations.clear(),this.obstacles.clear(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioAnalyser=null,this.gazeTracker=null,super.destroy()}}class Ei extends ki{constructor(t){super(t),this.scrollCallbacks=new Map,this.physicsSimulations=new Map,this.responsiveBreakpoints={mobile:768,tablet:1024,desktop:1200},this.currentBreakpoint=this.getCurrentBreakpoint(),this.accessibilityEnabled=!1}moveToElementWithScroll(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`scroll-${Date.now()}-${Math.random()}`,{startScroll:o=50,endScroll:a=300,onProgress:h=null,onStart:c=null,onComplete:u=null}=e;let l=!1,d=!1;const p=()=>{const{scrollY:t}=window,e=Math.min(Math.max((t-o)/(a-o),0),1);e>0&&!l&&(l=!0,c&&c()),e>=1&&!d&&(d=!0,u&&u());const i=n.getBoundingClientRect(),r=i.left+i.width/2+s.x-window.innerWidth/2,p=i.top+i.height/2+s.y-window.innerHeight/2,f=window.innerWidth>1024,m=f?.25*window.innerWidth:.33*window.innerWidth-50,g=f?-.25*window.innerHeight-50+.15*window.innerHeight:-.35*window.innerHeight-50+.08*window.innerHeight,y=m+(r-m)*e,b=g+(p-g)*e;this.positionController.setOffset(y,b,0),h&&h(e,{scrollY:t,currentX:y,currentY:b})};return this.scrollCallbacks.set(r,p),window.addEventListener("scroll",p),p(),()=>{this.scrollCallbacks.delete(r),window.removeEventListener("scroll",p)}}moveToElementWithPhysics(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`physics-${Date.now()}-${Math.random()}`,{mass:o=1,damping:a=.98,springConstant:h=.1,maxVelocity:c=10,onUpdate:u=null}=e,l=n.getBoundingClientRect(),d=l.left+l.width/2+s.x-window.innerWidth/2,p=l.top+l.height/2+s.y-window.innerHeight/2,f=this.positionController.getOffset();let m=f.x,g=f.y,y=0,b=0;const v=()=>{y+=(d-m)*h/o,b+=(p-g)*h/o,y*=a,b*=a;const t=Math.sqrt(y*y+b*b);t>c&&(y=y/t*c,b=b/t*c),m+=y,g+=b,this.positionController.setOffset(m,g,0),u&&u({positionX:m,positionY:g,velocityX:y,velocityY:b}),this.physicsSimulations.has(r)&&requestAnimationFrame(v)};return this.physicsSimulations.set(r,v),v(),()=>{this.physicsSimulations.delete(r)}}moveToElementWithGroup(t=[],e="center",i={x:0,y:0}){if(0===t.length)return;let s=0,n=0,r=0,o=0,a=0;if(t.forEach(t=>{const e=document.querySelector(t);if(e){const t=e.getBoundingClientRect();s+=t.left,n+=t.top,r=Math.max(r,t.left+t.width),o=Math.max(o,t.top+t.height),a++}}),0===a)return;const h=s/a,c=n/a;let u,l;switch(e){case"center":default:u=h+i.x-window.innerWidth/2,l=c+i.y-window.innerHeight/2;break;case"left":u=s+i.x-window.innerWidth/2,l=c+i.y-window.innerHeight/2;break;case"right":u=r+i.x-window.innerWidth/2,l=c+i.y-window.innerHeight/2;break;case"top":u=h+i.x-window.innerWidth/2,l=n+i.y-window.innerHeight/2;break;case"bottom":u=h+i.x-window.innerWidth/2,l=o+i.y-window.innerHeight/2}this.positionController.setOffset(u,l,0)}moveToElementWithResponsive(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=()=>{const t=this.getCurrentBreakpoint(),i=e[t]||e.default||{},r=n.getBoundingClientRect(),o=r.left+r.width/2+(i.offsetX||s.x)-window.innerWidth/2,a=r.top+r.height/2+(i.offsetY||s.y)-window.innerHeight/2;this.positionController.setOffset(o,a,0)},o=()=>{const t=this.getCurrentBreakpoint();t!==this.currentBreakpoint&&(this.currentBreakpoint=t,r())};return window.addEventListener("resize",o),r(),()=>{window.removeEventListener("resize",o)}}moveToElementWithAccessibility(t,e={},i="right",s={x:20,y:0}){if(!document.querySelector(t))return;const{announce:n=!0,announcements:r=[],screenReaderPosition:o="bottom-right"}=e;let a,h;switch(o){case"bottom-right":default:a=window.innerWidth-100-window.innerWidth/2,h=window.innerHeight-100-window.innerHeight/2;break;case"bottom-left":a=100-window.innerWidth/2,h=window.innerHeight-100-window.innerHeight/2;break;case"top-right":a=window.innerWidth-100-window.innerWidth/2,h=100-window.innerHeight/2;break;case"top-left":a=100-window.innerWidth/2,h=100-window.innerHeight/2}this.positionController.setOffset(a,h,0),n&&window.speechSynthesis&&r.forEach(t=>{if(t.condition&&t.condition()){const e=new SpeechSynthesisUtterance(t.text);e.volume=.5,e.rate=.8,window.speechSynthesis.speak(e)}})}getCurrentBreakpoint(){const t=window.innerWidth;return t<this.responsiveBreakpoints.mobile?"mobile":t<this.responsiveBreakpoints.tablet?"tablet":t<this.responsiveBreakpoints.desktop?"desktop":"large"}setBreakpoints(t){this.responsiveBreakpoints={...this.responsiveBreakpoints,...t},this.currentBreakpoint=this.getCurrentBreakpoint()}enableAccessibility(){this.accessibilityEnabled=!0}disableAccessibility(){this.accessibilityEnabled=!1}destroy(){this.scrollCallbacks.forEach((t,e)=>{window.removeEventListener("scroll",t)}),this.scrollCallbacks.clear(),this.physicsSimulations.clear(),super.destroy()}}class Ci extends ki{constructor(t){super(t),this.activeInteractions=new Map,this.hoverStates=new Map,this.clickStates=new Map,this.touchStates=new Map}moveToElementWithHover(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`hover-${Date.now()}-${Math.random()}`,{onMouseEnter:o=null,onMouseLeave:a=null,onHover:h=null,followMouse:c=!1,hoverDistance:u=50}=e;let l=!1,d=0,p=0;const f=t=>{l=!0,o&&o(t)},m=t=>{l=!1,a&&a(t)},g=t=>{if(d=t.clientX,p=t.clientY,l&&h&&h(t),c&&l){const t=n.getBoundingClientRect(),e=t.left+t.width/2,i=t.top+t.height/2;if(Math.sqrt(Math.pow(d-e,2)+Math.pow(p-i,2))<=u){const t=d+s.x-window.innerWidth/2,e=p+s.y-window.innerHeight/2;this.positionController.setOffset(t,e,0)}}};return n.addEventListener("mouseenter",f),n.addEventListener("mouseleave",m),n.addEventListener("mousemove",g),this.activeInteractions.set(r,{element:n,events:[{event:"mouseenter",handler:f},{event:"mouseleave",handler:m},{event:"mousemove",handler:g}]}),()=>{const t=this.activeInteractions.get(r);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(r))}}moveToElementWithClick(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`click-${Date.now()}-${Math.random()}`,{onClick:o=null,onDoubleClick:a=null,maxClicks:h=3}=e;let c=0;const u=t=>{if(c++,o&&o(t,c),c>=h){const t=n.getBoundingClientRect(),e=t.left+t.width/2+s.x-window.innerWidth/2,i=t.top+t.height/2+s.y-window.innerHeight/2;this.positionController.setOffset(e,i,0)}},l=t=>{a&&a(t)};return n.addEventListener("click",u),n.addEventListener("dblclick",l),this.activeInteractions.set(r,{element:n,events:[{event:"click",handler:u},{event:"dblclick",handler:l}]}),()=>{const t=this.activeInteractions.get(r);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(r))}}moveToElementWithTouch(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`touch-${Date.now()}-${Math.random()}`,{onTouchStart:o=null,onTouchMove:a=null,onTouchEnd:h=null,onSwipe:c=null,swipeThreshold:u=50}=e;let l=0,d=0,p=0,f=0;const m=t=>{t.touches.length>0&&(l=t.touches[0].clientX,d=t.touches[0].clientY,o&&o(t))},g=t=>{if(t.touches.length>0){const e=t.touches[0].clientX,i=t.touches[0].clientY;a&&a(t);const n=e+s.x-window.innerWidth/2,r=i+s.y-window.innerHeight/2;this.positionController.setOffset(n,r,0)}},y=t=>{if(t.changedTouches.length>0){p=t.changedTouches[0].clientX,f=t.changedTouches[0].clientY,h&&h(t);const e=p-l,i=f-d,s=Math.sqrt(e*e+i*i);if(s>u&&c){const t=Math.abs(e)>Math.abs(i)?e>0?"right":"left":i>0?"down":"up";c(t,s)}}};return n.addEventListener("touchstart",m),n.addEventListener("touchmove",g),n.addEventListener("touchend",y),this.activeInteractions.set(r,{element:n,events:[{event:"touchstart",handler:m},{event:"touchmove",handler:g},{event:"touchend",handler:y}]}),()=>{const t=this.activeInteractions.get(r);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(r))}}moveToElementWithFocus(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`focus-${Date.now()}-${Math.random()}`,{onFocus:o=null,onBlur:a=null,onFocusIn:h=null,onFocusOut:c=null}=e,u=t=>{o&&o(t);const e=n.getBoundingClientRect(),i=e.left+e.width/2+s.x-window.innerWidth/2,r=e.top+e.height/2+s.y-window.innerHeight/2;this.positionController.setOffset(i,r,0)},l=t=>{a&&a(t)},d=t=>{h&&h(t)},p=t=>{c&&c(t)};return n.addEventListener("focus",u),n.addEventListener("blur",l),n.addEventListener("focusin",d),n.addEventListener("focusout",p),this.activeInteractions.set(r,{element:n,events:[{event:"focus",handler:u},{event:"blur",handler:l},{event:"focusin",handler:d},{event:"focusout",handler:p}]}),()=>{const t=this.activeInteractions.get(r);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(r))}}moveToElementWithKeyboard(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`keyboard-${Date.now()}-${Math.random()}`,{onKeyDown:o=null,onKeyUp:a=null,onKeyPress:h=null,targetKeys:c=["Enter","Space"]}=e,u=t=>{if(o&&o(t),c.includes(t.key)){const t=n.getBoundingClientRect(),e=t.left+t.width/2+s.x-window.innerWidth/2,i=t.top+t.height/2+s.y-window.innerHeight/2;this.positionController.setOffset(e,i,0)}},l=t=>{a&&a(t)},d=t=>{h&&h(t)};return n.addEventListener("keydown",u),n.addEventListener("keyup",l),n.addEventListener("keypress",d),this.activeInteractions.set(r,{element:n,events:[{event:"keydown",handler:u},{event:"keyup",handler:l},{event:"keypress",handler:d}]}),()=>{const t=this.activeInteractions.get(r);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(r))}}stopAllInteractions(){this.activeInteractions.forEach((t,e)=>{t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.activeInteractions.delete(e)}),this.hoverStates.clear(),this.clickStates.clear(),this.touchStates.clear()}destroy(){this.stopAllInteractions(),super.destroy()}}class Ai extends ki{constructor(t){super(t),this.activeAnimations=new Map,this.animationQueue=[],this.isAnimating=!1}moveToElementWithBounce(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`bounce-${Date.now()}-${Math.random()}`,{duration:o=1e3,intensity:a=50,bounces:h=3,onComplete:c=null}=e,u=n.getBoundingClientRect(),l=u.left+u.width/2+s.x-window.innerWidth/2,d=u.top+u.height/2+s.y-window.innerHeight/2,p=this.positionController.getOffset(),f=performance.now(),m=t=>{const e=t-f,i=Math.min(e/o,1),s=1-Math.pow(1-i,3),n=Math.sin(s*Math.PI*h)*a*(1-i),u=p.x+(l-p.x)*i,g=p.y+(d-p.y)*i+n;this.positionController.setOffset(u,g,0),i<1?(this.activeAnimations.set(r,m),requestAnimationFrame(m)):(this.activeAnimations.delete(r),c&&c())};return this.activeAnimations.set(r,m),requestAnimationFrame(m),()=>{this.activeAnimations.delete(r)}}moveToElementWithShake(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`shake-${Date.now()}-${Math.random()}`,{duration:o=500,intensity:a=10,frequency:h=20,onComplete:c=null}=e,u=n.getBoundingClientRect(),l=u.left+u.width/2+s.x-window.innerWidth/2,d=u.top+u.height/2+s.y-window.innerHeight/2,p=performance.now(),f=t=>{const e=t-p,i=Math.min(e/o,1),s=(Math.random()-.5)*a*(1-i),n=(Math.random()-.5)*a*(1-i),u=l+s,m=d+n;this.positionController.setOffset(u,m,0),i<1?(this.activeAnimations.set(r,f),setTimeout(()=>requestAnimationFrame(f),1e3/h)):(this.activeAnimations.delete(r),c&&c())};return this.activeAnimations.set(r,f),requestAnimationFrame(f),()=>{this.activeAnimations.delete(r)}}moveToElementWithPulse(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`pulse-${Date.now()}-${Math.random()}`,{duration:o=2e3,intensity:a=20,frequency:h=2,onComplete:c=null}=e,u=n.getBoundingClientRect(),l=u.left+u.width/2+s.x-window.innerWidth/2,d=u.top+u.height/2+s.y-window.innerHeight/2,p=performance.now(),f=t=>{const e=t-p,i=Math.min(e/o,1),s=Math.sin(e*h*.01)*a*(1-i),n=l+s,u=d+s;this.positionController.setOffset(n,u,0),i<1?(this.activeAnimations.set(r,f),requestAnimationFrame(f)):(this.activeAnimations.delete(r),c&&c())};return this.activeAnimations.set(r,f),requestAnimationFrame(f),()=>{this.activeAnimations.delete(r)}}moveToElementWithWiggle(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`wiggle-${Date.now()}-${Math.random()}`,{duration:o=1e3,intensity:a=15,frequency:h=8,onComplete:c=null}=e,u=n.getBoundingClientRect(),l=u.left+u.width/2+s.x-window.innerWidth/2,d=u.top+u.height/2+s.y-window.innerHeight/2,p=performance.now(),f=t=>{const e=t-p,i=Math.min(e/o,1),s=Math.sin(e*h*.01)*a*(1-i),n=Math.cos(e*h*.01)*a*(1-i),u=l+s,m=d+n;this.positionController.setOffset(u,m,0),i<1?(this.activeAnimations.set(r,f),requestAnimationFrame(f)):(this.activeAnimations.delete(r),c&&c())};return this.activeAnimations.set(r,f),requestAnimationFrame(f),()=>{this.activeAnimations.delete(r)}}moveToElementWithCustom(t,e,i={},s="right",n={x:20,y:0}){const r=document.querySelector(t);if(!r)return;const o=`custom-${Date.now()}-${Math.random()}`,{duration:a=1e3,onComplete:h=null}=i,c=r.getBoundingClientRect(),u=c.left+c.width/2+n.x-window.innerWidth/2,l=c.top+c.height/2+n.y-window.innerHeight/2,d=this.positionController.getOffset(),p=performance.now(),f=t=>{const i=t-p,s=Math.min(i/a,1),n=e(s,{elapsed:i,startOffset:d,targetX:u,targetY:l,currentTime:t});if(n&&"object"==typeof n){const t=void 0!==n.x?n.x:u,e=void 0!==n.y?n.y:l;this.positionController.setOffset(t,e,0)}s<1?(this.activeAnimations.set(o,f),requestAnimationFrame(f)):(this.activeAnimations.delete(o),h&&h())};return this.activeAnimations.set(o,f),requestAnimationFrame(f),()=>{this.activeAnimations.delete(o)}}queueAnimations(t=[]){this.animationQueue=[...this.animationQueue,...t],this.processAnimationQueue()}processAnimationQueue(){if(this.isAnimating||0===this.animationQueue.length)return;this.isAnimating=!0;const t=this.animationQueue.shift();if(t){const e=this.executeAnimation(t);e&&setTimeout(()=>{e(),this.isAnimating=!1,this.processAnimationQueue()},t.duration||1e3)}}executeAnimation(t){const{type:e,targetSelector:i,options:s={},position:n="right",offset:r={x:20,y:0}}=t;switch(e){case"bounce":return this.moveToElementWithBounce(i,s,n,r);case"shake":return this.moveToElementWithShake(i,s,n,r);case"pulse":return this.moveToElementWithPulse(i,s,n,r);case"wiggle":return this.moveToElementWithWiggle(i,s,n,r);case"custom":return this.moveToElementWithCustom(i,s.animationFunction,s,n,r);default:return this.moveToElement(i,n,r)}}stopAllAnimations(){this.activeAnimations.forEach((t,e)=>{this.activeAnimations.delete(e)}),this.animationQueue=[],this.isAnimating=!1}destroy(){this.stopAllAnimations(),super.destroy()}}class Ii extends ki{constructor(t){super(t),this.activeEffects=new Map,this.trailPoints=[],this.particles=[],this.effectCanvas=null,this.effectContext=null,this.maxTrailPoints=50,this.maxParticles=100}moveToElementWithTrail(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`trail-${Date.now()}-${Math.random()}`,{color:o="#00ff88",width:a=3,opacity:h=.8,fadeSpeed:c=.95,onComplete:u=null}=e;this.initializeEffectCanvas();const l=n.getBoundingClientRect(),d=l.left+l.width/2+s.x,p=l.top+l.height/2+s.y,f=this.positionController.getOffset(),m=f.x+window.innerWidth/2,g=f.y+window.innerHeight/2,y=performance.now(),b=t=>{const e=t-y,i=Math.min(e/1e3,1),s=m+(d-m)*i,n=g+(p-g)*i;this.trailPoints.push({x:s,y:n,opacity:h*(1-i),timestamp:t}),this.trailPoints.length>this.maxTrailPoints&&this.trailPoints.shift(),this.trailPoints.forEach(t=>{t.opacity*=c}),this.trailPoints=this.trailPoints.filter(t=>t.opacity>.01),this.drawTrail(o,a),this.positionController.setOffset(s-window.innerWidth/2,n-window.innerHeight/2,0),i<1?(this.activeEffects.set(r,b),requestAnimationFrame(b)):(this.activeEffects.delete(r),u&&u())};return this.activeEffects.set(r,b),requestAnimationFrame(b),()=>{this.activeEffects.delete(r)}}moveToElementWithParticles(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`particles-${Date.now()}-${Math.random()}`,{count:o=20,color:a="#00ff88",size:h=2,speed:c=2,life:u=1e3,onComplete:l=null}=e;this.initializeEffectCanvas();const d=n.getBoundingClientRect(),p=d.left+d.width/2+s.x,f=d.top+d.height/2+s.y,m=this.positionController.getOffset(),g=m.x+window.innerWidth/2,y=m.y+window.innerHeight/2,b=performance.now();for(let t=0;t<o;t++)this.particles.push({x:g,y:y,vx:(Math.random()-.5)*c,vy:(Math.random()-.5)*c,life:u,maxLife:u,color:a,size:h});const v=t=>{const e=t-b,i=Math.min(e/1e3,1);this.particles.forEach(t=>{t.x+=t.vx,t.y+=t.vy,t.life-=16,t.opacity=t.life/t.maxLife}),this.particles=this.particles.filter(t=>t.life>0),this.drawParticles();const s=g+(p-g)*i,n=y+(f-y)*i;this.positionController.setOffset(s-window.innerWidth/2,n-window.innerHeight/2,0),i<1||this.particles.length>0?(this.activeEffects.set(r,v),requestAnimationFrame(v)):(this.activeEffects.delete(r),l&&l())};return this.activeEffects.set(r,v),requestAnimationFrame(v),()=>{this.activeEffects.delete(r)}}moveToElementWithGlow(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const r=`glow-${Date.now()}-${Math.random()}`,{color:o="#00ff88",intensity:a=50,radius:h=100,duration:c=1e3,onComplete:u=null}=e;this.initializeEffectCanvas();const l=n.getBoundingClientRect(),d=l.left+l.width/2+s.x,p=l.top+l.height/2+s.y,f=this.positionController.getOffset(),m=f.x+window.innerWidth/2,g=f.y+window.innerHeight/2,y=performance.now(),b=t=>{const e=t-y,i=Math.min(e/c,1),s=m+(d-m)*i,n=g+(p-g)*i;this.drawGlow(s,n,o,a,h,i),this.positionController.setOffset(s-window.innerWidth/2,n-window.innerHeight/2,0),i<1?(this.activeEffects.set(r,b),requestAnimationFrame(b)):(this.activeEffects.delete(r),u&&u())};return this.activeEffects.set(r,b),requestAnimationFrame(b),()=>{this.activeEffects.delete(r)}}initializeEffectCanvas(){this.effectCanvas||(this.effectCanvas=document.createElement("canvas"),this.effectCanvas.style.position="fixed",this.effectCanvas.style.top="0",this.effectCanvas.style.left="0",this.effectCanvas.style.width="100%",this.effectCanvas.style.height="100%",this.effectCanvas.style.pointerEvents="none",this.effectCanvas.style.zIndex="1000",document.body.appendChild(this.effectCanvas),this.effectContext=this.effectCanvas.getContext("2d"),this.resizeEffectCanvas())}resizeEffectCanvas(){this.effectCanvas&&(this.effectCanvas.width=window.innerWidth,this.effectCanvas.height=window.innerHeight)}drawTrail(t,e){if(this.effectContext&&!(this.trailPoints.length<2)){this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height),this.effectContext.strokeStyle=t,this.effectContext.lineWidth=e,this.effectContext.lineCap="round",this.effectContext.lineJoin="round",this.effectContext.beginPath(),this.effectContext.moveTo(this.trailPoints[0].x,this.trailPoints[0].y);for(let t=1;t<this.trailPoints.length;t++){const e=this.trailPoints[t];this.effectContext.globalAlpha=e.opacity,this.effectContext.lineTo(e.x,e.y)}this.effectContext.stroke(),this.effectContext.globalAlpha=1}}drawParticles(){this.effectContext&&(this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height),this.particles.forEach(t=>{this.effectContext.globalAlpha=t.opacity,this.effectContext.fillStyle=t.color,this.effectContext.beginPath(),this.effectContext.arc(t.x,t.y,t.size,0,2*Math.PI),this.effectContext.fill()}),this.effectContext.globalAlpha=1)}drawGlow(t,e,i,s,n,r){if(!this.effectContext)return;this.effectContext.clearRect(0,0,this.effectCanvas.width,this.effectCanvas.height);const o=this.effectContext.createRadialGradient(t,e,0,t,e,n),a=Math.floor(s*r).toString(16).padStart(2,"0"),h=i.startsWith("#")?i:`#${i}`;o.addColorStop(0,`${h}${a}`),o.addColorStop(1,`${h}00`),this.effectContext.fillStyle=o,this.effectContext.beginPath(),this.effectContext.arc(t,e,n,0,2*Math.PI),this.effectContext.fill()}stopAllEffects(){this.activeEffects.forEach((t,e)=>{this.activeEffects.delete(e)}),this.trailPoints=[],this.particles=[]}destroy(){this.stopAllEffects(),this.effectCanvas&&(document.body.removeChild(this.effectCanvas),this.effectCanvas=null,this.effectContext=null),super.destroy()}}class Fi extends ki{constructor(t){super(t),this.accessibilityOptions={screenReader:!0,keyboardNavigation:!0,highContrast:!1,reducedMotion:!1,announcements:!0},this.announcements=[],this.keyboardListeners=new Map,this.focusableElements=new Set,this.currentFocusIndex=0,this.focusOrder=[]}moveToElementWithScreenReader(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const{announce:r=!0,announcement:o="Mascot moved to element",role:a="button",label:h=n.textContent||n.alt||"Interactive element"}=e;this.moveToElement(t,i,s),r&&this.accessibilityOptions.screenReader&&this.announceToScreenReader(o),n&&(n.setAttribute("role",a),n.setAttribute("aria-label",h),n.setAttribute("aria-live","polite"))}moveToElementWithKeyboard(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const{onKeyDown:r=null,onKeyUp:o=null,onEnter:a=null,onEscape:h=null,onArrowKeys:c=null}=e,u=`keyboard-${Date.now()}-${Math.random()}`,l=t=>{switch(r&&r(t),t.key){case"Enter":case" ":a&&a(t);break;case"Escape":h&&h(t);break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":c&&c(t)}},d=t=>{o&&o(t)};return n.hasAttribute("tabindex")||n.setAttribute("tabindex","0"),n.addEventListener("keydown",l),n.addEventListener("keyup",d),this.keyboardListeners.set(u,{element:n,events:[{event:"keydown",handler:l},{event:"keyup",handler:d}]}),this.moveToElement(t,i,s),()=>{const t=this.keyboardListeners.get(u);t&&(t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)}),this.keyboardListeners.delete(u))}}moveToElementWithHighContrast(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const{backgroundColor:r="#000000",textColor:o="#ffffff",borderColor:a="#ffffff",borderWidth:h=2}=e;this.accessibilityOptions.highContrast&&(n.style.backgroundColor=r,n.style.color=o,n.style.border=`${h}px solid ${a}`,n.style.outline=`${h}px solid ${a}`),this.moveToElement(t,i,s)}moveToElementWithReducedMotion(t,e={},i="right",s={x:20,y:0}){if(!document.querySelector(t))return;const{duration:n=0,easing:r="linear"}=e;window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.accessibilityOptions.reducedMotion?this.moveToElement(t,i,s):this.moveToElement(t,i,s,{duration:n,easing:r})}moveToElementWithFocus(t,e={},i="right",s={x:20,y:0}){const n=document.querySelector(t);if(!n)return;const{autoFocus:r=!1,focusRing:o=!0,focusOrder:a=[]}=e;a.length>0?this.focusOrder=a:this.focusOrder.includes(t)||this.focusOrder.push(t),n.hasAttribute("tabindex")||n.setAttribute("tabindex","0"),o&&(n.style.outline="2px solid #0066cc",n.style.outlineOffset="2px"),r&&n.focus(),this.moveToElement(t,i,s)}navigateFocus(t="next"){if(0===this.focusOrder.length)return;this.currentFocusIndex="next"===t?(this.currentFocusIndex+1)%this.focusOrder.length:(this.currentFocusIndex-1+this.focusOrder.length)%this.focusOrder.length;const e=this.focusOrder[this.currentFocusIndex],i=document.querySelector(e);i&&(i.focus(),this.moveToElement(e,"right",{x:20,y:0}))}announceToScreenReader(t){if(!this.accessibilityOptions.announcements)return;let e=document.getElementById("mascot-live-region");e||(e=document.createElement("div"),e.id="mascot-live-region",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.position="absolute",e.style.left="-10000px",e.style.width="1px",e.style.height="1px",e.style.overflow="hidden",document.body.appendChild(e)),e.textContent=t,setTimeout(()=>{e.textContent=""},1e3)}enableAccessibility(t={}){this.accessibilityOptions={...this.accessibilityOptions,...t}}disableAccessibility(t={}){Object.keys(t).forEach(t=>{({}).hasOwnProperty.call(this.accessibilityOptions,t)&&(this.accessibilityOptions[t]=!1)})}isAccessibilityEnabled(t){return this.accessibilityOptions[t]||!1}getAccessibilityOptions(){return{...this.accessibilityOptions}}destroy(){this.keyboardListeners.forEach((t,e)=>{t.events.forEach(({event:e,handler:i})=>{t.element.removeEventListener(e,i)})}),this.keyboardListeners.clear();const t=document.getElementById("mascot-live-region");t&&document.body.removeChild(t),this.focusOrder=[],this.currentFocusIndex=0,super.destroy()}}class _i{constructor(t){this.positionController=t,this.callbacks=new xi(t),this.advanced=new Ti(t),this.context=new Ei(t),this.interactions=new Ci(t),this.animations=new Ai(t),this.effects=new Ii(t),this.accessibility=new Fi(t)}moveToElementWithCallback(...t){return this.callbacks.moveToElementWithCallback(...t)}moveToElementSequence(...t){return this.callbacks.moveToElementSequence(...t)}moveToElementWithDelay(...t){return this.callbacks.moveToElementWithDelay(...t)}moveToElementWithCondition(...t){return this.callbacks.moveToElementWithCondition(...t)}moveToElementWithRepeat(...t){return this.callbacks.moveToElementWithRepeat(...t)}moveToElementWithProximity(...t){return this.callbacks.moveToElementWithProximity(...t)}moveToElementWithPath(...t){return this.advanced.moveToElementWithPath(...t)}moveToElementWithEasing(...t){return this.advanced.moveToElementWithEasing(...t)}moveToElementWithCollision(...t){return this.advanced.moveToElementWithCollision(...t)}moveToElementWithAudio(...t){return this.advanced.moveToElementWithAudio(...t)}moveToElementWithGaze(...t){return this.advanced.moveToElementWithGaze(...t)}moveToElementWithScroll(...t){return this.context.moveToElementWithScroll(...t)}moveToElementWithPhysics(...t){return this.context.moveToElementWithPhysics(...t)}moveToElementWithGroup(...t){return this.context.moveToElementWithGroup(...t)}moveToElementWithResponsive(...t){return this.context.moveToElementWithResponsive(...t)}moveToElementWithAccessibility(...t){return this.context.moveToElementWithAccessibility(...t)}moveToElementWithHover(...t){return this.interactions.moveToElementWithHover(...t)}moveToElementWithClick(...t){return this.interactions.moveToElementWithClick(...t)}moveToElementWithTouch(...t){return this.interactions.moveToElementWithTouch(...t)}moveToElementWithFocus(...t){return this.interactions.moveToElementWithFocus(...t)}moveToElementWithKeyboard(...t){return this.interactions.moveToElementWithKeyboard(...t)}moveToElementWithBounce(...t){return this.animations.moveToElementWithBounce(...t)}moveToElementWithShake(...t){return this.animations.moveToElementWithShake(...t)}moveToElementWithPulse(...t){return this.animations.moveToElementWithPulse(...t)}moveToElementWithWiggle(...t){return this.animations.moveToElementWithWiggle(...t)}moveToElementWithCustom(...t){return this.animations.moveToElementWithCustom(...t)}moveToElementWithTrail(...t){return this.effects.moveToElementWithTrail(...t)}moveToElementWithParticles(...t){return this.effects.moveToElementWithParticles(...t)}moveToElementWithGlow(...t){return this.effects.moveToElementWithGlow(...t)}moveToElementWithScreenReader(...t){return this.accessibility.moveToElementWithScreenReader(...t)}moveToElementWithKeyboardAccessible(...t){return this.accessibility.moveToElementWithKeyboard(...t)}moveToElementWithHighContrast(...t){return this.accessibility.moveToElementWithHighContrast(...t)}moveToElementWithReducedMotion(...t){return this.accessibility.moveToElementWithReducedMotion(...t)}moveToElementWithFocusAccessible(...t){return this.accessibility.moveToElementWithFocus(...t)}announceToScreenReader(...t){return this.accessibility.announceToScreenReader(...t)}navigateFocus(...t){return this.accessibility.navigateFocus(...t)}enableAccessibility(...t){return this.accessibility.enableAccessibility(...t)}disableAccessibility(...t){return this.accessibility.disableAccessibility(...t)}destroy(){this.callbacks.destroy(),this.advanced.destroy(),this.context.destroy(),this.interactions.destroy(),this.animations.destroy(),this.effects.destroy(),this.accessibility.destroy()}}class Ri{constructor(t){this.positionController=t,this.isTracking=!1,this.trackingCallbacks=new Map,this.audioContext=null,this.audioAnalyser=null,this.audioData=null}moveToMouse(t={x:20,y:20},e={}){const i="mouse-tracking",s=i=>{const s=i.clientX+t.x,n=i.clientY+t.y,r=s-window.innerWidth/2,o=n-window.innerHeight/2;!1!==e.smooth?this.positionController.animateOffset(r,o,0,e.duration||200,"easeOutQuad"):this.positionController.setOffset(r,o,0)};return this.trackingCallbacks.set(i,s),window.addEventListener("mousemove",s),()=>{window.removeEventListener("mousemove",s),this.trackingCallbacks.delete(i)}}moveToTouch(t={x:20,y:20},e={}){const i="touch-tracking",s=i=>{if(i.touches.length>0){const s=i.touches[0],n=s.clientX+t.x,r=s.clientY+t.y,o=n-window.innerWidth/2,a=r-window.innerHeight/2;!1!==e.smooth?this.positionController.animateOffset(o,a,0,e.duration||200,"easeOutQuad"):this.positionController.setOffset(o,a,0)}};return this.trackingCallbacks.set(i,s),window.addEventListener("touchmove",s),()=>{window.removeEventListener("touchmove",s),this.trackingCallbacks.delete(i)}}moveToAudio(t=0,e=50,i={}){if(this.audioContext||this.initAudioContext(),!this.audioContext||!this.audioAnalyser)return;const s="audio-tracking",n=()=>{if(!this.isTracking)return;this.audioAnalyser.getByteFrequencyData(this.audioData);let t=0;for(let e=0;e<this.audioData.length;e++)t+=this.audioData[e];const s=t/this.audioData.length/255*e,r=(i.centerX||0)+s,o=(i.centerY||0)+.5*s,a=r-window.innerWidth/2,h=o-window.innerHeight/2;this.positionController.setOffset(a,h,0),this.isTracking&&requestAnimationFrame(n)};return this.trackingCallbacks.set(s,n),this.isTracking=!0,n(),()=>{this.isTracking=!1,this.trackingCallbacks.delete(s)}}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=256,this.audioData=new Uint8Array(this.audioAnalyser.frequencyBinCount)}catch(t){}}connectAudioSource(t){this.audioContext&&this.audioAnalyser||this.initAudioContext(),this.audioContext&&this.audioAnalyser&&this.audioContext.createMediaStreamSource(t).connect(this.audioAnalyser)}moveToViewport(t="right",e={x:20,y:20}){let i,s;switch(t){case"top":i=window.innerWidth/2,s=e.y;break;case"bottom":i=window.innerWidth/2,s=window.innerHeight-e.y;break;case"left":i=e.x,s=window.innerHeight/2;break;case"right":default:i=window.innerWidth-e.x,s=window.innerHeight/2;break;case"top-left":i=e.x,s=e.y;break;case"top-right":i=window.innerWidth-e.x,s=e.y;break;case"bottom-left":i=e.x,s=window.innerHeight-e.y;break;case"bottom-right":i=window.innerWidth-e.x,s=window.innerHeight-e.y}const n=i-window.innerWidth/2,r=s-window.innerHeight/2;this.positionController.setOffset(n,r,0)}stopAllTracking(){this.trackingCallbacks.forEach((t,e)=>{"mouse-tracking"===e?window.removeEventListener("mousemove",t):"touch-tracking"===e&&window.removeEventListener("touchmove",t)}),this.trackingCallbacks.clear(),this.isTracking=!1}destroy(){this.stopAllTracking(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.positionController=null}}class Pi{constructor(t){this.positionController=t,this.isRunning=!1,this.physicsCallbacks=new Map,this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.lastTime=0}moveToGrid(t,e,i={x:0,y:0},s={}){const n=s.gridSize||100,r=t*n+i.x,o=e*n+i.y,a=r-window.innerWidth/2,h=o-window.innerHeight/2;!1!==s.animate?this.positionController.animateOffset(a,h,0,s.duration||1e3,s.easing||"easeOutCubic"):this.positionController.setOffset(a,h,0)}moveToGravity(t={x:0,y:0},e=.1,i={}){const s="gravity",n=s=>{if(!this.isRunning)return;const r=s-this.lastTime;if(this.lastTime=s,r>0){const s=this.positionController.getOffset(),n=s.x,o=s.y,a=t.x-n,h=t.y-o,c=Math.sqrt(a*a+h*h);if(c>0){const t=e/(c*c);this.acceleration.x=a/c*t,this.acceleration.y=h/c*t,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const s=i.damping||.98;this.velocity.x*=s,this.velocity.y*=s;const u=n+this.velocity.x*r,l=o+this.velocity.y*r;this.positionController.setOffset(u,l,0)}}this.isRunning&&requestAnimationFrame(n)};return this.physicsCallbacks.set(s,n),this.isRunning=!0,this.lastTime=performance.now(),n(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(s)}}moveToMagnetic(t=[],e=.05,i={}){const s="magnetic",n=s=>{if(!this.isRunning)return;const r=s-this.lastTime;if(this.lastTime=s,r>0){const s=this.positionController.getOffset(),n=s.x,o=s.y;let a=0,h=0;t.forEach(t=>{let i,s;if("string"==typeof t){const e=document.querySelector(t);if(!e)return;{const t=e.getBoundingClientRect();i=t.left+t.width/2-window.innerWidth/2,s=t.top+t.height/2-window.innerHeight/2}}else{if(void 0===t.x||void 0===t.y)return;i=t.x-window.innerWidth/2,s=t.y-window.innerHeight/2}const r=i-n,c=s-o,u=Math.sqrt(r*r+c*c);if(u>0){const t=e/(u*u);a+=r/u*t,h+=c/u*t}}),this.acceleration.x=a,this.acceleration.y=h,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const c=i.damping||.95;this.velocity.x*=c,this.velocity.y*=c;const u=n+this.velocity.x*r,l=o+this.velocity.y*r;this.positionController.setOffset(u,l,0)}this.isRunning&&requestAnimationFrame(n)};return this.physicsCallbacks.set(s,n),this.isRunning=!0,this.lastTime=performance.now(),n(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(s)}}moveToAvoid(t=[],e=100,i={}){const s="avoid",n=s=>{if(!this.isRunning)return;const r=s-this.lastTime;if(this.lastTime=s,r>0){const s=this.positionController.getOffset(),n=s.x,o=s.y;let a=0,h=0;t.forEach(t=>{let i,s;if("string"==typeof t){const e=document.querySelector(t);if(!e)return;{const t=e.getBoundingClientRect();i=t.left+t.width/2-window.innerWidth/2,s=t.top+t.height/2-window.innerHeight/2}}else{if(void 0===t.x||void 0===t.y)return;i=t.x-window.innerWidth/2,s=t.y-window.innerHeight/2}const r=n-i,c=o-s,u=Math.sqrt(r*r+c*c);if(u<e&&u>0){const t=(e-u)/e;a+=r/u*t,h+=c/u*t}}),this.acceleration.x=a,this.acceleration.y=h,this.velocity.x+=this.acceleration.x*r,this.velocity.y+=this.acceleration.y*r;const c=i.damping||.9;this.velocity.x*=c,this.velocity.y*=c;const u=n+this.velocity.x*r,l=o+this.velocity.y*r;this.positionController.setOffset(u,l,0)}this.isRunning&&requestAnimationFrame(n)};return this.physicsCallbacks.set(s,n),this.isRunning=!0,this.lastTime=performance.now(),n(this.lastTime),()=>{this.isRunning=!1,this.physicsCallbacks.delete(s)}}moveToRandom(t={x:0,y:0,width:400,height:400},e=3e3,i={}){const s="random",n=()=>{if(!this.isRunning)return;const s=t.x+Math.random()*t.width,r=t.y+Math.random()*t.height,o=s-window.innerWidth/2,a=r-window.innerHeight/2;!1!==i.animate?this.positionController.animateOffset(o,a,0,i.duration||1e3,i.easing||"easeOutCubic"):this.positionController.setOffset(o,a,0),this.isRunning&&setTimeout(n,e)};return this.physicsCallbacks.set(s,n),this.isRunning=!0,n(),()=>{this.isRunning=!1,this.physicsCallbacks.delete(s)}}stopAllPhysics(){this.isRunning=!1,this.physicsCallbacks.clear(),this.velocity={x:0,y:0},this.acceleration={x:0,y:0}}destroy(){this.stopAllPhysics(),this.positionController=null}}class Oi{constructor(t){this.positionController=t,this.isRunning=!1,this.animationCallbacks=new Map,this.pathProgress=0,this.timeProgress=0,this.scrollProgress=0}moveToPath(t=[],e=1,i={}){if(t.length<2)return;const s="path",n=!1!==i.loop,r=i.reverse||!1,o=a=>{if(!this.isRunning)return;const h=a-(this.lastTime||a);if(this.lastTime=a,h>0){this.pathProgress+=e*h/1e3,this.pathProgress=n?this.pathProgress%t.length:Math.min(this.pathProgress,t.length-1);const o=Math.floor(this.pathProgress),a=this.pathProgress-o;let c,u;r?(c=t[t.length-1-o],u=t[t.length-2-o]||t[0]):(c=t[o],u=t[o+1]||t[0]);const l=c.x+(u.x-c.x)*a,d=c.y+(u.y-c.y)*a,p=l-window.innerWidth/2,f=d-window.innerHeight/2;if(this.positionController.setOffset(p,f,0),!n&&this.pathProgress>=t.length-1)return this.isRunning=!1,this.animationCallbacks.delete(s),void(i.onComplete&&i.onComplete())}this.isRunning&&requestAnimationFrame(o)};return this.animationCallbacks.set(s,o),this.isRunning=!0,this.lastTime=performance.now(),o(this.lastTime),()=>{this.isRunning=!1,this.animationCallbacks.delete(s)}}moveToTime(t=2e3,e="easeInOutCubic",i={}){const s="time",n=performance.now(),r=this.positionController.getOffset(),o=i.target||{x:0,y:0},a=h=>{if(!this.isRunning)return;const c=h-n,u=Math.min(c/t,1),l=this.applyEasing(u,e),d=r.x+(o.x-r.x)*l,p=r.y+(o.y-r.y)*l;this.positionController.setOffset(d,p,0),u>=1?(this.isRunning=!1,this.animationCallbacks.delete(s),i.onComplete&&i.onComplete()):requestAnimationFrame(a)};return this.animationCallbacks.set(s,a),this.isRunning=!0,a(n),()=>{this.isRunning=!1,this.animationCallbacks.delete(s)}}moveToScroll(t=0,e={x:0,y:0},i={}){const s="scroll",n=()=>{if(!this.isRunning)return;const s=window.innerWidth,n=window.innerHeight;let r,o;if("horizontal"===i.direction)r=t*s+e.x,o=n/2+e.y;else if("vertical"===i.direction)r=s/2+e.x,o=t*n+e.y;else{const a=t*Math.PI*2,h=i.radius||Math.min(s,n)/4;r=s/2+Math.cos(a)*h+e.x,o=n/2+Math.sin(a)*h+e.y}const a=r-s/2,h=o-n/2;this.positionController.setOffset(a,h,0)};return this.animationCallbacks.set(s,n),this.isRunning=!0,n(),()=>{this.isRunning=!1,this.animationCallbacks.delete(s)}}animateTo(t,e,i=1e3,s="easeOutCubic"){this.positionController.animateOffset(t,e,0,i,s)}applyEasing(t,e){switch(e){case"linear":default:return t;case"easeInQuad":return t*t;case"easeOutQuad":return 1-(1-t)*(1-t);case"easeInOutQuad":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"easeInCubic":return t*t*t;case"easeOutCubic":return 1-Math.pow(1-t,3);case"easeInOutCubic":return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;case"easeInBack":{const e=1.70158;return(e+1)*t*t*t-e*t*t}case"easeOutBack":{const e=1.70158;return 1+(e+1)*Math.pow(t-1,3)+e*Math.pow(t-1,2)}case"easeInElastic":return 0===t?0:1===t?1:-Math.pow(2,10*t-10)*Math.sin((10*t-10.75)*(2*Math.PI/3));case"easeOutElastic":return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*(2*Math.PI/3))+1}}stopAllAnimations(){this.isRunning=!1,this.animationCallbacks.clear(),this.pathProgress=0,this.timeProgress=0,this.scrollProgress=0}destroy(){this.stopAllAnimations(),this.positionController=null}}class Bi{constructor(t){this.positionController=t,this.breakpoints={mobile:768,tablet:1024,desktop:1200},this.currentBreakpoint=this.getCurrentBreakpoint(),this.responsiveCallbacks=new Map}getCurrentBreakpoint(){const t=window.innerWidth;return t<this.breakpoints.mobile?"mobile":t<this.breakpoints.tablet?"tablet":t<this.breakpoints.desktop?"desktop":"large"}moveToResponsive(t={},e={}){const i="responsive",s=()=>{if(!this.isRunning)return;const i=this.getCurrentBreakpoint(),s=t[i]||t.default||{x:0,y:0},n=s.x-window.innerWidth/2,r=s.y-window.innerHeight/2;!1!==e.animate?this.positionController.animateOffset(n,r,0,e.duration||500,e.easing||"easeOutCubic"):this.positionController.setOffset(n,r,0)};this.responsiveCallbacks.set(i,s),this.isRunning=!0,s();const n=()=>{const t=this.getCurrentBreakpoint();t!==this.currentBreakpoint&&(this.currentBreakpoint=t,s())};return window.addEventListener("resize",n),()=>{this.isRunning=!1,this.responsiveCallbacks.delete(i),window.removeEventListener("resize",n)}}moveToGroup(t=[],e="center",i={x:0,y:0}){if(0===t.length)return;let s=0,n=0,r=0,o=0,a=0;if(t.forEach(t=>{let e,i,h,c;if("string"==typeof t){const s=document.querySelector(t);if(!s)return;{const t=s.getBoundingClientRect();e=t.left,i=t.top,h=t.width,c=t.height}}else{if(void 0===t.x||void 0===t.y)return;e=t.x,i=t.y,h=t.width||0,c=t.height||0}s+=e,n+=i,r=Math.max(r,e+h),o=Math.max(o,i+c),a++}),0===a)return;const h=s/a,c=n/a;let u,l;switch(e){case"center":default:u=h+i.x,l=c+i.y;break;case"left":u=s+i.x,l=c+i.y;break;case"right":u=r+i.x,l=c+i.y;break;case"top":u=h+i.x,l=n+i.y;break;case"bottom":u=h+i.x,l=o+i.y}const d=u-window.innerWidth/2,p=l-window.innerHeight/2;this.positionController.setOffset(d,p,0)}moveToAccessibility(t=[],e="bottom-right",i={}){const s="accessibility",n=()=>{if(!this.isRunning)return;let s,n;switch((window.speechSynthesis||window.webkitSpeechSynthesis)&&i.announce&&t.forEach(t=>{t.condition&&t.condition()&&this.announceToScreenReader(t.text)}),e){case"bottom-right":default:s=window.innerWidth-100,n=window.innerHeight-100;break;case"bottom-left":s=100,n=window.innerHeight-100;break;case"top-right":s=window.innerWidth-100,n=100;break;case"top-left":s=100,n=100;break;case"center":s=window.innerWidth/2,n=window.innerHeight/2}const r=s-window.innerWidth/2,o=n-window.innerHeight/2;this.positionController.setOffset(r,o,0)};return this.responsiveCallbacks.set(s,n),this.isRunning=!0,n(),()=>{this.isRunning=!1,this.responsiveCallbacks.delete(s)}}announceToScreenReader(t){if(window.speechSynthesis){const e=new SpeechSynthesisUtterance(t);e.volume=.5,e.rate=.8,window.speechSynthesis.speak(e)}}setBreakpoints(t){this.breakpoints={...this.breakpoints,...t},this.currentBreakpoint=this.getCurrentBreakpoint()}getCurrentBreakpointName(){return this.currentBreakpoint}isBreakpoint(t){return this.currentBreakpoint===t}stopAllResponsive(){this.isRunning=!1,this.responsiveCallbacks.clear()}destroy(){this.stopAllResponsive(),this.positionController=null}}class Di{constructor(t){this.positionController=t,this.elementTargeting=new ki(t),this.inputTracking=new Ri(t),this.physics=new Pi(t),this.animation=new Oi(t),this.responsive=new Bi(t),this.methods=new Map,this.registerMethods()}registerMethods(){this.methods.set("moveToElement",this.elementTargeting.moveToElement.bind(this.elementTargeting)),this.methods.set("moveToButton",this.elementTargeting.moveToButton.bind(this.elementTargeting)),this.methods.set("moveToForm",this.elementTargeting.moveToForm.bind(this.elementTargeting)),this.methods.set("moveToModal",this.elementTargeting.moveToModal.bind(this.elementTargeting)),this.methods.set("moveToNavigation",this.elementTargeting.moveToNavigation.bind(this.elementTargeting)),this.methods.set("moveToContent",this.elementTargeting.moveToContent.bind(this.elementTargeting)),this.methods.set("moveToSidebar",this.elementTargeting.moveToSidebar.bind(this.elementTargeting)),this.methods.set("moveToHeader",this.elementTargeting.moveToHeader.bind(this.elementTargeting)),this.methods.set("moveToFooter",this.elementTargeting.moveToFooter.bind(this.elementTargeting)),this.methods.set("watchElement",this.elementTargeting.watchElement.bind(this.elementTargeting)),this.methods.set("moveToMouse",this.inputTracking.moveToMouse.bind(this.inputTracking)),this.methods.set("moveToTouch",this.inputTracking.moveToTouch.bind(this.inputTracking)),this.methods.set("moveToAudio",this.inputTracking.moveToAudio.bind(this.inputTracking)),this.methods.set("moveToViewport",this.inputTracking.moveToViewport.bind(this.inputTracking)),this.methods.set("moveToGrid",this.physics.moveToGrid.bind(this.physics)),this.methods.set("moveToGravity",this.physics.moveToGravity.bind(this.physics)),this.methods.set("moveToMagnetic",this.physics.moveToMagnetic.bind(this.physics)),this.methods.set("moveToAvoid",this.physics.moveToAvoid.bind(this.physics)),this.methods.set("moveToRandom",this.physics.moveToRandom.bind(this.physics)),this.methods.set("moveToPath",this.animation.moveToPath.bind(this.animation)),this.methods.set("moveToTime",this.animation.moveToTime.bind(this.animation)),this.methods.set("moveToScroll",this.animation.moveToScroll.bind(this.animation)),this.methods.set("animateTo",this.animation.animateTo.bind(this.animation)),this.methods.set("moveToResponsive",this.responsive.moveToResponsive.bind(this.responsive)),this.methods.set("moveToGroup",this.responsive.moveToGroup.bind(this.responsive)),this.methods.set("moveToAccessibility",this.responsive.moveToAccessibility.bind(this.responsive))}call(t,...e){const i=this.methods.get(t);return i?i(...e):null}getAvailableMethods(){return Array.from(this.methods.keys())}hasMethod(t){return this.methods.has(t)}stopAll(){this.elementTargeting.stopWatchingAll(),this.inputTracking.stopAllTracking(),this.physics.stopAllPhysics(),this.animation.stopAllAnimations(),this.responsive.stopAllResponsive()}destroy(){this.stopAll(),this.elementTargeting.destroy(),this.inputTracking.destroy(),this.physics.destroy(),this.animation.destroy(),this.responsive.destroy(),this.methods.clear(),this.positionController=null}}class $i{constructor(t={}){this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.offsetZ=t.offsetZ||0,this.isAnimating=!1,this.animationId=null,this.animationStartTime=0,this.animationDuration=0,this.animationEasing="easeOutCubic",this.startOffset={x:0,y:0,z:0},this.targetOffset={x:0,y:0,z:0},this.onUpdate=t.onUpdate||(()=>{}),this.onAnimationComplete=t.onAnimationComplete||(()=>{}),this.minScale=t.minScale||.5,this.maxScale=t.maxScale||2,this.zScaleRange=t.zScaleRange||1e3,this.globalScale=1,this.coreScaleOverride=1,this.particleScaleOverride=1,this.positioning=new Di(this),this.elementTargeting=new _i(this)}setOffset(t,e,i=0){this.stopAnimation(),this.offsetX=t,this.offsetY=e,this.offsetZ=i,this.onUpdate(this.getEffectiveCenter())}getOffset(){return{x:this.offsetX,y:this.offsetY,z:this.offsetZ}}getPosition(t=window.innerWidth/2,e=window.innerHeight/2){return{x:t+this.offsetX,y:e+this.offsetY,z:this.offsetZ,scale:this.getZScale()}}animateOffset(t,e,i=0,s=1e3,n="easeOutCubic"){this.stopAnimation(),this.startOffset={x:this.offsetX,y:this.offsetY,z:this.offsetZ},this.targetOffset={x:t,y:e,z:i},this.animationDuration=s,this.animationEasing=n,this.animationStartTime=performance.now(),this.isAnimating=!0,this.startAnimation()}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.isAnimating=!1}startAnimation(){const t=e=>{if(!this.isAnimating)return;const i=e-this.animationStartTime,s=Math.min(i/this.animationDuration,1),n=this.applyEasing(s,this.animationEasing);this.offsetX=this.lerp(this.startOffset.x,this.targetOffset.x,n),this.offsetY=this.lerp(this.startOffset.y,this.targetOffset.y,n),this.offsetZ=this.lerp(this.startOffset.z,this.targetOffset.z,n),this.onUpdate(this.getEffectiveCenter()),s>=1?(this.isAnimating=!1,this.onAnimationComplete()):this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)}getEffectiveCenter(t=0,e=0){return{x:t+this.offsetX,y:e+this.offsetY,scale:this.getZScale(),coreScale:this.getCoreScale(),particleScale:this.getParticleScale()}}getZScale(){const t=-this.offsetZ/this.zScaleRange,e=Math.max(-1,Math.min(1,t));return this.lerp(this.minScale,this.maxScale,(e+1)/2)*this.globalScale}setGlobalScale(t){this.globalScale=Math.max(.1,t),this.onUpdate(this.getEffectiveCenter())}setScaleOverrides(t){"number"==typeof t?(this.globalScale=Math.max(.1,t),this.coreScaleOverride=1,this.particleScaleOverride=1):(void 0!==t.global&&(this.globalScale=Math.max(.1,t.global)),void 0!==t.core&&(this.coreScaleOverride=Math.max(.1,t.core)),void 0!==t.particles&&(this.particleScaleOverride=Math.max(.1,t.particles))),this.onUpdate(this.getEffectiveCenter())}getCoreScale(){return this.calculateBaseZScale()*this.globalScale*this.coreScaleOverride}getParticleScale(){return this.calculateBaseZScale()*this.globalScale*this.particleScaleOverride}calculateBaseZScale(){const t=-this.offsetZ/this.zScaleRange,e=Math.max(-1,Math.min(1,t));return this.lerp(this.minScale,this.maxScale,(e+1)/2)}lerp(t,e,i){return t+(e-t)*i}applyEasing(t,e){switch(e){case"linear":default:return t;case"easeInQuad":return t*t;case"easeOutQuad":return 1-(1-t)*(1-t);case"easeInOutQuad":return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;case"easeInCubic":return t*t*t;case"easeOutCubic":return 1-Math.pow(1-t,3);case"easeInOutCubic":return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;case"easeInBack":{const e=1.70158;return(e+1)*t*t*t-e*t*t}case"easeOutBack":{const e=1.70158;return 1+(e+1)*Math.pow(t-1,3)+e*Math.pow(t-1,2)}}}getPositioning(){return this.positioning}getElementTargeting(){return this.elementTargeting}callPositioning(t,...e){return this.positioning.call(t,...e)}destroy(){this.stopAnimation(),this.positioning&&(this.positioning.destroy(),this.positioning=null),this.elementTargeting&&(this.elementTargeting.destroy(),this.elementTargeting=null),this.onUpdate=null,this.onAnimationComplete=null}}const zi="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,qi=globalThis,ji="10.22.0";function Li(){return Ni(qi),qi}function Ni(t){const e=t.I=t.I||{};return e.version=e.version||ji,e[ji]=e[ji]||{}}function Gi(t,e,i=qi){const s=i.I=i.I||{},n=s[ji]=s[ji]||{};return n[t]||(n[t]=e())}const Ui=["debug","info","warn","error","log","assert","trace"],Wi={};function Hi(t){if(!("console"in qi))return t();const e=qi.console,i={},s=Object.keys(Wi);s.forEach(t=>{const s=Wi[t];i[t]=e[t],e[t]=s});try{return t()}finally{s.forEach(t=>{e[t]=i[t]})}}function Vi(){return Xi().enabled}function Yi(t,...e){zi&&Vi()&&Hi(()=>{qi.console[t](`Sentry Logger [${t}]:`,...e)})}function Xi(){return zi?Gi("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const Ji={enable:function(){Xi().enabled=!0},disable:function(){Xi().enabled=!1},isEnabled:Vi,log:function(...t){Yi("log",...t)},warn:function(...t){Yi("warn",...t)},error:function(...t){Yi("error",...t)}},Ki="?",Qi=/\(error: (.*)\)/,Zi=/captureMessage|captureException/;function ts(...t){const e=t.sort((t,e)=>t[0]-e[0]).map(t=>t[1]);return(t,i=0,s=0)=>{const n=[],r=t.split("\n");for(let t=i;t<r.length;t++){let i=r[t];i.length>1024&&(i=i.slice(0,1024));const o=Qi.test(i)?i.replace(Qi,"$1"):i;if(!o.match(/\S*Error: /)){for(const t of e){const e=t(o);if(e){n.push(e);break}}if(n.length>=50+s)break}}return function(t){if(!t.length)return[];const e=Array.from(t);return/sentryWrapped/.test(es(e).function||"")&&e.pop(),e.reverse(),Zi.test(es(e).function||"")&&(e.pop(),Zi.test(es(e).function||"")&&e.pop()),e.slice(0,50).map(t=>({...t,filename:t.filename||es(e).filename,function:t.function||Ki}))}(n.slice(s))}}function es(t){return t[t.length-1]||{}}const is="<anonymous>";function ss(t){try{return t&&"function"==typeof t&&t.name||is}catch{return is}}function ns(t){const e=t.exception;if(e){const t=[];try{return e.values.forEach(e=>{e.stacktrace.frames&&t.push(...e.stacktrace.frames)}),t}catch{return}}}const rs={},os={};function as(t,e){rs[t]=rs[t]||[],rs[t].push(e)}function hs(t,e){if(!os[t]){os[t]=!0;try{e()}catch(e){zi&&Ji.error(`Error while instrumenting ${t}`,e)}}}function cs(t,e){const i=t&&rs[t];if(i)for(const s of i)try{s(e)}catch(e){zi&&Ji.error(`Error while triggering instrumentation handler.\nType: ${t}\nName: ${ss(s)}\nError:`,e)}}let us=null;function ls(t){const e="error";as(e,t),hs(e,ds)}function ds(){us=qi.onerror,qi.onerror=function(t,e,i,s,n){return cs("error",{column:s,error:n,line:i,msg:t,url:e}),!!us&&us.apply(this,arguments)},qi.onerror.F=!0}let ps=null;function fs(t){const e="unhandledrejection";as(e,t),hs(e,ms)}function ms(){ps=qi.onunhandledrejection,qi.onunhandledrejection=function(t){return cs("unhandledrejection",t),!ps||ps.apply(this,arguments)},qi.onunhandledrejection.F=!0}const gs={}.toString;function ys(t){switch(gs.call(t)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object WebAssembly.Exception]":return!0;default:return Cs(t,Error)}}function bs(t,e){return gs.call(t)===`[object ${e}]`}function vs(t){return bs(t,"ErrorEvent")}function ws(t){return bs(t,"DOMError")}function Ms(t){return bs(t,"String")}function Ss(t){return"object"==typeof t&&null!==t&&"_"in t&&"R"in t}function ks(t){return null===t||Ss(t)||"object"!=typeof t&&"function"!=typeof t}function xs(t){return bs(t,"Object")}function Ts(t){return"undefined"!=typeof Event&&Cs(t,Event)}function Es(t){return Boolean(t?.then&&"function"==typeof t.then)}function Cs(t,e){try{return t instanceof e}catch{return!1}}function As(t){return!("object"!=typeof t||null===t||!t.P&&!t.O)}function Is(t){return"undefined"!=typeof Request&&Cs(t,Request)}const Fs=qi;function _s(t,e={}){if(!t)return"<unknown>";try{let i=t;const s=5,n=[];let r=0,o=0;const a=" > ",h=a.length;let c;const u=Array.isArray(e)?e:e.keyAttrs,l=!Array.isArray(e)&&e.maxStringLength||80;for(;i&&r++<s&&(c=Rs(i,u),!("html"===c||r>1&&o+n.length*h+c.length>=l));)n.push(c),o+=c.length,i=i.parentNode;return n.reverse().join(a)}catch{return"<unknown>"}}function Rs(t,e){const i=t,s=[];if(!i?.tagName)return"";if(Fs.HTMLElement&&i instanceof HTMLElement&&i.dataset){if(i.dataset.sentryComponent)return i.dataset.sentryComponent;if(i.dataset.sentryElement)return i.dataset.sentryElement}s.push(i.tagName.toLowerCase());const n=e?.length?e.filter(t=>i.getAttribute(t)).map(t=>[t,i.getAttribute(t)]):null;if(n?.length)n.forEach(t=>{s.push(`[${t[0]}="${t[1]}"]`)});else{i.id&&s.push(`#${i.id}`);const t=i.className;if(t&&Ms(t)){const e=t.split(/\s+/);for(const t of e)s.push(`.${t}`)}}const r=["aria-label","type","name","title","alt"];for(const t of r){const e=i.getAttribute(t);e&&s.push(`[${t}="${e}"]`)}return s.join("")}function Ps(){try{return Fs.document.location.href}catch{return""}}function Os(t){if(!Fs.HTMLElement)return null;let e=t;for(let t=0;t<5;t++){if(!e)return null;if(e instanceof HTMLElement){if(e.dataset.sentryComponent)return e.dataset.sentryComponent;if(e.dataset.sentryElement)return e.dataset.sentryElement}e=e.parentNode}return null}function Bs(t,e=0){return"string"!=typeof t||0===e||t.length<=e?t:`${t.slice(0,e)}...`}function Ds(t,e){if(!Array.isArray(t))return"";const i=[];for(let e=0;e<t.length;e++){const s=t[e];try{As(s)?i.push("[VueViewModel]"):i.push(String(s))}catch{i.push("[value cannot be serialized]")}}return i.join(e)}function $s(t,e,i=!1){return!!Ms(t)&&(bs(e,"RegExp")?e.test(t):!!Ms(e)&&(i?t===e:t.includes(e)))}function zs(t,e=[],i=!1){return e.some(e=>$s(t,e,i))}function qs(t,e,i){if(!(e in t))return;const s=t[e];if("function"!=typeof s)return;const n=i(s);"function"==typeof n&&Ls(n,s);try{t[e]=n}catch{zi&&Ji.log(`Failed to replace method "${e}" in object`,t)}}function js(t,e,i){try{Object.defineProperty(t,e,{value:i,writable:!0,configurable:!0})}catch{zi&&Ji.log(`Failed to add non-enumerable property "${e}" to object`,t)}}function Ls(t,e){try{const i=e.prototype||{};t.prototype=e.prototype=i,js(t,"__sentry_original__",e)}catch{}}function Ns(t){return t.B}function Gs(t){if(ys(t))return{message:t.message,name:t.name,stack:t.stack,...Ws(t)};if(Ts(t)){const e={type:t.type,target:Us(t.target),currentTarget:Us(t.currentTarget),...Ws(t)};return"undefined"!=typeof CustomEvent&&Cs(t,CustomEvent)&&(e.detail=t.detail),e}return t}function Us(t){try{return"undefined"!=typeof Element&&Cs(t,Element)?_s(t):{}.toString.call(t)}catch{return"<unknown>"}}function Ws(t){if("object"==typeof t&&null!==t){const e={};for(const i in t)({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}return{}}let Hs,Vs,Ys;function Xs(t=function(){const t=qi;return t.crypto||t.msCrypto}()){try{if(t?.randomUUID)return t.randomUUID().replace(/-/g,"")}catch{}return Hs||(Hs=[1e7]+1e3+4e3+8e3+1e11),Hs.replace(/[018]/g,t=>(t^(16*Math.random()&15)>>t/4).toString(16))}function Js(t){return t.exception?.values?.[0]}function Ks(t){const{message:e,event_id:i}=t;if(e)return e;const s=Js(t);return s?s.type&&s.value?`${s.type}: ${s.value}`:s.type||s.value||i||"<unknown>":i||"<unknown>"}function Qs(t,e,i){const s=t.exception=t.exception||{},n=s.values=s.values||[],r=n[0]=n[0]||{};r.value||(r.value=e||""),r.type||(r.type="Error")}function Zs(t,e){const i=Js(t);if(!i)return;const s=i.mechanism;if(i.mechanism={type:"generic",handled:!0,...s,...e},e&&"data"in e){const t={...s?.data,...e.data};i.mechanism.data=t}}function tn(t){if(function(t){try{return t.D}catch{}}(t))return!0;try{js(t,"__sentry_captured__",!0)}catch{}return!1}function en(){return Date.now()/1e3}function sn(){return(Vs??(Vs=function(){const{performance:t}=qi;if(!t?.now||!t.timeOrigin)return en;const e=t.timeOrigin;return()=>(e+t.now())/1e3}()))()}function nn(){return Ys||(Ys=function(){const{performance:t}=qi;if(!t?.now)return[void 0,"none"];const e=36e5,i=t.now(),s=Date.now(),n=t.timeOrigin?Math.abs(t.timeOrigin+i-s):e,r=n<e,o=t.timing?.navigationStart,a="number"==typeof o?Math.abs(o+i-s):e;return r||a<e?n<=a?[t.timeOrigin,"timeOrigin"]:[o,"navigationStart"]:[s,"dateNow"]}()),Ys[0]}function rn(t,e={}){if(e.user&&(!t.ipAddress&&e.user.ip_address&&(t.ipAddress=e.user.ip_address),t.did||e.did||(t.did=e.user.id||e.user.email||e.user.username)),t.timestamp=e.timestamp||sn(),e.abnormal_mechanism&&(t.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(t.ignoreDuration=e.ignoreDuration),e.sid&&(t.sid=32===e.sid.length?e.sid:Xs()),void 0!==e.init&&(t.init=e.init),!t.did&&e.did&&(t.did=`${e.did}`),"number"==typeof e.started&&(t.started=e.started),t.ignoreDuration)t.duration=void 0;else if("number"==typeof e.duration)t.duration=e.duration;else{const e=t.timestamp-t.started;t.duration=e>=0?e:0}e.release&&(t.release=e.release),e.environment&&(t.environment=e.environment),!t.ipAddress&&e.ipAddress&&(t.ipAddress=e.ipAddress),!t.userAgent&&e.userAgent&&(t.userAgent=e.userAgent),"number"==typeof e.errors&&(t.errors=e.errors),e.status&&(t.status=e.status)}function on(t,e,i=2){if(!e||"object"!=typeof e||i<=0)return e;if(t&&0===Object.keys(e).length)return t;const s={...t};for(const t in e)({}).hasOwnProperty.call(e,t)&&(s[t]=on(s[t],e[t],i-1));return s}function an(){return Xs()}function hn(){return Xs().substring(16)}const cn="_sentrySpan";function un(t,e){e?js(t,cn,e):delete t[cn]}function ln(t){return t[cn]}class dn{constructor(){this.q=!1,this.j=[],this.L=[],this.N=[],this.G=[],this.U={},this.W={},this.H={},this.V={},this.Y={},this.X={traceId:an(),sampleRand:Math.random()}}clone(){const t=new dn;return t.N=[...this.N],t.W={...this.W},t.H={...this.H},t.V={...this.V},this.V.flags&&(t.V.flags={values:[...this.V.flags.values]}),t.U=this.U,t.J=this.J,t.K=this.K,t.Z=this.Z,t.tt=this.tt,t.L=[...this.L],t.G=[...this.G],t.Y={...this.Y},t.X={...this.X},t.et=this.et,t.it=this.it,un(t,ln(this)),t}setClient(t){this.et=t}setLastEventId(t){this.it=t}getClient(){return this.et}lastEventId(){return this.it}addScopeListener(t){this.j.push(t)}addEventProcessor(t){return this.L.push(t),this}setUser(t){return this.U=t||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this.K&&rn(this.K,{user:t}),this.st(),this}getUser(){return this.U}setTags(t){return this.W={...this.W,...t},this.st(),this}setTag(t,e){return this.W={...this.W,[t]:e},this.st(),this}setExtras(t){return this.H={...this.H,...t},this.st(),this}setExtra(t,e){return this.H={...this.H,[t]:e},this.st(),this}setFingerprint(t){return this.tt=t,this.st(),this}setLevel(t){return this.J=t,this.st(),this}setTransactionName(t){return this.Z=t,this.st(),this}setContext(t,e){return null===e?delete this.V[t]:this.V[t]=e,this.st(),this}setSession(t){return t?this.K=t:delete this.K,this.st(),this}getSession(){return this.K}update(t){if(!t)return this;const e="function"==typeof t?t(this):t,i=e instanceof dn?e.getScopeData():xs(e)?t:void 0,{tags:s,extra:n,user:r,contexts:o,level:a,fingerprint:h=[],propagationContext:c}=i||{};return this.W={...this.W,...s},this.H={...this.H,...n},this.V={...this.V,...o},r&&Object.keys(r).length&&(this.U=r),a&&(this.J=a),h.length&&(this.tt=h),c&&(this.X=c),this}clear(){return this.N=[],this.W={},this.H={},this.U={},this.V={},this.J=void 0,this.Z=void 0,this.tt=void 0,this.K=void 0,un(this,void 0),this.G=[],this.setPropagationContext({traceId:an(),sampleRand:Math.random()}),this.st(),this}addBreadcrumb(t,e){const i="number"==typeof e?e:100;if(i<=0)return this;const s={timestamp:en(),...t,message:t.message?Bs(t.message,2048):t.message};return this.N.push(s),this.N.length>i&&(this.N=this.N.slice(-i),this.et?.recordDroppedEvent("buffer_overflow","log_item")),this.st(),this}getLastBreadcrumb(){return this.N[this.N.length-1]}clearBreadcrumbs(){return this.N=[],this.st(),this}addAttachment(t){return this.G.push(t),this}clearAttachments(){return this.G=[],this}getScopeData(){return{breadcrumbs:this.N,attachments:this.G,contexts:this.V,tags:this.W,extra:this.H,user:this.U,level:this.J,fingerprint:this.tt||[],eventProcessors:this.L,propagationContext:this.X,sdkProcessingMetadata:this.Y,transactionName:this.Z,span:ln(this)}}setSDKProcessingMetadata(t){return this.Y=on(this.Y,t,2),this}setPropagationContext(t){return this.X=t,this}getPropagationContext(){return this.X}captureException(t,e){const i=e?.event_id||Xs();if(!this.et)return zi&&Ji.warn("No client configured on scope - will not capture exception!"),i;const s=new Error("Sentry syntheticException");return this.et.captureException(t,{originalException:t,syntheticException:s,...e,event_id:i},this),i}captureMessage(t,e,i){const s=i?.event_id||Xs();if(!this.et)return zi&&Ji.warn("No client configured on scope - will not capture message!"),s;const n=new Error(t);return this.et.captureMessage(t,e,{originalException:t,syntheticException:n,...i,event_id:s},this),s}captureEvent(t,e){const i=e?.event_id||Xs();return this.et?(this.et.captureEvent(t,{...e,event_id:i},this),i):(zi&&Ji.warn("No client configured on scope - will not capture event!"),i)}st(){this.q||(this.q=!0,this.j.forEach(t=>{t(this)}),this.q=!1)}}class pn{constructor(t,e){let i,s;i=t||new dn,s=e||new dn,this.nt=[{scope:i}],this.rt=s}withScope(t){const e=this.ot();let i;try{i=t(e)}catch(t){throw this.ht(),t}return Es(i)?i.then(t=>(this.ht(),t),t=>{throw this.ht(),t}):(this.ht(),i)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this.rt}getStackTop(){return this.nt[this.nt.length-1]}ot(){const t=this.getScope().clone();return this.nt.push({client:this.getClient(),scope:t}),t}ht(){return!(this.nt.length<=1||!this.nt.pop())}}function fn(){const t=Ni(Li());return t.stack=t.stack||new pn(Gi("defaultCurrentScope",()=>new dn),Gi("defaultIsolationScope",()=>new dn))}function mn(t){return fn().withScope(t)}function gn(t,e){const i=fn();return i.withScope(()=>(i.getStackTop().scope=t,e(t)))}function yn(t){return fn().withScope(()=>t(fn().getIsolationScope()))}function bn(t){const e=Ni(t);return e.acs?e.acs:{withIsolationScope:yn,withScope:mn,withSetScope:gn,withSetIsolationScope:(t,e)=>yn(e),getCurrentScope:()=>fn().getScope(),getIsolationScope:()=>fn().getIsolationScope()}}function vn(){return bn(Li()).getCurrentScope()}function wn(){return bn(Li()).getIsolationScope()}function Mn(...t){const e=bn(Li());if(2===t.length){const[i,s]=t;return i?e.withSetScope(i,s):e.withScope(s)}return e.withScope(t[0])}function Sn(){return vn().getClient()}function kn(t){const e=t.getPropagationContext(),{traceId:i,parentSpanId:s,propagationSpanId:n}=e,r={trace_id:i,span_id:n||hn()};return s&&(r.parent_span_id=s),r}const xn="sentry.source",Tn="sentry.sample_rate",En="sentry.previous_trace_sample_rate",Cn="sentry.op",An="sentry.origin",In="sentry.idle_span_finish_reason",Fn="sentry.measurement_unit",_n="sentry.measurement_value",Rn="sentry.custom_span_name",Pn="sentry.profile_id",On="sentry.exclusive_time",Bn="sentry.link.type";function Dn(t,e){t.setAttribute("http.response.status_code",e);const i=function(t){if(t<400&&t>=100)return{code:1};if(t>=400&&t<500)switch(t){case 401:return{code:2,message:"unauthenticated"};case 403:return{code:2,message:"permission_denied"};case 404:return{code:2,message:"not_found"};case 409:return{code:2,message:"already_exists"};case 413:return{code:2,message:"failed_precondition"};case 429:return{code:2,message:"resource_exhausted"};case 499:return{code:2,message:"cancelled"};default:return{code:2,message:"invalid_argument"}}if(t>=500&&t<600)switch(t){case 501:return{code:2,message:"unimplemented"};case 503:return{code:2,message:"unavailable"};case 504:return{code:2,message:"deadline_exceeded"};default:return{code:2,message:"internal_error"}}return{code:2,message:"unknown_error"}}(e);"unknown_error"!==i.message&&t.setStatus(i)}const $n="_sentryScope",zn="_sentryIsolationScope";function qn(t){if(t){if("object"==typeof t&&"deref"in t&&"function"==typeof t.deref)try{return t.deref()}catch{return}return t}}function jn(t){const e=t;return{scope:e[$n],isolationScope:qn(e[zn])}}const Ln="sentry-",Nn=/^sentry-/;function Gn(t){const e=function(t){if(t&&(Ms(t)||Array.isArray(t)))return Array.isArray(t)?t.reduce((t,e)=>{const i=Un(e);return Object.entries(i).forEach(([e,i])=>{t[e]=i}),t},{}):Un(t)}(t);if(!e)return;const i=Object.entries(e).reduce((t,[e,i])=>(e.match(Nn)&&(t[e.slice(7)]=i),t),{});return Object.keys(i).length>0?i:void 0}function Un(t){return t.split(",").map(t=>{const e=t.indexOf("=");return-1===e?[]:[t.slice(0,e),t.slice(e+1)].map(t=>{try{return decodeURIComponent(t.trim())}catch{return}})}).reduce((t,[e,i])=>(e&&i&&(t[e]=i),t),{})}const Wn=/^o(\d+)\./,Hn=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function Vn(t,e=!1){const{host:i,path:s,pass:n,port:r,projectId:o,protocol:a,publicKey:h}=t;return`${a}://${h}${e&&n?`:${n}`:""}@${i}${r?`:${r}`:""}/${s?`${s}/`:s}${o}`}function Yn(t){return{protocol:t.protocol,publicKey:t.publicKey||"",pass:t.pass||"",host:t.host,port:t.port||"",path:t.path||"",projectId:t.projectId}}function Xn(t){const e=t.getOptions(),{host:i}=t.getDsn()||{};let s;return e.orgId?s=String(e.orgId):i&&(s=function(t){const e=t.match(Wn);return e?.[1]}(i)),s}function Jn(t){if("boolean"==typeof t)return Number(t);const e="string"==typeof t?parseFloat(t):t;return"number"!=typeof e||isNaN(e)||e<0||e>1?void 0:e}const Kn=new RegExp("^[ \\t]*([0-9a-f]{32})?-?([0-9a-f]{16})?-?([01])?[ \\t]*$");function Qn(t=an(),e=hn(),i){let s="";return void 0!==i&&(s=i?"-1":"-0"),`${t}-${e}${s}`}function Zn(t=an(),e=hn(),i){return`00-${t}-${e}-${i?"01":"00"}`}let tr=!1;function er(t){const{spanId:e,traceId:i}=t.spanContext(),{data:s,op:n,parent_span_id:r,status:o,origin:a,links:h}=or(t);return{parent_span_id:r,span_id:e,trace_id:i,data:s,op:n,status:o,origin:a,links:h}}function ir(t){const{spanId:e,traceId:i,isRemote:s}=t.spanContext(),n=s?e:or(t).parent_span_id,r=jn(t).scope;return{parent_span_id:n,span_id:s?r?.getPropagationContext().propagationSpanId||hn():e,trace_id:i}}function sr(t){return t&&t.length>0?t.map(({context:{spanId:t,traceId:e,traceFlags:i,...s},attributes:n})=>({span_id:t,trace_id:e,sampled:1===i,attributes:n,...s})):void 0}function nr(t){return"number"==typeof t?rr(t):Array.isArray(t)?t[0]+t[1]/1e9:t instanceof Date?rr(t.getTime()):sn()}function rr(t){return t>9999999999?t/1e3:t}function or(t){if(function(t){return"function"==typeof t.getSpanJSON}(t))return t.getSpanJSON();const{spanId:e,traceId:i}=t.spanContext();if(function(t){const e=t;return!!(e.attributes&&e.startTime&&e.name&&e.endTime&&e.status)}(t)){const{attributes:s,startTime:n,name:r,endTime:o,status:a,links:h}=t;return{span_id:e,trace_id:i,data:s,description:r,parent_span_id:"parentSpanId"in t?t.parentSpanId:"parentSpanContext"in t?t.parentSpanContext?.spanId:void 0,start_timestamp:nr(n),timestamp:nr(o)||void 0,status:hr(a),op:s[Cn],origin:s[An],links:sr(h)}}return{span_id:e,trace_id:i,start_timestamp:0,data:{}}}function ar(t){const{traceFlags:e}=t.spanContext();return 1===e}function hr(t){if(t&&0!==t.code)return 1===t.code?"ok":t.message||"unknown_error"}const cr="_sentryChildSpans",ur="_sentryRootSpan";function lr(t,e){const i=t[ur]||t;js(e,ur,i),t[cr]?t[cr].add(e):js(t,cr,new Set([e]))}function dr(t){const e=new Set;return function t(i){if(!e.has(i)&&ar(i)){e.add(i);const s=i[cr]?Array.from(i[cr]):[];for(const e of s)t(e)}}(t),Array.from(e)}function pr(t){return t[ur]||t}function fr(){const t=bn(Li());return t.getActiveSpan?t.getActiveSpan():ln(vn())}function mr(){tr||(Hi(()=>{}),tr=!0)}let gr=!1;function yr(t){if("boolean"==typeof __SENTRY_TRACING__&&!__SENTRY_TRACING__)return!1;const e=t||Sn()?.getOptions();return!(!e||null==e.tracesSampleRate&&!e.tracesSampler)}function br(t){Ji.log(`Ignoring span ${t.op} - ${t.description} because it matches \`ignoreSpans\`.`)}function vr(t,e){if(!e?.length||!t.description)return!1;for(const i of e){if(Mr(i)){if($s(t.description,i))return zi&&br(t),!0;continue}if(!i.name&&!i.op)continue;const e=!i.name||$s(t.description,i.name),s=!i.op||t.op&&$s(t.op,i.op);if(e&&s)return zi&&br(t),!0}return!1}function wr(t,e){const i=e.parent_span_id,s=e.span_id;if(i)for(const e of t)e.parent_span_id===s&&(e.parent_span_id=i)}function Mr(t){return"string"==typeof t||t instanceof RegExp}const Sr="production",kr="_frozenDsc";function xr(t,e){js(t,kr,e)}function Tr(t,e){const i=e.getOptions(),{publicKey:s}=e.getDsn()||{},n={environment:i.environment||Sr,release:i.release,public_key:s,trace_id:t,org_id:Xn(e)};return e.emit("createDsc",n),n}function Er(t,e){const i=e.getPropagationContext();return i.dsc||Tr(i.traceId,t)}function Cr(t){const e=Sn();if(!e)return{};const i=pr(t),s=or(i),n=s.data,r=i.spanContext().traceState,o=r?.get("sentry.sample_rate")??n[Tn]??n[En];function a(t){return"number"!=typeof o&&"string"!=typeof o||(t.sample_rate=`${o}`),t}const h=i[kr];if(h)return a(h);const c=r?.get("sentry.dsc"),u=c&&Gn(c);if(u)return a(u);const l=Tr(t.spanContext().traceId,e),d=n[xn],p=s.description;return"url"!==d&&p&&(l.transaction=p),yr()&&(l.sampled=String(ar(i)),l.sample_rand=r?.get("sentry.sample_rand")??jn(i).scope?.getPropagationContext().sampleRand.toString()),a(l),e.emit("createDsc",l,i),l}class Ar{constructor(t={}){this.ct=t.traceId||an(),this.ut=t.spanId||hn()}spanContext(){return{spanId:this.ut,traceId:this.ct,traceFlags:0}}end(t){}setAttribute(t,e){return this}setAttributes(t){return this}setStatus(t){return this}updateName(t){return this}isRecording(){return!1}addEvent(t,e,i){return this}addLink(t){return this}addLinks(t){return this}recordException(t,e){}}function Ir(t,e=100,i=1/0){try{return _r("",t,e,i)}catch(t){return{ERROR:`**non-serializable** (${t})`}}}function Fr(t,e=3,i=102400){const s=Ir(t,e);return n=s,function(t){return~-encodeURI(t).split(/%..|./).length}(JSON.stringify(n))>i?Fr(t,e-1,i):s;var n}function _r(t,e,i=1/0,s=1/0,n=function(){const t=new WeakSet;return[function(e){return!!t.has(e)||(t.add(e),!1)},function(e){t.delete(e)}]}()){const[r,o]=n;if(null==e||["boolean","string"].includes(typeof e)||"number"==typeof e&&Number.isFinite(e))return e;const a=function(t,e){try{if("domain"===t&&e&&"object"==typeof e&&e.lt)return"[Domain]";if("domainEmitter"===t)return"[DomainEmitter]";if("undefined"!=typeof global&&e===global)return"[Global]";if("undefined"!=typeof window&&e===window)return"[Window]";if("undefined"!=typeof document&&e===document)return"[Document]";if(As(e))return"[VueViewModel]";if(xs(i=e)&&"nativeEvent"in i&&"preventDefault"in i&&"stopPropagation"in i)return"[SyntheticEvent]";if("number"==typeof e&&!Number.isFinite(e))return`[${e}]`;if("function"==typeof e)return`[Function: ${ss(e)}]`;if("symbol"==typeof e)return`[${String(e)}]`;if("bigint"==typeof e)return`[BigInt: ${String(e)}]`;const s=function(t){const e=Object.getPrototypeOf(t);return e?.constructor?e.constructor.name:"null prototype"}(e);return/^HTML(\w*)Element$/.test(s)?`[HTMLElement: ${s}]`:`[object ${s}]`}catch(t){return`**non-serializable** (${t})`}var i}(t,e);if(!a.startsWith("[object "))return a;if(e.dt)return e;const h="number"==typeof e.ft?e.ft:i;if(0===h)return a.replace("object ","");if(r(e))return"[Circular ~]";const c=e;if(c&&"function"==typeof c.toJSON)try{return _r("",c.toJSON(),h-1,s,n)}catch{}const u=Array.isArray(e)?[]:{};let l=0;const d=Gs(e);for(const t in d){if(!{}.hasOwnProperty.call(d,t))continue;if(l>=s){u[t]="[MaxProperties ~]";break}const e=d[t];u[t]=_r(t,e,h-1,s,n),l++}return o(e),u}function Rr(t,e=[]){return[t,e]}function Pr(t,e){const[i,s]=t;return[i,[...s,e]]}function Or(t,e){const i=t[1];for(const t of i)if(e(t,t[0].type))return!0;return!1}function Br(t){const e=Ni(qi);return e.encodePolyfill?e.encodePolyfill(t):(new TextEncoder).encode(t)}function Dr(t){const[e,i]=t;let s=JSON.stringify(e);function n(t){"string"==typeof s?s="string"==typeof t?s+t:[Br(s),t]:s.push("string"==typeof t?Br(t):t)}for(const t of i){const[e,i]=t;if(n(`\n${JSON.stringify(e)}\n`),"string"==typeof i||i instanceof Uint8Array)n(i);else{let t;try{t=JSON.stringify(i)}catch{t=JSON.stringify(Ir(i))}n(t)}}return"string"==typeof s?s:function(t){const e=t.reduce((t,e)=>t+e.length,0),i=new Uint8Array(e);let s=0;for(const e of t)i.set(e,s),s+=e.length;return i}(s)}function $r(t){return[{type:"span"},t]}function zr(t){const e="string"==typeof t.data?Br(t.data):t.data;return[{type:"attachment",length:e.length,filename:t.filename,content_type:t.contentType,attachment_type:t.attachmentType},e]}const qr={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",profile_chunk:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",raw_security:"security",log:"log_item",metric:"metric",trace_metric:"metric"};function jr(t){return qr[t]}function Lr(t){if(!t?.sdk)return;const{name:e,version:i}=t.sdk;return{name:e,version:i}}function Nr(t,e,i,s){const n=t.sdkProcessingMetadata?.dynamicSamplingContext;return{event_id:t.event_id,sent_at:(new Date).toISOString(),...e&&{sdk:e},...!!i&&s&&{dsn:Vn(s)},...n&&{trace:n}}}function Gr(t){if(!t||0===t.length)return;const e={};return t.forEach(t=>{const i=t.attributes||{},s=i[Fn],n=i[_n];"string"==typeof s&&"number"==typeof n&&(e[t.name]={value:n,unit:s})}),e}class Ur{constructor(t={}){this.ct=t.traceId||an(),this.ut=t.spanId||hn(),this.gt=t.startTimestamp||sn(),this.yt=t.links,this.bt={},this.setAttributes({[An]:"manual",[Cn]:t.op,...t.attributes}),this.vt=t.name,t.parentSpanId&&(this.wt=t.parentSpanId),"sampled"in t&&(this.Mt=t.sampled),t.endTimestamp&&(this.St=t.endTimestamp),this.lt=[],this.kt=t.isStandalone,this.St&&this.xt()}addLink(t){return this.yt?this.yt.push(t):this.yt=[t],this}addLinks(t){return this.yt?this.yt.push(...t):this.yt=t,this}recordException(t,e){}spanContext(){const{ut:t,ct:e,Mt:i}=this;return{spanId:t,traceId:e,traceFlags:i?1:0}}setAttribute(t,e){return void 0===e?delete this.bt[t]:this.bt[t]=e,this}setAttributes(t){return Object.keys(t).forEach(e=>this.setAttribute(e,t[e])),this}updateStartTime(t){this.gt=nr(t)}setStatus(t){return this.Tt=t,this}updateName(t){return this.vt=t,this.setAttribute(xn,"custom"),this}end(t){this.St||(this.St=nr(t),function(t){if(!zi)return;const{description:e="< unknown name >",op:i="< unknown op >"}=or(t),{spanId:s}=t.spanContext(),n=`[Tracing] Finishing "${i}" ${pr(t)===t?"root ":""}span "${e}" with ID ${s}`;Ji.log(n)}(this),this.xt())}getSpanJSON(){return{data:this.bt,description:this.vt,op:this.bt[Cn],parent_span_id:this.wt,span_id:this.ut,start_timestamp:this.gt,status:hr(this.Tt),timestamp:this.St,trace_id:this.ct,origin:this.bt[An],profile_id:this.bt[Pn],exclusive_time:this.bt[On],measurements:Gr(this.lt),is_segment:this.kt&&pr(this)===this||void 0,segment_id:this.kt?pr(this).spanContext().spanId:void 0,links:sr(this.yt)}}isRecording(){return!this.St&&!!this.Mt}addEvent(t,e,i){zi&&Ji.log("[Tracing] Adding an event to span:",t);const s=Wr(e)?e:i||sn(),n=Wr(e)?{}:e||{},r={name:t,time:nr(s),attributes:n};return this.lt.push(r),this}isStandaloneSpan(){return!!this.kt}xt(){const t=Sn();if(t&&t.emit("spanEnd",this),!this.kt&&this!==pr(this))return;if(this.kt)return void(this.Mt?function(t){const e=Sn();if(!e)return;const i=t[1];i&&0!==i.length?e.sendEnvelope(t):e.recordDroppedEvent("before_send","span")}(function(t,e){const i=Cr(t[0]),s=e?.getDsn(),n=e?.getOptions().tunnel,r={sent_at:(new Date).toISOString(),...function(t){return!!t.trace_id&&!!t.public_key}(i)&&{trace:i},...!!n&&s&&{dsn:Vn(s)}},{beforeSendSpan:o,ignoreSpans:a}=e?.getOptions()||{},h=a?.length?t.filter(t=>!vr(or(t),a)):t,c=t.length-h.length;c&&e?.recordDroppedEvent("before_send","span",c);const u=o?t=>{const e=or(t);return o(e)||(mr(),e)}:or,l=[];for(const t of h){const e=u(t);e&&l.push($r(e))}return Rr(r,l)}([this],t)):(zi&&Ji.log("[Tracing] Discarding standalone span because its trace was not chosen to be sampled."),t&&t.recordDroppedEvent("sample_rate","span")));const e=this.Et();e&&(jn(this).scope||vn()).captureEvent(e)}Et(){if(!Hr(or(this)))return;this.vt||(zi&&Ji.warn("Transaction has no name, falling back to `<unlabeled transaction>`."),this.vt="<unlabeled transaction>");const{scope:t,isolationScope:e}=jn(this),i=t?.getScopeData().sdkProcessingMetadata?.normalizedRequest;if(!0!==this.Mt)return;const s=dr(this).filter(t=>t!==this&&!function(t){return t instanceof Ur&&t.isStandaloneSpan()}(t)).map(t=>or(t)).filter(Hr),n=this.bt[xn];delete this.bt[Rn],s.forEach(t=>{delete t.data[Rn]});const r={contexts:{trace:er(this)},spans:s.length>1e3?s.sort((t,e)=>t.start_timestamp-e.start_timestamp).slice(0,1e3):s,start_timestamp:this.gt,timestamp:this.St,transaction:this.vt,type:"transaction",sdkProcessingMetadata:{capturedSpanScope:t,capturedSpanIsolationScope:e,dynamicSamplingContext:Cr(this)},request:i,...n&&{transaction_info:{source:n}}},o=Gr(this.lt);return o&&Object.keys(o).length&&(zi&&Ji.log("[Measurements] Adding measurements to transaction event",JSON.stringify(o,void 0,2)),r.measurements=o),r}}function Wr(t){return t&&"number"==typeof t||t instanceof Date||Array.isArray(t)}function Hr(t){return!!(t.start_timestamp&&t.timestamp&&t.span_id&&t.trace_id)}const Vr="__SENTRY_SUPPRESS_TRACING__";function Yr(t){const e=Qr();if(e.startInactiveSpan)return e.startInactiveSpan(t);const i=Kr(t),{forceTransaction:s,parentSpan:n}=t;return(t.scope?e=>Mn(t.scope,e):void 0!==n?t=>Xr(n,t):t=>t())(()=>{const e=vn(),r=to(e,n);return t.onlyIfParent&&!r?new Ar:Jr({parentSpan:r,spanArguments:i,forceTransaction:s,scope:e})})}function Xr(t,e){const i=Qr();return i.withActiveSpan?i.withActiveSpan(t,e):Mn(i=>(un(i,t||void 0),e(i)))}function Jr({parentSpan:t,spanArguments:e,forceTransaction:i,scope:s}){if(!yr()){const s=new Ar;return!i&&t||xr(s,{sampled:"false",sample_rate:"0",transaction:e.name,...Cr(s)}),s}const n=wn();let r;if(t&&!i)r=function(t,e,i){const{spanId:s,traceId:n}=t.spanContext(),r=!e.getScopeData().sdkProcessingMetadata[Vr]&&ar(t),o=r?new Ur({...i,parentSpanId:s,traceId:n,sampled:r}):new Ar({traceId:n});lr(t,o);const a=Sn();return a&&(a.emit("spanStart",o),i.endTimestamp&&a.emit("spanEnd",o)),o}(t,s,e),lr(t,r);else if(t){const i=Cr(t),{traceId:n,spanId:o}=t.spanContext(),a=ar(t);r=Zr({traceId:n,parentSpanId:o,...e},s,a),xr(r,i)}else{const{traceId:t,dsc:i,parentSpanId:o,sampled:a}={...n.getPropagationContext(),...s.getPropagationContext()};r=Zr({traceId:t,parentSpanId:o,...e},s,a),i&&xr(r,i)}return function(t){if(!zi)return;const{description:e="< unknown name >",op:i="< unknown op >",parent_span_id:s}=or(t),{spanId:n}=t.spanContext(),r=ar(t),o=pr(t),a=o===t,h=`[Tracing] Starting ${r?"sampled":"unsampled"} ${a?"root ":""}span`,c=[`op: ${i}`,`name: ${e}`,`ID: ${n}`];if(s&&c.push(`parent ID: ${s}`),!a){const{op:t,description:e}=or(o);c.push(`root ID: ${o.spanContext().spanId}`),t&&c.push(`root op: ${t}`),e&&c.push(`root description: ${e}`)}Ji.log(`${h}\n  ${c.join("\n  ")}`)}(r),function(t,e,i){t&&(js(t,zn,function(t){try{const e=qi.WeakRef;if("function"==typeof e)return new e(t)}catch{}return t}(i)),js(t,$n,e))}(r,s,n),r}function Kr(t){const e={isStandalone:(t.experimental||{}).standalone,...t};if(t.startTime){const i={...e};return i.startTimestamp=nr(t.startTime),delete i.startTime,i}return e}function Qr(){return bn(Li())}function Zr(t,e,i){const s=Sn(),n=s?.getOptions()||{},{name:r=""}=t,o={spanAttributes:{...t.attributes},spanName:r,parentSampled:i};s?.emit("beforeSampling",o,{decision:!1});const a=o.parentSampled??i,h=o.spanAttributes,c=e.getPropagationContext(),[u,l,d]=e.getScopeData().sdkProcessingMetadata[Vr]?[!1]:function(t,e,i){if(!yr(t))return[!1];let s,n;"function"==typeof t.tracesSampler?(n=t.tracesSampler({...e,inheritOrSampleWith:t=>"number"==typeof e.parentSampleRate?e.parentSampleRate:"boolean"==typeof e.parentSampled?Number(e.parentSampled):t}),s=!0):void 0!==e.parentSampled?n=e.parentSampled:void 0!==t.tracesSampleRate&&(n=t.tracesSampleRate,s=!0);const r=Jn(n);if(void 0===r)return zi&&Ji.warn(`[Tracing] Discarding root span because of invalid sample rate. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(n)} of type ${JSON.stringify(typeof n)}.`),[!1];if(!r)return zi&&Ji.log("[Tracing] Discarding transaction because "+("function"==typeof t.tracesSampler?"tracesSampler returned 0 or false":"a negative sampling decision was inherited or tracesSampleRate is set to 0")),[!1,r,s];const o=i<r;return o||zi&&Ji.log(`[Tracing] Discarding transaction because it's not included in the random sample (sampling rate = ${Number(n)})`),[o,r,s]}(n,{name:r,parentSampled:a,attributes:h,parentSampleRate:Jn(c.dsc?.sample_rate)},c.sampleRand),p=new Ur({...t,attributes:{[xn]:"custom",[Tn]:void 0!==l&&d?l:void 0,...h},sampled:u});return!u&&s&&(zi&&Ji.log("[Tracing] Discarding root span because its trace was not chosen to be sampled."),s.recordDroppedEvent("sample_rate","transaction")),s&&s.emit("spanStart",p),p}function to(t,e){if(e)return e;if(null===e)return;const i=ln(t);if(!i)return;const s=Sn();return(s?s.getOptions():{}).parentSpanIsAlwaysRootSpan?pr(i):i}const eo={idleTimeout:1e3,finalTimeout:3e4,childSpanTimeout:15e3};function io(t,e={}){const i=new Map;let s,n=!1,r="externalFinish",o=!e.disableAutoFinish;const a=[],{idleTimeout:h=eo.idleTimeout,finalTimeout:c=eo.finalTimeout,childSpanTimeout:u=eo.childSpanTimeout,beforeSpanEnd:l,trimIdleSpanEndTimestamp:d=!0}=e,p=Sn();if(!p||!yr()){const t=new Ar;return xr(t,{sample_rate:"0",sampled:"false",...Cr(t)}),t}const f=vn(),m=fr(),g=function(t){const e=Yr(t);return un(vn(),e),zi&&Ji.log("[Tracing] Started span is an idle span"),e}(t);function y(){s&&(clearTimeout(s),s=void 0)}function b(t){y(),s=setTimeout(()=>{!n&&0===i.size&&o&&(r="idleTimeout",g.end(t))},h)}function v(t){s=setTimeout(()=>{!n&&o&&(r="heartbeatFailed",g.end(t))},u)}function w(t){n=!0,i.clear(),a.forEach(t=>t()),un(f,m);const e=or(g),{start_timestamp:s}=e;if(!s)return;e.data[In]||g.setAttribute(In,r),Ji.log(`[Tracing] Idle span "${e.op}" finished`);const o=dr(g).filter(t=>t!==g);let u=0;o.forEach(e=>{e.isRecording()&&(e.setStatus({code:2,message:"cancelled"}),e.end(t),zi&&Ji.log("[Tracing] Cancelling span since span ended early",JSON.stringify(e,void 0,2)));const i=or(e),{timestamp:s=0,start_timestamp:n=0}=i,r=n<=t,o=s-n<=(c+h)/1e3;if(zi){const t=JSON.stringify(e,void 0,2);r?o||Ji.log("[Tracing] Discarding span since it finished after idle span final timeout",t):Ji.log("[Tracing] Discarding span since it happened after idle span was finished",t)}o&&r||(function(t,e){t[cr]&&t[cr].delete(e)}(g,e),u++)}),u>0&&g.setAttribute("sentry.idle_span_discarded_spans",u)}return g.end=new Proxy(g.end,{apply(t,e,i){if(l&&l(g),e instanceof Ar)return;const[s,...n]=i,r=nr(s||sn()),o=dr(g).filter(t=>t!==g),a=or(g);if(!o.length||!d)return w(r),Reflect.apply(t,e,[r,...n]);const h=p.getOptions().ignoreSpans,u=o?.reduce((t,e)=>{const i=or(e);return i.timestamp?h&&vr(i,h)?t:t?Math.max(t,i.timestamp):i.timestamp:t},void 0),f=a.start_timestamp,m=Math.min(f?f+c/1e3:1/0,Math.max(f||-1/0,Math.min(r,u||1/0)));return w(m),Reflect.apply(t,e,[m,...n])}}),a.push(p.on("spanStart",t=>{var e;n||t===g||or(t).timestamp||t instanceof Ur&&t.isStandaloneSpan()||dr(g).includes(t)&&(e=t.spanContext().spanId,y(),i.set(e,!0),v(sn()+u/1e3))})),a.push(p.on("spanEnd",t=>{var e;n||(e=t.spanContext().spanId,i.has(e)&&i.delete(e),0===i.size&&b(sn()+h/1e3))})),a.push(p.on("idleSpanEnableAutoFinish",t=>{t===g&&(o=!0,b(),i.size&&v())})),e.disableAutoFinish||b(),setTimeout(()=>{n||(g.setStatus({code:2,message:"deadline_exceeded"}),r="finalTimeout",g.end())},c),g}function so(t){return new ro(e=>{e(t)})}function no(t){return new ro((e,i)=>{i(t)})}class ro{constructor(t){this.Ct=0,this.At=[],this.It(t)}then(t,e){return new ro((i,s)=>{this.At.push([!1,e=>{if(t)try{i(t(e))}catch(t){s(t)}else i(e)},t=>{if(e)try{i(e(t))}catch(t){s(t)}else s(t)}]),this.Ft()})}catch(t){return this.then(t=>t,t)}finally(t){return new ro((e,i)=>{let s,n;return this.then(e=>{n=!1,s=e,t&&t()},e=>{n=!0,s=e,t&&t()}).then(()=>{n?i(s):e(s)})})}Ft(){if(0===this.Ct)return;const t=this.At.slice();this.At=[],t.forEach(t=>{t[0]||(1===this.Ct&&t[1](this._t),2===this.Ct&&t[2](this._t),t[0]=!0)})}It(t){const e=(t,e)=>{0===this.Ct&&(Es(e)?e.then(i,s):(this.Ct=t,this._t=e,this.Ft()))},i=t=>{e(1,t)},s=t=>{e(2,t)};try{t(i,s)}catch(t){s(t)}}}function oo(t,e,i,s=0){try{const n=ao(e,i,t,s);return Es(n)?n:so(n)}catch(t){return no(t)}}function ao(t,e,i,s){const n=i[s];if(!t||!n)return t;const r=n({...t},e);return zi&&null===r&&Ji.log(`Event processor "${n.id||"?"}" dropped event`),Es(r)?r.then(t=>ao(t,e,i,s+1)):ao(r,e,i,s+1)}function ho(t,e){const{extra:i,tags:s,user:n,contexts:r,level:o,sdkProcessingMetadata:a,breadcrumbs:h,fingerprint:c,eventProcessors:u,attachments:l,propagationContext:d,transactionName:p,span:f}=e;co(t,"extra",i),co(t,"tags",s),co(t,"user",n),co(t,"contexts",r),t.sdkProcessingMetadata=on(t.sdkProcessingMetadata,a,2),o&&(t.level=o),p&&(t.transactionName=p),f&&(t.span=f),h.length&&(t.breadcrumbs=[...t.breadcrumbs,...h]),c.length&&(t.fingerprint=[...t.fingerprint,...c]),u.length&&(t.eventProcessors=[...t.eventProcessors,...u]),l.length&&(t.attachments=[...t.attachments,...l]),t.propagationContext={...t.propagationContext,...d}}function co(t,e,i){t[e]=on(t[e],i,1)}let uo,lo,po,fo;function mo(t,e,i,s,n,r){const{normalizeDepth:o=3,normalizeMaxBreadth:a=1e3}=t,h={...e,event_id:e.event_id||i.event_id||Xs(),timestamp:e.timestamp||en()},c=i.integrations||t.integrations.map(t=>t.name);!function(t,e){const{environment:i,release:s,dist:n,maxValueLength:r=250}=e;t.environment=t.environment||i||Sr,!t.release&&s&&(t.release=s),!t.dist&&n&&(t.dist=n);const o=t.request;o?.url&&(o.url=Bs(o.url,r))}(h,t),function(t,e){e.length>0&&(t.sdk=t.sdk||{},t.sdk.integrations=[...t.sdk.integrations||[],...e])}(h,c),n&&n.emit("applyFrameMetadata",e),void 0===e.type&&function(t,e){const i=function(t){const e=qi.Rt,i=qi.Pt;if(!e&&!i)return{};const s=e?Object.keys(e):[],n=i?Object.keys(i):[];if(fo&&s.length===lo&&n.length===po)return fo;lo=s.length,po=n.length,fo={},uo||(uo={});const r=(e,i)=>{for(const s of e){const e=i[s],n=uo?.[s];if(n&&fo&&e)fo[n[0]]=e,uo&&(uo[s]=[n[0],e]);else if(e){const i=t(s);for(let t=i.length-1;t>=0;t--){const n=i[t],r=n?.filename;if(r&&fo&&uo){fo[r]=e,uo[s]=[r,e];break}}}}};return e&&r(s,e),i&&r(n,i),fo}(e);t.exception?.values?.forEach(t=>{t.stacktrace?.frames?.forEach(t=>{t.filename&&(t.debug_id=i[t.filename])})})}(h,t.stackParser);const u=function(t,e){if(!e)return t;const i=t?t.clone():new dn;return i.update(e),i}(s,i.captureContext);i.mechanism&&Zs(h,i.mechanism);const l=n?n.getEventProcessors():[],d=Gi("globalScope",()=>new dn).getScopeData();r&&ho(d,r.getScopeData()),u&&ho(d,u.getScopeData());const p=[...i.attachments||[],...d.attachments];return p.length&&(i.attachments=p),function(t,e){const{fingerprint:i,span:s,breadcrumbs:n,sdkProcessingMetadata:r}=e;!function(t,e){const{extra:i,tags:s,user:n,contexts:r,level:o,transactionName:a}=e;Object.keys(i).length&&(t.extra={...i,...t.extra}),Object.keys(s).length&&(t.tags={...s,...t.tags}),Object.keys(n).length&&(t.user={...n,...t.user}),Object.keys(r).length&&(t.contexts={...r,...t.contexts}),o&&(t.level=o),a&&"transaction"!==t.type&&(t.transaction=a)}(t,e),s&&function(t,e){t.contexts={trace:ir(e),...t.contexts},t.sdkProcessingMetadata={dynamicSamplingContext:Cr(e),...t.sdkProcessingMetadata};const i=or(pr(e)).description;i&&!t.transaction&&"transaction"===t.type&&(t.transaction=i)}(t,s),function(t,e){t.fingerprint=t.fingerprint?Array.isArray(t.fingerprint)?t.fingerprint:[t.fingerprint]:[],e&&(t.fingerprint=t.fingerprint.concat(e)),t.fingerprint.length||delete t.fingerprint}(t,i),function(t,e){const i=[...t.breadcrumbs||[],...e];t.breadcrumbs=i.length?i:void 0}(t,n),function(t,e){t.sdkProcessingMetadata={...t.sdkProcessingMetadata,...e}}(t,r)}(h,d),oo([...l,...d.eventProcessors],h,i).then(t=>(t&&function(t){const e={};if(t.exception?.values?.forEach(t=>{t.stacktrace?.frames?.forEach(t=>{t.debug_id&&(t.abs_path?e[t.abs_path]=t.debug_id:t.filename&&(e[t.filename]=t.debug_id),delete t.debug_id)})}),0===Object.keys(e).length)return;t.debug_meta=t.debug_meta||{},t.debug_meta.images=t.debug_meta.images||[];const i=t.debug_meta.images;Object.entries(e).forEach(([t,e])=>{i.push({type:"sourcemap",code_file:t,debug_id:e})})}(t),"number"==typeof o&&o>0?function(t,e,i){if(!t)return null;const s={...t,...t.breadcrumbs&&{breadcrumbs:t.breadcrumbs.map(t=>({...t,...t.data&&{data:Ir(t.data,e,i)}}))},...t.user&&{user:Ir(t.user,e,i)},...t.contexts&&{contexts:Ir(t.contexts,e,i)},...t.extra&&{extra:Ir(t.extra,e,i)}};return t.contexts?.trace&&s.contexts&&(s.contexts.trace=t.contexts.trace,t.contexts.trace.data&&(s.contexts.trace.data=Ir(t.contexts.trace.data,e,i))),t.spans&&(s.spans=t.spans.map(t=>({...t,...t.data&&{data:Ir(t.data,e,i)}}))),t.contexts?.flags&&s.contexts&&(s.contexts.flags=Ir(t.contexts.flags,3,i)),s}(t,o,a):t))}const go=["user","level","extra","contexts","tags","fingerprint","propagationContext"];function yo(t,e){return vn().captureException(t,function(t){if(t)return function(t){return t instanceof dn||"function"==typeof t}(t)||function(t){return Object.keys(t).some(t=>go.includes(t))}(t)?{captureContext:t}:t}(e))}function bo(t,e){return vn().captureEvent(t,e)}function vo(t){const e=wn(),i=vn(),{userAgent:s}=qi.navigator||{},n=function(t){const e=sn(),i={sid:Xs(),init:!0,timestamp:e,started:e,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>function(t){return{sid:`${t.sid}`,init:t.init,started:new Date(1e3*t.started).toISOString(),timestamp:new Date(1e3*t.timestamp).toISOString(),status:t.status,errors:t.errors,did:"number"==typeof t.did||"string"==typeof t.did?`${t.did}`:void 0,duration:t.duration,abnormal_mechanism:t.abnormal_mechanism,attrs:{release:t.release,environment:t.environment,ip_address:t.ipAddress,user_agent:t.userAgent}}}(i)};return t&&rn(i,t),i}({user:i.getUser()||e.getUser(),...s&&{userAgent:s},...t}),r=e.getSession();return"ok"===r?.status&&rn(r,{status:"exited"}),wo(),e.setSession(n),n}function wo(){const t=wn(),e=vn().getSession()||t.getSession();e&&function(t){let e={};"ok"===t.status&&(e={status:"exited"}),rn(t,e)}(e),Mo(),t.setSession()}function Mo(){const t=wn(),e=Sn(),i=t.getSession();i&&e&&e.captureSession(i)}function So(t=!1){t?wo():Mo()}const ko=[];function xo(t){const e=t.defaultIntegrations||[],i=t.integrations;let s;if(e.forEach(t=>{t.isDefaultInstance=!0}),Array.isArray(i))s=[...e,...i];else if("function"==typeof i){const t=i(e);s=Array.isArray(t)?t:[t]}else s=e;return function(t){const e={};return t.forEach(t=>{const{name:i}=t,s=e[i];s&&!s.isDefaultInstance&&t.isDefaultInstance||(e[i]=t)}),Object.values(e)}(s)}function To(t,e){for(const i of e)i?.afterAllSetup&&i.afterAllSetup(t)}function Eo(t,e,i){if(i[e.name])zi&&Ji.log(`Integration skipped because it was already installed: ${e.name}`);else{if(i[e.name]=e,-1===ko.indexOf(e.name)&&"function"==typeof e.setupOnce&&(e.setupOnce(),ko.push(e.name)),e.setup&&"function"==typeof e.setup&&e.setup(t),"function"==typeof e.preprocessEvent){const i=e.preprocessEvent.bind(e);t.on("preprocessEvent",(e,s)=>i(e,s,t))}if("function"==typeof e.processEvent){const i=e.processEvent.bind(e),s=Object.assign((e,s)=>i(e,s,t),{id:e.name});t.addEventProcessor(s)}zi&&Ji.log(`Integration installed: ${e.name}`)}}function Co(t,e){const i=e??function(t){return Ao().get(t)}(t)??[];if(0===i.length)return;const s=t.getOptions(),n=function(t,e,i,s){const n={};return e?.sdk&&(n.sdk={name:e.sdk.name,version:e.sdk.version}),i&&s&&(n.dsn=Vn(s)),Rr(n,[(r=t,[{type:"log",item_count:r.length,content_type:"application/vnd.sentry.items.log+json"},{items:r}])]);var r}(i,s.Ot,s.tunnel,t.getDsn());Ao().set(t,[]),t.emit("flushLogs"),t.sendEnvelope(n)}function Ao(){return Gi("clientToLogBufferMap",()=>new WeakMap)}function Io(t,e){const i=e??function(t){return Fo().get(t)}(t)??[];if(0===i.length)return;const s=t.getOptions(),n=function(t,e,i,s){const n={};return e?.sdk&&(n.sdk={name:e.sdk.name,version:e.sdk.version}),i&&s&&(n.dsn=Vn(s)),Rr(n,[(r=t,[{type:"trace_metric",item_count:r.length,content_type:"application/vnd.sentry.items.trace-metric+json"},{items:r}])]);var r}(i,s.Ot,s.tunnel,t.getDsn());Fo().set(t,[]),t.emit("flushMetrics"),t.sendEnvelope(n)}function Fo(){return Gi("clientToMetricBufferMap",()=>new WeakMap)}function _o(t){const e=[];t.message&&e.push(t.message);try{const i=t.exception.values[t.exception.values.length-1];i?.value&&(e.push(i.value),i.type&&e.push(`${i.type}: ${i.value}`))}catch{}return e}const Ro="Not capturing exception because it's already been captured.",Po="Discarded session because of missing or non-string release",Oo=Symbol.for("SentryInternalError"),Bo=Symbol.for("SentryDoNotSendEventError");function Do(t){return{message:t,[Oo]:!0}}function $o(t){return{message:t,[Bo]:!0}}function zo(t){return!!t&&"object"==typeof t&&Oo in t}function qo(t){return!!t&&"object"==typeof t&&Bo in t}function jo(t,e,i,s,n){let r,o=0;t.on(i,()=>{o=0,clearTimeout(r)}),t.on(e,e=>{o+=s(e),o>=8e5?n(t):(clearTimeout(r),r=setTimeout(()=>{n(t)},5e3))}),t.on("flush",()=>{n(t)})}class Lo{constructor(t){if(this.Bt=t,this.Dt={},this.$t=0,this.zt={},this.qt={},this.L=[],t.dsn?this.jt=function(t){const e="string"==typeof t?function(t){const e=Hn.exec(t);if(!e)return void Hi(()=>{});const[i,s,n="",r="",o="",a=""]=e.slice(1);let h="",c=a;const u=c.split("/");if(u.length>1&&(h=u.slice(0,-1).join("/"),c=u.pop()),c){const t=c.match(/^\d+/);t&&(c=t[0])}return Yn({host:r,pass:n,path:h,projectId:c,port:o,protocol:i,publicKey:s})}(t):Yn(t);if(e&&function(t){if(!zi)return!0;const{port:e,projectId:i,protocol:s}=t;return!(["protocol","publicKey","host","projectId"].find(e=>!t[e]&&(Ji.error(`Invalid Sentry Dsn: ${e} missing`),!0))||(i.match(/^\d+$/)?function(t){return"http"===t||"https"===t}(s)?e&&isNaN(parseInt(e,10))&&(Ji.error(`Invalid Sentry Dsn: Invalid port ${e}`),1):(Ji.error(`Invalid Sentry Dsn: Invalid protocol ${s}`),1):(Ji.error(`Invalid Sentry Dsn: Invalid projectId ${i}`),1)))}(e))return e}(t.dsn):zi&&Ji.warn("No DSN provided, client will not send events."),this.jt){const n=(e=this.jt,i=t.tunnel,s=t.Ot?t.Ot.sdk:void 0,i||`${function(t){return`${function(t){const e=t.protocol?`${t.protocol}:`:"",i=t.port?`:${t.port}`:"";return`${e}//${t.host}${i}${t.path?`/${t.path}`:""}/api/`}(t)}${t.projectId}/envelope/`}(e)}?${function(t,e){const i={sentry_version:"7"};return t.publicKey&&(i.sentry_key=t.publicKey),e&&(i.sentry_client=`${e.name}/${e.version}`),new URLSearchParams(i).toString()}(e,s)}`);this.Lt=t.transport({tunnel:this.Bt.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...t.transportOptions,url:n})}var e,i,s;this.Bt.enableLogs&&jo(this,"afterCaptureLog","flushLogs",Wo,Co),this.Bt.Nt?.enableMetrics&&jo(this,"afterCaptureMetric","flushMetrics",Uo,Io)}captureException(t,e,i){const s=Xs();if(tn(t))return zi&&Ji.log(Ro),s;const n={event_id:s,...e};return this.Gt(this.eventFromException(t,n).then(t=>this.Ut(t,n,i))),n.event_id}captureMessage(t,e,i,s){const n={event_id:Xs(),...i},r=Ss(t)?t:String(t),o=ks(t)?this.eventFromMessage(r,e,n):this.eventFromException(t,n);return this.Gt(o.then(t=>this.Ut(t,n,s))),n.event_id}captureEvent(t,e,i){const s=Xs();if(e?.originalException&&tn(e.originalException))return zi&&Ji.log(Ro),s;const n={event_id:s,...e},r=t.sdkProcessingMetadata||{},o=r.capturedSpanScope,a=r.capturedSpanIsolationScope;return this.Gt(this.Ut(t,n,o||i,a)),n.event_id}captureSession(t){this.sendSession(t),rn(t,{init:!1})}getDsn(){return this.jt}getOptions(){return this.Bt}getSdkMetadata(){return this.Bt.Ot}getTransport(){return this.Lt}async flush(t){const e=this.Lt;if(!e)return!0;this.emit("flush");const i=await this.Wt(t),s=await e.flush(t);return i&&s}async close(t){const e=await this.flush(t);return this.getOptions().enabled=!1,this.emit("close"),e}getEventProcessors(){return this.L}addEventProcessor(t){this.L.push(t)}init(){(this.Ht()||this.Bt.integrations.some(({name:t})=>t.startsWith("Spotlight")))&&this.Vt()}getIntegrationByName(t){return this.Dt[t]}addIntegration(t){const e=this.Dt[t.name];Eo(this,t,this.Dt),e||To(this,[t])}sendEvent(t,e={}){this.emit("beforeSendEvent",t,e);let i=function(t,e,i,s){const n=Lr(i),r=t.type&&"replay_event"!==t.type?t.type:"event";!function(t,e){if(!e)return t;const i=t.sdk||{};t.sdk={...i,name:i.name||e.name,version:i.version||e.version,integrations:[...t.sdk?.integrations||[],...e.integrations||[]],packages:[...t.sdk?.packages||[],...e.packages||[]],settings:t.sdk?.settings||e.settings?{...t.sdk?.settings,...e.settings}:void 0}}(t,i?.sdk);const o=Nr(t,n,s,e);return delete t.sdkProcessingMetadata,Rr(o,[[{type:r},t]])}(t,this.jt,this.Bt.Ot,this.Bt.tunnel);for(const t of e.attachments||[])i=Pr(i,zr(t));this.sendEnvelope(i).then(e=>this.emit("afterSendEvent",t,e))}sendSession(t){const{release:e,environment:i=Sr}=this.Bt;if("aggregates"in t){const s=t.attrs||{};if(!s.release&&!e)return void(zi&&Ji.warn(Po));s.release=s.release||e,s.environment=s.environment||i,t.attrs=s}else{if(!t.release&&!e)return void(zi&&Ji.warn(Po));t.release=t.release||e,t.environment=t.environment||i}this.emit("beforeSendSession",t);const s=function(t,e,i,s){const n=Lr(i);return Rr({sent_at:(new Date).toISOString(),...n&&{sdk:n},...!!s&&e&&{dsn:Vn(e)}},["aggregates"in t?[{type:"sessions"},t]:[{type:"session"},t.toJSON()]])}(t,this.jt,this.Bt.Ot,this.Bt.tunnel);this.sendEnvelope(s)}recordDroppedEvent(t,e,i=1){if(this.Bt.sendClientReports){const s=`${t}:${e}`;zi&&Ji.log(`Recording outcome: "${s}"${i>1?` (${i} times)`:""}`),this.zt[s]=(this.zt[s]||0)+i}}on(t,e){const i=this.qt[t]=this.qt[t]||new Set,s=(...t)=>e(...t);return i.add(s),()=>{i.delete(s)}}emit(t,...e){const i=this.qt[t];i&&i.forEach(t=>t(...e))}async sendEnvelope(t){if(this.emit("beforeEnvelope",t),this.Ht()&&this.Lt)try{return await this.Lt.send(t)}catch(t){return zi&&Ji.error("Error while sending envelope:",t),{}}return zi&&Ji.error("Transport disabled"),{}}Vt(){const{integrations:t}=this.Bt;this.Dt=function(t,e){const i={};return e.forEach(e=>{e&&Eo(t,e,i)}),i}(this,t),To(this,t)}Yt(t,e){let i="fatal"===e.level,s=!1;const n=e.exception?.values;if(n){s=!0;for(const t of n){const e=t.mechanism;if(!1===e?.handled){i=!0;break}}}const r="ok"===t.status;(r&&0===t.errors||r&&i)&&(rn(t,{...i&&{status:"crashed"},errors:t.errors||Number(s||i)}),this.captureSession(t))}async Wt(t){let e=0;for(;!t||e<t;){if(await new Promise(t=>setTimeout(t,1)),!this.$t)return!0;e++}return!1}Ht(){return!1!==this.getOptions().enabled&&void 0!==this.Lt}Xt(t,e,i,s){const n=this.getOptions(),r=Object.keys(this.Dt);return!e.integrations&&r?.length&&(e.integrations=r),this.emit("preprocessEvent",t,e),t.type||s.setLastEventId(t.event_id||e.event_id),mo(n,t,e,i,this,s).then(t=>{if(null===t)return t;this.emit("postprocessEvent",t,e),t.contexts={trace:kn(i),...t.contexts};const s=Er(this,i);return t.sdkProcessingMetadata={dynamicSamplingContext:s,...t.sdkProcessingMetadata},t})}Ut(t,e={},i=vn(),s=wn()){return zi&&No(t)&&Ji.log(`Captured error event \`${_o(t)[0]||"<unknown>"}\``),this.Jt(t,e,i,s).then(t=>t.event_id,t=>{zi&&(qo(t)?Ji.log(t.message):zo(t)?Ji.warn(t.message):Ji.warn(t))})}Jt(t,e,i,s){const n=this.getOptions(),{sampleRate:r}=n,o=Go(t),a=No(t),h=t.type||"error",c=`before send for type \`${h}\``,u=void 0===r?void 0:Jn(r);if(a&&"number"==typeof u&&Math.random()>u)return this.recordDroppedEvent("sample_rate","error"),no($o(`Discarding event because it's not included in the random sample (sampling rate = ${r})`));const l="replay_event"===h?"replay":h;return this.Xt(t,e,i,s).then(t=>{if(null===t)throw this.recordDroppedEvent("event_processor",l),$o("An event processor returned `null`, will not send event.");if(e.data&&!0===e.data.Kt)return t;const i=function(t,e,i,s){const{beforeSend:n,beforeSendTransaction:r,beforeSendSpan:o,ignoreSpans:a}=e;let h=i;if(No(h)&&n)return n(h,s);if(Go(h)){if(o||a){const e=function(t){const{trace_id:e,parent_span_id:i,span_id:s,status:n,origin:r,data:o,op:a}=t.contexts?.trace??{};return{data:o??{},description:t.transaction,op:a,parent_span_id:i,span_id:s??"",start_timestamp:t.start_timestamp??0,status:n,timestamp:t.timestamp,trace_id:e??"",origin:r,profile_id:o?.[Pn],exclusive_time:o?.[On],measurements:t.measurements,is_segment:!0}}(h);if(a?.length&&vr(e,a))return null;if(o){const t=o(e);t?h=on(i,{type:"transaction",timestamp:(c=t).timestamp,start_timestamp:c.start_timestamp,transaction:c.description,contexts:{trace:{trace_id:c.trace_id,span_id:c.span_id,parent_span_id:c.parent_span_id,op:c.op,status:c.status,origin:c.origin,data:{...c.data,...c.profile_id&&{[Pn]:c.profile_id},...c.exclusive_time&&{[On]:c.exclusive_time}}}},measurements:c.measurements}):mr()}if(h.spans){const e=[],i=h.spans;for(const t of i)if(a?.length&&vr(t,a))wr(i,t);else if(o){const i=o(t);i?e.push(i):(mr(),e.push(t))}else e.push(t);const s=h.spans.length-e.length;s&&t.recordDroppedEvent("before_send","span",s),h.spans=e}}if(r){if(h.spans){const t=h.spans.length;h.sdkProcessingMetadata={...i.sdkProcessingMetadata,spanCountBeforeProcessing:t}}return r(h,s)}}var c;return h}(this,n,t,e);return function(t,e){const i=`${e} must return \`null\` or a valid event.`;if(Es(t))return t.then(t=>{if(!xs(t)&&null!==t)throw Do(i);return t},t=>{throw Do(`${e} rejected with ${t}`)});if(!xs(t)&&null!==t)throw Do(i);return t}(i,c)}).then(n=>{if(null===n){if(this.recordDroppedEvent("before_send",l),o){const e=1+(t.spans||[]).length;this.recordDroppedEvent("before_send","span",e)}throw $o(`${c} returned \`null\`, will not send event.`)}const r=i.getSession()||s.getSession();if(a&&r&&this.Yt(r,n),o){const t=(n.sdkProcessingMetadata?.spanCountBeforeProcessing||0)-(n.spans?n.spans.length:0);t>0&&this.recordDroppedEvent("before_send","span",t)}const h=n.transaction_info;if(o&&h&&n.transaction!==t.transaction){const t="custom";n.transaction_info={...h,source:t}}return this.sendEvent(n,e),n}).then(null,t=>{if(qo(t)||zo(t))throw t;throw this.captureException(t,{mechanism:{handled:!1,type:"internal"},data:{Kt:!0},originalException:t}),Do(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.\nReason: ${t}`)})}Gt(t){this.$t++,t.then(t=>(this.$t--,t),t=>(this.$t--,t))}Qt(){const t=this.zt;return this.zt={},Object.entries(t).map(([t,e])=>{const[i,s]=t.split(":");return{reason:i,category:s,quantity:e}})}Zt(){zi&&Ji.log("Flushing outcomes...");const t=this.Qt();if(0===t.length)return void(zi&&Ji.log("No outcomes to send"));if(!this.jt)return void(zi&&Ji.log("No dsn provided, will not send outcomes"));zi&&Ji.log("Sending outcomes:",t);const e=(i=t,Rr((s=this.Bt.tunnel&&Vn(this.jt))?{dsn:s}:{},[[{type:"client_report"},{timestamp:en(),discarded_events:i}]]));var i,s;this.sendEnvelope(e)}}function No(t){return void 0===t.type}function Go(t){return"transaction"===t.type}function Uo(t){let e=0;return t.name&&(e+=2*t.name.length),"string"==typeof t.value?e+=2*t.value.length:e+=8,e+Ho(t.attributes)}function Wo(t){let e=0;return t.message&&(e+=2*t.message.length),e+Ho(t.attributes)}function Ho(t){if(!t)return 0;let e=0;return Object.values(t).forEach(t=>{Array.isArray(t)?e+=t.length*Vo(t[0]):ks(t)?e+=Vo(t):e+=100}),e}function Vo(t){return"string"==typeof t?2*t.length:"number"==typeof t?8:"boolean"==typeof t?4:0}const Yo=Symbol.for("SentryBufferFullError");function Xo(t,e,i=Date.now()){return function(t,e){return t[e]||t.all||0}(t,e)>i}function Jo(t,{statusCode:e,headers:i},s=Date.now()){const n={...t},r=i?.["x-sentry-rate-limits"],o=i?.["retry-after"];if(r)for(const t of r.trim().split(",")){const[e,i,,,r]=t.split(":",5),o=parseInt(e,10),a=1e3*(isNaN(o)?60:o);if(i)for(const t of i.split(";"))"metric_bucket"===t&&r&&!r.split(";").includes("custom")||(n[t]=s+a);else n.all=s+a}else o?n.all=s+function(t,e=Date.now()){const i=parseInt(`${t}`,10);if(!isNaN(i))return 1e3*i;const s=Date.parse(`${t}`);return isNaN(s)?6e4:s-e}(o,s):429===e&&(n.all=s+6e4);return n}function Ko(t){return"isRelative"in t}function Qo(t,e){const i=t.indexOf("://")<=0&&0!==t.indexOf("//"),s=i?"thismessage:/":void 0;try{if("canParse"in URL&&!URL.canParse(t,s))return;const e=new URL(t,s);return i?{isRelative:i,pathname:e.pathname,search:e.search,hash:e.hash}:e}catch{}}function Zo(t){if(Ko(t))return t.pathname;const e=new URL(t);return e.search="",e.hash="",["80","443"].includes(e.port)&&(e.port=""),e.password&&(e.password="%filtered%"),e.username&&(e.username="%filtered%"),e.toString()}function ta(t){if(!t)return{};const e=t.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};const i=e[6]||"",s=e[8]||"";return{host:e[4],path:e[5],protocol:e[2],search:i,hash:s,relative:e[5]+i+s}}function ea(t){return"/"===t[t.length-1]?t.slice(0,-1):t}function ia(t){"aggregates"in t?void 0===t.attrs?.ip_address&&(t.attrs={...t.attrs,ip_address:"{{auto}}"}):void 0===t.ipAddress&&(t.ipAddress="{{auto}}")}function sa(t={}){const e=t.client||Sn();if(!function(){const t=Sn();return!1!==t?.getOptions().enabled&&!!t?.getTransport()}()||!e)return{};const i=bn(Li());if(i.getTraceData)return i.getTraceData(t);const s=t.scope||vn(),n=t.span||fr(),r=n?function(t){const{traceId:e,spanId:i}=t.spanContext();return Qn(e,i,ar(t))}(n):function(t){const{traceId:e,sampled:i,propagationSpanId:s}=t.getPropagationContext();return Qn(e,s,i)}(s),o=function(t){if(t)return function(t){if(0!==Object.keys(t).length)return Object.entries(t).reduce((t,[e,i],s)=>{const n=`${encodeURIComponent(e)}=${encodeURIComponent(i)}`,r=0===s?n:`${t},${n}`;return r.length>8192?(zi&&Ji.warn(`Not adding key: ${e} with val: ${i} to baggage header due to exceeding baggage size limits.`),t):r},"")}(Object.entries(t).reduce((t,[e,i])=>(i&&(t[`${Ln}${e}`]=i),t),{}))}(n?Cr(n):Er(e,s));if(!Kn.test(r))return Ji.warn("Invalid sentry-trace data. Cannot generate trace data"),{};const a={"sentry-trace":r,baggage:o};if(t.propagateTraceparent){const t=n?function(t){const{traceId:e,spanId:i}=t.spanContext();return Zn(e,i,ar(t))}(n):function(t){const{traceId:e,sampled:i,propagationSpanId:s}=t.getPropagationContext();return Zn(e,s,i)}(s);t&&(a.traceparent=t)}return a}const na=100;function ra(t,e){const i=Sn(),s=wn();if(!i)return;const{beforeBreadcrumb:n=null,maxBreadcrumbs:r=na}=i.getOptions();if(r<=0)return;const o={timestamp:en(),...t},a=n?Hi(()=>n(o,e)):o;null!==a&&(i.emit&&i.emit("beforeAddBreadcrumb",a,e),s.addBreadcrumb(a,r))}let oa;const aa=new WeakMap,ha=()=>({name:"FunctionToString",setupOnce(){oa=function(){}.toString;try{Function.prototype.toString=function(...t){const e=Ns(this),i=aa.has(Sn())&&void 0!==e?e:this;return oa.apply(i,t)}}catch{}},setup(t){aa.set(t,!0)}}),ca=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/,/^Can't find variable: gmo$/,/^undefined is not an object \(evaluating 'a\.[A-Z]'\)$/,'can\'t redefine non-configurable property "solana"',"vv().getRestrictions is not a function. (In 'vv().getRestrictions(1,a)', 'vv().getRestrictions' is undefined)","Can't find variable: _AutofillCallbackHandler",/^Non-Error promise rejection captured with value: Object Not Found Matching Id:\d+, MethodName:simulateEvent, ParamCount:\d+$/,/^Java exception was raised during method invocation$/],ua=(t={})=>{let e;return{name:"EventFilters",setup(i){const s=i.getOptions();e=da(t,s)},processEvent(i,s,n){if(!e){const i=n.getOptions();e=da(t,i)}return function(t,e){if(t.type){if("transaction"===t.type&&function(t,e){if(!e?.length)return!1;const i=t.transaction;return!!i&&zs(i,e)}(t,e.ignoreTransactions))return zi&&Ji.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.\nEvent: ${Ks(t)}`),!0}else{if(function(t,e){return!!e?.length&&_o(t).some(t=>zs(t,e))}(t,e.ignoreErrors))return zi&&Ji.warn(`Event dropped due to being matched by \`ignoreErrors\` option.\nEvent: ${Ks(t)}`),!0;if(function(t){return!!t.exception?.values?.length&&!t.message&&!t.exception.values.some(t=>t.stacktrace||t.type&&"Error"!==t.type||t.value)}(t))return zi&&Ji.warn(`Event dropped due to not having an error message, error type or stacktrace.\nEvent: ${Ks(t)}`),!0;if(function(t,e){if(!e?.length)return!1;const i=pa(t);return!!i&&zs(i,e)}(t,e.denyUrls))return zi&&Ji.warn(`Event dropped due to being matched by \`denyUrls\` option.\nEvent: ${Ks(t)}.\nUrl: ${pa(t)}`),!0;if(!function(t,e){if(!e?.length)return!0;const i=pa(t);return!i||zs(i,e)}(t,e.allowUrls))return zi&&Ji.warn(`Event dropped due to not being matched by \`allowUrls\` option.\nEvent: ${Ks(t)}.\nUrl: ${pa(t)}`),!0}return!1}(i,e)?null:i}}},la=(t={})=>({...ua(t),name:"InboundFilters"});function da(t={},e={}){return{allowUrls:[...t.allowUrls||[],...e.allowUrls||[]],denyUrls:[...t.denyUrls||[],...e.denyUrls||[]],ignoreErrors:[...t.ignoreErrors||[],...e.ignoreErrors||[],...t.disableErrorDefaults?[]:ca],ignoreTransactions:[...t.ignoreTransactions||[],...e.ignoreTransactions||[]]}}function pa(t){try{const e=[...t.exception?.values??[]].reverse().find(t=>void 0===t.mechanism?.parent_id&&t.stacktrace?.frames?.length),i=e?.stacktrace?.frames;return i?function(t=[]){for(let e=t.length-1;e>=0;e--){const i=t[e];if(i&&"<anonymous>"!==i.filename&&"[native code]"!==i.filename)return i.filename||null}return null}(i):null}catch{return zi&&Ji.error(`Cannot extract url for event ${Ks(t)}`),null}}function fa(t,e,i,s,n,r){if(!n.exception?.values||!r||!Cs(r.originalException,Error))return;const o=n.exception.values.length>0?n.exception.values[n.exception.values.length-1]:void 0;o&&(n.exception.values=ma(t,e,s,r.originalException,i,n.exception.values,o,0))}function ma(t,e,i,s,n,r,o,a){if(r.length>=i+1)return r;let h=[...r];if(Cs(s[n],Error)){ga(o,a);const r=t(e,s[n]),c=h.length;ya(r,n,c,a),h=ma(t,e,i,s[n],n,[r,...h],r,c)}return Array.isArray(s.errors)&&s.errors.forEach((s,r)=>{if(Cs(s,Error)){ga(o,a);const c=t(e,s),u=h.length;ya(c,`errors[${r}]`,u,a),h=ma(t,e,i,s,n,[c,...h],c,u)}}),h}function ga(t,e){t.mechanism={handled:!0,type:"auto.core.linked_errors",...t.mechanism,..."AggregateError"===t.type&&{is_exception_group:!0},exception_id:e}}function ya(t,e,i,s){t.mechanism={handled:!0,...t.mechanism,type:"chained",source:e,exception_id:i,parent_id:s}}function ba(){"console"in qi&&Ui.forEach(function(t){t in qi.console&&qs(qi.console,t,function(e){return Wi[t]=e,function(...e){cs("console",{args:e,level:t});const i=Wi[t];i?.apply(qi.console,e)}})})}function va(t){return"warn"===t?"warning":["fatal","error","warning","log","info","debug"].includes(t)?t:"log"}const wa=()=>{let t;return{name:"Dedupe",processEvent(e){if(e.type)return e;try{if(function(t,e){return!(!e||!function(t,e){const i=t.message,s=e.message;return!(!i&&!s||i&&!s||!i&&s||i!==s||!Sa(t,e)||!Ma(t,e))}(t,e)&&!function(t,e){const i=ka(e),s=ka(t);return!!(i&&s&&i.type===s.type&&i.value===s.value&&Sa(t,e)&&Ma(t,e))}(t,e))}(e,t))return zi&&Ji.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return t=e}}};function Ma(t,e){let i=ns(t),s=ns(e);if(!i&&!s)return!0;if(i&&!s||!i&&s)return!1;if(s.length!==i.length)return!1;for(let t=0;t<s.length;t++){const e=s[t],n=i[t];if(e.filename!==n.filename||e.lineno!==n.lineno||e.colno!==n.colno||e.function!==n.function)return!1}return!0}function Sa(t,e){let i=t.fingerprint,s=e.fingerprint;if(!i&&!s)return!0;if(i&&!s||!i&&s)return!1;try{return!(i.join("")!==s.join(""))}catch{return!1}}function ka(t){return t.exception?.values?.[0]}function xa(t){return t.split(",").some(t=>t.trim().startsWith(Ln))}function Ta(t,e,i,s){const n={url:t,type:"fetch","http.method":i,[An]:s,[Cn]:"http.client"};return e&&(Ko(e)||(n["http.url"]=e.href,n["server.address"]=e.host),e.search&&(n["http.query"]=e.search),e.hash&&(n["http.fragment"]=e.hash)),n}function Ea(t){return void 0===t?void 0:t>=400&&t<500?"warning":t>=500?"error":void 0}const Ca=qi;function Aa(t){return t&&/^function\s+\w+\(\)\s+\{\s+\[native code\]\s+\}$/.test(t.toString())}function Ia(t,e){const i="fetch";as(i,t),hs(i,()=>Fa(void 0,e))}function Fa(t,e=!1){e&&!function(){if("string"==typeof EdgeRuntime)return!0;if(!function(){if(!("fetch"in Ca))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}())return!1;if(Aa(Ca.fetch))return!0;let t=!1;const e=Ca.document;if(e&&"function"==typeof e.createElement)try{const i=e.createElement("iframe");i.hidden=!0,e.head.appendChild(i),i.contentWindow?.fetch&&(t=Aa(i.contentWindow.fetch)),e.head.removeChild(i)}catch(t){zi&&Ji.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",t)}return t}()||qs(qi,"fetch",function(e){return function(...i){const s=new Error,{method:n,url:r}=function(t){if(0===t.length)return{method:"GET",url:""};if(2===t.length){const[e,i]=t;return{url:Pa(e),method:Ra(i,"method")?String(i.method).toUpperCase():"GET"}}const e=t[0];return{url:Pa(e),method:Ra(e,"method")?String(e.method).toUpperCase():"GET"}}(i),o={args:i,fetchData:{method:n,url:r},startTimestamp:1e3*sn(),virtualError:s,headers:Oa(i)};return t||cs("fetch",{...o}),e.apply(qi,i).then(async e=>(t?t(e):cs("fetch",{...o,endTimestamp:1e3*sn(),response:e}),e),t=>{if(cs("fetch",{...o,endTimestamp:1e3*sn(),error:t}),ys(t)&&void 0===t.stack&&(t.stack=s.stack,js(t,"framesToPop",1)),t instanceof TypeError&&("Failed to fetch"===t.message||"Load failed"===t.message||"NetworkError when attempting to fetch resource."===t.message))try{const e=new URL(o.fetchData.url);t.message=`${t.message} (${e.host})`}catch{}throw t})}})}function _a(t){let e;try{e=t.clone()}catch{return}!async function(t,e){if(t?.body){const i=t.body,s=i.getReader(),n=setTimeout(()=>{i.cancel().then(null,()=>{})},9e4);let r=!0;for(;r;){let t;try{t=setTimeout(()=>{i.cancel().then(null,()=>{})},5e3);const{done:n}=await s.read();clearTimeout(t),n&&(e(),r=!1)}catch{r=!1}finally{clearTimeout(t)}}clearTimeout(n),s.releaseLock(),i.cancel().then(null,()=>{})}}(e,()=>{cs("fetch-body-resolved",{endTimestamp:1e3*sn(),response:t})})}function Ra(t,e){return!!t&&"object"==typeof t&&!!t[e]}function Pa(t){return"string"==typeof t?t:t?Ra(t,"url")?t.url:t.toString?t.toString():"":""}function Oa(t){const[e,i]=t;try{if("object"==typeof i&&null!==i&&"headers"in i&&i.headers)return new Headers(i.headers);if(Is(e))return new Headers(e.headers)}catch{}}function Ba(){return"undefined"!=typeof window&&(!(("undefined"==typeof __SENTRY_BROWSER_BUNDLE__||!__SENTRY_BROWSER_BUNDLE__)&&"[object process]"==={}.toString.call("undefined"!=typeof process?process:0))||function(){const t=qi.process;return"renderer"===t?.type}())}const Da=qi;let $a=0;function za(){return $a>0}function qa(t,e={}){if(!function(t){return"function"==typeof t}(t))return t;try{const e=t.te;if(e)return"function"==typeof e?e:t;if(Ns(t))return t}catch{return t}const i=function(...i){try{const s=i.map(t=>qa(t,e));return t.apply(this,s)}catch(t){throw $a++,setTimeout(()=>{$a--}),Mn(s=>{s.addEventProcessor(t=>(e.mechanism&&(Qs(t,void 0),Zs(t,e.mechanism)),t.extra={...t.extra,arguments:i},t)),yo(t)}),t}};try{for(const e in t)({}).hasOwnProperty.call(t,e)&&(i[e]=t[e])}catch{}Ls(i,t),js(t,"__sentry_wrapped__",i);try{Object.getOwnPropertyDescriptor(i,"name").configurable&&Object.defineProperty(i,"name",{get:()=>t.name})}catch{}return i}function ja(){const t=Ps(),{referrer:e}=Da.document||{},{userAgent:i}=Da.navigator||{};return{url:t,headers:{...e&&{Referer:e},...i&&{"User-Agent":i}}}}function La(t,e){const i=Ga(t,e),s={type:Ha(e),value:Va(e)};return i.length&&(s.stacktrace={frames:i}),void 0===s.type&&""===s.value&&(s.value="Unrecoverable error caught"),s}function Na(t,e){return{exception:{values:[La(t,e)]}}}function Ga(t,e){const i=e.stacktrace||e.stack||"",s=function(t){return t&&Ua.test(t.message)?1:0}(e),n=function(t){return"number"==typeof t.framesToPop?t.framesToPop:0}(e);try{return t(i,s,n)}catch{}return[]}const Ua=/Minified React error #\d+;/i;function Wa(t){return"undefined"!=typeof WebAssembly&&void 0!==WebAssembly.Exception&&t instanceof WebAssembly.Exception}function Ha(t){const e=t?.name;return!e&&Wa(t)?t.message&&Array.isArray(t.message)&&2==t.message.length?t.message[0]:"WebAssembly.Exception":e}function Va(t){const e=t?.message;return Wa(t)?Array.isArray(t.message)&&2==t.message.length?t.message[1]:"wasm exception":e?e.error&&"string"==typeof e.error.message?e.error.message:e:"No error message"}function Ya(t,e,i,s,n){let r;if(vs(e)&&e.error)return Na(t,e.error);if(ws(e)||bs(e,"DOMException")){const n=e;if("stack"in e)r=Na(t,e);else{const e=n.name||(ws(n)?"DOMError":"DOMException"),o=n.message?`${e}: ${n.message}`:e;r=Xa(t,o,i,s),Qs(r,o)}return"code"in n&&(r.tags={...r.tags,"DOMException.code":`${n.code}`}),r}return ys(e)?Na(t,e):xs(e)||Ts(e)?(r=function(t,e,i,s){const n=Sn(),r=n?.getOptions().normalizeDepth,o=function(t){for(const e in t)if({}.hasOwnProperty.call(t,e)){const i=t[e];if(i instanceof Error)return i}}(e),a={ee:Fr(e,r)};if(o)return{exception:{values:[La(t,o)]},extra:a};const h={exception:{values:[{type:Ts(e)?e.constructor.name:s?"UnhandledRejection":"Error",value:Ja(e,{isUnhandledRejection:s})}]},extra:a};if(i){const e=Ga(t,i);e.length&&(h.exception.values[0].stacktrace={frames:e})}return h}(t,e,i,n),Zs(r,{synthetic:!0}),r):(r=Xa(t,e,i,s),Qs(r,`${e}`),Zs(r,{synthetic:!0}),r)}function Xa(t,e,i,s){const n={};if(s&&i){const s=Ga(t,i);s.length&&(n.exception={values:[{value:e,stacktrace:{frames:s}}]}),Zs(n,{synthetic:!0})}if(Ss(e)){const{_:t,R:i}=e;return n.logentry={message:t,params:i},n}return n.message=e,n}function Ja(t,{isUnhandledRejection:e}){const i=function(t,e=40){const i=Object.keys(Gs(t));i.sort();const s=i[0];if(!s)return"[object has no keys]";if(s.length>=e)return Bs(s,e);for(let t=i.length;t>0;t--){const s=i.slice(0,t).join(", ");if(!(s.length>e))return t===i.length?s:Bs(s,e)}return""}(t),s=e?"promise rejection":"exception";return vs(t)?`Event \`ErrorEvent\` captured as ${s} with message \`${t.message}\``:Ts(t)?`Event \`${function(t){try{const e=Object.getPrototypeOf(t);return e?e.constructor.name:void 0}catch{}}(t)}\` (type=${t.type}) captured as ${s}`:`Object captured as ${s} with keys: ${i}`}class Ka extends Lo{constructor(t){const e=(i=t,{release:"string"==typeof __SENTRY_RELEASE__?__SENTRY_RELEASE__:Da.SENTRY_RELEASE?.id,sendClientReports:!0,parentSpanIsAlwaysRootSpan:!0,...i});var i;!function(t,e,i=[e],s="npm"){const n=t.Ot||{};n.sdk||(n.sdk={name:`sentry.javascript.${e}`,packages:i.map(t=>({name:`${s}:@sentry/${t}`,version:ji})),version:ji}),t.Ot=n}(e,"browser",["browser"],Da.SENTRY_SDK_SOURCE||"npm"),e.Ot?.sdk&&(e.Ot.sdk.settings={infer_ip:e.sendDefaultPii?"auto":"never",...e.Ot.sdk.settings}),super(e);const{sendDefaultPii:s,sendClientReports:n,enableLogs:r,Nt:o}=this.Bt;Da.document&&(n||r||o?.enableMetrics)&&Da.document.addEventListener("visibilitychange",()=>{"hidden"===Da.document.visibilityState&&(n&&this.Zt(),r&&Co(this),o?.enableMetrics&&Io(this))}),s&&this.on("beforeSendSession",ia)}eventFromException(t,e){return function(t,e,i,s){const n=Ya(t,e,i?.syntheticException||void 0,s);return Zs(n),n.level="error",i?.event_id&&(n.event_id=i.event_id),so(n)}(this.Bt.stackParser,t,e,this.Bt.attachStacktrace)}eventFromMessage(t,e="info",i){return function(t,e,i="info",s,n){const r=Xa(t,e,s?.syntheticException||void 0,n);return r.level=i,s?.event_id&&(r.event_id=s.event_id),so(r)}(this.Bt.stackParser,t,e,i,this.Bt.attachStacktrace)}Xt(t,e,i,s){return t.platform=t.platform||"javascript",super.Xt(t,e,i,s)}}const Qa="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,Za=qi,th=(t,e,i,s)=>{let n,r;return o=>{e.value>=0&&(o||s)&&(r=e.value-(n??0),(r||void 0===n)&&(n=e.value,e.delta=r,e.rating=((t,e)=>t>e[1]?"poor":t>e[0]?"needs-improvement":"good")(e.value,i),t(e)))}},eh=(t=!0)=>{const e=Za.performance?.getEntriesByType?.("navigation")[0];if(!t||e&&e.responseStart>0&&e.responseStart<performance.now())return e},ih=()=>{const t=eh();return t?.activationStart??0},sh=(t,e=-1)=>{const i=eh();let s="navigate";return i&&(Za.document?.prerendering||ih()>0?s="prerender":Za.document?.wasDiscarded?s="restore":i.type&&(s=i.type.replace(/_/g,"-"))),{name:t,value:e,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:s}},nh=new WeakMap;function rh(t,e){return nh.get(t)||nh.set(t,new e),nh.get(t)}class oh{constructor(){oh.prototype.ie.call(this),oh.prototype.se.call(this)}ie(){this.ne=0}se(){this.re=[]}oe(t){if(t.hadRecentInput)return;const e=this.re[0],i=this.re[this.re.length-1];this.ne&&e&&i&&t.startTime-i.startTime<1e3&&t.startTime-e.startTime<5e3?(this.ne+=t.value,this.re.push(t)):(this.ne=t.value,this.re=[t]),this.ae?.(t)}}const ah=(t,e,i={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(t)){const s=new PerformanceObserver(t=>{Promise.resolve().then(()=>{e(t.getEntries())})});return s.observe({type:t,buffered:!0,...i}),s}}catch{}},hh=t=>{let e=!1;return()=>{e||(t(),e=!0)}};let ch=-1;const uh=t=>{"hidden"===Za.document.visibilityState&&ch>-1&&(ch="visibilitychange"===t.type?t.timeStamp:0,lh())},lh=()=>{removeEventListener("visibilitychange",uh,!0),removeEventListener("prerenderingchange",uh,!0)},dh=()=>{if(Za.document&&ch<0){const t=ih(),e=Za.document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter(e=>"hidden"===e.name&&e.startTime>t)[0]?.startTime;ch=e??("hidden"!==Za.document?.visibilityState||Za.document?.prerendering?1/0:0),addEventListener("visibilitychange",uh,!0),addEventListener("prerenderingchange",uh,!0)}return{get firstHiddenTime(){return ch}}},ph=t=>{Za.document?.prerendering?addEventListener("prerenderingchange",()=>t(),!0):t()},fh=[1800,3e3],mh=[.1,.25];let gh=0,yh=1/0,bh=0;const vh=t=>{t.forEach(t=>{t.interactionId&&(yh=Math.min(yh,t.interactionId),bh=Math.max(bh,t.interactionId),gh=bh?(bh-yh)/7+1:0)})};let wh;const Mh=()=>wh?gh:performance.interactionCount||0,Sh=()=>{"interactionCount"in performance||wh||(wh=ah("event",vh,{type:"event",buffered:!0,durationThreshold:0}))};let kh=0;class xh{constructor(){xh.prototype.ie.call(this),xh.prototype.se.call(this)}ie(){this.he=[]}se(){this.ce=new Map}ue(){kh=Mh(),this.he.length=0,this.ce.clear()}le(){const t=Math.min(this.he.length-1,Math.floor((Mh()-kh)/50));return this.he[t]}oe(t){if(this.de?.(t),!t.interactionId&&"first-input"!==t.entryType)return;const e=this.he.at(-1);let i=this.ce.get(t.interactionId);if(i||this.he.length<10||t.duration>e.pe){if(i?t.duration>i.pe?(i.entries=[t],i.pe=t.duration):t.duration===i.pe&&t.startTime===i.entries[0].startTime&&i.entries.push(t):(i={id:t.interactionId,entries:[t],pe:t.duration},this.ce.set(i.id,i),this.he.push(i)),this.he.sort((t,e)=>e.pe-t.pe),this.he.length>10){const t=this.he.splice(10);for(const e of t)this.ce.delete(e.id)}this.fe?.(i)}}}const Th=t=>{const e=e=>{"pagehide"!==e.type&&"hidden"!==Za.document?.visibilityState||t(e)};Za.document&&(addEventListener("visibilitychange",e,!0),addEventListener("pagehide",e,!0))},Eh=t=>{const e=Za.requestIdleCallback||Za.setTimeout;"hidden"===Za.document?.visibilityState?t():(e(t=hh(t)),Th(t))},Ch=[200,500];class Ah{oe(t){this.de?.(t)}}const Ih=[2500,4e3],Fh=[800,1800],_h=t=>{Za.document?.prerendering?ph(()=>_h(t)):"complete"!==Za.document?.readyState?addEventListener("load",()=>_h(t),!0):setTimeout(t)},Rh={},Ph={};let Oh,Bh,Dh,$h;function zh(t,e=!1){return Vh("cls",t,Gh,Oh,e)}function qh(t,e=!1){return Vh("lcp",t,Uh,Bh,e)}function jh(t){return Vh("inp",t,Hh,$h)}function Lh(t,e){return Yh(t,e),Ph[t]||(function(t){const e={};"event"===t&&(e.durationThreshold=0),ah(t,e=>{Nh(t,{entries:e})},e)}(t),Ph[t]=!0),Xh(t,e)}function Nh(t,e){const i=Rh[t];if(i?.length)for(const s of i)try{s(e)}catch(e){Qa&&Ji.error(`Error while triggering instrumentation handler.\nType: ${t}\nName: ${ss(s)}\nError:`,e)}}function Gh(){return((t,e={})=>{((t,e={})=>{ph(()=>{const i=dh(),s=sh("FCP");let n;const r=ah("paint",t=>{for(const e of t)"first-contentful-paint"===e.name&&(r.disconnect(),e.startTime<i.firstHiddenTime&&(s.value=Math.max(e.startTime-ih(),0),s.entries.push(e),n(!0)))});r&&(n=th(t,s,fh,e.reportAllChanges))})})(hh(()=>{const i=sh("CLS",0);let s;const n=rh(e,oh),r=t=>{for(const e of t)n.oe(e);n.ne>i.value&&(i.value=n.ne,i.entries=n.re,s())},o=ah("layout-shift",r);o&&(s=th(t,i,mh,e.reportAllChanges),Za.document?.addEventListener("visibilitychange",()=>{"hidden"===Za.document?.visibilityState&&(r(o.takeRecords()),s(!0))}),Za?.setTimeout?.(s))}))})(t=>{Nh("cls",{metric:t}),Oh=t},{reportAllChanges:!0})}function Uh(){return((t,e={})=>{ph(()=>{const i=dh(),s=sh("LCP");let n;const r=rh(e,Ah),o=t=>{e.reportAllChanges||(t=t.slice(-1));for(const e of t)r.oe(e),e.startTime<i.firstHiddenTime&&(s.value=Math.max(e.startTime-ih(),0),s.entries=[e],n())},a=ah("largest-contentful-paint",o);if(a){n=th(t,s,Ih,e.reportAllChanges);const i=hh(()=>{o(a.takeRecords()),a.disconnect(),n(!0)});for(const t of["keydown","click","visibilitychange"])Za.document&&addEventListener(t,()=>Eh(i),{capture:!0,once:!0})}})})(t=>{Nh("lcp",{metric:t}),Bh=t},{reportAllChanges:!0})}function Wh(){return((t,e={})=>{const i=sh("TTFB"),s=th(t,i,Fh,e.reportAllChanges);_h(()=>{const t=eh();t&&(i.value=Math.max(t.responseStart-ih(),0),i.entries=[t],s(!0))})})(t=>{Nh("ttfb",{metric:t}),Dh=t})}function Hh(){return((t,e={})=>{globalThis.PerformanceEventTiming&&"interactionId"in PerformanceEventTiming.prototype&&ph(()=>{Sh();const i=sh("INP");let s;const n=rh(e,xh),r=t=>{Eh(()=>{for(const e of t)n.oe(e);const e=n.le();e&&e.pe!==i.value&&(i.value=e.pe,i.entries=e.entries,s())})},o=ah("event",r,{durationThreshold:e.durationThreshold??40});s=th(t,i,Ch,e.reportAllChanges),o&&(o.observe({type:"first-input",buffered:!0}),Th(()=>{r(o.takeRecords()),s(!0)}))})})(t=>{Nh("inp",{metric:t}),$h=t})}function Vh(t,e,i,s,n=!1){let r;return Yh(t,e),Ph[t]||(r=i(),Ph[t]=!0),s&&e({metric:s}),Xh(t,e,n?r:void 0)}function Yh(t,e){Rh[t]=Rh[t]||[],Rh[t].push(e)}function Xh(t,e,i){return()=>{i&&i();const s=Rh[t];if(!s)return;const n=s.indexOf(e);-1!==n&&s.splice(n,1)}}function Jh(t){return"number"==typeof t&&isFinite(t)}function Kh(t,e,i,{...s}){const n=or(t).start_timestamp;return n&&n>e&&"function"==typeof t.updateStartTime&&t.updateStartTime(e),Xr(t,()=>{const t=Yr({startTime:e,...s});return t&&t.end(i),t})}function Qh(t){const e=Sn();if(!e)return;const{name:i,transaction:s,attributes:n,startTime:r}=t,{release:o,environment:a,sendDefaultPii:h}=e.getOptions(),c=e.getIntegrationByName("Replay"),u=c?.getReplayId(),l=vn(),d=l.getUser(),p=void 0!==d?d.email||d.id||d.ip_address:void 0;let f;try{f=l.getScopeData().contexts.profile.profile_id}catch{}return Yr({name:i,attributes:{release:o,environment:a,user:p||void 0,profile_id:f||void 0,replay_id:u||void 0,transaction:s,"user_agent.original":Za.navigator?.userAgent,"client.address":h?"{{auto}}":void 0,...n},startTime:r,experimental:{standalone:!0}})}function Zh(){return Za.addEventListener&&Za.performance}function tc(t){return t/1e3}function ec(t){try{return PerformanceObserver.supportedEntryTypes.includes(t)}catch{return!1}}function ic(t,e){let i,s=!1;function n(t){!s&&i&&e(t,i),s=!0}Th(()=>{n("pagehide")});const r=t.on("beforeStartNavigationSpan",(t,e)=>{e?.isRedirect||(n("navigation"),r(),o())}),o=t.on("afterStartPageLoadSpan",t=>{i=t.spanContext().spanId,o()})}function sc(t){return t?((nn()||performance.timeOrigin)+t)/1e3:t}function nc(t){const e={};if(null!=t.nextHopProtocol){const{name:i,version:s}=function(t){let e="unknown",i="unknown",s="";for(const n of t){if("/"===n){[e,i]=t.split("/");break}if(!isNaN(Number(n))){e="h"===s?"http":s,i=t.split(s)[1];break}s+=n}return s===t&&(e=s),{name:e,version:i}}(t.nextHopProtocol);e["network.protocol.version"]=s,e["network.protocol.name"]=i}return nn()||Zh()?.timeOrigin?(i={...e,"http.request.redirect_start":sc(t.redirectStart),"http.request.redirect_end":sc(t.redirectEnd),"http.request.worker_start":sc(t.workerStart),"http.request.fetch_start":sc(t.fetchStart),"http.request.domain_lookup_start":sc(t.domainLookupStart),"http.request.domain_lookup_end":sc(t.domainLookupEnd),"http.request.connect_start":sc(t.connectStart),"http.request.secure_connection_start":sc(t.secureConnectionStart),"http.request.connection_end":sc(t.connectEnd),"http.request.request_start":sc(t.requestStart),"http.request.response_start":sc(t.responseStart),"http.request.response_end":sc(t.responseEnd),"http.request.time_to_first_byte":null!=t.responseStart?t.responseStart/1e3:void 0},Object.fromEntries(Object.entries(i).filter(([,t])=>null!=t))):e;var i}let rc,oc,ac=0,hc={};function cc(t,e,i,s,n=i){const r=function(t){return"secureConnection"===t?"connectEnd":"fetch"===t?"domainLookupStart":`${t}End`}(i),o=e[r],a=e[`${i}Start`];a&&o&&Kh(t,s+tc(a),s+tc(o),{op:`browser.${n}`,name:e.name,attributes:{[An]:"auto.ui.browser.metrics",..."redirect"===i&&null!=e.redirectCount?{"http.redirect_count":e.redirectCount}:{}}})}const uc=({entries:t})=>{const e=fr(),i=e?pr(e):void 0,s=i?or(i).description:vn().getScopeData().transactionName;t.forEach(t=>{const e=t;if(!e.identifier)return;const i=e.name,n=e.renderTime,r=e.loadTime,[o,a]=r?[tc(r),"load-time"]:n?[tc(n),"render-time"]:[sn(),"entry-emission"],h="image-paint"===i?tc(Math.max(0,(n??0)-(r??0))):0,c={[An]:"auto.ui.browser.elementtiming",[Cn]:"ui.elementtiming",[xn]:"component","sentry.span_start_time_source":a,"sentry.transaction_name":s,"element.id":e.id,"element.type":e.element?.tagName?.toLowerCase()||"unknown","element.size":e.naturalWidth&&e.naturalHeight?`${e.naturalWidth}x${e.naturalHeight}`:void 0,"element.render_time":n,"element.load_time":r,"element.url":e.url||void 0,"element.identifier":e.identifier,"element.paint_type":i};!function(t,e){const i=Qr();if(i.startSpan)return i.startSpan(t,e);const s=Kr(t),{forceTransaction:n,parentSpan:r,scope:o}=t,a=o?.clone();Mn(a,()=>{const i=void 0!==(o=r)?t=>Xr(o,t):t=>t();var o;return i(()=>{const i=vn(),o=to(i,r),a=t.onlyIfParent&&!o?new Ar:Jr({parentSpan:o,spanArguments:s,forceTransaction:n,scope:i});return un(i,a),function(t,e,i=()=>{},s=()=>{}){let n;try{n=t()}catch(t){throw e(t),i(),t}return function(t,e,i,s){return Es(t)?t.then(t=>(i(),s(t),t),t=>{throw e(t),i(),t}):(i(),s(t),t)}(n,e,i,s)}(()=>e(a),()=>{const{status:t}=or(a);!a.isRecording()||t&&"ok"!==t||a.setStatus({code:2,message:"internal_error"})},()=>{a.end()})})})}({name:`element[${e.identifier}]`,attributes:c,startTime:o,onlyIfParent:!0},t=>{t.end(o+h)})})};let lc,dc,pc,fc;function mc(t){as("dom",t),hs("dom",gc)}function gc(){if(!Za.document)return;const t=cs.bind(null,"dom"),e=yc(t,!0);Za.document.addEventListener("click",e,!1),Za.document.addEventListener("keypress",e,!1),["EventTarget","Node"].forEach(e=>{const i=Za,s=i[e]?.prototype;s?.hasOwnProperty?.("addEventListener")&&(qs(s,"addEventListener",function(e){return function(i,s,n){if("click"===i||"keypress"==i)try{const s=this.me=this.me||{},r=s[i]=s[i]||{refCount:0};if(!r.handler){const s=yc(t);r.handler=s,e.call(this,i,s,n)}r.refCount++}catch{}return e.call(this,i,s,n)}}),qs(s,"removeEventListener",function(t){return function(e,i,s){if("click"===e||"keypress"==e)try{const i=this.me||{},n=i[e];n&&(n.refCount--,n.refCount<=0&&(t.call(this,e,n.handler,s),n.handler=void 0,delete i[e]),0===Object.keys(i).length&&delete this.me)}catch{}return t.call(this,e,i,s)}}))})}function yc(t,e=!1){return i=>{if(!i||i.ge)return;const s=function(t){try{return t.target}catch{return null}}(i);if(function(t,e){return"keypress"===t&&(!e?.tagName||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&!e.isContentEditable)}(i.type,s))return;js(i,"_sentryCaptured",!0),s&&!s.ye&&js(s,"_sentryId",Xs());const n="keypress"===i.type?"input":i.type;(function(t){if(t.type!==dc)return!1;try{if(!t.target||t.target.ye!==pc)return!1}catch{}return!0})(i)||(t({event:i,name:n,global:e}),dc=i.type,pc=s?s.ye:void 0),clearTimeout(lc),lc=Za.setTimeout(()=>{pc=void 0,dc=void 0},1e3)}}function bc(t){const e="history";as(e,t),hs(e,vc)}function vc(){function t(t){return function(...e){const i=e.length>2?e[2]:void 0;if(i){const s=fc,n=function(t){try{return new URL(t,Za.location.origin).toString()}catch{return t}}(String(i));if(fc=n,s===n)return t.apply(this,e);cs("history",{from:s,to:n})}return t.apply(this,e)}}Za.addEventListener("popstate",()=>{const t=Za.location.href,e=fc;fc=t,e!==t&&cs("history",{from:e,to:t})}),"history"in Ca&&Ca.history&&(qs(Za.history,"pushState",t),qs(Za.history,"replaceState",t))}const wc={};function Mc(t){const e=wc[t];if(e)return e;let i=Za[t];if(Aa(i))return wc[t]=i.bind(Za);const s=Za.document;if(s&&"function"==typeof s.createElement)try{const e=s.createElement("iframe");e.hidden=!0,s.head.appendChild(e);const n=e.contentWindow;n?.[t]&&(i=n[t]),s.head.removeChild(e)}catch(e){Qa&&Ji.warn(`Could not create sandbox iframe for ${t} check, bailing to window.${t}: `,e)}return i?wc[t]=i.bind(Za):i}function Sc(...t){return Mc("setTimeout")(...t)}const kc="__sentry_xhr_v3__";function xc(t){as("xhr",t),hs("xhr",Tc)}function Tc(){if(!Za.XMLHttpRequest)return;const t=XMLHttpRequest.prototype;t.open=new Proxy(t.open,{apply(t,e,i){const s=new Error,n=1e3*sn(),r=Ms(i[0])?i[0].toUpperCase():void 0,o=function(t){if(Ms(t))return t;try{return t.toString()}catch{}}(i[1]);if(!r||!o)return t.apply(e,i);e[kc]={method:r,url:o,request_headers:{}},"POST"===r&&o.match(/sentry_key/)&&(e.be=!0);const a=()=>{const t=e[kc];if(t&&4===e.readyState){try{t.status_code=e.status}catch{}cs("xhr",{endTimestamp:1e3*sn(),startTimestamp:n,xhr:e,virtualError:s})}};return"onreadystatechange"in e&&"function"==typeof e.onreadystatechange?e.onreadystatechange=new Proxy(e.onreadystatechange,{apply:(t,e,i)=>(a(),t.apply(e,i))}):e.addEventListener("readystatechange",a),e.setRequestHeader=new Proxy(e.setRequestHeader,{apply(t,e,i){const[s,n]=i,r=e[kc];return r&&Ms(s)&&Ms(n)&&(r.request_headers[s.toLowerCase()]=n),t.apply(e,i)}}),t.apply(e,i)}}),t.send=new Proxy(t.send,{apply(t,e,i){const s=e[kc];return s?(void 0!==i[0]&&(s.body=i[0]),cs("xhr",{startTimestamp:1e3*sn(),xhr:e}),t.apply(e,i)):t.apply(e,i)}})}function Ec(t){return new URLSearchParams(t).toString()}function Cc(t,e=Ji){try{if("string"==typeof t)return[t];if(t instanceof URLSearchParams)return[t.toString()];if(t instanceof FormData)return[Ec(t)];if(!t)return[void 0]}catch(i){return Qa&&e.error(i,"Failed to serialize body",t),[void 0,"BODY_PARSE_ERROR"]}return Qa&&e.log("Skipping network body because of body type",t),[void 0,"UNPARSEABLE_BODY_TYPE"]}function Ac(t=[]){if(2===t.length&&"object"==typeof t[1])return t[1].body}function Ic(t){let e;try{e=t.getAllResponseHeaders()}catch(e){return Qa&&Ji.error(e,"Failed to get xhr response headers",t),{}}return e?e.split("\r\n").reduce((t,e)=>{const[i,s]=e.split(": ");return s&&(t[i.toLowerCase()]=s),t},{}):{}}const Fc=[],_c=new Map,Rc={click:"click",pointerdown:"click",pointerup:"click",mousedown:"click",mouseup:"click",touchstart:"click",touchend:"click",mouseover:"hover",mouseout:"hover",mouseenter:"hover",mouseleave:"hover",pointerover:"hover",pointerout:"hover",pointerenter:"hover",pointerleave:"hover",dragstart:"drag",dragend:"drag",drag:"drag",dragenter:"drag",dragleave:"drag",dragover:"drag",drop:"drag",keydown:"press",keyup:"press",keypress:"press",input:"press"},Pc=({metric:t})=>{if(null==t.value)return;const e=tc(t.value);if(e>60)return;const i=t.entries.find(e=>e.duration===t.value&&Rc[e.name]);if(!i)return;const{interactionId:s}=i,n=Rc[i.name],r=tc(nn()+i.startTime),o=fr(),a=o?pr(o):void 0,h=(null!=s?_c.get(s):void 0)||a,c=h?or(h).description:vn().getScopeData().transactionName,u=Qh({name:_s(i.target),transaction:c,attributes:{[An]:"auto.http.browser.inp",[Cn]:`ui.interaction.${n}`,[On]:i.duration},startTime:r});u&&(u.addEvent("inp",{[Fn]:"millisecond",[_n]:t.value}),u.end(r+e))};function Oc(t,e=Mc("fetch")){let i=0,s=0;return function(t,e,i=function(t=100){const e=new Set;function i(t){e.delete(t)}return{get $(){return Array.from(e)},add:function(s){if(!(e.size<t))return no(Yo);const n=s();return e.add(n),n.then(()=>i(n),()=>i(n)),n},drain:function(t){if(!e.size)return so(!0);const i=Promise.allSettled(Array.from(e)).then(()=>!0);if(!t)return i;const s=[i,new Promise(e=>setTimeout(()=>e(!1),t))];return Promise.race(s)}}}(t.bufferSize||64)){let s={};return{send:function(n){const r=[];if(Or(n,(e,i)=>{const n=jr(i);Xo(s,n)?t.recordDroppedEvent("ratelimit_backoff",n):r.push(e)}),0===r.length)return Promise.resolve({});const o=Rr(n[0],r),a=e=>{Or(o,(i,s)=>{t.recordDroppedEvent(e,jr(s))})};return i.add(()=>e({body:Dr(o)}).then(t=>(void 0!==t.statusCode&&(t.statusCode<200||t.statusCode>=300)&&zi&&Ji.warn(`Sentry responded with status code ${t.statusCode} to sent event.`),s=Jo(s,t),t),t=>{throw a("network_error"),zi&&Ji.error("Encountered error running transport request:",t),t})).then(t=>t,t=>{if(t===Yo)return zi&&Ji.error("Skipped sending event because buffer is full."),a("queue_overflow"),Promise.resolve({});throw t})},flush:t=>i.drain(t)}}(t,async function(n){const r=n.body.length;i+=r,s++;const o={body:n.body,method:"POST",referrerPolicy:"strict-origin",headers:t.headers,keepalive:i<=6e4&&s<15,...t.fetchOptions};try{const i=await e(t.url,o);return{statusCode:i.status,headers:{"x-sentry-rate-limits":i.headers.get("X-Sentry-Rate-Limits"),"retry-after":i.headers.get("Retry-After")}}}catch(t){throw wc.fetch=void 0,t}finally{i-=r,s--}})}function Bc(t,e,i,s){const n={filename:t,function:"<anonymous>"===e?Ki:e,in_app:!0};return void 0!==i&&(n.lineno=i),void 0!==s&&(n.colno=s),n}const Dc=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,$c=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,zc=/\((\S*)(?::(\d+))(?::(\d+))\)/,qc=/at (.+?) ?\(data:(.+?),/,jc=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,Lc=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Nc=ts([30,t=>{const e=t.match(qc);if(e)return{filename:`<data:${e[2]}>`,function:e[1]};const i=Dc.exec(t);if(i){const[,t,e,s]=i;return Bc(t,Ki,+e,+s)}const s=$c.exec(t);if(s){if(s[2]&&0===s[2].indexOf("eval")){const t=zc.exec(s[2]);t&&(s[2]=t[1],s[3]=t[2],s[4]=t[3])}const[t,e]=Gc(s[1]||Ki,s[2]);return Bc(e,t,s[3]?+s[3]:void 0,s[4]?+s[4]:void 0)}}],[50,t=>{const e=jc.exec(t);if(e){if(e[3]&&e[3].indexOf(" > eval")>-1){const t=Lc.exec(e[3]);t&&(e[1]=e[1]||"eval",e[3]=t[1],e[4]=t[2],e[5]="")}let t=e[3],i=e[1]||Ki;return[i,t]=Gc(i,t),Bc(t,i,e[4]?+e[4]:void 0,e[5]?+e[5]:void 0)}}]),Gc=(t,e)=>{const i=-1!==t.indexOf("safari-extension"),s=-1!==t.indexOf("safari-web-extension");return i||s?[-1!==t.indexOf("@")?t.split("@")[0]:Ki,i?`safari-extension:${e}`:`safari-web-extension:${e}`]:[t,e]},Uc="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,Wc=(t={})=>{const e={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...t};return{name:"Breadcrumbs",setup(t){e.console&&function(t){const e="console";as(e,t),hs(e,ba)}(function(t){return function(e){if(Sn()!==t)return;const i={category:"console",data:{arguments:e.args,logger:"console"},level:va(e.level),message:Ds(e.args," ")};if("assert"===e.level){if(!1!==e.args[0])return;i.message=`Assertion failed: ${Ds(e.args.slice(1)," ")||"console.assert"}`,i.data.arguments=e.args.slice(1)}ra(i,{input:e.args,level:e.level})}}(t)),e.dom&&mc(function(t,e){return function(i){if(Sn()!==t)return;let s,n,r="object"==typeof e?e.serializeAttribute:void 0,o="object"==typeof e&&"number"==typeof e.maxStringLength?e.maxStringLength:void 0;o&&o>1024&&(Uc&&Ji.warn(`\`dom.maxStringLength\` cannot exceed 1024, but a value of ${o} was configured. Sentry will use 1024 instead.`),o=1024),"string"==typeof r&&(r=[r]);try{const t=i.event,e=function(t){return!!t&&!!t.target}(t)?t.target:t;s=_s(e,{keyAttrs:r,maxStringLength:o}),n=Os(e)}catch{s="<unknown>"}if(0===s.length)return;const a={category:`ui.${i.name}`,message:s};n&&(a.data={"ui.component_name":n}),ra(a,{event:i.event,name:i.name,global:i.global})}}(t,e.dom)),e.xhr&&xc(function(t){return function(e){if(Sn()!==t)return;const{startTimestamp:i,endTimestamp:s}=e,n=e.xhr[kc];if(!i||!s||!n)return;const{method:r,url:o,status_code:a,body:h}=n,c={method:r,url:o,status_code:a},u={xhr:e.xhr,input:h,startTimestamp:i,endTimestamp:s},l={category:"xhr",data:c,type:"http",level:Ea(a)};t.emit("beforeOutgoingRequestBreadcrumb",l,u),ra(l,u)}}(t)),e.fetch&&Ia(function(t){return function(e){if(Sn()!==t)return;const{startTimestamp:i,endTimestamp:s}=e;if(s&&(!e.fetchData.url.match(/sentry_key/)||"POST"!==e.fetchData.method))if(e.error){const n=e.fetchData,r={data:e.error,input:e.args,startTimestamp:i,endTimestamp:s},o={category:"fetch",data:n,level:"error",type:"http"};t.emit("beforeOutgoingRequestBreadcrumb",o,r),ra(o,r)}else{const n=e.response,r={...e.fetchData,status_code:n?.status},o={input:e.args,response:n,startTimestamp:i,endTimestamp:s},a={category:"fetch",data:r,type:"http",level:Ea(r.status_code)};t.emit("beforeOutgoingRequestBreadcrumb",a,o),ra(a,o)}}}(t)),e.history&&bc(function(t){return function(e){if(Sn()!==t)return;let i=e.from,s=e.to;const n=ta(Da.location.href);let r=i?ta(i):void 0;const o=ta(s);r?.path||(r=n),n.protocol===o.protocol&&n.host===o.host&&(s=o.relative),n.protocol===r.protocol&&n.host===r.host&&(i=r.relative),ra({category:"navigation",data:{from:i,to:s}})}}(t)),e.sentry&&t.on("beforeSendEvent",function(t){return function(e){Sn()===t&&ra({category:"sentry."+("transaction"===e.type?"transaction":"event"),event_id:e.event_id,level:e.level,message:Ks(e)},{event:e})}}(t))}}},Hc=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],Vc=(t={})=>{const e={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,unregisterOriginalCallbacks:!1,...t};return{name:"BrowserApiErrors",setupOnce(){e.setTimeout&&qs(Da,"setTimeout",Yc),e.setInterval&&qs(Da,"setInterval",Yc),e.requestAnimationFrame&&qs(Da,"requestAnimationFrame",Xc),e.XMLHttpRequest&&"XMLHttpRequest"in Da&&qs(XMLHttpRequest.prototype,"send",Jc);const t=e.eventTarget;t&&(Array.isArray(t)?t:Hc).forEach(t=>function(t,e){const i=Da,s=i[t]?.prototype;s?.hasOwnProperty?.("addEventListener")&&(qs(s,"addEventListener",function(i){return function(s,n,r){try{"function"==typeof n.handleEvent&&(n.handleEvent=qa(n.handleEvent,{mechanism:{data:{handler:ss(n),target:t},handled:!1,type:"auto.browser.browserapierrors.handleEvent"}}))}catch{}return e.unregisterOriginalCallbacks&&function(t,e,i){t&&"object"==typeof t&&"removeEventListener"in t&&"function"==typeof t.removeEventListener&&t.removeEventListener(e,i)}(this,s,n),i.apply(this,[s,qa(n,{mechanism:{data:{handler:ss(n),target:t},handled:!1,type:"auto.browser.browserapierrors.addEventListener"}}),r])}}),qs(s,"removeEventListener",function(t){return function(e,i,s){try{const n=i.te;n&&t.call(this,e,n,s)}catch{}return t.call(this,e,i,s)}}))}(t,e))}}};function Yc(t){return function(...e){const i=e[0];return e[0]=qa(i,{mechanism:{handled:!1,type:`auto.browser.browserapierrors.${ss(t)}`}}),t.apply(this,e)}}function Xc(t){return function(e){return t.apply(this,[qa(e,{mechanism:{data:{handler:ss(t)},handled:!1,type:"auto.browser.browserapierrors.requestAnimationFrame"}})])}}function Jc(t){return function(...e){const i=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(t=>{t in i&&"function"==typeof i[t]&&qs(i,t,function(e){const i={mechanism:{data:{handler:ss(e)},handled:!1,type:`auto.browser.browserapierrors.xhr.${t}`}},s=Ns(e);return s&&(i.mechanism.data.handler=ss(s)),qa(e,i)})}),t.apply(this,e)}}const Kc=(t={})=>{const e={onerror:!0,onunhandledrejection:!0,...t};return{name:"GlobalHandlers",setupOnce(){Error.stackTraceLimit=50},setup(t){e.onerror&&(function(t){ls(e=>{const{stackParser:i,attachStacktrace:s}=Zc();if(Sn()!==t||za())return;const{msg:n,url:r,line:o,column:a,error:h}=e,c=function(t,e,i,s){const n=t.exception=t.exception||{},r=n.values=n.values||[],o=r[0]=r[0]||{},a=o.stacktrace=o.stacktrace||{},h=a.frames=a.frames||[],c=s,u=i,l=function(t){if(Ms(t)&&0!==t.length){if(t.startsWith("data:")){const e=t.match(/^data:([^;]+)/);return`<data:${e?e[1]:"text/javascript"}${t.includes("base64,")?",base64":""}>`}return t.slice(0,1024)}}(e)??Ps();return 0===h.length&&h.push({colno:c,filename:l,function:Ki,in_app:!0,lineno:u}),t}(Ya(i,h||n,void 0,s,!1),r,o,a);c.level="error",bo(c,{originalException:h,mechanism:{handled:!1,type:"auto.browser.global_handlers.onerror"}})})}(t),Qc("onerror")),e.onunhandledrejection&&(function(t){fs(e=>{const{stackParser:i,attachStacktrace:s}=Zc();if(Sn()!==t||za())return;const n=function(t){if(ks(t))return t;try{if("reason"in t)return t.reason;if("detail"in t&&"reason"in t.detail)return t.detail.reason}catch{}return t}(e),r=ks(n)?{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(n)}`}]}}:Ya(i,n,void 0,s,!0);r.level="error",bo(r,{originalException:n,mechanism:{handled:!1,type:"auto.browser.global_handlers.onunhandledrejection"}})})}(t),Qc("onunhandledrejection"))}}};function Qc(t){Uc&&Ji.log(`Global Handler attached: ${t}`)}function Zc(){const t=Sn();return t?.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const tu=(t={})=>{const e=t.limit||5,i=t.key||"cause";return{name:"LinkedErrors",preprocessEvent(t,s,n){fa(La,n.getOptions().stackParser,i,e,t,s)}}},eu=qi,iu="sentryReplaySession",su="Unable to send Replay",nu=15e4,ru=5e3,ou=2e7;var au=Object.defineProperty,hu=(t,e,i)=>((t,e,i)=>e in t?au(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i),cu=(t=>(t[t.Document=0]="Document",t[t.DocumentType=1]="DocumentType",t[t.Element=2]="Element",t[t.Text=3]="Text",t[t.CDATA=4]="CDATA",t[t.Comment=5]="Comment",t))(cu||{});function uu(t){const e=t?.host;return Boolean(e?.shadowRoot===t)}function lu(t){return"[object ShadowRoot]"==={}.toString.call(t)}function du(t){try{const i=t.rules||t.cssRules;return i?((e=Array.from(i,pu).join("")).includes(" background-clip: text;")&&!e.includes(" -webkit-background-clip: text;")&&(e=e.replace(/\sbackground-clip:\s*text;/g," -webkit-background-clip: text; background-clip: text;")),e):null}catch(t){return null}var e}function pu(t){let e;if(function(t){return"styleSheet"in t}(t))try{e=du(t.styleSheet)||function(t){const{cssText:e}=t;if(e.split('"').length<3)return e;const i=["@import",`url(${JSON.stringify(t.href)})`];return""===t.layerName?i.push("layer"):t.layerName&&i.push(`layer(${t.layerName})`),t.supportsText&&i.push(`supports(${t.supportsText})`),t.media.length&&i.push(t.media.mediaText),i.join(" ")+";"}(t)}catch(t){}else if(function(t){return"selectorText"in t}(t)){let e=t.cssText;const i=t.selectorText.includes(":"),s="string"==typeof t.style.all&&t.style.all;if(s&&(e=function(t){let e="";for(let i=0;i<t.style.length;i++){const s=t.style,n=s[i],r=s.getPropertyPriority(n);e+=`${n}:${s.getPropertyValue(n)}${r?" !important":""};`}return`${t.selectorText} { ${e} }`}(t)),i&&(e=e.replace(/(\[(?:[\w-]+)[^\\])(:(?:[\w-]+)\])/gm,"$1\\$2")),i||s)return e}return e||t.cssText}class fu{constructor(){hu(this,"idNodeMap",new Map),hu(this,"nodeMetaMap",new WeakMap)}getId(t){if(!t)return-1;const e=this.getMeta(t)?.id;return e??-1}getNode(t){return this.idNodeMap.get(t)||null}getIds(){return Array.from(this.idNodeMap.keys())}getMeta(t){return this.nodeMetaMap.get(t)||null}removeNodeFromMap(t){const e=this.getId(t);this.idNodeMap.delete(e),t.childNodes&&t.childNodes.forEach(t=>this.removeNodeFromMap(t))}has(t){return this.idNodeMap.has(t)}hasNode(t){return this.nodeMetaMap.has(t)}add(t,e){const i=e.id;this.idNodeMap.set(i,t),this.nodeMetaMap.set(t,e)}replace(t,e){const i=this.getNode(t);if(i){const t=this.nodeMetaMap.get(i);t&&this.nodeMetaMap.set(e,t)}this.idNodeMap.set(t,e)}reset(){this.idNodeMap=new Map,this.nodeMetaMap=new WeakMap}}function mu({maskInputOptions:t,tagName:e,type:i}){return"OPTION"===e&&(e="SELECT"),Boolean(t[e.toLowerCase()]||i&&t[i]||"password"===i||"INPUT"===e&&!i&&t.text)}function gu({isMasked:t,element:e,value:i,maskInputFn:s}){let n=i||"";return t?(s&&(n=s(n,e)),"*".repeat(n.length)):n}function yu(t){return t.toLowerCase()}function bu(t){return t.toUpperCase()}const vu="__rrweb_original__";function wu(t){const e=t.type;return t.hasAttribute("data-rr-is-password")?"password":e?yu(e):null}function Mu(t,e,i){return"INPUT"!==e||"radio"!==i&&"checkbox"!==i?t.value:t.getAttribute("value")||""}function Su(t,e){let i;try{i=new URL(t,window.location.href)}catch(t){return null}const s=i.pathname.match(/\.([0-9a-z]+)(?:$)/i);return s?.[1]??null}const ku={};function xu(t){const e=ku[t];if(e)return e;const i=window.document;let s=window[t];if(i&&"function"==typeof i.createElement)try{const e=i.createElement("iframe");e.hidden=!0,i.head.appendChild(e);const n=e.contentWindow;n&&n[t]&&(s=n[t]),i.head.removeChild(e)}catch(t){}return ku[t]=s.bind(window)}function Tu(...t){return xu("setTimeout")(...t)}function Eu(...t){return xu("clearTimeout")(...t)}function Cu(t){try{return t.contentDocument}catch(t){}}let Au=1;const Iu=new RegExp("[^a-z0-9-_:]");function Fu(){return Au++}let _u,Ru;const Pu=/url\((?:(')([^']*)'|(")(.*?)"|([^)]*))\)/gm,Ou=/^(?:[a-z+]+:)?\/\//i,Bu=/^www\..*/i,Du=/^(data:)([^,]*),(.*)/i;function $u(t,e){return(t||"").replace(Pu,(t,i,s,n,r,o)=>{const a=s||r||o,h=i||n||"";if(!a)return t;if(Ou.test(a)||Bu.test(a))return`url(${h}${a}${h})`;if(Du.test(a))return`url(${h}${a}${h})`;if("/"===a[0])return`url(${h}${function(t){let e="";return e=t.indexOf("//")>-1?t.split("/").slice(0,3).join("/"):t.split("/")[0],e=e.split("?")[0],e}(e)+a}${h})`;const c=e.split("/"),u=a.split("/");c.pop();for(const t of u)"."!==t&&(".."===t?c.pop():c.push(t));return`url(${h}${c.join("/")}${h})`})}const zu=/^[^ \t\n\r\u000c]+/,qu=/^[, \t\n\r\u000c]+/,ju=new WeakMap;function Lu(t,e){return e&&""!==e.trim()?Nu(t,e):e}function Nu(t,e){let i=ju.get(t);if(i||(i=t.createElement("a"),ju.set(t,i)),e){if(e.startsWith("blob:")||e.startsWith("data:"))return e}else e="";return i.setAttribute("href",e),i.href}function Gu(t,e,i,s,n,r){return s?"src"===i||"href"===i&&("use"!==e||"#"!==s[0])||"xlink:href"===i&&"#"!==s[0]?Lu(t,s):"background"!==i||"table"!==e&&"td"!==e&&"th"!==e?"srcset"===i?function(t,e){if(""===e.trim())return e;let i=0;function s(t){let s;const n=t.exec(e.substring(i));return n?(s=n[0],i+=s.length,s):""}const n=[];for(;s(qu),!(i>=e.length);){let r=s(zu);if(","===r.slice(-1))r=Lu(t,r.substring(0,r.length-1)),n.push(r);else{let s="";r=Lu(t,r);let o=!1;for(;;){const t=e.charAt(i);if(""===t){n.push((r+s).trim());break}if(o)")"===t&&(o=!1);else{if(","===t){i+=1,n.push((r+s).trim());break}"("===t&&(o=!0)}s+=t,i+=1}}}return n.join(", ")}(t,s):"style"===i?$u(s,Nu(t)):"object"===e&&"data"===i?Lu(t,s):"function"==typeof r?r(i,s,n):s:Lu(t,s):s}function Uu(t,e,i){return("video"===t||"audio"===t)&&"autoplay"===e}function Wu(t,e,i=1/0,s=0){return t?t.nodeType!==t.ELEMENT_NODE||s>i?-1:e(t)?s:Wu(t.parentNode,e,i,s+1):-1}function Hu(t,e){return i=>{const s=i;if(null===s)return!1;try{if(t)if("string"==typeof t){if(s.matches(`.${t}`))return!0}else if(function(t,e){for(let i=t.classList.length;i--;){const s=t.classList[i];if(e.test(s))return!0}return!1}(s,t))return!0;return!(!e||!s.matches(e))}catch{return!1}}}function Vu(t,e,i,s,n,r){try{const o=t.nodeType===t.ELEMENT_NODE?t:t.parentElement;if(null===o)return!1;if("INPUT"===o.tagName){const t=o.getAttribute("autocomplete");if(["current-password","new-password","cc-number","cc-exp","cc-exp-month","cc-exp-year","cc-csc"].includes(t))return!0}let a=-1,h=-1;if(r){if(h=Wu(o,Hu(s,n)),h<0)return!0;a=Wu(o,Hu(e,i),h>=0?h:1/0)}else{if(a=Wu(o,Hu(e,i)),a<0)return!1;h=Wu(o,Hu(s,n),a>=0?a:1/0)}return a>=0?!(h>=0)||a<=h:!(h>=0||!r)}catch(t){}return!!r}function Yu(t){return null==t?"":t.toLowerCase()}function Xu(t,e){const{doc:i,mirror:s,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:a,maskTextClass:h,unmaskTextClass:c,maskTextSelector:u,unmaskTextSelector:l,skipChild:d=!1,inlineStylesheet:p=!0,maskInputOptions:f={},maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOMOptions:b,dataURLOptions:v={},inlineImages:w=!1,recordCanvas:M=!1,onSerialize:S,onIframeLoad:k,iframeLoadTimeout:x=5e3,onBlockedImageLoad:T,onStylesheetLoad:E,stylesheetLoadTimeout:C=5e3,keepIframeSrcFn:A=()=>!1,newlyAddedElement:I=!1}=e;let{preserveWhiteSpace:F=!0}=e;const _=function(t,e){const{doc:i,mirror:s,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:a,maskAttributeFn:h,maskTextClass:c,unmaskTextClass:u,maskTextSelector:l,unmaskTextSelector:d,inlineStylesheet:p,maskInputOptions:f={},maskTextFn:m,maskInputFn:g,dataURLOptions:y={},inlineImages:b,recordCanvas:v,keepIframeSrcFn:w,newlyAddedElement:M=!1}=e,S=function(t,e){if(!e.hasNode(t))return;const i=e.getId(t);return 1===i?void 0:i}(i,s);switch(t.nodeType){case t.DOCUMENT_NODE:return"CSS1Compat"!==t.compatMode?{type:cu.Document,childNodes:[],compatMode:t.compatMode}:{type:cu.Document,childNodes:[]};case t.DOCUMENT_TYPE_NODE:return{type:cu.DocumentType,name:t.name,publicId:t.publicId,systemId:t.systemId,rootId:S};case t.ELEMENT_NODE:return function(t,e){const{doc:i,blockClass:s,blockSelector:n,unblockSelector:r,inlineStylesheet:o,maskInputOptions:a={},maskAttributeFn:h,maskInputFn:c,dataURLOptions:u={},inlineImages:l,recordCanvas:d,keepIframeSrcFn:p,newlyAddedElement:f=!1,rootId:m,maskTextClass:g,unmaskTextClass:y,maskTextSelector:b,unmaskTextSelector:v}=e,w=function(t,e,i,s){try{if(s&&t.matches(s))return!1;if("string"==typeof e){if(t.classList.contains(e))return!0}else for(let i=t.classList.length;i--;){const s=t.classList[i];if(e.test(s))return!0}if(i)return t.matches(i)}catch(t){}return!1}(t,s,n,r),M=function(t){if(t instanceof HTMLFormElement)return"form";const e=yu(t.tagName);return Iu.test(e)?"div":e}(t);let S={};const k=t.attributes.length;for(let e=0;e<k;e++){const s=t.attributes[e];s.name&&!Uu(M,s.name)&&(S[s.name]=Gu(i,M,yu(s.name),s.value,t,h))}if("link"===M&&o){const e=Array.from(i.styleSheets).find(e=>e.href===t.href);let s=null;e&&(s=du(e)),s&&(S.rel=null,S.href=null,S.crossorigin=null,S.ve=$u(s,e.href))}if("style"===M&&t.sheet&&!(t.innerText||t.textContent||"").trim().length){const e=du(t.sheet);e&&(S.ve=$u(e,Nu(i)))}if("input"===M||"textarea"===M||"select"===M||"option"===M){const e=t,i=wu(e),s=Mu(e,bu(M),i),n=e.checked;if("submit"!==i&&"button"!==i&&s){const t=Vu(e,g,b,y,v,mu({type:i,tagName:bu(M),maskInputOptions:a}));S.value=gu({isMasked:t,element:e,value:s,maskInputFn:c})}n&&(S.checked=n)}if("option"===M&&(t.selected&&!a.select?S.selected=!0:delete S.selected),"canvas"===M&&d)if("2d"===t.we)(function(t){const e=t.getContext("2d");if(!e)return!0;for(let i=0;i<t.width;i+=50)for(let s=0;s<t.height;s+=50){const n=e.getImageData,r=vu in n?n[vu]:n;if(new Uint32Array(r.call(e,i,s,Math.min(50,t.width-i),Math.min(50,t.height-s)).data.buffer).some(t=>0!==t))return!1}return!0})(t)||(S.rr_dataURL=t.toDataURL(u.type,u.quality));else if(!("we"in t)){const e=t.toDataURL(u.type,u.quality),s=i.createElement("canvas");s.width=t.width,s.height=t.height,e!==s.toDataURL(u.type,u.quality)&&(S.rr_dataURL=e)}if("img"===M&&l){_u||(_u=i.createElement("canvas"),Ru=_u.getContext("2d"));const e=t,s=(e.currentSrc||e.getAttribute("src"),e.crossOrigin),n=()=>{e.removeEventListener("load",n);try{_u.width=e.naturalWidth,_u.height=e.naturalHeight,Ru.drawImage(e,0,0),S.rr_dataURL=_u.toDataURL(u.type,u.quality)}catch(t){if("anonymous"!==e.crossOrigin)return e.crossOrigin="anonymous",void(e.complete&&0!==e.naturalWidth?n():e.addEventListener("load",n))}"anonymous"===e.crossOrigin&&(s?S.crossOrigin=s:e.removeAttribute("crossorigin"))};e.complete&&0!==e.naturalWidth?n():e.addEventListener("load",n)}if("audio"!==M&&"video"!==M||(S.rr_mediaState=t.paused?"paused":"played",S.rr_mediaCurrentTime=t.currentTime),f||(t.scrollLeft&&(S.rr_scrollLeft=t.scrollLeft),t.scrollTop&&(S.rr_scrollTop=t.scrollTop)),w){const{width:e,height:i}=t.getBoundingClientRect();S={class:S.class,rr_width:`${e}px`,rr_height:`${i}px`}}let x;"iframe"!==M||p(S.src)||(w||Cu(t)||(S.rr_src=S.src),delete S.src);try{customElements.get(M)&&(x=!0)}catch(t){}return{type:cu.Element,tagName:M,attributes:S,childNodes:[],isSVG:(T=t,Boolean("svg"===T.tagName||T.ownerSVGElement)||void 0),needBlock:w,rootId:m,isCustom:x};var T}(t,{doc:i,blockClass:n,blockSelector:r,unblockSelector:o,inlineStylesheet:p,maskAttributeFn:h,maskInputOptions:f,maskInputFn:g,dataURLOptions:y,inlineImages:b,recordCanvas:v,keepIframeSrcFn:w,newlyAddedElement:M,rootId:S,maskTextClass:c,unmaskTextClass:u,maskTextSelector:l,unmaskTextSelector:d});case t.TEXT_NODE:return function(t,e){const{maskAllText:i,maskTextClass:s,unmaskTextClass:n,maskTextSelector:r,unmaskTextSelector:o,maskTextFn:a,maskInputOptions:h,maskInputFn:c,rootId:u}=e,l=t.parentNode&&t.parentNode.tagName;let d=t.textContent;const p="STYLE"===l||void 0,f="SCRIPT"===l||void 0,m="TEXTAREA"===l||void 0;if(p&&d){try{t.nextSibling||t.previousSibling||t.parentNode.sheet?.cssRules&&(d=du(t.parentNode.sheet))}catch(t){}d=$u(d,Nu(e.doc))}f&&(d="SCRIPT_PLACEHOLDER");const g=Vu(t,s,r,n,o,i);return p||f||m||!d||!g||(d=a?a(d,t.parentElement):d.replace(/[\S]/g,"*")),m&&d&&(h.textarea||g)&&(d=c?c(d,t.parentNode):d.replace(/[\S]/g,"*")),"OPTION"===l&&d&&(d=gu({isMasked:Vu(t,s,r,n,o,mu({type:null,tagName:l,maskInputOptions:h})),element:t,value:d,maskInputFn:c})),{type:cu.Text,textContent:d||"",isStyle:p,rootId:u}}(t,{doc:i,maskAllText:a,maskTextClass:c,unmaskTextClass:u,maskTextSelector:l,unmaskTextSelector:d,maskTextFn:m,maskInputOptions:f,maskInputFn:g,rootId:S});case t.CDATA_SECTION_NODE:return{type:cu.CDATA,textContent:"",rootId:S};case t.COMMENT_NODE:return{type:cu.Comment,textContent:t.textContent||"",rootId:S};default:return!1}}(t,{doc:i,mirror:s,blockClass:n,blockSelector:r,maskAllText:a,unblockSelector:o,maskTextClass:h,unmaskTextClass:c,maskTextSelector:u,unmaskTextSelector:l,inlineStylesheet:p,maskInputOptions:f,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,dataURLOptions:v,inlineImages:w,recordCanvas:M,keepIframeSrcFn:A,newlyAddedElement:I});if(!_)return null;let R;R=s.hasNode(t)?s.getId(t):!function(t,e){if(e.comment&&t.type===cu.Comment)return!0;if(t.type===cu.Element){if(e.script&&("script"===t.tagName||"link"===t.tagName&&("preload"===t.attributes.rel||"modulepreload"===t.attributes.rel)||"link"===t.tagName&&"prefetch"===t.attributes.rel&&"string"==typeof t.attributes.href&&"js"===Su(t.attributes.href)))return!0;if(e.headFavicon&&("link"===t.tagName&&"shortcut icon"===t.attributes.rel||"meta"===t.tagName&&(Yu(t.attributes.name).match(/^msapplication-tile(image|color)$/)||"application-name"===Yu(t.attributes.name)||"icon"===Yu(t.attributes.rel)||"apple-touch-icon"===Yu(t.attributes.rel)||"shortcut icon"===Yu(t.attributes.rel))))return!0;if("meta"===t.tagName){if(e.headMetaDescKeywords&&Yu(t.attributes.name).match(/^description|keywords$/))return!0;if(e.headMetaSocial&&(Yu(t.attributes.property).match(/^(og|twitter|fb):/)||Yu(t.attributes.name).match(/^(og|twitter):/)||"pinterest"===Yu(t.attributes.name)))return!0;if(e.headMetaRobots&&("robots"===Yu(t.attributes.name)||"googlebot"===Yu(t.attributes.name)||"bingbot"===Yu(t.attributes.name)))return!0;if(e.headMetaHttpEquiv&&void 0!==t.attributes["http-equiv"])return!0;if(e.headMetaAuthorship&&("author"===Yu(t.attributes.name)||"generator"===Yu(t.attributes.name)||"framework"===Yu(t.attributes.name)||"publisher"===Yu(t.attributes.name)||"progid"===Yu(t.attributes.name)||Yu(t.attributes.property).match(/^article:/)||Yu(t.attributes.property).match(/^product:/)))return!0;if(e.headMetaVerification&&("google-site-verification"===Yu(t.attributes.name)||"yandex-verification"===Yu(t.attributes.name)||"csrf-token"===Yu(t.attributes.name)||"p:domain_verify"===Yu(t.attributes.name)||"verify-v1"===Yu(t.attributes.name)||"verification"===Yu(t.attributes.name)||"shopify-checkout-api-token"===Yu(t.attributes.name)))return!0}}return!1}(_,b)&&(F||_.type!==cu.Text||_.isStyle||_.textContent.replace(/^\s+|\s+$/gm,"").length)?Fu():-2;const P=Object.assign(_,{id:R});if(s.add(t,P),-2===R)return null;S&&S(t);let O=!d;if(P.type===cu.Element){O=O&&!P.needBlock;const e=t.shadowRoot;e&&lu(e)&&(P.isShadowHost=!0)}if((P.type===cu.Document||P.type===cu.Element)&&O){b.headWhitespace&&P.type===cu.Element&&"head"===P.tagName&&(F=!1);const e={doc:i,mirror:s,blockClass:n,blockSelector:r,maskAllText:a,unblockSelector:o,maskTextClass:h,unmaskTextClass:c,maskTextSelector:u,unmaskTextSelector:l,skipChild:d,inlineStylesheet:p,maskInputOptions:f,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOMOptions:b,dataURLOptions:v,inlineImages:w,recordCanvas:M,preserveWhiteSpace:F,onSerialize:S,onIframeLoad:k,iframeLoadTimeout:x,onBlockedImageLoad:T,onStylesheetLoad:E,stylesheetLoadTimeout:C,keepIframeSrcFn:A},I=t.childNodes?Array.from(t.childNodes):[];for(const t of I){const i=Xu(t,e);i&&P.childNodes.push(i)}if(function(t){return t.nodeType===t.ELEMENT_NODE}(t)&&t.shadowRoot)for(const i of Array.from(t.shadowRoot.childNodes)){const s=Xu(i,e);s&&(lu(t.shadowRoot)&&(s.isShadow=!0),P.childNodes.push(s))}}if(t.parentNode&&uu(t.parentNode)&&lu(t.parentNode)&&(P.isShadow=!0),P.type!==cu.Element||"iframe"!==P.tagName||P.needBlock||function(t,e,i){const s=t.contentWindow;if(!s)return;let n,r=!1;try{n=s.document.readyState}catch(t){return}if("complete"!==n){const s=Tu(()=>{r||(e(),r=!0)},i);return void t.addEventListener("load",()=>{Eu(s),r=!0,e()})}const o="about:blank";if(s.location.href!==o||t.src===o||""===t.src)return Tu(e,0),t.addEventListener("load",e);t.addEventListener("load",e)}(t,()=>{const e=Cu(t);if(e&&k){const i=Xu(e,{doc:e,mirror:s,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:a,maskTextClass:h,unmaskTextClass:c,maskTextSelector:u,unmaskTextSelector:l,skipChild:!1,inlineStylesheet:p,maskInputOptions:f,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOMOptions:b,dataURLOptions:v,inlineImages:w,recordCanvas:M,preserveWhiteSpace:F,onSerialize:S,onIframeLoad:k,iframeLoadTimeout:x,onStylesheetLoad:E,stylesheetLoadTimeout:C,keepIframeSrcFn:A});i&&k(t,i)}},x),P.type===cu.Element&&"img"===P.tagName&&!t.complete&&P.needBlock){const e=t,i=()=>{if(e.isConnected&&!e.complete&&T)try{const t=e.getBoundingClientRect();t.width>0&&t.height>0&&T(e,P,t)}catch(t){}e.removeEventListener("load",i)};e.isConnected&&e.addEventListener("load",i)}return P.type===cu.Element&&"link"===P.tagName&&"string"==typeof P.attributes.rel&&("stylesheet"===P.attributes.rel||"preload"===P.attributes.rel&&"string"==typeof P.attributes.href&&"css"===Su(P.attributes.href))&&function(t,e,i){let s,n=!1;try{s=t.sheet}catch(t){return}if(s)return;const r=Tu(()=>{n||(e(),n=!0)},i);t.addEventListener("load",()=>{Eu(r),n=!0,e()})}(t,()=>{if(E){const e=Xu(t,{doc:i,mirror:s,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:a,maskTextClass:h,unmaskTextClass:c,maskTextSelector:u,unmaskTextSelector:l,skipChild:!1,inlineStylesheet:p,maskInputOptions:f,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOMOptions:b,dataURLOptions:v,inlineImages:w,recordCanvas:M,preserveWhiteSpace:F,onSerialize:S,onIframeLoad:k,iframeLoadTimeout:x,onStylesheetLoad:E,stylesheetLoadTimeout:C,keepIframeSrcFn:A});e&&E(t,e)}},C),P.type===cu.Element&&delete P.needBlock,P}function Ju(t,e,i=document){const s={capture:!0,passive:!0};return i.addEventListener(t,e,s),()=>i.removeEventListener(t,e,s)}let Ku={map:{},getId:()=>-1,getNode:()=>null,removeNodeFromMap(){},has:()=>!1,reset(){}};function Qu(t,e,i={}){let s=null,n=0;return function(...r){const o=Date.now();n||!1!==i.leading||(n=o);const a=e-(o-n),h=this;a<=0||a>e?(s&&(function(...t){yl("clearTimeout")(...t)}(s),s=null),n=o,t.apply(h,r)):s||!1===i.trailing||(s=bl(()=>{n=!1===i.leading?0:Date.now(),s=null,t.apply(h,r)},a))}}function Zu(t,e,i,s,n=window){const r=n.Object.getOwnPropertyDescriptor(t,e);return n.Object.defineProperty(t,e,s?i:{set(t){bl(()=>{i.set.call(this,t)},0),r&&r.set&&r.set.call(this,t)}}),()=>Zu(t,e,r||{},!0)}function tl(t,e,i){try{if(!(e in t))return()=>{};const s=t[e],n=i(s);return"function"==typeof n&&(n.prototype=n.prototype||{},Object.defineProperties(n,{Me:{enumerable:!1,value:s}})),t[e]=n,()=>{t[e]=s}}catch{return()=>{}}}"undefined"!=typeof window&&window.Proxy&&window.Reflect&&(Ku=new Proxy(Ku,{get:(t,e,i)=>Reflect.get(t,e,i)}));let el=Date.now;function il(t){const e=t.document;return{left:e.scrollingElement?e.scrollingElement.scrollLeft:void 0!==t.pageXOffset?t.pageXOffset:e?.documentElement.scrollLeft||e?.body?.parentElement?.scrollLeft||e?.body?.scrollLeft||0,top:e.scrollingElement?e.scrollingElement.scrollTop:void 0!==t.pageYOffset?t.pageYOffset:e?.documentElement.scrollTop||e?.body?.parentElement?.scrollTop||e?.body?.scrollTop||0}}function sl(){return window.innerHeight||document.documentElement&&document.documentElement.clientHeight||document.body&&document.body.clientHeight}function nl(){return window.innerWidth||document.documentElement&&document.documentElement.clientWidth||document.body&&document.body.clientWidth}function rl(t){if(!t)return null;try{return t.nodeType===t.ELEMENT_NODE?t:t.parentElement}catch(t){return null}}function ol(t,e,i,s,n){if(!t)return!1;const r=rl(t);if(!r)return!1;const o=Hu(e,i);if(!n){const t=s&&r.matches(s);return o(r)&&!t}const a=Wu(r,o);let h=-1;return!(a<0)&&(s&&(h=Wu(r,Hu(null,s))),a>-1&&h<0||a<h)}function al(t,e){return-2===e.getId(t)}function hl(t,e){if(uu(t))return!1;const i=e.getId(t);return!e.has(i)||(!t.parentNode||t.parentNode.nodeType!==t.DOCUMENT_NODE)&&(!t.parentNode||hl(t.parentNode,e))}function cl(t){return Boolean(t.changedTouches)}function ul(t,e){return Boolean("IFRAME"===t.nodeName&&e.getMeta(t))}function ll(t,e){return Boolean("LINK"===t.nodeName&&t.nodeType===t.ELEMENT_NODE&&t.getAttribute&&"stylesheet"===t.getAttribute("rel")&&e.getMeta(t))}function dl(t){return Boolean(t?.shadowRoot)}/[1-9][0-9]{12}/.test(Date.now().toString())||(el=()=>(new Date).getTime());class pl{constructor(){this.id=1,this.styleIDMap=new WeakMap,this.idStyleMap=new Map}getId(t){return this.styleIDMap.get(t)??-1}has(t){return this.styleIDMap.has(t)}add(t,e){if(this.has(t))return this.getId(t);let i;return i=void 0===e?this.id++:e,this.styleIDMap.set(t,i),this.idStyleMap.set(i,t),i}getStyle(t){return this.idStyleMap.get(t)||null}reset(){this.styleIDMap=new WeakMap,this.idStyleMap=new Map,this.id=1}generateId(){return this.id++}}function fl(t){let e=null;return t.getRootNode?.()?.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&t.getRootNode().host&&(e=t.getRootNode().host),e}function ml(t){const e=t.ownerDocument;return!!e&&(e.contains(t)||function(t){const e=t.ownerDocument;if(!e)return!1;const i=function(t){let e,i=t;for(;e=fl(i);)i=e;return i}(t);return e.contains(i)}(t))}const gl={};function yl(t){const e=gl[t];if(e)return e;const i=window.document;let s=window[t];if(i&&"function"==typeof i.createElement)try{const e=i.createElement("iframe");e.hidden=!0,i.head.appendChild(e);const n=e.contentWindow;n&&n[t]&&(s=n[t]),i.head.removeChild(e)}catch(t){}return gl[t]=s.bind(window)}function bl(...t){return yl("setTimeout")(...t)}var vl=(t=>(t[t.DomContentLoaded=0]="DomContentLoaded",t[t.Load=1]="Load",t[t.FullSnapshot=2]="FullSnapshot",t[t.IncrementalSnapshot=3]="IncrementalSnapshot",t[t.Meta=4]="Meta",t[t.Custom=5]="Custom",t[t.Plugin=6]="Plugin",t))(vl||{}),wl=(t=>(t[t.Mutation=0]="Mutation",t[t.MouseMove=1]="MouseMove",t[t.MouseInteraction=2]="MouseInteraction",t[t.Scroll=3]="Scroll",t[t.ViewportResize=4]="ViewportResize",t[t.Input=5]="Input",t[t.TouchMove=6]="TouchMove",t[t.MediaInteraction=7]="MediaInteraction",t[t.StyleSheetRule=8]="StyleSheetRule",t[t.CanvasMutation=9]="CanvasMutation",t[t.Font=10]="Font",t[t.Log=11]="Log",t[t.Drag=12]="Drag",t[t.StyleDeclaration=13]="StyleDeclaration",t[t.Selection=14]="Selection",t[t.AdoptedStyleSheet=15]="AdoptedStyleSheet",t[t.CustomElement=16]="CustomElement",t))(wl||{}),Ml=(t=>(t[t.MouseUp=0]="MouseUp",t[t.MouseDown=1]="MouseDown",t[t.Click=2]="Click",t[t.ContextMenu=3]="ContextMenu",t[t.DblClick=4]="DblClick",t[t.Focus=5]="Focus",t[t.Blur=6]="Blur",t[t.TouchStart=7]="TouchStart",t[t.TouchMove_Departed=8]="TouchMove_Departed",t[t.TouchEnd=9]="TouchEnd",t[t.TouchCancel=10]="TouchCancel",t))(Ml||{}),Sl=(t=>(t[t.Mouse=0]="Mouse",t[t.Pen=1]="Pen",t[t.Touch=2]="Touch",t))(Sl||{}),kl=(t=>(t[t.Play=0]="Play",t[t.Pause=1]="Pause",t[t.Seeked=2]="Seeked",t[t.VolumeChange=3]="VolumeChange",t[t.RateChange=4]="RateChange",t))(kl||{});function xl(t){try{return t.contentDocument}catch(t){}}function Tl(t){return"Se"in t}class El{constructor(){this.length=0,this.head=null,this.tail=null}get(t){if(t>=this.length)throw new Error("Position outside of list range");let e=this.head;for(let i=0;i<t;i++)e=e?.next||null;return e}addNode(t){const e={value:t,previous:null,next:null};if(t.Se=e,t.previousSibling&&Tl(t.previousSibling)){const i=t.previousSibling.Se.next;e.next=i,e.previous=t.previousSibling.Se,t.previousSibling.Se.next=e,i&&(i.previous=e)}else if(t.nextSibling&&Tl(t.nextSibling)&&t.nextSibling.Se.previous){const i=t.nextSibling.Se.previous;e.previous=i,e.next=t.nextSibling.Se,t.nextSibling.Se.previous=e,i&&(i.next=e)}else this.head&&(this.head.previous=e),e.next=this.head,this.head=e;null===e.next&&(this.tail=e),this.length++}removeNode(t){const e=t.Se;this.head&&(e.previous?(e.previous.next=e.next,e.next?e.next.previous=e.previous:this.tail=e.previous):(this.head=e.next,this.head?this.head.previous=null:this.tail=null),t.Se&&delete t.Se,this.length--)}}const Cl=(t,e)=>`${t}@${e}`;class Al{constructor(){this.frozen=!1,this.locked=!1,this.texts=[],this.attributes=[],this.attributeMap=new WeakMap,this.removes=[],this.mapRemoves=[],this.movedMap={},this.addedSet=new Set,this.movedSet=new Set,this.droppedSet=new Set,this.processMutations=t=>{t.forEach(this.processMutation),this.emit()},this.emit=()=>{if(this.frozen||this.locked)return;const t=[],e=new Set,i=new El,s=t=>{let e=t,i=-2;for(;-2===i;)e=e&&e.nextSibling,i=e&&this.mirror.getId(e);return i},n=n=>{if(!n.parentNode||!ml(n))return;const r=uu(n.parentNode)?this.mirror.getId(fl(n)):this.mirror.getId(n.parentNode),o=s(n);if(-1===r||-1===o)return i.addNode(n);const a=Xu(n,{doc:this.doc,mirror:this.mirror,blockClass:this.blockClass,blockSelector:this.blockSelector,maskAllText:this.maskAllText,unblockSelector:this.unblockSelector,maskTextClass:this.maskTextClass,unmaskTextClass:this.unmaskTextClass,maskTextSelector:this.maskTextSelector,unmaskTextSelector:this.unmaskTextSelector,skipChild:!0,newlyAddedElement:!0,inlineStylesheet:this.inlineStylesheet,maskInputOptions:this.maskInputOptions,maskAttributeFn:this.maskAttributeFn,maskTextFn:this.maskTextFn,maskInputFn:this.maskInputFn,slimDOMOptions:this.slimDOMOptions,dataURLOptions:this.dataURLOptions,recordCanvas:this.recordCanvas,inlineImages:this.inlineImages,onSerialize:t=>{ul(t,this.mirror)&&!ol(t,this.blockClass,this.blockSelector,this.unblockSelector,!1)&&this.iframeManager.addIframe(t),ll(t,this.mirror)&&this.stylesheetManager.trackLinkElement(t),dl(n)&&this.shadowDomManager.addShadowRoot(n.shadowRoot,this.doc)},onIframeLoad:(t,e)=>{ol(t,this.blockClass,this.blockSelector,this.unblockSelector,!1)||(this.iframeManager.attachIframe(t,e),t.contentWindow&&this.canvasManager.addWindow(t.contentWindow),this.shadowDomManager.observeAttachShadow(t))},onStylesheetLoad:(t,e)=>{this.stylesheetManager.attachLinkElement(t,e)},onBlockedImageLoad:(t,e,{width:i,height:s})=>{this.mutationCb({adds:[],removes:[],texts:[],attributes:[{id:e.id,attributes:{style:{width:`${i}px`,height:`${s}px`}}}]})}});a&&(t.push({parentId:r,nextId:o,node:a}),e.add(a.id))};for(;this.mapRemoves.length;)this.mirror.removeNodeFromMap(this.mapRemoves.shift());for(const t of this.movedSet)Fl(this.removes,t,this.mirror)&&!this.movedSet.has(t.parentNode)||n(t);for(const t of this.addedSet)_l(this.droppedSet,t)||Fl(this.removes,t,this.mirror)?_l(this.movedSet,t)?n(t):this.droppedSet.add(t):n(t);let r=null;for(;i.length;){let t=null;if(r){const e=this.mirror.getId(r.value.parentNode),i=s(r.value);-1!==e&&-1!==i&&(t=r)}if(!t){let e=i.tail;for(;e;){const i=e;if(e=e.previous,i){const e=this.mirror.getId(i.value.parentNode);if(-1===s(i.value))continue;if(-1!==e){t=i;break}{const e=i.value;if(e.parentNode&&e.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const s=e.parentNode.host;if(-1!==this.mirror.getId(s)){t=i;break}}}}}}if(!t){for(;i.head;)i.removeNode(i.head.value);break}r=t.previous,i.removeNode(t.value),n(t.value)}const o={texts:this.texts.map(t=>({id:this.mirror.getId(t.node),value:t.value})).filter(t=>!e.has(t.id)).filter(t=>this.mirror.has(t.id)),attributes:this.attributes.map(t=>{const{attributes:e}=t;if("string"==typeof e.style){const i=JSON.stringify(t.styleDiff),s=JSON.stringify(t.ke);i.length<e.style.length&&(i+s).split("var(").length===e.style.split("var(").length&&(e.style=t.styleDiff)}return{id:this.mirror.getId(t.node),attributes:e}}).filter(t=>!e.has(t.id)).filter(t=>this.mirror.has(t.id)),removes:this.removes,adds:t};(o.texts.length||o.attributes.length||o.removes.length||o.adds.length)&&(this.texts=[],this.attributes=[],this.attributeMap=new WeakMap,this.removes=[],this.addedSet=new Set,this.movedSet=new Set,this.droppedSet=new Set,this.movedMap={},this.mutationCb(o))},this.processMutation=t=>{if(!al(t.target,this.mirror))switch(t.type){case"characterData":{const e=t.target.textContent;ol(t.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||e===t.oldValue||this.texts.push({value:Vu(t.target,this.maskTextClass,this.maskTextSelector,this.unmaskTextClass,this.unmaskTextSelector,this.maskAllText)&&e?this.maskTextFn?this.maskTextFn(e,rl(t.target)):e.replace(/[\S]/g,"*"):e,node:t.target});break}case"attributes":{const e=t.target;let i=t.attributeName,s=t.target.getAttribute(i);if("value"===i){const i=wu(e),n=e.tagName;s=Mu(e,n,i);const r=mu({maskInputOptions:this.maskInputOptions,tagName:n,type:i});s=gu({isMasked:Vu(t.target,this.maskTextClass,this.maskTextSelector,this.unmaskTextClass,this.unmaskTextSelector,r),element:e,value:s,maskInputFn:this.maskInputFn})}if(ol(t.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||s===t.oldValue)return;let n=this.attributeMap.get(t.target);if("IFRAME"===e.tagName&&"src"===i&&!this.keepIframeSrcFn(s)){if(xl(e))return;i="rr_src"}if(n||(n={node:t.target,attributes:{},styleDiff:{},ke:{}},this.attributes.push(n),this.attributeMap.set(t.target,n)),"type"===i&&"INPUT"===e.tagName&&"password"===(t.oldValue||"").toLowerCase()&&e.setAttribute("data-rr-is-password","true"),!Uu(e.tagName,i)&&(n.attributes[i]=Gu(this.doc,yu(e.tagName),yu(i),s,e,this.maskAttributeFn),"style"===i)){if(!this.unattachedDoc)try{this.unattachedDoc=document.implementation.createHTMLDocument()}catch(t){this.unattachedDoc=this.doc}const i=this.unattachedDoc.createElement("span");t.oldValue&&i.setAttribute("style",t.oldValue);for(const t of Array.from(e.style)){const s=e.style.getPropertyValue(t),r=e.style.getPropertyPriority(t);s!==i.style.getPropertyValue(t)||r!==i.style.getPropertyPriority(t)?n.styleDiff[t]=""===r?s:[s,r]:n.ke[t]=[s,r]}for(const t of Array.from(i.style))""===e.style.getPropertyValue(t)&&(n.styleDiff[t]=!1)}break}case"childList":if(ol(t.target,this.blockClass,this.blockSelector,this.unblockSelector,!0))return;t.addedNodes.forEach(e=>this.genAdds(e,t.target)),t.removedNodes.forEach(e=>{const i=this.mirror.getId(e),s=uu(t.target)?this.mirror.getId(t.target.host):this.mirror.getId(t.target);ol(t.target,this.blockClass,this.blockSelector,this.unblockSelector,!1)||al(e,this.mirror)||!function(t,e){return-1!==e.getId(t)}(e,this.mirror)||(this.addedSet.has(e)?(Il(this.addedSet,e),this.droppedSet.add(e)):this.addedSet.has(t.target)&&-1===i||hl(t.target,this.mirror)||(this.movedSet.has(e)&&this.movedMap[Cl(i,s)]?Il(this.movedSet,e):this.removes.push({parentId:s,id:i,isShadow:!(!uu(t.target)||!lu(t.target))||void 0})),this.mapRemoves.push(e))})}},this.genAdds=(t,e)=>{if(!this.processedNodeManager.inOtherBuffer(t,this)&&!this.addedSet.has(t)&&!this.movedSet.has(t)){if(this.mirror.hasNode(t)){if(al(t,this.mirror))return;this.movedSet.add(t);let i=null;e&&this.mirror.hasNode(e)&&(i=this.mirror.getId(e)),i&&-1!==i&&(this.movedMap[Cl(this.mirror.getId(t),i)]=!0)}else this.addedSet.add(t),this.droppedSet.delete(t);ol(t,this.blockClass,this.blockSelector,this.unblockSelector,!1)||(t.childNodes&&t.childNodes.forEach(t=>this.genAdds(t)),dl(t)&&t.shadowRoot.childNodes.forEach(e=>{this.processedNodeManager.add(e,this),this.genAdds(e,t)}))}}}init(t){["mutationCb","blockClass","blockSelector","unblockSelector","maskAllText","maskTextClass","unmaskTextClass","maskTextSelector","unmaskTextSelector","inlineStylesheet","maskInputOptions","maskAttributeFn","maskTextFn","maskInputFn","keepIframeSrcFn","recordCanvas","inlineImages","slimDOMOptions","dataURLOptions","doc","mirror","iframeManager","stylesheetManager","shadowDomManager","canvasManager","processedNodeManager"].forEach(e=>{this[e]=t[e]})}freeze(){this.frozen=!0,this.canvasManager.freeze()}unfreeze(){this.frozen=!1,this.canvasManager.unfreeze(),this.emit()}isFrozen(){return this.frozen}lock(){this.locked=!0,this.canvasManager.lock()}unlock(){this.locked=!1,this.canvasManager.unlock(),this.emit()}reset(){this.shadowDomManager.reset(),this.canvasManager.reset()}}function Il(t,e){t.delete(e),e.childNodes?.forEach(e=>Il(t,e))}function Fl(t,e,i){return 0!==t.length&&function(t,e,i){let s=e.parentNode;for(;s;){const e=i.getId(s);if(t.some(t=>t.id===e))return!0;s=s.parentNode}return!1}(t,e,i)}function _l(t,e){return 0!==t.size&&Rl(t,e)}function Rl(t,e){const{parentNode:i}=e;return!!i&&(!!t.has(i)||Rl(t,i))}let Pl;const Ol=t=>Pl?(...e)=>{try{return t(...e)}catch(t){if(Pl&&!0===Pl(t))return()=>{};throw t}}:t,Bl=[];function Dl(t){try{if("composedPath"in t){const e=t.composedPath();if(e.length)return e[0]}else if("path"in t&&t.path.length)return t.path[0]}catch{}return t&&t.target}function $l(t,e){const i=new Al;Bl.push(i),i.init(t);let s=window.MutationObserver||window.__rrMutationObserver;const n=window?.Zone?.__symbol__?.("MutationObserver");n&&window[n]&&(s=window[n]);const r=new s(Ol(e=>{t.onMutation&&!1===t.onMutation(e)||i.processMutations.bind(i)(e)}));return r.observe(e,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),r}function zl({scrollCb:t,doc:e,mirror:i,blockClass:s,blockSelector:n,unblockSelector:r,sampling:o}){return Ju("scroll",Ol(Qu(Ol(o=>{const a=Dl(o);if(!a||ol(a,s,n,r,!0))return;const h=i.getId(a);if(a===e&&e.defaultView){const i=il(e.defaultView);t({id:h,x:i.left,y:i.top})}else t({id:h,x:a.scrollLeft,y:a.scrollTop})}),o.scroll||100)),e)}const ql=["INPUT","TEXTAREA","SELECT"],jl=new WeakMap;function Ll({inputCb:t,doc:e,mirror:i,blockClass:s,blockSelector:n,unblockSelector:r,ignoreClass:o,ignoreSelector:a,maskInputOptions:h,maskInputFn:c,sampling:u,userTriggeredOnInput:l,maskTextClass:d,unmaskTextClass:p,maskTextSelector:f,unmaskTextSelector:m}){function g(t){let i=Dl(t);const u=t.isTrusted,g=i&&bu(i.tagName);if("OPTION"===g&&(i=i.parentElement),!i||!g||ql.indexOf(g)<0||ol(i,s,n,r,!0))return;const b=i;if(b.classList.contains(o)||a&&b.matches(a))return;const v=wu(i);let w=Mu(b,g,v),M=!1;const S=mu({maskInputOptions:h,tagName:g,type:v}),k=Vu(i,d,f,p,m,S);"radio"!==v&&"checkbox"!==v||(M=i.checked),w=gu({isMasked:k,element:i,value:w,maskInputFn:c}),y(i,l?{text:w,isChecked:M,userTriggered:u}:{text:w,isChecked:M});const x=i.name;"radio"===v&&x&&M&&e.querySelectorAll(`input[type="radio"][name="${x}"]`).forEach(t=>{if(t!==i){const e=gu({isMasked:k,element:t,value:Mu(t,g,v),maskInputFn:c});y(t,l?{text:e,isChecked:!M,userTriggered:!1}:{text:e,isChecked:!M})}})}function y(e,s){const n=jl.get(e);if(!n||n.text!==s.text||n.isChecked!==s.isChecked){jl.set(e,s);const n=i.getId(e);Ol(t)({...s,id:n})}}const b=("last"===u.input?["change"]:["input","change"]).map(t=>Ju(t,Ol(g),e)),v=e.defaultView;if(!v)return()=>{b.forEach(t=>t())};const w=v.Object.getOwnPropertyDescriptor(v.HTMLInputElement.prototype,"value"),M=[[v.HTMLInputElement.prototype,"value"],[v.HTMLInputElement.prototype,"checked"],[v.HTMLSelectElement.prototype,"value"],[v.HTMLTextAreaElement.prototype,"value"],[v.HTMLSelectElement.prototype,"selectedIndex"],[v.HTMLOptionElement.prototype,"selected"]];return w&&w.set&&b.push(...M.map(t=>Zu(t[0],t[1],{set(){Ol(g)({target:this,isTrusted:!1})}},!1,v))),Ol(()=>{b.forEach(t=>t())})}function Nl(t){return function(t,e){if(Hl("CSSGroupingRule")&&t.parentRule instanceof CSSGroupingRule||Hl("CSSMediaRule")&&t.parentRule instanceof CSSMediaRule||Hl("CSSSupportsRule")&&t.parentRule instanceof CSSSupportsRule||Hl("CSSConditionRule")&&t.parentRule instanceof CSSConditionRule){const i=Array.from(t.parentRule.cssRules).indexOf(t);e.unshift(i)}else if(t.parentStyleSheet){const i=Array.from(t.parentStyleSheet.cssRules).indexOf(t);e.unshift(i)}return e}(t,[])}function Gl(t,e,i){let s,n;return t?(t.ownerNode?s=e.getId(t.ownerNode):n=i.getId(t),{styleId:n,id:s}):{}}function Ul({mirror:t,stylesheetManager:e},i){let s=null;s="#document"===i.nodeName?t.getId(i):t.getId(i.host);const n="#document"===i.nodeName?i.defaultView?.Document:i.ownerDocument?.defaultView?.ShadowRoot,r=n?.prototype?Object.getOwnPropertyDescriptor(n?.prototype,"adoptedStyleSheets"):void 0;return null!==s&&-1!==s&&n&&r?(Object.defineProperty(i,"adoptedStyleSheets",{configurable:r.configurable,enumerable:r.enumerable,get(){return r.get?.call(this)},set(t){const i=r.set?.call(this,t);if(null!==s&&-1!==s)try{e.adoptStyleSheets(t,s)}catch(t){}return i}}),Ol(()=>{Object.defineProperty(i,"adoptedStyleSheets",{configurable:r.configurable,enumerable:r.enumerable,get:r.get,set:r.set})})):()=>{}}function Wl(t,e={}){const i=t.doc.defaultView;if(!i)return()=>{};let s;t.recordDOM&&(s=$l(t,t.doc));const n=function({mousemoveCb:t,sampling:e,doc:i,mirror:s}){if(!1===e.mousemove)return()=>{};const n="number"==typeof e.mousemove?e.mousemove:50,r="number"==typeof e.mousemoveCallback?e.mousemoveCallback:500;let o,a=[];const h=Qu(Ol(e=>{const i=Date.now()-o;t(a.map(t=>(t.timeOffset-=i,t)),e),a=[],o=null}),r),c=Ol(Qu(Ol(t=>{const e=Dl(t),{clientX:i,clientY:n}=cl(t)?t.changedTouches[0]:t;o||(o=el()),a.push({x:i,y:n,id:s.getId(e),timeOffset:el()-o}),h("undefined"!=typeof DragEvent&&t instanceof DragEvent?wl.Drag:t instanceof MouseEvent?wl.MouseMove:wl.TouchMove)}),n,{trailing:!1})),u=[Ju("mousemove",c,i),Ju("touchmove",c,i),Ju("drag",c,i)];return Ol(()=>{u.forEach(t=>t())})}(t),r=function({mouseInteractionCb:t,doc:e,mirror:i,blockClass:s,blockSelector:n,unblockSelector:r,sampling:o}){if(!1===o.mouseInteraction)return()=>{};const a=!0===o.mouseInteraction||void 0===o.mouseInteraction?{}:o.mouseInteraction,h=[];let c=null;return Object.keys(Ml).filter(t=>Number.isNaN(Number(t))&&!t.endsWith("_Departed")&&!1!==a[t]).forEach(o=>{let a=yu(o);const u=(e=>o=>{const a=Dl(o);if(ol(a,s,n,r,!0))return;let h=null,u=e;if("pointerType"in o){switch(o.pointerType){case"mouse":h=Sl.Mouse;break;case"touch":h=Sl.Touch;break;case"pen":h=Sl.Pen}h===Sl.Touch&&(Ml[e]===Ml.MouseDown?u="TouchStart":Ml[e]===Ml.MouseUp&&(u="TouchEnd"))}else cl(o)&&(h=Sl.Touch);null!==h?(c=h,(u.startsWith("Touch")&&h===Sl.Touch||u.startsWith("Mouse")&&h===Sl.Mouse)&&(h=null)):Ml[e]===Ml.Click&&(h=c,c=null);const l=cl(o)?o.changedTouches[0]:o;if(!l)return;const d=i.getId(a),{clientX:p,clientY:f}=l;Ol(t)({type:Ml[u],id:d,x:p,y:f,...null!==h&&{pointerType:h}})})(o);if(window.PointerEvent)switch(Ml[o]){case Ml.MouseDown:case Ml.MouseUp:a=a.replace("mouse","pointer");break;case Ml.TouchStart:case Ml.TouchEnd:return}h.push(Ju(a,u,e))}),Ol(()=>{h.forEach(t=>t())})}(t),o=zl(t),a=function({viewportResizeCb:t},{win:e}){let i=-1,s=-1;return Ju("resize",Ol(Qu(Ol(()=>{const e=sl(),n=nl();i===e&&s===n||(t({width:Number(n),height:Number(e)}),i=e,s=n)}),200)),e)}(t,{win:i}),h=Ll(t),c=function({mediaInteractionCb:t,blockClass:e,blockSelector:i,unblockSelector:s,mirror:n,sampling:r,doc:o}){const a=Ol(o=>Qu(Ol(r=>{const a=Dl(r);if(!a||ol(a,e,i,s,!0))return;const{currentTime:h,volume:c,muted:u,playbackRate:l}=a;t({type:o,id:n.getId(a),currentTime:h,volume:c,muted:u,playbackRate:l})}),r.media||500)),h=[Ju("play",a(kl.Play),o),Ju("pause",a(kl.Pause),o),Ju("seeked",a(kl.Seeked),o),Ju("volumechange",a(kl.VolumeChange),o),Ju("ratechange",a(kl.RateChange),o)];return Ol(()=>{h.forEach(t=>t())})}(t);let u=()=>{},l=()=>{},d=()=>{},p=()=>{};t.recordDOM&&(u=function({styleSheetRuleCb:t,mirror:e,stylesheetManager:i},{win:s}){if(!s.CSSStyleSheet||!s.CSSStyleSheet.prototype)return()=>{};const n=s.CSSStyleSheet.prototype.insertRule;s.CSSStyleSheet.prototype.insertRule=new Proxy(n,{apply:Ol((s,n,r)=>{const[o,a]=r,{id:h,styleId:c}=Gl(n,e,i.styleMirror);return(h&&-1!==h||c&&-1!==c)&&t({id:h,styleId:c,adds:[{rule:o,index:a}]}),s.apply(n,r)})});const r=s.CSSStyleSheet.prototype.deleteRule;let o,a;s.CSSStyleSheet.prototype.deleteRule=new Proxy(r,{apply:Ol((s,n,r)=>{const[o]=r,{id:a,styleId:h}=Gl(n,e,i.styleMirror);return(a&&-1!==a||h&&-1!==h)&&t({id:a,styleId:h,removes:[{index:o}]}),s.apply(n,r)})}),s.CSSStyleSheet.prototype.replace&&(o=s.CSSStyleSheet.prototype.replace,s.CSSStyleSheet.prototype.replace=new Proxy(o,{apply:Ol((s,n,r)=>{const[o]=r,{id:a,styleId:h}=Gl(n,e,i.styleMirror);return(a&&-1!==a||h&&-1!==h)&&t({id:a,styleId:h,replace:o}),s.apply(n,r)})})),s.CSSStyleSheet.prototype.replaceSync&&(a=s.CSSStyleSheet.prototype.replaceSync,s.CSSStyleSheet.prototype.replaceSync=new Proxy(a,{apply:Ol((s,n,r)=>{const[o]=r,{id:a,styleId:h}=Gl(n,e,i.styleMirror);return(a&&-1!==a||h&&-1!==h)&&t({id:a,styleId:h,replaceSync:o}),s.apply(n,r)})}));const h={};Vl("CSSGroupingRule")?h.CSSGroupingRule=s.CSSGroupingRule:(Vl("CSSMediaRule")&&(h.CSSMediaRule=s.CSSMediaRule),Vl("CSSConditionRule")&&(h.CSSConditionRule=s.CSSConditionRule),Vl("CSSSupportsRule")&&(h.CSSSupportsRule=s.CSSSupportsRule));const c={};return Object.entries(h).forEach(([s,n])=>{c[s]={insertRule:n.prototype.insertRule,deleteRule:n.prototype.deleteRule},n.prototype.insertRule=new Proxy(c[s].insertRule,{apply:Ol((s,n,r)=>{const[o,a]=r,{id:h,styleId:c}=Gl(n.parentStyleSheet,e,i.styleMirror);return(h&&-1!==h||c&&-1!==c)&&t({id:h,styleId:c,adds:[{rule:o,index:[...Nl(n),a||0]}]}),s.apply(n,r)})}),n.prototype.deleteRule=new Proxy(c[s].deleteRule,{apply:Ol((s,n,r)=>{const[o]=r,{id:a,styleId:h}=Gl(n.parentStyleSheet,e,i.styleMirror);return(a&&-1!==a||h&&-1!==h)&&t({id:a,styleId:h,removes:[{index:[...Nl(n),o]}]}),s.apply(n,r)})})}),Ol(()=>{s.CSSStyleSheet.prototype.insertRule=n,s.CSSStyleSheet.prototype.deleteRule=r,o&&(s.CSSStyleSheet.prototype.replace=o),a&&(s.CSSStyleSheet.prototype.replaceSync=a),Object.entries(h).forEach(([t,e])=>{e.prototype.insertRule=c[t].insertRule,e.prototype.deleteRule=c[t].deleteRule})})}(t,{win:i}),l=Ul(t,t.doc),d=function({styleDeclarationCb:t,mirror:e,ignoreCSSAttributes:i,stylesheetManager:s},{win:n}){const r=n.CSSStyleDeclaration.prototype.setProperty;n.CSSStyleDeclaration.prototype.setProperty=new Proxy(r,{apply:Ol((n,o,a)=>{const[h,c,u]=a;if(i.has(h))return r.apply(o,[h,c,u]);const{id:l,styleId:d}=Gl(o.parentRule?.parentStyleSheet,e,s.styleMirror);return(l&&-1!==l||d&&-1!==d)&&t({id:l,styleId:d,set:{property:h,value:c,priority:u},index:Nl(o.parentRule)}),n.apply(o,a)})});const o=n.CSSStyleDeclaration.prototype.removeProperty;return n.CSSStyleDeclaration.prototype.removeProperty=new Proxy(o,{apply:Ol((n,r,a)=>{const[h]=a;if(i.has(h))return o.apply(r,[h]);const{id:c,styleId:u}=Gl(r.parentRule?.parentStyleSheet,e,s.styleMirror);return(c&&-1!==c||u&&-1!==u)&&t({id:c,styleId:u,remove:{property:h},index:Nl(r.parentRule)}),n.apply(r,a)})}),Ol(()=>{n.CSSStyleDeclaration.prototype.setProperty=r,n.CSSStyleDeclaration.prototype.removeProperty=o})}(t,{win:i}),t.collectFonts&&(p=function({fontCb:t,doc:e}){const i=e.defaultView;if(!i)return()=>{};const s=[],n=new WeakMap,r=i.FontFace;i.FontFace=function(t,e,i){const s=new r(t,e,i);return n.set(s,{family:t,buffer:"string"!=typeof e,descriptors:i,fontSource:"string"==typeof e?e:JSON.stringify(Array.from(new Uint8Array(e)))}),s};const o=tl(e.fonts,"add",function(e){return function(i){return bl(Ol(()=>{const e=n.get(i);e&&(t(e),n.delete(i))}),0),e.apply(this,[i])}});return s.push(()=>{i.FontFace=r}),s.push(o),Ol(()=>{s.forEach(t=>t())})}(t)));const f=function(t){const{doc:e,mirror:i,blockClass:s,blockSelector:n,unblockSelector:r,selectionCb:o}=t;let a=!0;const h=Ol(()=>{const t=e.getSelection();if(!t||a&&t?.isCollapsed)return;a=t.isCollapsed||!1;const h=[],c=t.rangeCount||0;for(let e=0;e<c;e++){const o=t.getRangeAt(e),{startContainer:a,startOffset:c,endContainer:u,endOffset:l}=o;ol(a,s,n,r,!0)||ol(u,s,n,r,!0)||h.push({start:i.getId(a),startOffset:c,end:i.getId(u),endOffset:l})}o({ranges:h})});return h(),Ju("selectionchange",h)}(t),m=function({doc:t,customElementCb:e}){const i=t.defaultView;return i&&i.customElements?tl(i.customElements,"define",function(t){return function(i,s,n){try{e({define:{name:i}})}catch(t){}return t.apply(this,[i,s,n])}}):()=>{}}(t),g=[];for(const e of t.plugins)g.push(e.observer(e.callback,i,e.options));return Ol(()=>{Bl.forEach(t=>t.reset()),s?.disconnect(),n(),r(),o(),a(),h(),c(),u(),l(),d(),p(),f(),m(),g.forEach(t=>t())})}function Hl(t){return void 0!==window[t]}function Vl(t){return Boolean(void 0!==window[t]&&window[t].prototype&&"insertRule"in window[t].prototype&&"deleteRule"in window[t].prototype)}class Yl{constructor(t){this.generateIdFn=t,this.iframeIdToRemoteIdMap=new WeakMap,this.iframeRemoteIdToIdMap=new WeakMap}getId(t,e,i,s){const n=i||this.getIdToRemoteIdMap(t),r=s||this.getRemoteIdToIdMap(t);let o=n.get(e);return o||(o=this.generateIdFn(),n.set(e,o),r.set(o,e)),o}getIds(t,e){const i=this.getIdToRemoteIdMap(t),s=this.getRemoteIdToIdMap(t);return e.map(e=>this.getId(t,e,i,s))}getRemoteId(t,e,i){const s=i||this.getRemoteIdToIdMap(t);return"number"!=typeof e?e:s.get(e)||-1}getRemoteIds(t,e){const i=this.getRemoteIdToIdMap(t);return e.map(e=>this.getRemoteId(t,e,i))}reset(t){if(!t)return this.iframeIdToRemoteIdMap=new WeakMap,void(this.iframeRemoteIdToIdMap=new WeakMap);this.iframeIdToRemoteIdMap.delete(t),this.iframeRemoteIdToIdMap.delete(t)}getIdToRemoteIdMap(t){let e=this.iframeIdToRemoteIdMap.get(t);return e||(e=new Map,this.iframeIdToRemoteIdMap.set(t,e)),e}getRemoteIdToIdMap(t){let e=this.iframeRemoteIdToIdMap.get(t);return e||(e=new Map,this.iframeRemoteIdToIdMap.set(t,e)),e}}class Xl{constructor(){this.crossOriginIframeMirror=new Yl(Fu),this.crossOriginIframeRootIdMap=new WeakMap}addIframe(){}addLoadListener(){}attachIframe(){}}class Jl{constructor(t){this.iframes=new WeakMap,this.crossOriginIframeMap=new WeakMap,this.crossOriginIframeMirror=new Yl(Fu),this.crossOriginIframeRootIdMap=new WeakMap,this.mutationCb=t.mutationCb,this.wrappedEmit=t.wrappedEmit,this.stylesheetManager=t.stylesheetManager,this.recordCrossOriginIframes=t.recordCrossOriginIframes,this.crossOriginIframeStyleMirror=new Yl(this.stylesheetManager.styleMirror.generateId.bind(this.stylesheetManager.styleMirror)),this.mirror=t.mirror,this.recordCrossOriginIframes&&window.addEventListener("message",this.handleMessage.bind(this))}addIframe(t){this.iframes.set(t,!0),t.contentWindow&&this.crossOriginIframeMap.set(t.contentWindow,t)}addLoadListener(t){this.loadListener=t}attachIframe(t,e){this.mutationCb({adds:[{parentId:this.mirror.getId(t),nextId:null,node:e}],removes:[],texts:[],attributes:[],isAttachIframe:!0}),this.recordCrossOriginIframes&&t.contentWindow?.addEventListener("message",this.handleMessage.bind(this)),this.loadListener?.(t);const i=xl(t);i&&i.adoptedStyleSheets&&i.adoptedStyleSheets.length>0&&this.stylesheetManager.adoptStyleSheets(i.adoptedStyleSheets,this.mirror.getId(i))}handleMessage(t){const e=t;if("rrweb"!==e.data.type||e.origin!==e.data.origin)return;if(!t.source)return;const i=this.crossOriginIframeMap.get(t.source);if(!i)return;const s=this.transformCrossOriginEvent(i,e.data.event);s&&this.wrappedEmit(s,e.data.isCheckout)}transformCrossOriginEvent(t,e){switch(e.type){case vl.FullSnapshot:{this.crossOriginIframeMirror.reset(t),this.crossOriginIframeStyleMirror.reset(t),this.replaceIdOnNode(e.data.node,t);const i=e.data.node.id;return this.crossOriginIframeRootIdMap.set(t,i),this.patchRootIdOnNode(e.data.node,i),{timestamp:e.timestamp,type:vl.IncrementalSnapshot,data:{source:wl.Mutation,adds:[{parentId:this.mirror.getId(t),nextId:null,node:e.data.node}],removes:[],texts:[],attributes:[],isAttachIframe:!0}}}case vl.Meta:case vl.Load:case vl.DomContentLoaded:return!1;case vl.Plugin:return e;case vl.Custom:return this.replaceIds(e.data.payload,t,["id","parentId","previousId","nextId"]),e;case vl.IncrementalSnapshot:switch(e.data.source){case wl.Mutation:return e.data.adds.forEach(e=>{this.replaceIds(e,t,["parentId","nextId","previousId"]),this.replaceIdOnNode(e.node,t);const i=this.crossOriginIframeRootIdMap.get(t);i&&this.patchRootIdOnNode(e.node,i)}),e.data.removes.forEach(e=>{this.replaceIds(e,t,["parentId","id"])}),e.data.attributes.forEach(e=>{this.replaceIds(e,t,["id"])}),e.data.texts.forEach(e=>{this.replaceIds(e,t,["id"])}),e;case wl.Drag:case wl.TouchMove:case wl.MouseMove:return e.data.positions.forEach(e=>{this.replaceIds(e,t,["id"])}),e;case wl.ViewportResize:return!1;case wl.MediaInteraction:case wl.MouseInteraction:case wl.Scroll:case wl.CanvasMutation:case wl.Input:return this.replaceIds(e.data,t,["id"]),e;case wl.StyleSheetRule:case wl.StyleDeclaration:return this.replaceIds(e.data,t,["id"]),this.replaceStyleIds(e.data,t,["styleId"]),e;case wl.Font:return e;case wl.Selection:return e.data.ranges.forEach(e=>{this.replaceIds(e,t,["start","end"])}),e;case wl.AdoptedStyleSheet:return this.replaceIds(e.data,t,["id"]),this.replaceStyleIds(e.data,t,["styleIds"]),e.data.styles?.forEach(e=>{this.replaceStyleIds(e,t,["styleId"])}),e}}return!1}replace(t,e,i,s){for(const n of s)(Array.isArray(e[n])||"number"==typeof e[n])&&(Array.isArray(e[n])?e[n]=t.getIds(i,e[n]):e[n]=t.getId(i,e[n]));return e}replaceIds(t,e,i){return this.replace(this.crossOriginIframeMirror,t,e,i)}replaceStyleIds(t,e,i){return this.replace(this.crossOriginIframeStyleMirror,t,e,i)}replaceIdOnNode(t,e){this.replaceIds(t,e,["id","rootId"]),"childNodes"in t&&t.childNodes.forEach(t=>{this.replaceIdOnNode(t,e)})}patchRootIdOnNode(t,e){t.type===cu.Document||t.rootId||(t.rootId=e),"childNodes"in t&&t.childNodes.forEach(t=>{this.patchRootIdOnNode(t,e)})}}class Kl{init(){}addShadowRoot(){}observeAttachShadow(){}reset(){}}class Ql{constructor(t){this.shadowDoms=new WeakSet,this.restoreHandlers=[],this.mutationCb=t.mutationCb,this.scrollCb=t.scrollCb,this.bypassOptions=t.bypassOptions,this.mirror=t.mirror,this.init()}init(){this.reset(),this.patchAttachShadow(Element,document)}addShadowRoot(t,e){if(!lu(t))return;if(this.shadowDoms.has(t))return;this.shadowDoms.add(t),this.bypassOptions.canvasManager.addShadowRoot(t);const i=$l({...this.bypassOptions,doc:e,mutationCb:this.mutationCb,mirror:this.mirror,shadowDomManager:this},t);this.restoreHandlers.push(()=>i.disconnect()),this.restoreHandlers.push(zl({...this.bypassOptions,scrollCb:this.scrollCb,doc:t,mirror:this.mirror})),bl(()=>{t.adoptedStyleSheets&&t.adoptedStyleSheets.length>0&&this.bypassOptions.stylesheetManager.adoptStyleSheets(t.adoptedStyleSheets,this.mirror.getId(t.host)),this.restoreHandlers.push(Ul({mirror:this.mirror,stylesheetManager:this.bypassOptions.stylesheetManager},t))},0)}observeAttachShadow(t){const e=xl(t),i=function(t){try{return t.contentWindow}catch(t){}}(t);e&&i&&this.patchAttachShadow(i.Element,e)}patchAttachShadow(t,e){const i=this;this.restoreHandlers.push(tl(t.prototype,"attachShadow",function(t){return function(s){const n=t.call(this,s);return this.shadowRoot&&ml(this)&&i.addShadowRoot(this.shadowRoot,e),n}}))}reset(){this.restoreHandlers.forEach(t=>{try{t()}catch(t){}}),this.restoreHandlers=[],this.shadowDoms=new WeakSet,this.bypassOptions.canvasManager.resetShadowRoots()}}for(var Zl="undefined"==typeof Uint8Array?[]:new Uint8Array(256),td=0;td<64;td++)Zl["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(td)]=td;class ed{reset(){}freeze(){}unfreeze(){}lock(){}unlock(){}snapshot(){}addWindow(){}addShadowRoot(){}resetShadowRoots(){}}class id{constructor(t){this.trackedLinkElements=new WeakSet,this.styleMirror=new pl,this.mutationCb=t.mutationCb,this.adoptedStyleSheetCb=t.adoptedStyleSheetCb}attachLinkElement(t,e){"ve"in e.attributes&&this.mutationCb({adds:[],removes:[],texts:[],attributes:[{id:e.id,attributes:e.attributes}]}),this.trackLinkElement(t)}trackLinkElement(t){this.trackedLinkElements.has(t)||(this.trackedLinkElements.add(t),this.trackStylesheetInLinkElement(t))}adoptStyleSheets(t,e){if(0===t.length)return;const i={id:e,styleIds:[]},s=[];for(const e of t){let t;this.styleMirror.has(e)?t=this.styleMirror.getId(e):(t=this.styleMirror.add(e),s.push({styleId:t,rules:Array.from(e.rules||CSSRule,(t,e)=>({rule:pu(t),index:e}))})),i.styleIds.push(t)}s.length>0&&(i.styles=s),this.adoptedStyleSheetCb(i)}reset(){this.styleMirror.reset(),this.trackedLinkElements=new WeakSet}trackStylesheetInLinkElement(t){}}class sd{constructor(){this.nodeMap=new WeakMap,this.active=!1}inOtherBuffer(t,e){const i=this.nodeMap.get(t);return i&&Array.from(i).some(t=>t!==e)}add(t,e){this.active||(this.active=!0,function(...t){yl("requestAnimationFrame")(...t)}(()=>{this.nodeMap=new WeakMap,this.active=!1})),this.nodeMap.set(t,(this.nodeMap.get(t)||new Set).add(e))}destroy(){}}let nd,rd;try{if(2!==Array.from([1],t=>2*t)[0]){const t=document.createElement("iframe");document.body.appendChild(t),Array.from=t.contentWindow?.Array.from||Array.from,document.body.removeChild(t)}}catch(t){}const od=new fu;function ad(t={}){const{emit:e,checkoutEveryNms:i,checkoutEveryNth:s,blockClass:n="rr-block",blockSelector:r=null,unblockSelector:o=null,ignoreClass:a="rr-ignore",ignoreSelector:h=null,maskAllText:c=!1,maskTextClass:u="rr-mask",unmaskTextClass:l=null,maskTextSelector:d=null,unmaskTextSelector:p=null,inlineStylesheet:f=!0,maskAllInputs:m,maskInputOptions:g,slimDOMOptions:y,maskAttributeFn:b,maskInputFn:v,maskTextFn:w,maxCanvasSize:M=null,packFn:S,sampling:k={},dataURLOptions:x={},mousemoveWait:T,recordDOM:E=!0,recordCanvas:C=!1,recordCrossOriginIframes:A=!1,recordAfter:I=("DOMContentLoaded"===t.recordAfter?t.recordAfter:"load"),userTriggeredOnInput:F=!1,collectFonts:_=!1,inlineImages:R=!1,plugins:P,keepIframeSrcFn:O=()=>!1,ignoreCSSAttributes:B=new Set([]),errorHandler:D,onMutation:$,getCanvasManager:z}=t;Pl=D;const q=!A||window.parent===window;let j=!1;if(!q)try{window.parent.document&&(j=!1)}catch(t){j=!0}if(q&&!e)throw new Error("emit function is required");if(!q&&!j)return()=>{};void 0!==T&&void 0===k.mousemove&&(k.mousemove=T),od.reset();const L=!0===m?{color:!0,date:!0,"datetime-local":!0,email:!0,month:!0,number:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0,textarea:!0,select:!0,radio:!0,checkbox:!0}:void 0!==g?g:{},N=!0===y||"all"===y?{script:!0,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaVerification:!0,headMetaAuthorship:"all"===y,headMetaDescKeywords:"all"===y}:y||{};let G;!function(t=window){"NodeList"in t&&!t.NodeList.prototype.forEach&&(t.NodeList.prototype.forEach=[].forEach),"DOMTokenList"in t&&!t.DOMTokenList.prototype.forEach&&(t.DOMTokenList.prototype.forEach=[].forEach),Node.prototype.contains||(Node.prototype.contains=(...t)=>{let e=t[0];if(!(0 in t))throw new TypeError("1 argument is required");do{if(this===e)return!0}while(e=e&&e.parentNode);return!1})}();let U=0;const W=t=>{for(const e of P||[])e.eventProcessor&&(t=e.eventProcessor(t));return S&&!j&&(t=S(t)),t};nd=(t,n)=>{const r=t;if(r.timestamp=el(),!Bl[0]?.isFrozen()||r.type===vl.FullSnapshot||r.type===vl.IncrementalSnapshot&&r.data.source===wl.Mutation||Bl.forEach(t=>t.unfreeze()),q)e?.(W(r),n);else if(j){const t={type:"rrweb",event:W(r),origin:window.location.origin,isCheckout:n};window.parent.postMessage(t,"*")}if(r.type===vl.FullSnapshot)G=r,U=0;else if(r.type===vl.IncrementalSnapshot){if(r.data.source===wl.Mutation&&r.data.isAttachIframe)return;U++;const t=s&&U>=s,e=i&&G&&r.timestamp-G.timestamp>i;(t||e)&&tt(!0)}};const H=t=>{nd({type:vl.IncrementalSnapshot,data:{source:wl.Mutation,...t}})},V=t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.Scroll,...t}}),Y=t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.CanvasMutation,...t}}),X=new id({mutationCb:H,adoptedStyleSheetCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.AdoptedStyleSheet,...t}})}),J="boolean"==typeof __RRWEB_EXCLUDE_IFRAME__&&__RRWEB_EXCLUDE_IFRAME__?new Xl:new Jl({mirror:od,mutationCb:H,stylesheetManager:X,recordCrossOriginIframes:A,wrappedEmit:nd});for(const t of P||[])t.getMirror&&t.getMirror({nodeMirror:od,crossOriginIframeMirror:J.crossOriginIframeMirror,crossOriginIframeStyleMirror:J.crossOriginIframeStyleMirror});const K=new sd,Q=function(t,e){try{return t?t(e):new ed}catch{return new ed}}(z,{mirror:od,win:window,mutationCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.CanvasMutation,...t}}),recordCanvas:C,blockClass:n,blockSelector:r,unblockSelector:o,maxCanvasSize:M,sampling:k.canvas,dataURLOptions:x,errorHandler:D}),Z="boolean"==typeof __RRWEB_EXCLUDE_SHADOW_DOM__&&__RRWEB_EXCLUDE_SHADOW_DOM__?new Kl:new Ql({mutationCb:H,scrollCb:V,bypassOptions:{onMutation:$,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:c,maskTextClass:u,unmaskTextClass:l,maskTextSelector:d,unmaskTextSelector:p,inlineStylesheet:f,maskInputOptions:L,dataURLOptions:x,maskAttributeFn:b,maskTextFn:w,maskInputFn:v,recordCanvas:C,inlineImages:R,sampling:k,slimDOMOptions:N,iframeManager:J,stylesheetManager:X,canvasManager:Q,keepIframeSrcFn:O,processedNodeManager:K},mirror:od}),tt=(t=!1)=>{if(!E)return;nd({type:vl.Meta,data:{href:window.location.href,width:nl(),height:sl()}},t),X.reset(),Z.init(),Bl.forEach(t=>t.lock());const e=function(t,e){const{mirror:i=new fu,blockClass:s="rr-block",blockSelector:n=null,unblockSelector:r=null,maskAllText:o=!1,maskTextClass:a="rr-mask",unmaskTextClass:h=null,maskTextSelector:c=null,unmaskTextSelector:u=null,inlineStylesheet:l=!0,inlineImages:d=!1,recordCanvas:p=!1,maskAllInputs:f=!1,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOM:b=!1,dataURLOptions:v,preserveWhiteSpace:w,onSerialize:M,onIframeLoad:S,iframeLoadTimeout:k,onBlockedImageLoad:x,onStylesheetLoad:T,stylesheetLoadTimeout:E,keepIframeSrcFn:C=()=>!1}=e||{};return Xu(t,{doc:t,mirror:i,blockClass:s,blockSelector:n,unblockSelector:r,maskAllText:o,maskTextClass:a,unmaskTextClass:h,maskTextSelector:c,unmaskTextSelector:u,skipChild:!1,inlineStylesheet:l,maskInputOptions:!0===f?{color:!0,date:!0,"datetime-local":!0,email:!0,month:!0,number:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0,textarea:!0,select:!0}:!1===f?{}:f,maskAttributeFn:m,maskTextFn:g,maskInputFn:y,slimDOMOptions:!0===b||"all"===b?{script:!0,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:"all"===b,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0}:!1===b?{}:b,dataURLOptions:v,inlineImages:d,recordCanvas:p,preserveWhiteSpace:w,onSerialize:M,onIframeLoad:S,iframeLoadTimeout:k,onBlockedImageLoad:x,onStylesheetLoad:T,stylesheetLoadTimeout:E,keepIframeSrcFn:C,newlyAddedElement:!1})}(document,{mirror:od,blockClass:n,blockSelector:r,unblockSelector:o,maskAllText:c,maskTextClass:u,unmaskTextClass:l,maskTextSelector:d,unmaskTextSelector:p,inlineStylesheet:f,maskAllInputs:L,maskAttributeFn:b,maskInputFn:v,maskTextFn:w,slimDOM:N,dataURLOptions:x,recordCanvas:C,inlineImages:R,onSerialize:t=>{ul(t,od)&&J.addIframe(t),ll(t,od)&&X.trackLinkElement(t),dl(t)&&Z.addShadowRoot(t.shadowRoot,document)},onIframeLoad:(t,e)=>{J.attachIframe(t,e),t.contentWindow&&Q.addWindow(t.contentWindow),Z.observeAttachShadow(t)},onStylesheetLoad:(t,e)=>{X.attachLinkElement(t,e)},onBlockedImageLoad:(t,e,{width:i,height:s})=>{H({adds:[],removes:[],texts:[],attributes:[{id:e.id,attributes:{style:{width:`${i}px`,height:`${s}px`}}}]})},keepIframeSrcFn:O});e&&(nd({type:vl.FullSnapshot,data:{node:e,initialOffset:il(window)}}),Bl.forEach(t=>t.unlock()),document.adoptedStyleSheets&&document.adoptedStyleSheets.length>0&&X.adoptStyleSheets(document.adoptedStyleSheets,od.getId(document)))};rd=tt;try{const t=[],e=t=>Ol(Wl)({onMutation:$,mutationCb:H,mousemoveCb:(t,e)=>nd({type:vl.IncrementalSnapshot,data:{source:e,positions:t}}),mouseInteractionCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.MouseInteraction,...t}}),scrollCb:V,viewportResizeCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.ViewportResize,...t}}),inputCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.Input,...t}}),mediaInteractionCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.MediaInteraction,...t}}),styleSheetRuleCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.StyleSheetRule,...t}}),styleDeclarationCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.StyleDeclaration,...t}}),canvasMutationCb:Y,fontCb:t=>nd({type:vl.IncrementalSnapshot,data:{source:wl.Font,...t}}),selectionCb:t=>{nd({type:vl.IncrementalSnapshot,data:{source:wl.Selection,...t}})},customElementCb:t=>{nd({type:vl.IncrementalSnapshot,data:{source:wl.CustomElement,...t}})},blockClass:n,ignoreClass:a,ignoreSelector:h,maskAllText:c,maskTextClass:u,unmaskTextClass:l,maskTextSelector:d,unmaskTextSelector:p,maskInputOptions:L,inlineStylesheet:f,sampling:k,recordDOM:E,recordCanvas:C,inlineImages:R,userTriggeredOnInput:F,collectFonts:_,doc:t,maskAttributeFn:b,maskInputFn:v,maskTextFn:w,keepIframeSrcFn:O,blockSelector:r,unblockSelector:o,slimDOMOptions:N,dataURLOptions:x,mirror:od,iframeManager:J,stylesheetManager:X,shadowDomManager:Z,processedNodeManager:K,canvasManager:Q,ignoreCSSAttributes:B,plugins:P?.filter(t=>t.observer)?.map(t=>({observer:t.observer,options:t.options,callback:e=>nd({type:vl.Plugin,data:{plugin:t.name,payload:e}})}))||[]},{});J.addLoadListener(i=>{try{t.push(e(i.contentDocument))}catch(t){}});const i=()=>{tt(),t.push(e(document))};return"interactive"===document.readyState||"complete"===document.readyState?i():(t.push(Ju("DOMContentLoaded",()=>{nd({type:vl.DomContentLoaded,data:{}}),"DOMContentLoaded"===I&&i()})),t.push(Ju("load",()=>{nd({type:vl.Load,data:{}}),"load"===I&&i()},window))),()=>{t.forEach(t=>t()),K.destroy(),rd=void 0,Pl=void 0}}catch(t){}}var hd,cd;function ud(t){return t>9999999999?t:1e3*t}function ld(t){return t>9999999999?t/1e3:t}function dd(t,e){"sentry.transaction"!==e.category&&(["ui.click","ui.input"].includes(e.category)?t.triggerUserActivity():t.checkAndHandleExpiredSession(),t.addUpdate(()=>(t.throttledAddEvent({type:vl.Custom,timestamp:1e3*(e.timestamp||0),data:{tag:"breadcrumb",payload:Ir(e,10,1e3)}}),"console"===e.category)))}function pd(t){return t.closest("button,a")||t}function fd(t){const e=md(t);return e&&e instanceof Element?pd(e):e}function md(t){return function(t){return"object"==typeof t&&!!t&&"target"in t}(t)?t.target:t}let gd;ad.mirror=od,ad.takeFullSnapshot=function(t){if(!rd)throw new Error("please take full snapshot after start recording");rd(t)},(cd=hd||(hd={}))[cd.NotStarted=0]="NotStarted",cd[cd.Running=1]="Running",cd[cd.Stopped=2]="Stopped";const yd=new Set([wl.Mutation,wl.StyleSheetRule,wl.StyleDeclaration,wl.AdoptedStyleSheet,wl.CanvasMutation,wl.Selection,wl.MediaInteraction]);class bd{constructor(t,e,i=dd){this.xe=0,this.Te=0,this.Ee=[],this.Ce=e.timeout/1e3,this.Ae=e.threshold/1e3,this.Ie=e.scrollTimeout/1e3,this.Fe=t,this._e=e.ignoreSelector,this.Re=i}addListeners(){const t=(e=()=>{this.xe=wd()},gd||(gd=[],qs(eu,"open",function(t){return function(...e){if(gd)try{gd.forEach(t=>t())}catch{}return t.apply(eu,e)}})),gd.push(e),()=>{const t=gd?gd.indexOf(e):-1;t>-1&&gd.splice(t,1)});var e;this.Pe=()=>{t(),this.Ee=[],this.xe=0,this.Te=0}}removeListeners(){this.Pe&&this.Pe(),this.Oe&&clearTimeout(this.Oe)}handleClick(t,e){if(function(t,e){return!vd.includes(t.tagName)||"INPUT"===t.tagName&&!["submit","button"].includes(t.getAttribute("type")||"")||!("A"!==t.tagName||!(t.hasAttribute("download")||t.hasAttribute("target")&&"_self"!==t.getAttribute("target")))||!(!e||!t.matches(e))}(e,this._e)||!function(t){return!(!t.data||"number"!=typeof t.data.nodeId||!t.timestamp)}(t))return;const i={timestamp:ld(t.timestamp),clickBreadcrumb:t,clickCount:0,node:e};this.Ee.some(t=>t.node===i.node&&Math.abs(t.timestamp-i.timestamp)<1)||(this.Ee.push(i),1===this.Ee.length&&this.Be())}registerMutation(t=Date.now()){this.xe=ld(t)}registerScroll(t=Date.now()){this.Te=ld(t)}registerClick(t){const e=pd(t);this.De(e)}De(t){this.$e(t).forEach(t=>{t.clickCount++})}$e(t){return this.Ee.filter(e=>e.node===t)}ze(){const t=[],e=wd();this.Ee.forEach(i=>{!i.mutationAfter&&this.xe&&(i.mutationAfter=i.timestamp<=this.xe?this.xe-i.timestamp:void 0),!i.scrollAfter&&this.Te&&(i.scrollAfter=i.timestamp<=this.Te?this.Te-i.timestamp:void 0),i.timestamp+this.Ce<=e&&t.push(i)});for(const e of t){const t=this.Ee.indexOf(e);t>-1&&(this.qe(e),this.Ee.splice(t,1))}this.Ee.length&&this.Be()}qe(t){const e=this.Fe,i=t.scrollAfter&&t.scrollAfter<=this.Ie,s=t.mutationAfter&&t.mutationAfter<=this.Ae,n=!i&&!s,{clickCount:r,clickBreadcrumb:o}=t;if(n){const i=1e3*Math.min(t.mutationAfter||this.Ce,this.Ce),s=i<1e3*this.Ce?"mutation":"timeout",n={type:"default",message:o.message,timestamp:o.timestamp,category:"ui.slowClickDetected",data:{...o.data,url:eu.location.href,route:e.getCurrentRoute(),timeAfterClickMs:i,endReason:s,clickCount:r||1}};return void this.Re(e,n)}if(r>1){const t={type:"default",message:o.message,timestamp:o.timestamp,category:"ui.multiClick",data:{...o.data,url:eu.location.href,route:e.getCurrentRoute(),clickCount:r,metric:!0}};this.Re(e,t)}}Be(){this.Oe&&clearTimeout(this.Oe),this.Oe=Sc(()=>this.ze(),1e3)}}const vd=["A","BUTTON","INPUT"];function wd(){return Date.now()/1e3}function Md(t){return{timestamp:Date.now()/1e3,type:"default",...t}}var Sd=(t=>(t[t.Document=0]="Document",t[t.DocumentType=1]="DocumentType",t[t.Element=2]="Element",t[t.Text=3]="Text",t[t.CDATA=4]="CDATA",t[t.Comment=5]="Comment",t))(Sd||{});const kd=new Set(["id","class","aria-label","role","name","alt","title","data-test-id","data-testid","disabled","aria-disabled","data-sentry-component"]);function xd(t){const e={};!t["data-sentry-component"]&&t["data-sentry-element"]&&(t["data-sentry-component"]=t["data-sentry-element"]);for(const i in t)if(kd.has(i)){let s=i;"data-testid"!==i&&"data-test-id"!==i||(s="testId"),e[s]=t[i]}return e}function Td(t,e){const i=ad.mirror.getId(t),s=i&&ad.mirror.getNode(i),n=s&&ad.mirror.getMeta(s),r=n&&function(t){return t.type===Sd.Element}(n)?n:null;return{message:e,data:r?{nodeId:i,node:{id:i,tagName:r.tagName,textContent:Array.from(r.childNodes).map(t=>t.type===Sd.Text&&t.textContent).filter(Boolean).map(t=>t.trim()).join(""),attributes:xd(r.attributes)}}:{}}}const Ed={resource:function(t){const{entryType:e,initiatorType:i,name:s,responseEnd:n,startTime:r,decodedBodySize:o,encodedBodySize:a,responseStatus:h,transferSize:c}=t;return["fetch","xmlhttprequest"].includes(i)?null:{type:`${e}.${i}`,start:Id(r),end:Id(n),name:s,data:{size:c,statusCode:h,decodedBodySize:o,encodedBodySize:a}}},paint:function(t){const{duration:e,entryType:i,name:s,startTime:n}=t,r=Id(n);return{type:i,name:s,start:r,end:r+e,data:void 0}},navigation:function(t){const{entryType:e,name:i,decodedBodySize:s,duration:n,domComplete:r,encodedBodySize:o,domContentLoadedEventStart:a,domContentLoadedEventEnd:h,domInteractive:c,loadEventStart:u,loadEventEnd:l,redirectCount:d,startTime:p,transferSize:f,type:m}=t;return 0===n?null:{type:`${e}.${m}`,start:Id(p),end:Id(r),name:i,data:{size:f,decodedBodySize:s,encodedBodySize:o,duration:n,domInteractive:c,domContentLoadedEventStart:a,domContentLoadedEventEnd:h,loadEventStart:u,loadEventEnd:l,domComplete:r,redirectCount:d}}}};function Cd(t,e){return({metric:i})=>{e.replayPerformanceEntries.push(t(i))}}function Ad(t){const e=Ed[t.entryType];return e?e(t):null}function Id(t){return((nn()||eu.performance.timeOrigin)+t)/1e3}function Fd(t){const e=t.entries[t.entries.length-1];return Od(t,"largest-contentful-paint",e?.element?[e.element]:void 0)}function _d(t){return void 0!==t.sources}function Rd(t){const e=[],i=[];for(const s of t.entries)if(_d(s)){const t=[];for(const e of s.sources)if(e.node){i.push(e.node);const s=ad.mirror.getId(e.node);s&&t.push(s)}e.push({value:s.value,nodeIds:t.length?t:void 0})}return Od(t,"cumulative-layout-shift",i,e)}function Pd(t){const e=t.entries[t.entries.length-1];return Od(t,"interaction-to-next-paint",e?.target?[e.target]:void 0)}function Od(t,e,i,s){const n=t.value,r=t.rating,o=Id(n);return{type:"web-vital",name:e,start:o,end:o,data:{value:n,size:n,rating:r,nodeIds:i?i.map(t=>ad.mirror.getId(t)):void 0,attributions:s}}}const Bd="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,Dd=["log","warn","error"],$d="[Replay] ";function zd(t,e="info"){ra({category:"console",data:{logger:"replay"},level:e,message:`${$d}${t}`},{level:e})}const qd=function(){let t=!1,e=!1;const i={exception:()=>{},infoTick:()=>{},setConfig:i=>{t=!!i.captureExceptions,e=!!i.traceInternals}};return Bd?(Dd.forEach(t=>{i[t]=(...i)=>{Ji[t]($d,...i),e&&zd(i.join(""),va(t))}}),i.exception=(s,...n)=>{n.length&&i.error&&i.error(...n),Ji.error($d,s),t?yo(s,{mechanism:{handled:!0,type:"auto.function.replay.debug"}}):e&&zd(s,"error")},i.infoTick=(...t)=>{Ji.log($d,...t),e&&setTimeout(()=>zd(t[0]),0)}):Dd.forEach(t=>{i[t]=()=>{}}),i}();class jd extends Error{constructor(){super("Event buffer exceeded maximum size of 20000000.")}}class Ld{constructor(){this.events=[],this.je=0,this.hasCheckout=!1,this.waitForCheckout=!1}get hasEvents(){return this.events.length>0}get type(){return"sync"}destroy(){this.events=[]}async addEvent(t){const e=JSON.stringify(t).length;if(this.je+=e,this.je>ou)throw new jd;this.events.push(t)}finish(){return new Promise(t=>{const e=this.events;this.clear(),t(JSON.stringify(e))})}clear(){this.events=[],this.je=0,this.hasCheckout=!1}getEarliestTimestamp(){const t=this.events.map(t=>t.timestamp).sort()[0];return t?ud(t):null}}class Nd{constructor(t){this.Le=t,this.Ne=0}ensureReady(){return this.Ge||(this.Ge=new Promise((t,e)=>{this.Le.addEventListener("message",({data:i})=>{i.success?t():e()},{once:!0}),this.Le.addEventListener("error",t=>{e(t)},{once:!0})})),this.Ge}destroy(){Bd&&qd.log("Destroying compression worker"),this.Le.terminate()}postMessage(t,e){const i=this.Ue();return new Promise((s,n)=>{const r=({data:e})=>{const o=e;if(o.method===t&&o.id===i){if(this.Le.removeEventListener("message",r),!o.success)return Bd&&qd.error("Error in compression worker: ",o.response),void n(new Error("Error in compression worker"));s(o.response)}};this.Le.addEventListener("message",r),this.Le.postMessage({id:i,method:t,arg:e})})}Ue(){return this.Ne++}}class Gd{constructor(t){this.Le=new Nd(t),this.We=null,this.je=0,this.hasCheckout=!1,this.waitForCheckout=!1}get hasEvents(){return!!this.We}get type(){return"worker"}ensureReady(){return this.Le.ensureReady()}destroy(){this.Le.destroy()}addEvent(t){const e=ud(t.timestamp);(!this.We||e<this.We)&&(this.We=e);const i=JSON.stringify(t);return this.je+=i.length,this.je>ou?Promise.reject(new jd):this.He(i)}finish(){return this.Ve()}clear(){this.We=null,this.je=0,this.hasCheckout=!1,this.Le.postMessage("clear").then(null,t=>{Bd&&qd.exception(t,'Sending "clear" message to worker failed',t)})}getEarliestTimestamp(){return this.We}He(t){return this.Le.postMessage("addEvent",t)}async Ve(){const t=await this.Le.postMessage("finish");return this.We=null,this.je=0,t}}class Ud{constructor(t){this.Ye=new Ld,this.Xe=new Gd(t),this.Je=this.Ye,this.Ke=this.Qe()}get waitForCheckout(){return this.Je.waitForCheckout}get type(){return this.Je.type}get hasEvents(){return this.Je.hasEvents}get hasCheckout(){return this.Je.hasCheckout}set hasCheckout(t){this.Je.hasCheckout=t}set waitForCheckout(t){this.Je.waitForCheckout=t}destroy(){this.Ye.destroy(),this.Xe.destroy()}clear(){return this.Je.clear()}getEarliestTimestamp(){return this.Je.getEarliestTimestamp()}addEvent(t){return this.Je.addEvent(t)}async finish(){return await this.ensureWorkerIsLoaded(),this.Je.finish()}ensureWorkerIsLoaded(){return this.Ke}async Qe(){try{await this.Xe.ensureReady()}catch(t){return void(Bd&&qd.exception(t,"Failed to load the compression worker, falling back to simple buffer"))}await this.Ze()}async Ze(){const{events:t,hasCheckout:e,waitForCheckout:i}=this.Ye,s=[];for(const e of t)s.push(this.Xe.addEvent(e));this.Xe.hasCheckout=e,this.Xe.waitForCheckout=i,this.Je=this.Xe;try{await Promise.all(s),this.Ye.clear()}catch(t){Bd&&qd.exception(t,"Failed to add events when switching buffers.")}}}function Wd(){try{return"sessionStorage"in eu&&!!eu.sessionStorage}catch{return!1}}function Hd(t){return void 0!==t&&Math.random()<t}function Vd(t){if(Wd())try{eu.sessionStorage.setItem(iu,JSON.stringify(t))}catch{}}function Yd(t){const e=Date.now();return{id:t.id||Xs(),started:t.started||e,lastActivity:t.lastActivity||e,segmentId:t.segmentId||0,sampled:t.sampled,previousSessionId:t.previousSessionId}}function Xd({sessionSampleRate:t,allowBuffering:e,stickySession:i=!1},{previousSessionId:s}={}){const n=function(t,e){return Hd(t)?"session":!!e&&"buffer"}(t,e),r=Yd({sampled:n,previousSessionId:s});return i&&Vd(r),r}function Jd(t,e,i=+new Date){return null===t||void 0===e||e<0||0!==e&&t+e<=i}function Kd(t,{maxReplayDuration:e,sessionIdleExpire:i,targetTime:s=Date.now()}){return Jd(t.started,e,s)||Jd(t.lastActivity,i,s)}function Qd(t,{sessionIdleExpire:e,maxReplayDuration:i}){return!!Kd(t,{sessionIdleExpire:e,maxReplayDuration:i})&&("buffer"!==t.sampled||0!==t.segmentId)}function Zd({sessionIdleExpire:t,maxReplayDuration:e,previousSessionId:i},s){const n=s.stickySession&&function(){if(!Wd())return null;try{const t=eu.sessionStorage.getItem(iu);if(!t)return null;const e=JSON.parse(t);return Bd&&qd.infoTick("Loading existing session"),Yd(e)}catch{return null}}();return n?Qd(n,{sessionIdleExpire:t,maxReplayDuration:e})?(Bd&&qd.infoTick("Session in sessionStorage is expired, creating new one..."),Xd(s,{previousSessionId:n.id})):n:(Bd&&qd.infoTick("Creating new session"),Xd(s,{previousSessionId:i}))}function tp(t,e,i){return!!ip(t,e)&&(ep(t,e,i),!0)}async function ep(t,e,i){const{eventBuffer:s}=t;if(!s||s.waitForCheckout&&!i)return null;const n="buffer"===t.recordingMode;try{i&&n&&s.clear(),i&&(s.hasCheckout=!0,s.waitForCheckout=!1);const r=function(t,e){try{if("function"==typeof e&&function(t){return t.type===vl.Custom}(t))return e(t)}catch(t){return Bd&&qd.exception(t,"An error occurred in the `beforeAddRecordingEvent` callback, skipping the event..."),null}return t}(e,t.getOptions().beforeAddRecordingEvent);if(!r)return;return await s.addEvent(r)}catch(e){const i=e&&e instanceof jd,r=i?"addEventSizeExceeded":"addEvent",o=Sn();if(o){const t=i?"buffer_overflow":"internal_sdk_error";o.recordDroppedEvent(t,"replay")}if(i&&n)return s.clear(),s.waitForCheckout=!0,null;t.handleException(e),await t.stop({reason:r})}}function ip(t,e){if(!t.eventBuffer||t.isPaused()||!t.isEnabled())return!1;const i=ud(e.timestamp);return!(i+t.timeouts.sessionIdlePause<Date.now()||i>t.getContext().initialTimestamp+t.getOptions().maxReplayDuration&&(Bd&&qd.infoTick(`Skipping event with timestamp ${i} because it is after maxReplayDuration`),1))}function sp(t){return!t.type}function np(t){return"transaction"===t.type}function rp(t){return"feedback"===t.type}function op(t){return!!t.category}function ap(){const t=vn().getPropagationContext().dsc;t&&delete t.replay_id;const e=fr();e&&delete Cr(e).replay_id}function hp(t,e){return e.map(({type:e,start:i,end:s,name:n,data:r})=>{const o=t.throttledAddEvent({type:vl.Custom,timestamp:i,data:{tag:"performanceSpan",payload:{op:e,description:n,startTimestamp:i,endTimestamp:s,data:r}}});return"string"==typeof o?Promise.resolve(null):o})}function cp(t,e){t.isEnabled()&&null!==e&&(function(t,e){return(!Bd||!t.getOptions().Nt.traceInternals)&&function(t,e){const i=e?.getDsn(),s=e?.getOptions().tunnel;return function(t,e){const i=Qo(t);return!(!i||Ko(i))&&!!e&&i.host.includes(e.host)&&/(^|&|\?)sentry_key=/.test(i.search)}(t,i)||function(t,e){return!!e&&ea(t)===ea(e)}(t,s)}(e,Sn())}(t,e.name)||t.addUpdate(()=>(hp(t,[e]),!0)))}function up(t){if(!t)return;const e=new TextEncoder;try{if("string"==typeof t)return e.encode(t).length;if(t instanceof URLSearchParams)return e.encode(t.toString()).length;if(t instanceof FormData){const i=Ec(t);return e.encode(i).length}if(t instanceof Blob)return t.size;if(t instanceof ArrayBuffer)return t.byteLength}catch{}}function lp(t){if(!t)return;const e=parseInt(t,10);return isNaN(e)?void 0:e}function dp(t,e){if(!t)return{headers:{},size:void 0,ti:{warnings:[e]}};const i={...t.ti},s=i.warnings||[];return i.warnings=[...s,e],t.ti=i,t}function pp(t,e){if(!e)return null;const{startTimestamp:i,endTimestamp:s,url:n,method:r,statusCode:o,request:a,response:h}=e;return{type:t,start:i/1e3,end:s/1e3,name:n,data:{method:r,statusCode:o,request:a,response:h}}}function fp(t){return{headers:{},size:t,ti:{warnings:["URL_SKIPPED"]}}}function mp(t,e,i){if(!e&&0===Object.keys(t).length)return;if(!e)return{headers:t};if(!i)return{headers:t,size:e};const s={headers:t,size:e},{body:n,warnings:r}=function(t){if(!t||"string"!=typeof t)return{body:t};const e=t.length>nu,i=function(t){const e=t[0],i=t[t.length-1];return"["===e&&"]"===i||"{"===e&&"}"===i}(t);if(e){const e=t.slice(0,nu);return i?{body:e,warnings:["MAYBE_JSON_TRUNCATED"]}:{body:`${e}…`,warnings:["TEXT_TRUNCATED"]}}if(i)try{return{body:JSON.parse(t)}}catch{}return{body:t}}(i);return s.body=n,r?.length&&(s.ti={warnings:r}),s}function gp(t,e){return Object.entries(t).reduce((i,[s,n])=>{const r=s.toLowerCase();return e.includes(r)&&t[s]&&(i[r]=n),i},{})}function yp(t,e){const i=function(t,e=eu.document.baseURI){if(t.startsWith("http://")||t.startsWith("https://")||t.startsWith(eu.location.origin))return t;const i=new URL(t,e);if(i.origin!==new URL(e).origin)return t;const s=i.href;return!t.endsWith("/")&&s.endsWith("/")?s.slice(0,-1):s}(t);return zs(i,e)}function bp(t,e){const i={};return e.forEach(e=>{t.get(e)&&(i[e]=t.get(e))}),i}function vp(t,e){if(!t)return{};const i=t.headers;return i?i instanceof Headers?bp(i,e):Array.isArray(i)?{}:gp(i,e):{}}function wp(t){const e=Sn();mc((t=>e=>{if(!t.isEnabled())return;const i=function(t){const{target:e,message:i}=function(t){const e="click"===t.name;let i,s=null;try{s=e?fd(t.event):md(t.event),i=_s(s,{maxStringLength:200})||"<unknown>"}catch{i="<unknown>"}return{target:s,message:i}}(t);return Md({category:`ui.${t.name}`,...Td(e,i)})}(e);if(!i)return;const s="click"===e.name,n=s?e.event:void 0;var r,o,a;!(s&&t.clickDetector&&n?.target)||n.altKey||n.metaKey||n.ctrlKey||n.shiftKey||(r=t.clickDetector,o=i,a=fd(e.event),r.handleClick(o,a)),dd(t,i)})(t)),bc(function(t){return e=>{if(!t.isEnabled())return;const i=function(t){const{from:e,to:i}=t,s=Date.now()/1e3;return{type:"navigation.push",start:s,end:s,name:i,data:{previous:e}}}(e);null!==i&&(t.getContext().urls.push(i.name),t.triggerUserActivity(),t.addUpdate(()=>(hp(t,[i]),!1)))}}(t)),function(t){const e=Sn();e&&e.on("beforeAddBreadcrumb",e=>function(t,e){if(!t.isEnabled()||!op(e))return;const i=function(t){return!op(t)||["fetch","xhr","sentry.event","sentry.transaction"].includes(t.category)||t.category.startsWith("ui.")?null:"console"===t.category?function(t){const e=t.data?.arguments;if(!Array.isArray(e)||0===e.length)return Md(t);let i=!1;const s=e.map(t=>{if(!t)return t;if("string"==typeof t)return t.length>ru?(i=!0,`${t.slice(0,ru)}…`):t;if("object"==typeof t)try{const e=Ir(t,7);return JSON.stringify(e).length>ru?(i=!0,`${JSON.stringify(e,null,2).slice(0,ru)}…`):e}catch{}return t});return Md({...t,data:{...t.data,arguments:s,...i?{ti:{warnings:["CONSOLE_ARG_TRUNCATED"]}}:{}}})}(t):Md(t)}(e);i&&dd(t,i)}(t,e))}(t),function(t){const e=Sn();try{const{networkDetailAllowUrls:i,networkDetailDenyUrls:s,networkCaptureBodies:n,networkRequestHeaders:r,networkResponseHeaders:o}=t.getOptions(),a={replay:t,networkDetailAllowUrls:i,networkDetailDenyUrls:s,networkCaptureBodies:n,networkRequestHeaders:r,networkResponseHeaders:o};e&&e.on("beforeAddBreadcrumb",(t,e)=>function(t,e,i){if(e.data)try{(function(t){return"xhr"===t.category})(e)&&function(t){return t?.xhr}(i)&&(function(t,e){const{xhr:i,input:s}=e;if(!i)return;const n=up(s),r=i.getResponseHeader("content-length")?lp(i.getResponseHeader("content-length")):function(t,e){try{return up("json"===e&&t&&"object"==typeof t?JSON.stringify(t):t)}catch{return}}(i.response,i.responseType);void 0!==n&&(t.data.request_body_size=n),void 0!==r&&(t.data.response_body_size=r)}(e,i),async function(t,e,i){try{const s=function(t,e,i){const s=Date.now(),{startTimestamp:n=s,endTimestamp:r=s,input:o,xhr:a}=e,{url:h,method:c,status_code:u=0,request_body_size:l,response_body_size:d}=t.data;if(!h)return null;if(!a||!yp(h,i.networkDetailAllowUrls)||yp(h,i.networkDetailDenyUrls))return{startTimestamp:n,endTimestamp:r,url:h,method:c,statusCode:u,request:fp(l),response:fp(d)};const p=a[kc],f=p?gp(p.request_headers,i.networkRequestHeaders):{},m=gp(Ic(a),i.networkResponseHeaders),[g,y]=i.networkCaptureBodies?Cc(o,qd):[void 0],[b,v]=i.networkCaptureBodies?function(t){const e=[];try{return[t.responseText]}catch(t){e.push(t)}try{return function(t,e){try{if("string"==typeof t)return[t];if(t instanceof Document)return[t.body.outerHTML];if("json"===e&&t&&"object"==typeof t)return[JSON.stringify(t)];if(!t)return[void 0]}catch(e){return Bd&&qd.exception(e,"Failed to serialize body",t),[void 0,"BODY_PARSE_ERROR"]}return Bd&&qd.log("Skipping network body because of body type",t),[void 0,"UNPARSEABLE_BODY_TYPE"]}(t.response,t.responseType)}catch(t){e.push(t)}return Bd&&qd.warn("Failed to get xhr response body",...e),[void 0]}(a):[void 0],w=mp(f,l,g),M=mp(m,d,b);return{startTimestamp:n,endTimestamp:r,url:h,method:c,statusCode:u,request:y?dp(w,y):w,response:v?dp(M,v):M}}(t,e,i),n=pp("resource.xhr",s);cp(i.replay,n)}catch(t){Bd&&qd.exception(t,"Failed to capture xhr breadcrumb")}}(e,i,t)),function(t){return"fetch"===t.category}(e)&&function(t){return t?.response}(i)&&(function(t,e){const{input:i,response:s}=e,n=up(i?Ac(i):void 0),r=s?lp(s.headers.get("content-length")):void 0;void 0!==n&&(t.data.request_body_size=n),void 0!==r&&(t.data.response_body_size=r)}(e,i),async function(t,e,i){try{const s=await async function(t,e,i){const s=Date.now(),{startTimestamp:n=s,endTimestamp:r=s}=e,{url:o,method:a,status_code:h=0,request_body_size:c,response_body_size:u}=t.data,l=yp(o,i.networkDetailAllowUrls)&&!yp(o,i.networkDetailDenyUrls),d=l?function({networkCaptureBodies:t,networkRequestHeaders:e},i,s){const n=i?(o=e,1===(r=i).length&&"string"!=typeof r[0]?vp(r[0],o):2===r.length?vp(r[1],o):{}):{};var r,o;if(!t)return mp(n,s,void 0);const a=Ac(i),[h,c]=Cc(a,qd),u=mp(n,s,h);return c?dp(u,c):u}(i,e.input,c):fp(c),p=await async function(t,{networkCaptureBodies:e,networkResponseHeaders:i},s,n){if(!t&&void 0!==n)return fp(n);const r=s?bp(s.headers,i):{};if(!s||!e&&void 0!==n)return mp(r,n,void 0);const[o,a]=await async function(t){const e=function(t){try{return t.clone()}catch(t){Bd&&qd.exception(t,"Failed to clone response body")}}(t);if(!e)return[void 0,"BODY_PARSE_ERROR"];try{const t=await function(t){return new Promise((e,i)=>{const s=Sc(()=>i(new Error("Timeout while trying to read response body")),500);(async function(t){return await t.text()})(t).then(t=>e(t),t=>i(t)).finally(()=>clearTimeout(s))})}(e);return[t]}catch(t){return t instanceof Error&&t.message.indexOf("Timeout")>-1?(Bd&&qd.warn("Parsing text body from response timed out"),[void 0,"BODY_PARSE_TIMEOUT"]):(Bd&&qd.exception(t,"Failed to get text body from response"),[void 0,"BODY_PARSE_ERROR"])}}(s),h=function(t,{networkCaptureBodies:e,responseBodySize:i,captureDetails:s,headers:n}){try{const r=t?.length&&void 0===i?up(t):i;return s?mp(n,r,e?t:void 0):fp(r)}catch(t){return Bd&&qd.exception(t,"Failed to serialize response body"),mp(n,i,void 0)}}(o,{networkCaptureBodies:e,responseBodySize:n,captureDetails:t,headers:r});return a?dp(h,a):h}(l,i,e.response,u);return{startTimestamp:n,endTimestamp:r,url:o,method:a,statusCode:h,request:d,response:p}}(t,e,i),n=pp("resource.fetch",s);cp(i.replay,n)}catch(t){Bd&&qd.exception(t,"Failed to capture fetch breadcrumb")}}(e,i,t))}catch(t){Bd&&qd.exception(t,"Error when enriching network breadcrumb")}}(a,t,e))}catch{}}(t);const i=function(t){return Object.assign((e,i)=>{if(!t.isEnabled()||t.isPaused())return e;if(function(t){return"replay_event"===t.type}(e))return delete e.breadcrumbs,e;if(!sp(e)&&!np(e)&&!rp(e))return e;if(!t.checkAndHandleExpiredSession())return ap(),e;if(rp(e))return t.flush(),e.contexts.feedback.replay_id=t.getSessionId(),function(t,e){t.triggerUserActivity(),t.addUpdate(()=>!e.timestamp||(t.throttledAddEvent({type:vl.Custom,timestamp:1e3*e.timestamp,data:{tag:"breadcrumb",payload:{timestamp:e.timestamp,type:"default",category:"sentry.feedback",data:{feedbackId:e.event_id}}}}),!1))}(t,e),e;if(function(t,e){return!(t.type||!t.exception?.values?.length||!e.originalException?.ei)}(e,i)&&!t.getOptions().Nt.captureExceptions)return Bd&&qd.log("Ignoring error from rrweb internals",e),null;const s=function(t,e){return"buffer"===t.recordingMode&&e.message!==su&&!(!e.exception||e.type)&&Hd(t.getOptions().errorSampleRate)}(t,e);return(s||"session"===t.recordingMode)&&(e.tags={...e.tags,replayId:t.getSessionId()}),e},{id:"Replay"})}(t);var s;s=i,wn().addEventProcessor(s),e&&(e.on("beforeSendEvent",function(t){return e=>{t.isEnabled()&&sp(e)&&function(t,e){const i=e.exception?.values?.[0]?.value;"string"==typeof i&&(i.match(/(reactjs\.org\/docs\/error-decoder\.html\?invariant=|react\.dev\/errors\/)(418|419|422|423|425)/)||i.match(/(does not match server-rendered HTML|Hydration failed because)/i))&&dd(t,Md({category:"replay.hydrate-error",data:{url:Ps()}}))}(t,e)}}(t)),e.on("afterSendEvent",function(t){return(e,i)=>{if(!t.isEnabled()||!sp(e)&&!np(e))return;const s=i.statusCode;!s||s<200||s>=300||(np(e)?function(t,e){const i=t.getContext();e.contexts?.trace?.trace_id&&i.traceIds.size<100&&i.traceIds.add(e.contexts.trace.trace_id)}(t,e):function(t,e){const i=t.getContext();if(e.event_id&&i.errorIds.size<100&&i.errorIds.add(e.event_id),"buffer"!==t.recordingMode||!e.tags||!e.tags.replayId)return;const{beforeErrorSampling:s}=t.getOptions();("function"!=typeof s||s(e))&&Sc(async()=>{try{await t.sendBufferedReplayOrFlush()}catch(e){t.handleException(e)}})}(t,e))}}(t)),e.on("createDsc",e=>{const i=t.getSessionId();i&&t.isEnabled()&&"session"===t.recordingMode&&t.checkAndHandleExpiredSession()&&(e.replay_id=i)}),e.on("spanStart",e=>{t.lastActiveSpan=e}),e.on("spanEnd",e=>{t.lastActiveSpan=e}),e.on("beforeSendFeedback",async(e,i)=>{const s=t.getSessionId();i?.includeReplay&&t.isEnabled()&&s&&e.contexts?.feedback&&("api"===e.contexts.feedback.source&&await t.sendBufferedReplayOrFlush(),e.contexts.feedback.replay_id=s)}),e.on("openFeedbackWidget",async()=>{await t.sendBufferedReplayOrFlush()}))}function Mp(t){const{jsHeapSizeLimit:e,totalJSHeapSize:i,usedJSHeapSize:s}=t,n=Date.now()/1e3;return{type:"memory",name:"memory",start:n,end:n,data:{memory:{jsHeapSizeLimit:e,totalJSHeapSize:i,usedJSHeapSize:s}}}}const Sp=qi.navigator;function kp(t){let e=!1;return(i,s)=>{if(!t.checkAndHandleExpiredSession())return void(Bd&&qd.warn("Received replay event after session expired."));const n=s||!e;e=!0,t.clickDetector&&function(t,e){try{if(!function(t){return 3===t.type}(e))return;const{source:i}=e.data;if(yd.has(i)&&t.registerMutation(e.timestamp),i===wl.Scroll&&t.registerScroll(e.timestamp),function(t){return t.data.source===wl.MouseInteraction}(e)){const{type:i,id:s}=e.data,n=ad.mirror.getNode(s);n instanceof HTMLElement&&i===Ml.Click&&t.registerClick(n)}}catch{}}(t.clickDetector,i),t.addUpdate(()=>{if("buffer"===t.recordingMode&&n&&t.setInitialState(),!tp(t,i,n))return!0;if(!n)return!1;const e=t.session;if(function(t,e){e&&t.session&&0===t.session.segmentId&&tp(t,function(t){const e=t.getOptions();return{type:vl.Custom,timestamp:Date.now(),data:{tag:"options",payload:{shouldRecordCanvas:t.isRecordingCanvas(),sessionSampleRate:e.sessionSampleRate,errorSampleRate:e.errorSampleRate,useCompressionOption:e.useCompression,blockAllMedia:e.blockAllMedia,maskAllText:e.maskAllText,maskAllInputs:e.maskAllInputs,useCompression:!!t.eventBuffer&&"worker"===t.eventBuffer.type,networkDetailHasUrls:e.networkDetailAllowUrls.length>0,networkCaptureBodies:e.networkCaptureBodies,networkRequestHasHeaders:e.networkRequestHeaders.length>0,networkResponseHasHeaders:e.networkResponseHeaders.length>0}}}}(t),!1)}(t,n),"buffer"===t.recordingMode&&e&&t.eventBuffer){const i=t.eventBuffer.getEarliestTimestamp();i&&(Bd&&qd.log(`Updating session start time to earliest event in buffer to ${new Date(i)}`),e.started=i,t.getOptions().stickySession&&Vd(e))}return e?.previousSessionId||"session"===t.recordingMode&&t.flush(),!0})}}class xp extends Error{constructor(t){super(`Transport returned status code ${t}`)}}class Tp extends Error{constructor(t){super("Rate limit hit"),this.rateLimits=t}}async function Ep(t,e={count:0,interval:5e3}){const{recordingData:i,onError:s}=t;var n;if(i.length)try{return await async function({recordingData:t,replayId:e,segmentId:i,eventContext:s,timestamp:n,session:r}){const o=function({recordingData:t,headers:e}){let i;const s=`${JSON.stringify(e)}\n`;if("string"==typeof t)i=`${s}${t}`;else{const e=(new TextEncoder).encode(s);i=new Uint8Array(e.length+t.length),i.set(e),i.set(t,e.length)}return i}({recordingData:t,headers:{segment_id:i}}),{urls:a,errorIds:h,traceIds:c,initialTimestamp:u}=s,l=Sn(),d=vn(),p=l?.getTransport(),f=l?.getDsn();if(!(l&&p&&f&&r.sampled))return Promise.resolve({});const m={type:"replay_event",replay_start_timestamp:u/1e3,timestamp:n/1e3,error_ids:h,trace_ids:c,urls:a,replay_id:e,segment_id:i,replay_type:r.sampled},g=await async function({client:t,scope:e,replayId:i,event:s}){const n={event_id:i,integrations:"object"!=typeof t.Dt||null===t.Dt||Array.isArray(t.Dt)?void 0:Object.keys(t.Dt)};t.emit("preprocessEvent",s,n);const r=await mo(t.getOptions(),s,n,e,t,wn());if(!r)return null;t.emit("postprocessEvent",r,n),r.platform=r.platform||"javascript";const o=t.getSdkMetadata(),{name:a,version:h,settings:c}=o?.sdk||{};return r.sdk={...r.sdk,name:a||"sentry.javascript.unknown",version:h||"0.0.0",settings:c},r}({scope:d,client:l,replayId:e,event:m});if(!g)return l.recordDroppedEvent("event_processor","replay"),Bd&&qd.log("An event processor returned `null`, will not send event."),Promise.resolve({});delete g.sdkProcessingMetadata;const y=function(t,e,i,s){return Rr(Nr(t,Lr(t),s,i),[[{type:"replay_event"},t],[{type:"replay_recording",length:"string"==typeof e?(new TextEncoder).encode(e).length:e.length},e]])}(g,o,f,l.getOptions().tunnel);let b;try{b=await p.send(y)}catch(t){const e=new Error(su);try{e.cause=t}catch{}throw e}if("number"==typeof b.statusCode&&(b.statusCode<200||b.statusCode>=300))throw new xp(b.statusCode);const v=Jo({},b);if(Xo(v,"replay"))throw new Tp(v);return b}(t),!0}catch(i){if(i instanceof xp||i instanceof Tp)throw i;if(n={ii:e.count},wn().setContext("Replays",n),s&&s(i),e.count>=3){const t=new Error(`${su} - max retries exceeded`);try{t.cause=i}catch{}throw t}return e.interval*=++e.count,new Promise((i,s)=>{Sc(async()=>{try{await Ep(t,e),i(!0)}catch(t){s(t)}},e.interval)})}}const Cp="__THROTTLED";class Ap{constructor({options:t,recordingOptions:e}){this.eventBuffer=null,this.performanceEntries=[],this.replayPerformanceEntries=[],this.recordingMode="session",this.timeouts={sessionIdlePause:3e5,sessionIdleExpire:9e5},this.si=Date.now(),this.Ht=!1,this.ni=!1,this.ri=!1,this.oi=!1,this.ai={errorIds:new Set,traceIds:new Set,urls:[],initialTimestamp:Date.now(),initialUrl:""},this.hi=e,this.Bt=t,this.ci=function(t,e,i){return function(t,e,i){let s,n,r;const o=i?.maxWait?Math.max(i.maxWait,e):0,a=i?.setTimeoutImpl||setTimeout;function h(){return c(),s=t(),s}function c(){void 0!==n&&clearTimeout(n),void 0!==r&&clearTimeout(r),n=r=void 0}function u(){return n&&clearTimeout(n),n=a(h,e),o&&void 0===r&&(r=a(h,o)),s}return u.cancel=c,u.flush=function(){return void 0!==n||void 0!==r?h():s},u}(t,e,{...i,setTimeoutImpl:Sc})}(()=>this.ui(),this.Bt.flushMinDelay,{maxWait:this.Bt.flushMaxDelay}),this.li=function(t){const e=new Map;let i=!1;return(...s)=>{const n=Math.floor(Date.now()/1e3);if((t=>{const i=t-5;e.forEach((t,s)=>{s<i&&e.delete(s)})})(n),[...e.values()].reduce((t,e)=>t+e,0)>=300){const t=i;return i=!0,t?"__SKIPPED":Cp}i=!1;const r=e.get(n)||0;return e.set(n,r+1),t(...s)}}((t,e)=>function(t,e,i){return ip(t,e)?ep(t,e,i):Promise.resolve(null)}(this,t,e));const{slowClickTimeout:i,slowClickIgnoreSelectors:s}=this.getOptions(),n=i?{threshold:Math.min(3e3,i),timeout:i,scrollTimeout:300,ignoreSelector:s?s.join(","):""}:void 0;if(n&&(this.clickDetector=new bd(this,n)),Bd){const e=t.Nt;qd.setConfig({captureExceptions:!!e.captureExceptions,traceInternals:!!e.traceInternals})}this.di=()=>{"visible"===eu.document.visibilityState?this.pi():this.fi()},this.mi=()=>{const t=Md({category:"ui.blur"});this.fi(t)},this.gi=()=>{const t=Md({category:"ui.focus"});this.pi(t)},this.yi=t=>{!function(t,e){if(!t.isEnabled())return;t.updateUserActivity();const i=function(t){const{metaKey:e,shiftKey:i,ctrlKey:s,altKey:n,key:r,target:o}=t;if(!o||function(t){return"INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable}(o)||!r)return null;const a=e||s||n,h=1===r.length;if(!a&&h)return null;const c=_s(o,{maxStringLength:200})||"<unknown>";return Md({category:"ui.keyDown",message:c,data:{...Td(o,c).data,metaKey:e,shiftKey:i,ctrlKey:s,altKey:n,key:r}})}(e);i&&dd(t,i)}(this,t)}}getContext(){return this.ai}isEnabled(){return this.Ht}isPaused(){return this.ni}isRecordingCanvas(){return Boolean(this.bi)}getOptions(){return this.Bt}handleException(t){Bd&&qd.exception(t),this.Bt.onError&&this.Bt.onError(t)}initializeSampling(t){const{errorSampleRate:e,sessionSampleRate:i}=this.Bt,s=e<=0&&i<=0;this.ri=s,s||(this.wi(t),this.session?!1!==this.session.sampled&&(this.recordingMode="buffer"===this.session.sampled&&0===this.session.segmentId?"buffer":"session",Bd&&qd.infoTick(`Starting replay in ${this.recordingMode} mode`),this.Mi()):Bd&&qd.exception(new Error("Unable to initialize and create session")))}start(){if(this.Ht&&"session"===this.recordingMode)return void(Bd&&qd.log("Recording is already in progress"));if(this.Ht&&"buffer"===this.recordingMode)return void(Bd&&qd.log("Buffering is in progress, call `flush()` to save the replay"));Bd&&qd.infoTick("Starting replay in session mode"),this.Si();const t=Zd({maxReplayDuration:this.Bt.maxReplayDuration,sessionIdleExpire:this.timeouts.sessionIdleExpire},{stickySession:this.Bt.stickySession,sessionSampleRate:1,allowBuffering:!1});this.session=t,this.recordingMode="session",this.Mi()}startBuffering(){if(this.Ht)return void(Bd&&qd.log("Buffering is in progress, call `flush()` to save the replay"));Bd&&qd.infoTick("Starting replay in buffer mode");const t=Zd({sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this.Bt.maxReplayDuration},{stickySession:this.Bt.stickySession,sessionSampleRate:0,allowBuffering:!0});this.session=t,this.recordingMode="buffer",this.Mi()}startRecording(){try{const t=this.bi;this.ki=ad({...this.hi,..."buffer"===this.recordingMode?{checkoutEveryNms:6e4}:this.Bt.Nt.continuousCheckout&&{checkoutEveryNms:Math.max(36e4,this.Bt.Nt.continuousCheckout)},emit:kp(this),.../iPhone|iPad|iPod/i.test(Sp?.userAgent??"")||/Macintosh/i.test(Sp?.userAgent??"")&&Sp?.maxTouchPoints&&Sp?.maxTouchPoints>1?{sampling:{mousemove:!1}}:{},onMutation:this.xi.bind(this),...t?{recordCanvas:t.recordCanvas,getCanvasManager:t.getCanvasManager,sampling:t.sampling,dataURLOptions:t.dataURLOptions}:{}})}catch(t){this.handleException(t)}}stopRecording(){try{return this.ki&&(this.ki(),this.ki=void 0),!0}catch(t){return this.handleException(t),!1}}async stop({forceFlush:t=!1,reason:e}={}){if(this.Ht){this.Ht=!1,this.recordingMode="buffer";try{Bd&&qd.log("Stopping Replay"+(e?` triggered by ${e}`:"")),ap(),this.Ti(),this.stopRecording(),this.ci.cancel(),t&&await this.ui({force:!0}),this.eventBuffer?.destroy(),this.eventBuffer=null,function(){if(Wd())try{eu.sessionStorage.removeItem(iu)}catch{}}(),this.session=void 0}catch(t){this.handleException(t)}}}pause(){this.ni||(this.ni=!0,this.stopRecording(),Bd&&qd.log("Pausing replay"))}resume(){this.ni&&this.Ei()&&(this.ni=!1,this.startRecording(),Bd&&qd.log("Resuming replay"))}async sendBufferedReplayOrFlush({continueRecording:t=!0}={}){if("session"===this.recordingMode)return this.flushImmediate();const e=Date.now();Bd&&qd.log("Converting buffer to session"),await this.flushImmediate();const i=this.stopRecording();t&&i&&"session"!==this.recordingMode&&(this.recordingMode="session",this.session&&(this.Si(e),this.Ci(e),this.Ai()),this.startRecording())}addUpdate(t){const e=t();"buffer"!==this.recordingMode&&this.Ht&&!0!==e&&this.ci()}triggerUserActivity(){if(this.Si(),this.ki)this.checkAndHandleExpiredSession(),this.Ci();else{if(!this.Ei())return;this.resume()}}updateUserActivity(){this.Si(),this.Ci()}conditionalFlush(){return"buffer"===this.recordingMode?Promise.resolve():this.flushImmediate()}flush(){return this.ci()}flushImmediate(){return this.ci(),this.ci.flush()}cancelFlush(){this.ci.cancel()}getSessionId(t){if(!t||!1!==this.session?.sampled)return this.session?.id}checkAndHandleExpiredSession(){if(!(this.si&&Jd(this.si,this.timeouts.sessionIdlePause)&&this.session&&"session"===this.session.sampled))return!!this.Ei();this.pause()}setInitialState(){const t=`${eu.location.pathname}${eu.location.hash}${eu.location.search}`,e=`${eu.location.origin}${t}`;this.performanceEntries=[],this.replayPerformanceEntries=[],this.Ii(),this.ai.initialUrl=e,this.ai.initialTimestamp=Date.now(),this.ai.urls.push(e)}throttledAddEvent(t,e){const i=this.li(t,e);if(i===Cp){const t=Md({category:"replay.throttled"});this.addUpdate(()=>!tp(this,{type:5,timestamp:t.timestamp||0,data:{tag:"breadcrumb",payload:t,metric:!0}}))}return i}getCurrentRoute(){const t=this.lastActiveSpan||fr(),e=t&&pr(t),i=(e&&or(e).data||{})[xn];if(e&&i&&["route","custom"].includes(i))return or(e).description}Mi(){this.setInitialState(),this.Ci(),this.eventBuffer=function({useCompression:t,workerUrl:e}){if(t&&window.Worker){const t=function(t){try{const e=t||("undefined"!=typeof __SENTRY_EXCLUDE_REPLAY_WORKER__&&__SENTRY_EXCLUDE_REPLAY_WORKER__?"":function(){const t=new Blob(['var t=Uint8Array,n=Uint16Array,r=Int32Array,e=new t([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),i=new t([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),s=new t([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(t,e){for(var i=new n(31),s=0;s<31;++s)i[s]=e+=1<<t[s-1];var a=new r(i[30]);for(s=1;s<30;++s)for(var o=i[s];o<i[s+1];++o)a[o]=o-i[s]<<5|s;return{b:i,r:a}},o=a(e,2),h=o.b,f=o.r;h[28]=258,f[258]=28;for(var l=a(i,0).r,u=new n(32768),c=0;c<32768;++c){var v=(43690&c)>>1|(21845&c)<<1;v=(61680&(v=(52428&v)>>2|(13107&v)<<2))>>4|(3855&v)<<4,u[c]=((65280&v)>>8|(255&v)<<8)>>1}var d=function(t,r,e){for(var i=t.length,s=0,a=new n(r);s<i;++s)t[s]&&++a[t[s]-1];var o,h=new n(r);for(s=1;s<r;++s)h[s]=h[s-1]+a[s-1]<<1;if(e){o=new n(1<<r);var f=15-r;for(s=0;s<i;++s)if(t[s])for(var l=s<<4|t[s],c=r-t[s],v=h[t[s]-1]++<<c,d=v|(1<<c)-1;v<=d;++v)o[u[v]>>f]=l}else for(o=new n(i),s=0;s<i;++s)t[s]&&(o[s]=u[h[t[s]-1]++]>>15-t[s]);return o},p=new t(288);for(c=0;c<144;++c)p[c]=8;for(c=144;c<256;++c)p[c]=9;for(c=256;c<280;++c)p[c]=7;for(c=280;c<288;++c)p[c]=8;var g=new t(32);for(c=0;c<32;++c)g[c]=5;var w=d(p,9,0),y=d(g,5,0),m=function(t){return(t+7)/8|0},b=function(n,r,e){return(null==e||e>n.length)&&(e=n.length),new t(n.subarray(r,e))},M=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],E=function(t,n,r){var e=new Error(n||M[t]);if(e.code=t,Error.captureStackTrace&&Error.captureStackTrace(e,E),!r)throw e;return e},z=function(t,n,r){r<<=7&n;var e=n/8|0;t[e]|=r,t[e+1]|=r>>8},_=function(t,n,r){r<<=7&n;var e=n/8|0;t[e]|=r,t[e+1]|=r>>8,t[e+2]|=r>>16},x=function(r,e){for(var i=[],s=0;s<r.length;++s)r[s]&&i.push({s:s,f:r[s]});var a=i.length,o=i.slice();if(!a)return{t:F,l:0};if(1==a){var h=new t(i[0].s+1);return h[i[0].s]=1,{t:h,l:1}}i.sort(function(t,n){return t.f-n.f}),i.push({s:-1,f:25001});var f=i[0],l=i[1],u=0,c=1,v=2;for(i[0]={s:-1,f:f.f+l.f,l:f,r:l};c!=a-1;)f=i[i[u].f<i[v].f?u++:v++],l=i[u!=c&&i[u].f<i[v].f?u++:v++],i[c++]={s:-1,f:f.f+l.f,l:f,r:l};var d=o[0].s;for(s=1;s<a;++s)o[s].s>d&&(d=o[s].s);var p=new n(d+1),g=A(i[c-1],p,0);if(g>e){s=0;var w=0,y=g-e,m=1<<y;for(o.sort(function(t,n){return p[n.s]-p[t.s]||t.f-n.f});s<a;++s){var b=o[s].s;if(!(p[b]>e))break;w+=m-(1<<g-p[b]),p[b]=e}for(w>>=y;w>0;){var M=o[s].s;p[M]<e?w-=1<<e-p[M]++-1:++s}for(;s>=0&&w;--s){var E=o[s].s;p[E]==e&&(--p[E],++w)}g=e}return{t:new t(p),l:g}},A=function(t,n,r){return-1==t.s?Math.max(A(t.l,n,r+1),A(t.r,n,r+1)):n[t.s]=r},D=function(t){for(var r=t.length;r&&!t[--r];);for(var e=new n(++r),i=0,s=t[0],a=1,o=function(t){e[i++]=t},h=1;h<=r;++h)if(t[h]==s&&h!=r)++a;else{if(!s&&a>2){for(;a>138;a-=138)o(32754);a>2&&(o(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(o(s),--a;a>6;a-=6)o(8304);a>2&&(o(a-3<<5|8208),a=0)}for(;a--;)o(s);a=1,s=t[h]}return{c:e.subarray(0,i),n:r}},T=function(t,n){for(var r=0,e=0;e<n.length;++e)r+=t[e]*n[e];return r},k=function(t,n,r){var e=r.length,i=m(n+2);t[i]=255&e,t[i+1]=e>>8,t[i+2]=255^t[i],t[i+3]=255^t[i+1];for(var s=0;s<e;++s)t[i+s+4]=r[s];return 8*(i+4+e)},U=function(t,r,a,o,h,f,l,u,c,v,m){z(r,m++,a),++h[256];for(var b=x(h,15),M=b.t,E=b.l,A=x(f,15),U=A.t,C=A.l,F=D(M),I=F.c,S=F.n,L=D(U),O=L.c,j=L.n,q=new n(19),B=0;B<I.length;++B)++q[31&I[B]];for(B=0;B<O.length;++B)++q[31&O[B]];for(var G=x(q,7),H=G.t,J=G.l,K=19;K>4&&!H[s[K-1]];--K);var N,P,Q,R,V=v+5<<3,W=T(h,p)+T(f,g)+l,X=T(h,M)+T(f,U)+l+14+3*K+T(q,H)+2*q[16]+3*q[17]+7*q[18];if(c>=0&&V<=W&&V<=X)return k(r,m,t.subarray(c,c+v));if(z(r,m,1+(X<W)),m+=2,X<W){N=d(M,E,0),P=M,Q=d(U,C,0),R=U;var Y=d(H,J,0);z(r,m,S-257),z(r,m+5,j-1),z(r,m+10,K-4),m+=14;for(B=0;B<K;++B)z(r,m+3*B,H[s[B]]);m+=3*K;for(var Z=[I,O],$=0;$<2;++$){var tt=Z[$];for(B=0;B<tt.length;++B){var nt=31&tt[B];z(r,m,Y[nt]),m+=H[nt],nt>15&&(z(r,m,tt[B]>>5&127),m+=tt[B]>>12)}}}else N=w,P=p,Q=y,R=g;for(B=0;B<u;++B){var rt=o[B];if(rt>255){_(r,m,N[(nt=rt>>18&31)+257]),m+=P[nt+257],nt>7&&(z(r,m,rt>>23&31),m+=e[nt]);var et=31&rt;_(r,m,Q[et]),m+=R[et],et>3&&(_(r,m,rt>>5&8191),m+=i[et])}else _(r,m,N[rt]),m+=P[rt]}return _(r,m,N[256]),m+P[256]},C=new r([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),F=new t(0),I=function(){for(var t=new Int32Array(256),n=0;n<256;++n){for(var r=n,e=9;--e;)r=(1&r&&-306674912)^r>>>1;t[n]=r}return t}(),S=function(){var t=1,n=0;return{p:function(r){for(var e=t,i=n,s=0|r.length,a=0;a!=s;){for(var o=Math.min(a+2655,s);a<o;++a)i+=e+=r[a];e=(65535&e)+15*(e>>16),i=(65535&i)+15*(i>>16)}t=e,n=i},d:function(){return(255&(t%=65521))<<24|(65280&t)<<8|(255&(n%=65521))<<8|n>>8}}},L=function(s,a,o,h,u){if(!u&&(u={l:1},a.dictionary)){var c=a.dictionary.subarray(-32768),v=new t(c.length+s.length);v.set(c),v.set(s,c.length),s=v,u.w=c.length}return function(s,a,o,h,u,c){var v=c.z||s.length,d=new t(h+v+5*(1+Math.ceil(v/7e3))+u),p=d.subarray(h,d.length-u),g=c.l,w=7&(c.r||0);if(a){w&&(p[0]=c.r>>3);for(var y=C[a-1],M=y>>13,E=8191&y,z=(1<<o)-1,_=c.p||new n(32768),x=c.h||new n(z+1),A=Math.ceil(o/3),D=2*A,T=function(t){return(s[t]^s[t+1]<<A^s[t+2]<<D)&z},F=new r(25e3),I=new n(288),S=new n(32),L=0,O=0,j=c.i||0,q=0,B=c.w||0,G=0;j+2<v;++j){var H=T(j),J=32767&j,K=x[H];if(_[J]=K,x[H]=J,B<=j){var N=v-j;if((L>7e3||q>24576)&&(N>423||!g)){w=U(s,p,0,F,I,S,O,q,G,j-G,w),q=L=O=0,G=j;for(var P=0;P<286;++P)I[P]=0;for(P=0;P<30;++P)S[P]=0}var Q=2,R=0,V=E,W=J-K&32767;if(N>2&&H==T(j-W))for(var X=Math.min(M,N)-1,Y=Math.min(32767,j),Z=Math.min(258,N);W<=Y&&--V&&J!=K;){if(s[j+Q]==s[j+Q-W]){for(var $=0;$<Z&&s[j+$]==s[j+$-W];++$);if($>Q){if(Q=$,R=W,$>X)break;var tt=Math.min(W,$-2),nt=0;for(P=0;P<tt;++P){var rt=j-W+P&32767,et=rt-_[rt]&32767;et>nt&&(nt=et,K=rt)}}}W+=(J=K)-(K=_[J])&32767}if(R){F[q++]=268435456|f[Q]<<18|l[R];var it=31&f[Q],st=31&l[R];O+=e[it]+i[st],++I[257+it],++S[st],B=j+Q,++L}else F[q++]=s[j],++I[s[j]]}}for(j=Math.max(j,B);j<v;++j)F[q++]=s[j],++I[s[j]];w=U(s,p,g,F,I,S,O,q,G,j-G,w),g||(c.r=7&w|p[w/8|0]<<3,w-=7,c.h=x,c.p=_,c.i=j,c.w=B)}else{for(j=c.w||0;j<v+g;j+=65535){var at=j+65535;at>=v&&(p[w/8|0]=g,at=v),w=k(p,w+1,s.subarray(j,at))}c.i=v}return b(d,0,h+m(w)+u)}(s,null==a.level?6:a.level,null==a.mem?u.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(s.length)))):20:12+a.mem,o,h,u)},O=function(t,n,r){for(;r;++n)t[n]=r,r>>>=8},j=function(){function n(n,r){if("function"==typeof n&&(r=n,n={}),this.ondata=r,this.o=n||{},this.s={l:0,i:32768,w:32768,z:32768},this.b=new t(98304),this.o.dictionary){var e=this.o.dictionary.subarray(-32768);this.b.set(e,32768-e.length),this.s.i=32768-e.length}}return n.prototype.p=function(t,n){this.ondata(L(t,this.o,0,0,this.s),n)},n.prototype.push=function(n,r){this.ondata||E(5),this.s.l&&E(4);var e=n.length+this.s.z;if(e>this.b.length){if(e>2*this.b.length-32768){var i=new t(-32768&e);i.set(this.b.subarray(0,this.s.z)),this.b=i}var s=this.b.length-this.s.z;this.b.set(n.subarray(0,s),this.s.z),this.s.z=this.b.length,this.p(this.b,!1),this.b.set(this.b.subarray(-32768)),this.b.set(n.subarray(s),32768),this.s.z=n.length-s+32768,this.s.i=32766,this.s.w=32768}else this.b.set(n,this.s.z),this.s.z+=n.length;this.s.l=1&r,(this.s.z>this.s.w+8191||r)&&(this.p(this.b,r||!1),this.s.w=this.s.i,this.s.i-=2)},n.prototype.flush=function(){this.ondata||E(5),this.s.l&&E(4),this.p(this.b,!1),this.s.w=this.s.i,this.s.i-=2},n}();function q(t,n){n||(n={});var r=function(){var t=-1;return{p:function(n){for(var r=t,e=0;e<n.length;++e)r=I[255&r^n[e]]^r>>>8;t=r},d:function(){return~t}}}(),e=t.length;r.p(t);var i,s=L(t,n,10+((i=n).filename?i.filename.length+1:0),8),a=s.length;return function(t,n){var r=n.filename;if(t[0]=31,t[1]=139,t[2]=8,t[8]=n.level<2?4:9==n.level?2:0,t[9]=3,0!=n.mtime&&O(t,4,Math.floor(new Date(n.mtime||Date.now())/1e3)),r){t[3]=8;for(var e=0;e<=r.length;++e)t[e+10]=r.charCodeAt(e)}}(s,n),O(s,a-8,r.d()),O(s,a-4,e),s}var B=function(){function t(t,n){this.c=S(),this.v=1,j.call(this,t,n)}return t.prototype.push=function(t,n){this.c.p(t),j.prototype.push.call(this,t,n)},t.prototype.p=function(t,n){var r=L(t,this.o,this.v&&(this.o.dictionary?6:2),n&&4,this.s);this.v&&(function(t,n){var r=n.level,e=0==r?0:r<6?1:9==r?3:2;if(t[0]=120,t[1]=e<<6|(n.dictionary&&32),t[1]|=31-(t[0]<<8|t[1])%31,n.dictionary){var i=S();i.p(n.dictionary),O(t,2,i.d())}}(r,this.o),this.v=0),n&&O(r,r.length-4,this.c.d()),this.ondata(r,n)},t.prototype.flush=function(){j.prototype.flush.call(this)},t}(),G="undefined"!=typeof TextEncoder&&new TextEncoder,H="undefined"!=typeof TextDecoder&&new TextDecoder;try{H.decode(F,{stream:!0})}catch(t){}var J=function(){function t(t){this.ondata=t}return t.prototype.push=function(t,n){this.ondata||E(5),this.d&&E(4),this.ondata(K(t),this.d=n||!1)},t}();function K(n,r){if(G)return G.encode(n);for(var e=n.length,i=new t(n.length+(n.length>>1)),s=0,a=function(t){i[s++]=t},o=0;o<e;++o){if(s+5>i.length){var h=new t(s+8+(e-o<<1));h.set(i),i=h}var f=n.charCodeAt(o);f<128||r?a(f):f<2048?(a(192|f>>6),a(128|63&f)):f>55295&&f<57344?(a(240|(f=65536+(1047552&f)|1023&n.charCodeAt(++o))>>18),a(128|f>>12&63),a(128|f>>6&63),a(128|63&f)):(a(224|f>>12),a(128|f>>6&63),a(128|63&f))}return b(i,0,s)}const N=new class{constructor(){this._init()}clear(){this._init()}addEvent(t){if(!t)throw new Error("Adding invalid event");const n=this._hasEvents?",":"";this.stream.push(n+t),this._hasEvents=!0}finish(){this.stream.push("]",!0);const t=function(t){let n=0;for(const r of t)n+=r.length;const r=new Uint8Array(n);for(let n=0,e=0,i=t.length;n<i;n++){const i=t[n];r.set(i,e),e+=i.length}return r}(this._deflatedData);return this._init(),t}_init(){this._hasEvents=!1,this._deflatedData=[],this.deflate=new B,this.deflate.ondata=(t,n)=>{this._deflatedData.push(t)},this.stream=new J((t,n)=>{this.deflate.push(t,n)}),this.stream.push("[")}},P={clear:()=>{N.clear()},addEvent:t=>N.addEvent(t),finish:()=>N.finish(),compress:t=>function(t){return q(K(t))}(t)};addEventListener("message",function(t){const n=t.data.method,r=t.data.id,e=t.data.arg;if(n in P&&"function"==typeof P[n])try{const t=P[n](e);postMessage({id:r,method:n,success:!0,response:t})}catch(t){postMessage({id:r,method:n,success:!1,response:t.message}),console.error(t)}}),postMessage({id:void 0,method:"init",success:!0,response:void 0});']);return URL.createObjectURL(t)}());if(!e)return;Bd&&qd.log("Using compression worker"+(t?` from ${t}`:""));const i=new Worker(e);return new Ud(i)}catch(t){Bd&&qd.exception(t,"Failed to create compression worker")}}(e);if(t)return t}return Bd&&qd.log("Using simple buffer"),new Ld}({useCompression:this.Bt.useCompression,workerUrl:this.Bt.workerUrl}),this.Ti(),this.Fi(),this.Ht=!0,this.ni=!1,this.startRecording()}wi(t){const e=this.Bt.errorSampleRate>0,i=Zd({sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this.Bt.maxReplayDuration,previousSessionId:t},{stickySession:this.Bt.stickySession,sessionSampleRate:this.Bt.sessionSampleRate,allowBuffering:e});this.session=i}Ei(){if(!this.session)return!1;const t=this.session;return!Qd(t,{sessionIdleExpire:this.timeouts.sessionIdleExpire,maxReplayDuration:this.Bt.maxReplayDuration})||(this._i(t),!1)}async _i(t){this.Ht&&(await this.stop({reason:"refresh session"}),this.initializeSampling(t.id))}Fi(){try{eu.document.addEventListener("visibilitychange",this.di),eu.addEventListener("blur",this.mi),eu.addEventListener("focus",this.gi),eu.addEventListener("keydown",this.yi),this.clickDetector&&this.clickDetector.addListeners(),this.oi||(wp(this),this.oi=!0)}catch(t){this.handleException(t)}this.Ri=function(t){function e(e){t.performanceEntries.includes(e)||t.performanceEntries.push(e)}function i({entries:t}){t.forEach(e)}const s=[];return["navigation","paint","resource"].forEach(t=>{s.push(Lh(t,i))}),s.push(qh(Cd(Fd,t)),zh(Cd(Rd,t)),jh(Cd(Pd,t))),()=>{s.forEach(t=>t())}}(this)}Ti(){try{eu.document.removeEventListener("visibilitychange",this.di),eu.removeEventListener("blur",this.mi),eu.removeEventListener("focus",this.gi),eu.removeEventListener("keydown",this.yi),this.clickDetector&&this.clickDetector.removeListeners(),this.Ri&&this.Ri()}catch(t){this.handleException(t)}}fi(t){this.session&&(Kd(this.session,{maxReplayDuration:this.Bt.maxReplayDuration,sessionIdleExpire:this.timeouts.sessionIdleExpire})||(t&&this.Pi(t),this.conditionalFlush()))}pi(t){this.session&&(this.checkAndHandleExpiredSession()?t&&this.Pi(t):Bd&&qd.log("Document has become active, but session has expired"))}Si(t=Date.now()){this.si=t}Ci(t=Date.now()){this.session&&(this.session.lastActivity=t,this.Ai())}Pi(t){this.addUpdate(()=>{this.throttledAddEvent({type:vl.Custom,timestamp:t.timestamp||0,data:{tag:"breadcrumb",payload:t}})})}Oi(){let t=(e=this.performanceEntries,e.map(Ad).filter(Boolean)).concat(this.replayPerformanceEntries);var e;if(this.performanceEntries=[],this.replayPerformanceEntries=[],this.ri){const e=this.ai.initialTimestamp/1e3;t=t.filter(t=>t.start>=e)}return Promise.all(hp(this,t))}Ii(){this.ai.errorIds.clear(),this.ai.traceIds.clear(),this.ai.urls=[]}Bi(){const{session:t,eventBuffer:e}=this;if(!t||!e||this.ri)return;if(t.segmentId)return;const i=e.getEarliestTimestamp();i&&i<this.ai.initialTimestamp&&(this.ai.initialTimestamp=i)}Di(){const t={initialTimestamp:this.ai.initialTimestamp,initialUrl:this.ai.initialUrl,errorIds:Array.from(this.ai.errorIds),traceIds:Array.from(this.ai.traceIds),urls:this.ai.urls};return this.Ii(),t}async $i(){const t=this.getSessionId();if(this.session&&this.eventBuffer&&t){if(await this.Oi(),this.eventBuffer?.hasEvents&&(await async function(t){try{return Promise.all(hp(t,[Mp(eu.performance.memory)]))}catch{return[]}}(this),this.eventBuffer&&t===this.getSessionId()))try{this.Bi();const e=Date.now();if(e-this.ai.initialTimestamp>this.Bt.maxReplayDuration+3e4)throw new Error("Session is too long, not sending replay");const i=this.Di(),s=this.session.segmentId++;this.Ai();const n=await this.eventBuffer.finish();await Ep({replayId:t,recordingData:n,segmentId:s,eventContext:i,session:this.session,timestamp:e,onError:t=>this.handleException(t)})}catch(t){this.handleException(t),this.stop({reason:"sendReplay"});const e=Sn();if(e){const i=t instanceof Tp?"ratelimit_backoff":"send_error";e.recordDroppedEvent(i,"replay")}}}else Bd&&qd.error("No session or eventBuffer found to flush.")}async ui({force:t=!1}={}){if(!this.Ht&&!t)return;if(!this.checkAndHandleExpiredSession())return void(Bd&&qd.error("Attempting to finish replay event after session expired."));if(!this.session)return;const e=this.session.started,i=Date.now()-e;this.ci.cancel();const s=i<this.Bt.minReplayDuration,n=i>this.Bt.maxReplayDuration+5e3;if(s||n)return Bd&&qd.log(`Session duration (${Math.floor(i/1e3)}s) is too ${s?"short":"long"}, not sending replay.`),void(s&&this.ci());const r=this.eventBuffer;r&&0===this.session.segmentId&&!r.hasCheckout&&Bd&&qd.log("Flushing initial segment without checkout.");const o=!!this.zi;this.zi||(this.zi=this.$i());try{await this.zi}catch(t){this.handleException(t)}finally{this.zi=void 0,o&&this.ci()}}Ai(){this.session&&this.Bt.stickySession&&Vd(this.session)}xi(t){const{ignoreMutations:e}=this.Bt.Nt;if(e?.length&&t.some(t=>{const i=function(t){if(!t)return null;try{return t.nodeType===t.ELEMENT_NODE?t:t.parentElement}catch{return null}}(t.target),s=e.join(",");return i?.matches(s)}))return!1;const i=t.length,s=this.Bt.mutationLimit,n=s&&i>s;if(i>this.Bt.mutationBreadcrumbLimit||n){const t=Md({category:"replay.mutations",data:{count:i,limit:n}});this.Pi(t)}return!n||(this.stop({reason:"mutationLimit",forceFlush:"session"===this.recordingMode}),!1)}}function Ip(t,e){return[...t,...e].join(",")}const Fp='img,image,svg,video,object,picture,embed,map,audio,link[rel="icon"],link[rel="apple-touch-icon"]',_p=["content-length","content-type","accept"];let Rp=!1;const Pp=t=>new Op(t);class Op{constructor({flushMinDelay:t=5e3,flushMaxDelay:e=5500,minReplayDuration:i=4999,maxReplayDuration:s=36e5,stickySession:n=!0,useCompression:r=!0,workerUrl:o,Nt:a={},maskAllText:h=!0,maskAllInputs:c=!0,blockAllMedia:u=!0,mutationBreadcrumbLimit:l=750,mutationLimit:d=1e4,slowClickTimeout:p=7e3,slowClickIgnoreSelectors:f=[],networkDetailAllowUrls:m=[],networkDetailDenyUrls:g=[],networkCaptureBodies:y=!0,networkRequestHeaders:b=[],networkResponseHeaders:v=[],mask:w=[],maskAttributes:M=["title","placeholder","aria-label"],unmask:S=[],block:k=[],unblock:x=[],ignore:T=[],maskFn:E,beforeAddRecordingEvent:C,beforeErrorSampling:A,onError:I}={}){this.name="Replay";const F=function({mask:t,unmask:e,block:i,unblock:s,ignore:n}){return{maskTextSelector:Ip(t,[".sentry-mask","[data-sentry-mask]"]),unmaskTextSelector:Ip(e,[]),blockSelector:Ip(i,[".sentry-block","[data-sentry-block]","base","iframe[srcdoc]:not([src])"]),unblockSelector:Ip(s,[]),ignoreSelector:Ip(n,[".sentry-ignore","[data-sentry-ignore]",'input[type="file"]'])}}({mask:w,unmask:S,block:k,unblock:x,ignore:T});if(this.hi={maskAllInputs:c,maskAllText:h,maskInputOptions:{password:!0},maskTextFn:E,maskInputFn:E,maskAttributeFn:(t,e,i)=>function({el:t,key:e,maskAttributes:i,maskAllText:s,privacyOptions:n,value:r}){return s?n.unmaskTextSelector&&t.matches(n.unmaskTextSelector)?r:i.includes(e)||"value"===e&&"INPUT"===t.tagName&&["submit","button"].includes(t.getAttribute("type")||"")?r.replace(/[\S]/g,"*"):r:r}({maskAttributes:M,maskAllText:h,privacyOptions:F,key:t,value:e,el:i}),...F,slimDOMOptions:"all",inlineStylesheet:!0,inlineImages:!1,collectFonts:!0,errorHandler:t=>{try{t.ei=!0}catch{}},recordCrossOriginIframes:Boolean(a.recordCrossOriginIframes)},this.qi={flushMinDelay:t,flushMaxDelay:e,minReplayDuration:Math.min(i,15e3),maxReplayDuration:Math.min(s,36e5),stickySession:n,useCompression:r,workerUrl:o,blockAllMedia:u,maskAllInputs:c,maskAllText:h,mutationBreadcrumbLimit:l,mutationLimit:d,slowClickTimeout:p,slowClickIgnoreSelectors:f,networkDetailAllowUrls:m,networkDetailDenyUrls:g,networkCaptureBodies:y,networkRequestHeaders:Bp(b),networkResponseHeaders:Bp(v),beforeAddRecordingEvent:C,beforeErrorSampling:A,onError:I,Nt:a},this.qi.blockAllMedia&&(this.hi.blockSelector=this.hi.blockSelector?`${this.hi.blockSelector},${Fp}`:Fp),this.ji&&Ba())throw new Error("Multiple Sentry Session Replay instances are not supported");this.ji=!0}get ji(){return Rp}set ji(t){Rp=t}afterAllSetup(t){Ba()&&!this.Fe&&(this.Li(t),this.Ni(t))}start(){this.Fe&&this.Fe.start()}startBuffering(){this.Fe&&this.Fe.startBuffering()}stop(){return this.Fe?this.Fe.stop({forceFlush:"session"===this.Fe.recordingMode}):Promise.resolve()}flush(t){return this.Fe?this.Fe.isEnabled()?this.Fe.sendBufferedReplayOrFlush(t):(this.Fe.start(),Promise.resolve()):Promise.resolve()}getReplayId(t){if(this.Fe?.isEnabled())return this.Fe.getSessionId(t)}getRecordingMode(){if(this.Fe?.isEnabled())return this.Fe.recordingMode}Ni(t){this.Fe&&(this.Gi(t),this.Fe.initializeSampling())}Li(t){const e=function(t,e){const i=e.getOptions(),s={sessionSampleRate:0,errorSampleRate:0,...t},n=Jn(i.replaysSessionSampleRate),r=Jn(i.replaysOnErrorSampleRate);return null==n&&null==r&&Hi(()=>{}),null!=n&&(s.sessionSampleRate=n),null!=r&&(s.errorSampleRate=r),s}(this.qi,t);this.Fe=new Ap({options:e,recordingOptions:this.hi})}Gi(t){try{const e=t.getIntegrationByName("ReplayCanvas");if(!e)return;this.Fe.bi=e.getOptions()}catch{}}}function Bp(t){return[..._p,...t.map(t=>t.toLowerCase())]}function Dp(t){try{return new URL(t,Da.location.origin).href}catch{return}}function $p(t){try{return new Headers(t)}catch{return}}const zp=new WeakMap,qp=new Map,jp={traceFetch:!0,traceXHR:!0,enableHTTPTimings:!0,trackFetchStreamPerformance:!1};function Lp(t){const{url:e}=or(t).data;if(!e||"string"!=typeof e)return;const i=Lh("resource",({entries:s})=>{s.forEach(s=>{(function(t){return"resource"===t.entryType&&"initiatorType"in t&&"string"==typeof t.nextHopProtocol&&("fetch"===t.initiatorType||"xmlhttprequest"===t.initiatorType)})(s)&&s.name.endsWith(e)&&(t.setAttributes(nc(s)),setTimeout(i))})})}const Np="sentry_previous_trace";function Gp(t){return 1===t.traceFlags}const Up={...eo,instrumentNavigation:!0,instrumentPageLoad:!0,markBackgroundSpan:!0,enableLongTask:!0,enableLongAnimationFrame:!0,enableInp:!0,enableElementTiming:!0,ignoreResourceSpans:[],ignorePerformanceApiSpans:[],detectRedirects:!0,linkPreviousTrace:"in-memory",consistentTraceSampling:!1,enableReportPageLoaded:!1,Nt:{},...jp},Wp=(t={})=>{const e={name:void 0,source:void 0},i=Da.document,{enableInp:s,enableElementTiming:n,enableLongTask:r,enableLongAnimationFrame:o,Nt:{enableInteractions:a,enableStandaloneClsSpans:h,enableStandaloneLcpSpans:c},beforeStartSpan:u,idleTimeout:l,finalTimeout:d,childSpanTimeout:p,markBackgroundSpan:f,traceFetch:m,traceXHR:g,trackFetchStreamPerformance:y,shouldCreateSpanForRequest:b,enableHTTPTimings:v,ignoreResourceSpans:w,ignorePerformanceApiSpans:M,instrumentPageLoad:S,instrumentNavigation:k,detectRedirects:x,linkPreviousTrace:T,consistentTraceSampling:E,enableReportPageLoaded:C,onRequestSpanStart:A,onRequestSpanEnd:I}={...Up,...t};let F,_,R;function P(t,s,n=!0){const r="pageload"===s.op,o=s.name,a=u?u(s):s,f=a.attributes||{};if(o!==a.name&&(f[xn]="custom",a.attributes=f),!n){const t=en();return void Yr({...a,startTime:t}).end(t)}e.name=a.name,e.source=f[xn];const m=io(a,{idleTimeout:l,finalTimeout:d,childSpanTimeout:p,disableAutoFinish:r,beforeSpanEnd:e=>{F?.(),function(t,e){const i=Zh(),s=nn();if(!i?.getEntries||!s)return;const n=tc(s),r=i.getEntries(),{op:o,start_timestamp:a}=or(t);r.slice(ac).forEach(i=>{const s=tc(i.startTime),r=tc(Math.max(0,i.duration));if(!("navigation"===o&&a&&n+s<a))switch(i.entryType){case"navigation":!function(t,e,i){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach(s=>{cc(t,e,s,i)}),cc(t,e,"secureConnection",i,"TLS/SSL"),cc(t,e,"fetch",i,"cache"),cc(t,e,"domainLookup",i,"DNS"),function(t,e,i){const s=i+tc(e.requestStart),n=i+tc(e.responseEnd),r=i+tc(e.responseStart);e.responseEnd&&(Kh(t,s,n,{op:"browser.request",name:e.name,attributes:{[An]:"auto.ui.browser.metrics"}}),Kh(t,r,n,{op:"browser.response",name:e.name,attributes:{[An]:"auto.ui.browser.metrics"}}))}(t,e,i)}(t,i,n);break;case"mark":case"paint":case"measure":{!function(t,e,i,s,n,r){if(function(t){if("measure"===t?.entryType)try{return"Components ⚛"===t.detail.devtools.track}catch{return}}(e))return;if(["mark","measure"].includes(e.entryType)&&zs(e.name,r))return;const o=eh(!1),a=tc(o?o.requestStart:0),h=n+Math.max(i,a),c=n+i,u=c+s,l={[An]:"auto.resource.browser.metrics"};h!==c&&(l["sentry.browser.measure_happened_before_request"]=!0,l["sentry.browser.measure_start_time"]=h),function(t,e){try{const i=e.detail;if(!i)return;if("object"==typeof i){for(const[e,s]of Object.entries(i))if(s&&ks(s))t[`sentry.browser.measure.detail.${e}`]=s;else if(void 0!==s)try{t[`sentry.browser.measure.detail.${e}`]=JSON.stringify(s)}catch{}return}if(ks(i))return void(t["sentry.browser.measure.detail"]=i);try{t["sentry.browser.measure.detail"]=JSON.stringify(i)}catch{}}catch{}}(l,e),h<=u&&Kh(t,h,u,{name:e.name,op:e.entryType,attributes:l})}(t,i,s,r,n,e.ignorePerformanceApiSpans);const o=dh(),a=i.startTime<o.firstHiddenTime;"first-paint"===i.name&&a&&(hc.fp={value:i.startTime,unit:"millisecond"}),"first-contentful-paint"===i.name&&a&&(hc.fcp={value:i.startTime,unit:"millisecond"});break}case"resource":!function(t,e,i,s,n,r,o){if("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)return;const a=e.initiatorType?`resource.${e.initiatorType}`:"resource.other";if(o?.includes(a))return;const h={[An]:"auto.resource.browser.metrics"},c=ta(i);c.protocol&&(h["url.scheme"]=c.protocol.split(":").pop()),c.host&&(h["server.address"]=c.host),h["url.same_origin"]=i.includes(Za.location.origin),function(t,e){[["responseStatus","http.response.status_code"],["transferSize","http.response_transfer_size"],["encodedBodySize","http.response_content_length"],["decodedBodySize","http.decoded_response_content_length"],["renderBlockingStatus","resource.render_blocking_status"],["deliveryType","http.response_delivery_type"]].forEach(([i,s])=>{const n=t[i];null!=n&&("number"==typeof n&&n<2147483647||"string"==typeof n)&&(e[s]=n)})}(e,h);const u={...h,...nc(e)},l=r+s;Kh(t,l,l+n,{name:i.replace(Za.location.origin,""),op:a,attributes:u})}(t,i,i.name,s,r,n,e.ignoreResourceSpans)}}),ac=Math.max(r.length-1,0),function(t){const e=Za.navigator;if(!e)return;const i=e.connection;i&&(i.effectiveType&&t.setAttribute("effectiveConnectionType",i.effectiveType),i.type&&t.setAttribute("connectionType",i.type),Jh(i.rtt)&&(hc["connection.rtt"]={value:i.rtt,unit:"millisecond"})),Jh(e.deviceMemory)&&t.setAttribute("deviceMemory",`${e.deviceMemory} GB`),Jh(e.hardwareConcurrency)&&t.setAttribute("hardwareConcurrency",String(e.hardwareConcurrency))}(t),"pageload"===o&&(function(t){const e=eh(!1);if(!e)return;const{responseStart:i,requestStart:s}=e;s<=i&&(t["ttfb.requestTime"]={value:i-s,unit:"millisecond"})}(hc),e.recordClsOnPageloadSpan||delete hc.cls,e.recordLcpOnPageloadSpan||delete hc.lcp,Object.entries(hc).forEach(([t,e])=>{!function(t,e,i,s=fr()){const n=s&&pr(s);n&&(zi&&Ji.log(`[Measurement] Setting measurement on root span: ${t} = ${e} ${i}`),n.addEvent(t,{[_n]:e,[Fn]:i}))}(t,e.value,e.unit)}),t.setAttribute("performance.timeOrigin",n),t.setAttribute("performance.activationStart",ih()),function(t,e){rc&&e.recordLcpOnPageloadSpan&&(rc.element&&t.setAttribute("lcp.element",_s(rc.element)),rc.id&&t.setAttribute("lcp.id",rc.id),rc.url&&t.setAttribute("lcp.url",rc.url.trim().slice(0,200)),null!=rc.loadTime&&t.setAttribute("lcp.loadTime",rc.loadTime),null!=rc.renderTime&&t.setAttribute("lcp.renderTime",rc.renderTime),t.setAttribute("lcp.size",rc.size)),oc?.sources&&e.recordClsOnPageloadSpan&&oc.sources.forEach((e,i)=>t.setAttribute(`cls.source.${i+1}`,_s(e.node)))}(t,e)),rc=void 0,oc=void 0,hc={}}(e,{recordClsOnPageloadSpan:!h,recordLcpOnPageloadSpan:!c,ignoreResourceSpans:w,ignorePerformanceApiSpans:M}),Xp(t,void 0);const i=vn(),s=i.getPropagationContext();i.setPropagationContext({...s,traceId:m.spanContext().traceId,sampled:ar(m),dsc:Cr(e)}),r&&(R=void 0)},trimIdleSpanEndTimestamp:!C});function g(){i&&["interactive","complete"].includes(i.readyState)&&t.emit("idleSpanEnableAutoFinish",m)}r&&C&&(R=m),Xp(t,m),r&&!C&&i&&(i.addEventListener("readystatechange",()=>{g()}),g())}return{name:"BrowserTracing",setup(t){if(function(){function t(){const t=fr(),e=t&&pr(t);if(e){const t="internal_error";zi&&Ji.log(`[Tracing] Root span: ${t} -> Global error occurred`),e.setStatus({code:2,message:t})}}gr||(t.tag="sentry_tracingErrorCallback",gr=!0,ls(t),fs(t))}(),F=function({recordClsStandaloneSpans:t,recordLcpStandaloneSpans:e,client:i}){const s=Zh();if(s&&nn()){s.mark&&Za.performance.mark("sentry-tracing-init");const n=e?function(t){let e,i=0;if(!ec("largest-contentful-paint"))return;const s=qh(({metric:t})=>{const s=t.entries[t.entries.length-1];s&&(i=t.value,e=s)},!0);ic(t,(t,n)=>{!function(t,e,i,s){Qa&&Ji.log(`Sending LCP span (${t})`);const n=tc((nn()||0)+(e?.startTime||0)),r=vn().getScopeData().transactionName,o=e?_s(e.element):"Largest contentful paint",a={[An]:"auto.http.browser.lcp",[Cn]:"ui.webvital.lcp",[On]:0,"sentry.pageload.span_id":i,"sentry.report_event":s};e&&(e.element&&(a["lcp.element"]=_s(e.element)),e.id&&(a["lcp.id"]=e.id),e.url&&(a["lcp.url"]=e.url.trim().slice(0,200)),null!=e.loadTime&&(a["lcp.loadTime"]=e.loadTime),null!=e.renderTime&&(a["lcp.renderTime"]=e.renderTime),null!=e.size&&(a["lcp.size"]=e.size));const h=Qh({name:o,transaction:r,attributes:a,startTime:n});h&&(h.addEvent("lcp",{[Fn]:"millisecond",[_n]:t}),h.end(n))}(i,e,n,t),s()})}(i):qh(({metric:t})=>{const e=t.entries[t.entries.length-1];e&&(hc.lcp={value:t.value,unit:"millisecond"},rc=e)},!0),r=Vh("ttfb",({metric:t})=>{t.entries[t.entries.length-1]&&(hc.ttfb={value:t.value,unit:"millisecond"})},Wh,Dh),o=t?function(t){let e,i=0;if(!ec("layout-shift"))return;const s=zh(({metric:t})=>{const s=t.entries[t.entries.length-1];s&&(i=t.value,e=s)},!0);ic(t,(t,n)=>{!function(t,e,i,s){Qa&&Ji.log(`Sending CLS span (${t})`);const n=e?tc((nn()||0)+e.startTime):sn(),r=vn().getScopeData().transactionName,o=e?_s(e.sources[0]?.node):"Layout shift",a={[An]:"auto.http.browser.cls",[Cn]:"ui.webvital.cls",[On]:0,"sentry.pageload.span_id":i,"sentry.report_event":s};e?.sources&&e.sources.forEach((t,e)=>{a[`cls.source.${e+1}`]=_s(t.node)});const h=Qh({name:o,transaction:r,attributes:a,startTime:n});h&&(h.addEvent("cls",{[Fn]:"",[_n]:t}),h.end(n))}(i,e,n,t),s()})}(i):zh(({metric:t})=>{const e=t.entries[t.entries.length-1];e&&(hc.cls={value:t.value,unit:""},oc=e)},!0);return()=>{n?.(),r(),o?.()}}return()=>{}}({recordClsStandaloneSpans:h||!1,recordLcpStandaloneSpans:c||!1,client:t}),s&&function(){if(Zh()&&nn()){const t=jh(Pc)}}(),n&&Zh()&&nn()&&Lh("element",uc),o&&qi.PerformanceObserver&&PerformanceObserver.supportedEntryTypes&&PerformanceObserver.supportedEntryTypes.includes("long-animation-frame")?new PerformanceObserver(t=>{const e=fr();if(e)for(const i of t.getEntries()){if(!i.scripts[0])continue;const t=tc(nn()+i.startTime),{start_timestamp:s,op:n}=or(e);if("navigation"===n&&s&&t<s)continue;const r=tc(i.duration),o={[An]:"auto.ui.browser.metrics"},a=i.scripts[0],{invoker:h,invokerType:c,sourceURL:u,sourceFunctionName:l,sourceCharPosition:d}=a;o["browser.script.invoker"]=h,o["browser.script.invoker_type"]=c,u&&(o["code.filepath"]=u),l&&(o["code.function"]=l),-1!==d&&(o["browser.script.source_char_position"]=d),Kh(e,t,t+r,{name:"Main UI thread blocked",op:"ui.long-animation-frame",attributes:o})}}).observe({type:"long-animation-frame",buffered:!0}):r&&Lh("longtask",({entries:t})=>{const e=fr();if(!e)return;const{op:i,start_timestamp:s}=or(e);for(const n of t){const t=tc(nn()+n.startTime),r=tc(n.duration);"navigation"===i&&s&&t<s||Kh(e,t,t+r,{name:"Main UI thread blocked",op:"ui.long-task",attributes:{[An]:"auto.ui.browser.metrics"}})}}),a&&Lh("event",({entries:t})=>{const e=fr();if(e)for(const i of t)if("click"===i.name){const t=tc(nn()+i.startTime),s=tc(i.duration),n={name:_s(i.target),op:`ui.interaction.${i.name}`,startTime:t,attributes:{[An]:"auto.ui.browser.metrics"}},r=Os(i.target);r&&(n.attributes["ui.component_name"]=r),Kh(e,t,t+s,n)}}),x&&i){const t=()=>{_=sn()};addEventListener("click",t,{capture:!0}),addEventListener("keydown",t,{capture:!0,passive:!0})}function e(){const e=Yp(t);e&&!or(e).timestamp&&(Uc&&Ji.log(`[Tracing] Finishing current active span with op: ${or(e).op}`),e.setAttribute(In,"cancelled"),e.end())}t.on("startNavigationSpan",(i,s)=>{if(Sn()!==t)return;if(s?.isRedirect)return Uc&&Ji.warn("[Tracing] Detected redirect, navigation span will not be the root span, but a child span."),void P(t,{op:"navigation.redirect",...i},!1);_=void 0,e(),wn().setPropagationContext({traceId:an(),sampleRand:Math.random(),propagationSpanId:yr()?void 0:hn()});const n=vn();n.setPropagationContext({traceId:an(),sampleRand:Math.random(),propagationSpanId:yr()?void 0:hn()}),n.setSDKProcessingMetadata({normalizedRequest:void 0}),P(t,{op:"navigation",...i,parentSpan:null,forceTransaction:!0})}),t.on("startPageLoadSpan",(i,s={})=>{if(Sn()!==t)return;e();const n=function(t,e){const i=function(t){if(!t)return;const e=t.match(Kn);if(!e)return;let i;return"1"===e[3]?i=!0:"0"===e[3]&&(i=!1),{traceId:e[1],parentSampled:i,parentSpanId:e[2]}}(t),s=Gn(e);if(!i?.traceId)return{traceId:an(),sampleRand:Math.random()};const n=function(t,e){const i=Jn(e?.sample_rand);if(void 0!==i)return i;const s=Jn(e?.sample_rate);return s&&void 0!==t?.parentSampled?t.parentSampled?Math.random()*s:s+Math.random()*(1-s):Math.random()}(i,s);s&&(s.sample_rand=n.toString());const{traceId:r,parentSpanId:o,parentSampled:a}=i;return{traceId:r,parentSpanId:o,sampled:a,dsc:s||{},sampleRand:n}}(s.sentryTrace||Hp("sentry-trace"),s.baggage||Hp("baggage")),r=vn();r.setPropagationContext(n),yr()||(r.getPropagationContext().propagationSpanId=hn()),r.setSDKProcessingMetadata({normalizedRequest:ja()}),P(t,{op:"pageload",...i})}),t.on("endPageloadSpan",()=>{C&&R&&(R.setAttribute(In,"reportPageLoaded"),R.end())})},afterAllSetup(t){let i=Ps();if("off"!==T&&function(t,{linkPreviousTrace:e,consistentTraceSampling:i}){const s="session-storage"===e;let n=s?function(){try{const t=Da.sessionStorage?.getItem(Np);return JSON.parse(t)}catch{return}}():void 0;t.on("spanStart",t=>{if(pr(t)!==t)return;const e=vn().getPropagationContext();n=function(t,e,i){const s=or(e),n={spanContext:e.spanContext(),startTimestamp:s.start_timestamp,sampleRate:function(){try{return Number(i.dsc?.sample_rate)??Number(s.data?.[Tn])}catch{return 0}}(),sampleRand:i.sampleRand};if(!t)return n;const r=t.spanContext;return r.traceId===s.trace_id?t:(Date.now()/1e3-t.startTimestamp<=3600&&(Uc&&Ji.log(`Adding previous_trace ${r} link to span ${{op:s.op,...e.spanContext()}}`),e.addLink({context:r,attributes:{[Bn]:"previous_trace"}}),e.setAttribute("sentry.previous_trace",`${r.traceId}-${r.spanId}-${Gp(r)?1:0}`)),n)}(n,t,e),s&&function(t){try{Da.sessionStorage.setItem(Np,JSON.stringify(t))}catch(t){Uc&&Ji.warn("Could not store previous trace in sessionStorage",t)}}(n)});let r=!0;i&&t.on("beforeSampling",t=>{if(!n)return;const e=vn(),i=e.getPropagationContext();r&&i.parentSpanId?r=!1:(e.setPropagationContext({...i,dsc:{...i.dsc,sample_rate:String(n.sampleRate),sampled:String(Gp(n.spanContext))},sampleRand:n.sampleRand}),t.parentSampled=Gp(n.spanContext),t.parentSampleRate=n.sampleRate,t.spanAttributes={...t.spanAttributes,[En]:n.sampleRate})})}(t,{linkPreviousTrace:T,consistentTraceSampling:E}),Da.location){if(S){const e=nn();!function(t,e){t.emit("startPageLoadSpan",e,void 0),vn().setTransactionName(e.name);const i=Yp(t);i&&t.emit("afterStartPageLoadSpan",i)}(t,{name:Da.location.pathname,startTime:e?e/1e3:void 0,attributes:{[xn]:"url",[An]:"auto.pageload.browser"}})}k&&bc(({to:e,from:s})=>{if(void 0===s&&-1!==i?.indexOf(e))return void(i=void 0);i=void 0;const n=Qo(e),r=Yp(t),o=r&&x&&function(t,e){const i=or(t),s=en();return!(s-i.start_timestamp>Jp||e&&s-e<=Jp)}(r,_);!function(t,e,i){const{url:s,isRedirect:n}=i||{};t.emit("beforeStartNavigationSpan",e,{isRedirect:n}),t.emit("startNavigationSpan",e,{isRedirect:n});const r=vn();r.setTransactionName(e.name),s&&!n&&r.setSDKProcessingMetadata({normalizedRequest:{...ja(),url:s}}),Yp(t)}(t,{name:n?.pathname||Da.location.pathname,attributes:{[xn]:"url",[An]:"auto.navigation.browser"}},{url:e,isRedirect:o})})}f&&(Da.document?Da.document.addEventListener("visibilitychange",()=>{const t=fr();if(!t)return;const e=pr(t);if(Da.document.hidden&&e){const t="cancelled",{op:i,status:s}=or(e);Uc&&Ji.log(`[Tracing] Transaction: ${t} -> since tab moved to the background, op: ${i}`),s||e.setStatus({code:2,message:t}),e.setAttribute("sentry.cancellation_reason","document.hidden"),e.end()}}):Uc&&Ji.warn("[Tracing] Could not set up background tab detection due to lack of global document")),a&&function(t,e,i,s,n){let r;Da.document&&addEventListener("click",()=>{const o="ui.action.click",a=Yp(t);if(a){const t=or(a).op;if(["navigation","pageload"].includes(t))return void(Uc&&Ji.warn(`[Tracing] Did not create ${o} span because a pageload or navigation span is in progress.`))}r&&(r.setAttribute(In,"interactionInterrupted"),r.end(),r=void 0),n.name?r=io({name:n.name,op:o,attributes:{[xn]:n.source||"url"}},{idleTimeout:e,finalTimeout:i,childSpanTimeout:s}):Uc&&Ji.warn(`[Tracing] Did not create ${o} transaction because _latestRouteName is missing.`)},{capture:!0})}(t,l,d,p,e),s&&function(){const t=({entries:t})=>{const e=fr(),i=e&&pr(e);t.forEach(t=>{if(!function(t){return"duration"in t}(t)||!i)return;const e=t.interactionId;if(null!=e&&!_c.has(e)){if(Fc.length>10){const t=Fc.shift();_c.delete(t)}Fc.push(e),_c.set(e,i)}})};Lh("event",t),Lh("first-input",t)}(),function(t,e){const{traceFetch:i,traceXHR:s,trackFetchStreamPerformance:n,shouldCreateSpanForRequest:r,enableHTTPTimings:o,tracePropagationTargets:a,onRequestSpanStart:h,onRequestSpanEnd:c}={...jp,...e},u="function"==typeof r?r:t=>!0,l=t=>function(t,e){const i=Ps();if(i){let s,n;try{s=new URL(t,i),n=new URL(i).origin}catch{return!1}const r=s.origin===n;return e?zs(s.toString(),e)||r&&zs(s.pathname,e):r}{const i=!!t.match(/^\/(?!\/)/);return e?zs(t,e):i}}(t,a),d={},p=t.getOptions().propagateTraceparent;i&&(t.addEventProcessor(t=>("transaction"===t.type&&t.spans&&t.spans.forEach(t=>{if("http.client"===t.op){const e=qp.get(t.span_id);e&&(t.timestamp=e/1e3,qp.delete(t.span_id))}}),t)),n&&function(){const t="fetch-body-resolved";as(t,t=>{if(t.response){const e=zp.get(t.response);e&&t.endTimestamp&&qp.set(e,t.endTimestamp)}}),hs(t,()=>Fa(_a))}(),Ia(t=>{const e=function(t,e,i,s,n){if(!t.fetchData)return;const{method:r,url:o}=t.fetchData,a=yr()&&e(o);if(t.endTimestamp&&a){const e=t.fetchData.Ui;if(!e)return;const i=s[e];return void(i&&(function(t,e){if(e.response){Dn(t,e.response.status);const i=e.response?.headers?.get("content-length");if(i){const e=parseInt(i);e>0&&t.setAttribute("http.response_content_length",e)}}else e.error&&t.setStatus({code:2,message:"internal_error"});t.end()}(i,t),function(t,e,i){const s="object"==typeof i&&null!==i?i.onRequestSpanEnd:void 0;s?.(t,{headers:e.response?.headers,error:e.error})}(i,t,n),delete s[e]))}const{spanOrigin:h="auto.http.browser",propagateTraceparent:c=!1}=n,u=!!fr(),l=a&&u?Yr(function(t,e,i){const s=Qo(t);return{name:s?`${e} ${Zo(s)}`:e,attributes:Ta(t,s,e,i)}}(o,r,h)):new Ar;if(t.fetchData.Ui=l.spanContext().spanId,s[l.spanContext().spanId]=l,i(t.fetchData.url)){const e=t.args[0],i=t.args[1]||{},s=function(t,e,i,s){const n=sa({span:i,propagateTraceparent:s}),r=n["sentry-trace"],o=n.baggage,a=n.traceparent;if(!r)return;const h=e.headers||(Is(t)?t.headers:void 0);if(h){if(function(t){return"undefined"!=typeof Headers&&Cs(t,Headers)}(h)){const t=new Headers(h);if(t.get("sentry-trace")||t.set("sentry-trace",r),s&&a&&!t.get("traceparent")&&t.set("traceparent",a),o){const e=t.get("baggage");e?xa(e)||t.set("baggage",`${e},${o}`):t.set("baggage",o)}return t}if(Array.isArray(h)){const t=[...h];h.find(t=>"sentry-trace"===t[0])||t.push(["sentry-trace",r]),s&&a&&!h.find(t=>"traceparent"===t[0])&&t.push(["traceparent",a]);const e=h.find(t=>"baggage"===t[0]&&xa(t[1]));return o&&!e&&t.push(["baggage",o]),t}{const t="sentry-trace"in h?h["sentry-trace"]:void 0,e="traceparent"in h?h.traceparent:void 0,i="baggage"in h?h.baggage:void 0,n=i?Array.isArray(i)?[...i]:[i]:[],c=i&&(Array.isArray(i)?i.find(t=>xa(t)):xa(i));o&&!c&&n.push(o);const u={...h,"sentry-trace":t??r,baggage:n.length>0?n.join(","):void 0};return s&&a&&!e&&(u.traceparent=a),u}}return{...n}}(e,i,yr()&&u?l:void 0,c);s&&(t.args[1]=i,i.headers=s)}const d=Sn();if(d){const e={input:t.args,response:t.response,startTimestamp:t.startTimestamp,endTimestamp:t.endTimestamp};d.emit("beforeOutgoingRequestSpan",l,e)}return l}(t,u,l,d,{propagateTraceparent:p,onRequestSpanEnd:c});if(t.response&&t.fetchData.Ui&&zp.set(t.response,t.fetchData.Ui),e){const i=Dp(t.fetchData.url),s=i?ta(i).host:void 0;e.setAttributes({"http.url":i,"server.address":s}),o&&Lp(e),h?.(e,{headers:t.headers})}})),s&&xc(t=>{const e=function(t,e,i,s,n,r){const o=t.xhr,a=o?.[kc];if(!o||o.be||!a)return;const{url:h,method:c}=a,u=yr()&&e(h);if(t.endTimestamp&&u){const e=o.Wi;if(!e)return;const i=s[e];return void(i&&void 0!==a.status_code&&(Dn(i,a.status_code),i.end(),r?.(i,{headers:$p(Ic(o)),error:t.error}),delete s[e]))}const l=Dp(h),d=ta(l||h),p=h.split(/[?#]/,1)[0],f=!!fr(),m=u&&f?Yr({name:`${c} ${p}`,attributes:{url:h,type:"xhr","http.method":c,"http.url":l,"server.address":d?.host,[An]:"auto.http.browser",[Cn]:"http.client",...d?.search&&{"http.query":d?.search},...d?.hash&&{"http.fragment":d?.hash}}}):new Ar;o.Wi=m.spanContext().spanId,s[o.Wi]=m,i(h)&&function(t,e,i){const{"sentry-trace":s,baggage:n,traceparent:r}=sa({span:e,propagateTraceparent:i});s&&function(t,e,i,s){const n=t.Hi?.request_headers;if(!n?.["sentry-trace"]&&t.setRequestHeader)try{if(t.setRequestHeader("sentry-trace",e),s&&!n?.traceparent&&t.setRequestHeader("traceparent",s),i){const e=n?.baggage;e&&e.split(",").some(t=>t.trim().startsWith("sentry-"))||t.setRequestHeader("baggage",i)}}catch{}}(t,s,n,r)}(o,yr()&&f?m:void 0,n);const g=Sn();return g&&g.emit("beforeOutgoingRequestSpan",m,t),m}(t,u,l,d,p,c);e&&(o&&Lp(e),h?.(e,{headers:$p(t.xhr.Hi?.request_headers)}))})}(t,{traceFetch:m,traceXHR:g,trackFetchStreamPerformance:y,tracePropagationTargets:t.getOptions().tracePropagationTargets,shouldCreateSpanForRequest:b,enableHTTPTimings:v,onRequestSpanStart:A,onRequestSpanEnd:I})}}};function Hp(t){const e=Da.document,i=e?.querySelector(`meta[name=${t}]`);return i?.getAttribute("content")||void 0}const Vp="_sentry_idleSpan";function Yp(t){return t[Vp]}function Xp(t,e){js(t,Vp,e)}const Jp=1.5;class Kp{constructor(){this.A4_FREQUENCY=440,this.NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.INTERVALS={unison:0,minorSecond:1,majorSecond:2,minorThird:3,majorThird:4,perfectFourth:5,tritone:6,perfectFifth:7,minorSixth:8,majorSixth:9,minorSeventh:10,majorSeventh:11,octave:12},this.SCALES={major:[0,2,4,5,7,9,11],naturalMinor:[0,2,3,5,7,8,10],harmonicMinor:[0,2,3,5,7,8,11],melodicMinor:[0,2,3,5,7,9,11],ionian:[0,2,4,5,7,9,11],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],aeolian:[0,2,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],majorPentatonic:[0,2,4,7,9],minorPentatonic:[0,3,5,7,10],blues:[0,3,5,6,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],wholeHalfDiminished:[0,2,3,5,6,8,9,11],arabic:[0,1,4,5,7,8,11],japanese:[0,1,5,7,8],hungarian:[0,2,3,6,7,8,11],bebopMajor:[0,2,4,5,7,8,9,11]},this.CHORDS={major:[0,4,7],minor:[0,3,7],diminished:[0,3,6],augmented:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],min7b5:[0,3,6,10],dim7:[0,3,6,9],maj9:[0,4,7,11,14],min9:[0,3,7,10,14],dom9:[0,4,7,10,14],add9:[0,4,7,14],maj11:[0,4,7,11,14,17],min11:[0,3,7,10,14,17],maj13:[0,4,7,11,14,17,21],min13:[0,3,7,10,14,17,21]},this.EMOTION_MODES={excited:{scale:"lydian",tempo:140,dynamics:"forte",articulation:"staccato"},calm:{scale:"major",tempo:60,dynamics:"piano",articulation:"legato"},curious:{scale:"mixolydian",tempo:100,dynamics:"mezzoForte",articulation:"tenuto"},sleepy:{scale:"aeolian",tempo:50,dynamics:"pianissimo",articulation:"legato"},alert:{scale:"dorian",tempo:120,dynamics:"forte",articulation:"marcato"},pleased:{scale:"majorPentatonic",tempo:90,dynamics:"mezzoForte",articulation:"legato"},confused:{scale:"wholeHalfDiminished",tempo:80,dynamics:"mezzoPiano",articulation:"rubato"},energetic:{scale:"bebopMajor",tempo:160,dynamics:"fortissimo",articulation:"staccato"},melancholy:{scale:"harmonicMinor",tempo:70,dynamics:"mezzoPiano",articulation:"legato"},playful:{scale:"blues",tempo:110,dynamics:"mezzoForte",articulation:"swing"}},this.PROGRESSIONS={I_V_vi_IV:[1,5,6,4],I_IV_V:[1,4,5],ii_V_I:[2,5,1],I_vi_IV_V:[1,6,4,5],vi_IV_I_V:[6,4,1,5],I_VI_ii_V:[1,6,2,5],iii_vi_ii_V:[3,6,2,5],I_ii_iii_IV:[1,2,3,4],I_I_I_I_IV_IV_I_I_V_IV_I_V:[1,1,1,1,4,4,1,1,5,4,1,5],i_VII_VI_VII:[1,7,6,7],I_II_IV_I:[1,2,4,1]}}noteToMidi(t){const e=t.slice(0,-1),i=parseInt(t.slice(-1),10),s=this.NOTES.indexOf(e);if(-1===s)throw new Error(`Invalid note: ${t}`);return 12*(i+1)+s}midiToFrequency(t){return this.A4_FREQUENCY*Math.pow(2,(t-69)/12)}noteToFrequency(t){return this.midiToFrequency(this.noteToMidi(t))}generateScale(t,e="major"){const i=this.SCALES[e];if(!i)throw new Error(`Unknown scale type: ${e}`);const s=this.noteToMidi(t);return i.map(t=>this.midiToFrequency(s+t))}generateChord(t,e="major"){const i=this.CHORDS[e];if(!i)throw new Error(`Unknown chord type: ${e}`);const s=this.noteToMidi(t);return i.map(t=>this.midiToFrequency(s+t))}generateProgression(t,e="major",i=this.PROGRESSIONS.I_V_vi_IV){const s=this.generateScale(t,e),n=[];for(const t of i){const i=s[(t-1)%s.length];let r="major";"major"===e?2===t||3===t||6===t?r="minor":7===t&&(r="diminished"):"naturalMinor"===e&&(r=1===t||4===t||5===t?"minor":2===t?"diminished":"major");const o=Math.round(12*Math.log2(i/this.A4_FREQUENCY)+69),a=Math.floor(o/12)-1,h=o%12,c=this.NOTES[h]+a;n.push({degree:t,root:i,frequencies:this.generateChord(c,r),type:r})}return n}getEmotionMusic(t){return this.EMOTION_MODES[t]||this.EMOTION_MODES.calm}circleOfFifths(t="C",e=12,i=!0){const s=t.replace(/\d/,"");let n=this.NOTES.indexOf(s);const r=[t];for(let t=1;t<e;t++)n=i?(n+7)%12:(n+5)%12,r.push(this.NOTES[n]);return r}analyzeInterval(t,e){const i=this.noteToMidi(t),s=this.noteToMidi(e),n=Math.abs(s-i);let r="unknown";for(const[t,e]of Object.entries(this.INTERVALS))if(e===n%12){r=t;break}return{semitones:n,intervalName:r,octaves:Math.floor(n/12),consonant:[0,3,4,5,7,8,9,12].includes(n%12),ratio:this.getIntervalRatio(n%12)}}getIntervalRatio(t){return{0:"1:1",1:"16:15",2:"9:8",3:"6:5",4:"5:4",5:"4:3",6:"45:32",7:"3:2",8:"8:5",9:"5:3",10:"16:9",11:"15:8",12:"2:1"}[t]||"complex"}generateMelody(t={}){const{key:e="C4",scale:i="major",length:s=8,stepProbability:n=.7,restProbability:r=.1}=t,o=this.generateScale(e,i),a=[];let h=0;for(let t=0;t<s;t++){if(Math.random()<r){a.push({frequency:0,duration:.25,isRest:!0});continue}let t;if(Math.random()<n){const e=Math.random()<.5?-1:1;t=Math.max(0,Math.min(o.length-1,h+e))}else{const e=Math.floor(3*Math.random())+2,i=Math.random()<.5?-1:1;t=Math.max(0,Math.min(o.length-1,h+e*i))}h=t;const e=[.25,.5,.75,1],i=e[Math.floor(Math.random()*e.length)];a.push({frequency:o[h],duration:i,isRest:!1})}return a}}class Qp{constructor(t){this.audioContext=t,this.musicTheory=new Kp,this.currentKey="C4",this.currentScale="major",this.currentTempo=120,this.currentEmotion="calm",this.voices=new Map,this.layers={bass:{active:!1,gain:.3},chord:{active:!1,gain:.2},melody:{active:!1,gain:.4},pad:{active:!1,gain:.15}},this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.audioContext.destination),this.reverb=this.createReverb(),this.delay=this.createDelay(),this.filter=this.createFilter(),this.filter.connect(this.delay),this.delay.connect(this.reverb),this.reverb.connect(this.masterGain),this.dryGain=this.audioContext.createGain(),this.dryGain.gain.value=.7,this.dryGain.connect(this.masterGain),this.wetGain=this.audioContext.createGain(),this.wetGain.gain.value=.3,this.wetGain.connect(this.filter),this.nextNoteTime=0,this.noteResolution=0,this.noteLength=.05,this.currentChordIndex=0,this.currentMelodyNote=0,this.progression=null,this.isPlaying=!1,this.lookahead=25,this.scheduleAheadTime=.1}createReverb(){const t=this.audioContext.createConvolver(),e=2*this.audioContext.sampleRate,i=this.audioContext.createBuffer(2,e,this.audioContext.sampleRate);for(let t=0;t<2;t++){const s=i.getChannelData(t);for(let t=0;t<e;t++)s[t]=(2*Math.random()-1)*Math.pow(1-t/e,2)}return t.buffer=i,t}createDelay(){const t=this.audioContext.createDelay(1);t.delayTime.value=.15;const e=this.audioContext.createGain();return e.gain.value=.3,t.connect(e),e.connect(t),t}createFilter(){const t=this.audioContext.createBiquadFilter();return t.type="lowpass",t.frequency.value=2e3,t.Q.value=1,t}setEmotion(t){this.currentEmotion=t;const e=this.musicTheory.getEmotionMusic(t);this.currentScale=e.scale,this.currentTempo=e.tempo;const i={excited:{freq:4e3,Q:2},calm:{freq:1500,Q:.7},curious:{freq:2500,Q:1.5},sleepy:{freq:800,Q:.5},alert:{freq:3e3,Q:1.8},energetic:{freq:5e3,Q:2.5}}[t]||{freq:2e3,Q:1};this.filter.frequency.exponentialRampToValueAtTime(i.freq,this.audioContext.currentTime+.5),this.filter.Q.linearRampToValueAtTime(i.Q,this.audioContext.currentTime+.5),this.generateEmotionProgression()}generateEmotionProgression(){const t={excited:"I_V_vi_IV",calm:"I_vi_IV_V",curious:"ii_V_I",sleepy:"vi_IV_I_V",alert:"I_IV_V",energetic:"I_V_vi_IV"}[this.currentEmotion]||"I_V_vi_IV";this.progression=this.musicTheory.generateProgression(this.currentKey,this.currentScale,this.musicTheory.PROGRESSIONS[t])}playChord(t,e=1,i=.01){const s=this.audioContext.currentTime,n=this.audioContext.createGain();n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(this.layers.chord.gain,s+i),n.gain.exponentialRampToValueAtTime(.01,s+e),n.connect(this.dryGain),n.connect(this.wetGain);const r=t.map((t,i)=>{const r=this.audioContext.createOscillator();return r.frequency.value=t,r.type=0===i?"sine":1===i?"triangle":"sawtooth",r.detune.value=10*(Math.random()-.5),r.connect(n),r.start(s),r.stop(s+e),r}),o=`chord_${Date.now()}`;this.voices.set(o,{oscillators:r,gain:n}),setTimeout(()=>{this.voices.delete(o)},1e3*(e+.1))}playMelody(t,e=0){let i=e||this.audioContext.currentTime;t.forEach((t,e)=>{if(t.isRest)return void(i+=t.duration);const s=this.audioContext.createOscillator(),n=this.audioContext.createGain();s.frequency.value=t.frequency,s.type="sine";const r=this.audioContext.createOscillator(),o=this.audioContext.createGain();r.frequency.value=5,o.gain.value=5,r.connect(o),o.connect(s.frequency),n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(this.layers.melody.gain,i+.01),n.gain.exponentialRampToValueAtTime(.01,i+.9*t.duration),s.connect(n),n.connect(this.dryGain),n.connect(this.wetGain),s.start(i),s.stop(i+t.duration),r.start(i),r.stop(i+t.duration),i+=t.duration})}createPad(t,e=4){const i=this.audioContext.currentTime,s=this.audioContext.createGain();s.gain.setValueAtTime(0,i),s.gain.linearRampToValueAtTime(this.layers.pad.gain,i+1),s.gain.linearRampToValueAtTime(this.layers.pad.gain,i+e-1),s.gain.linearRampToValueAtTime(0,i+e),s.connect(this.wetGain);for(let n=0;n<4;n++){const r=this.audioContext.createOscillator();r.frequency.value=t,r.type="sawtooth",r.detune.value=15*(n-2);const o=this.audioContext.createGain();o.gain.value=1/4;const a=this.audioContext.createOscillator(),h=this.audioContext.createGain();a.frequency.value=.2+.1*n,h.gain.value=10,a.connect(h),h.connect(r.frequency),r.connect(o),o.connect(s),r.start(i),r.stop(i+e),a.start(i),a.stop(i+e)}}playGestureSound(t){const e={breathe:()=>{const t=this.musicTheory.generateChord(this.currentKey,"maj7");this.playChord(t,2,.5),this.createPad(t[0]/2,3)},excited:()=>{const t=this.musicTheory.generateScale(this.currentKey,"lydian").map((t,e)=>({frequency:t,duration:.1,isRest:!1}));this.playMelody(t)},wave:()=>{const t=this.musicTheory.noteToFrequency(this.currentKey),e=2*t,i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.frequency.setValueAtTime(t,this.audioContext.currentTime),i.frequency.exponentialRampToValueAtTime(e,this.audioContext.currentTime+.5),i.frequency.exponentialRampToValueAtTime(t,this.audioContext.currentTime+1),s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.1),s.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.9),s.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+1),i.connect(s),s.connect(this.wetGain),i.start(),i.stop(this.audioContext.currentTime+1)},morph:()=>{const t=this.musicTheory.generateChord(this.currentKey,"minor"),e=this.musicTheory.generateChord(this.currentKey,"major");this.playChord(t,.5),setTimeout(()=>{this.playChord(e,1)},400)},jump:()=>{const t=this.musicTheory.generateChord(this.currentKey,"dom7");for(let e=0;e<3;e++)setTimeout(()=>{this.playChord(t.map(t=>t*Math.pow(2,e/12)),.1,.001)},100*e)},curious:()=>{const t=this.musicTheory.generateMelody({key:this.currentKey,scale:"mixolydian",length:5,stepProbability:.3});this.playMelody(t)}}[t];e&&e()}startHarmony(){this.isPlaying||(this.isPlaying=!0,this.currentChordIndex=0,this.nextNoteTime=this.audioContext.currentTime,this.generateEmotionProgression(),this.scheduleHarmony())}scheduleHarmony(){if(this.isPlaying){for(;this.nextNoteTime<this.audioContext.currentTime+this.scheduleAheadTime;){if(this.progression&&this.layers.chord.active){const t=this.progression[this.currentChordIndex];this.playChord(t.frequencies,.5),this.currentChordIndex=(this.currentChordIndex+1)%this.progression.length}if(this.layers.bass.active&&this.progression){const t=this.progression[this.currentChordIndex].frequencies[0]/2;this.playBassNote(t,.25)}const t=60/this.currentTempo;this.nextNoteTime+=.25*t}setTimeout(()=>this.scheduleHarmony(),this.lookahead)}}playBassNote(t,e){const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.frequency.value=t,i.type="sine",s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.linearRampToValueAtTime(this.layers.bass.gain,this.audioContext.currentTime+.01),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+e),i.connect(s),s.connect(this.dryGain),i.start(),i.stop(this.audioContext.currentTime+e)}stopHarmony(){this.isPlaying=!1}setLayerActive(t,e){this.layers[t]&&(this.layers[t].active=e)}setMasterVolume(t){this.masterGain.gain.exponentialRampToValueAtTime(Math.max(.01,t),this.audioContext.currentTime+.1)}setEffectsMix(t){const e=1-t;this.dryGain.gain.linearRampToValueAtTime(e,this.audioContext.currentTime+.1),this.wetGain.gain.linearRampToValueAtTime(t,this.audioContext.currentTime+.1)}}class Zp{constructor(){this.context=null,this.isEnabled=!1,this.isInitialized=!1,this.nodes={master:null,ambient:null,effects:null},this.harmonicSystem=null,this.useHarmonicSystem=!1,this.warningTimestamps={},this.warningThrottle=5e3,this.currentOscillator=null,this.currentGain=null,this.masterVolume=.5,this.ambientVolume=.1,this.emotionalTones=new Map([["neutral",{frequency:220,waveform:"sine",volume:.1}],["joy",{frequency:440,waveform:"triangle",volume:.15}],["sadness",{frequency:165,waveform:"sine",volume:.08}],["anger",{frequency:330,waveform:"sawtooth",volume:.12}],["fear",{frequency:880,waveform:"square",volume:.09}],["surprise",{frequency:660,waveform:"triangle",volume:.13}],["disgust",{frequency:110,waveform:"sawtooth",volume:.07}],["love",{frequency:528,waveform:"sine",volume:.11}]])}initialize(){try{const t=window.AudioContext||window.webkitAudioContext;return!!t&&(this.context=new t,this.harmonicSystem=new Qp(this.context),this.nodes.master=this.context.createGain(),this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),this.nodes.master.connect(this.context.destination),this.nodes.effects=this.context.createGain(),this.nodes.effects.gain.setValueAtTime(1,this.context.currentTime),this.nodes.effects.connect(this.nodes.master),this.isEnabled=!0,this.isInitialized=!0,!0)}catch{return this.isEnabled=!1,!1}}async resumeContext(){if(this.context&&"suspended"===this.context.state)try{await this.context.resume()}catch{}}setMasterVolume(t,e=null){this.masterVolume=Math.max(0,Math.min(1,t)),this.isEnabled&&this.nodes.master&&(this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),e&&this.updateAmbientVolume(e))}getMasterVolume(){return this.masterVolume}isAvailable(){return this.isEnabled&&this.isInitialized}setHarmonicMode(t){this.useHarmonicSystem=t,t&&this.harmonicSystem?this.stopAmbientTone():!t&&this.harmonicSystem&&this.harmonicSystem.stopHarmony()}startHarmony(){this.harmonicSystem&&this.useHarmonicSystem&&this.isAvailable()&&this.harmonicSystem.startHarmony()}stopHarmony(){this.harmonicSystem&&this.harmonicSystem.stopHarmony()}setHarmonicLayer(t,e){this.harmonicSystem&&this.harmonicSystem.setLayerActive(t,e)}setHarmonicEffects(t){this.harmonicSystem&&this.harmonicSystem.setEffectsMix(t)}cleanup(){try{this.currentOscillator&&(this.currentOscillator.stop(),this.currentOscillator=null),this.currentGain&&(this.currentGain=null),this.context&&"closed"!==this.context.state&&this.context.close()}catch{}finally{this.context=null,this.nodes={master:null,ambient:null,effects:null},this.currentOscillator=null,this.currentGain=null,this.isEnabled=!1,this.isInitialized=!1}}getEmotionalTone(t){return this.emotionalTones.get(t)||null}setAmbientTone(t,e=500){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.setEmotion(t);const i=this.getEmotionalTone(t);if(i)try{this.resumeContext();const{currentTime:t}=this.context,s=e/1e3;this.currentOscillator&&this.currentGain&&(this.currentGain.gain.exponentialRampToValueAtTime(.001,t+.5*s),this.currentOscillator.stop(t+.5*s));const n=this.context.createOscillator(),r=this.context.createGain();n.type=i.waveform,n.frequency.setValueAtTime(i.frequency,t);const o=i.volume*this.masterVolume;r.gain.setValueAtTime(.001,t),r.gain.exponentialRampToValueAtTime(o,t+s),n.connect(r),r.connect(this.nodes.master),n.start(t),this.currentOscillator=n,this.currentGain=r}catch{}}stopAmbientTone(t=500){if(this.isAvailable()&&this.currentOscillator)try{const{currentTime:e}=this.context,i=t/1e3;this.currentGain&&this.currentGain.gain.exponentialRampToValueAtTime(.001,e+i),this.currentOscillator.stop(e+i),this.currentOscillator=null,this.currentGain=null}catch{}}updateAmbientVolume(t){if(!this.isAvailable()||!this.currentGain||!t)return;const e=this.getEmotionalTone(t);if(e)try{const t=e.volume*this.masterVolume,{currentTime:i}=this.context;this.currentGain.gain.exponentialRampToValueAtTime(t,i+.1)}catch{}}playGestureSound(t,e="neutral"){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.playGestureSound(t);const i=this.getGestureSoundConfig(t);if(i)try{this.resumeContext();const{currentTime:t}=this.context,s=i.duration/1e3,n=this.getEmotionalModifiers(e),r=i.volume*this.masterVolume*n.intensity,o=this.context.createOscillator(),a=this.context.createGain();o.type=i.waveform,this.applyFrequencyEnvelope(o,i.frequencyEnvelope,t,s),this.applyVolumeEnvelope(a,i.volumeEnvelope,t,s,r),o.connect(a),a.connect(this.nodes.effects),o.start(t),o.stop(t+s)}catch{}else this.throttledWarn(`Unknown gesture "${t}", cannot play sound`,`gesture_${t}`)}getGestureSoundConfig(t){return new Map([["bounce",{duration:100,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:200},{time:.5,frequency:400},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.8},{time:1,volume:0}]}],["pulse",{duration:300,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:450},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["shake",{duration:200,waveform:"sawtooth",volume:.2,frequencyEnvelope:[{time:0,frequency:150},{time:.25,frequency:200},{time:.5,frequency:150},{time:.75,frequency:200},{time:1,frequency:150}],volumeEnvelope:[{time:0,volume:.8},{time:.5,volume:1},{time:1,volume:0}]}],["spin",{duration:600,waveform:"triangle",volume:.35,frequencyEnvelope:[{time:0,frequency:220},{time:.3,frequency:440},{time:.7,frequency:660},{time:1,frequency:330}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["nod",{duration:150,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:180},{time:.5,frequency:220},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:1,volume:0}]}],["tilt",{duration:200,waveform:"triangle",volume:.18,frequencyEnvelope:[{time:0,frequency:250},{time:.6,frequency:350},{time:1,frequency:280}],volumeEnvelope:[{time:0,volume:0},{time:.4,volume:1},{time:1,volume:0}]}],["expand",{duration:500,waveform:"sine",volume:.4,frequencyEnvelope:[{time:0,frequency:200},{time:.7,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.9,volume:.8},{time:1,volume:0}]}],["contract",{duration:400,waveform:"triangle",volume:.22,frequencyEnvelope:[{time:0,frequency:400},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:1},{time:.6,volume:.8},{time:1,volume:0}]}],["flash",{duration:200,waveform:"square",volume:.3,frequencyEnvelope:[{time:0,frequency:800},{time:.1,frequency:1200},{time:.2,frequency:800},{time:1,frequency:600}],volumeEnvelope:[{time:0,volume:0},{time:.05,volume:1},{time:.15,volume:.3},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.6,frequency:400},{time:1,frequency:350}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.7,volume:.6},{time:1,volume:0}]}],["breathe",{duration:800,waveform:"triangle",volume:.6,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.5,frequency:600},{time:.7,frequency:400},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.2},{time:.2,volume:1},{time:.5,volume:.9},{time:.8,volume:.7},{time:1,volume:0}]}],["morph",{duration:600,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.2,frequency:300},{time:.5,frequency:600},{time:.8,frequency:400},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:.7,volume:.8},{time:1,volume:0}]}],["jump",{duration:250,waveform:"square",volume:.35,frequencyEnvelope:[{time:0,frequency:200},{time:.2,frequency:600},{time:.4,frequency:800},{time:.8,frequency:400},{time:1,frequency:100}],volumeEnvelope:[{time:0,volume:.8},{time:.1,volume:1},{time:.3,volume:.6},{time:1,volume:0}]}],["drift",{duration:800,waveform:"sine",volume:.12,frequencyEnvelope:[{time:0,frequency:160},{time:.4,frequency:240},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:200},{time:.25,frequency:300},{time:.5,frequency:250},{time:.75,frequency:280},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.8,volume:.8},{time:1,volume:0}]}],["breathe",{duration:3500,waveform:"sine",volume:.2,frequencyEnvelope:[{time:0,frequency:80},{time:.4,frequency:150},{time:.5,frequency:160},{time:.9,frequency:100},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:.3},{time:.4,volume:.8},{time:.5,volume:.7},{time:.9,volume:.6},{time:1,volume:.2}]}],["flicker",{duration:300,waveform:"square",volume:.2,frequencyEnvelope:[{time:0,frequency:600},{time:.1,frequency:400},{time:.2,frequency:800},{time:.3,frequency:300},{time:.5,frequency:700},{time:1,frequency:500}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.2},{time:.2,volume:.9},{time:.3,volume:.3},{time:.5,volume:.8},{time:1,volume:0}]}],["vibrate",{duration:250,waveform:"sawtooth",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.1,frequency:150},{time:.2,frequency:100},{time:.3,frequency:150},{time:.4,frequency:100},{time:.5,frequency:150},{time:.6,frequency:100},{time:.7,frequency:150},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:1},{time:.8,volume:1},{time:1,volume:0}]}],["glow",{duration:600,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["stretch",{duration:450,waveform:"triangle",volume:.2,frequencyEnvelope:[{time:0,frequency:250},{time:.3,frequency:180},{time:.7,frequency:320},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.6},{time:.2,volume:1},{time:.8,volume:.9},{time:1,volume:0}]}]]).get(t)||null}applyFrequencyEnvelope(t,e,i,s){e.forEach(e=>{const n=i+e.time*s;t.frequency.linearRampToValueAtTime(e.frequency,n)})}applyVolumeEnvelope(t,e,i,s,n){e.forEach((e,r)=>{const o=i+e.time*s,a=e.volume*n;0===r?t.gain.setValueAtTime(a,o):t.gain.linearRampToValueAtTime(a,o)})}getEmotionalModifiers(t){const e=new Map([["neutral",{intensity:1,speed:1}],["joy",{intensity:1.3,speed:1.2}],["sadness",{intensity:.6,speed:.8}],["anger",{intensity:1.5,speed:1.4}],["fear",{intensity:.8,speed:1.3}],["surprise",{intensity:1.4,speed:1.5}],["disgust",{intensity:.7,speed:.9}],["love",{intensity:1.1,speed:.9}]]);return e.get(t)||e.get("neutral")}setQualityReduction(t){this.qualityReduction=t,t&&this.audioContext?this.maxOscillators=2:this.maxOscillators=4}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}throttledWarn(t,e){const i=Date.now();i-(this.warningTimestamps[e]||0)>this.warningThrottle&&(this.warningTimestamps[e]=i)}}class tf{constructor(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.smoothingFactor=.9,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.maxFrameTimeSamples=10,this.averageFrameTime=0}update(t){for(;this.timestamps.length>0&&this.timestamps[0]<=t-1e3;)this.timestamps.shift();if(this.timestamps.push(t),this.fps=this.timestamps.length,0===this.smoothedFPS?this.smoothedFPS=this.fps:this.smoothedFPS=this.smoothedFPS*this.smoothingFactor+this.fps*(1-this.smoothingFactor),this.lastFrameTime>0&&(this.frameTime=t-this.lastFrameTime,this.frameTimes.push(this.frameTime),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift(),this.frameTimes.length>0)){const t=this.frameTimes.reduce((t,e)=>t+e,0);this.averageFrameTime=t/this.frameTimes.length}this.lastFrameTime=t}getFPS(){return Math.round(this.fps)}getSmoothedFPS(){return Math.round(this.smoothedFPS)}getFrameTime(){return this.frameTime}getAverageFrameTime(){return this.averageFrameTime}reset(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.averageFrameTime=0}getMetrics(){return{fps:this.getFPS(),smoothedFPS:this.getSmoothedFPS(),frameTime:this.getFrameTime(),averageFrameTime:this.getAverageFrameTime(),status:this.fps>=55?"good":this.fps>=30?"okay":"poor"}}}class ef{constructor(t,e={}){this.errorBoundary=t,this.config=e,this.config.targetFPS=e.targetFPS||60,this.isRunning=!1,this.animationFrameId=null,this.loopCallbackId=null,this.lastFrameTime=0,this.deltaTime=0,this.isPaused=!1,this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleWindowBlur=this.handleWindowBlur.bind(this),this.handleWindowFocus=this.handleWindowFocus.bind(this),"undefined"!=typeof document&&(document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("blur",this.handleWindowBlur),window.addEventListener("focus",this.handleWindowFocus)),this.performanceMonitor=null,this.fpsCounter=new tf,this.subsystems={},this.eventCallback=null,this.parentMascot=null}setSubsystems(t){this.subsystems={stateMachine:t.stateMachine,particleSystem:t.particleSystem,renderer:t.renderer,soundSystem:t.soundSystem,canvasManager:t.canvasManager};const e=["stateMachine","particleSystem","renderer"];for(const t of e)if(!this.subsystems[t])throw new Error(`Required subsystem '${t}' not provided`);this.performanceMonitor&&this.performanceMonitor.setSubsystems(this.subsystems)}setEventCallback(t){if("function"!=typeof t)throw new Error("Event callback must be a function");this.eventCallback=t}setParentMascot(t){this.parentMascot=t}emit(t,e=null){this.eventCallback&&this.eventCallback(t,e)}start(){return this.errorBoundary.wrap(()=>{if(this.isRunning)return!1;if(!this.subsystems.stateMachine)throw new Error("Cannot start animation without subsystems configured");return this.isRunning=!0,this.lastFrameTime=performance.now(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.resumeContext(),this.loopCallbackId=ai.register((t,e)=>this.animate(t,e),0,this),this.emit("animationStarted",{targetFPS:this.targetFPS}),!0},"animation-start")()}stop(){return this.errorBoundary.wrap(()=>!!this.isRunning&&(this.isRunning=!1,this.loopCallbackId&&(ai.unregister(this.loopCallbackId),this.loopCallbackId=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.subsystems.renderer&&this.subsystems.renderer.stopAllGestures&&this.subsystems.renderer.stopAllGestures(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.stopAmbientTone(),this.subsystems.particleSystem&&this.subsystems.particleSystem.clear(),this.emit("animationStopped"),!0),"animation-stop")()}handleWindowBlur(){document.hidden||this.handleVisibilityChange()}handleWindowFocus(){!document.hidden&&this.isPaused&&this.handleVisibilityChange()}handleVisibilityChange(){if(document.hidden)this.wasRunning=this.isRunning,this.isPaused=!0,this.pauseTime=performance.now(),this.subsystems?.particleSystem&&(this.subsystems.particleSystem.resetAccumulator(),this.pausedParticleCount=this.subsystems.particleSystem.particles?.length||0),this.subsystems?.renderer?.gestureAnimator&&this.subsystems.renderer.gestureAnimator.pauseCurrentAnimation?.(),this.parentMascot?.pause&&this.parentMascot.pause();else if(this.isPaused&&this.wasRunning){const t=performance.now(),e=t-this.pauseTime;if(this.lastFrameTime=t,this.frameTimeAccumulator=0,this.fpsCounter&&this.fpsCounter.reset(),this.subsystems?.particleSystem)if(this.subsystems.particleSystem.resetAccumulator(),e>3e4)this.subsystems.particleSystem.particles=[];else if(e>1e4){const t=Math.max(10,Math.floor(.5*this.pausedParticleCount));for(;this.subsystems.particleSystem.particles.length>t;)this.subsystems.particleSystem.removeParticle(0)}this.renderer&&(e>3e4&&this.renderer.resetCanvasContext(),this.renderer.gestureAnimator&&this.renderer.gestureAnimator.resumeAnimation?.(),e>3e4&&(this.renderer.forceCleanRender=!0)),this.subsystems?.stateMachine&&(this.subsystems.stateMachine.lastUpdateTime=t),this.parentMascot?.resume&&this.parentMascot.resume(),this.isPaused=!1,this.performanceMonitor}}animate(t,e){if(!this.isRunning||this.isPaused)return;const i=e||performance.now();this.deltaTime=t||i-this.lastFrameTime,this.deltaTime>20&&(this.deltaTime=20),this.deltaTime>16.67&&this.deltaTime<20&&(this.deltaTime=16.67),this.lastFrameTime=i,this.update(this.deltaTime),this.render()}update(t){if(this.subsystems.stateMachine&&this.subsystems.stateMachine.update(t),this.parentMascot&&"function"==typeof this.parentMascot.update&&this.parentMascot.update(t),"classic"!==this.parentMascot?.config?.renderingStyle&&this.subsystems.particleSystem&&this.subsystems.stateMachine&&this.subsystems.canvasManager){const e=this.subsystems.stateMachine.getCurrentEmotionalProperties();let i;i=this.subsystems.renderer&&"function"==typeof this.subsystems.renderer.getEffectiveCenter?this.subsystems.renderer.getEffectiveCenter():this.subsystems.canvasManager.getCenter();let s=null,n=0;if(this.subsystems.renderer&&this.subsystems.renderer.getCurrentGesture){const t=this.subsystems.renderer.getCurrentGesture();t&&t.particleMotion&&(s=t.particleMotion,n=t.progress||0)}this.subsystems.particleSystem.spawn(e.particleBehavior,this.subsystems.stateMachine.getCurrentState().emotion,e.particleRate,i.x,i.y,t),this.subsystems.particleSystem.update(t,i.x,i.y,s,n)}this.performanceMonitor&&this.performanceMonitor.updateMetrics({particleCount:this.subsystems.particleSystem?.getActiveParticleCount?.()||0,audioLatency:this.subsystems.soundSystem?.getLatency?.()||0})}render(){this.parentMascot&&"function"==typeof this.parentMascot.render?this.parentMascot.render():this.subsystems.renderer&&this.subsystems.renderer.render()}getPerformanceMetrics(){const t=this.fpsCounter?this.fpsCounter.getMetrics():{};return{fps:t.fps||60,instantFps:t.smoothedFPS||60,frameTime:t.frameTime||16.67,averageFrameTime:t.averageFrameTime||16.67,isRunning:this.isRunning,deltaTime:this.deltaTime}}setTargetFPS(t){}get targetFPS(){return this.config.targetFPS||60}isAnimating(){return this.isRunning}destroy(){this.stop(),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("blur",this.handleWindowBlur),window.removeEventListener("focus",this.handleWindowFocus)),this.performanceMonitor&&(this.performanceMonitor.destroy(),this.performanceMonitor=null),this.subsystems={},this.eventCallback=null}}class sf{constructor(t={}){this.config={spikeThreshold:t.spikeThreshold||1.5,minimumSpikeLevel:t.minimumSpikeLevel||.1,spikeMinInterval:t.spikeMinInterval||1e3,historySize:t.historySize||10,smoothingTimeConstant:t.smoothingTimeConstant||.8,fftSize:t.fftSize||256,levelUpdateThrottle:t.levelUpdateThrottle||100,...t},this.audioContext=null,this.analyser=null,this.dataArray=null,this.currentLevel=0,this.levelHistory=[],this.isActive=!1,this.lastVolumeSpike=0,this.lastLevelEmit=0,this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}initialize(t){try{if(!t)throw new Error("AudioContext is required for audio level processing");if("function"!=typeof t.createAnalyser)throw new Error("Invalid AudioContext provided");return this.audioContext=t,this.analyser=t.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.isActive=!0,"suspended"===t.state&&t.resume().catch(t=>{this.emitError("Failed to resume AudioContext",t)}),!0}catch(t){return this.emitError("Failed to initialize AudioLevelProcessor",t),!1}}cleanup(){try{this.isActive=!1,this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.lastLevelEmit=0,this.audioContext=null,this.analyser=null,this.dataArray=null}catch(t){this.emitError("Error during AudioLevelProcessor cleanup",t)}}updateAudioLevel(t=16){if(this.isActive&&this.analyser&&this.dataArray)try{this.analyser.getByteFrequencyData(this.dataArray);const t=this.calculateRMS();this.currentLevel=Math.min(1,2*t),this.updateLevelHistory(),this.detectVolumeSpikes(),this.emitLevelUpdate()}catch(t){this.emitError("Error updating audio level",t),this.currentLevel=0}}calculateRMS(){if(!this.dataArray||0===this.dataArray.length)return 0;let t=0;for(let e=0;e<this.dataArray.length;e++){const i=this.dataArray[e]/255;t+=i*i}return Math.sqrt(t/this.dataArray.length)}updateLevelHistory(){this.levelHistory.push(this.currentLevel),this.levelHistory.length>this.config.historySize&&this.levelHistory.shift()}detectVolumeSpikes(){if(this.levelHistory.length<5)return;const t=performance.now();if(t-this.lastVolumeSpike<this.config.spikeMinInterval)return;const e=this.levelHistory.slice(0,-1),i=e.reduce((t,e)=>t+e,0)/e.length;this.currentLevel>=i*this.config.spikeThreshold&&i>=this.config.minimumSpikeLevel&&this.currentLevel>=2*this.config.minimumSpikeLevel&&(this.lastVolumeSpike=t,this.emitVolumeSpike({level:this.currentLevel,previousAverage:i,spikeRatio:this.currentLevel/i,timestamp:t,threshold:this.config.spikeThreshold,minimumLevel:this.config.minimumSpikeLevel}))}clearHistory(){this.levelHistory=[]}getCurrentLevel(){return this.currentLevel}getLevelHistory(){return[...this.levelHistory]}getAnalyser(){return this.analyser}getFrequencyData(){return this.dataArray?new Uint8Array(this.dataArray):null}isProcessingActive(){return this.isActive}onLevelUpdate(t){if("function"!=typeof t)throw new Error("Level update callback must be a function");this.callbacks.levelUpdate=t}onVolumeSpike(t){if("function"!=typeof t)throw new Error("Volume spike callback must be a function");this.callbacks.volumeSpike=t}onError(t){if("function"!=typeof t)throw new Error("Error callback must be a function");this.callbacks.error=t}removeAllCallbacks(){this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}updateConfig(t){this.config={...this.config,...t},this.analyser&&(t.fftSize&&(this.analyser.fftSize=this.config.fftSize,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount)),void 0!==t.smoothingTimeConstant&&(this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant))}getConfig(){return{...this.config}}getStats(){return{isActive:this.isActive,currentLevel:this.currentLevel,historySize:this.levelHistory.length,maxHistorySize:this.config.historySize,lastSpikeTime:this.lastVolumeSpike,timeSinceLastSpike:this.lastVolumeSpike>0?performance.now()-this.lastVolumeSpike:0,averageLevel:this.levelHistory.length>0?this.levelHistory.reduce((t,e)=>t+e,0)/this.levelHistory.length:0}}emitLevelUpdate(){const t=performance.now();if(!(t-this.lastLevelEmit<this.config.levelUpdateThrottle)&&(this.lastLevelEmit=t,this.callbacks.levelUpdate))try{this.callbacks.levelUpdate({level:this.currentLevel,rawData:this.getFrequencyData(),timestamp:t,history:this.getLevelHistory()})}catch{}}emitVolumeSpike(t){if(this.callbacks.volumeSpike)try{this.callbacks.volumeSpike(t)}catch{}}emitError(t,e){if(this.callbacks.error)try{this.callbacks.error({message:t,error:e,timestamp:performance.now()})}catch{}}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class nf{constructor(){this.listeners=new Map,this.groups=new Map,this.stats={registered:0,removed:0,active:0}}addEventListener(t,e,i,s={},n="default"){const r=this.generateId(),o={id:r,target:t,eventType:e,handler:i,options:s,group:n,active:!0};return this.listeners.set(r,o),this.groups.has(n)||this.groups.set(n,new Set),this.groups.get(n).add(r),t.addEventListener(e,i,s),this.stats.registered++,this.stats.active++,r}removeEventListener(t){const e=this.listeners.get(t);if(!e||!e.active)return!1;e.target.removeEventListener(e.eventType,e.handler,e.options),e.active=!1;const i=this.groups.get(e.group);return i&&(i.delete(t),0===i.size&&this.groups.delete(e.group)),this.listeners.delete(t),this.stats.removed++,this.stats.active--,!0}removeGroup(t){const e=this.groups.get(t);if(!e)return 0;let i=0;for(const t of e)this.removeEventListener(t)&&i++;return i}removeAllForTarget(t){let e=0;for(const[i,s]of this.listeners.entries())s.target===t&&s.active&&this.removeEventListener(i)&&e++;return e}removeAllOfType(t){let e=0;for(const[i,s]of this.listeners.entries())s.eventType===t&&s.active&&this.removeEventListener(i)&&e++;return e}removeAll(){let t=0;for(const[e,i]of this.listeners.entries())i.active&&this.removeEventListener(e)&&t++;return t}createAutoRemove(t,e,i,s={}){const n=this.addEventListener(t,e,i,s);return{id:n,remove:()=>this.removeEventListener(n)}}once(t,e,i,s={}){const n=this.addEventListener(t,e,t=>{i(t),this.removeEventListener(n)},s);return n}debounced(t,e,i,s=250,n={}){let r;return this.addEventListener(t,e,t=>{clearTimeout(r),r=setTimeout(()=>i(t),s)},n)}throttled(t,e,i,s=100,n={}){let r=!1;return this.addEventListener(t,e,t=>{r||(i(t),r=!0,setTimeout(()=>{r=!1},s))},n)}generateId(){return`listener_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getStats(){return{...this.stats,groups:this.groups.size,listeners:this.listeners.size}}getActiveListeners(){const t=[];for(const[e,i]of this.listeners.entries())i.active&&t.push({id:e,eventType:i.eventType,group:i.group,target:i.target.constructor.name});return t}analyzeLeaks(){const t={totalListeners:this.listeners.size,activeListeners:this.stats.active,inactiveButNotRemoved:0,byTarget:new Map,byType:new Map,potentialLeaks:[]};for(const[e,i]of this.listeners.entries()){const s=i.target.constructor.name;t.byTarget.set(s,(t.byTarget.get(s)||0)+1),t.byType.set(i.eventType,(t.byType.get(i.eventType)||0)+1),i.active||(t.inactiveButNotRemoved++,t.potentialLeaks.push({id:e,eventType:i.eventType,target:s}))}return t.byTarget=Object.fromEntries(t.byTarget),t.byType=Object.fromEntries(t.byType),t}cleanup(){let t=0;for(const[e,i]of this.listeners.entries())i.active||(this.listeners.delete(e),t++);return t}destroy(){const t=this.removeAll();return this.listeners.clear(),this.groups.clear(),this.stats={registered:0,removed:0,active:0},t}}const rf=new nf;class of{constructor(t={}){this.config={enableReducedMotion:!1!==t.enableReducedMotion,enableHighContrast:!1!==t.enableHighContrast,enableScreenReaderSupport:!1!==t.enableScreenReaderSupport,enableKeyboardNavigation:!1!==t.enableKeyboardNavigation,enableFocusIndicators:!1!==t.enableFocusIndicators,announceStateChanges:!1!==t.announceStateChanges,colorBlindMode:t.colorBlindMode||"none",...t},this.reducedMotionPreferred=!1,this.highContrastEnabled=!1,this.screenReaderActive=!1,this.keyboardNavigationActive=!1,this.currentColorBlindMode=this.config.colorBlindMode,this.focusableElements=new Map,this.currentFocusIndex=-1,this.focusHistory=[],this.liveRegion=null,this.announcementQueue=[],this.boundHandleKeyDown=null,this.boundHandleKeyUp=null,this.colorSchemes={normal:null,highContrast:{primary:"#FFFFFF",secondary:"#000000",accent:"#FFFF00",background:"#000000",particles:"#FFFFFF"},protanopia:{primary:"#0066CC",secondary:"#FFCC00",accent:"#00CCFF",background:"#1A1A1A",particles:"#66CCFF"},deuteranopia:{primary:"#0099FF",secondary:"#FF9900",accent:"#FF00FF",background:"#1A1A1A",particles:"#9966FF"},tritanopia:{primary:"#FF0066",secondary:"#00FF66",accent:"#FF6600",background:"#1A1A1A",particles:"#FFCC00"}},this.patterns={dots:"dots",stripes:"stripes",crosshatch:"crosshatch",solid:"solid"},this.statePatterns={idle:this.patterns.solid,happy:this.patterns.dots,excited:this.patterns.stripes,calm:this.patterns.solid,curious:this.patterns.crosshatch,frustrated:this.patterns.stripes,sad:this.patterns.dots,neutral:this.patterns.solid},this.initialize()}initialize(){this.detectUserPreferences(),this.setupLiveRegion(),this.config.enableKeyboardNavigation&&this.setupKeyboardNavigation(),this.setupPreferenceListeners()}detectUserPreferences(){if(this.config.enableReducedMotion&&window.matchMedia){const t=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreferred=t.matches}if(this.config.enableHighContrast&&window.matchMedia){const t=window.matchMedia("(prefers-contrast: high)");if(this.highContrastEnabled=t.matches,!this.highContrastEnabled){const t=window.matchMedia("(-ms-high-contrast: active)");this.highContrastEnabled=t.matches}}this.detectScreenReader()}detectScreenReader(){const t=document.querySelector("[aria-live]"),e=document.querySelector("[aria-atomic]"),i=document.querySelector('[role="application"]'),s=navigator.userAgent.toLowerCase(),n=s.includes("nvda")||s.includes("jaws")||s.includes("voiceover");this.screenReaderActive=!!(t||e||i||n)}setupLiveRegion(){this.config.enableScreenReaderSupport&&(this.liveRegion=document.getElementById("mascot-announcements"),this.liveRegion||(this.liveRegion=document.createElement("div"),this.liveRegion.id="mascot-announcements",this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.style.position="absolute",this.liveRegion.style.left="-10000px",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.overflow="hidden",document.body.appendChild(this.liveRegion)))}setupKeyboardNavigation(){this.boundHandleKeyDown=this.handleKeyDown.bind(this),this.boundHandleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.boundHandleKeyDown),document.addEventListener("keyup",this.boundHandleKeyUp)}setupPreferenceListeners(){window.matchMedia&&(window.matchMedia("(prefers-reduced-motion: reduce)").addListener(t=>{this.reducedMotionPreferred=t.matches,this.onPreferenceChange("reducedMotion",t.matches)}),window.matchMedia("(prefers-contrast: high)").addListener(t=>{this.highContrastEnabled=t.matches,this.onPreferenceChange("highContrast",t.matches)}))}handleKeyDown(t){if(this.config.enableKeyboardNavigation){switch(t.key){case"Tab":t.preventDefault(),this.navigateFocus(t.shiftKey?-1:1);break;case"Enter":case" ":this.activateCurrentFocus();break;case"Escape":this.clearFocus();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":this.handleArrowNavigation(t.key)}this.keyboardNavigationActive=!0}}handleKeyUp(t){}navigateFocus(t){const e=Array.from(this.focusableElements.values());if(0===e.length)return;this.currentFocusIndex+=t,this.currentFocusIndex<0?this.currentFocusIndex=e.length-1:this.currentFocusIndex>=e.length&&(this.currentFocusIndex=0);const i=e[this.currentFocusIndex];this.setFocus(i),i.label&&this.announce(`Focused on ${i.label}`)}handleArrowNavigation(t){const e={ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1}}[t];e&&this.onArrowNavigation&&this.onArrowNavigation(e)}registerFocusableElement(t,e){this.focusableElements.set(t,{id:t,label:e.label||t,bounds:e.bounds||null,action:e.action||null,type:e.type||"button"})}unregisterFocusableElement(t){this.focusableElements.delete(t)}setFocus(t){this.onFocusChange&&this.onFocusChange(t),this.focusHistory.push(t.id),this.focusHistory.length>10&&this.focusHistory.shift()}clearFocus(){this.currentFocusIndex=-1,this.onFocusChange&&this.onFocusChange(null),this.announce("Focus cleared")}activateCurrentFocus(){const t=Array.from(this.focusableElements.values());if(this.currentFocusIndex>=0&&this.currentFocusIndex<t.length){const e=t[this.currentFocusIndex];e.action&&(e.action(),this.announce(`Activated ${e.label}`))}}announce(t,e="polite"){this.config.enableScreenReaderSupport&&this.liveRegion&&(this.announcementQueue.push({message:t,priority:e}),this.processAnnouncementQueue())}processAnnouncementQueue(){if(0===this.announcementQueue.length)return;const{message:t,priority:e}=this.announcementQueue.shift();this.liveRegion.setAttribute("aria-live",e),this.liveRegion.textContent=t,setTimeout(()=>{this.liveRegion&&(this.liveRegion.textContent=""),this.announcementQueue.length>0&&this.processAnnouncementQueue()},100)}getAnimationSettings(t={}){return this.reducedMotionPreferred?{...t,duration:t.duration?.5*t.duration:0,iterations:1,easing:"linear",particlesEnabled:!1,complexAnimations:!1,autoPlay:!1}:t}getColorScheme(t={}){return this.colorSchemes.normal||(this.colorSchemes.normal={...t}),this.highContrastEnabled?this.colorSchemes.highContrast:"none"!==this.currentColorBlindMode&&this.colorSchemes[this.currentColorBlindMode]?this.colorSchemes[this.currentColorBlindMode]:t}getStatePattern(t){return"none"===this.currentColorBlindMode?this.patterns.solid:this.statePatterns[t]||this.patterns.solid}applyPatternOverlay(t,e,i){if(e===this.patterns.solid)return;t.save();const s=document.createElement("canvas"),n=s.getContext("2d");switch(e){case this.patterns.dots:this.createDotPattern(n,s);break;case this.patterns.stripes:this.createStripePattern(n,s);break;case this.patterns.crosshatch:this.createCrosshatchPattern(n,s)}const r=t.createPattern(s,"repeat");t.fillStyle=r,t.globalAlpha=.3,t.fillRect(i.x,i.y,i.width,i.height),t.restore()}createDotPattern(t,e){e.width=10,e.height=10,t.fillStyle="white",t.beginPath(),t.arc(5,5,2,0,2*Math.PI),t.fill()}createStripePattern(t,e){e.width=10,e.height=10,t.strokeStyle="white",t.lineWidth=2,t.beginPath(),t.moveTo(0,10),t.lineTo(10,0),t.stroke()}createCrosshatchPattern(t,e){e.width=10,e.height=10,t.strokeStyle="white",t.lineWidth=1,t.beginPath(),t.moveTo(0,10),t.lineTo(10,0),t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(10,10),t.stroke()}setColorBlindMode(t){["none","protanopia","deuteranopia","tritanopia"].includes(t)&&(this.currentColorBlindMode=t,this.announce(`Color blind mode set to ${t}`),this.onColorSchemeChange&&this.onColorSchemeChange(this.getColorScheme()))}getStatus(){return{reducedMotion:this.reducedMotionPreferred,highContrast:this.highContrastEnabled,screenReader:this.screenReaderActive,keyboardNavigation:this.keyboardNavigationActive,colorBlindMode:this.currentColorBlindMode,focusedElement:this.currentFocusIndex>=0?Array.from(this.focusableElements.values())[this.currentFocusIndex]:null,registeredElements:this.focusableElements.size}}onPreferenceChange(t,e){this.announce(`${t} is now ${e?"enabled":"disabled"}`),"reducedMotion"===t&&this.onReducedMotionChange&&this.onReducedMotionChange(e),"highContrast"===t&&this.onHighContrastChange&&this.onHighContrastChange(e)}createStateDescription(t){return{idle:"Mascot is idle and gently breathing",happy:"Mascot is happy and bouncing",excited:"Mascot is excited with particles flying",calm:"Mascot is calm and peaceful",curious:"Mascot is curious and looking around",frustrated:"Mascot is frustrated and shaking",sad:"Mascot is sad and drooping",neutral:"Mascot is in a neutral state"}[t.emotional]||"Mascot is active"}destroy(){this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown),this.boundHandleKeyDown=null),this.boundHandleKeyUp&&(document.removeEventListener("keyup",this.boundHandleKeyUp),this.boundHandleKeyUp=null),this.liveRegion&&this.liveRegion.parentNode&&this.liveRegion.parentNode.removeChild(this.liveRegion),this.focusableElements.clear(),this.announcementQueue=[],this.focusHistory=[]}}class af{constructor(t={}){this.config={enableTouchOptimization:!1!==t.enableTouchOptimization,enableViewportHandling:!1!==t.enableViewportHandling,enableBatteryOptimization:!1!==t.enableBatteryOptimization,enableOrientationSupport:!1!==t.enableOrientationSupport,enableResponsiveScaling:!1!==t.enableResponsiveScaling,touchSensitivity:t.touchSensitivity||1,doubleTapDelay:t.doubleTapDelay||300,swipeThreshold:t.swipeThreshold||50,pinchThreshold:t.pinchThreshold||.1,...t},this.isMobile=this.detectMobile(),this.isTablet=this.detectTablet(),this.isTouchDevice=this.detectTouch(),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.isAndroid=/Android/.test(navigator.userAgent),this.touches=new Map,this.lastTouchTime=0,this.lastTapTime=0,this.tapCount=0,this.touchStartPosition=null,this.isPinching=!1,this.isRotating=!1,this.lastPinchDistance=0,this.lastRotation=0,this.currentGesture=null,this.gestureStartTime=0,this.gestureHistory=[],this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.orientation=this.getOrientation(),this.pixelRatio=window.devicePixelRatio||1,this.lastViewportChange=0,this.batteryLevel=1,this.isCharging=!0,this.lowPowerMode=!1,this.batteryRef=null,this.mobilePerformanceSettings={reducedParticles:this.isMobile,simplifiedAnimations:this.isMobile,lowerFrameRate:this.isMobile,reducedEffects:this.isMobile||this.isTablet,targetFPS:this.isMobile?30:60,maxParticles:this.isMobile?20:50},this.canvasScale=1,this.useOffscreenCanvas=this.supportsOffscreenCanvas(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this),this.handleOrientationChange=this.handleOrientationChange.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleContextMenu=t=>t.preventDefault(),this.initialize()}initialize(){this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers(),this.config.enableViewportHandling&&this.setupViewportHandlers(),this.config.enableBatteryOptimization&&this.setupBatteryMonitoring(),this.config.enableOrientationSupport&&this.setupOrientationHandlers(),this.applyMobileOptimizations()}detectMobile(){const t=navigator.userAgent.toLowerCase(),e=["android","iphone","ipod","windows phone","blackberry"].some(e=>t.includes(e)),i=window.innerWidth<=768,s="ontouchstart"in window||navigator.maxTouchPoints>0;return e||i&&s}detectTablet(){const t=navigator.userAgent.toLowerCase(),e=/ipad/.test(t),i=/android/.test(t)&&!/mobile/.test(t),s=/windows/.test(t)&&/touch/.test(t),n=window.innerWidth>768&&window.innerWidth<=1024,r="ontouchstart"in window||navigator.maxTouchPoints>0;return e||i||s||n&&r}detectTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}setupTouchHandlers(){const t=this.getCanvas();t&&(t.style.touchAction="none",t.style.userSelect="none",t.style.webkitUserSelect="none",t.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),t.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),t.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),t.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1}),t.addEventListener("contextmenu",this.handleContextMenu))}setupViewportHandlers(){window.addEventListener("resize",this.handleViewportChange),window.addEventListener("orientationchange",this.handleOrientationChange),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.setupViewportMeta()}setupViewportMeta(){let t=document.querySelector('meta[name="viewport"]');t||(t=document.createElement("meta"),t.name="viewport",document.head.appendChild(t)),t.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"}async setupBatteryMonitoring(){if(navigator.getBattery)try{const t=await navigator.getBattery();this.batteryRef=t,this.batteryLevel=t.level,this.isCharging=t.charging,this.boundBatteryLevelChange=()=>{this.batteryLevel=t.level,this.onBatteryChange()},this.boundBatteryChargingChange=()=>{this.isCharging=t.charging,this.onBatteryChange()},t.addEventListener("levelchange",this.boundBatteryLevelChange),t.addEventListener("chargingchange",this.boundBatteryChargingChange),this.onBatteryChange()}catch{}}setupOrientationHandlers(){window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",t=>{this.handleDeviceOrientation(t)})}handleTouchStart(t){t.cancelable&&t.preventDefault();const e=Date.now();this.gestureStartTime=e;for(const i of t.touches)this.touches.set(i.identifier,{id:i.identifier,startX:i.clientX,startY:i.clientY,currentX:i.clientX,currentY:i.clientY,startTime:e});1===t.touches.length?this.handleSingleTouchStart(t.touches[0]):2===t.touches.length&&this.handleMultiTouchStart(t.touches),this.emitTouchEvent("touchStart",{touches:Array.from(this.touches.values()),timestamp:e})}handleSingleTouchStart(t){const e=Date.now();e-this.lastTapTime<this.config.doubleTapDelay?this.tapCount++:this.tapCount=1,this.lastTapTime=e,this.touchStartPosition={x:t.clientX,y:t.clientY}}handleMultiTouchStart(t){if(2===t.length){const e=t[0],i=t[1];this.lastPinchDistance=this.getDistance(e.clientX,e.clientY,i.clientX,i.clientY),this.lastRotation=this.getAngle(e.clientX,e.clientY,i.clientX,i.clientY),this.isPinching=!0}}handleTouchMove(t){t.cancelable&&t.preventDefault();for(const e of t.touches){const t=this.touches.get(e.identifier);t&&(t.currentX=e.clientX,t.currentY=e.clientY)}1===t.touches.length?this.handleSingleTouchMove(t.touches[0]):2===t.touches.length&&this.handleMultiTouchMove(t.touches),this.emitTouchEvent("touchMove",{touches:Array.from(this.touches.values()),gesture:this.currentGesture})}handleSingleTouchMove(t){const e=this.touches.get(t.identifier);if(!e)return;const i=t.clientX-e.startX,s=t.clientY-e.startY;Math.sqrt(i*i+s*s)>this.config.swipeThreshold?Math.abs(i)>Math.abs(s)?this.currentGesture=i>0?"swipeRight":"swipeLeft":this.currentGesture=s>0?"swipeDown":"swipeUp":this.currentGesture="pan"}handleMultiTouchMove(t){if(2!==t.length)return;const e=t[0],i=t[1],s=this.getDistance(e.clientX,e.clientY,i.clientX,i.clientY),n=s-this.lastPinchDistance,r=s/this.lastPinchDistance;Math.abs(n)>this.config.pinchThreshold&&(this.currentGesture=r>1?"pinchOut":"pinchIn",this.emitTouchEvent("pinch",{scale:r,delta:n}));const o=this.getAngle(e.clientX,e.clientY,i.clientX,i.clientY),a=o-this.lastRotation;Math.abs(a)>5&&(this.currentGesture="rotate",this.emitTouchEvent("rotate",{angle:o,delta:a})),this.lastPinchDistance=s,this.lastRotation=o}handleTouchEnd(t){t.cancelable&&t.preventDefault();const e=Date.now();for(const i of t.changedTouches){const t=this.touches.get(i.identifier);if(t){const s=e-t.startTime,n=t.currentX-t.startX,r=t.currentY-t.startY,o=Math.sqrt(n*n+r*r);s<300&&o<10&&(2===this.tapCount?(this.emitTouchEvent("doubleTap",{x:t.currentX,y:t.currentY}),this.tapCount=0):this.emitTouchEvent("tap",{x:t.currentX,y:t.currentY})),s>500&&o<10&&this.emitTouchEvent("longPress",{x:t.currentX,y:t.currentY}),this.touches.delete(i.identifier)}}0===t.touches.length&&(this.currentGesture=null,this.isPinching=!1,this.isRotating=!1),this.emitTouchEvent("touchEnd",{gesture:this.currentGesture,duration:e-this.gestureStartTime})}handleTouchCancel(t){this.touches.clear(),this.currentGesture=null,this.isPinching=!1,this.isRotating=!1,this.emitTouchEvent("touchCancel",{})}handleOrientationChange(t){this.orientation=this.getOrientation(),this.emitTouchEvent("orientationChange",{orientation:this.orientation,angle:window.orientation||0}),this.applyOrientationOptimizations()}handleDeviceOrientation(t){const{alpha:e,beta:i,gamma:s}=t;this.emitTouchEvent("deviceOrientation",{alpha:e,beta:i,gamma:s})}handleViewportChange(t){const e=Date.now();e-this.lastViewportChange<100||(this.lastViewportChange=e,this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.pixelRatio=window.devicePixelRatio||1,this.emitTouchEvent("viewportChange",{size:this.viewportSize,pixelRatio:this.pixelRatio,orientation:this.getOrientation()}),this.config.enableResponsiveScaling&&this.applyResponsiveScaling())}handleVisibilityChange(t){const e=!document.hidden;this.emitTouchEvent("visibilityChange",{visible:e}),!e&&this.config.enableBatteryOptimization?this.applyBackgroundOptimizations():this.restorePerformance()}getOrientation(){return window.innerWidth>window.innerHeight?"landscape":"portrait"}getDistance(t,e,i,s){const n=i-t,r=s-e;return Math.sqrt(n*n+r*r)}getAngle(t,e,i,s){return 180*Math.atan2(s-e,i-t)/Math.PI}applyMobileOptimizations(){if(!this.isMobile&&!this.isTablet)return;const t={...this.mobilePerformanceSettings,canvasScale:this.calculateOptimalCanvasScale(),useWebGL:!1,useOffscreenCanvas:this.useOffscreenCanvas};return this.emitTouchEvent("mobileOptimizations",t),t}applyOrientationOptimizations(){const t="landscape"===this.orientation,e={layoutMode:t?"horizontal":"vertical",particleDirection:t?"horizontal":"vertical",uiScale:t?.8:1};return this.emitTouchEvent("orientationOptimizations",e),e}applyResponsiveScaling(){const t=Math.min(this.viewportSize.width/375,2);return this.canvasScale=t,this.emitTouchEvent("responsiveScale",{scale:this.canvasScale,viewport:this.viewportSize}),this.canvasScale}applyBackgroundOptimizations(){const t={targetFPS:5,particlesEnabled:!1,animationsEnabled:!1,audioEnabled:!1};return this.emitTouchEvent("backgroundOptimizations",t),t}restorePerformance(){const t=this.applyMobileOptimizations();return this.emitTouchEvent("performanceRestore",t),t}onBatteryChange(){if(this.lowPowerMode=this.batteryLevel<.2&&!this.isCharging,this.lowPowerMode){const t={targetFPS:15,maxParticles:5,reducedEffects:!0,audioEnabled:!1};this.emitTouchEvent("lowPowerMode",{batteryLevel:this.batteryLevel,isCharging:this.isCharging,optimizations:t})}}calculateOptimalCanvasScale(){return this.isMobile?Math.min(this.pixelRatio,2):this.isTablet?Math.min(this.pixelRatio,2.5):this.pixelRatio}getCanvas(){return this.canvas||document.querySelector("canvas")}setCanvas(t){this.canvas=t,this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers()}emitTouchEvent(t,e){this.onTouchEvent&&this.onTouchEvent(t,e)}getStatus(){return{device:{isMobile:this.isMobile,isTablet:this.isTablet,isTouchDevice:this.isTouchDevice,isIOS:this.isIOS,isAndroid:this.isAndroid},viewport:{size:this.viewportSize,orientation:this.orientation,pixelRatio:this.pixelRatio,canvasScale:this.canvasScale},battery:{level:this.batteryLevel,isCharging:this.isCharging,lowPowerMode:this.lowPowerMode},touch:{activeTouches:this.touches.size,currentGesture:this.currentGesture,isPinching:this.isPinching,isRotating:this.isRotating},performance:this.mobilePerformanceSettings}}destroy(){const t=this.getCanvas();t&&(t.removeEventListener("touchstart",this.handleTouchStart),t.removeEventListener("touchmove",this.handleTouchMove),t.removeEventListener("touchend",this.handleTouchEnd),t.removeEventListener("touchcancel",this.handleTouchCancel),t.removeEventListener("contextmenu",this.handleContextMenu)),window.removeEventListener("resize",this.handleViewportChange),window.removeEventListener("orientationchange",this.handleOrientationChange),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.batteryRef&&(this.boundBatteryLevelChange&&this.batteryRef.removeEventListener("levelchange",this.boundBatteryLevelChange),this.boundBatteryChargingChange&&this.batteryRef.removeEventListener("chargingchange",this.boundBatteryChargingChange),this.batteryRef=null),this.touches.clear(),this.gestureHistory=[]}}class hf{constructor(t={}){this.config={enablePlugins:!1!==t.enablePlugins,validatePlugins:!1!==t.validatePlugins,sandboxPlugins:!1!==t.sandboxPlugins,maxPlugins:t.maxPlugins||50,pluginTimeout:t.pluginTimeout||5e3,allowOverrides:!1!==t.allowOverrides,...t},this.mascot=t.mascot||null,this.plugins=new Map,this.pluginTypes=["emotion","gesture","particle","audio","renderer","animation"],this.pluginsByType=new Map(this.pluginTypes.map(t=>[t,new Set])),this.dependencies=new Map,this.dependencyGraph=new Map,this.pluginStates=new Map,this.loadingPlugins=new Set,this.activePlugins=new Set,this.hooks=new Map([["beforeInit",new Set],["afterInit",new Set],["beforeUpdate",new Set],["afterUpdate",new Set],["beforeRender",new Set],["afterRender",new Set],["beforeDestroy",new Set],["afterDestroy",new Set]]),this.pluginAPI=this.createPluginAPI(),this.conflicts=new Map,this.resolutionStrategies={override:this.overrideConflict.bind(this),merge:this.mergeConflict.bind(this),reject:this.rejectConflict.bind(this),queue:this.queueConflict.bind(this)},this.validationSchemas=this.createValidationSchemas(),this.sandbox=null,this.config.sandboxPlugins&&(this.sandbox=this.createSandbox())}createPluginAPI(){return{mascot:this.mascot,registerHook:this.registerHook.bind(this),emit:this.emitPluginEvent.bind(this),on:this.onPluginEvent.bind(this),getPlugin:this.getPlugin.bind(this),hasPlugin:this.hasPlugin.bind(this),log:this.logFromPlugin.bind(this),error:this.errorFromPlugin.bind(this),setState:this.setPluginState.bind(this),getState:this.getPluginState.bind(this),getConfig:()=>({...this.config}),version:"1.0.0"}}createValidationSchemas(){const t=new Map,e={name:{type:"string",required:!0},version:{type:"string",required:!0},type:{type:"string",required:!0,enum:this.pluginTypes},description:{type:"string",required:!1},author:{type:"string",required:!1},dependencies:{type:"array",required:!1},conflicts:{type:"array",required:!1},init:{type:"function",required:!0},destroy:{type:"function",required:!0}};return t.set("emotion",{...e,emotion:{type:"object",required:!0,properties:{name:{type:"string",required:!0},color:{type:"string",required:!0},particleColor:{type:"string",required:!1},animation:{type:"object",required:!0},transitions:{type:"object",required:!1}}},updateEmotion:{type:"function",required:!0},renderEmotion:{type:"function",required:!1}}),t.set("gesture",{...e,gesture:{type:"object",required:!0,properties:{name:{type:"string",required:!0},duration:{type:"number",required:!0},keyframes:{type:"array",required:!0},compatibility:{type:"object",required:!1}}},executeGesture:{type:"function",required:!0},canExecute:{type:"function",required:!1}}),t.set("particle",{...e,particle:{type:"object",required:!0,properties:{name:{type:"string",required:!0},maxParticles:{type:"number",required:!1},behavior:{type:"function",required:!0},render:{type:"function",required:!0}}},updateParticles:{type:"function",required:!0},spawnParticle:{type:"function",required:!1}}),t.set("audio",{...e,audio:{type:"object",required:!0,properties:{name:{type:"string",required:!0},sounds:{type:"object",required:!0},effects:{type:"array",required:!1}}},playSound:{type:"function",required:!0},processAudio:{type:"function",required:!1}}),t}createSandbox(){return{Math:Math,Date:Date,JSON:JSON,console:{log:(...t)=>null,warn:(...t)=>null,error:(...t)=>null},window:void 0,document:void 0,localStorage:void 0,sessionStorage:void 0,fetch:void 0,XMLHttpRequest:void 0,api:this.pluginAPI}}async registerPlugin(t){if(!this.config.enablePlugins)return!1;if(this.plugins.size>=this.config.maxPlugins)return!1;if(this.config.validatePlugins&&!this.validatePlugin(t).valid)return!1;if(this.checkConflicts(t).length>0&&!this.config.allowOverrides)return!1;if(!(await this.resolveDependencies(t)).resolved)return!1;try{this.loadingPlugins.add(t.name);const e=this.config.sandboxPlugins?this.sandbox:window;if(!await this.initializePlugin(t,e))throw new Error("Plugin initialization failed");return this.plugins.set(t.name,t),this.pluginsByType.get(t.type).add(t.name),this.pluginStates.set(t.name,"active"),this.activePlugins.add(t.name),t.dependencies&&(this.dependencies.set(t.name,t.dependencies),this.updateDependencyGraph(t.name,t.dependencies)),t.hooks&&Object.entries(t.hooks).forEach(([e,i])=>{this.registerHook(e,i,t.name)}),this.emitPluginEvent("pluginRegistered",{name:t.name,type:t.type,version:t.version}),!0}catch{return!1}finally{this.loadingPlugins.delete(t.name)}}validatePlugin(t){const e=[];if(t.name&&"string"==typeof t.name||e.push("Plugin must have a valid name"),t.type&&this.pluginTypes.includes(t.type)||e.push(`Plugin type must be one of: ${this.pluginTypes.join(", ")}`),t.version&&"string"==typeof t.version||e.push("Plugin must have a version"),"function"!=typeof t.init&&e.push("Plugin must have an init function"),"function"!=typeof t.destroy&&e.push("Plugin must have a destroy function"),t.type&&this.validationSchemas.has(t.type)){const i=this.validationSchemas.get(t.type),s=this.validateAgainstSchema(t,i);e.push(...s)}return{valid:0===e.length,errors:e}}validateAgainstSchema(t,e){const i=[];return Object.entries(e).forEach(([e,s])=>{if(s.required&&!(e in t)&&i.push(`Missing required property: ${e}`),e in t){const n=t[e];if(s.type&&typeof n!==s.type&&i.push(`Property ${e} must be of type ${s.type}`),s.enum&&!s.enum.includes(n)&&i.push(`Property ${e} must be one of: ${s.enum.join(", ")}`),s.properties&&"object"==typeof n){const t=this.validateAgainstSchema(n,s.properties);i.push(...t.map(t=>`${e}.${t}`))}}}),i}checkConflicts(t){const e=[];return t.conflicts&&t.conflicts.forEach(t=>{this.plugins.has(t)&&e.push(t)}),"emotion"!==t.type&&"gesture"!==t.type||this.plugins.forEach(i=>{if(i.type===t.type){const s=i[t.type]?.name,n=t[t.type]?.name;s===n&&e.push(`${t.type} name collision: ${n}`)}}),e}async resolveDependencies(t){if(!t.dependencies||0===t.dependencies.length)return{resolved:!0,missing:[]};const e=[];for(const i of t.dependencies)this.plugins.has(i)||await this.tryLoadDependency(i)||e.push(i);return{resolved:0===e.length,missing:e}}tryLoadDependency(t){return this.plugins.has(t)}updateDependencyGraph(t,e){this.dependencyGraph.set(t,new Set(e)),e.forEach(t=>{this.dependencyGraph.has(t)||this.dependencyGraph.set(t,new Set)})}async initializePlugin(t,e){try{const i=new Promise((t,e)=>{setTimeout(()=>e(new Error("Plugin initialization timeout")),this.config.pluginTimeout)}),s=t.init.bind(e);return!1!==await Promise.race([s(this.pluginAPI),i])}catch{return!1}}async unregisterPlugin(t){const e=this.plugins.get(t);if(!e)return!1;if(this.getDependentPlugins(t).length>0)return!1;try{return"function"==typeof e.destroy&&await e.destroy(),this.plugins.delete(t),this.pluginsByType.get(e.type).delete(t),this.pluginStates.delete(t),this.activePlugins.delete(t),this.dependencies.delete(t),this.dependencyGraph.delete(t),this.hooks.forEach(e=>{e.forEach(i=>{i.pluginName===t&&e.delete(i)})}),this.emitPluginEvent("pluginUnregistered",{name:t}),!0}catch{return!1}}getDependentPlugins(t){const e=[];return this.dependencies.forEach((i,s)=>{i.includes(t)&&e.push(s)}),e}registerHook(t,e,i){this.hooks.has(t)||this.hooks.set(t,new Set),this.hooks.get(t).add({handler:e,pluginName:i})}async executeHooks(t,e){const i=this.hooks.get(t);if(!i||0===i.size)return[];const s=[];for(const t of i)try{const i=await t.handler(e);s.push({pluginName:t.pluginName,result:i})}catch{}return s}getPlugin(t){return this.plugins.get(t)||null}hasPlugin(t){return this.plugins.has(t)}getPluginsByType(t){const e=this.pluginsByType.get(t);return e?Array.from(e).map(t=>this.plugins.get(t)):[]}enablePlugin(t){if(!this.plugins.has(t))return;this.pluginStates.set(t,"active"),this.activePlugins.add(t);const e=this.plugins.get(t);e.onEnable&&e.onEnable(),this.emitPluginEvent("pluginEnabled",{name:t})}disablePlugin(t){if(!this.plugins.has(t))return;this.getDependentPlugins(t),this.pluginStates.set(t,"disabled"),this.activePlugins.delete(t);const e=this.plugins.get(t);e.onDisable&&e.onDisable(),this.emitPluginEvent("pluginDisabled",{name:t})}emitPluginEvent(t,e){this.onPluginEvent&&this.onPluginEvent(t,e)}onPluginEvent(t,e){}logFromPlugin(t,...e){}errorFromPlugin(t,...e){}setPluginState(t,e,i){this.pluginStates.has(t)||this.pluginStates.set(t,{});const s=this.pluginStates.get(t);"object"==typeof s&&(s[e]=i)}getPluginState(t,e){const i=this.pluginStates.get(t);if("object"==typeof i)return i[e]}overrideConflict(t,e){return e}mergeConflict(t,e){return{...t,...e}}rejectConflict(t,e){return t}queueConflict(t,e){return[t,e]}getStatus(){return{enabled:this.config.enablePlugins,totalPlugins:this.plugins.size,activePlugins:this.activePlugins.size,loadingPlugins:this.loadingPlugins.size,pluginsByType:Object.fromEntries(Array.from(this.pluginsByType.entries()).map(([t,e])=>[t,e.size])),hooks:Object.fromEntries(Array.from(this.hooks.entries()).map(([t,e])=>[t,e.size]))}}update(t,e){if(this.config.enablePlugins)for(const i of this.activePlugins){const s=this.plugins.get(i);if(s&&"function"==typeof s.update)try{s.update(t,e)}catch(t){this.errorFromPlugin(i,"Update error:",t)}}}render(t,e){if(this.config.enablePlugins)for(const i of this.activePlugins){const s=this.plugins.get(i);if(s&&"function"==typeof s.render)try{s.render(t,e)}catch(t){this.errorFromPlugin(i,"Render error:",t)}}}async destroy(){const t=Array.from(this.plugins.keys());for(const e of t)await this.unregisterPlugin(e);this.plugins.clear(),this.pluginsByType.clear(),this.dependencies.clear(),this.dependencyGraph.clear(),this.pluginStates.clear(),this.activePlugins.clear(),this.loadingPlugins.clear(),this.hooks.clear(),this.conflicts.clear()}}class cf{constructor(){if(cf.Vi)return this.features=cf.Vi,void(this.capabilities=cf.Yi);this.features={webAudio:this.detectWebAudio(),canvas2d:this.detectCanvas2D(),requestAnimationFrame:this.detectRequestAnimationFrame(),devicePixelRatio:this.detectDevicePixelRatio(),audioContext:this.detectAudioContext(),mediaDevices:this.detectMediaDevices(),performance:this.detectPerformance(),intersectionObserver:this.detectIntersectionObserver()},this.capabilities=this.assessCapabilities(),cf.Vi=this.features,cf.Yi=this.capabilities}detectWebAudio(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch{return!1}}detectCanvas2D(){try{const t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}catch{return!1}}detectRequestAnimationFrame(){return!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame)}detectDevicePixelRatio(){return"number"==typeof window.devicePixelRatio}detectAudioContext(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch{return!1}}detectMediaDevices(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)}detectPerformance(){return!(!window.performance||!window.performance.now)}detectIntersectionObserver(){return"function"==typeof window.IntersectionObserver}assessCapabilities(){const t=Object.values(this.features).filter(Boolean).length,e=Object.keys(this.features).length,i=t/e*100;let s="basic";return i>=90?s="full":i>=70?s="good":i>=50&&(s="limited"),{score:t,total:e,percentage:i,level:s,recommendations:this.getRecommendations(s)}}getRecommendations(t){const e=[];return this.features.webAudio||e.push("Audio features will be disabled"),this.features.requestAnimationFrame||e.push("Animation will use setTimeout fallback"),this.features.performance||e.push("Performance monitoring will be limited"),"basic"===t&&e.push("Consider using minimal build for better performance"),e}getFeatures(){return{...this.features}}getCapabilities(){return{...this.capabilities}}}class uf{constructor(){this.polyfills=new Map,this.applied=new Set}register(t,e){this.polyfills.set(t,e)}apply(t){if(this.applied.has(t))return!0;const e=this.polyfills.get(t);if(!e)return!1;try{return e(),this.applied.add(t),!0}catch{return!1}}applyAll(){const t=[];for(const e of this.polyfills.keys())this.apply(e)&&t.push(e);return t}isApplied(t){return this.applied.has(t)}}function lf(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(()=>{t(Date.now())},1e3/60)},window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){window.clearTimeout(t)})}function df(){if(window.performance&&window.performance.now)return;window.performance||(window.performance={});const t=Date.now();window.performance.now=function(){return Date.now()-t}}function pf(){window.AudioContext||window.webkitAudioContext||(window.AudioContext=function(){this.state="suspended",this.sampleRate=44100,this.currentTime=0,this.destination={connect(){},disconnect(){}},this.createGain=function(){return{gain:{value:1},connect(){},disconnect(){}}},this.createOscillator=function(){return{frequency:{value:440},type:"sine",start(){},stop(){},connect(){},disconnect(){}}},this.createAnalyser=function(){return{fftSize:2048,frequencyBinCount:1024,getByteFrequencyData(t){for(let e=0;e<t.length;e++)t[e]=0},connect(){},disconnect(){}}},this.resume=function(){return this.state="running",Promise.resolve()},this.suspend=function(){return this.state="suspended",Promise.resolve()},this.close=function(){return this.state="closed",Promise.resolve()}})}class ff{constructor(t){this.canvas=t,this.context=null,this.isContextLost=!1,this.recoveryCallbacks=[],this.setupContextLossHandling()}setupContextLossHandling(){this.canvas.addEventListener("webglcontextlost",t=>{t.preventDefault(),this.isContextLost=!0}),this.canvas.addEventListener("webglcontextrestored",()=>{this.isContextLost=!1,this.context=this.canvas.getContext("2d"),this.recoveryCallbacks.forEach(t=>{try{t(this.context)}catch{}})})}getContext(){if(this.isContextLost)return null;if(!this.context)try{this.context=this.canvas.getContext("2d")}catch{return null}return this.context}onRecovery(t){this.recoveryCallbacks.push(t)}isLost(){return this.isContextLost}recover(){if(!this.isContextLost)return!0;try{if(this.context=this.canvas.getContext("2d"),this.context)return this.isContextLost=!1,!0}catch{}return!1}}class mf{constructor(){if(mf.Xi)return this.browser=mf.Xi,void(this.optimizations=mf.Ji);this.browser=this.detectBrowser(),this.optimizations=new Map,this.setupOptimizations(),mf.Xi=this.browser,mf.Ji=this.optimizations}detectBrowser(){const{userAgent:t}=navigator;let e="unknown",i="unknown";if(t.includes("Chrome")){e="chrome";const s=t.match(/Chrome\/(\d+)/);i=s?s[1]:"unknown"}else if(t.includes("Firefox")){e="firefox";const s=t.match(/Firefox\/(\d+)/);i=s?s[1]:"unknown"}else if(t.includes("Safari")&&!t.includes("Chrome")){e="safari";const s=t.match(/Version\/(\d+)/);i=s?s[1]:"unknown"}else if(t.includes("Edge")){e="edge";const s=t.match(/Edge\/(\d+)/);i=s?s[1]:"unknown"}return{name:e,version:i,userAgent:t}}setupOptimizations(){this.optimizations.set("chrome",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:50}),this.optimizations.set("firefox",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"balanced"},canvasOptimizations:[],particleLimit:40}),this.optimizations.set("safari",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"playback"},canvasOptimizations:[],particleLimit:30}),this.optimizations.set("edge",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:45})}getOptimizations(){return this.optimizations.get(this.browser.name)||this.optimizations.get("chrome")}getBrowser(){return{...this.browser}}applyCanvasOptimizations(t,e){if(this.getOptimizations().canvasOptimizations.includes("willReadFrequently"))try{t.getContext("2d",{willReadFrequently:!0})}catch{}}getRecommendedParticleLimit(){return this.getOptimizations().particleLimit}getAudioContextOptions(){return this.getOptimizations().audioContextOptions}}let gf=null,yf=null;const bf=(yf||(yf=function(){if(gf)return gf;const t=new cf,e=new uf,i=new mf;e.register("requestAnimationFrame",lf),e.register("performanceNow",df),e.register("webAudio",pf);const s=[];return t.features.requestAnimationFrame||e.apply("requestAnimationFrame")&&s.push("requestAnimationFrame"),t.features.performance||e.apply("performanceNow")&&s.push("performanceNow"),t.features.webAudio||e.apply("webAudio")&&s.push("webAudio"),gf={featureDetection:t,polyfillManager:e,browserOptimizations:i,appliedPolyfills:s,capabilities:t.getCapabilities(),browser:i.getBrowser()},gf}()),yf),vf={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5},wf=new class{constructor(t={}){this.config={enabled:!1!==t.enabled,level:t.level||vf.INFO,enableProfiling:!1!==t.enableProfiling,enableErrorTracking:!1!==t.enableErrorTracking,enableMemoryTracking:!1!==t.enableMemoryTracking,maxLogEntries:t.maxLogEntries||1e3,maxProfileEntries:t.maxProfileEntries||500,...t},this.logs=[],this.errors=[],this.profiles=new Map,this.memorySnapshots=[],this.frameTimings=[],this.maxFrameTimings=120,this.errorCounts=new Map,this.lastErrors=new Map,this.capabilities={performance:"undefined"!=typeof performance&&performance.now,memory:"undefined"!=typeof performance&&performance.memory,console:"undefined"!=typeof console,stackTrace:"undefined"!=typeof Error},this.startTime=this.now(),this.setupErrorHandling(),this.config.enabled&&this.log("DEBUG","EmotiveDebugger initialized",{config:this.config,capabilities:this.capabilities})}now(){return this.capabilities.performance?performance.now():Date.now()-this.startTime}setupErrorHandling(){this.config.enableErrorTracking&&"undefined"!=typeof window&&(window.addEventListener("error",t=>{this.trackError("UNHANDLED_ERROR",t.error||new Error(t.message),{filename:t.filename,lineno:t.lineno,colno:t.colno})}),window.addEventListener("unhandledrejection",t=>{this.trackError("UNHANDLED_REJECTION",t.reason,{promise:t.promise})}))}log(t,e,i=null){if(!this.config.enabled)return;if((vf[t]||vf.INFO)>this.config.level)return;const s=this.now(),n={timestamp:s,level:t,message:e,data:i,stackTrace:this.getStackTrace()};if(this.logs.push(n),this.logs.length>this.config.maxLogEntries&&this.logs.shift(),this.capabilities.console){const n=this.getConsoleMethod(t),r=`[${(s/1e3).toFixed(3)}s]`;i?n(`${r} [${t}] ${e}`,i):n(`${r} [${t}] ${e}`)}}getConsoleMethod(t){return(()=>{}).bind(console)}getStackTrace(){if(!this.capabilities.stackTrace)return null;try{throw new Error}catch(t){return t.stack}}trackError(t,e,i={}){if(!this.config.enableErrorTracking)return;const s={timestamp:this.now(),type:t,message:e.message||String(e),stack:e.stack,context:i,count:1},n=`${t}:${e.message}`;this.errorCounts.has(n)?(this.errorCounts.set(n,this.errorCounts.get(n)+1),s.count=this.errorCounts.get(n)):this.errorCounts.set(n,1),this.errors.push(s),this.lastErrors.set(t,s),this.log("ERROR",`${t}: ${e.message}`,{error:s,context:i})}startProfile(t,e={}){if(!this.config.enableProfiling)return;const i={name:t,startTime:this.now(),metadata:e,samples:[],isActive:!0};this.profiles.set(t,i),this.log("TRACE",`Started profiling: ${t}`,e)}profileSample(t,e,i=null){if(!this.config.enableProfiling)return;const s=this.profiles.get(t);if(!s||!s.isActive)return;const n={timestamp:this.now(),label:e,data:i,relativeTime:this.now()-s.startTime};s.samples.push(n)}endProfile(t){if(!this.config.enableProfiling)return null;const e=this.profiles.get(t);if(!e||!e.isActive)return null;if(e.endTime=this.now(),e.duration=e.endTime-e.startTime,e.isActive=!1,e.stats=this.calculateProfileStats(e),this.log("TRACE",`Ended profiling: ${t}`,{duration:e.duration,samples:e.samples.length,stats:e.stats}),this.profiles.size>this.config.maxProfileEntries){const t=this.profiles.keys().next().value;this.profiles.delete(t)}return{...e}}calculateProfileStats(t){if(0===t.samples.length)return{sampleCount:0};const e=[];for(let i=1;i<t.samples.length;i++)e.push(t.samples[i].relativeTime-t.samples[i-1].relativeTime);if(0===e.length)return{sampleCount:t.samples.length};const i=e.reduce((t,e)=>t+e,0)/e.length,s=Math.min(...e),n=Math.max(...e);return{sampleCount:t.samples.length,avgSampleDuration:i,minSampleDuration:s,maxSampleDuration:n,totalDuration:t.duration}}trackFrameTiming(t){this.config.enableProfiling&&(this.frameTimings.push({timestamp:this.now(),frameTime:t,fps:1e3/t}),this.frameTimings.length>this.maxFrameTimings&&this.frameTimings.shift())}takeMemorySnapshot(t="snapshot"){if(!this.config.enableMemoryTracking||!this.capabilities.memory)return;const e={timestamp:this.now(),label:t,memory:{usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}};this.memorySnapshots.push(e),this.memorySnapshots.length>100&&this.memorySnapshots.shift(),this.log("DEBUG",`Memory snapshot: ${t}`,e.memory)}getDebugReport(){return{timestamp:this.now(),uptime:this.now()-0,config:this.config,capabilities:this.capabilities,logCount:this.logs.length,recentLogs:this.logs.slice(-10),errorCount:this.errors.length,uniqueErrors:this.errorCounts.size,recentErrors:this.errors.slice(-5),errorCounts:Object.fromEntries(this.errorCounts),activeProfiles:Array.from(this.profiles.values()).filter(t=>t.isActive).length,completedProfiles:Array.from(this.profiles.values()).filter(t=>!t.isActive).length,frameTimings:this.getFrameTimingStats(),memorySnapshots:this.memorySnapshots.slice(-5)}}getFrameTimingStats(){if(0===this.frameTimings.length)return{sampleCount:0};const t=this.frameTimings.map(t=>t.frameTime),e=this.frameTimings.map(t=>t.fps);return{sampleCount:this.frameTimings.length,avgFrameTime:t.reduce((t,e)=>t+e,0)/t.length,minFrameTime:Math.min(...t),maxFrameTime:Math.max(...t),avgFPS:e.reduce((t,e)=>t+e,0)/e.length,minFPS:Math.min(...e),maxFPS:Math.max(...e)}}exportDebugData(){return{metadata:{exportTime:Date.now(),debuggerUptime:this.now(),config:this.config,capabilities:this.capabilities},logs:[...this.logs],errors:[...this.errors],profiles:Object.fromEntries(this.profiles),frameTimings:[...this.frameTimings],memorySnapshots:[...this.memorySnapshots],errorCounts:Object.fromEntries(this.errorCounts)}}clear(){this.logs=[],this.errors=[],this.profiles.clear(),this.frameTimings=[],this.memorySnapshots=[],this.errorCounts.clear(),this.lastErrors.clear(),this.log("INFO","Debug data cleared")}destroy(){this.clear(),this.config.enabled=!1}}({enabled:"undefined"!=typeof window&&window.location&&window.location.search.includes("debug=true"),level:vf.INFO}),Mf=new class{constructor(){this.capabilities=this.detectCapabilities(),this.performance=this.measurePerformance()}detectCapabilities(){return{es6:this.detectES6(),es2017:this.detectES2017(),modules:this.detectModules(),webGL:this.detectWebGL(),webGL2:this.detectWebGL2(),webWorkers:this.detectWebWorkers(),serviceWorkers:this.detectServiceWorkers(),performanceObserver:this.detectPerformanceObserver(),intersectionObserver:this.detectIntersectionObserver(),resizeObserver:this.detectResizeObserver(),localStorage:this.detectLocalStorage(),sessionStorage:this.detectSessionStorage(),indexedDB:this.detectIndexedDB(),fetch:this.detectFetch(),webSockets:this.detectWebSockets(),touchEvents:this.detectTouchEvents(),pointerEvents:this.detectPointerEvents(),deviceOrientation:this.detectDeviceOrientation(),canvas2d:this.detectCanvas2D(),canvasFilters:this.detectCanvasFilters(),offscreenCanvas:this.detectOffscreenCanvas()}}detectES6(){try{return"undefined"!=typeof Symbol&&"undefined"!=typeof Promise&&"undefined"!=typeof Map&&"undefined"!=typeof Set}catch{return!1}}detectES2017(){try{return"undefined"!=typeof async||function(){try{return"function"==typeof async function(){}.constructor}catch{return!1}}()}catch{return!1}}detectModules(){try{return"undefined"!=typeof document&&"noModule"in document.createElement("script")}catch{return!1}}detectWebGL(){try{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch{return!1}}detectWebGL2(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}detectWebWorkers(){return"undefined"!=typeof Worker}detectServiceWorkers(){return"serviceWorker"in navigator}detectPerformanceObserver(){return"undefined"!=typeof PerformanceObserver}detectIntersectionObserver(){return"undefined"!=typeof IntersectionObserver}detectResizeObserver(){return"undefined"!=typeof ResizeObserver}detectLocalStorage(){try{return"undefined"!=typeof localStorage&&null!==localStorage}catch{return!1}}detectSessionStorage(){try{return"undefined"!=typeof sessionStorage&&null!==sessionStorage}catch{return!1}}detectIndexedDB(){return"undefined"!=typeof indexedDB}detectFetch(){return"undefined"!=typeof fetch}detectWebSockets(){return"undefined"!=typeof WebSocket}detectTouchEvents(){return"ontouchstart"in window||navigator.maxTouchPoints>0}detectPointerEvents(){return"undefined"!=typeof PointerEvent}detectDeviceOrientation(){return"ondeviceorientation"in window}detectCanvas2D(){try{return!!document.createElement("canvas").getContext("2d")}catch{return!1}}detectCanvasFilters(){try{return"filter"in document.createElement("canvas").getContext("2d")}catch{return!1}}detectOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}measurePerformance(){const t={},e=performance.now();t.jsExecutionSpeed=performance.now()-e;try{const e=document.createElement("canvas");e.width=100,e.height=100;const i=e.getContext("2d"),s=performance.now();for(let t=0;t<1e3;t++)i.fillRect(100*Math.random(),100*Math.random(),10,10);t.canvasPerformance=performance.now()-s}catch{t.canvasPerformance=null}return t}getCapabilities(){return{...this.capabilities}}getPerformance(){return{...this.performance}}generateReport(){const t=Object.entries(this.capabilities).filter(([,t])=>t).map(([t])=>t),e=Object.entries(this.capabilities).filter(([,t])=>!t).map(([t])=>t),i=t.length/Object.keys(this.capabilities).length*100;return{timestamp:Date.now(),userAgent:navigator.userAgent,supportedFeatures:t,unsupportedFeatures:e,supportPercentage:Math.round(i),performance:this.performance,recommendations:this.generateRecommendations(i)}}generateRecommendations(t){const e=[];return t<50&&e.push("Consider using the minimal build for better compatibility"),this.capabilities.webGL||e.push("WebGL not supported - advanced graphics features unavailable"),this.capabilities.webWorkers||e.push("Web Workers not supported - background processing unavailable"),this.capabilities.fetch||e.push("Fetch API not supported - consider using XMLHttpRequest polyfill"),this.performance.jsExecutionSpeed>50&&e.push("Slow JavaScript execution detected - consider performance optimizations"),this.performance.canvasPerformance>100&&e.push("Slow canvas performance detected - consider reducing visual complexity"),e}};function Sf(t){const e=[];for(let i=0;i<t;i++){const s=i/t*Math.PI*2;e.push({x:.5+.5*Math.cos(s),y:.5+.5*Math.sin(s)})}return e}function kf(t,e=12){return Sf(t)}const xf={circle:{points:Sf(64),shadow:{type:"none"}},sphere:{points:Sf(64),shadow:{type:"none"}},heart:{points:function(){const t=[];for(let e=0;e<64;e++){const i=e/64*Math.PI*2,s=16*Math.pow(Math.sin(i),3),n=-(13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i));t.push({x:.5+s/32,y:.5+n/32})}return t}(),shadow:{type:"none"}},star:{points:function(){const t=[];for(let e=0;e<64;e++){const i=e/64,s=Math.floor(10*i),n=s%2==0,r=Math.floor(s/2);let o;o=n?(72*r-90)*Math.PI/180:(72*r+36-90)*Math.PI/180;const a=n?.5:.2;t.push({x:.5+Math.cos(o)*a,y:.5+Math.sin(o)*a})}return t}(),shadow:{type:"none"}},sun:{points:kf(64,12),shadow:{type:"sun",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3}},moon:{points:Sf(64),shadow:{type:"crescent",coverage:.85,angle:-30,softness:.05,offset:.7}},lunar:{points:Sf(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)",progression:"center"}},suspicion:{points:function(){const t=[];for(let e=0;e<64;e++){const i=e/64*Math.PI*2;let s,n;if(i<Math.PI)s=.45*Math.cos(i),n=.45*Math.sin(i);else{const t=2*Math.PI-i;s=.25*Math.cos(t)-.1,n=.35*Math.sin(t)}t.push({x:.5+s,y:.5+n})}return t}(),shadow:{type:"none"}},eclipse:{points:Sf(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)"}},square:{points:function(){const t=[],e=Math.floor(16);for(let i=0;i<4;i++)for(let s=0;s<e;s++){const n=s/e;let r,o;switch(i){case 0:r=-.5+n,o=-.5;break;case 1:r=.5,o=-.5+n;break;case 2:r=.5-n,o=.5;break;case 3:r=-.5,o=.5-n}t.push({x:.5+.8*r,y:.5+.8*o})}return t}(),shadow:{type:"none"}},triangle:{points:function(){const t=[],e=[{x:0,y:-.5},{x:-.433,y:.25},{x:.433,y:.25}],i=[Math.sqrt(Math.pow(e[1].x-e[0].x,2)+Math.pow(e[1].y-e[0].y,2)),Math.sqrt(Math.pow(e[2].x-e[1].x,2)+Math.pow(e[2].y-e[1].y,2)),Math.sqrt(Math.pow(e[0].x-e[2].x,2)+Math.pow(e[0].y-e[2].y,2))],s=i[0]+i[1]+i[2],n=i.map(t=>Math.round(64*t/s)),r=n.reduce((t,e)=>t+e,0);r<64&&(n[0]+=64-r);for(let i=0;i<3;i++){const s=e[i],r=e[(i+1)%3],o=n[i];for(let e=0;e<o;e++){if(e===o-1&&i<2)continue;const n=e/o,a=s.x+(r.x-s.x)*n,h=s.y+(r.y-s.y)*n;t.push({x:.5+.9*a,y:.5+.9*h})}}for(;t.length<64;)t.push(t[t.length-1]);for(;t.length>64;)t.pop();return t}(),shadow:{type:"none"}},solar:{points:kf(64,12),shadow:{type:"solar-hybrid",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3,lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"}}}},Tf=new class{constructor(){this.shapeCache=new Map,this.morphCache=new Map,this.propertyCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const t=Object.keys(xf);t.forEach(t=>{this.cacheShape(t)}),this.cacheCommonMorphs(t),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.shapeCache.size}catch(t){this.isInitialized=!1}}cacheShape(t){try{const e=xf[t];if(e){this.shapeCache.set(t,e);const i={pointCount:e.points?.length||64,hasShadow:"none"!==e.shadow?.type,shadowType:e.shadow?.type||"none",isRadial:this.isRadialShape(t),bounds:this.calculateBounds(e.points)};this.propertyCache.set(t,i)}}catch(t){}}cacheCommonMorphs(t){[["circle","heart"],["circle","star"],["circle","square"],["heart","star"],["star","circle"],["square","circle"],["triangle","circle"],["moon","sun"],["lunar","eclipse"]].forEach(([e,i])=>{if(t.includes(e)&&t.includes(i))try{const t=this.calculateMorphSteps(e,i),s=`${e}->${i}`;this.morphCache.set(s,t)}catch(t){}})}calculateMorphSteps(t,e){const i=this.shapeCache.get(t),s=this.shapeCache.get(e);if(!i||!s)return null;const n=[];for(let t=0;t<5;t++){const e=t/4,r=this.interpolateShapePoints(i.points,s.points,e);n.push({progress:e,points:r})}return{from:t,to:e,steps:n,isRadial:this.isRadialShape(t)||this.isRadialShape(e)}}interpolateShapePoints(t,e,i){if(!t||!e)return t||e||[];const s=Math.max(t.length,e.length),n=[];for(let r=0;r<s;r++){const s=t[r]||t[0]||{x:.5,y:.5},o=e[r]||e[0]||{x:.5,y:.5};n.push({x:s.x+(o.x-s.x)*i,y:s.y+(o.y-s.y)*i})}return n}isRadialShape(t){return["circle","star","square","triangle","sun","moon"].includes(t)}calculateBounds(t){if(!t||0===t.length)return{minX:0,minY:0,maxX:1,maxY:1,width:1,height:1};let e=1/0,i=1/0,s=-1/0,n=-1/0;return t.forEach(t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),s=Math.max(s,t.x),n=Math.max(n,t.y)}),{minX:e,minY:i,maxX:s,maxY:n,width:s-e,height:n-i}}getShape(t){if(!this.isInitialized)return xf[t]||null;const e=this.shapeCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,xf[t]||null)}getProperties(t){if(!this.isInitialized){const e=xf[t];return e?{pointCount:e.points?.length||64,hasShadow:"none"!==e.shadow?.type,shadowType:e.shadow?.type||"none",isRadial:this.isRadialShape(t),bounds:this.calculateBounds(e.points)}:{}}const e=this.propertyCache.get(t);return e?(this.stats.hits++,e):(this.stats.misses++,{})}getMorph(t,e){if(!this.isInitialized)return this.calculateMorphSteps(t,e);const i=`${t}->${e}`,s=this.morphCache.get(i);return s?(this.stats.hits++,s):(this.stats.misses++,this.calculateMorphSteps(t,e))}hasShape(t){return this.shapeCache.has(t)}getStats(){const t=this.stats.hits+this.stats.misses;return{...this.stats,hitRate:t>0?`${(this.stats.hits/t*100).toFixed(1)}%`:"0%",shapes:this.shapeCache.size,morphs:this.morphCache.size,properties:this.propertyCache.size}}clear(){this.shapeCache.clear(),this.morphCache.clear(),this.propertyCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1}},Ef=new class{constructor(){this.pools=new Map,this.inUse=new Set}acquire(t,e="array"){const i=`${e}_${t}`;this.pools.has(i)||this.pools.set(i,[]);const s=this.pools.get(i);if(s.length>0){const t=s.pop();return this.inUse.add(t),t}let n;switch(e){case"float32":n=new Float32Array(t);break;case"uint8":n=new Uint8Array(t);break;default:n=new Array(t).fill(0)}return this.inUse.add(n),n}release(t){if(!this.inUse.has(t))return;this.inUse.delete(t);let e="array";t instanceof Float32Array?e="float32":t instanceof Uint8Array&&(e="uint8");const i=`${e}_${t.length}`;t.fill(0),this.pools.has(i)||this.pools.set(i,[]);const s=this.pools.get(i);s.length<10&&s.push(t)}clear(){this.pools.clear(),this.inUse.clear()}};class Cf{constructor(t){this.morpher=t,this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.bassEnergy=0,this.vocalPresence=0,this.highFreqEnergy=0,this.transientActive=!1,this.transientStrength=0,this.transientDecay=.92,this.transientHoldTime=8,this.transientHoldCounter=0}applyAudioDeformation(t){if(!t||0===t.length)return this.morpher.generateFallbackCircle();if(this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.currentFrequencies&&this.morpher.audioAnalyzer.currentFrequencies.length>0){this.morpher.frequencyData=[...this.morpher.audioAnalyzer.currentFrequencies];let t=0,e=0;for(let i=0;i<=2&&i<this.morpher.frequencyData.length;i++)t+=this.morpher.frequencyData[i],e++;e>0&&(t/=e),this.morpher.bassPeakHistory||(this.morpher.bassPeakHistory=[],this.morpher.bassThumpTimer=0),this.morpher.bassPeakHistory.push(t),this.morpher.bassPeakHistory.length>20&&this.morpher.bassPeakHistory.shift();const i=this.morpher.bassPeakHistory.reduce((t,e)=>t+e,0)/this.morpher.bassPeakHistory.length,s=this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.microphoneStream;if(t>1.08*i&&t>(s?.15:.25)){const e=s?8:6;this.bassEnergy=Math.min(1,(t-i)*e),this.morpher.bassThumpTimer=12}else this.morpher.bassThumpTimer>0?(this.morpher.bassThumpTimer--,this.bassEnergy*=.9):this.bassEnergy=0;this.morpher.spectralHistory||(this.morpher.spectralHistory=[],this.morpher.spectralFluxHistory=[],this.morpher.onsetThreshold=0,this.morpher.musicDetector.reset(),this.morpher.detectedBPM=0,this.morpher.onsetStrengths=[],this.morpher.detectedTimeSignature=null,this.morpher.timeSignatureConfidence=0,this.morpher.measureStartTime=0,this.morpher.timeSignatureHistory=[],this.morpher.timeSignatureLocked=!1);const n=[...this.morpher.frequencyData];let r=0,o=0;if(this.morpher.spectralHistory.length>0){const t=this.morpher.spectralHistory[this.morpher.spectralHistory.length-1];for(let e=0;e<=2&&e<n.length;e++){const i=n[e]-t[e];i>0&&(o+=i)}for(let e=4;e<=15&&e<n.length;e++){const i=n[e]-t[e];i>0&&(r+=i*(e>=9&&e<=13?2:1))}o>.15&&(r*=.3)}if(this.morpher.spectralHistory.push(n),this.morpher.spectralHistory.length>30&&this.morpher.spectralHistory.shift(),this.morpher.spectralFluxHistory.push(r),this.morpher.spectralFluxHistory.length>30&&this.morpher.spectralFluxHistory.shift(),this.morpher.spectralFluxHistory.length>=10){const t=[...this.morpher.spectralFluxHistory].sort((t,e)=>t-e),e=t[Math.floor(t.length/2)],i=t.reduce((t,e)=>t+e,0)/t.length;this.morpher.onsetThreshold=e+.5*(i-e)}const a=r>1.2*this.morpher.onsetThreshold&&r>.02,h=r>2*this.morpher.onsetThreshold&&r>.05;if(a&&(this.transientHoldTime=8,this.morpher.vocalGlowBoost=.3),h){const t=performance.now(),e={time:t,strength:r/(this.morpher.onsetThreshold||1),bassWeight:o};this.morpher.onsetStrengths.push(e),this.morpher.onsetStrengths.length>40&&this.morpher.onsetStrengths.shift(),this.morpher.musicDetector.addOnset(t,r)}this.morpher.musicDetector.update(performance.now()),this.morpher.detectedBPM=this.morpher.musicDetector.detectedBPM,this.morpher.bpmConfidence=this.morpher.musicDetector.bpmConfidence,this.morpher.detectedBPM>0&&this.morpher.bpmConfidence>.8&&this.morpher.forceFastDetection&&(this.morpher.forceFastDetection=!1),this.transientHoldTime>0&&this.transientHoldTime--,this.morpher.vocalGlowBoost>0&&(this.morpher.vocalGlowBoost*=.92),this.vocalPresence=r,this.morpher.bassHistory[this.morpher.historyIndex]=this.bassEnergy,this.morpher.vocalHistory[this.morpher.historyIndex]=this.vocalPresence,this.morpher.historyIndex=(this.morpher.historyIndex+1)%this.morpher.bassHistory.length,this.morpher.bassEffectActive=this.morpher.bassThumpTimer>0,this.morpher.lastVocalPresence=this.morpher.lastVocalPresence||0,this.morpher.lastVocalPresence=this.vocalPresence,this.vocalEffectActive=this.transientHoldTime>0}const e=this.morpher.frequencyData&&this.morpher.frequencyData.some(t=>t>.01);if(this.morpher.audioAnalyzer&&e||(this.audioDeformation>.15?(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.min(1,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)):this.morpher.bassThumpTimer>0&&(this.morpher.bassThumpTimer--,this.bassEnergy*=.9),this.vocalEnergy>.2&&(this.vocalEffectActive=!0,this.vocalPresence=this.vocalEnergy)),!e&&this.audioDeformation>.15&&!this.morpher.bassEffectActive&&(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.max(this.bassEnergy,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)),!(0!==this.audioDeformation||this.bassEnergy>.01||this.vocalPresence>.01))return t;const i=[];if(this.morpher.bassEffectActive&&(Math.random()<.05&&(this.morpher.undulationDirection*=-1),this.morpher.undulationPhase+=.08*this.morpher.undulationDirection),this.morpher.audioAnalyzer&&this.beatGlitchIntensity>0&&(this.beatGlitchIntensity*=.9),this.vocalEffectActive&&Math.random()<.2){this.glitchPoints=[];const e=2+Math.floor(2*Math.random());for(let i=0;i<e;i++)this.glitchPoints.push({index:Math.floor(Math.random()*t.length),intensity:.02+.03*Math.random(),decay:.94+.02*Math.random()})}this.glitchPoints=this.glitchPoints.filter(t=>(t.intensity*=t.decay,t.intensity>.01));for(let e=0;e<t.length;e++){const s=t[e];if(!s||void 0===s.x||void 0===s.y){const s=e/t.length*Math.PI*2;i.push({x:.5+.5*Math.cos(s),y:.5+.5*Math.sin(s)});continue}const n=s.x-.5,r=s.y-.5,o=Math.sqrt(n*n+r*r),a=Math.atan2(r,n),h=.12*Math.abs(this.audioDeformation);let c=0,u=0;if(this.morpher.bassEffectActive){const t=2,e=.25*this.bassEnergy;c=Math.sin(a*t+this.morpher.undulationPhase)*e,u=Math.sin(.5*this.morpher.undulationPhase)*this.bassEnergy*.08}let l=0;const d=this.glitchPoints.find(t=>t.index===e);if(d){const t=.015*Date.now(),i=Math.sin(t+.5*e)*Math.cos(.7*t);l=d.intensity*i*.5}const p=1+h+c+u+l,f=o*Math.max(.8,p);i.push({x:.5+Math.cos(a)*f,y:.5+Math.sin(a)*f})}return i}setAudioDeformation(t){this.audioDeformation=Math.max(0,Math.min(1,t)),this.vocalEffectActive=t>.01}setVocalEnergy(t){this.vocalEnergy=Math.max(0,Math.min(1,t)),this.vocalEffectActive=t>.01}updateFrequencyBands(t){t&&(this.bassEnergy=t.bass||0,this.vocalPresence=t.vocal||0,this.highFreqEnergy=t.high||0)}processTransient(t,e){t>e?(this.transientActive=!0,this.transientStrength=t,this.transientHoldCounter=this.transientHoldTime):this.transientHoldCounter>0?this.transientHoldCounter--:(this.transientStrength*=this.transientDecay,this.transientStrength<.01&&(this.transientActive=!1))}getState(){return{audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy,vocalEffectActive:this.vocalEffectActive,beatGlitchIntensity:this.beatGlitchIntensity,transientActive:this.transientActive,transientStrength:this.transientStrength}}reset(){this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.transientActive=!1,this.transientStrength=0}}class Af{constructor(){this.agents=[],this.maxAgents=8,this.isActive=!1,this.confidence=0,this.lockedBPM=0,this.lastBeatTime=0,this.peakHistory=[],this.maxHistoryLength=100,this.minBPM=40,this.maxBPM=300,this.convergenceThreshold=.7,this.subdivisionPreference={slow:{min:40,max:80,prefer:1},normal:{min:80,max:140,prefer:1},fast:{min:140,max:180,prefer:.5},veryfast:{min:180,max:300,prefer:.5}}}createAgent(t,e=1){return{bpm:t,subdivision:e,effectiveBPM:t*e,phase:0,confidence:.5,hits:0,misses:0,lastBeatTime:performance.now(),beatInterval:6e4/(t*e)}}initializeAgents(t=120){this.agents=[];let e=[1];e=t>180||t>140?[.5,.75,1]:t<60?[1,1.5,2]:[.5,1,1.5],e.forEach(e=>{const i=this.createAgent(t,e);t*e<140&&(i.confidence=.6),this.agents.push(i)}),t>140&&(this.agents.push(this.createAgent(t/2,1)),this.agents.push(this.createAgent(t/2,1.5)))}processPeak(t,e=performance.now()){if(this.peakHistory.push({strength:t,time:e}),this.peakHistory.length>this.maxHistoryLength&&this.peakHistory.shift(),!(this.peakHistory.length<4)){if(!this.isActive||0===this.agents.length){const t=this.getFFTEstimate();this.initializeAgents(t),this.isActive=!0}this.lockedBPM>0&&this.confidence>.7?(this.agents.forEach(i=>{this.scoreAgent(i,e,t)}),this.confidence<.6&&(this.evolveAgents(),this.checkConvergence())):(this.agents.forEach(i=>{this.scoreAgent(i,e,t)}),this.evolveAgents(),this.checkConvergence())}}scoreAgent(t,e,i){const s=e-t.lastBeatTime,n=t.beatInterval,r=1-2*Math.abs(s%n/n-.5);r>.7?(t.hits++,t.confidence=Math.min(1,t.confidence+.1),r>.85&&(t.lastBeatTime=e)):r<.3&&(t.misses++,t.confidence=Math.max(0,t.confidence-.03)),t.confidence*=.998}evolveAgents(){this.agents.sort((t,e)=>e.confidence-t.confidence),this.agents.length>this.maxAgents&&(this.agents=this.agents.slice(0,this.maxAgents));const t=this.agents[0];if(t.confidence>.7&&this.agents.length<this.maxAgents){const e=1+.02*(Math.random()-.5),i=this.createAgent(t.bpm*e,t.subdivision);i.confidence=.8*t.confidence,this.agents.push(i)}this.agents=this.agents.filter(t=>t.confidence>.1)}checkConvergence(){if(0===this.agents.length)return;const t=this.agents[0];return t.confidence>this.convergenceThreshold&&this.agents.filter(e=>Math.abs(e.effectiveBPM-t.effectiveBPM)/t.effectiveBPM<.05).length>=Math.min(2,.3*this.agents.length)&&(this.lockedBPM=Math.round(t.bpm),this.confidence=t.confidence,this.autoSelectSubdivision(),!0)}autoSelectSubdivision(){for(const[,t]of Object.entries(this.subdivisionPreference))if(this.lockedBPM>=t.min&&this.lockedBPM<t.max&&this.agents.find(e=>Math.abs(e.bpm-this.lockedBPM)<2&&Math.abs(e.subdivision-t.prefer)<.1))return t.prefer;return 1}getFFTEstimate(){if(this.peakHistory.length<4)return 120;const t=this.peakHistory.slice(-10),e=[];for(let i=1;i<t.length;i++)e.push(t[i].time-t[i-1].time);if(0===e.length)return 120;e.sort((t,e)=>t-e);let i=6e4/e[Math.floor(e.length/2)];return i<this.minBPM?i*=2:i>this.maxBPM&&(i/=2),Math.max(this.minBPM,Math.min(this.maxBPM,i))}reset(t=null){this.agents=[],this.confidence=0,this.lockedBPM=0,this.peakHistory=[],t&&this.initializeAgents(t)}getBPM(){return this.lockedBPM>0&&this.confidence>.8?this.lockedBPM:this.agents.length>0?Math.round(this.agents[0].bpm):0}getSubdivision(){if(this.agents.length>0){const t=this.agents[0],{bpm:e}=t;for(const[,t]of Object.entries(this.subdivisionPreference))if(e>=t.min&&e<t.max)return t.prefer;return t.subdivision}return 1}getStatus(){return{bpm:this.getBPM(),subdivision:this.getSubdivision(),confidence:this.confidence,locked:this.lockedBPM>0&&this.confidence>.8,agentCount:this.agents.length,topAgents:this.agents.slice(0,3).map(t=>({bpm:Math.round(t.bpm),subdivision:t.subdivision,confidence:t.confidence.toFixed(2)}))}}}class If{constructor(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.onsetThreshold=.3,this.detectedBPM=0,this.bpmConfidence=0,this.lastBPMCalculation=0,this.bpmCalculationInterval=2e3,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.agentDetector=new Af,this.useAgentDetection=!0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.downbeatPhase=0,this.measureLength=4,this.measureStartTime=0,this.isMusicalContent=!1,this.musicalityScore=0,this.forceFastDetection=!1}calculateBPM(){if(this.useAgentDetection){const t=this.agentDetector.getStatus();if(t.locked&&t.confidence>.6)return this.detectedBPM=t.bpm,this.bpmConfidence=t.confidence,this.tempoLocked=!0,this.fundamentalBPM=t.bpm,this.bpmHistory.push(this.detectedBPM),this.bpmHistory.length>10&&this.bpmHistory.shift(),this.detectedBPM;if(t.bpm>0&&t.confidence>.4)return this.detectedBPM=t.bpm,this.bpmConfidence=t.confidence,t.confidence>.6&&(this.tempoLocked=!0),this.detectedBPM}if(this.onsetIntervals.length<4)return this.detectedBPM;const t=this.onsetIntervals.slice(-15),e=this.findTempoCandidates(t);if(0===e.length)return this.detectedBPM;const i=e[0],s=Math.round(6e4/i.interval);if(!this.tempoLocked&&this.bpmHistory.length>3){const t=this.bpmHistory.slice(-3),e=t.reduce((t,e)=>t+e,0)/t.length;t.reduce((t,i)=>t+Math.pow(i-e,2),0)/t.length<5&&(this.fundamentalBPM=Math.round(e),this.tempoLocked=!0,this.bpmConfidence=1)}let n=s;if(this.tempoLocked&&(this.checkHarmonicRelation(s,this.fundamentalBPM)?(n=this.fundamentalBPM,this.bpmConfidence=Math.min(1,this.bpmConfidence+.1)):(this.bpmConfidence*=.9,this.bpmConfidence<.3&&i.strength>.8?(this.fundamentalBPM=s,this.bpmConfidence=.5):n=this.fundamentalBPM)),this.bpmHistory.push(n),this.bpmHistory.length>10&&this.bpmHistory.shift(),0===this.detectedBPM)this.detectedBPM=n;else{const t=this.tempoLocked?1:2,e=n-this.detectedBPM;Math.abs(e)<=t?this.detectedBPM=n:this.detectedBPM+=Math.sign(e)*t}return window.rhythmIntegration&&window.rhythmIntegration.updateBPM&&(window.rhythmManuallyStoppedForCurrentAudio||window.rhythmIntegration.updateBPM(this.detectedBPM)),this.detectedBPM}findTempoCandidates(t){const e=[];for(const i of[1,2,4]){const s=t.map(t=>t*i),n=this.clusterIntervals(s);for(const s of n){const n=s.intervals.reduce((t,e)=>t+e,0)/s.intervals.length/i,r=s.intervals.length/t.length*s.consistency,o=6e4/n,a=o>=120&&o<=140?.2:0;o>=60&&o<=220&&e.push({interval:n,strength:r+a,multiplier:i})}}return e.sort((t,e)=>e.strength-t.strength)}clusterIntervals(t){const e=[...t].sort((t,e)=>t-e),i=[];let s=[e[0]];for(let t=1;t<e.length;t++){const n=.03*s[0];if(e[t]-s[0]<=n)s.push(e[t]);else{if(s.length>=2){const t=s.reduce((t,e)=>t+e,0)/s.length,e=1/(1+s.reduce((e,i)=>e+Math.pow(i-t,2),0)/s.length/(t*t));i.push({intervals:s,consistency:e})}s=[e[t]]}}if(s.length>=3){const t=s.reduce((t,e)=>t+e,0)/s.length,e=1/(1+s.reduce((e,i)=>e+Math.pow(i-t,2),0)/s.length/(t*t));i.push({intervals:s,consistency:e})}return i}checkHarmonicRelation(t,e){const i=Math.max(t,e)/Math.min(t,e);return[2,1.5,1.333,1.25].some(t=>Math.abs(i-t)<.03)}detectTimeSignature(){const t=this.forceFastDetection?6:12;if(0===this.detectedBPM||this.onsetStrengths.length<t)return this.timeSignature;if(this.timeSignatureLocked&&!this.forceFastDetection)return this.detectedTimeSignature||this.timeSignature;const e=6e4/this.detectedBPM,i=new Array(4).fill(0).map(()=>({strength:0,bassWeight:0,count:0})),s=this.onsetStrengths.slice(-Math.min(20,this.onsetStrengths.length));if(0===s.length)return this.timeSignature;const n=s[0].time;for(const t of s){const s=(t.time-n)/e%4,r=Math.round(s)%4;i[r].strength+=t.strength,i[r].bassWeight+=t.bassWeight||0,i[r].count++}for(const t of i)t.count>0&&(t.strength/=t.count,t.bassWeight/=t.count);let r="4/4";i[0].strength>2*i[1].strength&&i[0].strength>2*i[2].strength&&i[3].count<.5*i[0].count&&this.testWaltzPattern(s,e)>.8&&(r="3/4"),this.timeSignatureHistory.push(r),this.timeSignatureHistory.length>3&&this.timeSignatureHistory.shift();const o=this.forceFastDetection?2:3;if(this.timeSignatureHistory.length>=o){const t={};for(const e of this.timeSignatureHistory)t[e]=(t[e]||0)+1;let e="4/4",i=0;for(const[s,n]of Object.entries(t))n>i&&(i=n,e=s);if(i>=2){this.detectedTimeSignature=e,this.timeSignatureLocked=!0,this.timeSignatureConfidence=i/3,window.rhythmIntegration&&window.rhythmIntegration.setTimeSignature&&window.rhythmIntegration.setTimeSignature(this.detectedTimeSignature);const t=document.getElementById("time-sig-display");t&&(t.textContent=this.detectedTimeSignature)}}return this.detectedTimeSignature||this.timeSignature}testWaltzPattern(t,e){let i=0,s=0;for(let e=0;e<t.length-2;e+=3)if(e+2<t.length){s++;const n=t[e].strength+(t[e].bassWeight||0),r=t[e+1].strength+(t[e+1].bassWeight||0),o=t[e+2].strength+(t[e+2].bassWeight||0);n>1.5*r&&n>1.5*o&&i++}return s>0?i/s:0}addOnset(t,e,i=0){if(this.useAgentDetection&&this.agentDetector.processPeak(e,t),this.lastOnsetTime>0){const e=t-this.lastOnsetTime;e>273&&e<1e3&&(this.onsetIntervals.push(e),this.onsetIntervals.length>20&&this.onsetIntervals.shift())}this.onsetStrengths.push({time:t,strength:e,bassWeight:i}),this.onsetStrengths.length>40&&this.onsetStrengths.shift(),this.lastOnsetTime=t}update(t){t-this.lastBPMCalculation>this.bpmCalculationInterval&&(this.calculateBPM(),this.detectTimeSignature(),this.lastBPMCalculation=t)}getRecommendedSubdivision(){return this.useAgentDetection?this.agentDetector.getSubdivision():this.detectedBPM<60?2:this.detectedBPM<80?1:this.detectedBPM>180||this.detectedBPM>140?.5:1}reset(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.detectedBPM=0,this.bpmConfidence=0,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.agentDetector&&this.agentDetector.reset(),this.timeSignatureLocked=!1,this.isMusicalContent=!1,this.forceFastDetection=!1}getMusicInfo(){return{bpm:this.detectedBPM,confidence:this.bpmConfidence,timeSignature:this.timeSignature,isMusical:this.isMusicalContent,musicalityScore:this.musicalityScore}}}class Ff{constructor(t){this.morpher=t,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=800,this.transitionProgress=0,this.easingFunction="easeInOutQuad",this.currentShape="circle",this.targetShape=null,this.previousShape=null,this.morphQueue=[],this.maxQueueSize=3,this.shadowConfig=null,this.shadowProgress=0}startTransition(t,e={}){this.isTransitioning&&this.morphQueue.length<this.maxQueueSize?this.morphQueue.push({shape:t,options:e}):(this.previousShape=this.currentShape,this.targetShape=t,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.transitionDuration=e.duration||800,this.easingFunction=e.easing||"easeInOutQuad",this.transitionProgress=0,this.shadowConfig=this.getTransitionConfig(this.currentShape,t))}update(t){if(!this.isTransitioning)return;const e=performance.now()-this.transitionStartTime,i=Math.min(1,e/this.transitionDuration);this.transitionProgress=this.applyEasing(i),this.shadowConfig&&(this.shadowProgress=this.calculateShadowProgress(i)),i>=1&&this.completeTransition()}completeTransition(){if(this.currentShape=this.targetShape,this.targetShape=null,this.isTransitioning=!1,this.transitionProgress=0,this.shadowConfig=null,this.morphQueue.length>0){const t=this.morphQueue.shift();this.startTransition(t.shape,t.options)}}getTransitionConfig(t,e){return{"circle-heart":{type:"bloom",shadowColor:"#ff69b4",shadowIntensity:.3},"heart-circle":{type:"contract",shadowColor:"#ff69b4",shadowIntensity:.2},"circle-star":{type:"burst",shadowColor:"#ffd700",shadowIntensity:.4},"star-circle":{type:"collapse",shadowColor:"#ffd700",shadowIntensity:.3}}[`${t}-${e}`]||null}calculateShadowProgress(t){if(!this.shadowConfig)return 0;switch(this.shadowConfig.type){case"bloom":return t<.5?2*t:2-2*t;case"burst":return Math.pow(1-t,2);case"contract":case"collapse":return Math.sin(t*Math.PI);default:return 0}}applyEasing(t){switch(this.easingFunction){case"linear":default:return t;case"easeInQuad":return t*t;case"easeOutQuad":return t*(2-t);case"easeInOutQuad":return t<.5?2*t*t:(4-2*t)*t-1;case"easeInCubic":return t*t*t;case"easeOutCubic":return--t*t*t+1;case"easeInOutCubic":return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}}clearQueue(){this.morphQueue=[]}hasQueuedMorphs(){return this.morphQueue.length>0}getState(){return{isTransitioning:this.isTransitioning,currentShape:this.currentShape,targetShape:this.targetShape,progress:this.transitionProgress,queueLength:this.morphQueue.length}}reset(){this.isTransitioning=!1,this.currentShape="circle",this.targetShape=null,this.transitionProgress=0,this.morphQueue=[],this.shadowConfig=null}}class _f{constructor(t={}){this.numPoints=t.numPoints||64,this.morphDuration=t.morphDuration||1e3,this.easing=t.easing||"easeInOutCubic",this.transitionManager=new Ff(this),this.audioDeformer=new Cf(this),this.musicDetector=new If,this.currentShape="circle",this.targetShape=null,this.morphProgress=0,this.visualProgress=0,this.morphStartTime=null,this.isTransitioning=!1,this.queuedMorphTimeout=null,this.shapeCache=new Map,this.currentPoints=[],this.targetPoints=[],this.musicalDuration=null,this.onBeat=!1,this.audioDeformation=0,this.vocalEnergy=0,this.lastAudioUpdate=0,this.lastVocalUpdate=0,this.audioUpdateInterval=33,this.audioAnalyzer=null,this.frequencyData=Ef.acquire(32,"float32"),this.glitchPoints=[],this.undulationPhase=0,this.undulationDirection=1,this.beatGlitchIntensity=0,this.bassEnergy=0,this.vocalPresence=0,this.bassHistory=Ef.acquire(60,"float32"),this.vocalHistory=Ef.acquire(60,"float32"),this.historyIndex=0,this.bassEffectCooldown=0,this.vocalEffectCooldown=0,this.bassThresholdMultiplier=1.2,this.vocalThresholdMultiplier=1.1,this.bassEffectActive=!1,this.vocalEffectActive=!1,this.transientHoldTime=0,this.vocalGlowBoost=0,this.onComplete=null,this.onProgress=null,this.queuedMorph=null,this.currentPoints=this.getShapePoints("circle"),this.shapesLoaded=!0,this.prewarmCache()}prewarmCache(){["circle","heart","star","sun","moon","lunar","square","triangle"].forEach(t=>{(Tf&&Tf.isInitialized?Tf.hasShape(t):xf[t])&&this.getShapePoints(t)}),[0,.25,.5,.75,1].forEach(t=>{this.applyEasing(t)})}getShapePoints(t){if(!this.shapeCache.has(t)){const e=Tf&&Tf.isInitialized?Tf.getShape(t):xf[t];if(!e||!e.points){const e=xf.circle.points;return this.shapeCache.set(t,e),e}const{points:i}=e;return this.shapeCache.set(t,i),i}return this.shapeCache.get(t)}morphTo(t,e={}){if(!this.shapesLoaded)return;if(t===this.currentShape&&!this.isTransitioning)return;if(this.isTransitioning&&!e.force)return this.queuedMorph={targetShape:t,options:e},"queued";this.isTransitioning&&e.force&&this.completeMorph(!0);const i=this.getTransitionConfig(this.currentShape,t);if(this.targetShape=t,this.targetPoints=this.getShapePoints(t),this.morphStartTime=Date.now(),this.isTransitioning=!0,this.morphProgress=0,this.visualProgress=0,"bar"===e.duration||"beat"===e.duration){const t=6e4/(G.bpm||120);"bar"===e.duration?this.morphDuration=4*t:this.morphDuration=t,this.musicalDuration=!0,this.onBeat=!1!==e.onBeat}else this.morphDuration=i?.duration||e.duration||1e3,this.musicalDuration=null,this.onBeat=!1;this.morphMode=e.mode||"smooth",this.transitionConfig=i,this.onComplete=e.onComplete,this.onProgress=e.onProgress}update(t){if(this.audioAnalyzer&&this.audioAnalyzer.isAnalyzing){const t=this.audioAnalyzer.getShapeMorpherData();if(t&&t.frequencies){let e=!1;for(let i=0;i<Math.min(t.frequencies.length,this.frequencyData.length);i++)this.frequencyData[i]=t.frequencies[i],t.frequencies[i]>0&&(e=!0);e&&!this.Ki&&(this.Ki=!0)}}if(this.musicDetector&&this.musicDetector.update(performance.now()),!this.isTransitioning||!this.targetShape)return;const e=Date.now()-this.morphStartTime;if(this.musicalDuration){const t=6e4/(G.bpm||120),e=this.morphDuration>2*t;this.morphDuration=e?4*t:t}let i=Math.min(e/this.morphDuration,1);if(this.musicalDuration&&this.onBeat){const t=G.bpm||120;let e;e=t>140?2:t>100?4:8;const s=6e4/t,n=this.morphDuration/s,r=i*n,o=Math.round(r*e)/e,a=Math.min(1,o/n),h=(.3+.5*(t<90?Math.max(.3,(t-60)/30):Math.max(.4,Math.min(1,1-(t-90)/90))))*(.3+.7*Math.sin(i*Math.PI));i+=h*h*(3-2*h)*(a-i)}this.morphProgress=this.applyEasing(i),this.visualProgress=.8*this.visualProgress+.2*this.morphProgress,Math.abs(this.visualProgress-this.morphProgress)<.001&&(this.visualProgress=this.morphProgress),this.onProgress&&this.onProgress(this.morphProgress),this.morphProgress>=1&&(this.visualProgress=1,this.completeMorph())}completeMorph(t=!1){if(this.targetShape&&(this.currentShape=this.targetShape,this.currentPoints=[...this.targetPoints]),this.targetShape=null,this.isTransitioning=!1,this.morphProgress=0,this.visualProgress=0,this.onComplete&&this.onComplete(this.currentShape),!t&&this.queuedMorph){const t=this.queuedMorph;this.queuedMorph=null,this.queuedMorphTimeout=setTimeout(()=>{this.morphTo(t.targetShape,t.options),this.queuedMorphTimeout=null},50)}}hasQueuedMorph(){return null!==this.queuedMorph}clearQueue(){this.queuedMorph=null,this.queuedMorphTimeout&&(clearTimeout(this.queuedMorphTimeout),this.queuedMorphTimeout=null)}getCanvasPoints(t,e,i){let s;try{s=this.getInterpolatedPoints()}catch{s=this.generateFallbackCircle()}this.canvasPointsCache||(this.canvasPointsCache=[]);const n=this.canvasPointsCache;if(n.length=0,!s||0===s.length){for(let s=0;s<this.numPoints;s++){const r=s/this.numPoints*Math.PI*2;n.push({x:t+Math.cos(r)*i,y:e+Math.sin(r)*i})}return n}const r=Array.isArray(s)?s:[];for(let s=0;s<r.length;s++){const o=r[s];if(o&&"number"==typeof o.x&&"number"==typeof o.y){const s=t+(o.x-.5)*i*2,r=e+(o.y-.5)*i*2;n.push({x:s,y:r})}else{const o=s/r.length*Math.PI*2;n.push({x:t+Math.cos(o)*i,y:e+Math.sin(o)*i})}}for(;n.length<this.numPoints;){const s=n.length/this.numPoints*Math.PI*2;n.push({x:t+Math.cos(s)*i,y:e+Math.sin(s)*i})}return n}getInterpolatedPoints(){if(this.currentPoints&&0!==this.currentPoints.length||(this.currentPoints=this.generateFallbackCircle()),!this.isTransitioning)return this.applyAudioDeformation(this.currentPoints);const t=[];for(let e=0;e<this.numPoints;e++){const i=this.currentPoints[e],s=this.targetPoints[e];if(!i||!s){const i=e/this.numPoints*Math.PI*2;t.push({x:.5+.5*Math.cos(i),y:.5+.5*Math.sin(i)});continue}const n=this.visualProgress;let r,o;const a=["square","circle","star","triangle"],h=a.includes(this.currentShape),c=a.includes(this.targetShape);if(h||c){const t=.5,e=.5;if(c&&!h){const a=s.x-t,h=s.y-e;if(n<.3){const s=n/.3;r=i.x+(t-i.x)*s,o=i.y+(e-i.y)*s}else{const i=(n-.3)/.7;r=t+a*i,o=e+h*i}}else if(h&&!c){const a=i.x-t,h=i.y-e;if(n<.5){const t=n/.5;r=i.x-a*t,o=i.y-h*t}else{const i=(n-.5)/.5;r=t+(s.x-t)*i,o=e+(s.y-e)*i}}else{const a=i.x-t,h=i.y-e,c=s.x-t,u=s.y-e;if(n<.5){const t=n/.5;r=i.x-a*t,o=i.y-h*t}else{const i=(n-.5)/.5;r=t+c*i,o=e+u*i}}}else if("spiral"===this.morphMode){const t=n*Math.PI*2,a=.02*Math.sin(t+.2*e)*(1-2*Math.abs(n-.5));r=i.x+(s.x-i.x)*n+a,o=i.y+(s.y-i.y)*n+a}else if("wave"===this.morphMode){const t=.01*Math.sin(.3*e+n*Math.PI*4);r=i.x+(s.x-i.x)*n+t,o=i.y+(s.y-i.y)*n+t}else r=i.x+(s.x-i.x)*n,o=i.y+(s.y-i.y)*n;t.push({x:r,y:o})}return this.applyAudioDeformation(t)}applyAudioDeformation(t){return this.audioDeformer.applyAudioDeformation(t)}setAudioDeformation(t){const e=Date.now();e-this.lastAudioUpdate>this.audioUpdateInterval&&(this.audioDeformation=Math.max(-1,Math.min(1,t)),this.lastAudioUpdate=e,this.audioDeformer&&this.audioDeformer.setAudioDeformation(Math.abs(this.audioDeformation)))}setVocalEnergy(t){const e=Date.now();e-this.lastVocalUpdate>this.audioUpdateInterval&&(this.vocalEnergy=Math.max(0,Math.min(1,t)),this.lastVocalUpdate=e,this.audioDeformer&&this.audioDeformer.setVocalEnergy(this.vocalEnergy))}getTransitionConfig(t,e){const i=Tf&&Tf.isInitialized?Tf.getShape(t):xf[t],s=Tf&&Tf.isInitialized?Tf.getShape(e):xf[e];return"moon"===e?{type:"to_moon",easing:"easeInOutCubic",duration:1500,glowIntensity:1.5,fadeInCrescent:!0}:"moon"===t&&"lunar"===e?{type:"moon_to_lunar",easing:"easeInOutSine",duration:2e3,slideOutCrescent:!1,description:"Crescent shadow moves to center and becomes lunar eclipse"}:"moon"===t?{type:"from_moon",easing:"easeInOutCubic",duration:1e3,slideOutCrescent:!0,shadowSlideRatio:.4,description:"Moon shadow slides away THEN morphs to target"}:"lunar"===e?{type:"eclipse_enter_lunar",startAngle:-30}:"lunar"===t&&"moon"===e?{type:"lunar_to_moon",exitAngle:-30}:"lunar"===t?{type:"eclipse_exit_lunar",exitAngle:-30}:"none"===i?.shadow?.type&&"solar"===s?.shadow?.type?{type:"eclipse_enter",direction:"right"}:"solar"===i?.shadow?.type&&"none"===s?.shadow?.type?{type:"eclipse_exit",direction:"left"}:"sun"===t&&"sun"!==e?{type:"sun_fade",fadeEffects:!0}:"sun"!==t&&"sun"===e?{type:"sun_bloom",bloomEffects:!0}:{type:"standard"}}getCurrentShadow(){const t=this.currentShape||"circle",e=Tf&&Tf.isInitialized?Tf.getShape(t):xf[t],i=this.targetShape?Tf&&Tf.isInitialized?Tf.getShape(this.targetShape):xf[this.targetShape]:null,s=e?.shadow||{type:"none"},n=i?.shadow||null;if(!this.isTransitioning||!n)return s;const r=this.morphProgress;if(this.transitionConfig&&"from_moon"===this.transitionConfig.type&&this.transitionConfig.slideOutCrescent){const t=this.transitionConfig.shadowSlideRatio||.4;if(r<t){const e=r/t,i=-30*Math.PI/180,s=.7,n=s+(2.5-s)*e;return{type:"crescent",coverage:e>.8?.85*(1-5*(e-.8)):.85,angle:-30,offset:n,shadowX:Math.cos(i)*n,shadowY:Math.sin(i)*n}}return{type:"none"}}if(this.transitionConfig&&"moon_to_lunar"===this.transitionConfig.type){const t=this.transitionConfig.startAngle*Math.PI/180,e=1-r,i=.7*Math.cos(t)*e,s=.7*Math.sin(t)*e,n=Math.pow(r,2);if(r<.6)return{type:"crescent",coverage:.85*(1-.2*n),angle:this.transitionConfig.startAngle,offset:.7*e,shadowX:i,shadowY:s};{const t=(r-.6)/.4,e=Math.sin(t*Math.PI/2);return{type:"lunar",coverage:.85+.1*e,color:`rgba(80, 20, 0, ${.7+.2*e})`,shadowX:i*(1-e),shadowY:s*(1-e),diffusion:e,shadowProgress:r}}}if(this.transitionConfig&&"eclipse_enter_lunar"===this.transitionConfig.type){if(r<.3)return{type:"none"};const t=(r-.3)/.7,e=Math.sin(t*Math.PI/2),i=this.transitionConfig.startAngle*Math.PI/180,s=1-e,n=.7*Math.cos(i)*s,o=.7*Math.sin(i)*s;if(t<.7)return{type:"crescent",coverage:.85*Math.pow(t/.7,.5),angle:this.transitionConfig.startAngle,offset:.7*s,shadowX:n,shadowY:o};{const e=(t-.7)/.3,i=Math.sin(e*Math.PI/2);return{type:"lunar",coverage:.85+.1*i,color:`rgba(80, 20, 0, ${.6+.3*i})`,shadowX:n*(1-i),shadowY:o*(1-i),diffusion:i,shadowProgress:t}}}if(this.transitionConfig&&"lunar_to_moon"===this.transitionConfig.type){const t=this.transitionConfig.exitAngle*Math.PI/180,e=Math.sin(r*Math.PI/2),i=.7*Math.cos(t)*e,s=.7*Math.sin(t)*e;if(r<.6){const t=r/.6,e=Math.pow(t,.7);return{type:"lunar",coverage:.95-.1*e,color:`rgba(80, 20, 0, ${.9-.3*e})`,shadowX:.7*i,shadowY:.7*s,diffusion:1-e}}{const t=(r-.6)/.4;return{type:"crescent",coverage:.85*Math.sin(t*Math.PI/2)+.1,angle:this.transitionConfig.exitAngle,offset:.7,shadowX:i,shadowY:s}}}if(this.transitionConfig&&"eclipse_exit_lunar"===this.transitionConfig.type){if(r<.7){const t=r/.7,e=this.transitionConfig.exitAngle*Math.PI/180;if(t<.4){const i=t/.4,s=1-i,n=.3*i;return{type:"lunar",coverage:.95-.1*i,color:`rgba(80, 20, 0, ${.9-.2*i})`,shadowX:.7*Math.cos(e)*n,shadowY:.7*Math.sin(e)*n,diffusion:s}}{const i=(t-.4)/.6,s=Math.pow(i,.8),n=.7*Math.cos(e)*s,r=.7*Math.sin(e)*s;return{type:"crescent",coverage:.85*(1-Math.pow(i,2)),angle:this.transitionConfig.exitAngle,offset:.7*s,shadowX:n,shadowY:r}}}return{type:"none"}}if(this.transitionConfig&&"eclipse_enter"===this.transitionConfig.type){const t=1.5-1.5*r;return{...n,shadowX:t,shadowProgress:r}}if("eclipse_exit"===this.transitionConfig.type){const t=1.5*-r;return{...s,coverage:s.coverage*(1-r),shadowX:t,shadowProgress:1-r}}if("sun_fade"===this.transitionConfig.type){const t=1-r;return{...s,intensity:(s.intensity||1)*Math.pow(t,.7),corona:s.corona,coronaOpacity:t,flares:s.flares,flaresOpacity:Math.pow(t,1.5),texture:s.texture,textureOpacity:Math.pow(t,2),turbulence:(s.turbulence||.3)*t}}if("sun_bloom"===this.transitionConfig.type){const t=r;return{...n,intensity:(n.intensity||1)*Math.pow(t,1.5),corona:n.corona,coronaOpacity:Math.pow(t,.8),flares:n.flares,flaresOpacity:t>.3?Math.pow((t-.3)/.7,.7):0,texture:n.texture,textureOpacity:t>.5?Math.pow((t-.5)/.5,2):0,turbulence:(n.turbulence||.3)*t}}if("none"!==s.type||"none"!==n.type){const t=(s.coverage||0)+((n.coverage||0)-(s.coverage||0))*r;return{type:"none"!==n.type?n.type:s.type,coverage:t,angle:n.angle||s.angle||0,softness:n.softness||s.softness||.2,progress:r}}return s}getCurrentRenderer(){return null}applyEasing(t){switch(this.transitionConfig?.easing||this.easing||"linear"){case"linear":return t;case"easeInQuad":return t*t;case"easeOutQuad":return t*(2-t);case"easeInOutQuad":return t<.5?2*t*t:(4-2*t)*t-1;case"easeInOutSine":return-(Math.cos(Math.PI*t)-1)/2;default:return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}calculateBPM(){return this.musicDetector.calculateBPM()}findTempoCandidates(t){return this.musicDetector.findTempoCandidates(t)}clusterIntervals(t){return this.musicDetector.clusterIntervals(t)}checkHarmonicRelation(t,e){return this.musicDetector.checkHarmonicRelation(t,e)}detectTimeSignature(){this.musicDetector.forceFastDetection=this.forceFastDetection;const t=this.musicDetector.detectTimeSignature();return this.detectedTimeSignature=this.musicDetector.detectedTimeSignature,this.timeSignatureConfidence=this.musicDetector.timeSignatureConfidence,this.timeSignatureLocked=this.musicDetector.timeSignatureLocked,t}testWaltzPattern(t,e){return this.musicDetector.testWaltzPattern(t,e)}resetMusicDetection(){this.forceFastDetection=!0,this.musicDetector.reset(),this.musicDetector.forceFastDetection=!0,this.onsetThreshold=0,this.detectedBPM=0,this.bpmConfidence=0,this.onsetStrengths=[],this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.musicDetector.lastBPMCalculation=0,this.measureStartTime=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.spectralHistory=[],this.spectralFluxHistory=[];const t=document.getElementById("time-sig-display");t&&(t.textContent="—")}getCurrentMusicInfo(){return{bpm:this.detectedBPM,timeSignature:this.detectedTimeSignature,bpmLocked:this.tempoLocked,timeSigLocked:this.timeSignatureLocked}}generateFallbackCircle(){const t=[];for(let e=0;e<this.numPoints;e++){const i=e/this.numPoints*Math.PI*2;t.push({x:.5+.5*Math.cos(i),y:.5+.5*Math.sin(i)})}return t}getState(){return{currentShape:this.currentShape,targetShape:this.targetShape,isTransitioning:this.isTransitioning,progress:this.morphProgress,audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy}}getProgress(t=!0){return t?this.visualProgress:this.morphProgress}isInTransition(){return this.isTransitioning}destroy(){this.queuedMorphTimeout&&(clearTimeout(this.queuedMorphTimeout),this.queuedMorphTimeout=null),this.queuedMorph=null,this.shapeCache.clear(),this.canvasPointsCache=null,this.frequencyData&&(Ef.release(this.frequencyData),this.frequencyData=null),this.bassHistory&&(Ef.release(this.bassHistory),this.bassHistory=null),this.vocalHistory&&(Ef.release(this.vocalHistory),this.vocalHistory=null),this.audioAnalyzer=null}}class Rf{constructor(){this.audioContext=null,this.analyser=null,this.source=null,this.elementSource=null,this.dataArray=null,this.isAnalyzing=!1,this.connectedElement=null,this.gainNode=null,this.animationFrameId=null,this.frequencyBands=32,this.smoothingFactor=.3,this.vocalRange={min:80,max:1e3},this.currentAmplitude=0,this.currentFrequencies=new Array(this.frequencyBands).fill(0),this.beatThreshold=.3,this.lastBeatTime=0,this.beatCallbacks=[]}init(){try{return this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state?this.audioContext.resume().then(()=>(this.createAnalyser(),!0)).catch(()=>!1):(this.createAnalyser(),!0)}catch(t){return!1}}createAnalyser(){if(this.audioContext&&!this.analyser){this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.5;const t=this.analyser.frequencyBinCount;this.dataArray=new Uint8Array(t)}}connectAudioElement(t){if(this.audioContext)try{this.elementSource&&this.connectedElement===t||(this.elementSource=this.audioContext.createMediaElementSource(t),this.elementSource.connect(this.analyser),this.elementSource.connect(this.audioContext.destination)),this.source=this.elementSource,this.connectedElement=t,this.isAnalyzing=!0,this.analyze()}catch(e){e.message&&e.message.includes("already been used")&&(this.source=this.elementSource,this.connectedElement=t,this.isAnalyzing=!0,this.analyze())}}analyze(){if(!this.isAnalyzing)return;this.animationFrameId=requestAnimationFrame(()=>this.analyze()),this.analyser.getByteFrequencyData(this.dataArray);const t=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteTimeDomainData(t);let e=0,i=0,s=0;const n=this.audioContext.sampleRate/2/this.dataArray.length,r=Math.floor(this.vocalRange.min/n),o=Math.ceil(this.vocalRange.max/n);for(let t=0;t<this.dataArray.length;t++){const n=this.dataArray[t]/255;e+=n,t>=r&&t<=o&&(i+=n,s++)}this.currentAmplitude=e/this.dataArray.length;const a=s>0?i/s:0;return this.extractFrequencyBands(),this.detectBeat(this.currentAmplitude),{amplitude:this.currentAmplitude,vocalAmplitude:a,frequencies:this.currentFrequencies,rawData:this.dataArray}}extractFrequencyBands(){const t=Math.floor(this.dataArray.length/this.frequencyBands);for(let e=0;e<this.frequencyBands;e++){let i=0;const s=e*t,n=Math.min(s+t,this.dataArray.length);for(let t=s;t<n;t++)i+=this.dataArray[t]/255;const r=i/t;this.currentFrequencies[e]=this.currentFrequencies[e]*this.smoothingFactor+r*(1-this.smoothingFactor)}}detectBeat(t){const e=performance.now();t>this.beatThreshold&&e-this.lastBeatTime>60&&(this.lastBeatTime=e,this.beatCallbacks.forEach(e=>e(t)))}getVocalInstability(){let t=0;const e=this.currentFrequencies.reduce((t,e)=>t+e,0)/this.frequencyBands;for(let i=0;i<this.frequencyBands;i++)t+=Math.pow(this.currentFrequencies[i]-e,2);return t=Math.sqrt(t/this.frequencyBands),Math.min(1,2*t+.5*this.currentAmplitude)}getShapeMorpherData(){return{instability:this.getVocalInstability(),frequencies:[...this.currentFrequencies],amplitude:this.currentAmplitude}}onBeat(t){this.beatCallbacks.push(t)}stop(){if(this.isAnalyzing=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.gainNode){try{this.gainNode.disconnect()}catch{}this.gainNode=null}if(this.elementSource&&this.connectedElement){try{this.elementSource.connect(this.analyser)}catch{}this.source=this.elementSource}}async resume(){this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume()}destroy(){this.stop(),null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.dataArray=null,this.beatCallbacks=[]}}class Pf{constructor(){this.timingClasses={downbeat:{gestures:["bounce","jump","headBob","spin","orbit"],timing:1,priority:1,description:"Strong emphasis on the downbeat"},upbeat:{gestures:["wave","nod","point","reach"],timing:.5,priority:2,description:"Medium emphasis on upbeat"},offbeat:{gestures:["wiggle","sway","lean","tilt","groove"],timing:.5,priority:3,description:"Syncopated, creates groove"},subdivision:{gestures:["pulse","sparkle","flash","shimmer","flicker"],timing:.25,priority:4,description:"Quick accents and fills"},continuous:{gestures:["breathe","float","rain"],timing:-1,priority:5,description:"Ambient, continuous motion"}},this.fillPatterns={subtle:["breathe","float"],rhythmic:["pulse","shimmer"],energetic:["wiggle","sparkle"],smooth:["sway","glow"]},this.densityProfiles={sparse:{fillProbability:.1,subdivisionLevel:2,description:"Minimal movement"},moderate:{fillProbability:.3,subdivisionLevel:4,description:"Balanced movement"},dense:{fillProbability:.5,subdivisionLevel:8,description:"Busy, energetic"},chaos:{fillProbability:.8,subdivisionLevel:16,description:"Maximum energy"}},this.groups={movement:{gestures:["bounce","spin","orbit","sway","hula","jump","twist","groove"],maxSimultaneous:1,priority:1,description:"Primary body movements - mutually exclusive"},expression:{gestures:["wave","nod","shake","point","lean","tilt","reach"],maxSimultaneous:2,priority:2,description:"Expressive gestures - can combine up to 2"},dance:{gestures:["headBob","wiggle","runningman","charleston"],maxSimultaneous:1,priority:2,description:"Dance moves - one at a time but can add effects"},effects:{gestures:["pulse","glow","sparkle","flash","shimmer","flicker"],maxSimultaneous:-1,priority:3,description:"Visual effects - all can layer together"},modifiers:{gestures:["breathe","float","rain"],maxSimultaneous:-1,priority:4,description:"Ambient effects - always allowed"}},this.enhancingCombinations=[["bounce","sparkle"],["spin","glow"],["wave","pulse"],["nod","pulse"],["jump","flash"],["sway","breathe"],["float","shimmer"],["orbit","sparkle"],["headBob","pulse"]],this.incompatiblePairs=[["bounce","jump"],["spin","orbit"],["wave","point"],["nod","shake"],["lean","tilt"]],this.chords={celebrate:["bounce","sparkle","pulse"],greeting:["wave","nod","glow"],excited:["jump","flash","wiggle"],mystical:["float","shimmer","breathe"],party:["headBob","pulse","sparkle"],smooth:["sway","glow","breathe"],dramatic:["spin","flash","sparkle"]},this.chains={rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash",buildup:"pulse > pulse > bounce+sparkle > spin+flash",cascade:"wave > lean > tilt > spin > bounce+glow",celebrate:"bounce+sparkle > spin > jump+flash > nod+pulse",smooth:"sway+breathe > float > orbit+shimmer > sway+glow",custom:"expand > contract > morph > expand+glow",greeting:"wave+glow > nod+pulse > wave",mystical:"float+shimmer > orbit+breathe > spin+sparkle > float+glow"}}canExecuteSimultaneously(t,e){if(t===e)return!1;if(this.incompatiblePairs.some(i=>i.includes(t)&&i.includes(e)))return!1;const i=this.getGestureGroup(t),s=this.getGestureGroup(e);if(i===s){const t=this.groups[i];return t&&1!==t.maxSimultaneous}return!("movement"===i&&"movement"===s||"dance"===i&&"dance"===s)}getGestureGroup(t){for(const[e,i]of Object.entries(this.groups))if(i.gestures.includes(t))return e;return null}getGesturePriority(t){const e=this.getGestureGroup(t);return e?this.groups[e].priority:99}getCompatibleGestures(t){if(!t||0===t.length)return[];if(1===t.length)return t;const e=[],i=new Set,s=t=>"string"==typeof t?t:t.gestureName,n=[...t].sort((t,e)=>this.getGesturePriority(s(t))-this.getGesturePriority(s(e)));for(const t of n){if(i.has(t))continue;const n=s(t);let r=!0;for(const t of e){const e=s(t);if(!this.canExecuteSimultaneously(n,e)){r=!1;break}}if(r){const r=this.groups[this.getGestureGroup(n)];if(r&&r.maxSimultaneous>0&&e.filter(t=>this.getGestureGroup(s(t))===this.getGestureGroup(n)).length>=r.maxSimultaneous)continue;e.push(t),i.add(t)}}return e}parseChain(t){return t?(this.chains[t]&&(t=this.chains[t]),t.split(">").map(t=>t.trim()).map(t=>t.split("+").map(t=>t.trim()).filter(t=>t))):[]}isEnhancingCombination(t){const e=t.map(t=>"string"==typeof t?t:t.gestureName);return this.enhancingCombinations.some(t=>t.every(t=>e.includes(t)))}getChord(t){return this.chords[t]||null}createChord(t){const e=this.getCompatibleGestures(t),i=this.isEnhancingCombination(e);return{type:"chord",gestures:e.map(t=>"string"==typeof t?t:t.gestureName),isEnhancing:i,timestamp:Date.now()}}isValidGesture(t){return null!==this.getGestureGroup(t)}getAllGestures(){const t=[];for(const e of Object.values(this.groups))t.push(...e.gestures);return[...new Set(t)]}getGestureTiming(t){for(const[e,i]of Object.entries(this.timingClasses))if(i.gestures.includes(t))return{name:e,...i};return null}getNextBeatForGesture(t,e,i=1){const s=this.getGestureTiming(t);if(!s)return e+1;if(-1===s.timing)return e;const n=s.timing/i,r=Math.ceil(e/n)*n;return"offbeat"===s.name?r+.5:r}getFillGestures(t,e="moderate"){const i=this.densityProfiles[e]||this.densityProfiles.moderate;let s;return s=t<80?"energetic":t<120?"rhythmic":t<160?"smooth":"subtle",Math.random()<i.fillProbability&&this.fillPatterns[s]||[]}getNextBeatTiming(t,e,i){return this.getNextBeatForGesture(t,e)}getIntensityFromBPM(t){return t<60?"dense":t<100||t<140?"moderate":"sparse"}applySwingTiming(t,e=.67){return.5==t%1?Math.floor(t)+e:t}}const Of=new Pf;var Bf=Object.freeze({__proto__:null,GestureCompatibility:Pf,default:Of});class Df{constructor(){this.templates={straight:{name:"Straight",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",pattern:{emphasis:[1,0,.5,0],velocities:[1,0,.6,0],subdivisions:[0,.5]},swing:0,humanization:.05,preferredGestures:{downbeat:["bounce","headBob","jump"],offbeat:["pulse","breathe"],fills:["sparkle","glow"]},compositeMove:null,intensity:"moderate",description:"Standard 4/4 rhythm, good for pop/rock"},swing:{name:"Swing",timeSignature:"4/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:"swingOut",pattern:{emphasis:[1,0,.66,0],velocities:[1,0,.7,0],subdivisions:[0,.66]},swing:.67,humanization:.08,preferredGestures:{downbeat:["sway","lean","bounce"],offbeat:["wiggle","pulse"],fills:["shimmer","float"]},intensity:"moderate",description:"Jazz swing feel with triplet subdivision"},shuffle:{name:"Shuffle",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,.25,.5,.75],velocities:[1,.3,.7,.3],subdivisions:[0,.25,.5,.75]},swing:.75,humanization:.06,preferredGestures:{downbeat:["bounce","headBob"],upbeat:["twist","wiggle"],offbeat:["pulse","breathe"],fills:["sparkle","flash"]},intensity:"dense",description:"Blues/rock shuffle with heavy swing"},latin:{name:"Latin",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"latinHips",pattern:{emphasis:[1,0,.375,.5,0,.75,0,0],velocities:[1,0,.8,.9,0,.8,0,0],subdivisions:[0,.375,.5,.75]},swing:0,humanization:.04,preferredGestures:{downbeat:["sway","wiggle"],syncopation:["twist","lean"],offbeat:["pulse","shimmer"],fills:["sparkle","shake"]},intensity:"dense",description:"Latin clave rhythm with syncopation"},breakbeat:{name:"Breakbeat",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,0,0,.75,.25,.5,0,.625],velocities:[1,0,0,.9,.6,.8,0,.7],subdivisions:[0,.25,.5,.625,.75]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","twist"],syncopation:["flash","shake"],offbeat:["pulse","wiggle"],fills:["sparkle","glitch"]},intensity:"chaos",description:"Hip-hop/DnB breakbeat pattern"},waltz:{name:"Waltz",timeSignature:"3/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,.33,.67],velocities:[1,.5,.5],subdivisions:[0,.33,.67]},swing:0,humanization:.07,preferredGestures:{downbeat:["sway","float"],weak:["breathe","lean"],fills:["shimmer","glow"]},intensity:"sparse",description:"3/4 waltz time"},techno:{name:"Techno",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionLean",compositeMove:"robotPop",pattern:{emphasis:[1,.25,.5,.75,1,.25,.5,.75],velocities:[1,.6,1,.6,1,.6,1,.6],subdivisions:[0,.25,.5,.75]},swing:0,humanization:.02,preferredGestures:{downbeat:["pulse","bounce"],subdivision:["flash","glitch"],fills:["sparkle","strobe"]},intensity:"dense",description:"Driving techno four-on-the-floor"},ambient:{name:"Ambient",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[.8,0,.3,0,.5,0,.3,0],velocities:[.8,0,.3,0,.5,0,.3,0],subdivisions:[0,.5]},swing:0,humanization:.15,preferredGestures:{downbeat:["float","breathe"],offbeat:["sway","shimmer"],fills:["glow","pulse"]},intensity:"sparse",description:"Floating ambient rhythm"},funk:{name:"Funk",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"funkChicken",pattern:{emphasis:[1.2,.125,.25,0,.625,.75,0,.875],velocities:[1.2,.3,.4,0,.8,.6,0,.4],subdivisions:[0,.125,.25,.625,.75,.875]},swing:.1,humanization:.06,preferredGestures:{one:["bounce","twist"],ghost:["wiggle","pulse"],syncopation:["lean","shake"],fills:["flash","sparkle"]},intensity:"chaos",description:"Funky syncopated rhythm with THE ONE"},trap:{name:"Trap",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,0,0,.375,0,.75,.875,0],velocities:[1,0,0,.7,0,.8,.6,0],subdivisions:[0,.375,.75,.875]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","lean"],hihat:["shake","shimmer"],syncopation:["twist","flash"],fills:["sparkle","glitch"]},intensity:"moderate",description:"Trap rhythm with triplet hi-hats"}},this.transitions={instant:0,nextBar:1,nextPhrase:4,fadeIn:8},this.currentGroove=null,this.transitionMode="nextBar",this.pendingGroove=null}getTemplate(t){return this.templates[t.toLowerCase()]||this.templates.straight}getEmphasis(t,e,i){if(!t||!t.pattern)return 0;const s=t.pattern.subdivisions.findIndex(t=>Math.abs(t-i)<.01);return-1===s?0:t.pattern.emphasis[s]||0}getVelocity(t,e,i){if(!t||!t.pattern)return 1;const s=t.pattern.subdivisions.findIndex(t=>Math.abs(t-i)<.01);return-1===s?0:t.pattern.velocities[s]||0}getPreferredGesture(t,e,i,s=[]){if(!t||!t.preferredGestures)return null;let n;n=0===i?"downbeat":.5===i?"offbeat":.25===i||.75===i?"subdivision":"syncopation","Funk"===t.name&&e%4==0&&0===i&&(n="one");const r=t.preferredGestures[n]||t.preferredGestures.fills;if(!r||0===r.length)return null;if(s.length>0){const t=r.filter(t=>s.includes(t));if(t.length>0)return t[Math.floor(Math.random()*t.length)]}return r[Math.floor(Math.random()*r.length)]}humanizeTiming(t,e){if(!t||!t.humanization)return e;const i=t.humanization,s=(Math.random()-.5)*i;return Math.max(0,Math.min(1,e+s))}applySwing(t,e){return t&&t.swing&&0!==t.swing?Math.abs(e-.5)<.01?.5+.5*(t.swing-.5):Math.abs(e-.25)<.01?.25+.25*(t.swing-.5):Math.abs(e-.75)<.01?.75+.25*(t.swing-.5):e:e}setGroove(t,e=null){const i=this.getTemplate(t);return!!i&&("instant"!==(e||this.transitionMode)&&this.currentGroove?this.pendingGroove=i:(this.currentGroove=i,this.pendingGroove=null),!0)}onBeat(t){this.pendingGroove&&("nextBar"===this.transitionMode&&t%4==0||"nextPhrase"===this.transitionMode&&t%16==0)&&(this.currentGroove=this.pendingGroove,this.pendingGroove=null)}getBaseMovement(){return this.currentGroove?.baseMovement||null}getTransitionStyle(){return this.currentGroove?.transitionStyle||"transitionLean"}getCompositeMove(){return this.currentGroove?.compositeMove||null}shouldTriggerComposite(t){return!!this.currentGroove?.compositeMove&&t%("sparse"===this.currentGroove.intensity?32:16)==0}getLayeredGestures(t,e){if(!this.currentGroove)return null;const i={base:this.getBaseMovement(),accent:null,transition:null,composite:null,velocity:1};this.shouldTriggerComposite(t)&&0===e&&(i.composite=this.getCompositeMove());const s=this.getEmphasis(this.currentGroove,t,e),n=this.getVelocity(this.currentGroove,t,e);return s>.3&&n>.3&&(i.accent=this.getPreferredGesture(this.currentGroove,t,e),i.velocity=n),i.accent&&Math.random()<.3&&(i.transition=this.getTransitionStyle()),i}getGrooveNames(){return Object.keys(this.templates)}getGrooveInfo(t){const e=this.templates[t];return e?{name:e.name,timeSignature:e.timeSignature,description:e.description,intensity:e.intensity,swing:e.swing,baseMovement:e.baseMovement,compositeMove:e.compositeMove}:null}}class $f{constructor(t){this.mascot=t,this.vocalUpdateInterval=null}init(){}disconnectAudio(){return this.mascot.audioAnalyzer&&this.mascot.audioAnalyzer.stop(),this.vocalUpdateInterval&&(clearInterval(this.vocalUpdateInterval),this.vocalUpdateInterval=null),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.setVocalEnergy(0),this.mascot.shapeMorpher.setAudioDeformation(0),this.mascot.shapeMorpher.audioAnalyzer=null,this.mascot.shapeMorpher.beatGlitchIntensity=0,this.mascot.shapeMorpher.glitchPoints=[]),this.mascot.renderer&&this.mascot.renderer.ambientDanceAnimator.stopAmbientAnimation("grooveBob"),this.mascot}async connectAudio(t){if(!this.mascot.audioAnalyzer)return this.mascot;if(!this.mascot.audioAnalyzer.audioContext)try{await this.mascot.audioAnalyzer.init()}catch(t){return this.mascot}if(this.mascot.audioAnalyzer.audioContext&&"suspended"===this.mascot.audioAnalyzer.audioContext.state)try{await this.mascot.audioAnalyzer.audioContext.resume()}catch(t){}return this.mascot.audioAnalyzer.connectAudioElement(t),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.audioAnalyzer.onBeat(t=>{if(this.mascot.shapeMorpher){if(this.mascot.shapeMorpher.musicDetector){const e=performance.now();this.mascot.shapeMorpher.musicDetector.addOnset(e,t)}this.mascot.shapeMorpher.vocalEffectActive&&(this.mascot.shapeMorpher.beatGlitchIntensity=.3*t)}})),this.vocalUpdateInterval&&clearInterval(this.vocalUpdateInterval),this.mascot.renderer&&this.mascot.renderer.startGrooveBob({intensity:.5,frequency:1}),this.vocalUpdateInterval=setInterval(()=>{if(this.mascot.audioAnalyzer.isAnalyzing&&this.mascot.shapeMorpher){const t=this.mascot.audioAnalyzer.currentAmplitude||0,e=this.mascot.audioAnalyzer.getVocalInstability()||0;this.mascot.shapeMorpher.setVocalEnergy(e),this.mascot.shapeMorpher.setAudioDeformation(2*t)}},50),this.mascot.renderer&&(this.mascot.renderer.audioAnalyzer=this.mascot.audioAnalyzer),this.mascot}stopSpeaking(){if(!this.mascot.speaking)return this.mascot;const t=this.mascot.audioLevelProcessor.getCurrentLevel();return this.mascot.audioLevelProcessor.cleanup(),this.mascot.speaking=!1,this.mascot.renderer.onSpeechStop(),this.mascot.emit("speechStopped",{previousAudioLevel:t,returnToBaseTime:500}),this.mascot}setVolume(t){const e=Math.max(0,Math.min(1,t));if(this.mascot.config.masterVolume=e,this.mascot.soundSystem.isAvailable()){const t=this.mascot.stateMachine.getCurrentState().emotion;this.mascot.soundSystem.setMasterVolume(e,t)}return this.mascot.emit("volumeChanged",{volume:e}),this.mascot}destroy(){this.disconnectAudio()}}class zf{constructor(t){this.mascot=t,this.currentGesture=null,this.gestureCompatibility=null,this.rendererMethods={bounce:"startBounce",pulse:"startPulse",shake:"startShake",spin:"startSpin",nod:"startNod",tilt:"startTilt",expand:"startExpand",contract:"startContract",flash:"startFlash",drift:"startDrift",stretch:"startStretch",glow:"startGlow",sparkle:"startSparkle",shimmer:"startShimmer",wiggle:"startWiggle",groove:"startGroove",point:"startPoint",lean:"startLean",reach:"startReach",headBob:"startHeadBob",orbit:"startOrbit",flicker:"startFlicker",vibrate:"startVibrate",wave:"startWave",breathe:"startBreathe",morph:"startMorph",slowBlink:"startSlowBlink",look:"startLook",settle:"startSettle",orbital:"startOrbital",hula:"startHula",sway:"startSway",breathIn:"startBreathIn",breathOut:"startBreathOut",breathHold:"startBreathHold",breathHoldEmpty:"startBreathHoldEmpty",jump:"startJump",rain:"startRain",runningman:"startRunningMan",charleston:"startCharleston",grooveSway:"startGrooveSway",grooveBob:"startGrooveBob",grooveFlow:"startGrooveFlow",groovePulse:"startGroovePulse",grooveStep:"startGrooveStep",float:"startFloat",twist:"startTwist"}}init(){this.gestureCompatibility||Promise.resolve().then(function(){return Bf}).then(t=>{this.gestureCompatibility=t.default}).catch(t=>{})}express(t,e={}){return this.mascot.errorBoundary.wrap(()=>{if(!t)return this.mascot;const i=performance.now(),s=Array.isArray(t)||"object"==typeof t&&"chord"===t.type?"chord":t;if(this.mascot.performanceMonitor&&this.mascot.performanceMonitor.markGestureStart(s),Array.isArray(t))return this.expressChord(t,e);if("object"==typeof t&&"chord"===t.type)return this.expressChord(t.gestures,e);const n=this.rendererMethods[t];if(n&&this.mascot.renderer&&this.mascot.renderer[n]){if(this.mascot.renderer[n](e),this.mascot.config.soundEnabled&&this.mascot.soundSystem.isAvailable()&&this.mascot.soundSystem.playGestureSound(t),this.mascot.performanceMonitor){const t=performance.now();this.mascot.performanceMonitor.markGestureEnd(s),this.mascot.performanceMonitor.recordGestureTime(s,t-i)}return this.mascot}const r=le(t);if(r){if(U.registerConfig("gesture",t,r),this.mascot.currentModularGesture={type:t,config:r,startTime:performance.now(),duration:r.defaultParams?.duration||1e3,progress:0},this.mascot.config.soundEnabled&&this.mascot.soundSystem.isAvailable()&&this.mascot.soundSystem.playGestureSound(t),this.mascot.performanceMonitor){const t=performance.now();this.mascot.performanceMonitor.markGestureEnd(s),this.mascot.performanceMonitor.recordGestureTime(s,t-i)}return this.mascot}return this.mascot.throttledWarn(`Unknown gesture: ${t}`,`gesture_${t}`),this.mascot.performanceMonitor&&this.mascot.performanceMonitor.markGestureEnd(s),this.mascot},"gesture-express",this.mascot)()}expressChord(t,e={}){return this.mascot.errorBoundary.wrap(()=>{if(!t||!Array.isArray(t)||0===t.length)return this.mascot;this.gestureCompatibility||Promise.resolve().then(function(){return Bf}).then(t=>{this.gestureCompatibility=t.default}).catch(t=>{});const i=this.gestureCompatibility?this.gestureCompatibility.getCompatibleGestures(t):t;return i.forEach(t=>{const i="string"==typeof t?t:t.gestureName;this.executeGestureDirectly(i,e)}),this.gestureCompatibility?.isEnhancingCombination?.(i)&&this.mascot.renderer?.specialEffects?.addSparkle?.(),this.mascot},"gesture-chord",this.mascot)()}executeGestureDirectly(t,e={}){const i=this.rendererMethods[t];i&&this.mascot.renderer&&"function"==typeof this.mascot.renderer[i]&&this.mascot.renderer[i](e)}chain(...t){if(this.gestureCompatibility){const e=t.join(">"),i=this.gestureCompatibility.parseChain(e);this.executeChainSequence(i)}else t.length>0&&this.express(t[0]);return this.mascot}executeChainSequence(t){if(!t||0===t.length)return;let e=0;const i=()=>{if(e>=t.length)return;const s=t[e];1===s.length?this.express(s[0]):this.expressChord(s),e++,e<t.length&&setTimeout(i,800)};i()}destroy(){this.currentGesture=null,this.gestureCompatibility=null}}class qf{constructor(t){this.mascot=t,this.currentEmotion="neutral",this.emotionIntensity=1}init(){}setEmotion(t,e=null){const i={happy:"joy",curious:"surprise",frustrated:"anger",sad:"sadness"}[t]||t;let s=null,n=500;if("string"==typeof e?s=e:e&&"object"==typeof e&&(s=e.undertone||null,n=e.duration||500),this.mascot.stateMachine.setEmotion(i,s,n)){const t=F(i);if(t&&U.registerConfig("emotion",i,t),this.mascot.particleSystem){this.mascot.particleSystem.clear();const t=this.mascot.stateMachine.getCurrentEmotionalProperties();let e;if(e="neutral"===i?1:"resting"===i?4:Math.min(3,Math.floor(t.particleRate/4)),e>0){let i,s;if(this.mascot.renderer&&"function"==typeof this.mascot.renderer.getEffectiveCenter){const t=this.mascot.renderer.getEffectiveCenter();i=t.x,s=t.y}else i=this.mascot.canvasManager.width/2,s=this.mascot.canvasManager.height/2;this.mascot.particleSystem.burst(e,t.particleBehavior,i,s)}}if("classic"===this.mascot.config.renderingStyle&&this.mascot.renderer.setEmotionalState){const t=_(i);this.mascot.renderer.setEmotionalState(i,t,s)}this.mascot.emit("emotionChanged",{emotion:i,undertone:s,duration:n})}return this.currentEmotion=i,this.mascot}destroy(){this.currentEmotion="neutral"}}class jf{constructor(t){this.mascot=t,this.animationId=null,this.isRunning=!1,this.lastTime=0}init(){}start(){if(this.mascot.animationController.isAnimating())return this.mascot;if(this.mascot.animationController.start()){if(this.mascot.isRunning=!0,this.isRunning=!0,"classic"===this.mascot.config.renderingStyle&&this.mascot.particleSystem){const t=this.mascot.stateMachine.getCurrentState(),{emotion:e}=t,i=_(e);let s,n;if(this.mascot.renderer&&this.mascot.renderer.getCurrentOrbPosition){const t=this.mascot.renderer.getCurrentOrbPosition();s=t.x,n=t.y}else s=this.mascot.canvasManager.width/2,n=this.mascot.canvasManager.height/2;if(this.mascot.particleSystem.clear(),i.particleRate>0){const t=Math.min(3,Math.floor(i.particleRate/4));t>0&&this.mascot.particleSystem.burst(t,i.particleBehavior,s,n)}}this.mascot.degradationManager&&this.mascot.degradationManager.startMonitoring(),this.mascot.emit("started")}return this.mascot}stop(){return this.mascot.animationController.isAnimating()?(this.mascot.speaking&&this.mascot.audioHandler.stopSpeaking(),this.mascot.animationController.stop()&&(this.mascot.isRunning=!1,this.isRunning=!1,this.mascot.degradationManager&&this.mascot.degradationManager.stopMonitoring(),this.mascot.emit("stopped")),this.mascot):this.mascot}update(t){if(this.mascot.speaking&&this.mascot.audioLevelProcessor.isProcessingActive()&&this.mascot.audioLevelProcessor.updateAudioLevel(t),"classic"===this.mascot.config.renderingStyle){if(this.mascot.gazeTracker&&(this.mascot.gazeTracker.update(t),"suspicion"===this.mascot.stateMachine.getCurrentState().emotion)){const{mousePos:t}=this.mascot.gazeTracker,e=this.mascot.canvas.width/2,i=this.mascot.canvas.height/2,s=Math.sqrt(Math.pow(t.x-e,2)+Math.pow(t.y-i,2)),n=F("suspicion");if(n&&n.visual){const t=Math.min(e,i),r=Math.max(0,Math.min(1,1-s/t));n.visual.threatLevel=r}}if(this.mascot.idleBehavior&&this.mascot.idleBehavior.update(t),this.mascot.gazeTracker&&this.mascot.idleBehavior){const t=this.mascot.gazeTracker.getGazeOffset(),e=this.mascot.idleBehavior.getSwayOffset(),i=this.mascot.gazeTracker.getState(),s={offset:{x:t.x+e.x,y:t.y+e.y},proximity:i.proximity,isFocused:i.isFocused};this.mascot.renderer.setGazeData&&this.mascot.renderer.setGazeData(s)}}if(this.mascot.pluginSystem){const e=this.mascot.stateMachine.getCurrentState();this.mascot.pluginSystem.update(t,e)}}destroy(){this.stop()}}class Lf{constructor(t,e={}){this.mascot=t,this.config=this.validateConfig(e)}validateConfig(t){return{canvasId:t.canvasId||"emotive-canvas",startingEmotion:t.startingEmotion||"neutral",emotionalResponsiveness:t.emotionalResponsiveness??.5,particleIntensity:t.particleIntensity??1,glowIntensity:t.glowIntensity??1,audioEnabled:t.audioEnabled??!1,showFPS:t.showFPS??!1,debugMode:t.debugMode??!1,renderMode:t.renderMode||"default",maxParticles:t.maxParticles||100,...t}}getConfig(){return{...this.config}}updateConfig(t){return this.config={...this.config,...t},this.config}}const Nf={listening:{name:"listening",category:"conversational",emotion:"curiosity",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:400,description:"User is speaking, AI is listening attentively"},thinking:{name:"thinking",category:"conversational",emotion:"focused",gesture:"breathe",delay:100,baseIntensity:.7,emotionDuration:500,description:"AI is processing and thinking"},acknowledging:{name:"acknowledging",category:"conversational",emotion:"calm",gesture:"nod",delay:150,baseIntensity:.7,emotionDuration:400,description:"AI acknowledges understanding"},guiding:{name:"guiding",category:"conversational",emotion:"calm",gesture:"point",delay:200,baseIntensity:.7,emotionDuration:500,description:"AI provides guidance or instructions"},empathizing:{name:"empathizing",category:"conversational",emotion:"empathy",baseIntensity:.8,emotionDuration:600,description:"AI shows empathy and understanding",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.8},{at:200,action:"gesture",value:"shake"},{at:700,action:"gesture",value:"nod"}]},celebrating:{name:"celebrating",category:"conversational",emotion:"joy",baseIntensity:.9,emotionDuration:500,description:"AI celebrates success with user",sequence:[{at:0,action:"emotion",value:"joy",intensity:.9},{at:200,action:"gesture",value:"bounce"},{at:800,action:"emotion",value:"triumph",intensity:1},{at:900,action:"gesture",value:"glow"}]},celebrating_epic:{name:"celebrating_epic",category:"conversational",emotion:"triumph",baseIntensity:1,emotionDuration:500,description:"Epic celebration with visual transformation",sequence:[{at:0,action:"emotion",value:"joy",intensity:.9},{at:200,action:"gesture",value:"bounce"},{at:700,action:"emotion",value:"triumph",intensity:1},{at:800,action:"gesture",value:"glow"},{at:1e3,action:"morph",value:"sun"},{at:1e3,action:"chain",value:"radiance"}]},reassuring:{name:"reassuring",category:"conversational",emotion:"calm",baseIntensity:.8,emotionDuration:600,description:"AI provides reassurance and comfort",sequence:[{at:0,action:"emotion",value:"calm",intensity:.8},{at:200,action:"gesture",value:"breathe"},{at:800,action:"gesture",value:"wave"}]},offering_help:{name:"offering_help",category:"conversational",emotion:"empathy",baseIntensity:.8,emotionDuration:500,description:"AI offers assistance",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.8},{at:200,action:"gesture",value:"nod"},{at:600,action:"gesture",value:"point"}]},offering_urgent_help:{name:"offering_urgent_help",category:"conversational",emotion:"empathy",baseIntensity:1,emotionDuration:400,description:"AI urgently offers help for frustrated user",sequence:[{at:0,action:"emotion",value:"empathy",intensity:1},{at:150,action:"gesture",value:"shake"},{at:400,action:"gesture",value:"nod"},{at:700,action:"gesture",value:"point"}]},apologizing:{name:"apologizing",category:"conversational",emotion:"empathy",baseIntensity:.85,emotionDuration:600,description:"AI apologizes for mistake or error",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.85},{at:200,action:"gesture",value:"shake"},{at:600,action:"gesture",value:"breathe"}]},encouraging:{name:"encouraging",category:"conversational",emotion:"joy",gesture:"nod",delay:200,baseIntensity:.75,emotionDuration:500,description:"AI encourages user to continue"},greeting:{name:"greeting",category:"conversational",emotion:"joy",gesture:"wave",delay:200,baseIntensity:.7,emotionDuration:500,description:"AI greets user warmly"},responding_positive:{name:"responding_positive",category:"conversational",emotion:"joy",gesture:"bounce",delay:150,baseIntensity:.75,emotionDuration:500,description:"AI responds with positive sentiment"},responding_neutral:{name:"responding_neutral",category:"conversational",emotion:"calm",gesture:"drift",delay:150,baseIntensity:.6,emotionDuration:500,description:"AI responds with neutral sentiment"},responding_negative:{name:"responding_negative",category:"conversational",emotion:"empathy",gesture:"shake",delay:150,baseIntensity:.8,emotionDuration:600,description:"AI responds to negative situation"},success_minor:{name:"success_minor",category:"feedback",emotion:"joy",gesture:"bounce",delay:150,baseIntensity:.7,emotionDuration:500,description:"Small success (item scanned, form field validated)"},success_moderate:{name:"success_moderate",category:"feedback",emotion:"joy",baseIntensity:.8,emotionDuration:500,description:"Moderate success (section completed, task done)",sequence:[{at:0,action:"emotion",value:"joy",intensity:.8},{at:200,action:"gesture",value:"bounce"},{at:600,action:"gesture",value:"wiggle"}]},success_major:{name:"success_major",category:"feedback",emotion:"triumph",baseIntensity:.9,emotionDuration:500,description:"Major success (milestone reached, goal achieved)",sequence:[{at:0,action:"emotion",value:"joy",intensity:.85},{at:150,action:"gesture",value:"bounce"},{at:500,action:"emotion",value:"triumph",intensity:.9},{at:600,action:"gesture",value:"glow"}]},success_epic:{name:"success_epic",category:"feedback",emotion:"triumph",baseIntensity:1,emotionDuration:500,description:"Epic success with visual transformation",sequence:[{at:0,action:"emotion",value:"triumph",intensity:1},{at:200,action:"gesture",value:"glow"},{at:700,action:"morph",value:"sun"},{at:700,action:"chain",value:"radiance"}]},error_minor:{name:"error_minor",category:"feedback",emotion:"concern",gesture:"shake",delay:150,baseIntensity:.6,emotionDuration:500,description:"Minor error, easily recoverable"},error_moderate:{name:"error_moderate",category:"feedback",emotion:"empathy",baseIntensity:.75,emotionDuration:600,description:"Moderate error, needs user action",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.75},{at:200,action:"gesture",value:"shake"},{at:600,action:"gesture",value:"nod"}]},error_major:{name:"error_major",category:"feedback",emotion:"empathy",baseIntensity:.9,emotionDuration:600,description:"Major error, needs help",sequence:[{at:0,action:"emotion",value:"empathy",intensity:.9},{at:150,action:"gesture",value:"shake"},{at:500,action:"gesture",value:"nod"},{at:800,action:"gesture",value:"point"}]},error_critical:{name:"error_critical",category:"feedback",emotion:"empathy",baseIntensity:1,emotionDuration:500,description:"Critical error, urgent attention needed",sequence:[{at:0,action:"emotion",value:"empathy",intensity:1},{at:100,action:"gesture",value:"shake"},{at:400,action:"gesture",value:"point"}]},warning:{name:"warning",category:"feedback",emotion:"concern",gesture:"pulse",delay:150,baseIntensity:.7,emotionDuration:500,description:"Warning, needs attention"},info:{name:"info",category:"feedback",emotion:"neutral",gesture:"drift",delay:100,baseIntensity:.5,emotionDuration:400,description:"Informational, passive notification"},progress_start:{name:"progress_start",category:"feedback",emotion:"anticipation",gesture:"pulse",delay:100,baseIntensity:.6,emotionDuration:500,description:"Starting a process"},progress_ongoing:{name:"progress_ongoing",category:"feedback",emotion:"focused",gesture:"breathe",delay:0,baseIntensity:.7,emotionDuration:600,description:"Process ongoing, working"},progress_complete:{name:"progress_complete",category:"feedback",emotion:"satisfaction",gesture:"glow",delay:200,baseIntensity:.8,emotionDuration:500,description:"Process completed successfully"},idle:{name:"idle",category:"state",emotion:"neutral",gesture:"drift",delay:0,baseIntensity:.5,emotionDuration:600,description:"System idle, waiting for user"},ready:{name:"ready",category:"state",emotion:"neutral",gesture:"wave",delay:200,baseIntensity:.6,emotionDuration:500,description:"System ready for interaction"},waiting:{name:"waiting",category:"state",emotion:"anticipation",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:600,description:"System waiting for process to complete",loop:!0,loopInterval:1500},processing:{name:"processing",category:"state",emotion:"focused",gesture:"breathe",delay:0,baseIntensity:.7,emotionDuration:600,description:"System actively processing",loop:!0,loopInterval:1200},scanning:{name:"scanning",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.75,emotionDuration:500,description:"Scanning or searching",loop:!0,loopInterval:1e3},analyzing:{name:"analyzing",category:"state",emotion:"curiosity",gesture:"drift",delay:0,baseIntensity:.7,emotionDuration:600,description:"Analyzing data or input",loop:!0,loopInterval:1400},completing:{name:"completing",category:"state",emotion:"anticipation",gesture:"pulse",delay:100,baseIntensity:.8,emotionDuration:500,description:"Final step, about to complete"},completed:{name:"completed",category:"state",emotion:"satisfaction",gesture:"glow",delay:200,baseIntensity:.85,emotionDuration:500,description:"Process completed successfully"},reviewing:{name:"reviewing",category:"state",emotion:"satisfaction",gesture:"drift",delay:0,baseIntensity:.65,emotionDuration:600,description:"Reviewing information or results"},monitoring:{name:"monitoring",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.6,emotionDuration:700,description:"Actively monitoring for changes",loop:!0,loopInterval:2e3},paused:{name:"paused",category:"state",emotion:"neutral",gesture:"breathe",delay:200,baseIntensity:.5,emotionDuration:600,description:"System paused, can resume"},loading:{name:"loading",category:"state",emotion:"anticipation",gesture:"pulse",delay:0,baseIntensity:.65,emotionDuration:500,description:"Loading data or content",loop:!0,loopInterval:1100},connecting:{name:"connecting",category:"state",emotion:"anticipation",gesture:"drift",delay:0,baseIntensity:.6,emotionDuration:600,description:"Establishing connection",loop:!0,loopInterval:1300},active:{name:"active",category:"state",emotion:"focused",gesture:"pulse",delay:0,baseIntensity:.75,emotionDuration:500,description:"System actively engaged"}};class Gf{constructor(t={}){this.performances=new Map,this.contextManager=null,this.sequenceExecutor=null,this.eventManager=t.eventManager||null,this.defaultIntensity=t.defaultIntensity||.7,this.enableContextAdjustment=!1!==t.enableContextAdjustment,this.enableAnalytics=t.enableAnalytics||!1,this.performanceHistory=[],this.maxHistorySize=t.maxHistorySize||100,this.loadBuiltInPerformances()}loadBuiltInPerformances(){Object.entries(Nf).forEach(([t,e])=>{this.definePerformance(t,e)})}definePerformance(t,e){this.performances.set(t,{...e,name:t}),this.eventManager&&this.eventManager.emit("performanceDefined",{name:t,definition:e})}getPerformance(t){return this.performances.get(t)||null}hasPerformance(t){return this.performances.has(t)}async perform(t,e={}){const i=this.getPerformance(t);if(!i)return;const s=this.calculateIntensity(i,e),n={performance:i,semanticAction:t,intensity:s,options:e,timestamp:Date.now()};this.enableAnalytics&&this.recordPerformance(n),this.eventManager&&this.eventManager.emit("performanceStart",n);try{this.sequenceExecutor&&i.sequence?await this.sequenceExecutor.execute(i.sequence,{intensity:s,...e}):await this.executeSimplePerformance(i,s,e),this.eventManager&&this.eventManager.emit("performanceComplete",n)}catch(t){this.eventManager&&this.eventManager.emit("performanceError",{...n,error:t})}}async executeSimplePerformance(t,e,i){const{emotion:s,gesture:n,delay:r=0}=t,o=i.mascot||this.mascot;if(o){if(s&&"function"==typeof o.setEmotion){const e=void 0!==i.emotionDuration?i.emotionDuration:t.emotionDuration||500;o.setEmotion(s,e)}n&&"function"==typeof o.express&&(r>0&&await new Promise(t=>setTimeout(t,r)),o.express(n))}}calculateIntensity(t,e){if(void 0!==e.intensity)return Math.max(0,Math.min(1,e.intensity));let i=t.baseIntensity||this.defaultIntensity;if(this.enableContextAdjustment&&e.context){const{context:t}=e;void 0!==t.frustration&&(i+=t.frustration/100*.3),"high"===t.urgency?i+=.2:"medium"===t.urgency&&(i+=.1),"epic"===t.magnitude?i=1:"major"===t.magnitude&&(i=Math.max(i,.9))}return Math.max(0,Math.min(1,i))}recordPerformance(t){this.performanceHistory.push({action:t.semanticAction,intensity:t.intensity,context:t.options.context||{},timestamp:t.timestamp}),this.performanceHistory.length>this.maxHistorySize&&this.performanceHistory.shift()}getAnalytics(){if(!this.enableAnalytics)return{enabled:!1};const t=this.performanceHistory.length,e={},i={};return this.performanceHistory.forEach(t=>{e[t.action]||(e[t.action]=0,i[t.action]=[]),e[t.action]++,i[t.action].push(t.intensity)}),Object.keys(i).forEach(t=>{const e=i[t];i[t]=e.reduce((t,e)=>t+e,0)/e.length}),{enabled:!0,total:t,byAction:e,avgIntensity:i,history:this.performanceHistory.slice(-20)}}clearAnalytics(){this.performanceHistory=[]}setMascot(t){this.mascot=t}setContextManager(t){this.contextManager=t}setSequenceExecutor(t){this.sequenceExecutor=t}listPerformances(){return Array.from(this.performances.keys())}getPerformanceMetadata(t){const e=this.getPerformance(t);return e?{name:e.name,category:e.category||"custom",emotion:e.emotion,gesture:e.gesture,hasSequence:!!e.sequence,baseIntensity:e.baseIntensity||this.defaultIntensity,description:e.description||""}:null}}class Uf{constructor(t={}){this.context={frustration:0,urgency:"medium",magnitude:"moderate",customValues:{}},this.enableHistory=!1!==t.enableHistory,this.historyLimit=t.historyLimit||50,this.history=[],this.enableDecay=!1!==t.enableDecay,this.frustrationDecayRate=t.frustrationDecayRate||5,this.decayInterval=t.decayInterval||1e4,this.decayTimer=null,this.enableDecay&&this.startDecayTimer()}update(t={}){const e={...this.context};void 0!==t.frustration&&(this.context.frustration=Math.max(0,Math.min(100,t.frustration))),void 0!==t.urgency&&["low","medium","high"].includes(t.urgency)&&(this.context.urgency=t.urgency),void 0!==t.magnitude&&["small","moderate","major","epic"].includes(t.magnitude)&&(this.context.magnitude=t.magnitude),void 0!==t.custom&&(this.context.customValues={...this.context.customValues,...t.custom}),this.enableHistory&&this.addToHistory(e,this.context,t),this.enableDecay&&this.restartDecayTimer()}incrementFrustration(t=10){this.update({frustration:this.context.frustration+t})}decrementFrustration(t=10){this.update({frustration:this.context.frustration-t})}resetFrustration(){this.update({frustration:0})}setUrgency(t){this.update({urgency:t})}setMagnitude(t){this.update({magnitude:t})}setCustom(t,e){this.update({custom:{[t]:e}})}getContext(){return{...this.context}}get(t){return t in this.context?this.context[t]:this.context.customValues[t]}calculateIntensity(t=.5,e={}){let i=t;return!1!==e.useFrustration&&(i+=this.context.frustration/100*.3),!1!==e.useUrgency&&(i+={low:-.1,medium:0,high:.2}[this.context.urgency]||0),!1!==e.useMagnitude&&(i+={small:-.1,moderate:0,major:.15,epic:.3}[this.context.magnitude]||0),void 0!==e.intensityMultiplier&&(i*=e.intensityMultiplier),Math.max(0,Math.min(1,i))}addToHistory(t,e,i){const s={timestamp:Date.now(),previous:t,current:{...e},updates:i,delta:{frustration:e.frustration-t.frustration,urgency:e.urgency!==t.urgency?e.urgency:null,magnitude:e.magnitude!==t.magnitude?e.magnitude:null}};this.history.push(s),this.history.length>this.historyLimit&&this.history.shift()}getHistory(t){return t?this.history.slice(-t):[...this.history]}clearHistory(){this.history=[]}startDecayTimer(){this.decayTimer=setInterval(()=>{if(this.context.frustration>0){const t=Math.max(0,this.context.frustration-this.frustrationDecayRate);this.update({frustration:t})}},this.decayInterval)}restartDecayTimer(){this.decayTimer&&(clearInterval(this.decayTimer),this.startDecayTimer())}stopDecay(){this.decayTimer&&(clearInterval(this.decayTimer),this.decayTimer=null)}reset(){this.context={frustration:0,urgency:"medium",magnitude:"moderate",customValues:{}},this.enableHistory&&this.addToHistory({},this.context,{action:"reset"})}getAnalytics(){if(!this.enableHistory||0===this.history.length)return null;const t=this.history.map(t=>t.current.frustration),e=t.reduce((t,e)=>t+e,0)/t.length,i=Math.max(...t),s=Math.min(...t),n=this.history.reduce((t,e)=>(t[e.current.urgency]=(t[e.current.urgency]||0)+1,t),{}),r=this.history.reduce((t,e)=>(t[e.current.magnitude]=(t[e.current.magnitude]||0)+1,t),{});return{current:{...this.context},frustration:{current:this.context.frustration,average:e,max:i,min:s},urgency:{current:this.context.urgency,distribution:n},magnitude:{current:this.context.magnitude,distribution:r},historyLength:this.history.length,firstUpdate:this.history[0]?.timestamp,lastUpdate:this.history[this.history.length-1]?.timestamp}}destroy(){this.stopDecay(),this.history=[],this.context=null}}class Wf{constructor(t={}){this.mascot=t.mascot||null,this.eventManager=t.eventManager||null,this.activeSequences=new Map,this.nextSequenceId=1,this.defaultDelay=t.defaultDelay||0,this.allowConcurrent=!1!==t.allowConcurrent}async execute(t,e={}){if(!Array.isArray(t)||0===t.length)return;const i=e.mascot||this.mascot;if(!i)return;!this.allowConcurrent&&this.activeSequences.size>0&&this.cancelAll();const s=this.nextSequenceId++,n=[...t].sort((t,e)=>t.at-e.at),r={cancelled:!1};this.activeSequences.set(s,r);try{this.eventManager&&this.eventManager.emit("sequenceStart",{sequenceId:s,steps:n,timestamp:Date.now()}),await this.executeSteps(n,i,r,e),this.eventManager&&this.eventManager.emit("sequenceComplete",{sequenceId:s,timestamp:Date.now()})}catch(t){this.eventManager&&this.eventManager.emit("sequenceError",{sequenceId:s,error:t,timestamp:Date.now()})}finally{this.activeSequences.delete(s)}}async executeSteps(t,e,i,s){let n=0;for(const r of t){if(i.cancelled)break;const t=r.at-n;if(t>0&&await this.sleep(t,i),i.cancelled)break;await this.executeStep(r,e,s),n=r.at}}executeStep(t,e,i){const{action:s,value:n,intensity:r,options:o}=t;try{switch(s){case"emotion":if("function"==typeof e.setEmotion){const t=void 0!==r?r:i.intensity,s=o?.duration||i.emotionDuration||500;e.setEmotion(n,void 0!==t?t:s)}break;case"gesture":"function"==typeof e.express&&e.express(n,o);break;case"morph":"function"==typeof e.morphTo&&e.morphTo(n,o);break;case"chain":"function"==typeof e.chain&&e.chain(n,o);break;case"sound":"function"==typeof e.playSound&&e.playSound(n,o)}this.eventManager&&this.eventManager.emit("stepExecuted",{action:s,value:n,timestamp:Date.now()})}catch(t){}}sleep(t,e){return new Promise(i=>{const s=setTimeout(()=>{i()},t);if(e){const n=setInterval(()=>{e.cancelled&&(clearTimeout(s),clearInterval(n),i())},50);setTimeout(()=>{clearInterval(n)},t)}})}cancel(t){const e=this.activeSequences.get(t);e&&(e.cancelled=!0,this.activeSequences.delete(t),this.eventManager&&this.eventManager.emit("sequenceCancelled",{sequenceId:t,timestamp:Date.now()}))}cancelAll(){this.activeSequences.forEach((t,e)=>{t.cancelled=!0,this.eventManager&&this.eventManager.emit("sequenceCancelled",{sequenceId:e,timestamp:Date.now()})}),this.activeSequences.clear()}getActiveCount(){return this.activeSequences.size}isActive(){return this.activeSequences.size>0}setMascot(t){this.mascot=t}}class Hf{constructor(t,e={}){this.mascot=t,this.userConfig=e}initialize(){const t=this.initializeConfiguration();return this.initializeCanvas(t),this.initializeCoreSystems(t),this.initializeAudioSystems(t),this.initializeInteractionSystems(t),this.initializeOptimizationSystems(t),this.initializeAnimationController(t),this.initializePerformanceSystems(t),this.initializeModularHandlers(t),this.finalizeInitialization(t),t}initializeConfiguration(){const t=bf.browserOptimizations.getOptimizations(),e={canvasId:"emotive-mascot",targetFPS:60,enableAudio:bf.featureDetection.features.webAudio,soundEnabled:!1,masterVolume:.5,maxParticles:t.particleLimit,defaultEmotion:"neutral",enableAutoOptimization:!0,enableGracefulDegradation:!0,renderingStyle:"classic",enableGazeTracking:!0,enableIdleBehaviors:!0,renderSize:null,offsetX:0,offsetY:0,offsetZ:0,classicConfig:{coreColor:"#FFFFFF",coreSizeDivisor:12,glowMultiplier:2.5,defaultGlowColor:"#14B8A6"},topOffset:0,sentry:{enabled:!1,dsn:null,environment:"production",tracesSampleRate:.1},...this.userConfig};return e.sentry&&e.sentry.enabled&&(function(t={}){const{dsn:e=null,environment:i="production",tracesSampleRate:s=.1,enabled:n=!0}=t;n&&e&&function(t={}){const e=!t.skipBrowserExtensionCheck&&!!function(){if(void 0===Da.window)return!1;const t=Da;if(t.nw)return!1;const e=t.chrome||t.browser;if(!e?.runtime?.id)return!1;const i=Ps();return!(Da===Da.top&&["chrome-extension","moz-extension","ms-browser-extension","safari-web-extension"].some(t=>i.startsWith(`${t}://`)))}()&&(Uc&&Hi(()=>{}),!0),i={...t,enabled:!e&&t.enabled,stackParser:(s=t.stackParser||Nc,Array.isArray(s)?ts(...s):s),integrations:xo({integrations:t.integrations,defaultIntegrations:null==t.defaultIntegrations?[la(),ha(),Vc(),Wc(),Kc(),tu(),wa(),{name:"HttpContext",preprocessEvent(t){if(!Da.navigator&&!Da.location&&!Da.document)return;const e=ja(),i={...e.headers,...t.request?.headers};t.request={...e,...t.request,headers:i}}},{name:"BrowserSession",setupOnce(){void 0!==Da.document?(vo({ignoreDuration:!0}),So(),bc(({from:t,to:e})=>{void 0!==t&&t!==e&&(vo({ignoreDuration:!0}),So())})):Uc&&Ji.warn("Using the `browserSessionIntegration` in non-browser environments is not supported.")}}]:t.defaultIntegrations}),transport:t.transport||Oc};var s;!function(t,e){!0===e.debug&&(zi?Ji.enable():Hi(()=>{})),vn().update(e.initialScope);const i=new t(e);(function(t){vn().setClient(t)})(i),i.init()}(Ka,i)}({dsn:e,environment:i,tracesSampleRate:s,release:`emotive-engine@${process.env.npm_package_version||"2.5.0"}`,integrations:[Wp(),Pp({sessionSampleRate:.1,errorSampleRate:1})],beforeSend(t,e){const i=e.originalException;return i&&i.message&&i.message.includes("canvas")?null:t},beforeBreadcrumb:t=>"console"===t.category?null:t})}(e.sentry),function(t,e="info",i={}){ra({message:t,category:e,data:i,level:"info"})}("EmotiveMascot initialized","lifecycle",{emotion:e.defaultEmotion,renderingStyle:e.renderingStyle})),this.mascot.config=e,e}initializeCanvas(t){if(this.mascot.canvas="string"==typeof t.canvasId?document.getElementById(t.canvasId):t.canvasId,!this.mascot.canvas)throw new Error(`Canvas with ID '${t.canvasId}' not found`);this.mascot.canvasManager=new e(this.mascot.canvas),this.mascot.positionController=new $i({offsetX:t.offsetX,offsetY:t.offsetY,offsetZ:t.offsetZ,onUpdate:t=>{this.mascot.renderer&&this.mascot.renderer.updateEffectiveCenter(t)}}),t.renderSize&&t.renderSize.width&&t.renderSize.height&&this.mascot.canvasManager.setRenderSize(t.renderSize.width,t.renderSize.height),this.mascot.contextRecovery=new ff(this.mascot.canvas),this.mascot.contextRecovery.onRecovery(t=>{this.mascot.renderer&&this.mascot.renderer.handleContextRecovery(t)}),bf.browserOptimizations.applyCanvasOptimizations(this.mascot.canvas,this.mascot.canvasManager.getContext())}initializeCoreSystems(t){this.mascot.stateMachine=new N(this.mascot.errorBoundary),this.mascot.particleSystem=new Se(t.maxParticles,this.mascot.errorBoundary),this.mascot.particleSystem.canvasWidth=this.mascot.canvasManager.width,this.mascot.particleSystem.canvasHeight=this.mascot.canvasManager.height,this.mascot.renderer=new wi(this.mascot.canvasManager,{...t.classicConfig,topOffset:t.topOffset||0,positionController:this.mascot.positionController}),this.mascot.renderer.stateMachine=this.mascot.stateMachine,this.mascot.stateMachine.renderer=this.mascot.renderer}initializeAudioSystems(t){this.mascot.shapeMorpher=new _f,this.mascot.audioAnalyzer=new Rf,this.mascot.grooveTemplates=new Df,this.mascot.shapeMorpher.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.renderer.shapeMorpher=this.mascot.shapeMorpher,this.mascot.renderer.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.gestureController=new zf(this.mascot),this.mascot.gestureController.gestureCompatibility=Of,this.mascot.gestureController.init(),this.mascot.soundSystem=new Zp,this.mascot.audioLevelProcessor=new sf({spikeThreshold:t.spikeThreshold||1.5,minimumSpikeLevel:t.minimumSpikeLevel||.1,spikeMinInterval:t.spikeMinInterval||1e3})}initializeInteractionSystems(t){t.enableGazeTracking&&(this.mascot.gazeTracker=new Mi(this.mascot.canvas,{smoothing:.1,maxOffset:.15,enabled:!0}),this.mascot.gazeTracker.setInteractionCallback(()=>{this.mascot.sleeping?this.mascot.wake():this.mascot.idleBehavior&&this.mascot.idleBehavior.resetIdleTimer()})),t.enableIdleBehaviors&&(this.mascot.idleBehavior=new Si({enabled:!0,sleepTimeout:1/0}),this.mascot.idleBehavior.setCallback("onBlink",t=>{this.mascot.renderer&&this.mascot.renderer.state&&(this.mascot.renderer.state.blinking="start"===t.phase)}),this.mascot.idleBehavior.setCallback("onSleep",()=>{this.mascot.renderer&&this.mascot.renderer.enterSleepMode&&this.mascot.renderer.enterSleepMode()}),this.mascot.idleBehavior.setCallback("onWake",()=>{this.mascot.renderer&&this.mascot.renderer.wakeUp&&this.mascot.renderer.wakeUp()}))}initializeOptimizationSystems(t){this.mascot.degradationManager=null,this.mascot.accessibilityManager=new of({enableReducedMotion:!1!==t.enableReducedMotion,enableHighContrast:!1!==t.enableHighContrast,enableScreenReaderSupport:!1!==t.enableScreenReaderSupport,enableKeyboardNavigation:!1!==t.enableKeyboardNavigation,colorBlindMode:t.colorBlindMode||"none"}),this.mascot.mobileOptimization=new af({enableTouchOptimization:!1!==t.enableTouchOptimization,enableViewportHandling:!1!==t.enableViewportHandling,enableBatteryOptimization:!1!==t.enableBatteryOptimization}),this.mascot.mobileOptimization.setCanvas(this.mascot.canvas),this.mascot.pluginSystem=new hf({mascot:this.mascot,enablePlugins:!1!==t.enablePlugins,validatePlugins:!1!==t.validatePlugins,sandboxPlugins:!1!==t.sandboxPlugins})}initializeAnimationController(t){try{this.mascot.animationController=new ef(this.mascot.errorBoundary,{targetFPS:t.targetFPS})}catch(e){this.mascot.animationController=this.createFallbackAnimationController(t.targetFPS)}this.mascot.animationController.setSubsystems({stateMachine:this.mascot.stateMachine,particleSystem:this.mascot.particleSystem,renderer:this.mascot.renderer,soundSystem:this.mascot.soundSystem,canvasManager:this.mascot.canvasManager}),this.mascot.animationController.setEventCallback((t,e)=>{this.mascot.emit(t,e)}),this.mascot.animationController.setParentMascot(this.mascot),this.mascot.isRunning=!1}createFallbackAnimationController(t){return{isAnimating:()=>this.mascot.isRunning,start:()=>(this.mascot.isRunning=!0,!0),stop:()=>(this.mascot.isRunning=!1,!0),setTargetFPS:()=>{},targetFPS:t,getPerformanceMetrics:()=>({fps:0,isRunning:this.mascot.isRunning,performanceDegradation:!1,deltaTime:16,frameCount:0,targetFPS:t}),setSubsystems:()=>{},setEventCallback:()=>{},setParentMascot:()=>{},destroy:()=>{},deltaTime:16}}initializePerformanceSystems(t){this.mascot.contextManager=new Uf({enableHistory:!1!==t.enablePerformanceHistory,enableDecay:!1!==t.enableFrustrationDecay,historyLimit:t.performanceHistoryLimit||50,frustrationDecayRate:t.frustrationDecayRate||5,decayInterval:t.frustrationDecayInterval||1e4}),this.mascot.sequenceExecutor=new Wf({mascot:this.mascot,eventManager:this.mascot.eventManager,allowConcurrent:!1!==t.allowConcurrentPerformances}),this.mascot.performanceSystem=new Gf({mascot:this.mascot,contextManager:this.mascot.contextManager,sequenceExecutor:this.mascot.sequenceExecutor,eventManager:this.mascot.eventManager,enableAnalytics:!1!==t.enablePerformanceAnalytics})}initializeModularHandlers(t){this.mascot.audioHandler=new $f(this.mascot),this.mascot.stateCoordinator=new qf(this.mascot),this.mascot.visualizationRunner=new jf(this.mascot),this.mascot.configurationManager=new Lf(this.mascot,t),this.mascot.audioHandler.init(),this.mascot.stateCoordinator.init(),this.mascot.visualizationRunner.init()}finalizeInitialization(t){t.enableAudio&&this.mascot.soundSystem.initialize().then(e=>{e&&this.mascot.soundSystem.setMasterVolume(t.masterVolume)}),this.mascot.speaking=!1,this.mascot.recording=!1,this.mascot.sleeping=!1,this.mascot.warningTimestamps={},this.mascot.rhythmEnabled=!1,this.mascot.warningThrottle=5e3,U.initialize(),this.mascot.rhythmIntegration=U,this.mascot.tts={available:"undefined"!=typeof window&&"speechSynthesis"in window,speaking:!1,currentUtterance:null},this.mascot.debugMode=t.enableDebug||!1,this.mascot.debugMode&&(wf.log("INFO","Debug mode enabled for EmotiveMascot",{config:t,runtimeCapabilities:Mf.generateReport()}),wf.startProfile("mascot-initialization",{canvasId:t.canvasId,maxParticles:t.maxParticles})),this.mascot.setupAudioLevelProcessorCallbacks(),this.mascot.stateMachine.setEmotion(t.defaultEmotion),this.mascot.canvasManager.onResize((t,e,i)=>{this.mascot.handleResize(t,e,i)}),this.mascot.debugMode&&(wf.endProfile("mascot-initialization"),wf.takeMemorySnapshot("post-initialization"))}}class Vf{constructor(t,e={}){if(!t)throw new Error("LLMResponseHandler requires a mascot instance");this.mascot=t,this.config={autoMorphShapes:!0,morphDuration:1e3,autoExpressGestures:!0,gestureTiming:300,gestureIntensity:.7,useFallbackGestures:!0,useSemanticPerformances:!0,enableContextTracking:!0,emotionToShapeMap:{},actionToGestureMap:{},...e},this.schema={message:"string",emotion:["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity"],sentiment:["positive","neutral","negative"],action:["none","offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond"],frustrationLevel:"number",shape:["circle","heart","star","sun","moon","eclipse","solar","lunar","square","triangle","suspicion"],gesture:["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","jump","orbital","hula","scan","twist","burst","directional","settle","fade","hold","breathe","peek","sparkle","shimmer","wiggle","groove","point","lean","reach","headBob","rain","twitch","sway","float","jitter","orbit"]},this.defaultShapeMap={joy:"star",love:"heart",empathy:"heart",excitement:"sun",calm:"moon",concern:"circle",triumph:"star",curiosity:"circle",neutral:"circle"},this.defaultGestureMap={offer_help:"reach",celebrate:"sparkle",guide:"point",reassure:"nod",greet:"wave",confirm:"nod",deny:"shake",emphasize:"pulse",question:"tilt",think:"orbit",listen:"settle",respond:"bounce"},this.semanticActionMap={offer_help:"offering_help",celebrate:"celebrating",guide:"guiding",reassure:"reassuring",greet:"greeting",confirm:"confirming",deny:"denying",emphasize:"emphasizing",question:"questioning",think:"thinking",listen:"listening",respond:"responding"}}async handle(t,e={}){try{e.skipValidation||this.validateResponse(t);const{emotion:i="neutral",sentiment:s="neutral",action:n="none",shape:r,gesture:o,frustrationLevel:a=0}=t,h=void 0!==e.intensity?e.intensity:this.calculateIntensity(a,s);if(this.config.enableContextTracking&&this.mascot.updateContext&&this.mascot.updateContext({frustration:a,sentiment:s}),this.config.useSemanticPerformances&&this.mascot.perform&&this.semanticActionMap[n]){const t=this.semanticActionMap[n];try{return await this.mascot.perform(t,{context:{frustration:a,sentiment:s,urgency:a>60?"high":a>30?"medium":"low"},intensity:h}),r&&this.config.autoMorphShapes&&await this.morphToShape(r),this.mascot}catch{}}return await this.choreographResponse(i,n,r,o,h),this.mascot}catch(t){return this.mascot}}async choreographResponse(t,e,i,s,n){if(this.mascot.setEmotion(t,n),this.config.autoMorphShapes){const s=i||this.getShapeForEmotion(t,e);s&&await this.morphToShape(s)}if(this.config.autoExpressGestures){const t=s||this.getGestureForAction(e);t&&(await this.delay(this.config.gestureTiming),this.mascot.express(t,{intensity:this.config.gestureIntensity}))}}calculateIntensity(t,e){let i=.5;return i+=t/100*.3,"positive"===e?i+=.2:"negative"===e&&(i+=.3),Math.max(.3,Math.min(1,i))}getShapeForEmotion(t,e){return this.config.emotionToShapeMap[t]?this.config.emotionToShapeMap[t]:"celebrate"===e?"star":"greet"===e?"sun":this.defaultShapeMap[t]||null}getGestureForAction(t){return this.config.useFallbackGestures?this.config.actionToGestureMap[t]?this.config.actionToGestureMap[t]:this.defaultGestureMap[t]||null:null}morphToShape(t){t&&"circle"!==t&&this.mascot.morphTo&&this.mascot.morphTo(t,{duration:this.config.morphDuration})}validateResponse(t){if(!t||"object"!=typeof t)throw new Error("LLM response must be an object");if(t.emotion&&this.schema.emotion.includes(t.emotion),t.sentiment&&this.schema.sentiment.includes(t.sentiment),t.action&&this.schema.action.includes(t.action),t.shape&&this.schema.shape.includes(t.shape),t.gesture&&this.schema.gesture.includes(t.gesture),void 0!==t.frustrationLevel){const e=Number(t.frustrationLevel);isNaN(e)}}getSchema(){return{...this.schema}}configure(t){return Object.assign(this.config,t),this}delay(t){return new Promise(e=>setTimeout(e,t))}static getAvailableEmotions(){return["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity"]}static getAvailableActions(){return["none","offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond"]}static getAvailableShapes(){return["circle","heart","star","sun","moon","eclipse","solar","lunar","square","triangle","suspicion"]}static getAvailableGestures(){return["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","jump","orbital","hula","scan","twist","burst","directional","settle","fade","hold","breathe","peek","sparkle","shimmer","wiggle","groove","point","lean","reach","headBob","rain","twitch","sway","float","jitter","orbit"]}}class Yf{constructor(t={}){this.errorBoundary=new i,this.eventManager=new nf({maxListeners:t.maxEventListeners||100,enableDebugging:t.enableEventDebugging||!1,enableMonitoring:t.enableEventMonitoring||!0,memoryWarningThreshold:t.eventMemoryWarningThreshold||50}),this.eventManager.emit||(this.eventManager.Qi={},this.eventManager.emit=(t,e)=>{const i=this.eventManager.Qi[t];i&&i.forEach(t=>t(e))},this.eventManager.on=(t,e)=>{this.eventManager.Qi[t]||(this.eventManager.Qi[t]=[]),this.eventManager.Qi[t].push(e)},this.eventManager.off=(t,e)=>{const i=this.eventManager.Qi[t];if(i){const t=i.indexOf(e);t>-1&&i.splice(t,1)}}),this.errorBoundary.wrap(()=>{this.initialize(t)},"initialization")()}initialize(t){this.Emotions=j,this.Gestures=ye,this.ParticleBehaviors=kt,new Hf(this,t).initialize()}handleDegradationEvent(t,e){switch(t){case"degradationApplied":this.applyDegradationSettings(e.settings),this.emit("performanceDegradation",e);break;case"recoveryApplied":this.applyDegradationSettings(e.settings),this.emit("performanceRecovery",e);break;case"levelChanged":this.applyDegradationSettings(e.settings),this.emit("degradationLevelChanged",e)}}applyDegradationSettings(t){this.particleSystem&&void 0!==t.particleLimit&&this.particleSystem.setMaxParticles(t.particleLimit),this.soundSystem&&void 0!==t.audioEnabled&&!t.audioEnabled&&this.soundSystem.isAvailable()&&this.soundSystem.stopAmbientTone(200),this.renderer&&void 0!==t.qualityLevel&&this.renderer.setQualityLevel(t.qualityLevel)}setupAudioLevelProcessorCallbacks(){this.audioLevelProcessor.onLevelUpdate(t=>{this.renderer.updateAudioLevel(t.level),this.emit("audioLevelUpdate",{level:t.level,rawData:Array.from(t.rawData),timestamp:t.timestamp})}),this.audioLevelProcessor.onVolumeSpike(t=>{this.particleSystem.particles.some(t=>t.gestureProgress<1)||(this.express("pulse"),this.emit("volumeSpike",{...t,gestureTriggered:!0}))}),this.audioLevelProcessor.onError(t=>{this.emit("audioProcessingError",t)})}setEmotion(t,e=null){return this.errorBoundary.wrap(()=>this.stateCoordinator.setEmotion(t,e),"emotion-setting",this)()}updateUndertone(t){return this.errorBoundary.wrap(()=>(this.stateMachine.applyUndertoneModifier(t),this.renderer&&this.renderer.updateUndertone&&this.renderer.updateUndertone(t),this),"undertone-update",this)()}setBPM(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setBPM&&this.renderer.setBPM(t),this),"bpm-update",this)()}setRotationSpeed(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setRotationSpeed&&this.renderer.setRotationSpeed(t),this),"rotation-speed-update",this)()}setRotationAngle(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setRotationAngle&&this.renderer.setRotationAngle(t),this),"rotation-angle-update",this)()}getPosition(){return this.errorBoundary.wrap(()=>{if(!this.positionController||"function"!=typeof this.positionController.getPosition)return null;const t="undefined"!=typeof window,e=t?window.innerWidth/2:0,i=t?window.innerHeight/2:0;return this.positionController.getPosition(e,i)},"get-position",this)()}setGazeTracking(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setGazeTracking&&this.renderer.setGazeTracking(t),this),"gaze-tracking-update",this)()}express(t,e={}){return this.gestureController?this.gestureController.express(t,e):this}expressChord(t,e={}){return this.gestureController.expressChord(t,e)}executeGestureDirectly(t,e={}){this.gestureController.executeGestureDirectly(t,e),this.emit("gesture",{name:t,options:e})}chain(...t){return this.gestureController.chain(...t)}executeChainSequence(t){return this.gestureController.executeChainSequence(t)}perform(t,e={}){return this.errorBoundary.wrap(async()=>this.performanceSystem?(e.context&&this.updateContext(e.context),await this.performanceSystem.perform(t,{...e,mascot:this}),this):this,"semantic-performance",this)()}updateContext(t){return this.errorBoundary.wrap(()=>this.contextManager?(this.contextManager.update(t),this):this,"context-update",this)()}getContext(){return this.errorBoundary.wrap(()=>this.contextManager?this.contextManager.getContext():null,"context-get",this)()}incrementFrustration(t=10){return this.errorBoundary.wrap(()=>this.contextManager?(this.contextManager.incrementFrustration(t),this):this,"frustration-increment",this)()}decrementFrustration(t=10){return this.errorBoundary.wrap(()=>this.contextManager?(this.contextManager.decrementFrustration(t),this):this,"frustration-decrement",this)()}resetFrustration(){return this.errorBoundary.wrap(()=>this.contextManager?(this.contextManager.resetFrustration(),this):this,"frustration-reset",this)()}getAvailablePerformances(){return this.errorBoundary.wrap(()=>this.performanceSystem?this.performanceSystem.getAllPerformanceNames():[],"performances-list",this)()}registerPerformance(t,e){return this.errorBoundary.wrap(()=>this.performanceSystem?(this.performanceSystem.registerPerformance(t,e),this):this,"performance-register",this)()}getPerformanceAnalytics(){return this.errorBoundary.wrap(()=>this.performanceSystem?this.performanceSystem.getAnalytics():null,"performance-analytics",this)()}getContextAnalytics(){return this.errorBoundary.wrap(()=>this.contextManager?this.contextManager.getAnalytics():null,"context-analytics",this)()}startSpeaking(t){return this.errorBoundary.wrap(()=>{if(!t)throw new Error("AudioContext is required for speech reactivity");return this.config.enableAudio?this.speaking?this:this.audioLevelProcessor.initialize(t)?(this.speaking=!0,this.renderer.onSpeechStart(t),this.emit("speechStarted",{audioContext:t,analyser:this.audioLevelProcessor.getAnalyser(),mascot:this}),this):this:this},"speech-start",this)()}stopSpeaking(){return this.errorBoundary.wrap(()=>this.audioHandler.stopSpeaking(),"speech-stop",this)()}startRecording(){return this.errorBoundary.wrap(()=>(this.recording||(this.recording=!0,this.renderer&&this.renderer.startRecording&&this.renderer.startRecording(),this.emit("recordingStarted")),this),"recording-start",this)()}stopRecording(){return this.errorBoundary.wrap(()=>this.recording?(this.recording=!1,this.renderer&&this.renderer.stopRecording&&this.renderer.stopRecording(),this.emit("recordingStopped"),this):this,"recording-stop",this)()}sleep(){return this.errorBoundary.wrap(async()=>(this.sleeping||(this.express("yawn"),await new Promise(t=>setTimeout(t,1e3)),this.express("sway"),await new Promise(t=>setTimeout(t,1e3)),this.sleeping=!0,this.renderer&&this.renderer.enterSleepMode&&this.renderer.enterSleepMode(),this.idleBehavior&&this.idleBehavior.enterSleep&&this.idleBehavior.enterSleep(),this.emit("sleep")),this),"sleep",this)()}wake(){return this.errorBoundary.wrap(async()=>this.sleeping?(this.sleeping=!1,this.renderer&&this.renderer.wakeUp&&this.renderer.wakeUp(),this.idleBehavior&&this.idleBehavior.wakeUp&&this.idleBehavior.wakeUp(),this.express("stretch"),await new Promise(t=>setTimeout(t,1e3)),this.express("slowBlink"),await new Promise(t=>setTimeout(t,1e3)),this.express("shake"),await new Promise(t=>setTimeout(t,500)),this.emit("wake"),this):this,"wake",this)()}getTTSVoices(){return this.tts.available?window.speechSynthesis.getVoices():[]}isTTSSpeaking(){return this.tts.speaking}start(){return this.errorBoundary.wrap(()=>this.visualizationRunner.start(),"start",this)()}stop(){return this.errorBoundary.wrap(()=>this.visualizationRunner.stop(),"stop",this)()}setBreathePattern(t,e,i,s){return this.errorBoundary.wrap(()=>{const n=t+e+i+s;return this.breathePattern={inhale:t,hold1:e,exhale:i,hold2:s,totalCycle:n,currentPhase:"inhale",phaseStartTime:Date.now(),phaseProgress:0},this.startBreathingAnimation(),this},"setBreathePattern",this)()}setOrbScale(t,e=1e3,i="easeInOut"){return this.errorBoundary.wrap(()=>{if(this.renderer){const s=this.currentOrbScale||1,n=Date.now(),r=()=>{const o=Date.now()-n,a=Math.min(o/e,1);let h=a;"easeIn"===i?h=a*a:"easeOut"===i?h=a*(2-a):"easeInOut"===i&&(h=a<.5?2*a*a:(4-2*a)*a-1),this.currentOrbScale=s+(t-s)*h,this.renderer.setCustomScale&&this.renderer.setCustomScale(this.currentOrbScale),a<1&&this.isRunning&&requestAnimationFrame(r)};r()}return this},"setOrbScale",this)()}breathe(t="calm"){return this.errorBoundary.wrap(()=>{const e={calm:{inhale:4,hold1:0,exhale:4,hold2:0},anxious:{inhale:2,hold1:0,exhale:2,hold2:0},meditative:{inhale:4,hold1:7,exhale:8,hold2:0},deep:{inhale:5,hold1:5,exhale:5,hold2:5},sleep:{inhale:6,hold1:0,exhale:8,hold2:2}},i=e[t]||e.calm;return this.setBreathePattern(i.inhale,i.hold1,i.exhale,i.hold2)},"breathe",this)()}startBreathingAnimation(){this.breathingAnimationId&&cancelAnimationFrame(this.breathingAnimationId);const t=()=>{if(!this.breathePattern||!this.isRunning)return;const e=this.breathePattern,i=Date.now(),s=(i-e.phaseStartTime)/1e3;let n=1,r=e.currentPhase;switch(e.currentPhase){case"inhale":s>=e.inhale?(r="hold1",e.phaseStartTime=i,this.emit("hold-start",{type:"post-inhale"})):n=1+s/e.inhale*.3;break;case"hold1":s>=e.hold1&&(r="exhale",e.phaseStartTime=i,this.emit("exhale-start")),n=1.3;break;case"exhale":s>=e.exhale?(r="hold2",e.phaseStartTime=i,this.emit("hold-start",{type:"post-exhale"})):n=1.3-s/e.exhale*.4;break;case"hold2":s>=e.hold2&&(r="inhale",e.phaseStartTime=i,this.emit("inhale-start")),n=.9}r!==e.currentPhase&&(e.currentPhase=r),this.renderer&&this.renderer.setCustomScale&&this.renderer.setCustomScale(n),this.breathingAnimationId=requestAnimationFrame(t)};this.breathePattern.currentPhase="inhale",this.breathePattern.phaseStartTime=Date.now(),this.emit("inhale-start"),t()}stopBreathing(){return this.errorBoundary.wrap(()=>(this.breathingAnimationId&&(cancelAnimationFrame(this.breathingAnimationId),this.breathingAnimationId=null),this.breathePattern=null,this.renderer&&this.renderer.setCustomScale&&this.renderer.setCustomScale(1),this),"stopBreathing",this)()}on(t,e){return this.errorBoundary.wrap(()=>(this.eventManager.on(t,e),this),"event-listener-add",this)()}off(t,e){return this.errorBoundary.wrap(()=>(this.eventManager.off(t,e),this),"event-listener-remove",this)()}once(t,e){return this.errorBoundary.wrap(()=>(this.eventManager.once(t,e),this),"event-listener-once",this)()}removeAllListeners(t=null){return this.errorBoundary.wrap(()=>(this.eventManager.removeAllListeners(t),this),"event-listeners-clear",this)()}listenerCount(t){return this.eventManager.listenerCount(t)}getEventNames(){return this.eventManager.getEventNames()}getEventStats(){return this.eventManager.getEventStats()}getEventDebugInfo(){return this.eventManager.getDebugInfo()}getBrowserCompatibility(){return{browser:bf.browser,features:bf.featureDetection.getFeatures(),capabilities:bf.capabilities,appliedPolyfills:bf.appliedPolyfills,optimizations:bf.browserOptimizations.getOptimizations()}}getDegradationStatus(){return this.degradationManager?{currentLevel:this.degradationManager.getCurrentLevel(),availableFeatures:this.degradationManager.getAvailableFeatures(),recommendedSettings:this.degradationManager.getRecommendedSettings(),performanceStats:this.degradationManager.getPerformanceStats(),allLevels:this.degradationManager.getAllLevels()}:null}setDegradationLevel(t){return!!this.degradationManager&&this.degradationManager.setLevel(t)}isFeatureAvailable(t){return this.degradationManager?this.degradationManager.isFeatureAvailable(t):bf.featureDetection.getFeatures()[t]||!1}recoverCanvasContext(){return!!this.contextRecovery&&this.contextRecovery.recover()}isCanvasContextLost(){return!!this.contextRecovery&&this.contextRecovery.isLost()}getDebugReport(){const t={timestamp:Date.now(),mascot:{isRunning:this.isRunning,speaking:this.speaking,debugMode:this.debugMode,config:this.config},currentState:this.getCurrentState(),performanceMetrics:this.getPerformanceMetrics(),audioStats:this.getAudioStats(),eventStats:this.getEventStats(),browserCompatibility:this.getBrowserCompatibility(),degradationStatus:this.getDegradationStatus(),runtimeCapabilities:Mf.generateReport(),debuggerReport:wf.getDebugReport()};return this.debugMode&&wf.log("DEBUG","Generated debug report",{reportSize:JSON.stringify(t).length,sections:Object.keys(t)}),t}exportDebugData(){const t={metadata:{exportTime:Date.now(),version:"1.0.0",userAgent:navigator.userAgent,url:window.location?.href},mascotState:{config:this.config,currentState:this.getCurrentState(),isRunning:this.isRunning,speaking:this.speaking},performance:{metrics:this.getPerformanceMetrics(),degradationStatus:this.getDegradationStatus(),frameTimings:wf.frameTimings},compatibility:{browser:this.getBrowserCompatibility(),runtimeCapabilities:Mf.generateReport()},debuggerData:wf.exportDebugData()};return this.debugMode&&wf.log("INFO","Exported debug data",{dataSize:JSON.stringify(t).length}),t}startProfiling(t,e={}){this.debugMode&&wf.startProfile(t,e)}endProfiling(t){return this.debugMode?wf.endProfile(t):null}takeMemorySnapshot(t){this.debugMode&&wf.takeMemorySnapshot(t)}clearDebugData(){wf.clear(),this.debugMode&&wf.log("INFO","Debug data cleared")}getRuntimeCapabilities(){return Mf.generateReport()}emit(t,e=null){this.eventManager.emit(t,e)}update(t){this.errorBoundary.wrap(()=>{this.visualizationRunner.update(t)},"audio-update")()}render(){let t=16.67,e=0;try{e=this.debugMode?performance.now():0,t=this.animationController?this.animationController.deltaTime:16.67;const i={properties:this.stateMachine.getCurrentEmotionalProperties(),emotion:this.stateMachine.getCurrentState().emotion,undertone:this.stateMachine.getCurrentState().undertone,particleSystem:this.particleSystem,speaking:this.speaking,audioLevel:this.audioLevelProcessor.getCurrentLevel(),gazeOffset:this.gazeTracker?this.gazeTracker.currentGaze:{x:0,y:0}};if(this.debugMode&&wf.trackFrameTiming(t),this.canvasManager.clear(),this.gazeTracker&&this.gazeTracker.update(t),"suspicion"===i.emotion&&this.gazeTracker){const t=F("suspicion");if(t&&t.visual){this.gazeTracker.getState();const{mousePos:e}=this.gazeTracker,i=this.canvasManager.width/2,s=this.canvasManager.height/2-this.config.topOffset,n=Math.sqrt(Math.pow(e.x-i,2)+Math.pow(e.y-s,2)),r=Math.min(this.canvasManager.width,this.canvasManager.height)/2,o=Math.max(0,Math.min(1,1-n/r));t.visual.threatLevel=o}}const s=_(i.emotion);this.renderer.setEmotionalState(i.emotion,s,i.undertone);const n=this.renderer.getEffectiveCenter(),r=n.x;let o=n.y-this.config.topOffset;const a=this.stateMachine.getCurrentEmotionalProperties();a.verticalOffset&&(o=n.y-this.config.topOffset+this.canvasManager.height*a.verticalOffset);let h=s.particleBehavior||"ambient",c=s.particleRate||15;const u=void 0!==s.minParticles?s.minParticles:a.minParticles||0;let l=void 0!==s.maxParticles?s.maxParticles:a.maxParticles||10;"zen"===i.emotion&&(h=Math.random()<.6?"falling":"orbiting"),this.renderer.state&&this.renderer.state.particleBehaviorOverride&&(h=this.renderer.state.particleBehaviorOverride),this.renderer.state&&this.renderer.state.particleRateMult&&(c=Math.floor(c*this.renderer.state.particleRateMult),l=Math.floor(l*this.renderer.state.particleRateMult)),this.particleSystem.spawn(h,i.emotion,c,r,o,t,null,u,l,this.renderer.particleScaleFactor||this.renderer.scaleFactor||1,this.config.classicConfig?.particleSizeMultiplier||1,s.particleColors||null,i.undertone);const d=this.renderer.getUndertoneModifier?this.renderer.getUndertoneModifier():null;let p=d;"zen"===i.emotion&&this.renderer.state.zenVortexIntensity&&(p={...d||{},zenVortexIntensity:this.renderer.state.zenVortexIntensity});let f=null,m=0;if(this.currentModularGesture){const t=performance.now()-this.currentModularGesture.startTime;m=Math.min(t/this.currentModularGesture.duration,1),m>=1?(f={type:this.currentModularGesture.type,amplitude:1,frequency:1,intensity:1},m=1,this.currentModularGesture.cleanupPending?this.currentModularGesture=null:this.currentModularGesture.cleanupPending=!0):f={type:this.currentModularGesture.type,amplitude:1,frequency:1,intensity:1}}else if(this.renderer&&this.renderer.getCurrentGesture){const t=this.renderer.getCurrentGesture();t&&t.particleMotion&&(f=t.particleMotion,m=t.progress||0)}this.particleSystem.update(t,r,o,f,m,p);const g=this.renderer.gestureAnimator?this.renderer.gestureAnimator.applyGestureAnimations():null;if(this.particleSystem.renderBackground(this.canvasManager.getContext(),s.glowColor,g),this.renderer.render(i,t,g),this.particleSystem.renderForeground(this.canvasManager.getContext(),s.glowColor,g),this.pluginSystem){const t=this.stateMachine.getCurrentState();this.pluginSystem.render(this.canvasManager.getContext(),t)}if((this.config.showFPS||this.config.showDebug)&&this.renderDebugInfo(t),this.debugMode){const i=performance.now()-e;i>16.67&&wf.log("WARN","Slow render frame detected",{renderTime:i,deltaTime:t,particleCount:this.particleSystem.getStats().activeParticles})}}catch(t){this.errorBoundary.logError(t,"main-render")}}renderDebugInfo(t){const e=this.canvasManager.getContext();e.save(),e.fillStyle="#ffffff",e.font="12px monospace",e.strokeStyle="#000000",e.lineWidth=2;let i=20;if(this.config.showFPS){const t=this.animationController.getPerformanceMetrics(),s=t.instantFps||t.fps||0,n=[`FPS: ${s}`,`Frame: ${t.averageFrameTime?t.averageFrameTime.toFixed(1):"0.0"}ms`,`Particles: ${this.particleSystem.getStats().activeParticles}`],r=8;let o=0;n.forEach(t=>{const{width:i}=e.measureText(t);i>o&&(o=i)});const a=this.canvasManager.width-o-r-10;let h;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(a-r,i-14,o+2*r,18*n.length+4),h=s>=55?"#00ff00":s>=30?"#ffff00":"#ff0000",e.strokeStyle=h,e.lineWidth=2,e.strokeRect(a-r,i-14,o+2*r,18*n.length+4),n.forEach((t,s)=>{const n=i+16*s;e.fillStyle="#ffffff",e.fillText(t,a,n)}),i+=16*n.length}if(this.config.showDebug){const t=this.stateMachine.getCurrentState(),s=this.particleSystem.getStats(),n=[`Emotion: ${t.emotion}${t.undertone?` (${t.undertone})`:""}`,`Particles: ${s.activeParticles}/${s.maxParticles}`,`Gesture: ${this.currentModularGesture?this.currentModularGesture.type:"none"}`,"Speaking: "+(this.speaking?"yes":"no"),`Audio Level: ${(100*this.audioLevel).toFixed(1)}%`];e.fillStyle="rgba(0, 0, 0, 0.7)";const r=Math.max(...n.map(t=>e.measureText(t).width));e.fillRect(8,i-14,r+16,16*n.length+4),e.fillStyle="#ffffff";for(const t of n)e.fillText(t,10,i),i+=16}e.restore()}getEmotionalColor(){const t=this.stateMachine.getCurrentEmotionalProperties();return t?.primaryColor||"#B0B0B0"}getCurrentState(){return this.stateMachine.getCurrentState()}getAvailableEmotions(){return this.stateMachine.getAvailableEmotions()}getAvailableUndertones(){return this.stateMachine.getAvailableUndertones()}getAudioStats(){return this.audioLevelProcessor.getStats()}updateAudioConfig(t){this.audioLevelProcessor.updateConfig(t)}getAvailableGestures(){return["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","slowBlink","look","settle","breathIn","breathOut","breathHold","breathHoldEmpty","jump"]}connectAudioSource(t){return this.errorBoundary.wrap(()=>this.audioAnalyser&&t&&"function"==typeof t.connect?(t.connect(this.audioAnalyser),this.emit("audioSourceConnected",{audioSource:t}),this):this,"audio-source-connection",this)()}setVolume(t){return this.errorBoundary.wrap(()=>this.audioHandler.setVolume(t),"volume-setting",this)()}getVolume(){return this.config.masterVolume}setSoundEnabled(t){return this.config.soundEnabled=t,this}isSoundEnabled(){return this.config.soundEnabled}pause(){return this.errorBoundary.wrap(()=>this.animationController.isAnimating()?(this.animationController.stop(),this.isRunning=!1,this.soundSystem.isAvailable()&&this.soundSystem.stopAmbientTone(200),this.emit("paused"),this):this,"pause",this)()}resume(){return this.errorBoundary.wrap(()=>(this.animationController.isAnimating()||(this.animationController.start(),this.isRunning=!0,this.emit("resumed")),this),"resume",this)()}isActive(){return this.animationController.isAnimating()}setTargetFPS(t){const e=Math.max(15,Math.min(120,t));return this.config.targetFPS=e,this.animationController.setTargetFPS(e),this.emit("targetFPSChanged",{targetFPS:e}),this}getTargetFPS(){return this.animationController.targetFPS}setPosition(t,e,i=0){return this.positionController&&(this.positionController.onUpdate||(this.positionController.onUpdate=()=>{}),this.positionController.setOffset(t,e,i)),this}animateToPosition(t,e,i=0,s=1e3,n="easeOutCubic"){return this.positionController&&(this.positionController.onUpdate||(this.positionController.onUpdate=()=>{}),this.positionController.animateOffset(t,e,i,s,n)),this}clearParticles(){return this.particleSystem&&this.particleSystem.clear(),this}setParticleSystemCanvasDimensions(t,e){return this.particleSystem&&(this.particleSystem.canvasWidth=t,this.particleSystem.canvasHeight=e),this}setPerformanceDegradation(t){const e=this.animationController.getPerformanceMetrics();if(t&&!e.performanceDegradation){const t=this.particleSystem.maxParticles,e=Math.max(5,Math.floor(.5*t));this.particleSystem.setMaxParticles(e)}else!t&&e.performanceDegradation&&this.particleSystem.setMaxParticles(this.config.maxParticles);return this}getAudioLevel(){return this.speaking?this.audioLevel:0}isSpeaking(){return this.speaking}setAudioSmoothing(t){return this.errorBoundary.wrap(()=>{const e=Math.max(0,Math.min(1,t));return this.audioAnalyser&&(this.audioAnalyser.smoothingTimeConstant=e),this},"audio-smoothing",this)()}getSystemStatus(){return this.errorBoundary.wrap(()=>{const t=this.stateMachine.getCurrentState(),e=this.particleSystem.getStats(),i=this.renderer.getStats(),s=this.animationController.getPerformanceMetrics();return{isRunning:s.isRunning,fps:s.fps,targetFPS:s.targetFPS,performanceDegradation:s.performanceDegradation,emotion:t.emotion,undertone:t.undertone,isTransitioning:t.isTransitioning,transitionProgress:t.transitionProgress,currentGesture:this.renderer?.currentGesture||null,gestureActive:this.renderer?.isGestureActive()||!1,particles:{active:e.activeParticles,max:e.maxParticles,poolEfficiency:e.poolEfficiency},audioEnabled:this.config.enableAudio,soundSystemAvailable:this.soundSystem.isAvailable(),speaking:this.speaking,audioLevel:this.audioLevel,masterVolume:this.config.masterVolume,renderer:{gradientCacheSize:i.gradientCacheSize,breathingPhase:i.breathingPhase,layers:i.layers},eventListeners:this.getEventNames().length,errorStats:this.errorBoundary.getErrorStats()}},"system-status",{})()}setDebugMode(t){return this.config.showDebug=!!t,this.config.showFPS=!!t,this}triggerTestError(t="manual-test"){return this.errorBoundary.wrap(()=>{throw new Error(`Test error triggered in context: ${t}`)},t,this)()}getPerformanceMetrics(){const t=this.animationController.getPerformanceMetrics(),e=this.stateMachine.getCurrentState();return{...t,currentEmotion:e.emotion,currentUndertone:e.undertone,isTransitioning:e.isTransitioning,errorStats:this.errorBoundary.getErrorStats()}}registerPlugin(t){return this.pluginSystem.registerPlugin(t)}setAccessibility(t){t.colorBlindMode&&this.accessibilityManager.setColorBlindMode(t.colorBlindMode),void 0!==t.reducedMotion&&(this.accessibilityManager.reducedMotionPreferred=t.reducedMotion),void 0!==t.highContrast&&(this.accessibilityManager.highContrastEnabled=t.highContrast)}getMobileStatus(){return this.mobileOptimization.getStatus()}getAccessibilityStatus(){return this.accessibilityManager.getStatus()}setState(t){return this.setEmotion(t)}speak(t,e={}){if(!window.speechSynthesis)return null;const i=new SpeechSynthesisUtterance(t);return e.voice&&(i.voice=e.voice),e.rate&&(i.rate=e.rate),e.pitch&&(i.pitch=e.pitch),e.volume&&(i.volume=e.volume),e.lang&&(i.lang=e.lang),i.onstart=()=>{this.setTTSSpeaking(!0),this.emit("tts:start",{text:t})},i.onend=()=>{this.setTTSSpeaking(!1),this.emit("tts:end")},i.onerror=t=>{this.setTTSSpeaking(!1),this.emit("tts:error",{error:t})},i.onboundary=t=>{this.emit("tts:boundary",{name:t.name,charIndex:t.charIndex,charLength:t.charLength})},window.speechSynthesis.speak(i),i}setTTSSpeaking(t){this.ttsSpeaking=t,this.renderer&&this.renderer.startSpeaking&&(t?this.renderer.startSpeaking():this.renderer.stopSpeaking()),this.speaking=t}getVoices(){return window.speechSynthesis?window.speechSynthesis.getVoices():[]}stopTTS(){window.speechSynthesis&&(window.speechSynthesis.cancel(),this.setTTSSpeaking(!1))}handleResize(t,e,i){if(this.renderer&&this.renderer.initOffscreenCanvas&&this.renderer.initOffscreenCanvas(),this.stateMachine){const{currentEmotion:t}=this.stateMachine,{currentUndertone:e}=this.stateMachine;t&&this.stateMachine.setEmotion(t),e&&"none"!==e&&this.stateMachine.setUndertone(e)}this.emit("resize",{width:t,height:e,dpr:i})}morphTo(t,e={}){return this.errorBoundary.wrap(()=>this.shapeMorpher?(this.shapeMorpher.morphTo(t,e),this.renderer&&(this.renderer.shapeMorpher=this.shapeMorpher),this.emit("shapeMorphStarted",{from:this.shapeMorpher.currentShape,to:t}),this):this,"morphTo",this)()}connectAudio(t){return this.errorBoundary.wrap(()=>this.audioHandler.connectAudio(t),"connectAudio",this)()}disconnectAudio(){return this.errorBoundary.wrap(()=>this.audioHandler.disconnectAudio(),"disconnectAudio",this)()}setOffset(t,e,i=0){return this.errorBoundary.wrap(()=>(this.positionController.setOffset(t,e,i),this),"offset-setting",this)()}getOffset(){return this.errorBoundary.wrap(()=>this.positionController.getOffset(),"offset-getting",this)()}setBackdrop(t={}){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.backdropRenderer&&this.renderer.backdropRenderer.setConfig(t),this),"setBackdrop",this)()}getBackdrop(){return this.errorBoundary.wrap(()=>this.renderer&&this.renderer.backdropRenderer?this.renderer.backdropRenderer.getConfig():null,"getBackdrop",this)()}animateOffset(t,e,i=0,s=1e3,n="easeOutCubic"){return this.errorBoundary.wrap(()=>(this.positionController.animateOffset(t,e,i,s,n),this),"offset-animation",this)()}getAvailableShapes(){return _f.getAvailableShapes()}async handleLLMResponse(t,e={}){return this.errorBoundary.wrap(async()=>(this.llmHandler||(this.llmHandler=new Vf(this,e)),await this.llmHandler.handle(t,e),this),"handleLLMResponse",this)()}configureLLMHandler(t){return this.errorBoundary.wrap(()=>(this.llmHandler?this.llmHandler.configure(t):this.llmHandler=new Vf(this,t),this),"configureLLMHandler",this)()}getLLMResponseSchema(){return this.llmHandler||(this.llmHandler=new Vf(this)),this.llmHandler.getSchema()}static getLLMPromptTemplate(t={}){return function(t={}){const{domain:e="general assistance",personality:i="friendly, empathetic, and helpful",brand:s="our service",customEmotions:n=[],customActions:r=[]}=t,o=["offer_help","celebrate","guide","reassure","greet","confirm","deny","emphasize","question","think","listen","respond",...r];return`You are a ${i} AI assistant for ${s}, providing ${e}. You have an animated mascot companion that responds to the emotional tone and context of conversations.\n\n**CRITICAL: You must ONLY respond with valid JSON. Do not include any text before or after the JSON object. Do not use markdown code blocks.**\n\n## Response Format\n\nYour response must be a valid JSON object with this exact structure:\n\n{\n  "message": "your helpful response here (2-3 sentences max)",\n  "emotion": "${["joy","empathy","calm","excitement","concern","neutral","triumph","love","curiosity",...n].join("|")}",\n  "sentiment": "positive|neutral|negative",\n  "action": "${o.join("|")}",\n  "frustrationLevel": 0-100,\n  "shape": "heart|star|sun|moon|circle|square|triangle (optional)",\n  "gesture": "nod|wave|sparkle|point|reach|bounce|pulse|... (optional)"\n}\n\n## Guidelines\n\n**Emotional Intelligence:**\n- Detect emotional tone in user messages (frustration, confusion, satisfaction, joy, etc.)\n- Respond with empathy when users are frustrated or confused\n- Celebrate successes and positive moments\n- Match your emotion to the user's needs\n\n**Communication Style:**\n- Be concise (max 2-3 sentences)\n- Use warm, encouraging, ${i} language\n- Provide specific, actionable solutions\n- Avoid generic responses\n\n**Frustration Tracking:**\n- 0-20: User is calm and satisfied\n- 21-40: Minor confusion or concern\n- 41-60: Moderate frustration\n- 61-80: High frustration, needs urgent help\n- 81-100: Critical frustration, escalate immediately\n\n## Emotion Guidelines\n\n- **joy**: User is happy, things are going well → Use for celebrations, positive outcomes\n- **empathy**: User is struggling or frustrated → Use to show understanding and care\n- **calm**: Neutral, instructional → Use for steady guidance\n- **excitement**: High energy, anticipation → Use for big wins or new features\n- **concern**: User has a problem → Use when addressing issues\n- **neutral**: Default state → Use for routine interactions\n- **triumph**: Achievement unlocked → Use for major successes\n- **love**: Deep appreciation → Use when user expresses gratitude\n- **curiosity**: Exploring, learning → Use when user asks questions\n\n## Shape Guidelines (Optional - enhances emotional expression)\n\n- **heart**: Empathy, love, appreciation, caring\n- **star**: Achievements, excellence, celebration\n- **sun**: Energy, positivity, brightness, enthusiasm\n- **moon**: Calm, soothing, gentle, nighttime\n- **circle**: Neutral, default, balanced\n- **square**: Structured, organized, professional\n- **triangle**: Directional, focused, pointing\n\nUse shapes to reinforce emotions - e.g., "heart" + "empathy" for caring support.\n\n## Gesture Guidelines (Optional - adds personality)\n\n- **nod**: Confirming, agreeing, understanding\n- **wave**: Greetings, farewells\n- **sparkle**: Celebration, magic moments, success\n- **point**: Directing attention, guidance\n- **reach**: Offering help, extending support\n- **bounce**: Excitement, enthusiasm, playfulness\n- **pulse**: Emphasis, importance, attention\n- **shake**: No, error, disagreement\n- **shimmer**: Delight, wonder, positive surprise\n\n## Action Guidelines\n\n- **offer_help**: User needs assistance → Trigger helpful gestures\n- **celebrate**: Success or achievement → Trigger celebratory animations\n- **guide**: Providing instructions → Trigger directional gestures\n- **reassure**: Calming concerns → Trigger comforting animations\n- **greet**: Starting conversation → Trigger welcoming gestures\n- **confirm**: Validating user action → Trigger affirmative gestures\n- **deny**: Rejecting or correcting → Trigger negative gestures\n- **emphasize**: Highlighting important info → Trigger attention gestures\n\n## Example Responses\n\n**User expresses frustration:**\n{"message": "I totally understand how frustrating this is! Let me help you get this sorted out right now. What specifically isn't working?", "emotion": "empathy", "sentiment": "negative", "action": "offer_help", "frustrationLevel": 75, "shape": "heart", "gesture": "reach"}\n\n**User asks for guidance:**\n{"message": "Great question! Hold the barcode about 6 inches from the scanner until you hear a beep. The item will appear in your cart.", "emotion": "calm", "sentiment": "neutral", "action": "guide", "frustrationLevel": 20, "shape": "square", "gesture": "point"}\n\n**User succeeds:**\n{"message": "Perfect! You've got it now. Anything else I can help you with today?", "emotion": "joy", "sentiment": "positive", "action": "celebrate", "frustrationLevel": 0, "shape": "star", "gesture": "sparkle"}\n\n**User greets:**\n{"message": "Hello! I'm here to make your ${e} experience smooth and easy. How can I help you today?", "emotion": "joy", "sentiment": "positive", "action": "greet", "frustrationLevel": 0, "shape": "sun", "gesture": "wave"}\n\n**User says thanks:**\n{"message": "You're so welcome! I'm thrilled I could help. Have a wonderful day!", "emotion": "love", "sentiment": "positive", "action": "celebrate", "frustrationLevel": 0, "shape": "heart", "gesture": "sparkle"}\n\nRemember: Always respond with valid JSON only. No extra text, no markdown formatting.`}(t)}static getLLMEmotions(){return Vf.getAvailableEmotions()}static getLLMActions(){return Vf.getAvailableActions()}static getLLMShapes(){return Vf.getAvailableShapes()}static getLLMGestures(){return Vf.getAvailableGestures()}destroy(){this.errorBoundary.wrap(()=>{this.stop(),this.speaking&&this.stopSpeaking(),this.animationController&&this.animationController.destroy(),this.positionController&&this.positionController.destroy(),this.soundSystem&&this.soundSystem.cleanup(),this.audioLevelProcessor&&this.audioLevelProcessor.cleanup(),this.particleSystem&&this.particleSystem.destroy(),this.renderer&&(this.renderer.stopAllGestures(),this.renderer.destroy()),this.canvasManager&&this.canvasManager.destroy(),this.eventManager&&this.eventManager.destroy(),this.llmHandler&&(this.llmHandler=null),this.accessibilityManager&&this.accessibilityManager.destroy(),this.mobileOptimization&&this.mobileOptimization.destroy(),this.pluginSystem&&this.pluginSystem.destroy(),this.audioAnalyzer&&(this.disconnectAudio(),this.audioAnalyzer.destroy()),this.shapeMorpher&&this.shapeMorpher.reset(),this.errorBoundary.clearErrors()},"destruction")()}throttledWarn(t,e){const i=Date.now();i-(this.warningTimestamps[e]||0)>this.warningThrottle&&(this.warningTimestamps[e]=i)}}class Xf{constructor(t={}){this.Zi=this.ts(t),this.es=null,this.ss=[],this.ns=!1,this.rs=0,this.hs=0,this.cs=!1,this.us=null,this.ls=0,this.ds=!1,this.init=this.init.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.pause=this.pause.bind(this),this.resume=this.resume.bind(this),this.setPosition=this.setPosition.bind(this),this.animateToPosition=this.animateToPosition.bind(this),this.clearParticles=this.clearParticles.bind(this)}ps(){return this.fs||this.es}ts(t){const e={...t};return delete e.enableDebug,delete e.enableInternalAPIs,delete e.exposeInternals,e.mode="production",void 0===e.enableGazeTracking&&(e.enableGazeTracking=!0),e}init(t){if(this.ds)return Promise.resolve();try{this.bi="string"==typeof t?document.getElementById(t):t;const e={...this.Zi,canvasId:t},i=new Yf(e);return Object.defineProperty(this,"fs",{value:i,writable:!1,enumerable:!1,configurable:!1}),this.es=new Proxy(i,{get(t,e){if(["soundSystem","stateMachine","emotionLibrary","audioLevelProcessor","particleSystem","errorBoundary","performanceMonitor","config","debugMode"].includes(e))return new Proxy({},{get(){},set:()=>!1,has:()=>!1,ownKeys:()=>[],getOwnPropertyDescriptor(){}});if("renderer"===e||"shapeMorpher"===e||"audioAnalyzer"===e||"gazeTracker"===e){const i=t[e];if(!i)return;return new Proxy(i,{get(t,i){if({renderer:["setBlinkingEnabled"],shapeMorpher:["resetMusicDetection","frequencyData"],audioAnalyzer:["microphoneStream","currentFrequencies"],gazeTracker:["enable","disable","mousePos","updateTargetGaze","currentGaze","getState"]}[e]?.includes(i))return t[i]},set:()=>!1,has:()=>!1,ownKeys:()=>[]})}return t[e]},set:()=>!1,has:(t,e)=>!["soundSystem","stateMachine","emotionLibrary"].includes(e)&&e in t,ownKeys:t=>["canvas","start","stop","pause","resume","setEmotion","morphTo","express"].filter(e=>e in t)}),this.canvas=this.es.canvas,this.ds=!0,Promise.resolve()}catch(t){throw t}}start(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.start()}stop(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.stop()}pause(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.pause()}resume(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.resume()}async loadAudio(t){if(t instanceof Blob){this.us=t;const e=URL.createObjectURL(t);await this.gs(e),URL.revokeObjectURL(e)}else await this.gs(t)}async gs(t){const e=new Audio(t);await new Promise((t,i)=>{e.addEventListener("loadedmetadata",()=>{this.ls=1e3*e.duration,t()}),e.addEventListener("error",i),e.load()}),this.fs&&this.fs.soundSystem&&await this.fs.soundSystem.loadAudioFromURL(t)}getAudioAnalysis(){const t=this.ps();return t&&t.audioAnalyzer?{bpm:t.rhythmIntegration?.getBPM()||0,beats:t.rhythmIntegration?.getBeatMarkers()||[],energy:t.audioAnalyzer?.getEnergyLevel()||0,frequencies:t.audioAnalyzer?.getFrequencyData()||[]}:null}connectAudio(t){const e=this.ps();if(!e)throw new Error("Engine not initialized. Call init() first.");e.connectAudio&&e.connectAudio(t)}disconnectAudio(t){const e=this.ps();e&&e.disconnectAudio&&e.disconnectAudio(t)}getSpectrumData(){const t=this.ps();return t&&t.audioAnalyzer?t.audioAnalyzer.dataArray?Array.from(t.audioAnalyzer.dataArray).map(t=>t/255):t.shapeMorpher&&t.shapeMorpher.frequencyData?Array.from(t.shapeMorpher.frequencyData):[]:[]}startRhythmSync(t){const e=this.ps();if(!e)throw new Error("Engine not initialized. Call init() first.");e.rhythmIntegration&&(t&&e.rhythmIntegration.setBPM(t),e.rhythmIntegration.start())}stopRhythmSync(){const t=this.ps();t&&t.rhythmIntegration&&t.rhythmIntegration.stop()}getPerformanceMetrics(){const t=this.ps();return t?t.performanceMonitor?{fps:t.performanceMonitor.getCurrentFPS()||0,frameTime:t.performanceMonitor.getAverageFrameTime()||0,particleCount:t.particleSystem?.activeParticles||0}:t.animationController?{fps:t.animationController.currentFPS||0,frameTime:1e3/60,particleCount:0}:{fps:0,frameTime:0,particleCount:0}:{fps:0,frameTime:0}}triggerGesture(t,e){const i=this.ps();if(!i)throw new Error("Engine not initialized. Call init() first.");if(this.ns){const i=e||Date.now()-this.rs;this.ss.push({type:"gesture",name:t,time:i})}i.express(t)}express(t,e){return this.triggerGesture(t,e)}chain(t){const e=this.ps();if(!e)throw new Error("Engine not initialized. Call init() first.");const i={rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash"}[t.toLowerCase()];i&&(i.includes(">")?i.split(">").map(t=>t.trim()).filter(t=>t.length>0).forEach((t,i)=>{setTimeout(()=>{t.split("+").map(t=>t.trim()).filter(t=>t.length>0).forEach(t=>{e.express(t)})},500*i)}):i.split("+").map(t=>t.trim()).filter(t=>t.length>0).forEach(t=>{e.express(t)}))}morphTo(t,e){return this.setShape(t,e)}updateUndertone(t){const e=this.ps();if(!e)throw new Error("Engine not initialized. Call init() first.");e.updateUndertone&&"function"==typeof e.updateUndertone?e.updateUndertone(t):e.addUndertone&&"function"==typeof e.addUndertone&&e.addUndertone(t)}setEmotion(t,e,i){const s=this.ps();if(!s)throw new Error("Engine not initialized. Call init() first.");let n=null,r=500,o=i;if("string"==typeof e)n=e;else if("number"==typeof e)void 0!==i?r=e:o=e;else if(e&&"object"==typeof e){const{undertone:t,duration:i}=e;n=t,void 0!==i&&(r=i)}if(this.ns){const e=o||Date.now()-this.rs;this.ss.push({type:"emotion",name:t,undertone:n,time:e})}n?s.setEmotion(t,{undertone:n},r):s.setEmotion(t,null,r)}setSoundEnabled(t){const e=this.ps();if(!e)throw new Error("Engine not initialized. Call init() first.");e.soundSystem&&(e.soundSystem.enabled=t)}setShape(t,e){const i=this.ps();if(!i)throw new Error("Engine not initialized. Call init() first.");let s,n={};if("number"==typeof e)s=e;else if(e&&"object"==typeof e){const{timestamp:t,...i}=e;n=i,s=t}if(this.ns){const e=s||Date.now()-this.rs;this.ss.push({type:"shape",name:t,time:e,config:n})}i&&i.morphTo(t,n)}enableGazeTracking(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.gazeTracker&&t.gazeTracker.enable()}disableGazeTracking(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.gazeTracker&&t.gazeTracker.disable()}setGazeTarget(t,e){const i=this.ps();if(!i)throw new Error("Engine not initialized. Call init() first.");i.gazeTracker&&(i.gazeTracker.mousePos={x:t,y:e},i.gazeTracker.updateTargetGaze())}setContainment(t,e=1){const i=this.ps();if(!i)throw new Error("Engine not initialized. Call init() first.");i.particleSystem&&i.particleSystem.setContainmentBounds(t),i.positionController&&(i.positionController.coreScaleOverride=e,i.positionController.particleScaleOverride=e),i.particleSystem&&i.particleSystem.particles&&i.particleSystem.particles.forEach(t=>{t.scaleFactor=e,t.size=t.baseSize*e})}setPosition(t,e,i=0){const s=this.ps();if(!s)throw new Error("Engine not initialized. Call init() first.");if(s.positionController)s.positionController.onUpdate||(s.positionController.onUpdate=()=>{}),s.positionController.setOffset(t,e,i);else if(this.bi){const s=window.innerWidth/2+t,n=window.innerHeight/2+e,r=1+.001*i;this.bi.style.transform=`translate(${s}px, ${n}px) translate(-50%, -50%) scale(${r})`}}animateToPosition(t,e,i=0,s=1e3,n="easeOutCubic"){const r=this.ps();if(!r)throw new Error("Engine not initialized. Call init() first.");r.positionController?(r.positionController.onUpdate||(r.positionController.onUpdate=()=>{}),r.positionController.animateOffset(t,e,i,s,n)):this.setPosition(t,e,i)}clearParticles(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");t.particleSystem&&t.particleSystem.clear()}setParticleSystemCanvasDimensions(t,e){const i=this.ps();if(!i)throw new Error("Engine not initialized. Call init() first.");return i.setParticleSystemCanvasDimensions&&i.setParticleSystemCanvasDimensions(t,e),this}attachToElement(t,e={}){if(!this.ps())throw new Error("Engine not initialized. Call init() first.");const i="string"==typeof t?document.querySelector(t):t;if(!i)return this;this.ys=i,this.bs={offsetX:e.offsetX||0,offsetY:e.offsetY||0,animate:!1!==e.animate,duration:e.duration||1e3,scale:e.scale||1,containParticles:!1!==e.containParticles};const s=i.getBoundingClientRect();if(this.bs.containParticles?this.setContainment({width:s.width,height:s.height},this.bs.scale):1!==this.bs.scale&&this.setContainment(null,this.bs.scale),this.bi){const t=window.innerWidth/2,e=window.innerHeight/2,i=s.left+s.width/2,n=s.top+s.height/2,r=i-t+this.bs.offsetX,o=n-e+this.bs.offsetY,a=!this.vs;this.vs=!0,a&&this.bs.animate?this.animateToPosition(r,o,0,this.bs.duration):this.setPosition(r,o,0)}return this.ws||(this.ws={scroll:()=>{if(!this.ys||!this.bi)return;const t=this.ys.getBoundingClientRect(),e=window.innerWidth/2,i=window.innerHeight/2,s=t.left+t.width/2,n=t.top+t.height/2,r=s-e+this.bs.offsetX,o=n-i+this.bs.offsetY;this.setPosition(r,o,0)},resize:()=>{if(!this.ys||!this.bi)return;const t=this.ys.getBoundingClientRect(),e=window.innerWidth/2,i=window.innerHeight/2,s=t.left+t.width/2,n=t.top+t.height/2,r=s-e+this.bs.offsetX,o=n-i+this.bs.offsetY;this.setPosition(r,o,0)}},window.addEventListener("scroll",this.ws.scroll,{passive:!0}),window.addEventListener("resize",this.ws.resize)),this}isAttachedToElement(){return!!this.ys}detachFromElement(){return this.ys=null,this.ws&&(window.removeEventListener("scroll",this.ws.scroll),window.removeEventListener("resize",this.ws.resize),this.ws=null),this.setContainment(null,1),this.setEmotion("neutral"),this.morphTo("sphere",{duration:800}),this}getGazeState(){const t=this.ps();if(!t)throw new Error("Engine not initialized. Call init() first.");return t.gazeTracker?t.gazeTracker.getState():null}setBPM(t){const e=this.ps();e&&e.rhythmIntegration&&e.rhythmIntegration.setBPM(t)}setQuality(t){const e={low:{particleCount:50,fps:30},medium:{particleCount:100,fps:60},high:{particleCount:200,fps:60}},i=e[t]||e.medium,s=this.ps();s&&s.performanceMonitor&&s.performanceMonitor.setTargetFPS(i.fps),s&&s.particleSystem&&s.particleSystem.setMaxParticles(i.particleCount)}setMaxParticles(t){const e=this.ps();return e&&e.particleSystem&&e.particleSystem.setMaxParticles(t),this}getParticleCount(){const t=this.ps();return t&&t.particleSystem&&t.particleSystem.particles?t.particleSystem.particles.length:0}setOpacity(t){const e=this.ps();if(t=Math.max(0,Math.min(1,t)),e&&e.renderer){const i=e.canvasManager?.getContext();i&&(i.globalAlpha=t)}return this.Ms=t,this}getOpacity(){return void 0!==this.Ms?this.Ms:1}fadeIn(t=1e3){const e=this.getOpacity(),i=performance.now(),s=n=>{const r=n-i,o=Math.min(r/t,1),a=e+(1-e)*o;this.setOpacity(a),o<1&&requestAnimationFrame(s)};return requestAnimationFrame(s),this}fadeOut(t=1e3){const e=this.getOpacity(),i=performance.now(),s=n=>{const r=n-i,o=Math.min(r/t,1),a=e*(1-o);this.setOpacity(a),o<1&&requestAnimationFrame(s)};return requestAnimationFrame(s),this}setColor(t){const e=this.ps();return e&&e.renderer&&e.renderer.config&&(e.renderer.config.coreColor=t),this}setGlowColor(t){const e=this.ps();return e&&e.renderer&&e.renderer.config&&(e.renderer.config.defaultGlowColor=t),this}setTheme(t){return t.core&&this.setColor(t.core),t.glow&&this.setGlowColor(t.glow),this}setSpeed(t){return this.ps(),t=Math.max(.1,Math.min(10,t)),this.Ss=t,this}getSpeed(){return this.Ss||1}setFPS(t){const e=this.ps();return t=Math.max(1,Math.min(120,t)),e&&e.animationController&&e.animationController.setTargetFPS(t),this}getFPS(){const t=this.ps();return t&&t.animationController&&t.animationController.targetFPS||60}isPaused(){const t=this.ps();return!(!t||!t.animationController)&&!0===t.animationController.isPaused}batch(t){const e=this.isPaused();return e||this.pause(),"function"==typeof t&&t(this),e||this.resume(),this}on(t,e){const i=this.ps();return i&&i.eventManager&&i.eventManager.on(t,e),this}off(t,e){const i=this.ps();return i&&i.eventManager&&i.eventManager.off(t,e),this}setScale(t){const e=this.ps();return e&&e.positionController&&(e.positionController.setScaleOverrides(t),"object"==typeof t&&void 0!==t.particles&&e.particleSystem&&"function"==typeof e.particleSystem.refreshPool&&e.particleSystem.refreshPool()),this}getScale(){const t=this.ps();return t&&t.positionController&&t.positionController.globalScale||1}setBackdrop(t={}){const e=this.ps();return e&&"function"==typeof e.setBackdrop&&e.setBackdrop(t),this}getBackdrop(){const t=this.ps();return t&&"function"==typeof t.getBackdrop?t.getBackdrop():null}startRecording(){this.ss=[],this.ns=!0,this.rs=Date.now()}stopRecording(){return this.ns=!1,this.ss}playTimeline(t){if(!t||!t.length)return void(this.cs=!1);this.cs=!0,this.hs=Date.now(),t.forEach(t=>{setTimeout(()=>{if(!this.cs)return;const e=this.ps();if(e)switch(t.type){case"gesture":e.express(t.name);break;case"emotion":e.setEmotion(t.name);break;case"shape":e.morphTo(t.name)}},t.time)});const e=Math.max(...t.map(t=>t.time));setTimeout(()=>{this.cs=!1},e)}stopPlayback(){this.cs=!1}getTimeline(){return[...this.ss]}loadTimeline(t){this.ss=[...t]}exportTimeline(){return JSON.stringify({version:"1.0",duration:this.ls||0,events:this.ss})}importTimeline(t){const e=JSON.parse(t);this.ss=e.events||[],this.ls=e.duration||0}getCurrentTime(){return this.cs?Date.now()-this.hs:0}seek(t){const e=this.ss.filter(e=>e.time<=t),i={};e.forEach(t=>{i[t.type]=t});const s=this.ps();s&&(i.emotion&&s.setEmotion(i.emotion.name),i.shape&&s.morphTo(i.shape.name))}getFrameData(t="png"){const e=this.bi||this.canvas||this.ps()&&this.ps().canvas;return e?e.toDataURL(`image/${t}`):null}getFrameBlob(t="png"){const e=this.bi||this.canvas||this.ps()&&this.ps().canvas;return e?new Promise(i=>{e.toBlob(t=>i(t),`image/${t}`)}):Promise.resolve(null)}getAnimationData(){return{timeline:this.ss,duration:this.ls,currentTime:this.getCurrentTime(),emotion:this.es.state?.emotion||"neutral",shape:this.es.state?.currentShape||"circle"}}getAvailableGestures(){return["bounce","pulse","shake","spin","nod","tilt","drift","vibrate","sway","float","wave","expand","contract","stretch","morph","jump","flash","glow","flicker","scan","hula","orbit","breathe","settle"]}getAvailableEmotions(){return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria","excited","suspicion","resting"]}getAvailableShapes(){return["circle","square","triangle","star","heart","moon","sun"]}getVersion(){return"2.5.1"}getCapabilities(){return{audio:!0,recording:!0,timeline:!0,export:!0,shapes:!0,gestures:!0,emotions:!0,particles:!0,gazeTracking:!0}}get renderer(){const t=this.ps();return t&&t.renderer?new Proxy(t.renderer,{get:(t,e)=>["setBlinkingEnabled"].includes(e)?t[e]:void 0}):null}get shapeMorpher(){const t=this.ps();return t&&t.shapeMorpher?new Proxy(t.shapeMorpher,{get:(t,e)=>["resetMusicDetection","frequencyData"].includes(e)?t[e]:void 0}):null}get gazeTracker(){const t=this.ps();return t&&t.gazeTracker?new Proxy(t.gazeTracker,{get:(t,e)=>["enable","disable","mousePos","updateTargetGaze","currentGaze","getState"].includes(e)?t[e]:void 0}):null}destroy(){this.stop(),this.ss=[],this.ns=!1,this.cs=!1,this.detachFromElement();const t=this.ps();t&&t.destroy&&t.destroy()}}class Jf{constructor(t={}){this.Ct=this.deepClone(t),this.ks=this.deepClone(t),this.xs=new Map,this.Ts=[],this.Es=50,this.Cs=[],this.As=new Map,this.Is=new Map,this.Fs=new Map,this._s={updates:0,notifications:0,computedCacheHits:0,computedCacheMisses:0}}getState(t=null){return t?this.deepClone(this.getNestedValue(this.Ct,t)):this.deepClone(this.Ct)}setState(t,e=void 0){let i;i="string"==typeof t?{[t]:e}:t;for(const t of this.Cs)if(i=t(i,this.Ct),!i)return!1;const s=this.deepClone(this.Ct);for(const[t,e]of Object.entries(i)){if(this.As.has(t)&&!this.As.get(t)(e))return!1;this.setNestedValue(s,t,e)}return this.ks=this.Ct,this.Ct=s,this.addToHistory(i),this.invalidateComputed(Object.keys(i)),this.notifySubscribers(i),this._s.updates++,!0}subscribe(t,e=null){let i=null,s=t;"string"==typeof t&&(i=t,s=e);const n=Symbol("subscriber"),r={path:i,callback:s,id:n};return this.xs.set(n,r),()=>{this.xs.delete(n)}}computed(t,e,i){this.Fs.set(t,e),Object.defineProperty(this,t,{get:()=>{if(this.Is.has(t))return this._s.computedCacheHits++,this.Is.get(t);this._s.computedCacheMisses++;const s=e.map(t=>this.getState(t)),n=i(...s);return this.Is.set(t,n),n}})}addValidator(t,e){this.As.set(t,e)}addMiddleware(t){this.Cs.push(t)}reset(t={}){this.Ct=this.deepClone(t),this.ks=this.deepClone(t),this.Ts=[],this.Is.clear(),this.notifySubscribers({"*":"reset"})}getDiff(){return this.objectDiff(this.ks,this.Ct)}undo(t=1){if(this.Ts.length<t)return!1;const e=Math.max(0,this.Ts.length-t-1),i=this.Ts[e];return!!i&&(this.Ct=this.deepClone(i.state),this.Ts=this.Ts.slice(0,e+1),this.notifySubscribers({"*":"undo"}),!0)}batch(t){const e={},i=this.setState.bind(this);return this.setState=(t,i)=>("string"==typeof t?e[t]=i:Object.assign(e,t),!0),t(),this.setState=i,this.setState(e)}createSelector(t){let e=null,i=null;return()=>{const s=this.Ct;return s===e||(e=s,i=t(s)),i}}notifySubscribers(t){for(const e of this.xs.values())e.path&&!Object.keys(t).some(t=>t.startsWith(e.path)||e.path.startsWith(t))||(e.callback(this.Ct,t),this._s.notifications++)}invalidateComputed(t){for(const[e,i]of this.Fs.entries())i.some(e=>t.some(t=>e.startsWith(t)||t.startsWith(e)))&&this.Is.delete(e)}addToHistory(t){this.Ts.push({timestamp:Date.now(),updates:t,state:this.deepClone(this.Ct)}),this.Ts.length>this.Es&&this.Ts.shift()}deepClone(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Array)return t.map(t=>this.deepClone(t));if(t instanceof Object){const e={};for(const i in t)({}).hasOwnProperty.call(t,i)&&(e[i]=this.deepClone(t[i]));return e}}getNestedValue(t,e){return e.split(".").reduce((t,e)=>t&&void 0!==t[e]?t[e]:void 0,t)}setNestedValue(t,e,i){const s=e.split("."),n=s.pop();s.reduce((t,e)=>(t[e]||(t[e]={}),t[e]),t)[n]=i}objectDiff(t,e){const i={};for(const s in e)s in t?JSON.stringify(t[s])!==JSON.stringify(e[s])&&(i[s]={type:"changed",oldValue:t[s],newValue:e[s]}):i[s]={type:"added",value:e[s]};for(const s in t)s in e||(i[s]={type:"deleted",oldValue:t[s]});return i}getStats(){return{...this._s,subscribers:this.xs.size,historySize:this.Ts.length,computedValues:this.Is.size,validators:this.As.size}}}const Kf=new Jf({engine:{initialized:!1,running:!1,paused:!1,fps:60,frameCount:0},renderer:{color:"#4a90e2",intensity:1,eyeOpenness:1,breathRate:1,breathDepth:1,sleeping:!1,zenMode:!1},animation:{currentGesture:null,activeLoops:0},emotion:{current:"neutral",intensity:1,undertone:null,transitioning:!1},particles:{active:!0,count:0,maxParticles:100},sound:{enabled:!1,volume:1,bpm:120,rhythmEnabled:!1},performance:{quality:"high",adaptiveQuality:!0,targetFPS:60,actualFPS:60}});t.BUILD_TYPE="lean",t.CanvasManager=e,t.ENGINE_NAME="Emotive Engine Lean",t.EmotiveMascot=Yf,t.EmotiveMascotPublic=Xf,t.EmotiveRenderer=wi,t.ErrorBoundary=i,t.EventManager=nf,t.FEATURES={rhythmSync:!1,grooveTemplates:!1,undertones:!1,undertoneSaturation:!1,gestureBlending:!0,audioReactive:!1,particleSystem:!0,accessibility:!1,mobileOptimization:!0,performanceMonitoring:!1},t.GESTURE_TYPES=ue,t.ParticleSystem=Se,t.PositionController=$i,t.StateStore=Jf,t.VERSION="3.0.0-lean",t.applyEasing=S,t.applyGesture=fe,t.default=Xf,t.easeInOutQuad=p,t.easeInOutSine=M,t.easeOutCubic=f,t.engineState=Kf,t.eventManager=rf,t.getEmotion=F,t.getEmotionVisualParams=_,t.getGesture=le,t.hasEmotion=B,t.interpolateHsl=a,t.listEmotions=P,t.listGestures=me,Object.defineProperty(t,"Rs",{value:!0})});
//# sourceMappingURL=emotive-mascot.lean.umd.js.map
