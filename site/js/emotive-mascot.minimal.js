class t{constructor(t){this.canvas=t,this.ctx=t.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.dpr=window.devicePixelRatio||1,this.width=0,this.height=0,this.centerX=0,this.centerY=0,this.resizeCallbacks=[],this.handleResize=this.handleResize.bind(this),window.addEventListener("resize",this.handleResize),this.resize()}resize(){if(this.canvas.hasAttribute("width")&&this.canvas.hasAttribute("height")){const t=parseInt(this.canvas.getAttribute("width"),10),i=parseInt(this.canvas.getAttribute("height"),10);this.width=t,this.height=i,this.canvas.width=t,this.canvas.height=i}else{const t=this.canvas.getBoundingClientRect();this.width=t.width,this.height=t.height,this.canvas.width=this.width*this.dpr,this.canvas.height=this.height*this.dpr,this.ctx.scale(this.dpr,this.dpr)}this.centerX=this.width/2,this.centerY=this.height/2,this.resizeCallbacks.forEach(t=>{try{t(this.width,this.height,this.dpr)}catch(t){}})}onResize(t){"function"==typeof t&&this.resizeCallbacks.push(t)}handleResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.resize()},100)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}getCenter(){return{x:this.centerX,y:this.centerY}}setTransform(t=0,i=0,e=1,s=0){this.ctx.save(),this.ctx.translate(t,i),this.ctx.rotate(s),this.ctx.scale(e,e)}restoreTransform(){this.ctx.restore()}getContext(){return this.ctx}getDimensions(){return{width:this.width,height:this.height}}destroy(){window.removeEventListener("resize",this.handleResize),clearTimeout(this.resizeTimeout)}}class i{constructor(){this.errors=[],this.maxErrors=10,this.errorCounts=new Map,this.defaults={emotion:"neutral",gesture:null,audioLevel:0,particleCount:0,glowIntensity:.7,coreSize:1,breathRate:1,color:"#B0B0B0"}}wrap(t,i,e=null){return(...s)=>{try{return t(...s)}catch(t){return this.logError(t,i),null!==e?e:this.getDefault(i)}}}logError(t,i){const e={timestamp:(new Date).toISOString(),context:i,message:t.message,stack:t.stack};this.errors.push(e);const s=this.errorCounts.get(i)||0;this.errorCounts.set(i,s+1),this.errors.length>this.maxErrors&&this.errors.shift()}getDefault(t){const i={"emotion-transition":this.defaults.emotion,"gesture-execution":this.defaults.gesture,"audio-processing":this.defaults.audioLevel,"particle-system":this.defaults.particleCount,rendering:{glowIntensity:this.defaults.glowIntensity,coreSize:this.defaults.coreSize,color:this.defaults.color},"canvas-operations":null,"state-management":this.defaults.emotion};return{}.hasOwnProperty.call(i,t)?i[t]:null}validateInput(t,i,e){try{switch(i){case"emotion":return["neutral","joy","sadness","anger","fear","surprise","disgust","love","euphoria"].includes(t)?t:e;case"undertone":return null===t||["nervous","confident","tired","intense","subdued"].includes(t)?t:null;case"gesture":return["bounce","pulse","shake","spin","nod","tilt","expand","contract","flash","drift"].includes(t)?t:e;case"number":return"number"!=typeof t||isNaN(t)?e:t;case"string":return"string"==typeof t?t:e;case"boolean":return"boolean"==typeof t?t:e;default:return null!=t?t:e}}catch(t){return this.logError(t,"input-validation"),e}}hasExceededThreshold(t,i=5){return(this.errorCounts.get(t)||0)>=i}getErrorStats(){return{totalErrors:this.errors.length,errorsByContext:Object.fromEntries(this.errorCounts),recentErrors:this.errors.slice(-5)}}clearErrors(){this.errors=[],this.errorCounts.clear()}async attemptRecovery(t,i,e=3){let s=0;for(;s<e;)try{return await i()}catch(i){if(s++,this.logError(i,`recovery-${t}-attempt-${s}`),s>=e)throw new Error(`Recovery failed for ${t} after ${e} attempts`);await new Promise(t=>setTimeout(t,100*Math.pow(2,s)))}}}function e(t){return 3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join("")),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}}function s(t,i,e){const s=t=>{const i=Math.round(Math.max(0,Math.min(255,t))).toString(16);return 1===i.length?`0${i}`:i};return`#${s(t)}${s(i)}${s(e)}`}function n(t,i,e){t/=255,i/=255,e/=255;const s=Math.max(t,i,e),n=Math.min(t,i,e);let h,a,r=(s+n)/2;if(s===n)h=a=0;else{const o=s-n;switch(a=r>.5?o/(2-s-n):o/(s+n),s){case t:h=(i-e)/o+(i<e?6:0);break;case i:h=(e-t)/o+2;break;case e:h=(t-i)/o+4}h/=6}return{h:360*h,s:100*a,l:100*r}}function h(t,i,e){t/=360,e/=100;const s=(t,i,e)=>(e<0&&(e+=1),e>1&&(e-=1),e<1/6?t+6*(i-t)*e:e<.5?i:e<2/3?t+(i-t)*(2/3-e)*6:t);let n,h,a;if(0==(i/=100))n=h=a=e;else{const r=e<.5?e*(1+i):e+i-e*i,o=2*e-r;n=s(o,r,t+1/3),h=s(o,r,t),a=s(o,r,t-1/3)}return{r:Math.round(255*n),g:Math.round(255*h),b:Math.round(255*a)}}function a(t,i,a){const r=e(t),o=e(i),c=n(r.r,r.g,r.b),l=n(o.r,o.g,o.b),u=c.h;let p=l.h;const d=p-u;d>180?p-=360:d<-180&&(p+=360);const m=h(((u+(p-u)*a)%360+360)%360,c.s+(l.s-c.s)*a,c.l+(l.l-c.l)*a);return s(m.r,m.g,m.b)}const r={intense:1.6,confident:1.3,nervous:1.15,clear:1,tired:.8,subdued:.5};function o(t,i){if(!i||"clear"===i)return t;const a=r[i.toLowerCase()];return a&&1!==a?function(t,i){const a=e(t),r=n(a.r,a.g,a.b);r.s=Math.max(0,Math.min(100,r.s*i));const o=h(r.h,r.s,r.l);return s(o.r,o.g,o.b)}(t,a):t}function c(t){return t}function l(t){return t*(2-t)}function u(t){return t*t}function p(t){return t<.5?2*t*t:(4-2*t)*t-1}function d(t){return 1-Math.pow(1-t,3)}function m(t){return t*t*t}function f(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function g(t){const i=2*Math.PI/3;return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*i)+1}function y(t){const i=7.5625,e=2.75;return t<1/e?i*t*t:t<2/e?i*(t-=1.5/e)*t+.75:t<2.5/e?i*(t-=2.25/e)*t+.9375:i*(t-=2.625/e)*t+.984375}function M(t){const i=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-i)/2:(Math.pow(2*t-2,2)*((i+1)*(2*t-2)+i)+2)/2}function b(t){return Math.sin(t*Math.PI/2)}function w(t){return-(Math.cos(Math.PI*t)-1)/2}function v(t,i,e,s="linear"){return i+(e-i)*("string"==typeof s?{linear:c,easeOutQuad:l,easeInQuad:u,easeInOutQuad:p,easeOutCubic:d,easeInCubic:m,easeInOutCubic:f,easeOutElastic:g,easeOutBounce:y,easeInOutBack:M,easeOutSine:b,easeInOutSine:w}[s]||c:s)(Math.max(0,Math.min(1,t)))}Object.fromEntries(Object.entries({neutral:"#B0B0B0",joy:"#FFD700",sadness:"#4169E1",anger:"#DC143C",fear:"#8B008B",surprise:"#FF8C00",disgust:"#9ACD32",love:"#FF69B4"}).map(([t,i])=>{const s=e(i);return[t,`${s.r}, ${s.g}, ${s.b}`]}));const S=new Map;var F=function(t){return S.get(t)||null},k=function(){return Array.from(S.keys())},x={name:"suspicion",emoji:"ðŸ¤¨",description:"Paranoid watchfulness with surveillance scanning",visual:{glowColor:"#6B46C1",glowIntensity:.85,particleRate:18,minParticles:6,maxParticles:12,particleBehavior:"surveillance",particleSpeed:.2,breathRate:.6,breathDepth:.04,coreJitter:.02,particleColors:[{color:"#6B46C1",weight:30},{color:"#4A5568",weight:25},{color:"#8B4789",weight:20},{color:"#9F7AEA",weight:15},{color:"#2D3748",weight:10}],threatLevel:0,getGlowIntensity(){return.3+.7*this.threatLevel},getParticleSpeed(){return.2+.8*this.threatLevel},getGlowColor(){const t=this.threatLevel||0,i=Math.round(107+113*t),e=Math.round(70+-32*t),s=Math.round(193+-66*t),n=t=>t.toString(16).padStart(2,"0");return`#${n(i)}${n(e)}${n(s)}`}},modifiers:{speed:.4,amplitude:.6,intensity:1.2,smoothness:.3,regularity:.2,focus:1.5,addWobble:!0},typicalGestures:["scan","twitch","peek","tilt","hold"],transitions:{duration:500,easing:"linear",priority:4},special:{coreSquint:.6,scanInterval:2e3,scanDuration:1200,scanAngle:60,twitchChance:.02,peekInterval:4e3,maxThreatDistance:300,alertThreshold:.7}},B={name:"calm",emoji:"ðŸ˜Œ",description:"Serene, peaceful state with gentle movements",visual:{glowColor:"#66D9CC",glowIntensity:.6,particleRate:25,minParticles:8,maxParticles:25,particleBehavior:"zen",breathRate:.4,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#66D9CC",weight:35},{color:"#99E6D9",weight:25},{color:"#40BFB3",weight:20},{color:"#B3F2E6",weight:15},{color:"#339980",weight:5}]},modifiers:{speed:.5,amplitude:.3,intensity:.4,smoothness:2,regularity:1.5,addWeight:!1,floatHeight:.2,swayAmount:.15,duration:1.5},typicalGestures:["breathe","float","drift","idle"],transitions:{duration:800,easing:"easeInOutSine",priority:1},audio:{ambientSound:"soft_waves",transitionSound:null,gestureSound:null,volumeModifier:.5},particleSpawn:{pattern:"center_drift",frequency:"slow",burstOnEntry:!1,fadeOnExit:!0,spawnRadius:.3,driftSpeed:.2},coreAppearance:{pupilSize:.9,irisPattern:"soft",blinkRate:"slow",lookDirection:"soft_center",eyeOpenness:.85},movement:{floatPattern:"sine_slow",floatPeriod:6e3,floatAmplitude:8,swayPattern:"gentle",swayPeriod:8e3,swayAmplitude:5,microMovements:!1},getCoreParams(t){const i=t.time||Date.now(),e=.5*Math.sin(6e-4*i)+.5;return{scaleX:1-.02*e,scaleY:1-.02*e,eyeOpenness:.85,eyeExpression:"serene",pupilOffset:{x:2*Math.sin(3e-4*i),y:1*Math.cos(4e-4*i)},glowPulse:.95+.05*e}},updateParticle(t,i){t.x+=.1*Math.sin(.001*t.life),t.y-=.02*i,t.opacity=.3*Math.sin(.002*t.life)+.2,t.size=t.baseSize*(1+.2*Math.sin(.001*t.life))},renderCore:(t,i,e,s)=>!1};const P=new Map,C={happy:"joy",peaceful:"calm",curious:"surprise",frustrated:"anger",sad:"sadness"};function A(t){const i=C[t]||t,e=P.get(i);if(e)return e;return F(i)||null}function T(t){const i=A(t);if(!i)return A("neutral").visual;if(!i.visual)return{};const{visual:e}=i,s={};for(const t in e)"function"!=typeof e[t]&&(s[t]=e[t]);return"function"==typeof e.getGlowIntensity&&(s.glowIntensity=e.getGlowIntensity()),"function"==typeof e.getParticleSpeed&&(s.particleSpeed=e.getParticleSpeed()),"function"==typeof e.getParticleRate&&(s.particleRate=e.getParticleRate()),"function"==typeof e.getGlowColor&&(s.glowColor=e.getGlowColor()),s}function O(t){const i=A(t);return i?i.modifiers:A("neutral").modifiers}function R(){return[...Array.from(P.keys()),...k()]}function z(t,i){const e=A(t),s=A(i);return e&&s?s.transitions&&s.transitions[t]?s.transitions[t]:{duration:1e3,easing:"ease-in-out",gesture:s.transitions?.defaultGesture||null}:{duration:1e3,easing:"ease-in-out"}}[{name:"neutral",emoji:"ðŸ˜",description:"Calm, balanced emotional state",visual:{glowColor:"#00BCD4",glowIntensity:.9,particleRate:2,minParticles:8,maxParticles:10,particleBehavior:"ambient",breathRate:1,breathDepth:.08,coreJitter:!1,particleColors:[{color:"#00BCD4",weight:25},{color:"#00ACC1",weight:20},{color:"#26C6DA",weight:15},{color:"#B2EBF2",weight:15},{color:"#0097A7",weight:10},{color:"#80DEEA",weight:10},{color:"#E0F7FA",weight:5}]},modifiers:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},typicalGestures:["breathe","float","idle","blink"],transitions:{duration:500,easing:"easeInOut",priority:0},audio:{ambientSound:null,transitionSound:null,gestureSound:null},particleSpawn:{pattern:"random",frequency:"steady",burstOnEntry:!1,fadeOnExit:!0},coreAppearance:{pupilSize:1,irisPattern:"default",blinkRate:"normal",lookDirection:"center"},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"neutral",pupilOffset:{x:0,y:0}}),renderCore:(t,i,e,s)=>!1},{name:"joy",emoji:"ðŸ˜Š",description:"Playful happiness and celebration",visual:{glowColor:"#FFEB3B",glowIntensity:1.6,particleRate:40,minParticles:0,maxParticles:40,particleBehavior:"popcorn",breathRate:1.5,breathDepth:.1,coreJitter:!1,particleColors:[{color:"#FFEB3B",weight:25},{color:"#FFC107",weight:20},{color:"#FFFF00",weight:15},{color:"#FFD700",weight:15},{color:"#FFF59D",weight:10},{color:"#FF9800",weight:10},{color:"#FFFDE7",weight:5}]},modifiers:{speed:1.8,amplitude:1.9,intensity:1.1,smoothness:1,regularity:.9,addBounce:!0},typicalGestures:["bounce","spin","wave","expand","shake","float"],transitions:{duration:400,easing:"easeOutBack",priority:5,burstOnEntry:!0},audio:{ambientSound:"cheerful_hum",transitionSound:"pop",gestureSound:"giggle"},particleSpawn:{pattern:"fountain",frequency:"burst",burstOnEntry:!0,fadeOnExit:!1,specialEffect:"sparkle"},coreAppearance:{pupilSize:1.2,irisPattern:"radiant",blinkRate:"frequent",lookDirection:"up",specialEffect:"twinkle"},rhythm:{enabled:!0,particleEmission:{syncMode:"beat",burstSize:8,offBeatRate:.6,popcornSync:!0},breathSync:{mode:"beats",beatsPerBreath:4,intensity:1.2},glowSync:{intensityRange:[1.2,1.8],syncTo:"beat",attack:.05,decay:.4},patternBehaviors:{waltz:{particleEmission:{burstSize:5},breathSync:{beatsPerBreath:3}},swing:{particleEmission:{syncMode:"swing",burstSize:6},glowSync:{curve:"bounce"}},dubstep:{particleEmission:{burstSize:15,dropMultiplier:3}},breakbeat:{particleEmission:{syncMode:"random",burstRange:[3,12]}}}},getCoreParams:t=>({scaleX:1,scaleY:1,eyeOpenness:1,eyeExpression:"happy",pupilOffset:{x:0,y:-.1},sparkle:!0})},{name:"sadness",emoji:"ðŸ˜¢",description:"Deep melancholic sorrow",visual:{glowColor:"#4169E1",glowIntensity:.65,particleRate:25,minParticles:0,maxParticles:25,particleBehavior:"falling",breathRate:.6,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#4169E1",weight:25},{color:"#1E90FF",weight:20},{color:"#6495ED",weight:15},{color:"#B0C4DE",weight:15},{color:"#191970",weight:10},{color:"#87CEEB",weight:10},{color:"#2F4F4F",weight:5}]},modifiers:{speed:.7,amplitude:.6,intensity:.8,smoothness:1.3,regularity:1.1,addGravity:!0},typicalGestures:["droop","sway","contract","drift","sink"],transitions:{duration:800,easing:"easeInOut",priority:3}},{name:"anger",emoji:"ðŸ˜ ",description:"Intense rage and aggression",visual:{glowColor:"#DC143C",glowIntensity:1.8,particleRate:20,minParticles:3,maxParticles:10,particleBehavior:"aggressive",breathRate:2.2,breathDepth:.15,coreJitter:!0,particleColors:[{color:"#DC143C",weight:25},{color:"#FF0000",weight:20},{color:"#B22222",weight:15},{color:"#FF4500",weight:15},{color:"#8B0000",weight:10},{color:"#FF6347",weight:10},{color:"#660000",weight:5}]},modifiers:{speed:1.5,amplitude:1.4,intensity:1.3,smoothness:.3,regularity:.7,addShake:!0},typicalGestures:["shake","vibrate","expand","pulse","flicker","strike"],transitions:{duration:300,easing:"easeOutExpo",priority:8,shakeOnEntry:!0},audio:{ambientSound:"rumble",transitionSound:"explosion",gestureSound:"growl"},particleSpawn:{pattern:"explosive",frequency:"chaotic",burstOnEntry:!0,fadeOnExit:!1,specialEffect:"flames"},coreAppearance:{pupilSize:.7,irisPattern:"sharp",blinkRate:"rare",lookDirection:"forward",specialEffect:"flames",pulseRate:"rapid"},special:{screenShake:!0,particleTrails:"fire",glowPulse:!0,temperatureEffect:"hot"}},{name:"fear",emoji:"ðŸ˜¨",description:"Anxious state with fleeing particles",visual:{glowColor:"#8A2BE2",glowIntensity:.9,particleRate:18,minParticles:4,maxParticles:16,particleBehavior:"scattering",breathRate:2.5,breathDepth:.06,coreJitter:!0,particleColors:[{color:"#8A2BE2",weight:25},{color:"#4B0082",weight:20},{color:"#9400D3",weight:15},{color:"#6B46C1",weight:15},{color:"#9932CC",weight:10},{color:"#E6E6FA",weight:8},{color:"#301934",weight:7}]},modifiers:{speed:1.4,amplitude:.8,intensity:1.2,smoothness:.5,regularity:.5,addJitter:!0},typicalGestures:["shake","vibrate","contract","flicker","retreat"],transitions:{duration:400,easing:"easeOut",priority:7}},{name:"surprise",emoji:"ðŸ˜²",description:"Sudden shock with explosive particles",visual:{glowColor:"#FFD700",glowIntensity:1.8,particleRate:30,minParticles:0,maxParticles:15,particleBehavior:"burst",breathRate:.3,breathDepth:.18,coreJitter:!1,particleColors:[{color:"#FFD700",weight:25},{color:"#FFA500",weight:20},{color:"#FFFF00",weight:15},{color:"#FF6347",weight:15},{color:"#FFE4B5",weight:10},{color:"#FF4500",weight:10},{color:"#FFFACD",weight:5}]},modifiers:{speed:1.6,amplitude:1.5,intensity:1.4,smoothness:.7,regularity:.8,addPop:!0},typicalGestures:["expand","bounce","flash","pulse","pop"],transitions:{duration:200,easing:"easeOutBack",priority:6}},{name:"disgust",emoji:"ðŸ¤¢",description:"Revulsion with repelling particles",visual:{glowColor:"#9ACD32",glowIntensity:1,particleRate:15,minParticles:5,maxParticles:12,particleBehavior:"repelling",breathRate:.7,breathDepth:.04,coreJitter:!1,particleColors:[{color:"#9ACD32",weight:25},{color:"#ADFF2F",weight:20},{color:"#7FFF00",weight:15},{color:"#BDB76B",weight:15},{color:"#6B8E23",weight:10},{color:"#CCFF00",weight:8},{color:"#556B2F",weight:7}]},modifiers:{speed:.9,amplitude:.7,intensity:.9,smoothness:.8,regularity:1,addRecoil:!0},typicalGestures:["contract","shake","recoil","wobble"],transitions:{duration:600,easing:"easeIn",priority:4}},{name:"love",emoji:"ðŸ’•",description:"Warm affection with orbiting particles",visual:{glowColor:"#FF1493",glowIntensity:1.8,particleRate:25,minParticles:10,maxParticles:18,particleBehavior:"orbiting",breathRate:.75,breathDepth:.15,coreJitter:!1,particleColors:[{color:"#FF1493",weight:30},{color:"#FF69B4",weight:25},{color:"#FF007F",weight:15},{color:"#FFB6C1",weight:10},{color:"#FF45A0",weight:10},{color:"#E91E63",weight:5},{color:"#FFC0CB",weight:5}]},modifiers:{speed:.9,amplitude:1.1,intensity:1.2,smoothness:1.4,regularity:1.2,addWarmth:!0},typicalGestures:["pulse","sway","orbit","glow","breathe","float"],transitions:{duration:700,easing:"easeInOut",priority:5},rhythm:{enabled:!0,particleEmission:{syncMode:"beat",burstSize:3,offBeatRate:.7},orbitalSync:{speedMultiplier:{onBeat:1.2,offBeat:.9,curve:"ease"},radiusSync:{enabled:!0,subdivision:"quarter",amount:.15}},glowSync:{intensityRange:[1.4,2],syncTo:"beat",attack:.1,decay:.6},breathSync:{mode:"bars",barsPerBreath:2,intensity:1},patternBehaviors:{waltz:{orbitalSync:{radiusSync:{subdivision:"bar",amount:.25}},particleEmission:{syncMode:"bar",burstSize:5}},swing:{orbitalSync:{speedMultiplier:{onBeat:1.5,curve:"bounce"}}}},intensityMapping:{low:{particleRate:.6,glowIntensity:.8},medium:{particleRate:1,glowIntensity:1},high:{particleRate:1.4,glowIntensity:1.3}}}},x,{name:"excited",emoji:"ðŸ¤©",description:"High energy with rapid particles",visual:{glowColor:"#FF6B35",glowIntensity:1.5,particleRate:25,minParticles:8,maxParticles:30,particleBehavior:"burst",breathRate:2,breathDepth:.14,coreJitter:!0,particleColors:[{color:"#FF6B35",weight:25},{color:"#FF1744",weight:20},{color:"#FFC107",weight:15},{color:"#FF9100",weight:15},{color:"#FFEB3B",weight:10},{color:"#FF5722",weight:10},{color:"#FFF59D",weight:5}]},modifiers:{speed:1.4,amplitude:1.3,intensity:1.3,smoothness:.8,regularity:.7,addVibration:!0},typicalGestures:["bounce","spin","vibrate","expand","shake","pulse"],transitions:{duration:300,easing:"easeOutElastic",priority:6},rhythm:{enabled:!0,particleEmission:{syncMode:"beat",burstSize:5,offBeatRate:.5},jitterSync:{subdivision:"sixteenth",intensity:.8,onBeat:1.5},glowSync:{intensityRange:[1,1.8],syncTo:"eighth",attack:.05,decay:.2},patternBehaviors:{dubstep:{particleEmission:{syncMode:"beat",burstSize:10,dropMultiplier:2}},breakbeat:{jitterSync:{subdivision:"random",intensity:1}}}}},{name:"resting",emoji:"ðŸ˜´",description:"Deep relaxation with slow drift",visual:{glowColor:"#9370DB",glowIntensity:.8,particleRate:10,minParticles:3,maxParticles:5,particleBehavior:"resting",breathRate:.8,breathDepth:.12,coreJitter:!1,particleColors:[{color:"#9370DB",weight:30},{color:"#A591C4",weight:20},{color:"#B366FF",weight:20},{color:"#B8A1E6",weight:15},{color:"#674D9B",weight:15}]},modifiers:{speed:.5,amplitude:.4,intensity:.5,smoothness:1.4,regularity:.9,addWeight:!0},typicalGestures:["breathe","drift","sway","float"],transitions:{duration:1e3,easing:"easeInOut",priority:2}},{name:"euphoria",emoji:"ðŸŒŸ",description:"Radiant hope and new beginnings",visual:{glowColor:"#FFB6C1",glowIntensity:2,particleRate:35,minParticles:15,maxParticles:30,particleBehavior:"radiant",breathRate:1.3,breathDepth:.25,coreJitter:!1,particleColors:[{color:"#FFB6C1",weight:20},{color:"#FFD700",weight:18},{color:"#87CEEB",weight:15},{color:"#DDA0DD",weight:15},{color:"#98FB98",weight:12},{color:"#FFA07A",weight:10},{color:"#E6E6FA",weight:8},{color:"#FFFFFF",weight:2}]},modifiers:{speed:1.4,amplitude:1.5,intensity:1.6,smoothness:1.3,regularity:.8,addWarmth:!0,addLift:!0},typicalGestures:["expand","radiate","pulse","glow","float","bloom"],transitions:{duration:600,easing:"easeOutExpo",priority:8}},{name:"focused",emoji:"ðŸŽ¯",description:"Intense concentration with directed flow",visual:{glowColor:"#00CED1",glowIntensity:1.2,particleRate:10,minParticles:5,maxParticles:12,particleBehavior:"directed",breathRate:1.2,breathDepth:.08,coreJitter:!0,particleColors:[{color:"#00CED1",weight:30},{color:"#4A9FA0",weight:20},{color:"#00FFFF",weight:20},{color:"#5FE5E7",weight:15},{color:"#006B6D",weight:15}],eyeOpenness:.7,microAdjustments:!0},modifiers:{speed:1,amplitude:.9,intensity:1.1,smoothness:1.1,regularity:1.2,addPrecision:!0},typicalGestures:["track","lock","scan","pulse","vibrate"],transitions:{duration:400,easing:"easeIn",priority:5},getCoreParams:t=>({scaleX:1.1,scaleY:.7,eyeOpenness:.7,eyeExpression:"focused",pupilOffset:{x:0,y:0},microAdjustments:!0})},{name:"glitch",emoji:"ðŸŒˆ",description:"Surprised sadness with rainbow colors and glitch wiggle",visual:{primaryColor:"#FF6B9D",glowColor:"#4169E1",glowIntensity:1.2,particleRate:20,minParticles:5,maxParticles:15,particleBehavior:"burst",particleSpeed:1,breathRate:.4,breathDepth:.15,coreJitter:!1,coreSize:1,eyeOpenness:.8,particleColors:[{color:"#FF0080",weight:18},{color:"#00FF80",weight:18},{color:"#8000FF",weight:18},{color:"#FF8000",weight:15},{color:"#0080FF",weight:15},{color:"#FFFF00",weight:10},{color:"#FF6B9D",weight:6}],particleGlitchWiggle:!0,glitchWiggleIntensity:.3,glitchWiggleFrequency:.1},modifiers:{speed:1.1,amplitude:1,intensity:1.1,smoothness:.8,regularity:.7,focus:.6},typicalGestures:["bounce","sway","pulse","drift","flash"],transitions:{duration:300,easing:"easeInOut",priority:5}},B].forEach(t=>{t&&t.name&&P.set(t.name,t)});const E=new class{constructor(){this.emotionCache=new Map,this.visualParamsCache=new Map,this.modifiersCache=new Map,this.transitionCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const t=R();t.forEach(t=>{this.cacheEmotion(t)}),this.cacheCommonTransitions(t),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.emotionCache.size}catch(t){this.isInitialized=!1}}cacheEmotion(t){try{const i=A(t);i&&this.emotionCache.set(t,i);const e=T(t);this.visualParamsCache.set(t,e);const s=O(t);this.modifiersCache.set(t,s)}catch(t){}}cacheCommonTransitions(t){[["neutral","joy"],["neutral","sadness"],["neutral","anger"],["joy","sadness"],["sadness","joy"],["anger","calm"],["calm","anger"]].forEach(([i,e])=>{if(t.includes(i)&&t.includes(e))try{const t=z(i,e),s=`${i}->${e}`;this.transitionCache.set(s,t)}catch(t){}})}getEmotion(t){if(!this.isInitialized)return A(t);const i=this.emotionCache.get(t);return i?(this.stats.hits++,i):(this.stats.misses++,A(t))}getVisualParams(t){if(!this.isInitialized)return T(t);const i=this.visualParamsCache.get(t);return i?(this.stats.hits++,i):(this.stats.misses++,T(t))}getModifiers(t){if(!this.isInitialized)return O(t);const i=this.modifiersCache.get(t);return i?(this.stats.hits++,i):(this.stats.misses++,O(t))}getTransitionParams(t,i){if(!this.isInitialized)return z(t,i);const e=`${t}->${i}`,s=this.transitionCache.get(e);return s?(this.stats.hits++,s):(this.stats.misses++,z(t,i))}hasEmotion(t){return this.emotionCache.has(t)}getStats(){const t=this.stats.hits+this.stats.misses,i=t>0?(this.stats.hits/t*100).toFixed(2):0;return{isInitialized:this.isInitialized,loadTime:this.stats.loadTime,cacheSize:this.stats.cacheSize,hits:this.stats.hits,misses:this.stats.misses,hitRate:`${i}%`,emotions:this.emotionCache.size,visualParams:this.visualParamsCache.size,modifiers:this.modifiersCache.size,transitions:this.transitionCache.size}}clear(){this.emotionCache.clear(),this.visualParamsCache.clear(),this.modifiersCache.clear(),this.transitionCache.clear(),this.isInitialized=!1,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0}}reinitialize(){this.clear(),this.initialize()}};class q{constructor(t){this.errorBoundary=t,this.state={emotion:"neutral",undertone:null,gesture:null,speaking:!1,audioLevel:0},this.transitions={emotional:{current:"neutral",target:null,progress:0,duration:500,startTime:0,isActive:!1},undertone:{current:null,target:null,progress:0,duration:300,startTime:0,isActive:!1,currentWeight:0,targetWeight:0}},this.interpolationCache={lastUpdate:0,cacheInterval:100,cachedProperties:null,cachedRenderState:null},this.initializeEmotionalStates(),this.initializeUndertoneModifiers()}initializeEmotionalStates(){this.emotionalStates=this.loadEmotionalStatesFromCache()}loadEmotionalStatesFromCache(){const t={};return["neutral","joy","sadness","anger","fear","surprise","disgust","love","suspicion","excited","resting","euphoria","focused","glitch","calm"].forEach(i=>{const e=E.getVisualParams(i);e&&(t[i]={primaryColor:e.primaryColor||"#B0B0B0",glowIntensity:e.glowIntensity||.7,particleRate:e.particleRate||1,minParticles:e.minParticles||3,maxParticles:e.maxParticles||4,particleBehavior:e.particleBehavior||"ambient",coreSize:e.coreSize||1,breathRate:e.breathRate||1,breathDepth:e.breathDepth||.1})}),t}initializeUndertoneModifiers(){this.undertoneModifiers={nervous:{jitterAmount:.3,breathRateMultiplier:1.2,glowIntensityMultiplier:.9,particleRateMultiplier:1.1},confident:{coreSizeMultiplier:1.1,glowIntensityMultiplier:1.2,breathRateMultiplier:.9,particleRateMultiplier:1},tired:{breathRateMultiplier:.7,particleRateMultiplier:.5,glowIntensityMultiplier:.8,coreSizeMultiplier:.95},intense:{amplificationFactor:1.3},subdued:{dampeningFactor:.7}}}setEmotion(t,i=null,e=500){return this.errorBoundary.wrap(()=>{if(this.interpolationCache.cachedProperties=null,this.interpolationCache.cachedRenderState=null,!function(t){const i=C[t]||t;return P.has(i)||null!==F(i)}(t)&&!{}.hasOwnProperty.call(this.emotionalStates,t)){const i=[...Object.keys(this.emotionalStates),...R()],e=[...new Set(i)];throw new Error(`Invalid emotion: ${t}. Valid emotions: ${e.join(", ")}`)}if(null!==i&&!{}.hasOwnProperty.call(this.undertoneModifiers,i))throw new Error(`Invalid undertone: ${i}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.emotion===t&&this.state.undertone===i||(this.state.emotion!==t&&(e>0?(this.transitions.emotional={current:this.state.emotion,target:t,progress:0,duration:Math.max(100,e),startTime:performance.now(),isActive:!0},void 0!==this.t&&(this.t=0)):this.transitions.emotional={current:t,target:null,progress:1,duration:0,startTime:performance.now(),isActive:!1},this.state.emotion=t),this.state.undertone!==i&&(this.transitions.undertone={current:this.state.undertone,target:i,progress:0,duration:300,startTime:performance.now(),isActive:!0,currentWeight:this.state.undertone?1:0,targetWeight:i?1:0},this.state.undertone=i)),!0},"emotion-setting",!1)()}applyUndertone(t,i){if(!i||!{}.hasOwnProperty.call(this.undertoneModifiers,i))return{...t};const e=this.undertoneModifiers[i],s={...t};if(void 0!==e.glowIntensityMultiplier&&(s.glowIntensity*=e.glowIntensityMultiplier),void 0!==e.breathRateMultiplier&&(s.breathRate*=e.breathRateMultiplier),void 0!==e.particleRateMultiplier&&(s.particleRate=Math.round(s.particleRate*e.particleRateMultiplier)),void 0!==e.coreSizeMultiplier&&(s.coreSize*=e.coreSizeMultiplier),void 0!==e.amplificationFactor){const t=e.amplificationFactor;s.glowIntensity*=t,s.breathRate*=t,s.particleRate=Math.round(s.particleRate*t),s.coreSize*=t}if(void 0!==e.dampeningFactor){const t=e.dampeningFactor;s.glowIntensity*=t,s.breathRate*=t,s.particleRate=Math.round(s.particleRate*t),s.coreSize*=t}return void 0!==e.jitterAmount&&(s.jitterAmount=e.jitterAmount),s}update(t){this.errorBoundary.wrap(()=>{this.transitions.emotional.isActive&&this.updateEmotionalTransition(t),this.transitions.undertone.isActive&&this.updateUndertoneTransition(t)},"state-machine-update")()}updateUndertoneTransition(t){const i=this.transitions.undertone,e=performance.now()-i.startTime,s=Math.min(e/i.duration,1),n=f(s);i.current&&i.target?(i.currentWeight=1-n,i.targetWeight=n):i.current&&!i.target?(i.currentWeight=1-n,i.targetWeight=0):!i.current&&i.target&&(i.currentWeight=0,i.targetWeight=n),i.progress=s,s>=1&&(i.isActive=!1,i.current=i.target,i.currentWeight=i.target?1:0,i.targetWeight=0)}updateEmotionalTransition(t){const i=this.transitions.emotional;let e;void 0!==this.t?(this.t+=t,e=this.t):e=performance.now()-i.startTime,i.progress=Math.min(1,e/i.duration),i.progress>=1&&(i.isActive=!1,i.current=i.target,i.target=null,i.progress=1)}getCurrentEmotionalProperties(){return this.errorBoundary.wrap(()=>{const t=performance.now();if(this.interpolationCache.cachedProperties&&t-this.interpolationCache.lastUpdate<this.interpolationCache.cacheInterval)return this.interpolationCache.cachedProperties;const i=this.transitions.emotional;let e;return e=i.isActive&&i.target?this.interpolateEmotionalProperties(i.current,i.target,i.progress):{...this.emotionalStates[this.state.emotion]||this.emotionalStates.neutral},e=this.applyUndertone(e,this.state.undertone),this.interpolationCache.cachedProperties=e,this.interpolationCache.lastUpdate=t,e},"emotional-properties",()=>this.emotionalStates.neutral)()}interpolateEmotionalProperties(t,i,e){const s=this.emotionalStates[t]||this.emotionalStates.neutral,n=this.emotionalStates[i]||this.emotionalStates.neutral,h=v(e,0,1,"easeOutCubic");return{primaryColor:a(s.primaryColor,n.primaryColor,h),glowIntensity:s.glowIntensity+(n.glowIntensity-s.glowIntensity)*h,particleRate:Math.round(s.particleRate+(n.particleRate-s.particleRate)*h),coreSize:s.coreSize+(n.coreSize-s.coreSize)*h,breathRate:s.breathRate+(n.breathRate-s.breathRate)*h,breathDepth:s.breathDepth+(n.breathDepth-s.breathDepth)*h,particleBehavior:h>.5?n.particleBehavior:s.particleBehavior}}getCurrentState(){return{emotion:this.state.emotion,undertone:this.state.undertone,isTransitioning:this.transitions.emotional.isActive,transitionProgress:this.transitions.emotional.progress,properties:this.getCurrentEmotionalProperties()}}applyUndertoneModifier(t){return this.errorBoundary.wrap(()=>{if(null!==t&&!{}.hasOwnProperty.call(this.undertoneModifiers,t))throw new Error(`Invalid undertone: ${t}. Valid undertones: ${Object.keys(this.undertoneModifiers).join(", ")}`);return this.state.undertone=t,!0},"undertone-application",!1)()}clearUndertone(){this.state.undertone=null}getUndertoneModifier(t){return this.errorBoundary.wrap(()=>{if(this.renderer&&this.renderer.undertoneModifiers&&this.renderer.undertoneModifiers[t])return{...this.renderer.undertoneModifiers[t]};if(!t||!{}.hasOwnProperty.call(this.undertoneModifiers,t))return null;const i={...this.undertoneModifiers[t]};return i.glowRadiusMult||(i.glowRadiusMult=1),i},"undertone-retrieval",null)()}getWeightedUndertoneModifiers(){const t=this.transitions.undertone;if(!t.isActive){if(this.state.undertone){const t=this.getUndertoneModifier(this.state.undertone);if(t)return{...t,weight:1,type:this.state.undertone}}return null}if(t.target){const i=this.getUndertoneModifier(t.target);if(i)return{...i,weight:t.targetWeight,type:t.target}}if(t.current&&t.currentWeight>0){const i=this.getUndertoneModifier(t.current);if(i)return{...i,weight:t.currentWeight,type:t.current}}return null}reset(t=500){this.setEmotion("neutral",null,t)}isValidEmotion(t){return{}.hasOwnProperty.call(this.emotionalStates,t)}isValidUndertone(t){return null===t||{}.hasOwnProperty.call(this.undertoneModifiers,t)}getAvailableEmotions(){return Object.keys(this.emotionalStates)}getAvailableUndertones(){return Object.keys(this.undertoneModifiers)}isTransitioning(){return this.transitions.emotional.isActive}getTransitionProgress(){return this.transitions.emotional.isActive?this.transitions.emotional.progress:1}completeTransition(){this.transitions.emotional.isActive&&(this.transitions.emotional.progress=1,this.transitions.emotional.isActive=!1,this.transitions.emotional.current=this.transitions.emotional.target,this.transitions.emotional.target=null)}interpolateProperty(t,i,e,s="easeOutCubic"){return t+(i-t)*v(e,0,1,s)}enableSimulatedTime(t=!0){t?this.t=0:delete this.t}}function D(t){if(!t||0===t.length)return"#FFFFFF";let i=0,e=0;const s=[];for(const n of t)"string"==typeof n?(s.push({color:n,weight:null}),e++):n&&"object"==typeof n&&n.color&&(s.push({color:n.color,weight:n.weight||null}),n.weight?i+=n.weight:e++);const n=Math.max(0,100-i),h=e>0?n/e:0,a=[];let r=0;for(const t of s)r+=null!==t.weight?t.weight:h,a.push({color:t.color,threshold:r});const o=Math.random()*r;for(const t of a)if(o<=t.threshold)return t.color;return s[s.length-1].color}var I={name:"ambient",emoji:"â˜ï¸",description:"Gentle upward drift like smoke",initialize:function(t){t.vx=0,t.vy=-.04-.02*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={upwardSpeed:5e-4,waviness:0,friction:.998}},update:function(t,i,e,s){const n=t.behaviorData;t.vy*=Math.pow(n.friction,i),t.vy-=n.upwardSpeed*i,t.vx=0}};const j=2*Math.PI;var $={name:"orbiting",emoji:"ðŸ’•",description:"Romantic firefly dance around the orb",initialize:function(t){t.lifeDecay=.001+.002*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.isSparkle="#FFE4E1"===t.color||"#FFCCCB"===t.color||"#FFC0CB"===t.color;const i=40*(t.scaleFactor||1)*(1.3+.9*Math.random());t.blinkPhase=Math.random()*j,t.blinkSpeed=.3+1.2*Math.random(),t.blinkIntensity=.6+.4*Math.random(),t.fadePhase=Math.random()*j,t.fadeSpeed=.1+.3*Math.random(),t.minOpacity=.2+.2*Math.random(),t.maxOpacity=.8+.2*Math.random(),t.isSparkle&&(t.blinkSpeed*=2,t.blinkIntensity=1,t.minOpacity=0,t.maxOpacity=1),t.behaviorData={angle:Math.random()*j,radius:i,baseRadius:i,angularVelocity:8e-4+.0017*Math.random(),swayAmount:3+7*Math.random(),swaySpeed:.2+.5*Math.random(),floatOffset:Math.random()*j,floatSpeed:.3+.7*Math.random(),floatAmount:2+6*Math.random(),twinklePhase:Math.random()*j,twinkleSpeed:2+3*Math.random()}},update:function(t,i,e,s){const n=t.behaviorData;n.angle+=n.angularVelocity*i;const h=Math.sin(n.angle*n.swaySpeed)*n.swayAmount,a=6*Math.sin(1.5*n.angle),r=(n.radius||n.baseRadius)+a+.2*h,o=e+Math.cos(n.angle)*r,c=s+Math.sin(n.angle)*r;n.floatOffset+=n.floatSpeed*i*.001;const l=Math.sin(n.floatOffset)*n.floatAmount;t.vx=.1*(o-t.x),t.vy=.1*(c+l-t.y),t.fadePhase+=t.fadeSpeed*i*.001;const u=.5*Math.sin(t.fadePhase)+.5,p=t.minOpacity+(t.maxOpacity-t.minOpacity)*u;let d;t.blinkPhase+=t.blinkSpeed*i*.002,t.isSparkle?(n.twinklePhase+=n.twinkleSpeed*i*.001,d=.7*Math.pow(Math.sin(n.twinklePhase),16)+.2*Math.sin(5*t.blinkPhase)+.1):d=.4*Math.sin(t.blinkPhase)+.3*Math.sin(3*t.blinkPhase)+.2*Math.sin(7*t.blinkPhase)+.1*Math.sin(11*t.blinkPhase);const m=.5*(d+1),f=.2+m*t.blinkIntensity*.8;t.opacity=t.baseOpacity*p*f,t.isSparkle?t.size=t.baseSize*(.5+1*m):t.size=t.baseSize*(.8+.3*m),t.isSparkle&&(t.tempColor=m>.85?"#FFFFFF":t.color)}},G={name:"rising",emoji:"ðŸŽˆ",description:"Buoyant upward movement like balloons",initialize:function(t){t.vx=.02*(Math.random()-.5),t.vy=-.05-.03*Math.random(),t.lifeDecay=.002,t.baseOpacity=.7+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={buoyancy:.001,driftAmount:.005}},update:function(t,i,e,s){const n=t.behaviorData;t.vy-=n.buoyancy*i,t.vx+=(Math.random()-.5)*n.driftAmount*i,t.vx*=Math.pow(.995,i),t.vy*=Math.pow(.998,i)}},L={name:"falling",emoji:"ðŸ’§",description:"Heavy downward drift like tears",initialize:function(t){t.vx=.03*(Math.random()-.5),t.vy=.05+.05*Math.random(),t.lifeDecay=.002,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={gravity:.002,drag:.995}},update:function(t,i,e,s){const n=t.behaviorData;t.vy+=n.gravity*i,t.vx*=Math.pow(n.drag,i),t.vy*=Math.pow(n.drag,i),t.vy>2&&(t.vy=2)}};const V=2e3,H=3,_=8,X=.7;var Y={name:"popcorn",emoji:"ðŸ¿",description:"Spontaneous popping with gravity and bounces",initialize:function(t){if(t.vx=.1*(Math.random()-.5),t.vy=.1*(Math.random()-.5),t.lifeDecay=.008+.012*Math.random(),t.emotionColors&&t.emotionColors.length>0)t.color=D(t.emotionColors);else{const i=["#FFFFFF","#FFFACD","#FFF8DC","#FFFFE0","#FAFAD2"];t.color=D(i)}t.size=Math.random()<.3?(8+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier:(2+4*Math.random())*t.scaleFactor*t.particleSizeMultiplier,t.baseSize=t.size,t.hasGlow=Math.random()<.2,t.glowSizeMultiplier=t.hasGlow?1.2:0,t.behaviorData={popDelay:Math.random()*V,hasPopped:!1,popStrength:H+Math.random()*(_-H),gravity:.098,bounceDamping:X,bounceCount:0,maxBounces:2+Math.floor(2*Math.random()),spinRate:10*(Math.random()-.5),lifetime:0}},update:function(t,i,e,s){const n=t.behaviorData;if(n.lifetime+=16.67*i,!n.hasPopped&&n.lifetime>n.popDelay){n.hasPopped=!0;const i=Math.random()*Math.PI*2;t.vx=Math.cos(i)*n.popStrength*1.5,t.vy=Math.sin(i)*n.popStrength-.3,t.size=1.25*t.baseSize}if(n.hasPopped){t.vy+=n.gravity*i;const e=s+100*t.scaleFactor;t.y>e&&n.bounceCount<n.maxBounces&&(t.y=e,t.vy=-Math.abs(t.vy)*n.bounceDamping,t.vx*=.9,n.bounceCount++,t.size=t.baseSize*(1.5-.1*n.bounceCount)),n.bounceCount>=n.maxBounces&&(t.lifeDecay=.03+.02*Math.random(),t.size*=.95),Math.sqrt(t.vx*t.vx+t.vy*t.vy)<.5&&(t.lifeDecay*=1.5)}}},U={name:"burst",emoji:"ðŸ’¥",description:"Explosive expansion from center",initialize:function(t){const i="suspicion"===t.emotion,e="surprise"===t.emotion,s="glitch"===t.emotion,n=Math.random()*j,h=i?1+.8*Math.random():e?7+5*Math.random():s?2+1.5*Math.random():3.5+2.5*Math.random();t.vx=Math.cos(n)*h,t.vy=Math.sin(n)*h,t.lifeDecay=i?.01:e?.006+.008*Math.random():s?.012:.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),i&&(t.size=(6+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.opacity=1,t.baseOpacity=t.opacity),t.behaviorData={isSuspicion:i,isSurprise:e,isGlitch:s,age:0,fadeStart:i?.3:.2,glitchPhase:Math.random()*Math.PI*2,glitchIntensity:s?.3:0,glitchFrequency:s?.1:0}},update:function(t,i,e,s){const n=t.behaviorData;if(n.isSurprise)if(n.age+=.016*i,n.age<.15){const e=.98;t.vx*=Math.pow(e,i),t.vy*=Math.pow(e,i)}else if(n.age<.25){const e=.85;t.vx*=Math.pow(e,i),t.vy*=Math.pow(e,i)}else{const e=.99;t.vx*=Math.pow(e,i),t.vy*=Math.pow(e,i),t.vx+=.01*(Math.random()-.5)*i,t.vy+=.01*(Math.random()-.5)*i}else{const e=n.isSuspicion?.99:n.isGlitch?.97:.95;t.vx*=Math.pow(e,i),t.vy*=Math.pow(e,i)}if(n.isSuspicion){const e=.001*Date.now();t.vx+=.01*Math.sin(2*e+t.id)*i}if(n.isGlitch){n.age+=.016*i,n.glitchPhase+=n.glitchFrequency*i;const e=Math.sin(n.glitchPhase)*n.glitchIntensity*i,s=Math.cos(1.3*n.glitchPhase)*n.glitchIntensity*i;if(t.vx+=e,t.vy+=s,Math.random()<.02){const i=Math.random()*Math.PI*2,e=.5+.5*Math.random();t.vx+=Math.cos(i)*e,t.vy+=Math.sin(i)*e}}}},W={name:"aggressive",emoji:"âš¡",description:"Sharp, chaotic movement with violent bursts",initialize:function(t){const i=Math.random()*j,e=1.5+2*Math.random();t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,t.lifeDecay=.015,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={acceleration:.05,jitter:.3,speedDecay:.95}},update:function(t,i,e,s){const n=t.behaviorData;if(t.vx+=(Math.random()-.5)*n.jitter*i,t.vy+=(Math.random()-.5)*n.jitter*i,t.vx*=Math.pow(n.speedDecay,i),t.vy*=Math.pow(n.speedDecay,i),Math.random()<Math.min(.05*i,.5)){const i=Math.random()*j;t.vx+=Math.cos(i)*n.acceleration,t.vy+=Math.sin(i)*n.acceleration}}},N={name:"scattering",emoji:"ðŸ˜¨",description:"Particles flee from center in panic",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.008,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={fleeSpeed:2,panicFactor:1.2,initialized:!1}},update:function(t,i,e,s){const n=t.behaviorData;if(!n.initialized){const i=t.x-e,h=t.y-s,a=Math.sqrt(i*i+h*h);if(a>0)t.vx=i/a*n.fleeSpeed,t.vy=h/a*n.fleeSpeed;else{const i=Math.random()*j;t.vx=Math.cos(i)*n.fleeSpeed,t.vy=Math.sin(i)*n.fleeSpeed}n.initialized=!0}const h=t.x-e,a=t.y-s,r=Math.sqrt(h*h+a*a);r>0&&(t.vx+=h/r*n.panicFactor*.01*i,t.vy+=a/r*n.panicFactor*.01*i),t.vx+=.1*(Math.random()-.5)*i,t.vy+=.1*(Math.random()-.5)*i,t.vx*=Math.pow(.98,i),t.vy*=Math.pow(.98,i)}},Q={name:"repelling",emoji:"ðŸš«",description:"Particles pushed away from center, maintaining distance",initialize:function(t){t.vx=0,t.vy=0,t.lifeDecay=.01,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={repelStrength:.8,minDistance:50,initialized:!1}},update:function(t,i,e,s){const n=t.behaviorData,h=t.x-e,a=t.y-s,r=Math.sqrt(h*h+a*a);if(!n.initialized||r<n.minDistance){if(r>0){const e=n.repelStrength/Math.max(r,5);t.vx+=h/r*e*i,t.vy+=a/r*e*i}n.initialized=!0}t.vx*=Math.pow(.99,i),t.vy*=Math.pow(.99,i)}},J={name:"connecting",emoji:"ðŸ”—",description:"Chaotic movement with center attraction for social states",initialize:function(t){const i=Math.random()*j,e=2+5*Math.random();t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,t.lifeDecay=.012,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={attractionForce:.008,chaosFactor:1,friction:.95}},update:function(t,i,e,s){const n=t.behaviorData;t.vx*=Math.pow(n.friction,i),t.vy*=Math.pow(n.friction,i);const h=(e-t.x)*n.attractionForce,a=(s-t.y)*n.attractionForce,r=(Math.random()-.5)*n.chaosFactor,o=(Math.random()-.5)*n.chaosFactor;t.vx+=h+r,t.vy+=a+o}},Z={name:"resting",emoji:"ðŸ˜´",description:"Ultra-slow vertical drift for deep rest states",initialize:function(t){t.vx=0,t.vy=-.01,t.lifeDecay=.001,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={upwardSpeed:2e-5,friction:.999}},update:function(t,i,e,s){const n=t.behaviorData;t.vy*=Math.pow(n.friction,i),t.vy-=n.upwardSpeed*i,t.vx=0}},K={name:"radiant",emoji:"â˜€ï¸",description:"Particles radiate outward like sunbeams",initialize:function(t){const i=Math.random()*j,e=.8+.4*Math.random();if(t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,t.lifeDecay=.006,t.emotionColors&&t.emotionColors.length>0)t.color=D(t.emotionColors);else{const i=["#FFD700","#FFB347","#FFA500","#FF69B4"];t.color=D(i)}t.hasGlow=Math.random()<.7,t.glowSizeMultiplier=t.hasGlow?1.5+.5*Math.random():0,t.behaviorData={radialSpeed:.02,shimmer:Math.random()*j,shimmerSpeed:.1,friction:.99}},update:function(t,i,e,s){const n=t.behaviorData,h=t.x-e,a=t.y-s,r=Math.sqrt(h*h+a*a);if(r>0){const e=h/r,s=a/r;t.vx+=e*n.radialSpeed*i,t.vy+=s*n.radialSpeed*i}n.shimmer+=n.shimmerSpeed*i;const o=Math.sin(n.shimmer);t.size=t.baseSize*(1+.2*o),t.opacity=t.baseOpacity*(1+.3*o),t.vx*=Math.pow(n.friction,i),t.vy*=Math.pow(n.friction,i)}};function tt(t){t.vx=.02*(Math.random()-.5),t.vy=-.03-.02*Math.random(),t.lifeDecay=8e-4,t.size=(6+6*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1)*1.33,t.baseSize=t.size,t.baseOpacity=.2+.2*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={ascensionSpeed:3e-4,waveFactor:.5,waveFrequency:.001,friction:.998,fadeStartDistance:100}}var it={name:"ascending",emoji:"ðŸ§˜",description:"Slow steady upward float like incense smoke",initialize:tt,update:function(t,i,e,s){const n=t.behaviorData;if(!n)return void tt(t);t.vx*=Math.pow(n.friction,i),t.vy*=Math.pow(n.friction,i),t.vy-=n.ascensionSpeed*i;const h=Math.sin(t.age*n.waveFrequency*1e3)*n.waveFactor;t.vx+=.001*h*i,void 0===t.initialY&&(t.initialY=t.y);const a=t.initialY-t.y;if(a>n.fadeStartDistance){const i=(a-n.fadeStartDistance)/100,e=Math.max(0,1-i);t.baseOpacity*=.995,e<.5&&(t.lifeDecay*=1.02)}Math.abs(t.vx)>.05&&(t.vx*=Math.pow(.95,i)),t.vy<-.1&&(t.vy=-.1)}},et={name:"erratic",emoji:"ðŸ˜°",description:"Nervous jittery movement for anxious states",initialize:function(t){const i=Math.random()*j,e=.1+.15*Math.random();t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,t.lifeDecay=.004,t.size=(2+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.4+.3*Math.random(),t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={jitterStrength:.02,directionChangeRate:.1,speedVariation:.3,spinRate:.05+.1*Math.random()}},update:function(t,i){const e=t.behaviorData;if(t.vx+=(Math.random()-.5)*e.jitterStrength*i,t.vy+=(Math.random()-.5)*e.jitterStrength*i,Math.random()<Math.min(e.directionChangeRate*i,.5)){const i=Math.random()*j,e=Math.sqrt(t.vx*t.vx+t.vy*t.vy);t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e}const s=1+(Math.random()-.5)*e.speedVariation*i;t.vx*=s,t.vy*=s;const n=t.age*e.spinRate*1e3;t.size=t.baseSize*(1+.2*Math.sin(n)),t.opacity=t.baseOpacity*(.8+.4*Math.random()),t.vx*=Math.pow(.98,i),t.vy*=Math.pow(.98,i);const h=Math.sqrt(t.vx*t.vx+t.vy*t.vy);h>.5&&(t.vx=t.vx/h*.5,t.vy=t.vy/h*.5)}},st={name:"cautious",emoji:"ðŸ¤¨",description:"Slow careful movement with watchful pauses",initialize:function(t){const i=Math.random()*j,e=.02+.03*Math.random();t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,t.lifeDecay=.001,t.life=1,t.size=(4+4*Math.random())*(t.scaleFactor||1)*(t.particleSizeMultiplier||1),t.baseSize=t.size,t.baseOpacity=.8+.2*Math.random(),t.opacity=t.baseOpacity,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={pauseTimer:2*Math.random(),pauseDuration:.5+.5*Math.random(),moveDuration:1+.5*Math.random(),isMoving:Math.random()>.5,moveTimer:0,originalVx:t.vx,originalVy:t.vy,watchRadius:50+30*Math.random()}},update:function(t,i,e,s){const n=t.behaviorData;if(n.moveTimer+=i,n.isMoving)n.moveTimer>n.moveDuration?(n.isMoving=!1,n.moveTimer=0,t.vx=0,t.vy=0):(t.vx=n.originalVx,t.vy=n.originalVy);else if(n.moveTimer>n.pauseDuration){n.isMoving=!0,n.moveTimer=0;const i=Math.random()*j,e=.02+.03*Math.random();t.vx=Math.cos(i)*e,t.vy=Math.sin(i)*e,n.originalVx=t.vx,n.originalVy=t.vy}const h=t.x-e,a=t.y-s,r=Math.sqrt(h*h+a*a);if(r>n.watchRadius){const e=.02;t.vx-=h/r*e*i,t.vy-=a/r*e*i}t.vx*=Math.pow(.995,i),t.vy*=Math.pow(.995,i),n.isMoving?t.opacity=t.baseOpacity:t.opacity=t.baseOpacity*(.9+.1*Math.sin(5*t.age))}},nt={name:"surveillance",emoji:"ðŸ‘ï¸",description:"Searchlight scanning with paranoid watchfulness",initialize(t,i){t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorState={scanAngle:Math.random()*Math.PI-Math.PI/2,scanDirection:Math.random()<.5?1:-1,scanSpeed:.3+.2*Math.random(),scanRange:Math.PI/3+Math.random()*Math.PI/4,scanCenter:Math.random()*Math.PI*2,pauseTimer:0,pauseDuration:500+500*Math.random(),mode:"scanning",modeTimer:0,nextModeChange:2e3+3e3*Math.random(),dartTarget:{x:0,y:0},dartSpeed:0,patrolRadius:150+100*Math.random(),patrolAngle:Math.random()*Math.PI*2,alertLevel:0,lastPosition:{x:t.x,y:t.y}};const e=Math.random();e<.7?t.behaviorState.primaryRole="scanner":e<.9?(t.behaviorState.primaryRole="patroller",t.behaviorState.mode="patrolling"):(t.behaviorState.primaryRole="watcher",t.behaviorState.mode="frozen")},update(t,i,e){const s=t.behaviorState;if(s){switch(s.modeTimer+=16*i,s.modeTimer>s.nextModeChange&&(this.changeMode(t,s),s.modeTimer=0,s.nextModeChange=2e3+4e3*Math.random()),s.mode){case"scanning":this.updateScanning(t,i,s,e);break;case"darting":this.updateDarting(t,i,s,e);break;case"frozen":this.updateFrozen(t,i,s,e);break;case"patrolling":this.updatePatrolling(t,i,s,e)}t.vy+=.05*i,t.x+=t.vx*i,t.y+=t.vy*i,s.lastPosition.x=t.x,s.lastPosition.y=t.y}},updateScanning(t,i,e,s){e.pauseTimer>0?(e.pauseTimer-=16*i,t.vx*=.9,t.vy*=.9):(e.scanAngle+=e.scanDirection*e.scanSpeed*i*.02,Math.abs(e.scanAngle)>e.scanRange/2&&(e.scanDirection*=-1,e.pauseTimer=e.pauseDuration,e.scanAngle=Math.sign(e.scanAngle)*e.scanRange/2));const n=e.scanCenter+e.scanAngle,h=.8+.5*e.alertLevel;t.vx=Math.cos(n)*h,t.vy=Math.sin(n)*h*.3},updateDarting(t,i,e,s){const n=e.dartTarget.x-t.x,h=e.dartTarget.y-t.y,a=Math.sqrt(n*n+h*h);a>5?(t.vx=n/a*e.dartSpeed,t.vy=h/a*e.dartSpeed):(e.mode="scanning",e.modeTimer=0)},updateFrozen(t,i,e,s){t.vx*=.95,t.vy*=.95,Math.random()<.01&&(t.vx+=.5*(Math.random()-.5),t.vy+=.5*(Math.random()-.5))},updatePatrolling(t,i,e,s){e.patrolAngle+=.01*i;const n=Math.cos(e.patrolAngle)*e.patrolRadius,h=Math.sin(e.patrolAngle)*e.patrolRadius,a=n-t.x,r=h-t.y;t.vx=.02*a,t.vy=.02*r},changeMode(t,i){const e=Math.random();"scanner"===i.primaryRole?e<.1?(i.mode="darting",i.dartTarget={x:200*(Math.random()-.5),y:200*(Math.random()-.5)},i.dartSpeed=3+2*Math.random()):i.mode=e<.2?"frozen":"scanning":"patroller"===i.primaryRole?i.mode=e<.1?"frozen":"patrolling":i.mode=e<.3?"scanning":"frozen"}},ht={name:"glitchy",emoji:"âš¡",description:"Digital glitch with stuttering orbits and corruption",rhythm:{enabled:!0,glitchTiming:{mode:"subdivision",subdivision:"sixteenth",probability:.3,intensityOnBeat:2,intensityOffBeat:.5},stutterSync:{mode:"pattern",patterns:{dubstep:{freezeOnDrop:!0,dropDuration:100},breakbeat:{randomFreeze:.1,duration:50}}},orbitRhythm:{baseSpeed:"tempo",wobbleSync:"eighth",beatAcceleration:1.5,barReset:!0},rgbSync:{enabled:!0,amount:"intensity",direction:"beat",maxSplit:10},noiseRhythm:{trigger:"accent",duration:50,intensity:"drop"}},initialize(t,i,e,s){t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorState={orbitAngle:Math.random()*Math.PI*2,orbitRadius:300+400*Math.random(),orbitSpeed:.01+.02*Math.random(),glitchTimer:0,nextGlitch:500*Math.random()+100,isGlitching:!1,glitchDuration:0,glitchOffset:{x:0,y:0},stutterTimer:0,nextStutter:200*Math.random()+50,isFrozen:!1,frozenPosition:{x:0,y:0},frozenVelocity:{x:0,y:0},hasGhost:Math.random()<.3,ghostOffset:20*Math.random()+10,ghostAngle:Math.random()*Math.PI*2,rgbSplit:Math.random()<.4,rgbPhase:Math.random()*Math.PI*2,noiseLevel:0,noiseBurst:!1,beatPhase:Math.random()*Math.PI*2,beatFrequency:.05+.03*Math.random(),dropIntensity:0},t.lifeDecay=.0015,t.hasGlow=!0,t.glowSizeMultiplier=3+2*Math.random()},update(t,i,e,s){const n=t.behaviorState;if(!n)return;n.glitchTimer+=16*i,n.stutterTimer+=16*i,n.stutterTimer>n.nextStutter&&(n.isFrozen?(n.isFrozen=!1,n.stutterTimer=0,n.nextStutter=100+300*Math.random(),Math.random()<.3&&(t.x+=60*(Math.random()-.5),t.y+=60*(Math.random()-.5))):(n.isFrozen=!0,n.frozenPosition={x:t.x,y:t.y},n.frozenVelocity={x:t.vx,y:t.vy},n.stutterTimer=0,n.nextStutter=20+40*Math.random())),n.glitchTimer>n.nextGlitch&&!n.isGlitching&&(n.isGlitching=!0,n.glitchDuration=50+100*Math.random(),n.glitchOffset={x:80*(Math.random()-.5),y:80*(Math.random()-.5)},n.glitchTimer=0,Math.random()<.5&&t.emotionColors&&(t.color=D(t.emotionColors))),n.isGlitching&&n.glitchTimer>n.glitchDuration&&(n.isGlitching=!1,n.glitchTimer=0,n.nextGlitch=200+800*Math.random(),n.glitchOffset={x:0,y:0}),n.beatPhase+=n.beatFrequency*i;const h=.5*Math.sin(n.beatPhase)+.5;if(n.beatPhase%(4*Math.PI)<.5*Math.PI?n.dropIntensity=Math.min(1,n.dropIntensity+.1*i):n.dropIntensity=Math.max(0,n.dropIntensity-.05*i),n.isFrozen)t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5);else{n.orbitAngle+=n.orbitSpeed*i*(1+.5*h);const a=n.orbitRadius*(1+.3*n.dropIntensity*Math.sin(4*n.beatPhase));let r=e+Math.cos(n.orbitAngle)*a,o=s+Math.sin(n.orbitAngle)*a*.6;if(n.isGlitching&&(r+=n.glitchOffset.x*Math.random()*.8,o+=n.glitchOffset.y*Math.random()*.8),n.rgbSplit){const t=3*(1+n.dropIntensity);r+=Math.sin(n.rgbPhase)*t,o+=Math.cos(n.rgbPhase)*t,n.rgbPhase+=.1*i}n.dropIntensity>.8&&Math.random()<.1&&(r+=30*(Math.random()-.5),o+=30*(Math.random()-.5));const c=n.isGlitching?.02:.03;t.vx=(r-t.x)*c,t.vy=(o-t.y)*c,t.vx+=(Math.random()-.5)*h*2,t.vy+=(Math.random()-.5)*h*2}t.x+=t.vx*i,t.y+=t.vy*i,Math.random()<.02&&(t.opacity=.1+.9*Math.random()),t.size=t.baseSize*(1+.3*h+.5*n.dropIntensity)}},at={name:"spaz",description:"Ultra-aggressive particles with explosive spread and chaotic motion",initialize(t,i,e,s){t.x=e,t.y=s,t.life=1,t.size=3+4*Math.random();const n=Math.random()*Math.PI*2,h=200+300*Math.random();t.vx=Math.cos(n)*h,t.vy=Math.sin(n)*h,t.behaviorState={explosionPhase:0,explosionTimer:0,explosionDuration:1e3+2e3*Math.random(),chaosTimer:0,nextChaosChange:100+200*Math.random(),chaosAngle:n,chaosSpeed:50+100*Math.random(),spazIntensity:.8+.4*Math.random(),zigzagPattern:Math.random()<.5,spiralPattern:Math.random()<.3,teleportChance:.02,sizePulse:!0,sizePulseSpeed:.1+.05*Math.random(),sizePulsePhase:Math.random()*Math.PI*2,colorShift:Math.random()<.3,colorShiftSpeed:.05+.03*Math.random()},t.lifeDecay=8e-4,t.hasGlow=!0,t.glowSizeMultiplier=4+3*Math.random(),t.glowIntensity=1.5+.5*Math.random()},update(t,i,e,s){const n=t.behaviorState;if(n.explosionTimer+=i,n.chaosTimer+=i,0===n.explosionPhase&&n.explosionTimer<500)t.vx*=.98,t.vy*=.98,Math.random()<.1&&(t.vx+=100*(Math.random()-.5),t.vy+=100*(Math.random()-.5));else if(0===n.explosionPhase&&n.explosionTimer>=500)n.explosionPhase=1,n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=30+70*Math.random();else if(1===n.explosionPhase){n.chaosTimer>=n.nextChaosChange&&(n.chaosAngle=Math.random()*Math.PI*2,n.chaosSpeed=20+80*Math.random(),n.nextChaosChange=50+150*Math.random(),n.chaosTimer=0);const i=Math.cos(n.chaosAngle)*n.chaosSpeed,e=Math.sin(n.chaosAngle)*n.chaosSpeed;if(t.vx=.7*t.vx+.3*i,t.vy=.7*t.vy+.3*e,n.zigzagPattern){const i=.01*n.chaosTimer;t.vx+=20*Math.sin(i),t.vy+=20*Math.cos(i)}if(n.spiralPattern){const i=.005*n.chaosTimer,e=50+30*Math.sin(.003*n.chaosTimer);t.vx+=Math.cos(i)*e*.1,t.vy+=Math.sin(i)*e*.1}}if(Math.random()<n.teleportChance){const i=Math.random()*Math.PI*2,n=200+400*Math.random();t.x=e+Math.cos(i)*n,t.y=s+Math.sin(i)*n,t.vx=200*(Math.random()-.5),t.vy=200*(Math.random()-.5)}if(t.x+=t.vx*(i/1e3),t.y+=t.vy*(i/1e3),n.sizePulse){n.sizePulsePhase+=n.sizePulseSpeed*i;const e=1+.5*Math.sin(n.sizePulsePhase);t.size=(3+4*Math.random())*e}n.colorShift&&(n.colorShiftPhase=(n.colorShiftPhase||0)+n.colorShiftSpeed*i),t.vx*=.995,t.vy*=.995,t.life-=t.lifeDecay*i,(t.life<=0||Math.abs(t.x-e)>2e3||Math.abs(t.y-s)>2e3)&&(t.life=0)},getSpawnPosition(t,i){const e=Math.random()*Math.PI*2,s=100+200*Math.random();return{x:t+Math.cos(e)*s,y:i+Math.sin(e)*s}},getVisualProperties:()=>({glowColor:"#FF00AA",glowIntensity:2,particleColors:[{color:"#FF00AA",weight:30},{color:"#00FFAA",weight:25},{color:"#FFAA00",weight:20},{color:"#AA00FF",weight:15},{color:"#00AAFF",weight:10}]})},rt={name:"directed",emoji:"ðŸŽ¯",description:"Focused, straight-line movement toward target",config:{speed:3,acceleration:.15,focusStrength:.8,randomness:.1,edgeBuffer:50},initialize(t,i,e,s,n){const h=i-t.x,a=e-t.y,r=Math.sqrt(h*h+a*a);if(r>0)t.vx=h/r*this.config.speed,t.vy=a/r*this.config.speed;else{const i=Math.random()*Math.PI*2;t.vx=Math.cos(i)*this.config.speed,t.vy=Math.sin(i)*this.config.speed}t.targetX=i,t.targetY=e,t.directedPhase=0},update(t,i,e,s,n,h){t.directedPhase+=.05*i;const a=t.targetX-t.x,r=t.targetY-t.y,o=Math.sqrt(a*a+r*r);if(o>10){const e=a/o*this.config.speed,s=r/o*this.config.speed;t.vx+=(e-t.vx)*this.config.acceleration*i,t.vy+=(s-t.vy)*this.config.acceleration*i,t.vx+=(Math.random()-.5)*this.config.randomness,t.vy+=(Math.random()-.5)*this.config.randomness}else{const i=Math.random()*Math.PI*2,a=100+200*Math.random();t.targetX=e+Math.cos(i)*a,t.targetY=s+Math.sin(i)*a,t.targetX=Math.max(this.config.edgeBuffer,Math.min(n-this.config.edgeBuffer,t.targetX)),t.targetY=Math.max(this.config.edgeBuffer,Math.min(h-this.config.edgeBuffer,t.targetY))}t.x+=t.vx*i,t.y+=t.vy*i,(t.x<=0||t.x>=n)&&(t.vx*=-.8,t.x=Math.max(0,Math.min(n,t.x)),t.targetX=e+300*(Math.random()-.5)),(t.y<=0||t.y>=h)&&(t.vy*=-.8,t.y=Math.max(0,Math.min(h,t.y)),t.targetY=s+300*(Math.random()-.5))},visuals:{trailLength:"medium",opacity:.9,sizeMultiplier:1,blurAmount:.2}},ot={name:"fizzy",emoji:"ðŸ«§",description:"Bubbly, effervescent movement like carbonation",config:{baseRiseSpeed:2.5,wobbleAmplitude:30,wobbleFrequency:.15,popChance:.002,popForce:8,fizziness:.3,gravity:-.05},initialize(t,i,e,s,n){t.vx=2*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.wobblePhase=Math.random()*Math.PI*2,t.wobbleSpeed=this.config.wobbleFrequency*(.8+.4*Math.random()),t.bubbleSize=.5+.5*Math.random(),t.popTimer=0,t.isFizzing=!0},update(t,i,e,s,n,h){t.wobblePhase+=t.wobbleSpeed*i;const a=Math.sin(t.wobblePhase)*this.config.wobbleAmplitude;if(t.vx=.05*a+(Math.random()-.5)*this.config.fizziness,t.vy+=this.config.gravity*i,t.vy+=(Math.random()-.5)*this.config.fizziness,Math.random()<this.config.popChance){const i=Math.random()*Math.PI*2;t.vx=Math.cos(i)*this.config.popForce,t.vy=Math.sin(i)*this.config.popForce*.7,t.popTimer=1,t.bubbleSize=.3+.7*Math.random()}t.popTimer>0&&(t.popTimer-=.05*i,t.vx*=.95,t.vy*=.95),t.x+=t.vx*i,t.y+=t.vy*i,t.y<-50&&(t.y=h+50,t.x=e+300*(Math.random()-.5),t.vy=-this.config.baseRiseSpeed-2*Math.random(),t.bubbleSize=.5+.5*Math.random()),(t.x<=0||t.x>=n)&&(t.vx*=-.5,t.x=Math.max(0,Math.min(n,t.x))),t.y>h+50&&(t.y=h,t.vy=1.5*-this.config.baseRiseSpeed),t.size=t.baseSize*t.bubbleSize*(1+.1*Math.sin(2*t.wobblePhase))},visuals:{trailLength:"short",opacity:.6,sizeMultiplier:1.2,blurAmount:.5,sparkle:!0}};var ct={name:"zen",emoji:"â˜¯ï¸",description:"Peaceful orbital movement like a hovering aura",initialize:function(t){t.vx=.5*(Math.random()-.5),t.vy=.5*(Math.random()-.5),t.lifeDecay=.003,t.emotionColors&&t.emotionColors.length>0&&(t.color=D(t.emotionColors)),t.behaviorData={orbitAngle:Math.random()*Math.PI*2,orbitRadius:40+60*Math.random(),orbitSpeed:8e-4+6e-4*Math.random(),floatOffset:Math.random()*Math.PI*2,breathingOffset:Math.random()*Math.PI*2,lifetime:0}},update:function(t,i,e,s){const n=t.behaviorData;if(!n)return;n.lifetime+=i;const h=(n.lifetime+8e3*n.breathingOffset)/8e3,a=.5*Math.sin(h*Math.PI*2)+.5;t.size=t.baseSize*(.95+.05*a),n.orbitAngle+=n.orbitSpeed*i;const r=10*Math.sin(1e-4*n.lifetime+n.floatOffset),o=n.orbitRadius+r,c=e+Math.cos(n.orbitAngle)*o,l=s+Math.sin(n.orbitAngle)*o,u=15*Math.sin(3e-4*n.lifetime+n.breathingOffset),p=c-t.x,d=l+u-t.y;t.vx=.03*p,t.vy=.03*d,t.vx+=.02*(Math.random()-.5),t.vy+=.02*(Math.random()-.5),t.vx*=.98,t.vy*=.98}};const lt=new Map;var ut=function(t){return lt.get(t)||null},pt=function(){return Array.from(lt.keys())};const dt={};function mt(t){if(dt[t])return dt[t];return ut(t)||null}function ft(t,i){const e=mt(i);return e&&e.initialize?(e.initialize(t),!0):"ambient"!==i&&ft(t,"ambient")}function gt(t,i,e,s,n){const h=mt(i);return!(!h||!h.update||(h.update(t,e,s,n),0))}[I,rt,ot,$,G,L,Y,U,W,N,Q,J,Z,K,it,et,st,nt,ht,at,ct].forEach(t=>{dt[t.name]=t}),"undefined"!=typeof window&&window.DEBUG_PARTICLES&&(window.ParticleBehaviors={registry:dt,list:function(){return[...Object.values(dt).map(t=>({name:t.name,emoji:t.emoji||"ðŸŽ¯",description:t.description||"No description",type:"core"})),...pt().map(t=>{const i=ut(t);return{name:i.name,emoji:i.emoji||"ðŸ”Œ",description:i.description||"Plugin behavior",type:"plugin"}})]},get:mt});const yt=new Map;var Mt=function(t){return yt.get(t)||null},bt=function(){return Array.from(yt.keys())},wt={name:"bounce",emoji:"â¬†ï¸",type:"blending",description:"Vertical oscillation with smooth easing",config:{duration:800,musicalDuration:{musical:!0,beats:2},amplitude:30,frequency:2,axis:"vertical",damping:!0,easing:"sine",strength:.6,particleMotion:{type:"bounce",axis:"vertical",strength:.6,frequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"bounce"},frequencySync:{mode:"tempo",multiplier:1},durationSync:{mode:"beats",beats:4},accentResponse:{enabled:!0,multiplier:1.5},patternOverrides:{waltz:{frequencySync:{multiplier:.75},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:2,offBeat:.4,curve:"ease"}},dubstep:{amplitudeSync:{onBeat:1.5,dropBeat:3,curve:"pulse"}},breakbeat:{frequencySync:{multiplier:1.5},amplitudeSync:{onBeat:2.2,offBeat:.3}}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.bounce={startY:t.y,startX:t.x,startVx:t.vx,startVy:t.vy,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.bounce?.initialized||this.initialize(t,e);const a={...this.config,...e},r=a.strength||this.config.strength||1,o=this.easeInOutCubic(i);let{frequency:c}=a;const l=e.phase||0;let u=a.amplitude*r*t.scaleFactor;e.rhythmModulation&&(u*=e.rhythmModulation.amplitudeMultiplier||1,u*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(c*=e.rhythmModulation.frequencyMultiplier));const p=Math.sin((o+l)*Math.PI*2*c);if(a.damping&&i>.7&&(u*=1-(i-.7)/.3*.8),"vertical"===a.axis?(t.vy+=p*u*.01*s,i>.9&&(t.vx*=.98)):"horizontal"===a.axis&&(t.vx+=p*u*.01*s,i>.9&&(t.vy*=.98)),i>.9){const e=1-10*(i-.9);t.vx=t.vx*(.95+.05*e),t.vy=t.vy*(.95+.05*e)}},cleanup(t){t.gestureData?.bounce&&delete t.gestureData.bounce},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},vt={name:"pulse",emoji:"ðŸ’—",type:"blending",description:"Radial expansion and contraction from center",config:{duration:600,amplitude:30,frequency:1,holdPeak:.1,easing:"sine",scaleAmount:.2,glowAmount:.3,strength:.15,direction:"outward",particleMotion:{type:"pulse",strength:.15,direction:"outward",frequency:1}},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.6,offBeat:.8,curve:"pulse"},frequencySync:{mode:"locked",subdivision:"quarter"},durationSync:{mode:"beats",beats:1},accentResponse:{enabled:!0,multiplier:2},patternOverrides:{waltz:{amplitudeSync:{onBeat:2,offBeat:.5},durationSync:{beats:3}},swing:{amplitudeSync:{onBeat:1.8,offBeat:.6,curve:"ease"},frequencySync:{subdivision:"swing"}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:4,curve:"pulse"}},breakbeat:{frequencySync:{mode:"random",range:[.5,2]},amplitudeSync:{onBeat:2.5,offBeat:.3}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s,a=Math.sqrt(n*n+h*h),r=Math.atan2(h,n);t.gestureData.pulse={baseDistance:a,angle:r,startX:t.x,startY:t.y,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.pulse?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.pulse,r={...this.config,...e},o=e.strength||1,c=this.easeInOutSine(i);let l,{frequency:u}=r,{amplitude:p}=r;e.rhythmModulation&&(p*=e.rhythmModulation.amplitudeMultiplier||1,p*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(u*=e.rhythmModulation.frequencyMultiplier));const d=c*u*2%2;l=r.holdPeak>0&&d>1-r.holdPeak&&d<1+r.holdPeak?1:Math.sin(c*Math.PI*2*u);const m=l*p*o*t.scaleFactor,f=a.baseDistance+m,g=n+Math.cos(a.angle)*f,y=h+Math.sin(a.angle)*f,M=.15*s;if(t.vx+=(g-t.x)*M*.1,t.vy+=(y-t.y)*M*.1,i>.9){const e=1-10*(i-.9);t.vx*=.9+.1*e,t.vy*=.9+.1*e}},cleanup(t){t.gestureData?.pulse&&delete t.gestureData.pulse},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},St={name:"shake",emoji:"ðŸ«¨",type:"blending",description:"Random jitter movement for vibration effects",config:{duration:400,amplitude:15,frequency:15,decay:.9,smoothing:.1,axes:"both",easing:"linear",strength:3,particleMotion:{type:"shake",strength:3,frequency:15,decay:!1}},rhythm:{enabled:!0,syncMode:"subdivision",amplitudeSync:{subdivision:"sixteenth",onBeat:2.5,offBeat:.7,curve:"pulse"},frequencySync:{mode:"tempo",baseFrequency:15,scaling:"linear"},durationSync:{mode:"beats",beats:2},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.2},frequencySync:{mode:"random",range:[8,20]}},dubstep:{amplitudeSync:{subdivision:"eighth",onBeat:4,dropBeat:6,curve:"pulse"}},swing:{amplitudeSync:{onBeat:1.8,offBeat:1,curve:"ease"}}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.shake={originalX:t.x,originalY:t.y,randomAngle:Math.random()*Math.PI*2,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.shake?.initialized||this.initialize(t,e);const a=t.gestureData.shake,r={...this.config,...e},o=r.strength||this.config.strength||1;let{amplitude:c}=r,{frequency:l}=r;e.rhythmModulation&&(c*=e.rhythmModulation.amplitudeMultiplier||1,c*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(l*=e.rhythmModulation.frequencyMultiplier));const u=r.decay?1-i:1,p=Math.sin(i*Math.PI*l)*c*u*o*t.scaleFactor,d=p*Math.cos(a.randomAngle),m=p*Math.sin(a.randomAngle);t.x=a.originalX+d,t.y=a.originalY+m},pseudoRandom(t){const i=1e4*Math.sin(t);return i-Math.floor(i)},cleanup(t){t.gestureData?.shake&&(t.x=t.gestureData.shake.originalX,t.y=t.gestureData.shake.originalY,delete t.gestureData.shake)}},Ft={name:"nod",emoji:"ðŸ™‚",type:"blending",description:"Vertical nodding motion",config:{duration:500,amplitude:15,frequency:2,easing:"sine",strength:.4,particleMotion:{type:"bounce",axis:"vertical",strength:.4,frequency:2,phase:0}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!1,priority:5,blendable:!1,minDuration:"halfBar",frequencySync:{mode:"subdivision",subdivision:"half",multiplier:1},amplitudeSync:{onBeat:1.4,offBeat:.8,curve:"ease"},durationSync:{mode:"beats",beats:2},patternOverrides:{waltz:{frequencySync:{subdivision:"quarter"},amplitudeSync:{onBeat:1.6,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.5,offBeat:.9}},dubstep:{amplitudeSync:{onBeat:1.2,dropBeat:3,curve:"pulse"}}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.nod={startY:t.y,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.nod?.initialized||this.initialize(t,e);const a={...this.config,...e},r=a.strength||this.config.strength||1;let{frequency:o}=a,{amplitude:c}=a;e.rhythmModulation&&(c*=e.rhythmModulation.amplitudeMultiplier||1,c*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(o*=e.rhythmModulation.frequencyMultiplier));const l=Math.sin(i*Math.PI*2*o);c=c*r*t.scaleFactor,t.vy+=l*c*.01*s,i>.9&&(t.vy*=.95)},cleanup(t){t.gestureData?.nod&&delete t.gestureData.nod}},kt={name:"vibrate",emoji:"ðŸ“³",type:"blending",description:"High frequency vibration",config:{duration:500,frequency:20,amplitude:8,easing:"linear",strength:2,particleMotion:{type:"shake",strength:2,frequency:20,amplitude:8}},rhythm:{enabled:!0,syncMode:"subdivision",frequencySync:{subdivision:"thirty-second",baseFrequency:20,tempoScaling:!0},amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"pulse"},durationSync:{mode:"beats",beats:1},patternOverrides:{dubstep:{frequencySync:{subdivision:"sixteenth"},amplitudeSync:{onBeat:2,dropBeat:3}},breakbeat:{frequencySync:{mode:"random",range:[15,30]}}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.vibrate={timer:0,seed:1e3*Math.random(),initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.vibrate?.initialized||this.initialize(t,e);const a=t.gestureData.vibrate,r={...this.config,...e},o=r.strength||this.config.strength||1;let{amplitude:c}=r,{frequency:l}=r;e.rhythmModulation&&(c*=e.rhythmModulation.amplitudeMultiplier||1,c*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(l*=e.rhythmModulation.frequencyMultiplier)),a.timer+=s*l;const u=(Math.random()-.5)*c*o,p=(Math.random()-.5)*c*o;if(t.vx+=.5*u*s,t.vy+=.5*p*s,t.vx*=.9,t.vy*=.9,i>.8){const e=1-5*(i-.8);t.vx*=e,t.vy*=e}},cleanup(t){t.gestureData?.vibrate&&delete t.gestureData.vibrate}},xt={name:"orbit",emoji:"ðŸª",description:"3D orbital motion around center",type:"override",config:{speed:1,rotations:1,zRotations:1,smoothness:.15,verticalOscillation:0,centripetal:!1},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:1,scaling:"linear"},rotationSync:{mode:"bars",rotationsPerBar:1,zSync:!0},radiusSync:{subdivision:"quarter",pulsAmount:.1,curve:"ease"},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{pulsAmount:.15}},swing:{speedSync:{mode:"swing",ratio:.67},verticalOscillation:.2},dubstep:{radiusSync:{subdivision:"eighth",pulsAmount:.3,dropMultiplier:2}},breakbeat:{speedSync:{mode:"random",range:[.5,2]},centripetal:!0}}},apply:function(t,i,e,s,n,h,a){if(!i.initialized){i.originalX=t.x,i.originalY=t.y,i.originalZ=t.z||0,i.originalVx=t.vx||0,i.originalVy=t.vy||0;const s=t.x-h,n=t.y-a;i.radius=Math.sqrt(s*s+n*n),i.radius<50&&(i.radius=50+100*Math.random()),i.initialAngle=Math.atan2(n,s),i.orbitSpeed=e.speed*(.8+.4*Math.random()),i.orbitTilt=.3*Math.random(),i.initialized=!0}let{rotations:r}=e,o=.05;e.rhythmModulation&&(e.rhythmModulation.speedMultiplier&&(i.orbitSpeed*=e.rhythmModulation.speedMultiplier),e.rhythmModulation.rotationMultiplier&&(r*=e.rhythmModulation.rotationMultiplier),e.rhythmModulation.radiusPulse&&(o=e.rhythmModulation.radiusPulse));let c=1,l=1;s<.15?(c=s/.15,c=c*c*(3-2*c),l=c):s>.85&&(c=(1-s)/.15,c=c*c*(3-2*c),l=c);const u=i.initialAngle+s*Math.PI*2*r*c,p=1+Math.sin(s*Math.PI*4)*o*c,d=i.radius*n*p*c,m=h+Math.cos(u)*d,f=a+Math.sin(u)*d,g=u*e.zRotations;if(t.z=.8*Math.sin(g)*c+i.originalZ*(1-c),s<.15){const e=.3*c;t.x=i.originalX+(m-i.originalX)*e,t.y=i.originalY+(f-i.originalY)*e;const s=-Math.sin(u)*d*i.orbitSpeed,n=Math.cos(u)*d*i.orbitSpeed;t.vx=i.originalVx+(s-i.originalVx)*l,t.vy=i.originalVy+(n-i.originalVy)*l}else if(s>.85){t.x=m+(i.originalX-m)*(1-c),t.y=f+(i.originalY-f)*(1-c);const e=-Math.sin(u)*d*i.orbitSpeed,s=Math.cos(u)*d*i.orbitSpeed;t.vx=e*l+i.originalVx*(1-l),t.vy=s*l+i.originalVy*(1-l)}else{if(e.verticalOscillation>0){const i=Math.sin(2*u)*e.verticalOscillation*n;t.y=f+i,t.x=m}else{const i=e.smoothness||.1;t.x+=(m-t.x)*i,t.y+=(f-t.y)*i}t.vx=-Math.sin(u)*d*i.orbitSpeed,t.vy=Math.cos(u)*d*i.orbitSpeed}if(e.centripetal){const n=1+.3*(1-Math.abs(t.z)),r=i.initialAngle+s*Math.PI*2*e.rotations*n;t.x=h+Math.cos(r)*d,t.y=a+Math.sin(r)*d}},emotions:["zen","love","excited","surprise"],features:{uses3D:!0,smooth:!0,looping:!0,dramatic:!0}},Bt={name:"twitch",emoji:"âš¡",type:"blending",description:"Nervous, paranoid twitching",config:{intensity:8,frequency:.08,duration:100,recovery:200,maxOffset:15,sharpness:.9},rhythm:{enabled:!0,syncMode:"subdivision",probabilitySync:{subdivision:"sixteenth",onBeat:.3,offBeat:.05,accentBoost:2},intensitySync:{onBeat:2,offBeat:.8,curve:"pulse"},patternOverrides:{breakbeat:{probabilitySync:{onBeat:.5,offBeat:.1},intensitySync:{onBeat:3,offBeat:.5}},dubstep:{intensitySync:{onBeat:1.5,dropBeat:5,curve:"pulse"}}}},apply(t,i,e,s,n,h){t.gestureData||(t.gestureData={}),t.gestureData.twitch||(t.gestureData.twitch={twitchOffset:{x:0,y:0},targetOffset:{x:0,y:0},isTwitching:!1,twitchTimer:0,cooldownTimer:0,lastTwitch:0});const a=t.gestureData.twitch,{config:r}=this;let o=e.intensity||r.intensity;e.rhythmModulation&&(o*=e.rhythmModulation.amplitudeMultiplier||1,o*=e.rhythmModulation.accentMultiplier||1);const c=Date.now();if(!a.isTwitching&&a.cooldownTimer<=0&&Math.random()<(e.frequency||r.frequency)){a.isTwitching=!0,a.twitchTimer=r.duration,a.cooldownTimer=r.recovery;const t=Math.random()*Math.PI*2,i=.5*r.maxOffset+Math.random()*(.5*r.maxOffset);a.targetOffset={x:Math.cos(t)*i*o/8,y:Math.sin(t)*i*o/8},a.lastTwitch=c}if(a.cooldownTimer>0&&(a.cooldownTimer-=16*s),a.isTwitching)if(a.twitchTimer-=16*s,a.twitchTimer>0){const{sharpness:t}=r;a.twitchOffset.x+=(a.targetOffset.x-a.twitchOffset.x)*t,a.twitchOffset.y+=(a.targetOffset.y-a.twitchOffset.y)*t}else a.isTwitching=!1;else a.twitchOffset.x*=.85,a.twitchOffset.y*=.85;t.vx+=a.twitchOffset.x*s*.5,t.vy+=a.twitchOffset.y*s*.5,Math.random()<.1&&(t.vx+=(Math.random()-.5)*o*.3,t.vy+=(Math.random()-.5)*o*.3)},cleanup(t){t.gestureData?.twitch&&delete t.gestureData.twitch}},Pt={name:"sway",type:"blending",emoji:"ðŸŒŠ",description:"Gentle side-to-side swaying motion",config:{duration:2e3,amplitude:20,frequency:1,strength:.5},rhythm:{enabled:!0,syncMode:"bar",amplitudeSync:{onBeat:1.2,offBeat:.9,curve:"ease"},durationSync:{mode:"bars",bars:1},patternOverrides:{waltz:{durationSync:{bars:1},amplitudeSync:{onBeat:1.5,curve:"ease"}},swing:{amplitudeSync:{onBeat:1.3,offBeat:.7,curve:"bounce"}}}},apply(t,i,e,s,n,h){const a={...this.config,...e},r=a.amplitude||this.config.amplitude,o=a.frequency||this.config.frequency,c=a.strength||this.config.strength,l=Math.sin(i*Math.PI*2*o)*r;t.vx+=.01*l*s*c,t.vy+=.5*Math.cos(i*Math.PI*4)*s*c},cleanup(t){}},Ct={name:"float",type:"blending",emoji:"ðŸŽˆ",description:"Gentle floating upward motion",config:{duration:2e3,amplitude:80,wobbleAmount:20,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:1.5,offBeat:.8,curve:"bounce"},wobbleSync:{subdivision:"eighth",intensity:.7},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:1.3},patternOverrides:{waltz:{wobbleSync:{subdivision:"quarter",intensity:.9}},dubstep:{amplitudeSync:{onBeat:2,curve:"pulse"}}}},apply(t,i,e,s,n,h){t.gestureData||(t.gestureData={}),t.gestureData.float||(t.gestureData.float={originalSize:t.size,originalOpacity:t.opacity||1});const a={...this.config,...e};let r=a.amplitude||this.config.amplitude,o=a.wobbleAmount||this.config.wobbleAmount;const c=a.strength||this.config.strength;e.rhythmModulation&&(r*=e.rhythmModulation.amplitudeMultiplier||1,r*=e.rhythmModulation.accentMultiplier||1,o*=e.rhythmModulation.wobbleMultiplier||1);const l=Math.sin(i*Math.PI*4)*o;t.vy-=.01*r*s*c*(1-.5*i),t.vx+=.01*l*s*c,t.size=t.baseSize*(1+.1*i),t.opacity=1-.3*i},cleanup(t){t.gestureData?.float?(t.opacity=t.gestureData.float.originalOpacity,t.size=t.gestureData.float.originalSize,delete t.gestureData.float):(t.opacity=1,t.size=t.baseSize),t.vx*=.5,t.vy*=.5}},At={name:"jitter",type:"blending",emoji:"ðŸ«¨",description:"Nervous jittery movement",config:{duration:1e3,intensity:15,frequency:30,strength:1},rhythm:{enabled:!0,syncMode:"beat",amplitudeSync:{onBeat:2,offBeat:.5,curve:"pulse"},patternOverrides:{breakbeat:{amplitudeSync:{onBeat:3,offBeat:.3}},dubstep:{amplitudeSync:{onBeat:5,offBeat:.1,curve:"pulse"}}}},apply(t,i,e,s,n,h){t.gestureData||(t.gestureData={}),t.gestureData.jitter||(t.gestureData.jitter={originalSize:t.size});const a={...this.config,...e};let r=a.intensity||this.config.intensity;const o=a.strength||this.config.strength;e.rhythmModulation&&(r*=e.rhythmModulation.amplitudeMultiplier||1,r*=e.rhythmModulation.accentMultiplier||1);const c=(Math.random()-.5)*r*o,l=(Math.random()-.5)*r*o,u=1-.5*i;t.vx+=.1*c*s*u,t.vy+=.1*l*s*u,t.size=t.baseSize*(1+.1*(Math.random()-.5))},cleanup(t){t.gestureData?.jitter?(t.size=t.gestureData.jitter.originalSize,delete t.gestureData.jitter):t.size=t.baseSize,t.vx*=.7,t.vy*=.7}},Tt={name:"spin",emoji:"ðŸŒ€",type:"override",description:"Orbital rotation around center point",config:{duration:600,musicalDuration:{musical:!0,beats:1},rotations:1,direction:"random",radiusMultiplier:1,spiralOut:!1,accelerate:!0,maintainDistance:!0,scaleAmount:.1,easing:"linear",strength:.7,particleMotion:{type:"spin",strength:.7,rotations:1,radius:1}},rhythm:{enabled:!0,syncMode:"bar",rotationSync:{mode:"bars",rotationsPerBar:1,accelerateOnBeat:!0},radiusSync:{subdivision:"quarter",expandOnBeat:1.2,contractOffBeat:.9,curve:"bounce"},durationSync:{mode:"beats",beats:4},patternOverrides:{waltz:{rotationSync:{rotationsPerBar:.75},radiusSync:{curve:"ease"}},swing:{rotationSync:{accelerateOnBeat:!1},direction:"alternating"},dubstep:{radiusSync:{subdivision:"eighth",expandOnBeat:1.5,dropMultiplier:2},spiralOut:!0},breakbeat:{rotationSync:{mode:"random",range:[.5,2]},direction:"random"}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;let a=i.direction||this.config.direction;"random"===a&&(a=Math.random()<.5?"clockwise":"counter-clockwise"),t.gestureData.spin={startAngle:Math.atan2(h,n),startRadius:Math.sqrt(n*n+h*h)||30,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,direction:a,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.spin?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.spin,r={...this.config,...e},o=e.strength||1;let{rotations:c}=r,{radiusMultiplier:l}=r;e.rhythmModulation&&(e.rhythmModulation.rotationMultiplier&&(c*=e.rhythmModulation.rotationMultiplier),e.rhythmModulation.radiusMultiplier&&(l*=e.rhythmModulation.radiusMultiplier));let u=i;r.accelerate&&(u=i<.5?.5*this.easeInQuad(2*i):.5+.5*this.easeOutQuad(2*(i-.5)));const p=c*Math.PI*2*o,d="counter-clockwise"===a.direction?-1:1,m=a.startAngle+p*u*d;let f=a.startRadius;r.spiralOut&&(f*=1+.5*i),1!==l&&(f*=1+(l-1)*Math.sin(i*Math.PI));const g=n+Math.cos(m)*f,y=h+Math.sin(m)*f;if(t.x+=.25*(g-t.x),t.y+=.25*(y-t.y),t.vx=.5*(g-t.x),t.vy=.5*(y-t.y),i>.9){const e=10*(1-i);t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e)}},cleanup(t){if(t.gestureData?.spin){const i=t.gestureData.spin;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.spin}},easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t)},Ot={name:"jump",emoji:"ðŸ¦˜",type:"override",description:"Squash, leap, and land with classic animation principles",config:{duration:800,jumpHeight:60,squashAmount:.8,stretchAmount:1.2,anticipation:.2,hangTime:.1,landingImpact:!0,driftOutward:!0,easing:"quad",particleMotion:{type:"jump",strength:.9,jumpHeight:60,squash:.8,stretch:1.2}},rhythm:{enabled:!0,syncMode:"beat",phaseSync:{anticipation:"eighth",jump:"beat",landing:"sixteenth"},heightSync:{onBeat:1.5,offBeat:.8,accent:2,curve:"exponential"},deformationSync:{squashOnBeat:.6,stretchOnBeat:1.4,timing:"anticipatory"},hangTimeSync:{mode:"tempo",baseDuration:.1,scaling:"inverse"},dynamics:{forte:{jumpHeight:80,stretch:1.3},piano:{jumpHeight:30,stretch:1.1}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={}),t.gestureData.jump={startX:t.x,startY:t.y,startSize:t.size,originalVx:t.vx,originalVy:t.vy,driftDirection:.1*(t.x-e),initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.jump?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.jump,r={...this.config,...e},o=e.strength||1,c=r.jumpHeight*o*t.scaleFactor,l=r.squashAmount,u=r.stretchAmount,p=r.anticipation,d=1-.5*r.anticipation;if(i<p){const e=i/p,s=this.easeOutQuad(e);t.size=a.startSize*(1-(1-l)*s),t.y=a.startY+5*s*t.scaleFactor,t.vx=0,t.vy=0}else if(i<d){const e=(i-p)/(d-p);let s=Math.sin(e*Math.PI);if(r.hangTime>0&&e>.4&&e<.6){const t=(e-.4)/.2;s=.95+.05*this.easeInOutCubic(t)}if(t.y=a.startY-s*c,r.driftOutward&&(t.x=a.startX+s*a.driftDirection),e<.5){const i=2*e;t.size=a.startSize*(l+(u-l)*i)}else{const i=2*(e-.5);t.size=a.startSize*(u-(u-1)*i*.8)}t.vx=.5*a.driftDirection,t.vy=-Math.cos(e*Math.PI)*c*.1}else{const e=(i-d)/(1-d),s=this.easeOutBounce(e);if(t.y=a.startY,r.landingImpact)if(e<.3){const i=e/.3;t.size=a.startSize*(1-(1-.8*l)*(1-i))}else{const i=(e-.3)/.7;t.size=a.startSize*(.8*l+(1-.8*l)*i)}else t.size=a.startSize*(l+(1-l)*s);t.vx=a.originalVx*s,t.vy=a.originalVy*s}},cleanup(t){if(t.gestureData?.jump){const i=t.gestureData.jump;t.size=i.startSize,t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.jump}},easeOutQuad:t=>t*(2-t),easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutBounce(t){const i=7.5625,e=2.75;return t<1/e?i*t*t:t<2/e?i*(t-=1.5/e)*t+.75:t<2.5/e?i*(t-=2.25/e)*t+.9375:i*(t-=2.625/e)*t+.984375}},Rt={name:"morph",emoji:"âœ¨",type:"override",description:"Form geometric patterns and shapes",config:{musicalDuration:{musical:!0,beats:2,minBeats:1,maxBeats:8},phases:[{name:"gather",beats:.25},{name:"form",beats:.75},{name:"hold",beats:.5},{name:"dissolve",beats:.5}],morphType:"fluid",pattern:"star",points:5,innerRadius:.4,size:80,amplitude:20,rotation:0,smooth:!0,randomizeOrder:!1,easing:"sine",strength:1.2,particleMotion:{type:"morph",pattern:"star",strength:1.2,smooth:!0,points:5}},rhythm:{enabled:!0,syncMode:"phrase",patternSync:{verse:"circle",chorus:"star",bridge:"heart",drop:"explosion"},timingSync:{formationBeat:1,holdBeats:2,dissolveBeat:4,curve:"anticipatory"},sizeSync:{onBeat:1.2,offBeat:.95,subdivision:"quarter",curve:"elastic"},rotationSync:{mode:"continuous",degreesPerBar:90,direction:"clockwise"},dynamics:{forte:{points:8,size:100},piano:{points:3,size:60}}},initialize(t,i,e,s,n){t.gestureData||(t.gestureData={});const h={...this.config,...i},a=t.x,r=t.y,o=Math.atan2(t.y-s,t.x-e),c=Math.random()<.5?1:-1;let l,u;const p=h.size*t.scaleFactor,d=(h.rotation||0)*Math.PI/180*c;switch(h.pattern){case"star":l=e,u=s,this.calculateStarPosition(t,o,p,h.points,h.innerRadius,d,e,s);break;case"heart":this.calculateHeartPosition(t,o,p,d,e,s);break;case"square":this.calculateSquarePosition(t,o,p,d,e,s);break;case"triangle":this.calculateTrianglePosition(t,o,p,d,e,s);break;default:{const t=p;l=e+Math.cos(o+d)*t,u=s+Math.sin(o+d)*t;break}}t.gestureData.morph={startX:a,startY:r,targetX:t.gestureData.morphTargetX||l,targetY:t.gestureData.morphTargetY||u,originalVx:t.vx,originalVy:t.vy,rotationDirection:c,initialized:!0}},calculateStarPosition(t,i,e,s,n,h,a,r){const o=((i+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI),c=Math.floor(o/(2*Math.PI)*10),l=c%2==0,u=Math.floor(c/2);let p;p=l?72*u*Math.PI/180:(72*u+36)*Math.PI/180,p+=h;const d=l?e:e*n;t.gestureData.morphTargetX=a+Math.cos(p)*d,t.gestureData.morphTargetY=r+Math.sin(p)*d},calculateHeartPosition(t,i,e,s,n,h){const a=(i+Math.PI)/(2*Math.PI),r=.05*e,o=16*Math.pow(Math.sin(a*Math.PI*2),3),c=-(13*Math.cos(a*Math.PI*2)-5*Math.cos(2*a*Math.PI*2)-2*Math.cos(3*a*Math.PI*2)-Math.cos(4*a*Math.PI*2)),l=Math.cos(s),u=Math.sin(s),p=o*l-c*u,d=o*u+c*l;t.gestureData.morphTargetX=n+p*r,t.gestureData.morphTargetY=h+d*r},calculateSquarePosition(t,i,e,s,n,h){const a=((i+s)%(2*Math.PI)+2*Math.PI)%(2*Math.PI);let r,o;const c=e;a<Math.PI/4||a>=7*Math.PI/4?(r=c,o=c*Math.tan(a)):a<3*Math.PI/4?(r=c/Math.tan(a),o=c):a<5*Math.PI/4?(r=-c,o=-c*Math.tan(a)):(r=-c/Math.tan(a),o=-c);const l=Math.cos(s),u=Math.sin(s),p=r*l-o*u,d=r*u+o*l;t.gestureData.morphTargetX=n+p,t.gestureData.morphTargetY=h+d},calculateTrianglePosition(t,i,e,s,n,h){const a=[{x:0,y:-e},{x:.866*-e,y:.5*e},{x:.866*e,y:.5*e}],r=Math.floor((i+Math.PI)/(2*Math.PI)*3)%3,o=(r+1)%3,c=Math.random(),l=a[r].x+(a[o].x-a[r].x)*c,u=a[r].y+(a[o].y-a[r].y)*c,p=Math.cos(s),d=Math.sin(s),m=l*p-u*d,f=l*d+u*p;t.gestureData.morphTargetX=n+m,t.gestureData.morphTargetY=h+f},apply(t,i,e,s,n,h){t.gestureData?.morph?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.morph,r={...this.config,...e};let o,c,l=i;if(r.holdTime>0){const t=.5-r.holdTime/2,e=.5+r.holdTime/2;l=i<t?i/t*.5:i<e?.5:.5+(i-e)/(1-e)*.5}if(l<=.5){const t=2*l;o=a.startX+(a.targetX-a.startX)*this.easeOutQuad(t),c=a.startY+(a.targetY-a.startY)*this.easeOutQuad(t)}else{const t=2*(l-.5);o=a.targetX+(a.startX-a.targetX)*this.easeInQuad(t),c=a.targetY+(a.startY-a.targetY)*this.easeInQuad(t)}if(r.smooth){const i=.2;t.x+=(o-t.x)*i,t.y+=(c-t.y)*i}else t.x=o,t.y=c;if(t.vx=.5*(o-t.x),t.vy=.5*(c-t.y),i>.9){const e=10*(1-i);t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e)}},cleanup(t){if(t.gestureData?.morph){const i=t.gestureData.morph;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.morph,delete t.gestureData.morphTargetX,delete t.gestureData.morphTargetY}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t),easeInQuad:t=>t*t},zt={name:"stretch",emoji:"â†”ï¸",type:"override",description:"Scale particles along X and Y axes",config:{duration:2e3,scaleX:1.3,scaleY:.9,alternate:!1,elastic:!0,overshoot:.1,frequency:1,easing:"sine",strength:1,particleMotion:{type:"stretch",scaleX:1.8,scaleY:.6,strength:1},centerBased:!0,preserveArea:!1},rhythm:{enabled:!0,syncMode:"beat",scaleSync:{onBeat:{x:1.5,y:.7},offBeat:{x:.8,y:1.3},subdivision:"eighth",curve:"elastic"},alternateSync:{pattern:"XYXY",beatsPerChange:1,overlap:.1},overshootSync:{normal:.1,accent:.3,downbeat:.2,curve:"spring"},preservationSync:{verse:!0,chorus:!1,bridge:!0},dynamics:{forte:{scaleX:2,scaleY:.5,overshoot:.4},piano:{scaleX:1.1,scaleY:.95,overshoot:.05}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;t.gestureData.stretch={offsetX:n,offsetY:h,startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.stretch?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.stretch,r={...this.config,...e},o=e.strength||1;let c,l,{scaleX:u}=r,{scaleY:p}=r;if(r.preserveArea&&1!==u&&1!==p){const t=u*p,i=Math.sqrt(1/t);u*=i,p*=i}if(r.alternate)if(i<.5){const t=2*i;u=1+(u-1)*this.getElasticProgress(t,r),p=1+(1/u-1)*(r.preserveArea?1:0)}else{const t=2*(i-.5);u+=(1-u)*this.getElasticProgress(t,r),p=1+(p-1)*this.getElasticProgress(t,r)}else{const t=this.getElasticProgress(i,r);u=1+(u-1)*t*o,p=1+(p-1)*t*o}if(r.centerBased?(c=n+a.offsetX*u,l=h+a.offsetY*p):(c=a.startX*u,l=a.startY*p),t.x=c,t.y=l,t.vx=a.offsetX*(u-1)*o*.1,t.vy=a.offsetY*(p-1)*o*.1,i>.9){const e=10*(1-i);t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e)}},getElasticProgress(t,i){if(!i.elastic)return this.easeInOutCubic(t);if(0===t)return 0;if(1===t)return 1;const e=i.overshoot||.1;if(t<.5){const i=2*t;return.5*this.easeInElastic(i,e)}{const i=2*(t-.5);return.5+.5*this.easeOutElastic(i,e)}},cleanup(t){if(t.gestureData?.stretch){const i=t.gestureData.stretch;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.stretch}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeInElastic:(t,i)=>0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin((t-1-.075)*(2*Math.PI)/.3)*(1+i),easeOutElastic:(t,i)=>0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)*(1+i)+1},Et={name:"tilt",emoji:"ðŸ¤”",type:"override",description:"Gather particles then tilt as unified group",config:{duration:500,gatherPhase:.2,tiltAngle:45,swayAmount:80,liftAmount:60,frequency:3,homeRadius:20,easing:"sine",strength:2.5,particleMotion:{type:"tilt",strength:2.5,frequency:3,swayAmount:80,liftAmount:60},smoothness:.25},rhythm:{enabled:!0,syncMode:"swing",angleSync:{onBeat:45,offBeat:-30,swing:15,subdivision:"triplet",curve:"ease-in-out"},gatherSync:{beatsBefore:.5,releaseAfter:.25,intensity:"dynamic"},swaySync:{verse:60,chorus:100,bridge:80,syncopated:!0},liftSync:{upOnTilt:!0,heightOnAccent:80,normalHeight:40,curve:"bounce"},dynamics:{forte:{tiltAngle:60,swayAmount:120,frequency:4},piano:{tiltAngle:20,swayAmount:40,frequency:2}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s,a=Math.atan2(h,n),r=Math.sqrt(n*n+h*h),o=Math.random(),c=({...this.config,...i}.homeRadius+20*Math.random())*t.scaleFactor;t.gestureData.tilt={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,angle:a,distance:r,homeRadius:c,homeX:e+Math.cos(a)*c,homeY:s+Math.sin(a)*c,role:o,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.tilt?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.tilt,r={...this.config,...e},o=e.strength||1;let c,l;if(i<r.gatherPhase){const e=i/r.gatherPhase,s=this.easeInOutCubic(e);c=a.startX+(a.homeX-a.startX)*s,l=a.startY+(a.homeY-a.startY)*s;const n=.6;t.x+=(c-t.x)*n,t.y+=(l-t.y)*n}else{const e=(i-r.gatherPhase)/(1-r.gatherPhase)*Math.PI*r.frequency,s=Math.sin(e),u=r.tiltAngle*Math.PI/180*o,p=a.angle+s*u,d=Math.abs(s)*r.liftAmount*t.scaleFactor,m=a.homeRadius+d;c=n+Math.cos(p)*m,l=h+Math.sin(p)*m-.3*d;const f=r.smoothness+.1*a.role;t.x+=(c-t.x)*f,t.y+=(l-t.y)*f;const g=-Math.sin(p),y=Math.cos(p);t.vx=g*s*2,t.vy=y*s*2}if(i<r.gatherPhase&&(t.vx=.25*(c-t.x),t.vy=.25*(l-t.y)),i>.9){const e=10*(1-i),s=a.startX+(t.x-a.startX)*e,n=a.startY+(t.y-a.startY)*e;t.x=s,t.y=n,t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e)}},cleanup(t){if(t.gestureData?.tilt){const i=t.gestureData.tilt;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.tilt}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},qt={name:"orbital",emoji:"ðŸª",type:"override",description:"Orbital motion around center",config:{speed:.02,maintainRadius:!0,elliptical:!1,use3D:!0,zPhaseOffset:0,verticalOscillation:0,duration:3e3,particleMotion:{type:"orbital",strength:1}},rhythm:{enabled:!0,syncMode:"harmonic",speedSync:{tonic:.02,fifth:.03,octave:.04,third:.025,curve:"smooth"},radiusSync:{bass:150,mid:100,treble:50,scaling:"logarithmic"},depthSync:{major:{z:1,phase:0},minor:{z:-1,phase:Math.PI},diminished:{z:.5,phase:Math.PI/2},augmented:{z:.8,phase:-Math.PI/2}},phaseSync:{mode:"harmonic",intervals:[1,1.5,2],drift:.05},dynamics:{forte:{speed:.04,maintainRadius:!1},piano:{speed:.01,maintainRadius:!0}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s,a=Math.sqrt(n*n+h*h),r=Math.random()<.5?1:-1,o=Math.max(a,100+180*Math.random());t.gestureData.orbital={radius:o,targetRadius:o,angle:a<5?Math.random()*Math.PI*2:Math.atan2(h,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,direction:r}},apply(t,i,e,s,n,h){t.gestureData?.orbital||this.initialize(t,e,n,h);const a=t.gestureData.orbital,r=(e.speed||this.config.speed)*(e.strength||1);a.angle+=r*s*a.direction;let{radius:o}=a;if(e.maintainRadius||(o=a.radius*(1+.1*Math.sin(i*Math.PI*2))),t.x=n+Math.cos(a.angle)*o,t.y=h+Math.sin(a.angle)*o,!1!==e.use3D){const i=a.angle+a.zPhase+(e.zPhaseOffset||0);if(t.z=.8*Math.sin(i),e.verticalOscillation){const s=Math.cos(i)*e.verticalOscillation*o*.1;t.y+=s}}if(t.vx=-Math.sin(a.angle)*o*r,t.vy=Math.cos(a.angle)*o*r,i>.9){const e=10*(1-i);t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e)}},cleanup(t){if(t.gestureData?.orbital){const i=t.gestureData.orbital;t.vx=i.originalVx,t.vy=i.originalVy,t.z=i.originalZ,delete t.gestureData.orbital}}},Dt={name:"hula",emoji:"ðŸŒ€",type:"override",description:"Hula-hoop motion with vertical waves",config:{speed:.015,maintainRadius:!1,elliptical:!0,use3D:!0,zPhaseOffset:Math.PI/4,verticalOscillation:.3,wobbleAmount:.15,duration:2500,particleMotion:{type:"hula",strength:1,verticalOscillation:.3}},rhythm:{enabled:!0,syncMode:"bar",speedSync:{mode:"tempo",baseSpeed:.015,scaling:"proportional"},wobbleSync:{onBeat:.25,offBeat:.1,curve:"sine"},verticalSync:{subdivision:"quarter",amplitude:.4,phase:"sequential"},dynamics:{forte:{wobbleAmount:.3,speed:1.2},piano:{wobbleAmount:.05,speed:.8}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s,a=Math.sqrt(n*n+h*h),r=Math.random()<.5?1:-1,o=Math.max(a,100+180*Math.random());t.gestureData.hula={radius:o,angle:a<5?Math.random()*Math.PI*2:Math.atan2(h,n),originalVx:t.vx,originalVy:t.vy,originalZ:t.z||0,zPhase:Math.random()*Math.PI*2,wobblePhase:Math.random()*Math.PI*2,direction:r}},apply(t,i,e,s,n,h){t.gestureData?.hula||this.initialize(t,e,n,h);const a=t.gestureData.hula,r=(e.speed||this.config.speed)*(e.strength||1);let o=1;i<.1?(o=i/.1,o=Math.sin(o*Math.PI*.5)):i>.9&&(o=(1-i)/.1,o=Math.sin(o*Math.PI*.5)),a.angle+=r*s*a.direction*o;const c=Math.sin(2*a.angle+a.wobblePhase)*(e.wobbleAmount||this.config.wobbleAmount)*o,l=a.radius*(1+c)*o,u=a.radius*(.7+c)*o,p=n+Math.cos(a.angle)*l,d=h+Math.sin(a.angle)*u;if(i<.1){const i=t.x-n,e=t.y-h;Math.sqrt(i*i+e*e)<50?(t.x=n+Math.cos(a.angle)*l,t.y=h+Math.sin(a.angle)*u):(t.x=t.x+(p-t.x)*o*.5,t.y=t.y+(d-t.y)*o*.5)}else t.x=p,t.y=d;const m=a.angle+a.zPhase+(e.zPhaseOffset||this.config.zPhaseOffset);t.z=.9*Math.sin(m)*o;const f=e.verticalOscillation||this.config.verticalOscillation,g=Math.cos(2*m)*f*a.radius*.2*o;t.y+=g;const y=t.z*a.radius*.1;t.y-=y;const M=-Math.sin(a.angle)*l*r,b=Math.cos(a.angle)*u*r;i<.1?(t.vx=a.originalVx+(M-a.originalVx)*o,t.vy=a.originalVy+(b-a.originalVy)*o):i>.9?(t.vx=M*o+a.originalVx*(1-o),t.vy=b*o+a.originalVy*(1-o),t.z=t.z*o+a.originalZ*(1-o)):(t.vx=M,t.vy=b)},cleanup(t){if(t.gestureData?.hula){const i=t.gestureData.hula;t.vx=i.originalVx,t.vy=i.originalVy,t.z=i.originalZ,delete t.gestureData.hula}}},It={name:"scan",emoji:"ðŸ”",type:"override",description:"Searchlight scanning motion",config:{scanSpeed:.008,scanWidth:120,pauseDuration:300,scanHeight:40,layers:3,duration:3e3},rhythm:{enabled:!0,syncMode:"measure",sweepSync:{beatsPerSweep:4,pauseOnDownbeat:!0,reverseOnBar:!0,curve:"linear"},layerSync:{quiet:1,moderate:2,loud:3,stagger:"sequential"},pauseSync:{onBeat:500,offBeat:100,accent:800,subdivision:"quarter"},widthSync:{verse:80,chorus:140,bridge:100,transition:"smooth"},dynamics:{forte:{scanSpeed:.012,layers:4},piano:{scanSpeed:.004,layers:1}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=Math.floor(Math.random()*this.config.layers);t.gestureData.scan={layer:n,phase:Math.random()*Math.PI*2,direction:Math.random()<.5?1:-1,pauseTimer:0,isPaused:!1,originalX:t.x,originalY:t.y,originalVx:t.vx,originalVy:t.vy,scanOffset:20*(Math.random()-.5),verticalOffset:30*n-30,initialized:!0,startTime:Date.now()}},apply(t,i,e,s,n,h){t.gestureData?.scan||this.initialize(t,e,n,h);const a=t.gestureData.scan,r=e.scanSpeed||this.config.scanSpeed,o=e.scanWidth||this.config.scanWidth,c=e.pauseDuration||this.config.pauseDuration;if(a.isPaused)a.pauseTimer-=16*s,a.pauseTimer<=0&&(a.isPaused=!1,a.direction*=-1);else{a.phase+=r*a.direction*s;const t=Math.sin(a.phase);Math.abs(t)>.95&&(a.isPaused=!0,a.pauseTimer=c)}const l=Math.sin(a.phase)*o,u=Math.cos(.5*a.phase)*(this.config.scanHeight/2);let p=1;i<.15?(p=i/.15,p*=p):i>.85&&(p=(1-i)/.15,p*=p);const d=n+l+a.scanOffset,m=h+u+a.verticalOffset;t.x=a.originalX+(d-a.originalX)*p,t.y=a.originalY+(m-a.originalY)*p,a.isPaused?(t.vx*=.85,t.vy*=.85):(t.vx=-Math.cos(a.phase)*o*r*60,t.vy=-Math.sin(.5*a.phase)*this.config.scanHeight*r*30),Math.random()<.02&&(t.vx+=2*(Math.random()-.5),t.vy+=2*(Math.random()-.5))},cleanup(t){if(t.gestureData?.scan){const i=t.gestureData.scan;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.scan}}},jt={name:"twist",emoji:"ðŸŒ€",type:"override",description:"Twisting dance motion with alternating rotation",config:{duration:1200,rotationAngle:45,contractionFactor:.8,twistFrequency:2,easing:"smooth",strength:.8,particleMotion:{type:"twist",rotationAngle:45,contractionFactor:.8,twistFrequency:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",interruptible:!0,priority:4,blendable:!1,crossfadePoint:"anyBeat",amplitudeSync:{onBeat:1.5,offBeat:.7,curve:"elastic"},patternOverrides:{funk:{rotationAngle:60,contractionFactor:.7},disco:{twistFrequency:3,rotationAngle:50},latin:{rotationAngle:35,contractionFactor:.85,twistFrequency:2.5}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.twist={startX:t.x,startY:t.y,startAngle:Math.atan2(t.y-i.centerY,t.x-i.centerX),startDistance:Math.sqrt(Math.pow(t.x-i.centerX,2)+Math.pow(t.y-i.centerY,2)),initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.twist?.initialized||this.initialize(t,{...e,centerX:n,centerY:h});const a={...this.config,...e},r=t.gestureData.twist,o=a.strength||this.config.strength||1,c=i*a.twistFrequency*Math.PI*2,l=Math.sin(c)*o;let{rotationAngle:u}=a,{contractionFactor:p}=a;e.rhythmModulation&&(u*=e.rhythmModulation.amplitudeMultiplier||1,p=1-(1-p)*(e.rhythmModulation.amplitudeMultiplier||1));const d=u*Math.PI/180*l,m=1-(1-p)*Math.abs(l),f=r.startAngle+d,g=r.startDistance*m,y=n+Math.cos(f)*g,M=h+Math.sin(f)*g,b=.15*o;t.x+=(y-t.x)*b,t.y+=(M-t.y)*b,t.vx=.05*(y-t.x),t.vy=.05*(M-t.y);const w=5*Math.sin(i*Math.PI*4)*o;if(t.y+=.1*w,i>.9){const e=1-10*(i-.9);t.vx*=e,t.vy*=e}},cleanup(t){t.gestureData?.twist&&delete t.gestureData.twist}},$t={name:"wave",emoji:"ðŸŒŠ",type:"override",description:"Infinity pattern flow with phasing",config:{musicalDuration:{musical:!0,bars:1,minBeats:4,maxBeats:16},phases:[{name:"gather",beats:.5},{name:"rise",beats:.5},{name:"waveLeft",beats:1},{name:"waveRight",beats:1},{name:"settle",beats:1}],amplitude:40,frequency:1,phaseShift:.3,liftHeight:20,fadeInOut:!0,smoothness:.1,easing:"sine",strength:1,particleMotion:{type:"wave",strength:1,amplitude:50}},rhythm:{enabled:!0,syncMode:"wave",amplitudeSync:{onWave:65,onStatic:25,curve:"flowing"},frequencySync:{mode:"phrase",slow:.7,fast:1.8,curve:"melodic"},durationSync:{mode:"bars",adaptToPhrase:!0,sustain:!0},phaseSync:{enabled:!0,multiplier:.5,type:"ensemble"},melodicResponse:{enabled:!0,multiplier:1.4,type:"amplitude"},patternOverrides:{ambient:{amplitudeSync:{onWave:80,onStatic:40,curve:"hypnotic"},frequencySync:{slow:.5,fast:1.2},durationSync:{minBeats:16,maxBeats:64}},ocean:{amplitudeSync:{onWave:90,onStatic:20,curve:"natural"},phaseSync:{multiplier:.8},melodicResponse:{multiplier:1.8}},electronic:{amplitudeSync:{onWave:70,onStatic:30,curve:"digital"},frequencySync:{slow:.8,fast:2.5,curve:"precise"}},orchestral:{amplitudeSync:{onWave:75,onStatic:35},phaseSync:{multiplier:.7},melodicResponse:{multiplier:2}}},dynamics:{forte:{amplitudeSync:{onWave:{multiplier:1.8},onStatic:{multiplier:1.4}},frequencySync:{multiplier:1.3},melodicResponse:{multiplier:2.2}},piano:{amplitudeSync:{onWave:{multiplier:.6},onStatic:{multiplier:.4}},frequencySync:{multiplier:.7},melodicResponse:{multiplier:1.1}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s,a=Math.atan2(h,n),r=Math.sqrt(n*n+h*h),o=Math.random()<.5?1:-1;t.gestureData.wave={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,angle:a,radius:r,offset:Math.random()*Math.PI*2,role:Math.random(),direction:o,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.wave?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.wave,r={...this.config,...e},o=e.strength||1,c=this.easeInOutSine(i),l=a.role*r.phaseShift,u=Math.max(0,c-l),p=u*Math.PI*2*r.frequency*a.direction+a.offset,d=.5+a.radius/100*.5,m=r.amplitude*d*o*t.scaleFactor,f=n+Math.sin(p)*m,g=h+Math.sin(2*p)*m*.3+-Math.abs(Math.sin(c*Math.PI))*r.liftHeight*t.scaleFactor,y=r.smoothness+.12*a.role;if(t.x+=(f-t.x)*y,t.y+=(g-t.y)*y,t.vx=.3*(f-t.x),t.vy=.3*(g-t.y),r.fadeInOut){let i;i=u<.1?u/.1:u>.9?(1-u)/.1:.5+.5*Math.sin(u*Math.PI),t.opacity=a.baseOpacity*(.3+.7*i),void 0!==t.life&&(t.life=t.opacity)}if(i>=.95){const e=20*(1-i);t.vx=t.vx*e+a.originalVx*(1-e),t.vy=t.vy*e+a.originalVy*(1-e),r.fadeInOut&&(t.opacity=a.baseOpacity*e,void 0!==t.life&&(t.life=t.opacity))}},cleanup(t){if(t.gestureData?.wave){const i=t.gestureData.wave;t.vx=i.originalVx,t.vy=i.originalVy,t.opacity=i.baseOpacity,void 0!==t.life&&(t.life=i.baseOpacity),delete t.gestureData.wave}},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},Gt={name:"drift",emoji:"â˜ï¸",type:"override",description:"Controlled floating with fade effects",config:{duration:800,distance:50,angle:45,returnToOrigin:!0,fadeOut:!1,holdTime:.2,turbulence:.1,angleSpread:45,smoothness:.08,easing:"ease",strength:1,particleMotion:{type:"drift",strength:1,distance:60}},rhythm:{enabled:!0,syncMode:"ambient",distanceSync:{quiet:30,loud:80,crescendo:"expand",diminuendo:"contract"},angleSync:{major:45,minor:225,modulation:"smooth",cadence:"return"},holdSync:{shortPhrase:.1,longPhrase:.4,fermata:"sustain"},accentResponse:{enabled:!0,multiplier:1.3,type:"distance"},patternOverrides:{ambient:{distanceSync:{quiet:40,loud:100},holdSync:{shortPhrase:.3,longPhrase:.6}},classical:{angleSync:{major:30,minor:210},distanceSync:{quiet:25,loud:60}},jazz:{angleSync:{major:60,minor:240,swing:!0,syncopated:!0}},new_age:{distanceSync:{quiet:35,loud:70},holdSync:{shortPhrase:.4,longPhrase:.8},angleSync:{modulation:"gradual"}}},dynamics:{forte:{distanceSync:{quiet:{multiplier:1.5},loud:{multiplier:1.8}},holdSync:{multiplier:1.2},accentResponse:{multiplier:1.6}},piano:{distanceSync:{quiet:{multiplier:.6},loud:{multiplier:.8}},holdSync:{multiplier:.8},accentResponse:{multiplier:1.1}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;let a=Math.atan2(h,n);const r={...this.config,...i}.angleSpread*Math.PI/180,o=(Math.random()-.5)*r;a+=o;const c=30+30*Math.random();t.gestureData.drift={startX:t.x,startY:t.y,originalVx:t.vx,originalVy:t.vy,baseOpacity:t.opacity||t.life||1,driftAngle:a,angleOffset:o,homeRadius:c*t.scaleFactor,homeX:e+Math.cos(a)*c,homeY:s+Math.sin(a)*c,role:Math.random(),turbulencePhase:Math.random()*Math.PI*2,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.drift?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.drift,r={...this.config,...e},o=e.strength||1,c=this.easeInOutCubic(i),l=Math.max(0,c-.1*a.role);let u,p,d;if(r.returnToOrigin)if(l<.4){const t=l/.4,i=this.easeOutQuad(t);u=a.startX+(a.homeX-a.startX)*i,p=a.startY+(a.homeY-a.startY)*i}else if(l<.6+r.holdTime){const i=(l-.4)/(.2+r.holdTime);d=a.homeRadius+Math.sin(i*Math.PI*.5)*r.distance*o*t.scaleFactor}else{const i=(l-.6-r.holdTime)/(.4-r.holdTime);d=a.homeRadius+Math.cos(i*Math.PI*.5)*r.distance*o*t.scaleFactor}else{const i=l;d=a.homeRadius+i*r.distance*o*t.scaleFactor}if(void 0!==d){a.turbulencePhase+=r.turbulence*s;const t=Math.sin(a.turbulencePhase)*r.turbulence*10,i=Math.cos(1.3*a.turbulencePhase)*r.turbulence*10,e=a.driftAngle+a.angleOffset;u=n+Math.cos(e)*d+t,p=h+Math.sin(e)*d+i}const m=r.smoothness+.08*a.role;if(t.x+=(u-t.x)*m,t.y+=(p-t.y)*m,t.vx=.25*(u-t.x),t.vy=.25*(p-t.y),r.fadeOut){let e;e=i<.25?.3+i/.25*.7:i<.75?.7+.3*Math.sin((i-.25)*Math.PI/.5):4*(1-i),t.opacity=a.baseOpacity*e,void 0!==t.life&&(t.life=t.opacity)}i>=.99&&(t.vx=.1*a.originalVx,t.vy=.1*a.originalVy,r.fadeOut&&(t.opacity=a.baseOpacity,void 0!==t.life&&(t.life=a.baseOpacity)))},cleanup(t){if(t.gestureData?.drift){const i=t.gestureData.drift;t.vx=i.originalVx,t.vy=i.originalVy,t.opacity=i.baseOpacity,void 0!==t.life&&(t.life=i.baseOpacity),delete t.gestureData.drift}},easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,easeOutQuad:t=>t*(2-t)},Lt={name:"flicker",emoji:"âš¡",type:"blending",description:"Rapid opacity changes with motion jitter",config:{duration:800,flickerRate:15,frequency:6,minOpacity:.3,maxOpacity:1,jitterAmount:2,colorShift:!1,strobe:!1,pulseMode:!1,groupFlicker:.3,easing:"linear",strength:.7,particleMotion:{type:"flicker",strength:.7,frequency:6}},rhythm:{enabled:!0,syncMode:"subdivision",rateSync:{subdivision:"sixteenth",onBeat:30,offBeat:10,triplet:20,curve:"step"},opacitySync:{pattern:"HLMH",subdivision:"eighth",onAccent:.1,regular:.5},jitterSync:{onBeat:5,offBeat:1,accent:10,curve:"random"},strobeSync:{verse:!1,chorus:!0,drop:"intense",pattern:"XOXO"},dynamics:{forte:{flickerRate:25,jitterAmount:5,minOpacity:.1},piano:{flickerRate:8,jitterAmount:1,minOpacity:.5}}},initialize(t,i){t.gestureData||(t.gestureData={});const e={...this.config,...i},s=Math.random()<e.groupFlicker;t.gestureData.flicker={baseOpacity:t.opacity||t.life||1,baseColor:t.color,baseX:t.x,baseY:t.y,flickerTimer:0,lastFlicker:0,flickerState:!0,isGrouped:s,groupId:s?Math.floor(3*Math.random()):-1,phase:Math.random()*Math.PI*2,colorHue:0,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.flicker?.initialized||this.initialize(t,e);const a=t.gestureData.flicker,r={...this.config,...e},o=e.strength||1;let c;if(a.flickerTimer+=s*r.flickerRate,r.strobe)c=(a.flickerTimer+a.phase)%1<.5?1:r.minOpacity;else if(r.pulseMode){const t=a.flickerTimer+a.phase;c=r.minOpacity+(r.maxOpacity-r.minOpacity)*(.5*Math.sin(t)+.5)}else{if(a.flickerTimer-a.lastFlicker>1)if(a.lastFlicker=a.flickerTimer,a.isGrouped){const t=Math.floor(a.flickerTimer)%3;a.flickerState=t===a.groupId}else a.flickerState=Math.random()>.3;const i=a.flickerState?r.maxOpacity:r.minOpacity+.3*Math.random(),e=t.opacity/a.baseOpacity;c=e+.3*(i-e)}const l=a.baseOpacity*(1+(c-1)*o);if(t.opacity=Math.max(0,Math.min(1,l)),void 0!==t.life&&(t.life=t.opacity),r.jitterAmount>0&&c>r.minOpacity){const i=r.jitterAmount*o*t.scaleFactor,e=(Math.random()-.5)*i*c,n=(Math.random()-.5)*i*c;t.vx+=.1*e*s,t.vy+=.1*n*s}if(r.colorShift&&t.color){a.colorHue+=.01*s;const i=30*Math.sin(a.colorHue);t.color=this.shiftHue(a.baseColor,i*o)}let u=1;i<.1?u=i/.1:i>.9&&(u=(1-i)/.1),t.opacity*=u,void 0!==t.life&&(t.life=t.opacity),i>.8&&(t.vx*=.95,t.vy*=.95)},shiftHue(t,i){if(!t||!t.startsWith("#"))return t;const e=t.slice(1),s=parseInt(e.substr(0,2),16)/255,n=parseInt(e.substr(2,2),16)/255,h=parseInt(e.substr(4,2),16)/255,a=i*Math.PI/180,r=Math.cos(a),o=Math.sin(a),c=s*o+n*r,l=h,u=t=>Math.max(0,Math.min(255,Math.round(255*t))).toString(16).padStart(2,"0");return`#${u(s*r-n*o)}${u(c)}${u(l)}`},cleanup(t){if(t.gestureData?.flicker){const i=t.gestureData.flicker;t.opacity=i.baseOpacity,t.color=i.baseColor,void 0!==t.life&&(t.life=i.baseOpacity),delete t.gestureData.flicker}}},Vt={name:"burst",emoji:"ðŸ’¥",type:"blending",description:"Explosive outward burst from center",config:{decay:.5,strength:2},rhythm:{enabled:!0,syncMode:"beat",strengthSync:{onBeat:3.5,offBeat:1,curve:"explosion"},decaySync:{mode:"tempo",fast:.8,slow:.3,curve:"exponential"},durationSync:{mode:"beats",beats:.5,sustain:!1},accentResponse:{enabled:!0,multiplier:2.5,type:"strength"},patternOverrides:{rock:{strengthSync:{onBeat:4,offBeat:1.5},decaySync:{fast:.6,slow:.4}},electronic:{strengthSync:{onBeat:3.8,offBeat:.8,curve:"sharp"},decaySync:{fast:.9,slow:.7}},jazz:{strengthSync:{onBeat:2.8,offBeat:1.8,swing:!0},decaySync:{fast:.5,slow:.2}},orchestral:{strengthSync:{onBeat:3.2,offBeat:.5},accentResponse:{multiplier:3}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:2},offBeat:{multiplier:1.5}},decaySync:{multiplier:.7},accentResponse:{multiplier:3.5}},piano:{strengthSync:{onBeat:{multiplier:.6},offBeat:{multiplier:.3}},decaySync:{multiplier:1.3},accentResponse:{multiplier:1.8}}}},apply(t,i,e,s,n,h){const a=e.decay||this.config.decay,r=(e.strength||this.config.strength)*(1-i*a),o=t.x-n,c=t.y-h,l=Math.sqrt(o*o+c*c);l>1&&(t.vx+=o/l*r*2*s,t.vy+=c/l*r*2*s)}},Ht={name:"directional",emoji:"âž¡ï¸",type:"blending",description:"Move particles in a specific direction",config:{angle:0,returnToOrigin:!1,strength:1},rhythm:{enabled:!0,syncMode:"flow",angleSync:{verse:0,chorus:90,bridge:180,outro:270,transition:"smooth"},strengthSync:{onBeat:1.8,offBeat:.6,curve:"wave"},returnSync:{enabled:!0,onSectionChange:!0,duration:"transition",strength:1.2},accentResponse:{enabled:!0,multiplier:2,type:"strength"},patternOverrides:{march:{angleSync:{verse:0,chorus:0},strengthSync:{onBeat:2.5,offBeat:1}},waltz:{angleSync:{verse:45,chorus:135,bridge:225,outro:315,transition:"circular"}},swing:{strengthSync:{onBeat:1.6,offBeat:1.4,swing:!0}},electronic:{angleSync:{transition:"instant"},strengthSync:{onBeat:2.2,offBeat:.4,curve:"sharp"}}},dynamics:{forte:{strengthSync:{onBeat:{multiplier:1.6},offBeat:{multiplier:1.2}},angleSync:{transition:"sharp"},accentResponse:{multiplier:2.5}},piano:{strengthSync:{onBeat:{multiplier:.7},offBeat:{multiplier:.8}},angleSync:{transition:"gradual"},accentResponse:{multiplier:1.4}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.directional={initialX:t.x,initialY:t.y}},apply(t,i,e,s,n,h){t.gestureData?.directional||this.initialize(t);const a=(e.angle||this.config.angle)*Math.PI/180,r=e.strength||this.config.strength;if(t.vx+=Math.cos(a)*r*.3*s,t.vy+=Math.sin(a)*r*.3*s,e.returnToOrigin&&i>.5){const e=2*(i-.5),n=t.gestureData.directional,h=n.initialX-t.x,a=n.initialY-t.y;t.vx+=h*e*.02*s,t.vy+=a*e*.02*s}}},_t={name:"settle",emoji:"ðŸƒ",type:"blending",description:"Gradually settle particles to rest",config:{damping:.02,threshold:.01},rhythm:{enabled:!0,syncMode:"resolution",dampingSync:{onResolution:.035,onTension:.015,curve:"gradual"},thresholdSync:{mode:"dynamics",forte:.02,piano:.005,curve:"exponential"},durationSync:{mode:"phrase",minBeats:2,maxBeats:12,sustain:!0},cadenceResponse:{enabled:!0,multiplier:1.6,type:"damping"},patternOverrides:{ambient:{dampingSync:{onResolution:.025,onTension:.008,curve:"atmospheric"},durationSync:{minBeats:8,maxBeats:32}},jazz:{dampingSync:{onResolution:.04,onTension:.02},cadenceResponse:{multiplier:1.8}},classical:{dampingSync:{onResolution:.045,onTension:.012,curve:"expressive"},cadenceResponse:{multiplier:2}},minimalist:{dampingSync:{onResolution:.02,onTension:.005},durationSync:{minBeats:16,maxBeats:64}}},dynamics:{forte:{dampingSync:{onResolution:{multiplier:1.4},onTension:{multiplier:.8}},thresholdSync:{multiplier:2},cadenceResponse:{multiplier:2.2}},piano:{dampingSync:{onResolution:{multiplier:.7},onTension:{multiplier:1.2}},thresholdSync:{multiplier:.5},cadenceResponse:{multiplier:1.3}}}},apply(t,i,e,s,n,h){const a=e.damping||this.config.damping,r=e.threshold||this.config.threshold;t.vx*=Math.max(0,1-a*s*60),t.vy*=Math.max(0,1-a*s*60),Math.abs(t.vx)<r&&(t.vx=0),Math.abs(t.vy)<r&&(t.vy=0)}},Xt={name:"fade",emoji:"ðŸ‘»",type:"blending",description:"Fade particle opacity",config:{fadeIn:!1,fadeOut:!0,minOpacity:0,maxOpacity:1},rhythm:{enabled:!0,syncMode:"dynamic",opacitySync:{onBeat:.9,offBeat:.3,subdivision:"eighth",curve:"exponential"},fadePhaseSync:{verse:{fadeIn:!0,fadeOut:!1},chorus:{fadeIn:!1,fadeOut:!1},bridge:{fadeIn:!0,fadeOut:!0},outro:{fadeIn:!1,fadeOut:!0}},pulseSync:{enabled:!0,frequency:"quarter",intensity:.2,onAccent:.4},dynamics:{forte:{minOpacity:.5,maxOpacity:1},piano:{minOpacity:0,maxOpacity:.4}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.fade={baseOpacity:t.opacity||t.life||1}},apply(t,i,e,s,n,h){t.gestureData?.fade||this.initialize(t);const a=t.gestureData.fade,r={...this.config,...e};let o;o=r.fadeIn&&!r.fadeOut?r.minOpacity+(r.maxOpacity-r.minOpacity)*i:r.fadeOut&&!r.fadeIn?r.maxOpacity-(r.maxOpacity-r.minOpacity)*i:i<.5?r.minOpacity+(r.maxOpacity-r.minOpacity)*(2*i):r.maxOpacity-(r.maxOpacity-r.minOpacity)*(2*(i-.5)),t.opacity=a.baseOpacity*o,void 0!==t.life&&(t.life=t.opacity)},cleanup(t){t.gestureData?.fade&&(t.opacity=t.gestureData.fade.baseOpacity,void 0!==t.life&&(t.life=t.opacity),delete t.gestureData.fade)}},Yt={name:"hold",emoji:"â¸ï¸",type:"override",description:"Hold particles in current position",config:{holdStrength:.95,allowDrift:!1},rhythm:{enabled:!0,syncMode:"rest",holdSync:{onRest:.98,onSound:.8,curve:"immediate"},durationSync:{mode:"rests",minBeats:.5,maxBeats:8,sustain:!0},pauseResponse:{enabled:!0,multiplier:1.5,type:"strength"},patternOverrides:{classical:{holdSync:{onRest:.99,onSound:.75,curve:"dramatic"},pauseResponse:{multiplier:2}},minimal:{holdSync:{onRest:.95,onSound:.85},durationSync:{minBeats:2,maxBeats:16}},jazz:{holdSync:{onRest:.9,onSound:.7},allowDrift:!0},electronic:{holdSync:{onRest:.99,onSound:.6,curve:"digital"},pauseResponse:{multiplier:1.2}}},dynamics:{forte:{holdSync:{onRest:{multiplier:1.02},onSound:{multiplier:.9}},pauseResponse:{multiplier:2.2}},piano:{holdSync:{onRest:{multiplier:.97},onSound:{multiplier:.85}},pauseResponse:{multiplier:1.3}}}},initialize(t){t.gestureData||(t.gestureData={}),t.gestureData.hold={holdX:t.x,holdY:t.y,originalVx:t.vx,originalVy:t.vy}},apply(t,i,e,s,n,h){t.gestureData?.hold||this.initialize(t);const a=t.gestureData.hold,r=e.holdStrength||this.config.holdStrength;if(e.allowDrift?(t.vx*=r,t.vy*=r):(t.x+=(a.holdX-t.x)*(1-r),t.y+=(a.holdY-t.y)*(1-r),t.vx=0,t.vy=0),i>.9){const e=10*(i-.9);t.vx=t.vx*(1-e)+a.originalVx*e,t.vy=t.vy*(1-e)+a.originalVy*e}},cleanup(t){if(t.gestureData?.hold){const i=t.gestureData.hold;t.vx=i.originalVx,t.vy=i.originalVy,delete t.gestureData.hold}}},Ut={name:"breathe",emoji:"ðŸ«",type:"blending",description:"Breathing rhythm with inhale and exhale",config:{musicalDuration:{musical:!0,bars:1,minBeats:2,maxBeats:16},phases:[{name:"inhale",beats:1.5},{name:"hold_in",beats:.5},{name:"exhale",beats:1.5},{name:"hold_out",beats:.5}],inhaleRadius:1.5,exhaleRadius:.3,breathRate:.3,spiralStrength:.002,scaleAmount:.25,glowAmount:.4,frequency:1,easing:"sine",strength:.8,particleMotion:{type:"breathe",strength:.8,inhaleRadius:1.5,exhaleRadius:.3}},rhythm:{enabled:!0,syncMode:"phrase",breathRateSync:{mode:"tempo",bpm:"auto",subdivision:"whole",curve:"sine"},radiusSync:{inhale:{onUpbeat:1.8,onDownbeat:1.4,curve:"ease-in"},exhale:{onUpbeat:.2,onDownbeat:.4,curve:"ease-out"}},durationSync:{mode:"phrases",phrases:2,hold:"fermata"},accentResponse:{enabled:!0,multiplier:1.5,type:"expansion"},patternOverrides:{ballad:{breathRateSync:{subdivision:"double-whole"},radiusSync:{inhale:{onUpbeat:2.2,onDownbeat:1.8},exhale:{onUpbeat:.1,onDownbeat:.2}}},uptempo:{breathRateSync:{subdivision:"half"},radiusSync:{inhale:{onUpbeat:1.4,onDownbeat:1.2},exhale:{onUpbeat:.3,onDownbeat:.4}}},ambient:{breathRateSync:{subdivision:"whole",curve:"ease"},radiusSync:{inhale:{onUpbeat:1.6,onDownbeat:1.6},exhale:{onUpbeat:.2,onDownbeat:.2}}}},dynamics:{forte:{radiusSync:{inhale:{multiplier:1.8},exhale:{multiplier:.5}},spiralStrength:.004,scaleAmount:.4},piano:{radiusSync:{inhale:{multiplier:1.2},exhale:{multiplier:.8}},spiralStrength:.001,scaleAmount:.1}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;t.gestureData.breathe={startX:t.x,startY:t.y,angle:Math.atan2(h,n),baseRadius:Math.sqrt(n*n+h*h),phaseOffset:.2*Math.random()-.1}},apply(t,i,e,s,n,h){t.gestureData?.breathe||this.initialize(t,e,n,h);const a={...this.config,...e},r=(Math.sin(i*Math.PI*2*a.breathRate)+1)/2,o=100*(t.scaleFactor||1),c=a.inhaleRadius*o,l=a.exhaleRadius*o,u=l+(c-l)*r,p=t.x-n,d=t.y-h,m=Math.sqrt(p*p+d*d),f=u-m,g=.05*(e.strength||.8)*s;if(m>0){const i=p/m*f*g,n=d/m*f*g;t.vx+=i,t.vy+=n;const h=a.spiralStrength*s*(e.strength||1),o=-d/m,c=p/m;t.vx+=o*h*r,t.vy+=c*h*r}t.vx*=.98,t.vy*=.98},cleanup(t){t.gestureData?.breathe&&delete t.gestureData.breathe}},Wt={name:"expand",emoji:"ðŸ’«",type:"blending",description:"Radial expansion from center",config:{duration:600,scaleAmount:3,scaleTarget:3,glowAmount:.5,easing:"back",strength:3,particleMotion:{type:"pulse",strength:3,direction:"outward",persist:!0}},rhythm:{enabled:!0,syncMode:"crescendo",strengthSync:{pianissimo:1.5,fortissimo:5,crescendo:"build",sforzando:"burst"},scaleTargetSync:{verse:2,chorus:4.5,climax:6,curve:"exponential"},durationSync:{mode:"phrases",build:1.2,release:.8,sustain:"hold"},accentResponse:{enabled:!0,multiplier:2.8,type:"strength"},patternOverrides:{orchestral:{strengthSync:{pianissimo:2,fortissimo:6.5,crescendo:"dramatic"},scaleTargetSync:{climax:8}},rock:{strengthSync:{pianissimo:1.8,fortissimo:5.5,curve:"power"},accentResponse:{multiplier:3.2}},ambient:{strengthSync:{pianissimo:1.2,fortissimo:3.5,crescendo:"organic"},durationSync:{build:1.8,release:1.2}},electronic:{strengthSync:{pianissimo:1.6,fortissimo:4.8,curve:"digital"},scaleTargetSync:{curve:"linear"}}},dynamics:{forte:{strengthSync:{pianissimo:{multiplier:1.4},fortissimo:{multiplier:1.8}},scaleTargetSync:{multiplier:1.6},accentResponse:{multiplier:3.5}},piano:{strengthSync:{pianissimo:{multiplier:.8},fortissimo:{multiplier:1.2}},scaleTargetSync:{multiplier:.7},accentResponse:{multiplier:2}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;t.gestureData.expand={startX:t.x,startY:t.y,angle:Math.atan2(h,n),baseRadius:Math.sqrt(n*n+h*h),initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.expand?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.expand,r={...this.config,...e},o=r.strength||1,c=1+(r.scaleTarget-1)*i*o,l=a.baseRadius*c,u=n+Math.cos(a.angle)*l,p=h+Math.sin(a.angle)*l,d=u-t.x,m=p-t.y;t.vx+=.8*d*s,t.vy+=.8*m*s,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.expand&&delete t.gestureData.expand}},Nt={name:"contract",emoji:"ðŸŒ€",type:"blending",description:"Radial contraction toward center",config:{duration:600,scaleAmount:.2,scaleTarget:.2,glowAmount:-.2,easing:"cubic",strength:2.5,particleMotion:{type:"pulse",strength:2.5,direction:"inward",persist:!0}},rhythm:{enabled:!0,syncMode:"tension",strengthSync:{onTension:4,onRelease:1.5,curve:"magnetic"},scaleTargetSync:{forte:.1,piano:.4,crescendo:"gradual",diminuendo:"ease"},durationSync:{mode:"phrases",shortPhrase:.8,longPhrase:1.5,hold:"sustain"},accentResponse:{enabled:!0,multiplier:2.2,type:"strength"},patternOverrides:{classical:{strengthSync:{onTension:3.5,onRelease:1.8},scaleTargetSync:{forte:.15,piano:.35}},metal:{strengthSync:{onTension:5,onRelease:2,curve:"sharp"},scaleTargetSync:{forte:.05,piano:.25}},ambient:{strengthSync:{onTension:2.8,onRelease:1.2,curve:"ease"},durationSync:{shortPhrase:1.2,longPhrase:2}},trap:{strengthSync:{onTension:4.5,onRelease:1,dropBeat:6},scaleTargetSync:{forte:.08,piano:.3}}},dynamics:{forte:{strengthSync:{onTension:{multiplier:1.8},onRelease:{multiplier:1.4}},scaleTargetSync:{multiplier:.6},accentResponse:{multiplier:2.8}},piano:{strengthSync:{onTension:{multiplier:.7},onRelease:{multiplier:.8}},scaleTargetSync:{multiplier:1.4},accentResponse:{multiplier:1.6}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={});const n=t.x-e,h=t.y-s;t.gestureData.contract={startX:t.x,startY:t.y,angle:Math.atan2(h,n),baseRadius:Math.sqrt(n*n+h*h),initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.contract?.initialized||this.initialize(t,e,n,h);const a=t.gestureData.contract,r={...this.config,...e},o=r.strength||1,c=1-(1-r.scaleTarget)*i*o,l=a.baseRadius*c,u=n+Math.cos(a.angle)*l,p=h+Math.sin(a.angle)*l,d=u-t.x,m=p-t.y;t.vx+=.5*d*s,t.vy+=.5*m*s,t.vx*=.95,t.vy*=.95},cleanup(t){t.gestureData?.contract&&delete t.gestureData.contract}},Qt={name:"flash",emoji:"âš¡",type:"blending",description:"Bright flash burst effect",config:{duration:400,glowAmount:2.5,glowPeak:3,scalePeak:1.1,easing:"cubic",strength:1,particleMotion:{type:"burst",strength:1,decay:.3}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"immediate",interruptible:!0,priority:8,blendable:!0,intensitySync:{onBeat:3.5,offBeat:1,accent:5,subdivision:"quarter",curve:"exponential"},durationSync:{mode:"tempo",baseDuration:400,scaling:"inverse"},scaleSync:{onBeat:1.2,offBeat:1,accent:1.4,curve:"elastic"},strobeSync:{enabled:!1,pattern:"XXOX",subdivision:"sixteenth"},dynamics:{forte:{glowPeak:4,scalePeak:1.3,duration:300},piano:{glowPeak:2,scalePeak:1.05,duration:500}}},initialize(t,i){t.gestureData||(t.gestureData={}),t.gestureData.flash={originalOpacity:t.opacity,originalSize:t.size,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.flash?.initialized||this.initialize(t,e);const a=t.gestureData.flash,r={...this.config,...e},o=r.strength||1;let c;if(c=i<.3?i/.3*r.glowPeak:r.glowPeak*(1-(i-.3)/.7),t.opacity=Math.min(1,a.originalOpacity*(1+c*o)),t.size=a.originalSize*(1+(r.scalePeak-1)*c*o*.1),i<.2){const e=(1-i/.2)*o,a=Math.atan2(t.y-h,t.x-n);t.vx+=Math.cos(a)*e*2*s,t.vy+=Math.sin(a)*e*2*s}t.vx*=1-.1*r.particleMotion.decay,t.vy*=1-.1*r.particleMotion.decay},cleanup(t){t.gestureData?.flash&&(t.opacity=t.gestureData.flash.originalOpacity,t.size=t.gestureData.flash.originalSize,delete t.gestureData.flash)}},Jt={name:"glow",emoji:"âœ¨",type:"blending",description:"Pure luminous glow without movement",config:{duration:1500,amplitude:0,frequency:1,holdPeak:.3,easing:"sine",scaleAmount:.1,glowAmount:.8,strength:0,direction:"none",particleMotion:{type:"glow",strength:0,direction:"none",frequency:1}},rhythm:{enabled:!0,syncMode:"phrase",amplitudeSync:{onBeat:2,offBeat:1.2,curve:"smooth"},frequencySync:{mode:"phrase",subdivision:"bar"},durationSync:{mode:"bars",bars:2},accentResponse:{enabled:!0,multiplier:2.5},patternOverrides:{ambient:{amplitudeSync:{onBeat:2.5,offBeat:1.8},durationSync:{bars:4}},electronic:{amplitudeSync:{onBeat:3,offBeat:.5,curve:"sharp"},frequencySync:{subdivision:"quarter"}}}},initialize(t,i,e,s){t.gestureData||(t.gestureData={}),t.gestureData.glow={startOpacity:t.opacity,startGlow:t.glowSizeMultiplier||0,initialized:!0}},apply(t,i,e,s,n,h){t.gestureData?.glow?.initialized||this.initialize(t,e,n,h);const a={...this.config,...e},r=this.easeInOutSine(i);let o,{frequency:c}=a,{glowAmount:l}=a;e.rhythmModulation&&(l*=e.rhythmModulation.amplitudeMultiplier||1,l*=e.rhythmModulation.accentMultiplier||1,e.rhythmModulation.frequencyMultiplier&&(c*=e.rhythmModulation.frequencyMultiplier));const u=r*c*2%2;o=a.holdPeak>0&&u>1-a.holdPeak&&u<1+a.holdPeak?1:Math.sin(r*Math.PI*2*c);let p=1;i>.9&&(p=.5+.5*(1-10*(i-.9))),t.glowIntensity=1+o*l*p},cleanup(t){t.gestureData?.glow&&(t.glowIntensity=1,delete t.gestureData.glow)},easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2},Zt={name:"peek",emoji:"ðŸ‘€",type:"effect",description:"Quick peek and hide motion",config:{peekDistance:40,peekSpeed:.15,holdDuration:200,hideSpeed:.25,stagger:!0,duration:1500},rhythm:{enabled:!0,syncMode:"accent",distanceSync:{onAccent:60,offAccent:25,curve:"quick"},speedSync:{mode:"tempo",fast:.25,slow:.1,hideMultiplier:1.8},durationSync:{mode:"subdivision",beats:.25,staggerBeats:.125,sustain:!1},syncopationResponse:{enabled:!0,multiplier:1.8,type:"distance"},patternOverrides:{funk:{distanceSync:{onAccent:70,offAccent:35,curve:"funky"},syncopationResponse:{multiplier:2.2}},latin:{speedSync:{fast:.3,slow:.12},durationSync:{beats:.5,staggerBeats:.25}},breakbeat:{distanceSync:{onAccent:55,offAccent:40},syncopationResponse:{multiplier:2.5}},classical:{distanceSync:{onAccent:45,offAccent:20,curve:"elegant"},speedSync:{fast:.18,slow:.08}}},dynamics:{forte:{distanceSync:{onAccent:{multiplier:1.6},offAccent:{multiplier:1.3}},speedSync:{multiplier:1.4},syncopationResponse:{multiplier:2.8}},piano:{distanceSync:{onAccent:{multiplier:.6},offAccent:{multiplier:.4}},speedSync:{multiplier:.7},syncopationResponse:{multiplier:1.2}}}},apply(t,i,e,s,n,h){if(t.gestureData||(t.gestureData={}),!t.gestureData.peek){const i=t.x-n,e=t.y-h,s=Math.atan2(e,i),a=Math.sqrt(i*i+e*e);t.gestureData.peek={originalX:t.x,originalY:t.y,peekAngle:s,originalDistance:a,staggerDelay:this.config.stagger?.3*Math.random():0,phase:"waiting",phaseTimer:0,peekOffset:{x:0,y:0}}}const a=t.gestureData.peek,{config:r}=this,o=Math.max(0,Math.min(1,(i-a.staggerDelay)/(1-a.staggerDelay)));0===o?a.phase="waiting":o<.3?a.phase="peeking":o<.6?a.phase="holding":o<1&&(a.phase="hiding");let c=0;switch(a.phase){case"peeking":{const t=o/.3;c=this.easeOutCubic(t)*r.peekDistance;break}case"holding":c=r.peekDistance,Math.random()<.1&&(a.peekOffset.x+=2*(Math.random()-.5),a.peekOffset.y+=2*(Math.random()-.5));break;case"hiding":{const t=(o-.6)/.4;c=(1-this.easeInCubic(t))*r.peekDistance;break}}if("waiting"!==a.phase){const i=Math.cos(a.peekAngle)*c,e=Math.sin(a.peekAngle)*c;a.peekOffset.x+=(i-a.peekOffset.x)*r.peekSpeed,a.peekOffset.y+=(e-a.peekOffset.y)*r.peekSpeed,t.x=a.originalX+a.peekOffset.x,t.y=a.originalY+a.peekOffset.y}void 0!==t.alpha&&("peeking"===a.phase||"holding"===a.phase?t.alpha=.7+.3*Math.random():t.alpha=1)},easeOutCubic:t=>1-Math.pow(1-t,3),easeInCubic:t=>t*t*t,cleanup(t){t.gestureData?.peek&&(t.x=t.gestureData.peek.originalX,t.y=t.gestureData.peek.originalY,void 0!==t.alpha&&(t.alpha=1),delete t.gestureData.peek)}};const Kt=(t,i="âœ¨")=>({name:t,emoji:i,type:"blending",description:`${t} animation`,config:{duration:1e3,musicalDuration:{musical:!0,beats:2}},rhythm:{enabled:!0,syncMode:"beat",timingSync:"nextBeat",durationSync:{mode:"beats",beats:2},interruptible:!0,priority:3,blendable:!0,crossfadePoint:"anyBeat",maxQueue:3},apply:(t,i,e)=>!1,blend:(t,i,e)=>!1}),ti=Kt("sparkle","âœ¨"),ii=Kt("wiggle","ã€°ï¸"),ei=Kt("groove","ðŸŽµ"),si=Kt("point","ðŸ‘‰"),ni=Kt("lean","â†—ï¸"),hi=Kt("reach","ðŸ¤š"),ai=Kt("headBob","ðŸŽ§"),ri={};function oi(t){if(ri[t])return ri[t];return Mt(t)||null}[wt,vt,St,Ft,kt,xt,Bt,Pt,Ct,At,ti,{name:"shimmer",emoji:"ðŸŒŸ",type:"particle",description:"Shimmer effect with sparkling particles",config:{duration:2e3,musicalDuration:{musical:!0,bars:1},particleMotion:"radiant"},rhythm:{enabled:!0,syncType:"beat",durationSync:{mode:"bars",bars:1},intensity:.8},override:(t,i,e)=>(t.shimmerEffect=!0,t.shimmerProgress=i,!0),blend:(t,i,e)=>!1},ii,ei,si,ni,hi,ai,{name:"rain",emoji:"ðŸŒ§ï¸",type:"particle",description:"Rain effect with falling particles",config:{duration:3e3,musicalDuration:{musical:!0,bars:2},particleMotion:"falling"},rhythm:{enabled:!0,syncType:"off-beat",durationSync:{mode:"bars",bars:2},intensity:.8},apply:(t,i,e)=>(t.rainEffect=!0,t.rainProgress=i,!0),blend:(t,i,e)=>!1},Tt,Ot,Rt,zt,Et,qt,Dt,It,jt,$t,Gt,Lt,Vt,Ht,_t,Xt,Yt,Ut,Wt,Nt,Qt,Jt,Zt,{name:"runningman",emoji:"ðŸƒ",type:"effect",description:"Hip-hop running man shuffle",config:{duration:2e3,slideDistance:30,stepHeight:15,speed:1.2,strength:.8,particleMotion:{type:"runningman",strength:.7}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:1,accentBeats:[1,3]},apply:(t,i,e,s,n,h)=>!1,blend:(t,i,e)=>!1},{name:"charleston",emoji:"ðŸ•º",type:"effect",description:"Hip-hop Charleston shuffle with crisscross",config:{duration:2500,kickDistance:35,swivelRange:40,bounceHeight:12,strength:.9,particleMotion:{type:"charleston",strength:.8}},rhythm:{enabled:!0,syncToBeat:!0,beatMultiplier:2,accentBeats:[1,2.5,3,4.5]},apply:(t,i,e,s,n,h)=>!1,blend:(t,i,e)=>!1}].forEach(t=>{ri[t.name]=t});const ci=new class{constructor(){this.bpm=120,this.timeSignature=[4,4],this.isPlaying=!1,this.startTime=0,this.currentBeat=0,this.currentBar=0,this.beatProgress=0,this.barProgress=0,this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.lastBeatTime=0,this.nextBeatTime=0,this.listeners=new Map,this.beatCallbacks=new Set,this.barCallbacks=new Set,this.subdivisions={sixteenth:0,eighth:0,triplet:0,swing:0},this.audioSync=null,this.syncOffset=0,this.autoSync=!1,this.intensity=1,this.groove=0,this.humanize=.05,this.patterns=new Map,this.currentPattern=null,this.initializePatterns()}initializePatterns(){this.patterns.set("4/4",{name:"4/4",description:"Common time - 4 beats per bar",timeSignature:[4,4],groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("straight",{name:"straight",description:"Straight, even timing",groove:0,accents:[1,.5,.7,.5]}),this.patterns.set("swing",{name:"swing",description:"Swing/shuffle timing",groove:.67,accents:[1,.3,.8,.3]}),this.patterns.set("3/4",{name:"3/4",description:"Waltz time - 3 beats per bar",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("waltz",{name:"waltz",description:"3/4 waltz timing",timeSignature:[3,4],accents:[1,.5,.5]}),this.patterns.set("6/8",{name:"6/8",description:"Compound duple time",timeSignature:[6,8],accents:[1,.3,.3,.7,.3,.3]}),this.patterns.set("5/4",{name:"5/4",description:"Complex meter - 5 beats per bar",timeSignature:[5,4],accents:[1,.5,.6,.5,.7]}),this.patterns.set("7/8",{name:"7/8",description:"Irregular meter",timeSignature:[7,8],accents:[1,.5,.5,.7,.5,.5,.6]}),this.patterns.set("dubstep",{name:"dubstep",description:"Dubstep half-time feel",accents:[.2,.2,1,.2],subdivisions:{wobble:!0}}),this.patterns.set("breakbeat",{name:"breakbeat",description:"Broken beat pattern",accents:[1,.2,.7,.9,.2,.8,.4,.2]})}start(){this.isPlaying||(this.isPlaying=!0,this.isRunning=!0,this.startTime=performance.now(),this.lastBeatTime=this.startTime,this.nextBeatTime=this.startTime+this.beatDuration,this.currentBeat=0,this.currentBar=0,this.emit("start",{bpm:this.bpm,timeSignature:this.timeSignature,pattern:this.currentPattern}),this.update())}stop(){this.isPlaying&&(this.isPlaying=!1,this.emit("stop",{totalBeats:this.currentBeat,totalBars:this.currentBar}))}update(){if(!this.isPlaying)return;const t=(performance.now()-this.startTime)/this.beatDuration,i=Math.floor(t);this.beatProgress=t%1,i>this.currentBeat&&this.onBeat(i);const e=Math.floor(i/this.timeSignature[0]);e>this.currentBar&&this.onBar(e),this.currentBeat=i,this.currentBar=e,this.barProgress=i%this.timeSignature[0]/this.timeSignature[0],this.updateSubdivisions(),this.emit("update",this.getTimeInfo()),this.isPlaying&&requestAnimationFrame(()=>this.update())}onBeat(t){const i=t%this.timeSignature[0],e=this.getAccent(i),s=this.humanize*(Math.random()-.5)*this.beatDuration,n={beat:t,beatInBar:i,bar:this.currentBar,accent:e,intensity:this.intensity*e,humanTiming:s,timestamp:performance.now()};this.emit("beat",n),this.beatCallbacks.forEach(t=>t(n)),this.lastBeatTime=performance.now(),this.nextBeatTime=this.lastBeatTime+this.beatDuration}onBar(t){const i={bar:t,timeSignature:this.timeSignature,pattern:this.currentPattern,timestamp:performance.now()};this.emit("bar",i),this.barCallbacks.forEach(t=>t(i))}updateSubdivisions(){if(this.subdivisions.sixteenth=4*this.beatProgress%1,this.subdivisions.eighth=2*this.beatProgress%1,this.subdivisions.triplet=3*this.beatProgress%1,this.groove>0){const t=.5+.17*this.groove;this.subdivisions.eighth<.5?this.subdivisions.swing=this.subdivisions.eighth/t:this.subdivisions.swing=.5+(this.subdivisions.eighth-.5)/(1-t)}else this.subdivisions.swing=this.subdivisions.eighth}getAccent(t){if(this.currentPattern&&this.patterns.has(this.currentPattern)){const i=this.patterns.get(this.currentPattern);if(i.accents&&void 0!==i.accents[t])return i.accents[t]}return 0===t?1:2===t&&4===this.timeSignature[0]?.7:.5}getTimeInfo(){return{elapsed:performance.now()-this.startTime,beat:this.currentBeat,bar:this.currentBar,beatInBar:this.currentBeat%this.timeSignature[0],beatProgress:this.beatProgress,barProgress:this.barProgress,subdivisions:{...this.subdivisions},bpm:this.bpm,beatDuration:this.beatDuration,timeSignature:[...this.timeSignature],intensity:this.intensity,groove:this.groove,pattern:this.currentPattern,nextBeatIn:this.nextBeatTime-performance.now(),accent:this.getAccent(this.currentBeat%this.timeSignature[0])}}setBPM(t){this.bpm=Math.max(20,Math.min(360,t)),this.beatDuration=6e4/this.bpm,this.barDuration=this.beatDuration*this.timeSignature[0],this.emit("tempoChange",{bpm:this.bpm})}setTimeSignature(t,i){this.timeSignature=[t,i],this.barDuration=this.beatDuration*t,this.emit("timeSignatureChange",{timeSignature:this.timeSignature})}setPattern(t){if(!this.patterns.has(t))return;const i=this.patterns.get(t);this.currentPattern=t,i.timeSignature&&this.setTimeSignature(...i.timeSignature),void 0!==i.groove&&(this.groove=i.groove),this.emit("patternChange",{pattern:t})}onBeatCallback(t){return this.beatCallbacks.add(t),()=>this.beatCallbacks.delete(t)}onBarCallback(t){return this.barCallbacks.add(t),()=>this.barCallbacks.delete(t)}emit(t,i){this.listeners.has(t)&&this.listeners.get(t).forEach(t=>t(i))}on(t,i){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(i),()=>{this.listeners.has(t)&&this.listeners.get(t).delete(i)}}syncToAudio(t,i){this.audioSync={context:t,source:i}}getAdapter(){return{getTimeInfo:()=>this.getTimeInfo(),isOnBeat:(t=.1)=>this.beatProgress<t||this.beatProgress>1-t,isOnSubdivision:(t,i=.1)=>{const e=this.subdivisions[t]||0;return e<i||e>1-i},getBeatSync:(t=0,i=1,e="linear")=>{let s=this.beatProgress;switch(e){case"ease":s=.5-Math.cos(s*Math.PI)/2;break;case"bounce":s=Math.abs(Math.sin(s*Math.PI));break;case"pulse":s=Math.pow(Math.sin(s*Math.PI),2)}return t+(i-t)*s},getAccentedValue:(t,i=2)=>t*(1+(this.getAccent(this.currentBeat%this.timeSignature[0])-.5)*i),onBeat:t=>this.onBeatCallback(t),onBar:t=>this.onBarCallback(t),beatsToMs:t=>t*this.beatDuration,msToBeats:t=>t/this.beatDuration,isPlaying:()=>this.isPlaying,getBPM:()=>this.bpm,getPattern:()=>this.currentPattern}}},li=new class{constructor(){this.enabled=!1,this.adapter=null,this.subsystemConfigs=new Map,this.activeModulations=new Map}initialize(){this.adapter=ci.getAdapter(),this.enabled=!0,this.adapter.onBeat(this.handleBeat.bind(this)),this.adapter.onBar(this.handleBar.bind(this))}updateBPM(t){if(t>=60&&t<=220){if(window.rhythmManuallyStoppedForCurrentAudio)return;if(!ci.isRunning)return this.start(t,"straight"),void(window.rhythmSyncVisualizer&&!window.rhythmSyncVisualizer.state.active&&window.rhythmSyncVisualizer.start());ci.setBPM(t)}}registerConfig(t,i,e){if(!e.rhythm||!e.rhythm.enabled)return;const s=`${t}:${i}`;this.subsystemConfigs.set(s,{type:t,name:i,rhythmConfig:e.rhythm,originalConfig:e})}applyGestureRhythm(t,i,e,s){if(!this.enabled||!t.rhythm?.enabled)return{};this.adapter.getTimeInfo();const n=t.rhythm,h={};if(n.amplitudeSync){const t=n.amplitudeSync,i=this.adapter.getBeatSync(t.offBeat||.8,t.onBeat||1.5,t.curve||"linear");h.amplitudeMultiplier=i}if(n.wobbleSync){const t=n.wobbleSync;this.adapter.isOnSubdivision(t.subdivision,.1)?h.wobbleMultiplier=1+t.intensity:h.wobbleMultiplier=1}if(n.accentResponse?.enabled){const t=this.adapter.getAccentedValue(1,n.accentResponse.multiplier||1.5);h.accentMultiplier=t}const a=this.adapter.getPattern();return a&&n.patternOverrides?.[a]&&Object.assign(h,n.patternOverrides[a]),h}applyParticleRhythm(t,i){if(!this.enabled||!t.rhythm?.enabled)return{};const e=this.adapter.getTimeInfo(),s=t.rhythm,n={};if(s.particleEmission){const t=s.particleEmission;"beat"===t.syncMode&&this.adapter.isOnBeat(.1)?n.emitBurst=t.burstSize||3:void 0!==t.offBeatRate&&(n.emissionRate=t.offBeatRate)}if(s.glowSync){const t=s.glowSync,i=this.adapter.getBeatSync(t.intensityRange[0]||1,t.intensityRange[1]||2,"pulse");n.glowIntensity=i}if("bars"===s.breathSync?.mode){const t=s.breathSync,i=e.bar%t.barsPerBreath/t.barsPerBreath;n.breathPhase=i*Math.PI*2}return n}applyBehaviorRhythm(t,i,e){if(!this.enabled||!t.rhythm?.enabled)return{};const s=this.adapter.getTimeInfo(),n=t.rhythm,h={};if(n.glitchTiming){const t=n.glitchTiming;if(this.adapter.isOnSubdivision(t.subdivision,.05)&&Math.random()<t.probability){const i=this.adapter.isOnBeat()?t.intensityOnBeat:t.intensityOffBeat;h.triggerGlitch=!0,h.glitchIntensity=i}}if(n.orbitRhythm){const t=n.orbitRhythm;"tempo"===t.baseSpeed&&(h.speedMultiplier=this.adapter.getBPM()/120),t.beatAcceleration&&this.adapter.isOnBeat(.1)&&(h.speedBoost=t.beatAcceleration),t.barReset&&0===s.beatInBar&&(h.resetOrbit=!0)}if(n.stutterSync){const t=n.stutterSync,i=this.adapter.getPattern();if(i&&t.patterns?.[i]){const e=t.patterns[i];e.freezeOnDrop&&2===s.beatInBar?(h.freeze=!0,h.freezeDuration=e.dropDuration):e.randomFreeze&&Math.random()<e.randomFreeze&&(h.freeze=!0,h.freezeDuration=e.duration)}}return h}handleBeat(t){this.lastBeatInfo=t}handleBar(t){this.lastBarInfo=t}getMusicalDuration(t,i){if(!this.enabled||!t?.durationSync)return i;const e=t.durationSync;return"bars"===e.mode?this.adapter.beatsToMs(4*e.bars):"beats"===e.mode?this.adapter.beatsToMs(e.beats):i}isEnabled(){return this.enabled&&this.adapter.isPlaying()}start(t=120,i="straight"){t&&ci.setBPM(t),i&&ci.setPattern(i),ci.start(),this.enabled=!0}stop(){ci.stop(),this.enabled=!1,this.bpmLocked=!1,this.lockedBPM=null}setPattern(t){ci.setPattern(t)}setBPM(t){ci.setBPM(t),this.bpmLocked&&(this.lockedBPM=t)}resampleBPM(){this.bpmLocked=!1,this.lockedBPM=null}setTimeSignature(t){this.timeSignature=t;const i=document.getElementById("time-sig-display");i&&(i.textContent=t),"3/4"===t&&ci.getPattern()}syncToAudio(t,i){ci.syncToAudio(t,i)}};class ui{constructor(t,i,e="ambient",s=1,n=1,h=null){const a=Math.random();this.z=a<1/13?.5+.5*Math.random():.9*Math.random()-1;const r=this.z>0?(20+20*Math.random())*s:3*s,o=Math.random()*Math.PI*2;this.x=t+Math.cos(o)*r,this.y=i+Math.sin(o)*r,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.maxLife=1,this.lifeDecay=.01,this.fadeInTime=.15,this.fadeOutTime=.3,this.isFadingOut=!1,this.age=0,this.scaleFactor=s,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*s*n,this.baseSize=this.size,this.emotionColors=h,this.color="#ffffff",this.opacity=1,this.hasGlow=Math.random()<.333,this.glowSizeMultiplier=this.hasGlow?1.33+.33*Math.random():0,this.isCellShaded=Math.random()<.333,this.baseOpacity=.3+.4*Math.random(),this.cachedColors=new Map,this.lastColor=null,this.lastOpacity=-1,this.behavior=e,this.behaviorData={},this.gestureData={initialX:t,initialY:i},ft(this,e)}update(t,i,e,s=null,n=null,h=0){const a=Math.min(t,50)/16.67,r=n&&n.type&&h>0&&function(t){const i=oi(t);return!!i&&"override"===i.type}(n.type);r?this.applyGestureMotion(n,h,a,i,e):"falling"===this.gestureBehavior?gt(this,"falling",a,i,e):"radiant"===this.gestureBehavior?gt(this,"radiant",a,i,e):(gt(this,this.behavior,a,i,e),n&&h>0&&this.applyGestureMotion(n,h,a,i,e)),r||(this.x+=this.vx*a,this.y+=this.vy*a);const o=2*i,c=2*e,l=20;this.x-this.size<l?(this.x=l+this.size,this.vx=.5*Math.abs(this.vx)):this.x+this.size>o-l&&(this.x=o-l-this.size,this.vx=.5*-Math.abs(this.vx)),this.y-this.size<l?(this.y=l+this.size,this.vy=.5*Math.abs(this.vy)):this.y+this.size>c-l&&(this.y=c-l-this.size,this.vy=.5*-Math.abs(this.vy)),this.age+=this.lifeDecay*a,this.age<this.fadeInTime?this.life=this.age/this.fadeInTime:this.age<1-this.fadeOutTime?this.life=1:(this.life=(1-this.age)/this.fadeOutTime,this.isFadingOut=!0,"popcorn"===this.behavior&&(this.size=this.baseSize*(.5+.5*this.life))),this.life=Math.max(0,Math.min(1,this.life)),this.opacity=this.easeInOutCubic(this.life),"burst"===this.behavior&&this.behaviorData&&this.life<this.behaviorData.fadeStart&&(this.size=this.baseSize*(this.life/this.behaviorData.fadeStart))}applyUndertoneModifier(t,i){}applyGestureMotion(t,i,e,s,n){!function(t,i,e,s,n,h){if(!e||!e.type||s>=1)return;t.gestureData||(t.gestureData={originalVx:t.vx,originalVy:t.vy,initialX:t.x,initialY:t.y,startAngle:Math.atan2(t.y-h,t.x-n),startRadius:Math.sqrt(Math.pow(t.x-n,2)+Math.pow(t.y-h,2))});const a=oi(e.type);if(!a)return;let r=e;if(li.isEnabled()&&a.rhythm?.enabled){const n=li.applyGestureRhythm(a,t,s,i);r={...e,amplitude:(e.amplitude||1)*(n.amplitudeMultiplier||1)*(n.accentMultiplier||1),wobbleAmount:(e.wobbleAmount||0)*(n.wobbleMultiplier||1),rhythmModulation:n}}a.apply&&a.apply(t,s,r,i,n,h),s>=.99&&a.cleanup&&(a.cleanup(t),t.gestureData=null)}(this,e,t,i,s,n)}isOutOfBounds(t,i){return this.x<-50||this.x>t+50||this.y<-50||this.y>i+50}isAlive(){return this.life>0}setOutwardVelocity(t){if(this.behaviorData&&void 0!==this.behaviorData.outwardSpeed){const i=this.behaviorData.outwardSpeed;this.vx=Math.cos(t)*i,this.vy=Math.sin(t)*i+(this.behaviorData.upwardBias||0)}}getDepthAdjustedSize(){const t=1+.2*this.z;return this.size*t}getState(){return{position:{x:this.x,y:this.y,z:this.z},velocity:{x:this.vx,y:this.vy,z:this.vz},life:this.life,behavior:this.behavior,size:this.size,opacity:this.opacity}}reset(t,i,e="ambient",s=1,n=1,h=null){const a=Math.random();this.z=a<1/13?.5+.5*Math.random():.9*Math.random()-1;const r=this.z>0?(20+20*Math.random())*s:3*s,o=Math.random()*Math.PI*2;if(this.x=t+Math.cos(o)*r,this.y=i+Math.sin(o)*r,this.vx=0,this.vy=0,this.vz=0,this.life=0,this.age=0,this.scaleFactor=s,this.particleSizeMultiplier=n,this.size=(4+6*Math.random())*s*n,this.baseSize=this.size,this.emotionColors=h,this.cachedColors.clear(),this.opacity=0,this.isFadingOut=!1,this.baseOpacity=.3+.4*Math.random(),this.color="#ffffff",this.behavior=e,this.gestureData=null,this.behaviorData)for(const t in this.behaviorData)delete this.behaviorData[t];else this.behaviorData={};ft(this,e)}getCachedColor(t,i){const e=Math.round(100*i)/100,s=`${t}_${e}`;return this.cachedColors.has(s)||this.cachedColors.set(s,this.hexToRgba(t,e)),this.cachedColors.get(s)}hexToRgba(t,i){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?`rgba(${parseInt(e[1],16)}, ${parseInt(e[2],16)}, ${parseInt(e[3],16)}, ${i})`:`rgba(255, 255, 255, ${i})`}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}render(t,i="#ffffff"){if(this.life<=0)return;if(!isFinite(this.x)||!isFinite(this.y))return;const e=this.x,s=this.y,n=Math.max(.1,this.size),h=this.tempColor||this.color||i;if(t.save(),this.isCellShaded){t.strokeStyle=this.getCachedColor(h,.9*this.opacity),t.lineWidth=2,t.beginPath(),t.arc(e,s,n,0,2*Math.PI),t.stroke();const i=Math.floor(3*this.opacity)/3;t.fillStyle=this.getCachedColor(h,i*(this.baseOpacity||.5)*.5),t.beginPath(),t.arc(e,s,Math.max(.1,n-1),0,2*Math.PI),t.fill(),i>.5&&(t.fillStyle=this.getCachedColor("#FFFFFF",.3),t.beginPath(),t.arc(e-.3*n,s-.3*n,.3*n,0,2*Math.PI),t.fill())}else{const i=t.createRadialGradient(e,s,0,e,s,n);if(i.addColorStop(0,this.getCachedColor(h,this.opacity*(this.baseOpacity||.5))),i.addColorStop(.5,this.getCachedColor(h,this.opacity*(this.baseOpacity||.5)*.5)),i.addColorStop(1,this.getCachedColor(h,0)),t.fillStyle=i,t.beginPath(),t.arc(e,s,n,0,2*Math.PI),t.fill(),this.hasGlow&&this.glowSizeMultiplier>0){const i=n*this.glowSizeMultiplier,a=t.createRadialGradient(e,s,.5*n,e,s,i),r=.3,o=Math.max(r,this.opacity),c=Math.min(1,this.glowSizeMultiplier/3);a.addColorStop(0,this.getCachedColor(h,Math.max(.5,.8*o)*c)),a.addColorStop(.25,this.getCachedColor(h,Math.max(.3,.6*o)*c)),a.addColorStop(.5,this.getCachedColor(h,Math.max(.2,.4*o)*c)),a.addColorStop(.75,this.getCachedColor(h,Math.max(.1,.2*o)*c)),a.addColorStop(1,this.getCachedColor(h,0)),t.save(),t.globalCompositeOperation="screen",t.fillStyle=a,t.beginPath(),t.arc(e,s,i,0,2*Math.PI),t.fill(),t.restore()}}t.restore()}}class pi{constructor(t=50,i=null){this.errorBoundary=i,this.maxParticles=t,this.absoluteMaxParticles=2*t,this.particles=[],this.pool=[],this.poolSize=Math.min(t,50),this.totalParticlesCreated=0,this.totalParticlesDestroyed=0,this.stateChangeCount=0,this.lastMemoryCheck=Date.now(),this.lastLeakedCount=0,this.spawnAccumulator=0,this.particleCount=0,this.poolHits=0,this.poolMisses=0,this.cleanupTimer=0,this.cleanupInterval=5e3,this.initializePool()}initializePool(){this.pool=[]}getParticleFromPool(t,i,e){let s;return this.pool.length>0?(s=this.pool.pop(),s.reset(t,i,e,this.scaleFactor||1,this.particleSizeMultiplier||1,this.currentEmotionColors),this.poolHits++):(s=new ui(t,i,e,this.scaleFactor||1,this.particleSizeMultiplier||1,this.currentEmotionColors),this.poolMisses++,this.totalParticlesCreated++),s.emotion=this.currentEmotion,this.gestureBehavior&&(s.gestureBehavior=this.gestureBehavior),s}returnParticleToPool(t){if(this.pool.length<this.poolSize){if(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData)for(const i in t.behaviorData)delete t.behaviorData[i];this.pool.push(t)}else this.totalParticlesDestroyed++}spawn(t,i,e,s,n,h,a=null,r=0,o=10,c=1,l=1,u=null,p=null){if(this.scaleFactor=c,this.particleSizeMultiplier=l,this.errorBoundary)return this.errorBoundary.wrap(()=>{this.i(t,i,e,s,n,h,a,r,o,u,p)},"particle-spawn")();this.i(t,i,e,s,n,h,a,r,o,u,p)}resetAccumulator(){this.spawnAccumulator=0}i(t,i,e,s,n,h,a,r=0,c=10,l=null,u=null){this.currentEmotion=i,this.baseEmotionColors=l,this.currentUndertone=u,this.currentEmotionColors=l&&u?function(t,i){return t&&Array.isArray(t)&&i&&"clear"!==i?t.map(t=>"string"==typeof t?o(t,i):t&&"object"==typeof t&&t.color?{...t,color:o(t.color,i)}:t):t}(l,u):l;let p=e;if(li.isEnabled()){const e=E&&E.isInitialized?E.getEmotion(i):A(i);if(e){const i=li.applyParticleRhythm(e,this);if(i.emitBurst)for(let e=0;e<i.emitBurst&&this.particles.length<c;e++)this.spawnSingleParticle(t,s,n);void 0!==i.emissionRate&&(p*=i.emissionRate)}}if(null!==a){for(let i=0;i<a&&this.particles.length<this.maxParticles;i++)this.spawnSingleParticle(t,s,n);return}if(this.skipSpawnThisFrame)return;for(;this.particles.length<r&&this.particles.length<this.maxParticles;)this.spawnSingleParticle(t,s,n);if(this.particles.length>=c)return;if(p<=0)return;const d=Math.min(h,50),m=p/1e3;for(this.spawnAccumulator+=m*d,this.spawnAccumulator=Math.min(this.spawnAccumulator,3);this.spawnAccumulator>=1&&this.particles.length<c;)this.spawnSingleParticle(t,s,n),this.spawnAccumulator-=1}spawnSingleParticle(t,i,e){if(this.particles.length>=this.absoluteMaxParticles)return;const s=this.getSpawnPosition(t,i,e),n=this.clampToCanvas(s.x,s.y,i,e);s.x=n.x,s.y=n.y;const h=this.getParticleFromPool(s.x,s.y,t);"meditation_swirl"===t&&s.palmCenter&&(h.palmCenter=s.palmCenter,h.swirlAngle=s.swirlAngle),this.particles.push(h),this.particleCount++}getSpawnPosition(t,i,e){const s=Math.min(2*i,2*e)/12,n=2.5*s,h=1.1*n,a=Math.min(1.5*n,i-30,e-30);switch(t){case"ambient":case"resting":{const t=Math.random()*Math.PI*2,s=.9*n;return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s,angle:t}}case"rising":case"falling":{const t=Math.random()*Math.PI*2,s=h+Math.random()*(a-h);return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s}}case"aggressive":{const t=Math.random()*Math.PI*2,h=n+Math.random()*s;return{x:i+Math.cos(t)*h,y:e+Math.sin(t)*h}}case"scattering":default:return{x:i,y:e};case"burst":{const t=Math.random()*Math.PI*2;if("suspicion"===this.currentEmotion){const n=1.5*s;return{x:i+Math.cos(t)*n,y:e+Math.sin(t)*n}}if("surprise"===this.currentEmotion){const n=1.2*s;return{x:i+Math.cos(t)*n,y:e+Math.sin(t)*n}}return{x:i,y:e}}case"repelling":{const t=Math.random()*Math.PI*2,s=.9*n;return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s}}case"orbiting":{const t=Math.random()*Math.PI*2,s=1.2*n+Math.random()*n*.5;return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s}}case"glitchy":{const t=Math.random()*Math.PI*2,s=3*n+Math.random()*n*4;return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s}}case"spaz":{const t=Math.random()*Math.PI*2,s=2*n+Math.random()*n*3;return{x:i+Math.cos(t)*s,y:e+Math.sin(t)*s}}}}clampToCanvas(t,i,e,s,n=30){const h=2*e,a=2*s;return{x:Math.max(n,Math.min(h-n,t)),y:Math.max(n,Math.min(a-n,i))}}update(t,i,e,s=null,n=0,h=null){if(this.errorBoundary)return this.errorBoundary.wrap((t,i,e,s,n,h)=>this.o(t,i,e,s,n,h),"particle-update")(t,i,e,s,n,h);this.o(t,i,e,s,n,h)}o(t,i,e,s=null,n=0,h=null){for(this.particles=this.particles.filter(a=>(a.update(t,i,e,h,s,n),a.isAlive()));this.particles.length>this.maxParticles;)this.removeParticle(0)}setGestureBehavior(t,i){this.gestureBehavior=i?t:null,i?this.particles.forEach(i=>{i.gestureBehavior=t}):this.particles.forEach(t=>{t.gestureBehavior=null})}removeParticle(t){if(t>=0&&t<this.particles.length){const i=this.particles.splice(t,1)[0];i.cachedGradient=null,i.cachedGradientKey=null,this.returnParticleToPool(i),this.particleCount=Math.max(0,this.particleCount-1)}}render(t,i="#ffffff",e=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.u(t,i,e)},"particle-render")();this.u(t,i,e)}renderBackground(t,i="#ffffff",e=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.p(t,i,!1,e)},"particle-render-bg")();this.p(t,i,!1,e)}renderForeground(t,i="#ffffff",e=null){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.p(t,i,!0,e)},"particle-render-fg")();this.p(t,i,!0,e)}p(t,i,e,s=null){const n=[],h=t.canvas.width,a=t.canvas.height;for(const t of this.particles)t.z>=0===e&&(t.x<-50||t.x>h+50||t.y<-50||t.y>a+50||t.life<=0||n.push(t));n.sort((t,i)=>t.isCellShaded!==i.isCellShaded?t.isCellShaded?-1:1:t.hasGlow!==i.hasGlow?t.hasGlow?-1:1:0),this.m(t,n,i,s)}u(t,i,e=null){const s=[];for(const t of this.particles)t.life<=0||s.push(t);this.m(t,s,i,e)}m(t,i,e,s=null){t.save();let n=null;for(const h of i)if(h.isCellShaded)h.render(t,e),n=null;else{const i=h.color||e;if(i!==n&&(t.fillStyle=i,n=i),!isFinite(h.x)||!isFinite(h.y))continue;const a=h.getDepthAdjustedSize?h.getDepthAdjustedSize():h.size;let r=Math.max(.1,a),o=1;if(s&&s.fireflyEffect){const t=(.01*h.x+.01*h.y+.1*h.size)%(2*Math.PI),i=s.fireflyTime||.001*Date.now(),e=s.particleGlow||2;o=.3+Math.max(0,Math.sin(3*i+t))*e}if(s&&s.flickerEffect){const t=(.02*h.x+.02*h.y)%(2*Math.PI),i=s.flickerTime||.001*Date.now(),e=s.particleGlow||2;o=.5+Math.sin(12*i+t)*e*.5}if(s&&s.shimmerEffect){const i=h.x-t.canvas.width/2,e=h.y-t.canvas.height/2,n=Math.sqrt(i*i+e*e)/200,a=s.shimmerTime||.001*Date.now(),r=s.shimmerWave||0,c=s.particleGlow||1.2;o=1+.15*Math.sin(3*a-n+r)*c}if(s&&s.glowEffect){const i=s.glowProgress||0,e=s.particleGlow||2,n=h.x-t.canvas.width/2,a=h.y-t.canvas.height/2,o=Math.sqrt(n*n+a*a)/300,c=Math.min(.3*o,.5),l=Math.max(0,(i-c)/(1-c)),u=Math.sin(l*Math.PI);h.M||(h.M={hasGlow:h.hasGlow,glowSizeMultiplier:h.glowSizeMultiplier||0}),h.hasGlow=!0,h.glowSizeMultiplier=Math.max(3,h.M.glowSizeMultiplier)+u*e*3,r*=1+.3*u,i>=.99&&h.M&&(h.hasGlow=h.M.hasGlow,h.glowSizeMultiplier=h.M.glowSizeMultiplier,delete h.M)}if(h.hasGlow||o>1){const i=Math.max(.1,r*(h.glowSizeMultiplier||1.5)*o);t.globalAlpha=.15*h.opacity*o,t.beginPath(),t.arc(h.x,h.y,i,0,2*Math.PI),t.fill(),t.globalAlpha=.25*h.opacity*o,t.beginPath(),t.arc(h.x,h.y,.6*i,0,2*Math.PI),t.fill()}t.globalAlpha=h.opacity*(h.baseOpacity||.5)*.6*Math.min(2,o),t.beginPath(),t.arc(h.x,h.y,r,0,2*Math.PI),t.fill()}t.restore()}clear(){for(this.stateChangeCount++;this.particles.length>0;){const t=this.particles.pop();if(t.cachedColors&&t.cachedColors.clear(),t.behaviorData)for(const i in t.behaviorData)delete t.behaviorData[i];this.pool.length<this.poolSize&&!this.pool.includes(t)&&this.pool.push(t)}if(this.particles.length=0,this.particleCount=0,this.spawnAccumulator=0,this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;this.pool.splice(this.poolSize,t)}}burst(t,i,e,s){if(this.errorBoundary)return this.errorBoundary.wrap(()=>{this.v(t,i,e,s)},"particle-burst")();this.v(t,i,e,s)}v(t,i,e,s){const n=Math.min(t,this.maxParticles-this.particles.length);for(let t=0;t<n;t++)this.spawnSingleParticle(i,e,s)}performCleanup(){if(this.pool.length>this.poolSize){const t=this.pool.length-this.poolSize;for(let i=0;i<t;i++){const t=this.pool.pop();t&&(t.cachedGradient=null,t.cachedGradientKey=null,t.behaviorData=null)}}for(const t of this.particles)t.cachedGradient&&t.life<.5&&(t.cachedGradient=null,t.cachedGradientKey=null)}getStats(){return{activeParticles:this.particles.length,maxParticles:this.maxParticles,poolSize:this.pool.length,poolHits:this.poolHits,poolMisses:this.poolMisses,poolEfficiency:this.poolHits/Math.max(1,this.poolHits+this.poolMisses),spawnAccumulator:this.spawnAccumulator}}setMaxParticles(t){for(this.originalMaxParticles=this.originalMaxParticles||this.maxParticles,this.maxParticles=Math.max(1,t);this.particles.length>this.maxParticles;)this.removeParticle(0)}cleanupDeadParticles(){const t=this.particles.length;this.particles=this.particles.filter(t=>t.isAlive());const i=t-this.particles.length;return this.pool.length>20&&(this.pool.length=20),i}getParticlesByBehavior(t){return this.particles.filter(i=>i.behavior===t)}validateParticles(){for(const t of this.particles)if(!t.isAlive()||t.life<0||t.life>1)return!1;return!0}cleanup(){for(let t=this.particles.length-1;t>=0;t--)this.particles[t].isAlive()||this.removeParticle(t)}destroy(){this.clear(),this.pool.length=0,this.poolHits=0,this.poolMisses=0}}const di=new class{constructor(){this.gestureCache=new Map,this.propertyCache=new Map,this.compositionCache=new Map,this.pluginCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{this.cacheCoreGestures(),this.cacheGestureProperties(),this.cacheCommonCombinations(),this.cachePluginGestures(),this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.gestureCache.size+this.propertyCache.size+this.compositionCache.size,this.isInitialized=!0}catch(t){this.isInitialized=!1}}cacheCoreGestures(){Object.values(ri).forEach(t=>{t&&t.name&&this.gestureCache.set(t.name,{...t,cached:!0,cacheTime:performance.now()})})}cacheGestureProperties(){this.gestureCache.forEach((t,i)=>{const e={type:t.type,emoji:t.emoji,description:t.description,config:t.config,rhythm:t.rhythm,duration:this.calculateGestureDuration(t),easing:this.extractEasingFunction(t),physics:this.extractPhysicsProperties(t),timing:this.extractTimingProperties(t)};this.propertyCache.set(i,e)})}cacheCommonCombinations(){[["bounce","pulse"],["shake","vibrate"],["orbit","spin"],["morph","glow"],["breathe","fade"],["wave","drift"],["nod","sway"],["jump","stretch"]].forEach(([t,i])=>{const e=`${t}+${i}`,s=this.calculateGestureCombination(t,i);s&&this.compositionCache.set(e,s)})}cachePluginGestures(){try{const t=bt();t&&Object.entries(t).forEach(([t,i])=>{this.pluginCache.set(t,{...i,cached:!0,cacheTime:performance.now(),isPlugin:!0})})}catch(t){}}getGesture(t){return this.gestureCache.has(t)?(this.stats.hits++,this.stats.gestureHits++,this.gestureCache.get(t)):this.pluginCache.has(t)?(this.stats.hits++,this.stats.gestureHits++,this.pluginCache.get(t)):(this.stats.misses++,null)}getGestureProperties(t){return this.propertyCache.has(t)?(this.stats.hits++,this.stats.propertyHits++,this.propertyCache.get(t)):(this.stats.misses++,null)}getGestureCombination(t,i){const e=`${t}+${i}`;return this.compositionCache.has(e)?(this.stats.hits++,this.stats.compositionHits++,this.compositionCache.get(e)):(this.stats.misses++,null)}calculateGestureDuration(t){if(!t.config)return 1e3;const{musicalDuration:i,duration:e}=t.config;return i&&i.musical?500*(i.beats||2):e||1e3}extractEasingFunction(t){if(!t.config)return"sine";const{easing:i,particleMotion:e}=t.config;return i||e?.easing||"sine"}extractPhysicsProperties(t){if(!t.config)return{};const{amplitude:i,strength:e,size:s,rotation:n}=t.config;return{amplitude:i||20,strength:e||1,size:s||80,rotation:n||0}}extractTimingProperties(t){if(!t.config)return{};const{phases:i,timingSync:e}=t.config;return{phases:i||[],timingSync:e||{},hasPhases:!!(i&&i.length>0),hasTimingSync:!!(e&&Object.keys(e).length>0)}}calculateGestureCombination(t,i){const e=this.getGesture(t),s=this.getGesture(i);return e&&s?{gestures:[t,i],combinedDuration:Math.max(this.calculateGestureDuration(e),this.calculateGestureDuration(s)),combinedType:e.type===s.type?e.type:"mixed",combinedEasing:this.extractEasingFunction(e),combinedPhysics:this.combinePhysicsProperties(e,s),compatibility:this.calculateCompatibility(e,s)}:null}combinePhysicsProperties(t,i){const e=this.extractPhysicsProperties(t),s=this.extractPhysicsProperties(i);return{amplitude:Math.max(e.amplitude,s.amplitude),strength:(e.strength+s.strength)/2,size:Math.max(e.size,s.size),rotation:(e.rotation+s.rotation)/2}}calculateCompatibility(t,i){return t.type===i.type?"high":"blending"===t.type&&"blending"===i.type?"medium":"override"===t.type||"override"===i.type?"low":"medium"}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(1):0;return{...this.stats,hitRate:`${t}%`,isInitialized:this.isInitialized,cacheSize:this.stats.cacheSize,coreGestures:this.gestureCache.size,pluginGestures:this.pluginCache.size,properties:this.propertyCache.size,combinations:this.compositionCache.size}}clear(){this.gestureCache.clear(),this.propertyCache.clear(),this.compositionCache.clear(),this.pluginCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0,gestureHits:0,propertyHits:0,compositionHits:0},this.isInitialized=!1}warmUp(t){t.forEach(t=>{this.getGesture(t),this.getGestureProperties(t)})}};function mi(t){if(di&&di.isInitialized){const i=di.getGesture(t);if(i)return i}return oi(t)}const fi={none:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},clear:{speed:1,amplitude:1,intensity:1,smoothness:1,regularity:1},nervous:{speed:1.2,amplitude:.9,intensity:1.1,smoothness:.7,regularity:.6,addFlutter:!0,addMicroShake:!0},confident:{speed:.9,amplitude:1.3,intensity:1.2,smoothness:1.1,regularity:1.2,addPower:!0,addHold:!0},tired:{speed:.7,amplitude:.7,intensity:.8,smoothness:1.3,regularity:.8,addDroop:!0,addPause:!0},intense:{speed:1.3,amplitude:1.2,intensity:1.4,smoothness:.6,regularity:.9,addPulse:!0,addFocus:!0},subdued:{speed:.8,amplitude:.8,intensity:.7,smoothness:1.2,regularity:1.1,addSoftness:!0,addFade:!0}};class gi{constructor(){this.cache=new Map,this.easingCache=new Map,this.preCalculateEasingCurves()}preCalculateEasingCurves(){const t=["linear","ease-in","ease-out","ease-in-out","bounce"];for(const i of t){const t=new Float32Array(101);for(let e=0;e<=100;e++){const s=e/100;t[e]=this.calculateEasing(s,i)}this.easingCache.set(i,t)}}calculateEasing(t,i){switch(i){case"ease-in":return t*t;case"ease-out":return t*(2-t);case"ease-in-out":return t<.5?2*t*t:(4-2*t)*t-1;case"bounce":return t<.363636?7.5625*t*t:t<.727272?7.5625*(t-=.545454)*t+.75:t<.90909?7.5625*(t-=.818181)*t+.9375:7.5625*(t-=.954545)*t+.984375;default:return t}}getEasingValue(t,i){const e=this.easingCache.get(i);return e?e[Math.min(Math.floor(100*t),100)]:t}compose(t,i,e=null){const s=`${t}-${i}-${e||"none"}`;if(this.cache.has(s))return this.cache.get(s);const n=mi(t),h=n?n.config:{duration:500,amplitude:20,easing:"sine"},a=E&&E.isInitialized?E.getModifiers(i):O(i),r=function(t){return t&&""!==t&&"clear"!==t&&fi[t]||fi.clear}(e),o=this.applyModifiers(h,a,r,t);return this.cache.size>100&&this.cache.clear(),this.cache.set(s,o),o}applyModifiers(t,i,e,s){const n={...t},h=i.speed*e.speed;if(n.duration=Math.round(t.duration/h),void 0!==n.amplitude&&(n.amplitude=t.amplitude*i.amplitude*e.amplitude),void 0!==n.scaleAmount&&(n.scaleAmount=t.scaleAmount*i.intensity*e.intensity),void 0!==n.scaleTarget){const s=i.amplitude*e.amplitude;n.scaleTarget=1+(t.scaleTarget-1)*s}void 0!==n.glowAmount&&(n.glowAmount=t.glowAmount*i.intensity*e.intensity),void 0!==n.glowPeak&&(n.glowPeak=1+(t.glowPeak-1)*i.intensity*e.intensity),void 0!==n.rotations&&(n.rotations=t.rotations*i.amplitude*e.amplitude),void 0!==n.angle&&(n.angle=t.angle*i.amplitude*e.amplitude),void 0!==n.distance&&(n.distance=t.distance*i.amplitude*e.amplitude);const a=i.smoothness*e.smoothness;return n.smoothness=a,n.easing=this.selectEasing(t.easing,a),n.regularity=i.regularity*e.regularity,n.effects=[],i.addBounce&&n.effects.push("bounce"),i.addGravity&&n.effects.push("gravity"),i.addShake&&n.effects.push("shake"),i.addJitter&&n.effects.push("shake"),i.addPop&&n.effects.push("pop"),i.addRecoil&&n.effects.push("recoil"),i.addWarmth&&n.effects.push("warmth"),i.addFlow&&n.effects.push("flow"),i.addWobble&&n.effects.push("wobble"),i.addVibration&&n.effects.push("vibration"),i.addDrag&&n.effects.push("drag"),i.addWeight&&n.effects.push("weight"),i.addTension&&n.effects.push("tension"),i.addPrecision&&n.effects.push("precision"),e.addFlutter&&n.effects.push("flutter"),e.addMicroShake&&n.effects.push("microShake"),e.addPower&&n.effects.push("power"),e.addHold&&n.effects.push("hold"),e.addDroop&&n.effects.push("droop"),e.addPause&&n.effects.push("pause"),e.addPulse&&n.effects.push("pulse"),e.addFocus&&n.effects.push("focus"),e.addSoftness&&n.effects.push("softness"),e.addFade&&n.effects.push("fade"),this.applyGestureSpecificMods(n,s,i,e),t.particleMotion&&(n.particleMotion={...t.particleMotion},void 0!==n.particleMotion.strength&&(n.particleMotion.strength*=i.intensity*e.intensity),void 0!==n.particleMotion.frequency&&(n.particleMotion.frequency*=h),void 0!==n.particleMotion.amplitude&&(n.particleMotion.amplitude*=i.amplitude*e.amplitude)),n}selectEasing(t,i){return i<.5?"linear":i<.8?"quad":i<1.2?t:i<1.5?"cubic":"sine"}applyGestureSpecificMods(t,i,e,s){switch(i){case"bounce":e.addShake&&(t.frequency=Math.floor(1.5*t.frequency)),e.addGravity&&(t.amplitude*=.6,t.frequency=1);break;case"pulse":e.addWarmth&&(t.frequency=2,t.glowAmount*=1.5),s.addFlutter&&(t.irregular=!0);break;case"shake":e.addJitter&&(t.frequency*=1.5,t.amplitude*=1.2),e.addShake&&(t.amplitude*=1.5,t.decay=!1);break;case"spin":e.addBounce&&(t.rotations*=1.5),e.addWobble&&(t.wobble=!0)}}clearCache(){this.cache.clear()}}var yi={name:"zen-vortex",emoji:"ðŸŒ€",description:"Swirling meditation vortex effect",config:{vortexSpeed:.02,spiralTightness:.15,maxRadius:1.5,lineWidth:2,segments:50,arms:3,fadeStart:.7,baseOpacity:.3,pulseSpeed:.01},state:{rotation:0,pulsePhase:0,intensity:0},shouldActivate:t=>"zen"===t.emotion||t.zenTransition?.active,apply(t,i){const{x:e,y:s,radius:n,intensity:h=1,deltaTime:a=16.67}=i;this.state.rotation+=this.config.vortexSpeed*(a/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(a/16.67),this.state.intensity=h,t.save();for(let i=0;i<this.config.arms;i++){const h=2*Math.PI/this.config.arms*i;this.drawSpiralArm(t,e,s,n,h)}this.drawMeditationEyes(t,e,s,.6*n,h),t.restore()},drawSpiralArm(t,i,e,s,n){t.beginPath();const h=1+.1*Math.sin(this.state.pulsePhase);for(let a=0;a<=this.config.segments;a++){const r=a/this.config.segments,o=this.state.rotation+n+r*Math.PI*4,c=r*s*this.config.maxRadius*h,l=i+Math.cos(o)*c,u=e+Math.sin(o)*c;0===a?t.moveTo(l,u):t.lineTo(l,u)}const a=t.createLinearGradient(i-s,e,i+s,e),r=this.config.baseOpacity*this.state.intensity;a.addColorStop(0,"rgba(147, 112, 219, 0)"),a.addColorStop(.3,`rgba(147, 112, 219, ${.5*r})`),a.addColorStop(this.config.fadeStart,`rgba(147, 112, 219, ${r})`),a.addColorStop(1,"rgba(147, 112, 219, 0)"),t.strokeStyle=a,t.lineWidth=this.config.lineWidth,t.stroke()},drawMeditationEyes(t,i,e,s,n){t.save();const h=.4*s,a=.3*s;t.strokeStyle=`rgba(255, 255, 255, ${.8*n})`,t.lineWidth=2,t.beginPath(),t.arc(i-a,e,h,Math.PI,0,!0),t.stroke(),t.beginPath(),t.arc(i+a,e,h,Math.PI,0,!0),t.stroke(),t.restore()},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.intensity=0}},Mi={name:"recording-glow",emoji:"ðŸ”´",description:"Pulsating red recording indicator",config:{color:"#FF0000",pulseSpeed:.08,minIntensity:.6,maxIntensity:1,radiusMultiplier:2,gradientStops:[{position:0,opacity:1},{position:.3,opacity:.7},{position:.6,opacity:.4},{position:.85,opacity:.2},{position:1,opacity:0}]},state:{pulsePhase:0,intensity:.8},shouldActivate:t=>!0===t.recording,apply(t,i){const{deltaTime:e=16.67}=i;this.state.pulsePhase+=this.config.pulseSpeed*(e/16.67);const s=(Math.sin(this.state.pulsePhase)+1)/2;return this.state.intensity=this.config.minIntensity+(this.config.maxIntensity-this.config.minIntensity)*s,!0},drawRecordingIndicator(t,i,e){t.save();const s=Math.min(i,e),n=Math.floor(.08*s),h=1.5*n,a=1.5*n,r=.3*n;t.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),t.beginPath(),t.arc(h-n,a,r,0,2*Math.PI),t.fill(),t.strokeStyle=this.hexToRgba("#FFFFFF",.8*this.state.intensity),t.lineWidth=3,t.font=`bold ${n}px 'Arial', sans-serif`,t.textAlign="left",t.textBaseline="middle",t.strokeText("REC",h,a),t.fillStyle=this.hexToRgba("#FF0000",this.state.intensity),t.fillText("REC",h,a),t.restore()},hexToRgba:(t,i)=>`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, ${i})`,reset(){this.state.pulsePhase=0,this.state.intensity=0}},bi={name:"speaking-pulse",emoji:"ðŸ—£ï¸",description:"Audio-reactive pulse when speaking",config:{scaleMultiplier:.15,smoothing:.1,minPulse:.02,colorShift:!0,ringEffect:!0},state:{audioLevel:0,smoothedLevel:0,rings:[]},shouldActivate:t=>!0===t.speaking,apply(t,i){const{x:e,y:s,radius:n,audioLevel:h=0,deltaTime:a=16.67}=i;this.state.smoothedLevel+=(h-this.state.smoothedLevel)*this.config.smoothing,h>.5&&this.state.audioLevel<=.5&&this.state.rings.push({radius:n,opacity:.5,speed:2}),this.config.ringEffect&&this.drawRings(t,e,s,a),this.state.audioLevel=h},drawRings(t,i,e,s){t.save(),t.strokeStyle="rgba(100, 200, 255, 0.5)",t.lineWidth=2;for(let n=this.state.rings.length-1;n>=0;n--){const h=this.state.rings[n];h.radius+=h.speed*(s/16.67),h.opacity-=s/16.67*.02,h.opacity<=0?this.state.rings.splice(n,1):(t.globalAlpha=h.opacity,t.beginPath(),t.arc(i,e,h.radius,0,2*Math.PI),t.stroke())}t.restore()},getScaleModifier(){return 1+this.state.smoothedLevel*this.config.scaleMultiplier}},wi={name:"sleeping",emoji:"ðŸ˜´",description:"Sleeping with closed eyes and Z particles",config:{eyeClosedScale:.1,breathingDepth:.15,breathingRate:.8,zParticleInterval:2e3,zDriftSpeed:1,zFadeSpeed:.01,orbDimming:.3,glowDimming:.2},state:{lastZSpawn:0,zParticles:[]},shouldActivate:t=>!0===t.sleeping||"resting"===t.emotion,apply(t,i){const{x:e,y:s,radius:n,deltaTime:h=16.67}=i,a=Date.now();if(a-this.state.lastZSpawn>this.config.zParticleInterval){const t=[100,200,300,400,500,600,700,800,900],i=t[Math.floor(Math.random()*t.length)];this.state.zParticles.push({x:e+n,y:s-n,opacity:1,size:12+8*Math.random(),drift:.5*Math.random()-.25,weight:i,rotation:30*Math.random()-15}),this.state.lastZSpawn=a}this.drawZParticles(t,h)},drawZParticles(t,i){t.save(),t.textAlign="center",t.textBaseline="middle";for(let e=this.state.zParticles.length-1;e>=0;e--){const s=this.state.zParticles[e];s.y-=this.config.zDriftSpeed*(i/16.67),s.x+=s.drift*(i/16.67),s.opacity-=this.config.zFadeSpeed*(i/16.67),s.rotation+=i/16.67*.5,s.opacity<=0?this.state.zParticles.splice(e,1):(t.save(),t.translate(s.x,s.y),t.rotate(s.rotation*Math.PI/180),t.globalAlpha=.7*s.opacity,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`${s.weight} ${s.size}px 'Poppins', sans-serif`,t.fillText("Z",0,0),t.shadowBlur=3,t.shadowColor="rgba(147, 112, 219, 0.5)",t.fillText("Z",0,0),t.restore())}t.restore()},getEyeOpenness(){return this.config.eyeClosedScale},getBreathingModifiers(){return{rate:this.config.breathingRate,depth:this.config.breathingDepth}},getDimmingValues(){return{orbDimming:this.config.orbDimming,glowDimming:this.config.glowDimming}}},vi={name:"suspicion-scan",emoji:"ðŸ”",description:"Suspicious scanning and squinting",config:{squintAmount:.4,scanInterval:5e3,scanDuration:800,scanAngle:45,squintSpeed:.02,pupilShift:.3},state:{currentSquint:0,targetSquint:0,lastScanTime:0,scanPhase:0,scanning:!1},shouldActivate:t=>"suspicion"===t.emotion||!0===t.suspicious,apply(t,i){const{deltaTime:e=16.67}=i,s=Date.now();this.updateSquint(e),s-this.state.lastScanTime>this.config.scanInterval&&(this.startScan(),this.state.lastScanTime=s),this.state.scanning&&this.updateScan(s,e)},updateSquint(t){this.state.targetSquint=this.config.squintAmount;const i=this.state.targetSquint-this.state.currentSquint;Math.abs(i)>.01?this.state.currentSquint+=i*this.config.squintSpeed*(t/16.67):this.state.currentSquint=this.state.targetSquint},startScan(){this.state.scanning=!0,this.state.scanStartTime=Date.now(),this.state.scanPhase=-1},updateScan(t,i){const e=(t-this.state.scanStartTime)/this.config.scanDuration;e<.33?this.state.scanPhase=-1:e<.66?this.state.scanPhase=1:(e<1||(this.state.scanning=!1),this.state.scanPhase=0)},getEyeModifiers(){return{scaleY:1-this.state.currentSquint,scaleX:1+.3*this.state.currentSquint,offsetX:this.state.scanPhase*this.config.pupilShift}},drawScanLines(t,i,e,s){if(!this.state.scanning)return;t.save(),t.strokeStyle="rgba(255, 165, 0, 0.3)",t.lineWidth=1,t.setLineDash([5,5]);const n=this.state.scanPhase*(this.config.scanAngle*Math.PI/180),h=i+Math.cos(n)*s*2,a=e+Math.sin(n)*s*.5;t.beginPath(),t.moveTo(i,e),t.lineTo(h,a),t.stroke(),t.restore()}},Si={name:"gaze-narrowing",emoji:"ðŸ‘ï¸",description:"Eye narrowing based on gaze proximity",config:{maxHorizontalScale:1.3,maxVerticalScale:.5,smoothing:.1,focusThreshold:.3},state:{currentScaleX:1,currentScaleY:1,targetScaleX:1,targetScaleY:1},shouldActivate:t=>t.gazeIntensity>0||t.gazeLocked,apply(t,i){const{gazeIntensity:e=0,deltaTime:s=16.67}=i;if(e>this.config.focusThreshold){const t=(e-this.config.focusThreshold)/(1-this.config.focusThreshold);this.state.targetScaleX=1+(this.config.maxHorizontalScale-1)*t,this.state.targetScaleY=1-(1-this.config.maxVerticalScale)*t}else this.state.targetScaleX=1,this.state.targetScaleY=1;this.animateScales(s)},animateScales(t){const i=this.config.smoothing*(t/16.67),e=this.state.targetScaleX-this.state.currentScaleX;Math.abs(e)>.001&&(this.state.currentScaleX+=e*i);const s=this.state.targetScaleY-this.state.currentScaleY;Math.abs(s)>.001&&(this.state.currentScaleY+=s*i)},getEyeScales(){return{scaleX:this.state.currentScaleX,scaleY:this.state.currentScaleY}},drawFocusIndicator(t,i,e,s,n){if(n<this.config.focusThreshold)return;t.save();const h=.5*(n-this.config.focusThreshold);t.strokeStyle=`rgba(100, 200, 255, ${h})`,t.lineWidth=1,t.setLineDash([2,4]);const a=[0,60,120,180,240,300];for(const n of a){const h=n*Math.PI/180,a=2*s,r=1.2*s;t.beginPath(),t.moveTo(i+Math.cos(h)*a,e+Math.sin(h)*a),t.lineTo(i+Math.cos(h)*r,e+Math.sin(h)*r),t.stroke()}t.restore()}},Fi={name:"fingerprint",emoji:"ðŸ‘†",description:"Biometric fingerprint pattern for authentication UI",config:{rings:8,ringSpacing:15,lineWidth:1.5,rotationSpeed:.001,pulseSpeed:.02,waveAmplitude:3,waveFrequency:8,breakPoints:5,opacity:.4,scanLineSpeed:.01,scanLineWidth:3,color:"#00CED1",glowColor:"#00FFFF",successColor:"#00FF00",failColor:"#FF0000"},state:{rotation:0,pulsePhase:0,scanPosition:0,scanDirection:1,isScanning:!1,scanResult:null,breaks:[],whorls:[]},shouldActivate:t=>!0===t.biometric||!0===t.fingerprint||!0===t.authenticating,initialize(){this.state.breaks=[];for(let t=0;t<this.config.rings;t++){const t=[];for(let i=0;i<this.config.breakPoints;i++)t.push(Math.random()*Math.PI*2);this.state.breaks.push(t)}this.state.whorls=[{x:.2,y:-.1,strength:.3},{x:-.15,y:.2,strength:.25},{x:0,y:0,strength:.5}]},apply(t,i){const{x:e,y:s,radius:n,deltaTime:h=16.67,scanning:a=!1,authResult:r=null}=i;0===this.state.breaks.length&&this.initialize(),this.state.rotation+=this.config.rotationSpeed*(h/16.67),this.state.pulsePhase+=this.config.pulseSpeed*(h/16.67),(a||this.state.isScanning)&&(this.state.isScanning=!0,this.state.scanPosition+=this.config.scanLineSpeed*this.state.scanDirection*(h/16.67),this.state.scanPosition>1?(this.state.scanPosition=1,this.state.scanDirection=-1):this.state.scanPosition<-1&&(this.state.scanPosition=-1,this.state.scanDirection=1)),t.save(),this.drawFingerprintPattern(t,e,s,n),this.state.isScanning&&this.drawScanLine(t,e,s,n),r&&this.showAuthResult(t,e,s,n,r),t.restore()},drawFingerprintPattern(t,i,e,s){const n=.1*Math.sin(this.state.pulsePhase)+1;for(let h=0;h<this.config.rings;h++){const a=(h+1)*this.config.ringSpacing*n;if(!(a>2*s)){t.beginPath(),t.strokeStyle=this.config.color,t.lineWidth=this.config.lineWidth,t.globalAlpha=this.config.opacity*(1-h/this.config.rings*.5);for(let n=0;n<2*Math.PI;n+=.05){let r=!1;for(const t of this.state.breaks[h]||[])if(Math.abs(n-t)<.1){r=!0;break}if(r){t.stroke(),t.beginPath();continue}let o=a,c=n+this.state.rotation;for(const t of this.state.whorls){const n=i+t.x*s,h=e+t.y*s,a=i+Math.cos(c)*o,r=e+Math.sin(c)*o,l=Math.sqrt(Math.pow(a-n,2)+Math.pow(r-h,2));c+=Math.exp(-l/(.5*s))*t.strength*.5}o+=Math.sin(n*this.config.waveFrequency)*this.config.waveAmplitude;const l=i+Math.cos(c)*o,u=e+Math.sin(c)*o;0===n?t.moveTo(l,u):t.lineTo(l,u)}t.stroke()}}},drawScanLine(t,i,e,s){const n=e+this.state.scanPosition*s,h=t.createLinearGradient(i-s,n,i+s,n);h.addColorStop(0,"rgba(0, 255, 255, 0)"),h.addColorStop(.5,this.config.glowColor),h.addColorStop(1,"rgba(0, 255, 255, 0)"),t.strokeStyle=h,t.lineWidth=this.config.scanLineWidth,t.globalAlpha=.8,t.shadowBlur=10,t.shadowColor=this.config.glowColor,t.beginPath(),t.moveTo(i-s,n),t.lineTo(i+s,n),t.stroke(),t.shadowBlur=0},showAuthResult(t,i,e,s,n){const h="success"===n?this.config.successColor:this.config.failColor,a="success"===n?"âœ“ AUTHENTICATED":"âœ— ACCESS DENIED";t.fillStyle=h,t.font=`bold ${.15*s}px monospace`,t.textAlign="center",t.textBaseline="middle",t.globalAlpha=.9,t.fillText(a,i,e+1.3*s),t.strokeStyle=h,t.lineWidth=3,t.globalAlpha=.5,t.beginPath(),t.arc(i,e,1.1*s,0,2*Math.PI),t.stroke()},startScan(){this.state.isScanning=!0,this.state.scanPosition=-1,this.state.scanDirection=1,this.state.scanResult=null},completeScan(t=!0){this.state.isScanning=!1,this.state.scanResult=t?"success":"fail",setTimeout(()=>{this.state.scanResult=null},2e3)},reset(){this.state.rotation=0,this.state.pulsePhase=0,this.state.scanPosition=0,this.state.scanDirection=1,this.state.isScanning=!1,this.state.scanResult=null}};const ki=new Map;function xi(t){t.name&&ki.set(t.name,t)}function Bi(t){return ki.get(t)||null}function Pi(t,i,e){const s=Bi(t);return!!s&&!!s.apply&&(s.apply(i,e),!0)}function Ci(t,i){const e=Bi(t);return!(!e||!e.shouldActivate)&&e.shouldActivate(i)}xi(yi),xi(Mi),xi(bi),xi(wi),xi(vi),xi(Si),xi(Fi);const Ai=new class{constructor(){this.noteDurations={whole:4,half:2,quarter:1,eighth:.5,sixteenth:.25,triplet:.333,"dotted-quarter":1.5,"dotted-half":3},this.cache=new Map,this.lastBPM=0,this.prewarmCache()}prewarmCache(){const t=[{musical:!0,beats:1},{musical:!0,bars:1},{musical:!0,beats:.5},{musical:!0,beats:2}];[60,90,120,140,160,180].forEach(i=>{t.forEach(t=>{const e=`${i}_${JSON.stringify(t)}`,s=this.toMilliseconds(t,i);this.cache.set(e,s)})})}toMilliseconds(t,i=null){const e=i||ci.bpm||120;if("number"==typeof t)return t;if("object"==typeof t&&t.musical){const i=6e4/e;if(void 0!==t.beats)return t.beats*i;if(void 0!==t.bars){const e=ci.timeSignature||[4,4];return t.bars*e[0]*i}if(void 0!==t.subdivision)return(this.noteDurations[t.subdivision]||1)*i}return 1e3}toMusical(t,i=null){const e=t/(6e4/(i||ci.bpm||120));let s="quarter",n=Math.abs(e-1);for(const[t,i]of Object.entries(this.noteDurations)){const h=Math.abs(e-i);h<n&&(n=h,s=t)}return{musical:!0,beats:e,bars:e/4,closestSubdivision:s,exact:n<.01}}calculatePhases(t,i){if(!t||0===t.length)return[{name:"main",beats:i,start:0,end:1}];const e=t.reduce((t,i)=>t+(i.beats||1),0),s=i/e;let n=0;return t.map(t=>{const e=(t.beats||1)*s,h=n/i;n+=e;const a=n/i;return{name:t.name,beats:e,start:h,end:a,duration:this.toMilliseconds({musical:!0,beats:e})}})}getBeatProgress(){const t=ci.getTimeInfo();return t?t.beatProgress:0}getBarProgress(){const t=ci.getTimeInfo();return t?t.barProgress:0}timeToNextBoundary(t="beat"){const i=ci.getTimeInfo();if(!i)return 100;switch(t){case"beat":default:return i.nextBeatIn;case"bar":return(i.timeSignature[0]-i.beatInBar)*i.beatDuration;case"phrase":{const t=4,e=i.timeSignature[0];return(t-(i.bar||0)%t)*e*i.beatDuration}}}quantize(t,i="eighth"){const e=6e4/(ci.bpm||120),s=(this.noteDurations[i]||1)*e;return Math.round(t/s)*s}isOnBoundary(t="beat",i=50){const e=this.timeToNextBoundary(t),s=ci.getTimeInfo();return!!s&&(e<i||s.beatDuration-e<i)}getTempoAdaptation(t=120){const i=(ci.bpm||120)/t;return{speed:i,energy:Math.min(2,Math.max(.5,i)),smoothness:i<.8?1.2:i>1.5?.8:1,intensity:i>1.3?1.2:i<.7?.8:1}}};class Ti{constructor(t){this.renderer=t,this.activeGestures=new Map,this.scaleFactor=t.scaleFactor||1,this.gestureAnimations={bounce:{active:!1,progress:0,params:{}},pulse:{active:!1,progress:0,params:{}},shake:{active:!1,progress:0,params:{}},spin:{active:!1,progress:0,params:{}},nod:{active:!1,progress:0,params:{}},tilt:{active:!1,progress:0,params:{}},expand:{active:!1,progress:0,params:{}},contract:{active:!1,progress:0,params:{}},flash:{active:!1,progress:0,params:{}},drift:{active:!1,progress:0,params:{}},stretch:{active:!1,progress:0,params:{}},glow:{active:!1,progress:0,params:{}},flicker:{active:!1,progress:0,params:{}},vibrate:{active:!1,progress:0,params:{}},orbital:{active:!1,progress:0,params:{}},hula:{active:!1,progress:0,params:{}},wave:{active:!1,progress:0,params:{}},breathe:{active:!1,progress:0,params:{}},morph:{active:!1,progress:0,params:{}},slowBlink:{active:!1,progress:0,params:{}},look:{active:!1,progress:0,params:{}},settle:{active:!1,progress:0,params:{}},breathIn:{active:!1,progress:0,params:{}},breathOut:{active:!1,progress:0,params:{}},breathHold:{active:!1,progress:0,params:{}},breathHoldEmpty:{active:!1,progress:0,params:{}},jump:{active:!1,progress:0,params:{}},sway:{active:!1,progress:0,params:{}},float:{active:!1,progress:0,params:{}},sparkle:{active:!1,progress:0,params:{}},shimmer:{active:!1,progress:0,params:{}},wiggle:{active:!1,progress:0,params:{}},groove:{active:!1,progress:0,params:{}},point:{active:!1,progress:0,params:{}},lean:{active:!1,progress:0,params:{}},reach:{active:!1,progress:0,params:{}},headBob:{active:!1,progress:0,params:{}},orbit:{active:!1,progress:0,params:{}},rain:{active:!1,progress:0,params:{}},runningman:{active:!1,progress:0,params:{}},charleston:{active:!1,progress:0,params:{}}}}startGesture(t){const i=mi(t);if(["bounce","shake","pulse","flash","jump","slam","spin","flicker"].includes(t)&&this.renderer.specialEffects){const i={flash:1,jump:1,shake:.9,bounce:.8,pulse:.7,slam:1,spin:.8,flicker:1}[t]||.8;this.renderer.specialEffects.triggerChromaticAberration(i)}let e;e=this.renderer.gestureCompositor?this.renderer.gestureCompositor.compose(t,this.renderer.state.emotion,this.renderer.currentUndertone):i?.config||{amplitude:20,frequency:2,duration:1e3,scaleAmount:.2,glowAmount:.3,rotations:1,distance:50,angle:15,scaleTarget:1.5,glowPeak:2,scalePeak:1.1,scaleX:1.2,scaleY:.8,maxOpacity:1,minOpacity:.5,lookDirection:"random",lookDistance:1,wobbleFreq:4,squashAmount:.8,stretchAmount:1.2,jumpHeight:100,decay:!0,easing:"sine",effects:[]};let s=1e3;if(i&&i.config)if(i.config.musicalDuration)s=Ai.toMilliseconds(i.config.musicalDuration);else if(i.config.duration){const{duration:t}=i.config;s=t}const n=this.gestureAnimations[t];n&&(n.active=!0,n.startTime=performance.now(),n.progress=0,n.params=e,n.duration=s,"shake"===t?n.randomAngle=void 0:"drift"===t?(n.startX=void 0,n.startY=void 0,n.currentDriftAngle=void 0):"tilt"===t?n.tiltDirection=void 0:"vibrate"===t&&(n.vibrateAngles=void 0))}applyGestureAnimations(){const t=performance.now(),i={offsetX:0,offsetY:0,scale:1,rotation:0,glow:1};for(const[e,s]of Object.entries(this.gestureAnimations)){if(!s.active)continue;const n=t-s.startTime,h=s.duration||(s.params?s.params.duration:1e3);s.progress=Math.min(n/h,1);const a=this.applyEasing(s.progress,s.params.easing);let r={};switch(e){case"bounce":r=this.applyBounce(s,a);break;case"pulse":r=this.applyPulse(s,a);break;case"shake":r=this.applyShake(s,a);break;case"spin":r=this.applySpin(s,a);break;case"nod":r=this.applyNod(s,a);break;case"tilt":r=this.applyTilt(s,a);break;case"expand":r=this.applyExpand(s,a);break;case"contract":r=this.applyContract(s,a);break;case"flash":r=this.applyFlash(s,a);break;case"drift":r=this.applyDrift(s,a);break;case"stretch":r=this.applyStretch(s,a);break;case"glow":r=this.applyGlow(s,a);break;case"flicker":r=this.applyFlicker(s,a);break;case"vibrate":r=this.applyVibrate(s,a);break;case"orbital":r=this.applyOrbital(s,a);break;case"hula":r=this.applyHula(s,a);break;case"wave":r=this.applyWave(s,a);break;case"breathe":r=this.applyBreathe(s,a);break;case"morph":r=this.applyMorph(s,a);break;case"slowBlink":r=this.applySlowBlink(s,a);break;case"look":r=this.applyLook(s,a);break;case"settle":r=this.applySettle(s,a);break;case"breathIn":r=this.applyBreathIn(s,a);break;case"breathOut":r=this.applyBreathOut(s,a);break;case"breathHold":r=this.applyBreathHold(s,a);break;case"breathHoldEmpty":r=this.applyBreathHoldEmpty(s,a);break;case"jump":r=this.applyJump(s,a);break;case"sway":r=this.applySway(s,a);break;case"float":r=this.applyFloat(s,a);break;case"rain":r=this.applyRain(s,a);break;case"runningman":r=this.applyRunningMan(s,a);break;case"charleston":r=this.applyCharleston(s,a);break;case"sparkle":r=this.applySparkle(s,a);break;case"shimmer":r=this.applyShimmer(s,a);break;case"wiggle":r=this.applyWiggle(s,a);break;case"groove":r=this.applyGroove(s,a);break;case"point":r=this.applyPoint(s,a);break;case"lean":r=this.applyLean(s,a);break;case"reach":r=this.applyReach(s,a);break;case"headBob":r=this.applyHeadBob(s,a);break;case"orbit":r=this.applyOrbit(s,a)}i.offsetX+=r.offsetX||0,i.offsetY+=r.offsetY||0,i.scale*=r.scale||1,i.rotation+=r.rotation||0,i.glow=Math.max(i.glow,r.glow||1),r.flashWave&&(i.flashWave=r.flashWave),r.fireflyEffect&&(i.fireflyEffect=r.fireflyEffect,i.particleGlow=r.particleGlow,i.fireflyTime=r.fireflyTime),r.flickerEffect&&(i.flickerEffect=r.flickerEffect,i.particleGlow=r.particleGlow,i.flickerTime=r.flickerTime),r.shimmerEffect&&(i.shimmerEffect=r.shimmerEffect,i.particleGlow=r.particleGlow,i.shimmerTime=r.shimmerTime,i.shimmerWave=r.shimmerWave),r.glowEffect&&(i.glowEffect=r.glowEffect,i.particleGlow=r.particleGlow,i.glowTime=r.glowTime,i.glowProgress=r.glowProgress,i.glowEnvelope=r.glowEnvelope),s.progress>=1&&(s.active=!1,s.progress=0,s.startTime=0,"flash"===e&&(s.flashWave=null,s.flashWaveData=null),r.glowEffect&&(r.glowEffect=null,r.particleGlow=null,r.glowTime=null,r.glowProgress=null,r.glowEnvelope=null),r.fireflyEffect&&(r.fireflyEffect=null,r.particleGlow=null,r.fireflyTime=null),r.flickerEffect&&(r.flickerEffect=null,r.particleGlow=null,r.flickerTime=null),r.shimmerEffect&&(r.shimmerEffect=null,r.particleGlow=null,r.shimmerTime=null,r.shimmerWave=null))}return i}update(t){return this.applyGestureAnimations()}stopAllGestures(){Object.keys(this.gestureAnimations).forEach(t=>{const i=this.gestureAnimations[t];i.active=!1,i.startTime=0,i.progress=0,i.params=null,i.glowEffect&&(i.glowEffect=null,i.particleGlow=null,i.glowTime=null,i.glowProgress=null,i.glowEnvelope=null),i.fireflyEffect&&(i.fireflyEffect=null,i.particleGlow=null,i.fireflyTime=null),i.flickerEffect&&(i.flickerEffect=null,i.particleGlow=null,i.flickerTime=null),i.shimmerEffect&&(i.shimmerEffect=null,i.particleGlow=null,i.shimmerTime=null,i.shimmerWave=null),i.flashWave&&(i.flashWave=null,i.flashWaveData=null)}),this.activeGestures.clear()}getCurrentGesture(){const t=["orbital","hula","wave","spin"];for(const i of t){const t=this.gestureAnimations[i];if(t&&t.active){const e=mi(i);return{name:i,particleMotion:e?.config?.particleMotion||{type:i,strength:t.params?.strength||1},progress:t.progress||0,params:t.params}}}for(const[t,i]of Object.entries(this.gestureAnimations))if(i.active){const e=mi(t),s={name:t,particleMotion:e?.config?.particleMotion||i.params?.particleMotion||{type:t,strength:i.params?.strength||1},progress:i.progress||0,params:i.params};return"breathe"===t&&void 0!==i.breathPhase&&(s.breathPhase=i.breathPhase),s}return null}applyEasing(t,i){switch(i){case"linear":default:return t;case"quad":return t*t;case"cubic":return t*t*t;case"sine":return Math.sin(t*Math.PI/2);case"back":return t*t*(2.7*t-1.7)}}applyBounce(t,i){return{offsetY:-Math.abs(Math.sin(i*Math.PI*t.params.frequency))*t.params.amplitude*this.scaleFactor*(t.params.effects&&t.params.effects.includes("gravity")?.6:1)}}applyPulse(t,i){const e=Math.sin(i*Math.PI*t.params.frequency);return{scale:1+e*t.params.scaleAmount,glow:1+e*t.params.glowAmount}}applyShake(t,i){t.randomAngle||(t.randomAngle=Math.random()*Math.PI*2);const e=t.params.decay?1-i:1,s=Math.sin(i*Math.PI*t.params.frequency)*t.params.amplitude*e*this.scaleFactor;return{offsetX:s*Math.cos(t.randomAngle),offsetY:s*Math.sin(t.randomAngle)}}applySpin(t,i){return{rotation:Math.min(1.05*i,1)*t.params.rotations*360,scale:1+Math.sin(i*Math.PI)*t.params.scaleAmount}}applyNod(t,i){return{offsetY:Math.sin(i*Math.PI*t.params.frequency)*t.params.amplitude*this.scaleFactor}}applyTilt(t,i){t.tiltDirection||(t.tiltDirection=Math.random()<.5?-1:1);const e=t.params.frequency||2,s=(t.params.angle||15)*Math.PI/180,n=Math.sin(i*Math.PI*e)*t.tiltDirection;return{rotation:n*s,scaleX:1+.1*Math.abs(n),scaleY:1-.05*Math.abs(n),offsetX:10*n,offsetY:-5*Math.abs(n)}}applyExpand(t,i){const e=Math.max(t.params.scaleAmount||t.params.scaleTarget||1.5,1),s=Math.sin(i*Math.PI/2);return{scale:1+(e-1)*s,glow:1+Math.abs(t.params.glowAmount||.2)*s}}applyContract(t,i){const e=t.params.scaleAmount||t.params.scaleTarget||.7,s=Math.sin(i*Math.PI/2);return{scale:1+(e-1)*s,glow:1+(t.params.glowAmount||-.2)*s}}applyFlash(t,i){const e=Math.sin(i*Math.PI);return{glow:1+((t.params.glowPeak||2)-1)*e,scale:1+((t.params.scalePeak||1.1)-1)*e}}applyDrift(t,i){i<=.01&&!t.currentDriftAngle&&(t.currentDriftAngle=Math.random()*Math.PI*2);const e=t.params.distance*Math.sin(i*Math.PI)*this.scaleFactor,s=t.currentDriftAngle||0;return i>=.99&&(t.currentDriftAngle=null),{offsetX:Math.cos(s)*e,offsetY:Math.sin(s)*e}}applyStretch(t,i){const e=Math.sin(i*Math.PI*t.params.frequency);return{scale:1+((t.params.scaleX+t.params.scaleY)/2-1)*e}}applyGlow(t,i){const e=Math.sin(i*Math.PI*t.params.frequency);return{scale:1+e*(t.params.scaleAmount||.1),glow:1+e*(t.params.glowAmount||.8)}}applyFlashWave(t,i){t.flashWave||(t.flashWave={innerRadius:0,outerRadius:0,maxRadius:3}),t.flashWave.outerRadius=i*t.flashWave.maxRadius,t.flashWave.innerRadius=Math.max(0,(i-.1)*t.flashWave.maxRadius);const e=Math.max(0,1-.7*i);return t.flashWaveData={innerRadius:t.flashWave.innerRadius,outerRadius:t.flashWave.outerRadius,intensity:e},{glow:1+.3*e,flashWave:t.flashWaveData}}applyFlicker(t,i){const e=t.params?.intensity||2,s=t.params?.speed||3,n=1+Math.sin(i*Math.PI*2*s)*e*.3,h=5*Math.sin(i*Math.PI*4)*this.scaleFactor,a=.001*Date.now();return{offsetX:h,glow:n,particleGlow:e*(.5*Math.sin(i*Math.PI*s*2)+.5),flickerTime:a,flickerEffect:!0}}applyVibrate(t,i){if(!t.vibrateAngles){t.vibrateAngles={x:2*Math.random()-1,y:2*Math.random()-1};const i=Math.sqrt(t.vibrateAngles.x**2+t.vibrateAngles.y**2);t.vibrateAngles.x/=i,t.vibrateAngles.y/=i}const e=Math.sin(i*Math.PI*2*t.params.frequency)*t.params.amplitude*this.scaleFactor;return{offsetX:e*t.vibrateAngles.x,offsetY:e*t.vibrateAngles.y}}applyWave(t,i){const e=(t.params.amplitude||40)*this.scaleFactor,s=i*Math.PI*2,n=Math.sin(s)*e,h=-Math.sin(i*Math.PI)*e*.3;return{offsetX:n,offsetY:Math.sin(2*s)*e*.2+h,rotation:5*Math.sin(s),scale:1+.05*Math.sin(i*Math.PI*2),glow:1+.2*Math.sin(i*Math.PI)}}applyBreathe(t,i){const{params:e}=t,s=e.particleMotion?.holdPercent||.1;let n;if(i<.4)n=Math.sin(i/.4*Math.PI/2);else if(i<.4+s)n=1;else if(i<.9){const t=(i-.4-s)/(.5-s);n=Math.cos(t*Math.PI/2)}else n=0;const h=1+n*(e.scaleAmount||.25),a=1+n*(e.glowAmount||.4);return t.breathPhase=n,{scale:h,glow:a,breathPhase:n}}applyMorph(t,i){const e=Math.sin(i*Math.PI*2);return{scale:1+.1*e,rotation:10*e}}applySlowBlink(t,i){let e=1;return e=i<.3?1-i/.3:i<.5?0:i<.8?(i-.5)/.3:1,{glow:e}}applyLook(t,i){if(!t.targetX){const i=t.params.lookDirection,e=50*t.params.lookDistance*this.scaleFactor;switch(i){case"left":t.targetX=-e,t.targetY=0;break;case"right":t.targetX=e,t.targetY=0;break;case"up":t.targetX=0,t.targetY=-e;break;case"down":t.targetX=0,t.targetY=e;break;default:{const i=Math.random()*Math.PI*2;t.targetX=Math.cos(i)*e,t.targetY=Math.sin(i)*e;break}}}let e=i;return e=i<.3?i/.3:i<.7?1:1-(i-.7)/.3,{offsetX:t.targetX*e,offsetY:t.targetY*e}}applySettle(t,i){const e=Math.sin(i*Math.PI*t.params.wobbleFreq)*Math.exp(3*-i)*20*this.scaleFactor;return{offsetY:e,scale:1+.01*e}}applyBreathIn(t,i){return{scale:1+(t.params.scaleAmount-1)*Math.sin(i*Math.PI/2)}}applyBreathOut(t,i){return{scale:1-(1-t.params.scaleAmount)*Math.sin(i*Math.PI/2)}}applyBreathHold(t,i){return{scale:t.params.scaleAmount}}applyBreathHoldEmpty(t,i){return{scale:t.params.scaleAmount}}applyJump(t,i){let e=0,s=1;if(i<.2){const e=i/.2;s=1-(1-t.params.squashAmount)*e}else if(i<.7){const n=(i-.2)/.5,h=Math.sin(n*Math.PI);e=-t.params.jumpHeight*h*this.scaleFactor,s=t.params.squashAmount+(t.params.stretchAmount-t.params.squashAmount)*h}else{const e=(i-.7)/.3;s=t.params.stretchAmount-(t.params.stretchAmount-1)*e}return{offsetY:e,scale:s}}applySway(t,i){const e=(t.params?.amplitude||30)*this.scaleFactor,s=t.params?.frequency||1;return{offsetX:Math.sin(i*Math.PI*2*s)*e,offsetY:Math.sin(i*Math.PI*4*s)*e*.1,rotation:5*Math.sin(i*Math.PI*2*s)}}applyRain(t,i){const e=t.params?.intensity||1,s=10*i*this.scaleFactor*e,n=5*Math.sin(i*Math.PI*4)*this.scaleFactor;return this.renderer&&this.renderer.particleSystem&&this.renderer.particleSystem.setGestureBehavior("falling",i>0&&i<1),{offsetX:n,offsetY:s,particleEffect:"falling"}}applyFloat(t,i){const e=(t.params?.amplitude||20)*this.scaleFactor,s=t.params?.speed||1,n=Math.sin(i*Math.PI*2*s)*e;return{offsetX:Math.sin(i*Math.PI*3*s)*e*.3,offsetY:n,scale:1+.02*Math.sin(i*Math.PI*4*s)}}applyOrbital(t,i){return{offsetX:0,offsetY:0}}applyHula(t,i){const e=(t.params?.amplitude||40)*this.scaleFactor,s=i*Math.PI*2;return{offsetX:Math.sin(s)*e,offsetY:Math.sin(2*s)*e*.5}}applySparkle(t,i){const e=t.params?.intensity||2,s=.001*Date.now();return{particleGlow:e,glow:.3*Math.sin(i*Math.PI*4)+.7,fireflyTime:s,fireflyEffect:!0}}applyShimmer(t,i){const e=.001*Date.now(),s=t.params?.intensity||.3,n=Math.sin(2*e+i*Math.PI*2);return{offsetX:0,offsetY:0,glow:1+n*s,scale:1+.01*n,particleGlow:1+.2*n,shimmerTime:e,shimmerWave:n,shimmerEffect:!0}}applyWiggle(t,i){const e=(t.params?.amplitude||15)*this.scaleFactor;void 0===t.wiggleDirection&&(t.wiggleDirection=Math.random()<.5?1:-1);const s=t.wiggleDirection;let n=0,h=0;if(i<.25){const t=i/.25;n=e*s*t,h=3*s*t}else if(i<.5){const t=(i-.25)/.25;n=e*s*(1-2*t),h=3*s*(1-2*t)}else if(i<.75){const t=(i-.5)/.25;n=e*-s*(1-2*t),h=3*-s*(1-2*t)}else{const t=(i-.75)/.25;n=e*s*(1-t),h=3*s*(1-t)}return{offsetX:n,offsetY:-Math.abs(Math.sin(i*Math.PI*4))*e*.15,rotation:h}}applyGroove(t,i){const e=(t.params?.amplitude||25)*this.scaleFactor;return{offsetX:Math.sin(i*Math.PI*2)*e+Math.sin(i*Math.PI*3+.5)*e*.4,offsetY:Math.sin(i*Math.PI*4+.3)*e*.25,scale:1+.03*Math.sin(i*Math.PI*3+.7),rotation:8*Math.sin(i*Math.PI*2+.2)}}applyPoint(t,i){void 0===t.pointDirection&&(t.pointDirection=Math.random()<.5?-1:1);const e=void 0!==t.params?.direction?t.params.direction:t.pointDirection,s=(t.params?.distance||40)*this.scaleFactor;let n,h;return i<.4?(n=1-Math.pow(1-i/.4,3),h=n):i<.6?(n=1,h=1):(n=Math.pow(1-(i-.6)/.4,3),h=n),{offsetX:e*s*n,offsetY:-Math.abs(.15*s*n),scale:1+.15*h,rotation:5*e*h}}applyLean(t,i){const e=t.params?.angle||15,s=t.params?.side||1,n=Math.sin(i*Math.PI),h=e*s*n;return{offsetX:10*s*this.scaleFactor*n,rotation:h}}applyReach(t,i){const e=t.params?.direction||-Math.PI/2,s=(t.params?.distance||40)*this.scaleFactor;let n;return n=i<.4?i/.4:i<.6?1:1-(i-.6)/.4,n=n*n*(3-2*n),{offsetX:Math.cos(e)*s*n,offsetY:Math.sin(e)*s*n,scale:1+.15*n}}applyHeadBob(t,i){const e=(t.params?.amplitude||20)*this.scaleFactor,s=i*(t.params?.frequency||2)%1;let n;return n=s<.3?s/.3*-e:-e*(1-(s-.3)/.7),{offsetY:n,rotation:s<.3?-3:0}}applyOrbit(t,i){const e=(t.params?.radius||30)*this.scaleFactor,s=t.params?.speed||1,n=i*Math.PI*2*s;return{offsetX:Math.cos(n)*e,offsetY:Math.sin(n)*e}}startBounce(){this.startGesture("bounce")}startPulse(){this.startGesture("pulse")}startShake(){this.startGesture("shake")}startSpin(){this.startGesture("spin")}startNod(){this.startGesture("nod")}startTilt(){this.startGesture("tilt")}startExpand(){this.startGesture("expand")}startContract(){this.startGesture("contract")}startFlash(){this.startGesture("flash")}startDrift(){this.startGesture("drift")}startStretch(){this.startGesture("stretch")}startGlow(){this.startGesture("glow")}startFlicker(){this.startGesture("flicker")}startVibrate(){this.startGesture("vibrate")}startOrbital(){this.startGesture("orbital")}startHula(){this.startGesture("hula")}startWave(){this.startGesture("wave")}startBreathe(){this.startGesture("breathe")}startMorph(){this.startGesture("morph")}startSlowBlink(){this.startGesture("slowBlink")}startLook(){this.startGesture("look")}startSettle(){this.startGesture("settle")}startBreathIn(){this.startGesture("breathIn")}startBreathOut(){this.startGesture("breathOut")}startBreathHold(){this.startGesture("breathHold")}startBreathHoldEmpty(){this.startGesture("breathHoldEmpty")}startJump(){this.startGesture("jump")}startSway(){this.startGesture("sway")}startFloat(){this.startGesture("float")}startRain(){this.startGesture("rain")}startRunningMan(){this.startGesture("runningman")}startCharleston(){this.startGesture("charleston")}startSparkle(){this.startGesture("sparkle")}startShimmer(){this.startGesture("shimmer")}startWiggle(){this.startGesture("wiggle")}startGroove(){this.startGesture("groove")}startPoint(){this.startGesture("point")}startLean(){this.startGesture("lean")}startReach(){this.startGesture("reach")}startHeadBob(){this.startGesture("headBob")}startOrbit(){this.startGesture("orbit")}applyRunningMan(t,i){const e=20*Math.sin(i*Math.PI*4)*this.scaleFactor;return{offsetX:e,offsetY:10*-Math.abs(Math.sin(i*Math.PI*8))*this.scaleFactor,rotation:.3*e,scaleY:1-.05*Math.abs(Math.sin(i*Math.PI*8))}}applyCharleston(t,i){const e=25*Math.sin(i*Math.PI*8)*this.scaleFactor;return{offsetX:e,offsetY:10*-Math.abs(Math.sin(i*Math.PI*8))*this.scaleFactor,rotation:.6*e,scaleY:1-.06*Math.abs(Math.sin(i*Math.PI*8))}}startRunningManGesture(){this.startGesture("runningman")}startCharlestonGesture(){this.startGesture("charleston")}pauseCurrentAnimation(){const t=performance.now();for(const[i,e]of Object.entries(this.gestureAnimations))e.active&&(e.pausedAt=t,e.pausedProgress=e.progress);this.isPaused=!0}resumeAnimation(){if(!this.isPaused)return;const t=performance.now();for(const[i,e]of Object.entries(this.gestureAnimations))if(e.active&&e.pausedAt){const i=t-e.pausedAt;e.startTime&&(e.startTime+=i),delete e.pausedAt,delete e.pausedProgress}this.isPaused=!1}reset(){for(const[t,i]of Object.entries(this.gestureAnimations))i.active=!1,i.progress=0,i.params={},delete i.startTime,delete i.pausedAt,delete i.pausedProgress;this.activeGestures.clear(),this.isPaused=!1}}class Oi{constructor(){this.colorTransition=null}applyUndertoneModifiers(t,i){return i}applyUndertoneToColor(t,i){if(i&&"object"==typeof i&&void 0!==i.weight){const{weight:e}=i,s=i.type||"clear";if("clear"===s||0===e)return t;const n=this.applyUndertoneSaturation(t,s),h=this.hexToRgb(t),a=this.hexToRgb(n),r=Math.round(h.r+(a.r-h.r)*e),o=Math.round(h.g+(a.g-h.g)*e),c=Math.round(h.b+(a.b-h.b)*e);return this.rgbToHex(r,o,c)}return i&&"clear"!==i?this.applyUndertoneSaturation(t,i):t}hexToRgb(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}rgbToHsl(t,i,e){t/=255,i/=255,e/=255;const s=Math.max(t,i,e),n=Math.min(t,i,e);let h,a,r=(s+n)/2;if(s===n)h=a=0;else{const o=s-n;switch(a=r>.5?o/(2-s-n):o/(s+n),s){case t:h=((i-e)/o+(i<e?6:0))/6;break;case i:h=((e-t)/o+2)/6;break;case e:h=((t-i)/o+4)/6}}return{h:360*h,s:100*a,l:100*r}}hslToHex(t,i,e){let s,n,h;if(t/=360,e/=100,0==(i/=100))s=n=h=e;else{const a=(t,i,e)=>(e<0&&(e+=1),e>1&&(e-=1),e<1/6?t+6*(i-t)*e:e<.5?i:e<2/3?t+(i-t)*(2/3-e)*6:t),r=e<.5?e*(1+i):e+i-e*i,o=2*e-r;s=a(o,r,t+1/3),n=a(o,r,t),h=a(o,r,t-1/3)}const a=t=>{const i=Math.round(255*t).toString(16);return 1===i.length?`0${i}`:i};return`#${a(s)}${a(n)}${a(h)}`}applyUndertoneSaturation(t,i){const e=this.hexToRgb(t),s=this.rgbToHsl(e.r,e.g,e.b),n={intense:1.5,confident:1.3,energetic:1.2,upbeat:1.2,nervous:1.15,mellow:.8,tired:.8,subdued:.5}[i]||1;return s.s=Math.min(100,s.s*n),this.hslToHex(s.h,s.s,s.l)}rgbToHex(t,i,e){const s=t=>{const i=Math.round(t).toString(16);return 1===i.length?`0${i}`:i};return`#${s(t)}${s(i)}${s(e)}`}startColorTransition(t,i,e=1500){this.currentColor===t&&this.currentIntensity===i||(this.colorTransition={active:!0,fromColor:this.currentColor||"#ffffff",toColor:t,fromIntensity:this.currentIntensity||1,toIntensity:i,progress:0,startTime:performance.now(),duration:e})}updateColorTransition(t){if(!this.colorTransition||!this.colorTransition.active)return null;const i=performance.now()-this.colorTransition.startTime,e=Math.min(i/this.colorTransition.duration,1),s=1-Math.pow(1-e,2),n=this.hexToRgb(this.colorTransition.fromColor),h=this.hexToRgb(this.colorTransition.toColor),a=Math.round(n.r+(h.r-n.r)*s),r=Math.round(n.g+(h.g-n.g)*s),o=Math.round(n.b+(h.b-n.b)*s),c=this.rgbToHex(a,r,o),l=this.colorTransition.fromIntensity+(this.colorTransition.toIntensity-this.colorTransition.fromIntensity)*s;return this.currentColor=c,this.currentIntensity=l,e>=1&&(this.colorTransition.active=!1),{color:c,intensity:l}}}class Ri{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvasManager?.canvas||t.canvas,this.recordingActive=!1,this.sleepMode=!1,this.speakingActive=!1,this.zenModeActive=!1,this.speakingRings=[],this.ringSpawnTimer=0,this.ringSpawnInterval=300,this.maxRings=3,this.sleepZ=[],this.sparkles=[],this.chromaticAberration={active:!1,intensity:0,targetIntensity:0,fadeSpeed:.01,maxOffset:30},this.scaleValue=i=>t.scaleValue(i),this.hexToRgba=(i,e)=>t.hexToRgba(i,e)}renderRecordingGlow(t,i,e,s){const{ctx:n}=this,h=2.5*e,a=n.createRadialGradient(t,i,0,t,i,h);a.addColorStop(0,`rgba(255, 0, 0, ${.3*s})`),a.addColorStop(.5,`rgba(255, 0, 0, ${.15*s})`),a.addColorStop(1,"rgba(255, 0, 0, 0)"),n.save(),n.globalCompositeOperation="screen",n.fillStyle=a,n.fillRect(t-h,i-h,2*h,2*h),n.restore()}renderRecordingIndicator(t,i){const e=Date.now()/1e3,s=.8+.2*Math.sin(2*e);this.ctx.save(),this.ctx.translate(t,i),this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=`rgba(255, 0, 0, ${.8*s})`;const n=this.scaleValue(80);this.ctx.font=`italic 900 ${n}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 0, 0, ${s})`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("REC",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic 900 ${n-1}px "Poppins", sans-serif`,this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*s})`,this.ctx.fillText("REC",-.5,-.5),this.ctx.restore()}renderSleepIndicator(t,i,e){if(this.ringSpawnTimer+=e,this.ringSpawnTimer>=2e3&&this.sleepZ.length<3){const e=["300","500","700","900"],s=e[Math.floor(Math.random()*e.length)],n=Math.random()>.5?"Z":"z";this.sleepZ.push({x:t+Math.random()*this.scaleValue(30)-this.scaleValue(15),y:i+this.scaleValue(80),size:this.scaleValue(3*(24+8*Math.random())),opacity:1,speed:-.025,drift:Math.random()*this.scaleValue(20)-this.scaleValue(10),lifetime:0,rotation:30*Math.random()-15,text:n,weight:s}),this.ringSpawnTimer=0}this.sleepZ=this.sleepZ.filter(t=>{t.lifetime+=e,t.y+=t.speed*e,t.x+=Math.sin(8e-4*t.lifetime)*t.drift*.008,t.rotation+=.01*e;if(t.lifetime<2e3?t.opacity=1:t.lifetime<4e3?t.opacity=1-(t.lifetime-2e3)/2e3:t.opacity=0,t.opacity>.01){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation*Math.PI/180);const i=this.renderer.state.glowColor||"#4a90e2";this.ctx.shadowBlur=this.scaleValue(15),this.ctx.shadowColor=this.hexToRgba(i,.5*t.opacity);const e=this.ctx.createLinearGradient(-t.size/2,-t.size/2,t.size/2,t.size/2);return e.addColorStop(0,this.hexToRgba(i,t.opacity)),e.addColorStop(.5,this.hexToRgba("#ffffff",.9*t.opacity)),e.addColorStop(1,this.hexToRgba(i,.7*t.opacity)),this.ctx.font=`italic ${t.weight||"900"} ${t.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=e,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.text||"Z",0,0),this.ctx.shadowBlur=0,this.ctx.font=`italic ${t.weight||"900"} ${.9*t.size}px 'Poppins', sans-serif`,this.ctx.fillStyle=this.hexToRgba("#ffffff",.3*t.opacity),this.ctx.fillText(t.text||"Z",-1,-1),this.ctx.restore(),!0}return!1})}renderSpeakingRings(t,i,e,s){this.ringSpawnTimer+=s,this.ringSpawnTimer>=this.ringSpawnInterval&&this.speakingRings.length<this.maxRings&&(this.speakingRings.push({radius:e,opacity:.8,speed:.15}),this.ringSpawnTimer=0),this.speakingRings=this.speakingRings.filter(n=>(n.radius+=n.speed*s,n.opacity=Math.max(0,.8*(1-(n.radius-e)/(2*e))),n.opacity>.01&&(this.ctx.strokeStyle=this.hexToRgba(this.renderer.state.glowColor,n.opacity),this.ctx.lineWidth=this.scaleValue(2),this.ctx.beginPath(),this.ctx.arc(t,i,n.radius,0,2*Math.PI),this.ctx.stroke(),!0)))}renderZenCore(t,i,e,s){const{ctx:n}=this,h=e*(.9+.1*(.5*Math.sin(.001*s)+.5)),a=n.createRadialGradient(t,i,0,t,i,h);a.addColorStop(0,"rgba(147, 112, 219, 0.8)"),a.addColorStop(.7,"rgba(147, 112, 219, 0.3)"),a.addColorStop(1,"rgba(147, 112, 219, 0)"),n.save(),n.globalCompositeOperation="screen",n.fillStyle=a,n.beginPath(),n.arc(t,i,1.5*h,0,2*Math.PI),n.fill(),n.restore()}startRecording(){this.recordingActive=!0}stopRecording(){this.recordingActive=!1}enterSleepMode(){this.sleepMode=!0}wakeUp(){this.sleepMode=!1}startSpeaking(){this.speakingActive=!0}stopSpeaking(){this.speakingActive=!1}createSparkle(t,i,e={}){this.sparkles.push({x:t,y:i,vx:e.velocity?.x||0,vy:e.velocity?.y||0,size:e.size||3,color:e.color||"hsl(50, 100%, 70%)",lifetime:e.lifetime||1e3,maxLifetime:e.lifetime||1e3,rotation:Math.random()*Math.PI*2,rotationSpeed:.2*(Math.random()-.5)})}renderSparkles(){const{ctx:t}=this;this.sparkles.forEach(i=>{const e=1-i.lifetime/i.maxLifetime,s=1-e;t.save(),t.translate(i.x,i.y),t.rotate(i.rotation);const n=this.scaleValue(i.size*(1-.5*e));t.beginPath();const h=n,a=.38*n;for(let i=0;i<10;i++){const e=i*Math.PI/5-Math.PI/2,s=i%2==0?h:a;0===i?t.moveTo(Math.cos(e)*s,Math.sin(e)*s):t.lineTo(Math.cos(e)*s,Math.sin(e)*s)}t.closePath(),t.shadowBlur=this.scaleValue(10),t.shadowColor=i.color,t.fillStyle=i.color.replace("70%",70+30*e+"%").replace(")",`, ${s})`).replace("hsl","hsla"),t.fill(),t.restore()})}triggerChromaticAberration(t=.8){this.chromaticAberration.active=!0,this.chromaticAberration.targetIntensity=Math.min(1,t),this.chromaticAberration.intensity=this.chromaticAberration.targetIntensity;const i=document.getElementById("emotive-canvas")||document.querySelector("canvas")||this.canvas;if(i){if(i.style.animation="none",!document.getElementById("chromatic-styles")){const t=document.createElement("style");t.id="chromatic-styles",t.textContent="\n                    @keyframes chromaticGlitch {\n                        0% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                        15% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.7)) drop-shadow(2px 0 0 rgba(0,255,255,0.7));\n                            transform: translateX(-0.5px);\n                        }\n                        30% {\n                            filter: drop-shadow(-3px 0 0 rgba(255,0,0,0.8)) drop-shadow(3px 0 0 rgba(0,255,255,0.8));\n                            transform: translateX(0.5px);\n                        }\n                        45% {\n                            filter: drop-shadow(-2px 0 0 rgba(255,0,0,0.6)) drop-shadow(2px 0 0 rgba(0,255,255,0.6));\n                            transform: translateX(-0.3px);\n                        }\n                        60% {\n                            filter: drop-shadow(-1px 0 0 rgba(255,0,0,0.4)) drop-shadow(1px 0 0 rgba(0,255,255,0.4));\n                            transform: translateX(0.2px);\n                        }\n                        100% {\n                            filter: none;\n                            transform: translateX(0);\n                        }\n                    }\n                ",document.head.appendChild(t)}i.style.animation=`chromaticGlitch ${300+200*t}ms ease-out`}}applyChromaticAberration(t,i){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return;const{intensity:e}=this.chromaticAberration,s=this.scaleValue(this.chromaticAberration.maxOffset*e),n=t.globalCompositeOperation;t.save(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation="source-over",t.filter="url(#red-channel)",t.drawImage(i,-s,0),t.globalCompositeOperation="screen",t.filter="url(#green-channel)",t.drawImage(i,0,0),t.globalCompositeOperation="screen",t.filter="url(#blue-channel)",t.drawImage(i,s,0),t.filter="none",t.globalCompositeOperation=n,t.restore()}applyChromaticAberrationSimple(t,i,e,s,n){if(!this.chromaticAberration.active||this.chromaticAberration.intensity<=0)return void n();const{intensity:h}=this.chromaticAberration,a=this.scaleValue(this.chromaticAberration.maxOffset*h);t.save(),t.globalCompositeOperation="source-over",t.translate(-a,0),t.globalAlpha=.33,t.fillStyle="#ff0000",t.filter="brightness(3)",n(),t.translate(a,0),t.globalCompositeOperation="screen",t.globalAlpha=.33,t.fillStyle="#00ff00",n(),t.translate(a,0),t.globalAlpha=.33,t.fillStyle="#0000ff",n(),t.restore()}update(t){this.sparkles=this.sparkles.filter(i=>(i.x+=i.vx,i.y+=i.vy,i.rotation+=i.rotationSpeed,i.lifetime-=t,i.vy+=.1,i.lifetime>0)),this.chromaticAberration.active&&(this.chromaticAberration.intensity-=this.chromaticAberration.fadeSpeed,this.chromaticAberration.intensity<=0&&(this.chromaticAberration.intensity=0,this.chromaticAberration.active=!1,this.chromaticAberration.targetIntensity=0))}}class zi{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.blinking=!1,this.blinkingEnabled=!0,this.blinkTimer=0,this.nextBlinkTime=this.getRandomBlinkTime(),this.squintAmount=0,this.eyeClose=null,this.eyeOpen=null,this.scaleValue=i=>t.scaleValue(i),this.hexToRgba=(i,e)=>t.hexToRgba(i,e)}update(t){this.blinking&&(this.blinkTimer+=t,this.blinkTimer>=150&&(this.blinking=!1,this.blinkTimer=0,this.nextBlinkTime=Date.now()+this.getRandomBlinkTime())),this.blinkingEnabled&&!this.blinking&&Date.now()>=this.nextBlinkTime&&this.startBlink()}startBlink(){this.blinkingEnabled&&(this.blinking=!0,this.blinkTimer=0)}getRandomBlinkTime(){return 3e3+4e3*Math.random()}getBlinkScale(){if(!this.blinking)return 1;const t=Math.min(this.blinkTimer/150,1);return 1-.7*Math.sin(t*Math.PI)}drawEyes(t,i,e,s,n={}){const{ctx:h}=this,a=n.eyeOpenness||1,r=n.eyeExpression||"neutral";if("zen"===s||"neutral"===s||a<=0)return;h.save(),h.strokeStyle="rgba(0, 0, 0, 0.3)",h.lineWidth=this.scaleValue(2),h.lineCap="round";const o=.4*e,c=i-.1*e,l=.25*e;switch(r){case"happy":this.drawHappyEyes(h,t,c,o,l,a);break;case"sad":this.drawSadEyes(h,t,c,o,l,a);break;case"angry":this.drawAngryEyes(h,t,c,o,l,a);break;case"surprised":this.drawSurprisedEyes(h,t,c,o,l,a);break;case"focused":this.drawFocusedEyes(h,t,c,o,l,a);break;case"sleepy":this.drawSleepyEyes(h,t,c,o,l,a);break;case"suspicious":this.drawSuspiciousEyes(h,t,c,o,l,a)}h.restore()}drawHappyEyes(t,i,e,s,n,h){t.beginPath(),t.arc(i-s,e,n,.2*Math.PI,.8*Math.PI,!1),t.stroke(),t.beginPath(),t.arc(i+s,e,n,.2*Math.PI,.8*Math.PI,!1),t.stroke()}drawSadEyes(t,i,e,s,n,h){t.beginPath(),t.arc(i-s,e+.5*n,n,1.2*Math.PI,1.8*Math.PI,!1),t.stroke(),t.beginPath(),t.arc(i+s,e+.5*n,n,1.2*Math.PI,1.8*Math.PI,!1),t.stroke()}drawAngryEyes(t,i,e,s,n,h){t.beginPath(),t.moveTo(i-s-n,e-.3*n),t.lineTo(i-s+.5*n,e+.3*n),t.stroke(),t.beginPath(),t.moveTo(i+s+n,e-.3*n),t.lineTo(i+s-.5*n,e+.3*n),t.stroke()}drawSurprisedEyes(t,i,e,s,n,h){t.beginPath(),t.arc(i-s,e,1.2*n,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(i+s,e,1.2*n,0,2*Math.PI),t.stroke()}drawFocusedEyes(t,i,e,s,n,h){t.fillStyle="rgba(0, 0, 0, 0.4)",t.beginPath(),t.arc(i-s,e,.3*n,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i+s,e,.3*n,0,2*Math.PI),t.fill()}drawSleepyEyes(t,i,e,s,n,h){t.beginPath(),t.moveTo(i-s-n,e),t.lineTo(i-s+n,e),t.stroke(),t.beginPath(),t.moveTo(i+s-n,e),t.lineTo(i+s+n,e),t.stroke()}drawSuspiciousEyes(t,i,e,s,n,h){t.beginPath(),t.moveTo(i-s-n,e),t.lineTo(i-s+.7*n,e),t.stroke(),t.beginPath(),t.arc(i+s,e,.8*n,.1*Math.PI,.9*Math.PI,!1),t.stroke()}setBlinkingEnabled(t){this.blinkingEnabled=t,t||(this.blinking=!1,this.blinkTimer=0)}setSquintAmount(t){this.squintAmount=Math.max(0,Math.min(1,t))}forceBlink(){this.startBlink()}}class Ei{constructor(t){this.renderer=t,this.breathingSpeed=.42,this.breathingDepth=.08,this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null,this.emotionBreathPatterns={happy:{rate:1.1,depth:1.2},sad:{rate:.8,depth:.7},angry:{rate:1.4,depth:1.3},calm:{rate:.7,depth:.9},excited:{rate:1.5,depth:1.4},focused:{rate:.9,depth:.6},neutral:{rate:1,depth:1},love:{rate:1.2,depth:1.3},surprised:{rate:1.3,depth:1.1},confused:{rate:1.1,depth:.9},amused:{rate:1.2,depth:1.1},bored:{rate:.6,depth:.8},tired:{rate:.5,depth:1.2},anxious:{rate:1.6,depth:.9},determined:{rate:1.1,depth:1},proud:{rate:.9,depth:1.3},content:{rate:.8,depth:1},hopeful:{rate:1,depth:1.1},zen:{rate:.4,depth:1.5},intrigued:{rate:1.1,depth:.8},embarrassed:{rate:1.3,depth:.7},grateful:{rate:.9,depth:1.1},inspired:{rate:1,depth:1.3},silly:{rate:1.4,depth:1.2},sleepy:{rate:.3,depth:1.4}}}update(t,i,e={}){e=e||{};const s=this.emotionBreathPatterns[i]||{rate:1,depth:1},n=e?.breathRateMult||1,h=e?.breathDepthMult||1;this.breathRate=s.rate*this.breathRateMult*n,this.breathDepth=this.breathingDepth*s.depth*this.breathDepthMult*h;let a=this.breathingSpeed*this.breathRate*(t/1e3);this.breathIrregular&&e?.breathIrregular&&(a*=.8+.4*Math.sin(3e-4*Date.now())),this.breathingPhase+=a,this.breathingPhase>2*Math.PI&&(this.breathingPhase-=2*Math.PI)}getBreathingScale(){return null!==this.customScale?this.customScale:1+Math.sin(this.breathingPhase)*this.breathDepth}setCustomScale(t){this.customScale=t}setBreathingSpeed(t){this.breathingSpeed=t}setBreathingDepth(t){this.breathingDepth=Math.max(0,Math.min(1,t))}setBreathRateMultiplier(t){this.breathRateMult=t}setBreathDepthMultiplier(t){this.breathDepthMult=t}setIrregularBreathing(t){this.breathIrregular=t}reset(){this.breathingPhase=0,this.breathRate=1,this.breathDepth=this.breathingDepth,this.breathRateMult=1,this.breathDepthMult=1,this.breathIrregular=!1,this.customScale=null}holdBreath(t=!1){this.customScale=t?.92:1.08}releaseBreath(){this.customScale=null}getBreathingInfo(){return{phase:this.breathingPhase,rate:this.breathRate,depth:this.breathDepth,scale:this.getBreathingScale(),isCustom:null!==this.customScale,isIrregular:this.breathIrregular}}}const qi=new class{constructor(){this.cache=new Map,this.stats={hits:0,misses:0,evictions:0},this.maxSize=100,this.ttl=6e4,this.accessOrder=[]}generateKey(t,i){if("radial"===t){const{x0:t,y0:e,r0:s,x1:n,y1:h,r1:a,stops:r}=i;return`radial:${t},${e},${s},${n},${h},${a}:${r.map(t=>`${t.offset}:${t.color}`).join("|")}`}if("linear"===t){const{x0:t,y0:e,x1:s,y1:n,stops:h}=i;return`linear:${t},${e},${s},${n}:${h.map(t=>`${t.offset}:${t.color}`).join("|")}`}return null}getRadialGradient(t,i,e,s,n,h,a,r){const o=this.generateKey("radial",{x0:i,y0:e,r0:s,x1:n,y1:h,r1:a,stops:r}),c=this.cache.get(o);if(c&&Date.now()-c.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(o),c.gradient;this.stats.misses++;const l=t.createRadialGradient(i,e,s,n,h,a);return r.forEach(t=>{l.addColorStop(t.offset,t.color)}),this.set(o,l),l}getLinearGradient(t,i,e,s,n,h){const a=this.generateKey("linear",{x0:i,y0:e,x1:s,y1:n,stops:h}),r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.ttl)return this.stats.hits++,this.updateAccessOrder(a),r.gradient;this.stats.misses++;const o=t.createLinearGradient(i,e,s,n);return h.forEach(t=>{o.addColorStop(t.offset,t.color)}),this.set(a,o),o}set(t,i){this.cache.size>=this.maxSize&&!this.cache.has(t)&&this.evictLRU(),this.cache.set(t,{gradient:i,timestamp:Date.now()}),this.updateAccessOrder(t)}updateAccessOrder(t){const i=this.accessOrder.indexOf(t);i>-1&&this.accessOrder.splice(i,1),this.accessOrder.push(t)}evictLRU(){if(this.accessOrder.length>0){const t=this.accessOrder.shift();this.cache.delete(t),this.stats.evictions++}}clear(){this.cache.clear(),this.accessOrder=[]}clearExpired(){const t=Date.now(),i=[];for(const[e,s]of this.cache.entries())t-s.timestamp>=this.ttl&&i.push(e);i.forEach(t=>{this.cache.delete(t);const i=this.accessOrder.indexOf(t);i>-1&&this.accessOrder.splice(i,1)})}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{size:this.cache.size,maxSize:this.maxSize,hits:this.stats.hits,misses:this.stats.misses,evictions:this.stats.evictions,hitRate:`${t}%`}}createHelper(t){return{radial:(i,e,s,n,h,a,r)=>this.getRadialGradient(t,i,e,s,n,h,a,r),linear:(i,e,s,n,h)=>this.getLinearGradient(t,i,e,s,n,h)}}};class Di{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.glowIntensity=1,this.glowColor="#4a90e2",this.targetGlowColor="#4a90e2",this.glowColorTransition=0,this.glowColorTransitionSpeed=.05,this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null,this.cachedGlowRadius=0,this.scaleValue=i=>t.scaleValue(i),this.hexToRgba=(i,e)=>t.hexToRgba(i,e),this.initOffscreenCanvas()}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d")}updateOffscreenSize(t){this.offscreenCanvas.width===t&&this.offscreenCanvas.height===t||(this.offscreenCanvas.width=t,this.offscreenCanvas.height=t,this.cachedGlowColor=null)}renderGlow(t,i,e,s={}){const{ctx:n}=this,h=s.color||this.glowColor,a=void 0!==s.intensity?s.intensity:this.glowIntensity;a<.01||(this.scaleValue(200),this.renderGlowDirect(n,t,i,e,h,a))}cacheGlowGradient(t,i){const e=this.offscreenCtx,s=i;this.updateOffscreenSize(2*i),e.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);const n=qi.getRadialGradient(e,s,s,0,s,s,i,[{offset:0,color:this.hexToRgba(t,.4)},{offset:.3,color:this.hexToRgba(t,.2)},{offset:.6,color:this.hexToRgba(t,.1)},{offset:1,color:this.hexToRgba(t,0)}]);e.fillStyle=n,e.fillRect(0,0,2*i,2*i),this.cachedGlowColor=t,this.cachedGlowRadius=i}renderGlowDirect(t,i,e,s,n,h){t.save();const a=[];for(let t=0;t<=20;t++){const i=t/20,e=.6*Math.pow(1-i,2.2)*h;a.push({offset:i,color:this.hexToRgba(n,e)})}const r=qi.getRadialGradient(t,i,e,0,i,e,s,a);t.fillStyle=r,t.beginPath(),t.arc(i,e,s,0,2*Math.PI),t.fill(),t.restore()}renderRecordingGlow(t,i,e,s){const{ctx:n}=this,h=2.5*e,a=qi.getRadialGradient(n,t,i,0,t,i,h,[{offset:0,color:`rgba(255, 0, 0, ${.3*s})`},{offset:.5,color:`rgba(255, 0, 0, ${.15*s})`},{offset:1,color:"rgba(255, 0, 0, 0)"}]);n.save(),n.globalCompositeOperation="screen",n.fillStyle=a,n.fillRect(t-h,i-h,2*h,2*h),n.restore()}renderZenGlow(t,i,e,s){const{ctx:n}=this,h=e*(.9+.1*(.5*Math.sin(.001*s)+.5)),a=qi.getRadialGradient(n,t,i,0,t,i,h,[{offset:0,color:"rgba(147, 112, 219, 0.8)"},{offset:.7,color:"rgba(147, 112, 219, 0.3)"},{offset:1,color:"rgba(147, 112, 219, 0)"}]);n.save(),n.globalCompositeOperation="screen",n.fillStyle=a,n.beginPath(),n.arc(t,i,1.5*h,0,2*Math.PI),n.fill(),n.restore()}updateGlowColor(t,i){this.targetGlowColor!==t&&(this.targetGlowColor=t,this.glowColorTransition=0),this.glowColorTransition<1&&(this.glowColorTransition=Math.min(1,this.glowColorTransition+this.glowColorTransitionSpeed),this.glowColor=this.lerpColor(this.glowColor,this.targetGlowColor,this.glowColorTransition))}lerpColor(t,i,e){const s=this.hexToRgb(t),n=this.hexToRgb(i);return`#${((1<<24)+(Math.round(s.r+(n.r-s.r)*e)<<16)+(Math.round(s.g+(n.g-s.g)*e)<<8)+Math.round(s.b+(n.b-s.b)*e)).toString(16).slice(1)}`}hexToRgb(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:{r:0,g:0,b:0}}setGlowIntensity(t){this.glowIntensity=Math.max(0,Math.min(1,t))}setGlowColor(t){this.glowColor=t,this.targetGlowColor=t,this.glowColorTransition=1}destroy(){this.offscreenCanvas=null,this.offscreenCtx=null,this.cachedGlowColor=null}}class Ii{constructor(t){this.renderer=t,this.ctx=t.ctx,this.canvas=t.canvas,this.coreColor="#FFFFFF",this.coreOpacity=1,this.coreBorderWidth=0,this.coreBorderColor=null,this.shapePoints=null,this.isMorphing=!1,this.scaleValue=i=>t.scaleValue(i),this.hexToRgba=(i,e)=>t.hexToRgba(i,e)}renderCore(t,i,e,s={}){const{ctx:n}=this,h=s.scaleX||1,a=s.scaleY||1,r=s.rotation||0,o=void 0!==s.opacity?s.opacity:this.coreOpacity,c=s.color||this.coreColor,l=s.shapePoints||this.shapePoints;n.save(),n.translate(t,i),0!==r&&n.rotate(r),n.scale(h,a),n.fillStyle=this.hexToRgba(c,o),l&&l.length>0?this.drawMorphedShape(n,l,e):this.drawCircle(n,e),this.coreBorderWidth>0&&this.coreBorderColor&&(n.strokeStyle=this.coreBorderColor,n.lineWidth=this.scaleValue(this.coreBorderWidth),n.stroke()),n.restore()}drawDropShadow(t,i,e){t.save();const s=this.scaleValue(2);if(t.translate(0,s),e&&e.length>32)t.fillStyle="rgba(0, 0, 0, 0.15)",t.beginPath(),t.arc(0,0,1.05*i,0,2*Math.PI),t.fill();else{const s=qi.getRadialGradient(t,0,0,.7*i,0,0,1.2*i,[{offset:0,color:"rgba(0, 0, 0, 0.2)"},{offset:.8,color:"rgba(0, 0, 0, 0.1)"},{offset:1,color:"rgba(0, 0, 0, 0)"}]);if(t.fillStyle=s,t.beginPath(),e){const i=1.1,s=e.length>20?2:1;t.moveTo(e[0].x*i,e[0].y*i);for(let n=s;n<e.length;n+=s)t.lineTo(e[n].x*i,e[n].y*i);t.closePath()}else t.arc(0,0,1.1*i,0,2*Math.PI);t.fill()}t.restore()}drawCircle(t,i){t.beginPath(),t.arc(0,0,i,0,2*Math.PI),t.fill()}drawMorphedShape(t,i,e){!i||i.length<3?this.drawCircle(t,e):(t.beginPath(),i.forEach((i,e)=>{0===e?t.moveTo(i.x,i.y):t.lineTo(i.x,i.y)}),t.closePath(),t.fill())}renderZenCore(t,i,e,s){const{ctx:n}=this,h=e*(.95+.05*(.5*Math.sin(.001*s)+.5));n.save(),n.shadowBlur=this.scaleValue(10),n.shadowColor="rgba(147, 112, 219, 0.3)",n.shadowOffsetX=0,n.shadowOffsetY=0,n.fillStyle="#FFFFFF",n.beginPath(),n.arc(t,i,h,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(147, 112, 219, 0.2)",n.lineWidth=this.scaleValue(1),n.beginPath(),n.arc(t,i,.9*h,0,2*Math.PI),n.stroke(),n.restore()}renderSleepyCore(t,i,e){const{ctx:s}=this;s.save(),s.translate(t,i),s.scale(1,.85),s.fillStyle="#FFFFFF",s.beginPath(),s.arc(0,0,e,0,2*Math.PI),s.fill(),s.restore()}renderGlitchedCore(t,i,e,s){const{ctx:n}=this;n.save(),[{x:-2,y:0,alpha:.3},{x:2,y:0,alpha:.3},{x:0,y:-1,alpha:.2}].forEach(h=>{n.fillStyle=this.hexToRgba("#FFFFFF",h.alpha*s),n.beginPath(),n.arc(t+h.x*s*this.scaleValue(5),i+h.y*s*this.scaleValue(5),e,0,2*Math.PI),n.fill()}),n.fillStyle="#FFFFFF",n.beginPath(),n.arc(t,i,e,0,2*Math.PI),n.fill(),n.restore()}setShapePoints(t){this.shapePoints=t,this.isMorphing=t&&t.length>0}clearShapePoints(){this.shapePoints=null,this.isMorphing=!1}setCoreColor(t){this.coreColor=t}setCoreOpacity(t){this.coreOpacity=Math.max(0,Math.min(1,t))}setCoreBorder(t,i){this.coreBorderWidth=t,this.coreBorderColor=i}getCoreInfo(){return{color:this.coreColor,opacity:this.coreOpacity,hasBorder:this.coreBorderWidth>0,isMorphing:this.isMorphing,shapePointCount:this.shapePoints?this.shapePoints.length:0}}}class ji{constructor(t){this.renderer=t,this.brakeStartTime=null,this.brakeDuration=2500,this.brakeStartRotation=0,this.brakeTargetRotation=0,this.brakeStartVelocity=0,this.onComplete=null,this.onProgress=null,this.DURATION_FACTOR=14}brakeToUpright(t={}){return this.brakeToTarget(0,t)}brakeToNearest(t,i={}){const e=this.renderer.state.manualRotation||0,s=Math.round(e/t)*t;return this.brakeToTarget(s,i)}brakeToTarget(t,i={}){return new Promise(e=>{const{onProgress:s=null,onComplete:n=null}=i;this.onProgress=s,this.onComplete=n;const h=this.renderer.state.rotationSpeed||0,a=this.renderer.state.manualRotation||0;if(0===h||this.brakeStartTime)return void e();if(this.brakeStartTime=performance.now(),this.brakeStartRotation=a,this.brakeStartVelocity=h,0===t)this.brakeTargetRotation=h>0?360*(Math.floor(a/360)+1):360*Math.floor(a/360);else{const i=t%360,e=Math.floor(a/360);this.brakeTargetRotation=h>0?i>a%360?360*e+i:360*(e+1)+i:i<a%360?360*e+i:360*(e-1)+i}const r=Math.abs(this.brakeTargetRotation-this.brakeStartRotation);this.brakeDuration=Math.max(500,r/Math.abs(h)*this.DURATION_FACTOR*5),this.renderer.setRotationSpeed(0),this.resolvePromise=e})}updateBrake(t){if(!this.brakeStartTime)return null;const i=t-this.brakeStartTime,e=Math.min(i/this.brakeDuration,1),s=1-Math.pow(1-e,4),n=this.brakeStartRotation+(this.brakeTargetRotation-this.brakeStartRotation)*s,h=this.brakeStartVelocity*Math.pow(1-s,2);return this.onProgress&&this.onProgress(s,h,n),e>=1?(this.brakeStartTime=null,this.complete(),{rotation:this.brakeTargetRotation,speed:0,complete:!0}):{rotation:n,speed:h,complete:!1}}stop(){this.brakeStartTime=null}complete(){this.onComplete&&this.onComplete(),this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null)}isBraking(){return null!==this.brakeStartTime}emergencyStop(){this.stop(),this.renderer.setRotationSpeed(0),this.complete()}getProgress(){if(!this.brakeStartTime)return 0;const t=performance.now()-this.brakeStartTime;return Math.min(t/this.brakeDuration,1)}}class $i{constructor(t){this.renderer=t,this.animations={grooveSway:null,grooveBob:null,grooveFlow:null,groovePulse:null,grooveStep:null},this.activeAnimation=null,this.blendState={x:0,y:0,rotation:0,scale:1,opacity:1}}startAmbientAnimation(t,i={}){this.activeAnimation&&this.activeAnimation!==t&&this.stopAmbientAnimation(this.activeAnimation),this.activeAnimation=t,this.animations[t]={startTime:Date.now(),intensity:i.intensity||1,frequency:i.frequency||1,options:i}}stopAmbientAnimation(t){this.animations[t]&&(this.animations[t]=null),this.activeAnimation===t&&(this.activeAnimation=null)}updateBlendState(t){if(!t)return;const i=.2;this.blendState.x=this.lerp(this.blendState.x,t.x||0,i),this.blendState.y=this.lerp(this.blendState.y,t.y||0,i),this.blendState.rotation=this.lerp(this.blendState.rotation,t.rotation||0,i),this.blendState.scale=this.lerp(this.blendState.scale,t.scale||1,i),this.blendState.opacity=this.lerp(this.blendState.opacity,t.opacity||1,i)}getTransform(t){const i={x:this.blendState.x,y:this.blendState.y,rotation:this.blendState.rotation,scale:this.blendState.scale,opacity:this.blendState.opacity};if(this.activeAnimation){const t=this.animations[this.activeAnimation];if(t){const e=Date.now()-t.startTime;switch(this.activeAnimation){case"grooveSway":i.x+=15*Math.sin(e/500*t.frequency)*t.intensity,i.rotation+=5*Math.sin(e/500*t.frequency+Math.PI/4)*t.intensity;break;case"grooveBob":i.y+=10*Math.sin(e/400*t.frequency)*t.intensity,i.scale*=1+.03*Math.sin(e/400*t.frequency)*t.intensity;break;case"grooveFlow":{const s=e/1e3*t.frequency;i.x+=Math.sin(s)*Math.cos(2*s)*20*t.intensity,i.y+=Math.cos(s)*Math.sin(2*s)*10*t.intensity,i.rotation+=8*Math.sin(2*s)*t.intensity;break}case"groovePulse":i.scale*=1+.05*Math.sin(e/250*t.frequency)*t.intensity,i.opacity*=.9+.1*Math.sin(e/250*t.frequency)*t.intensity;break;case"grooveStep":{const s=Math.floor(e/500*t.frequency)%4,n=e/500*t.frequency%1,h=this.smoothStep(n);0===s?i.x+=25*h*t.intensity:2===s&&(i.x-=25*h*t.intensity),i.y+=5*Math.abs(Math.sin(e/250*t.frequency))*t.intensity;break}}}}return i}lerp(t,i,e){return t+(i-t)*e}smoothStep(t){return t*t*(3-2*t)}}const Gi=2,Li=3,Vi=4,Hi=new class{constructor(){this.callbacks=new Map,this.callbackIdCounter=0,this.frameId=null,this.isRunning=!1,this.lastFrameTime=0,this.deltaTime=0,this.fps=60,this.frameCount=0,this.targetFPS=60,this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=16.67,this.prioritySkipCounters={[Gi]:0,[Li]:0,[Vi]:0},this.performanceMonitor=null,this.frameTimeHistory=[],this.maxHistorySize=60,this.loop=this.loop.bind(this)}register(t,i=2,e=null){if("function"!=typeof t)throw new Error("Callback must be a function");const s=++this.callbackIdCounter;return this.callbacks.set(s,{callback:t,priority:i,context:e,lastRun:0,runCount:0,totalTime:0,enabled:!0}),1!==this.callbacks.size||this.isRunning||this.start(),s}unregister(t){this.callbacks.delete(t),0===this.callbacks.size&&this.isRunning&&this.stop()}setEnabled(t,i){const e=this.callbacks.get(t);e&&(e.enabled=i)}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.frameId=requestAnimationFrame(this.loop))}stop(){this.isRunning&&(this.isRunning=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null))}loop(t){if(!this.isRunning)return;this.deltaTime=t-this.lastFrameTime,this.lastFrameTime=t,this.frameCount++,this.frameCount%60==0&&(this.fps=Math.round(1e3/(this.deltaTime||16.67))),this.frameTimeHistory.push(this.deltaTime),this.frameTimeHistory.length>this.maxHistorySize&&this.frameTimeHistory.shift();performance.now();const i=this.groupCallbacksByPriority();let e=0;for(const s of[0,1,2,3,4]){if(s>0&&e>.8*this.frameBudget)break;if(this.shouldSkipPriority(s))continue;const n=i.get(s)||[];for(const i of n){if(!i.enabled)continue;const s=performance.now();try{i.context?i.callback.call(i.context,this.deltaTime,t):i.callback(this.deltaTime,t);const n=performance.now()-s;i.totalTime+=n,i.runCount++,i.lastRun=t,e+=n}catch(t){i.runCount>0&&i.totalTime/i.runCount>10&&(i.enabled=!1)}if(e>this.frameBudget)break}}performance.now(),this.frameBudget,this.frameId=requestAnimationFrame(this.loop)}groupCallbacksByPriority(){const t=new Map;for(const[i,e]of this.callbacks){const{priority:i}=e;t.has(i)||t.set(i,[]),t.get(i).push(e)}return t}shouldSkipPriority(t){if(0===t)return!1;if(this.fps<30&&t>=3)return!0;if(this.fps<45&&4===t)return!0;if(2===t){if(this.fps<50&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%2!=0))return!0}else if(3===t){if(this.fps<50&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%3!=0))return!0}else if(4===t&&(this.prioritySkipCounters[t]++,this.prioritySkipCounters[t]%5!=0))return!0;return!1}getStats(){const t={fps:this.fps,frameCount:this.frameCount,callbackCount:this.callbacks.size,averageFrameTime:0,maxFrameTime:0,minFrameTime:1/0};if(this.frameTimeHistory.length>0){let i=0;for(const e of this.frameTimeHistory)i+=e,t.maxFrameTime=Math.max(t.maxFrameTime,e),t.minFrameTime=Math.min(t.minFrameTime,e);t.averageFrameTime=i/this.frameTimeHistory.length}t.callbacksByPriority={};for(const[i,e]of this.callbacks){const{priority:i}=e;t.callbacksByPriority[i]||(t.callbacksByPriority[i]={count:0,totalTime:0,enabled:0}),t.callbacksByPriority[i].count++,t.callbacksByPriority[i].totalTime+=e.totalTime,e.enabled&&t.callbacksByPriority[i].enabled++}return t}setTargetFPS(t){this.targetFPS=Math.max(15,Math.min(120,t)),this.targetFrameTime=1e3/this.targetFPS,this.frameBudget=this.targetFrameTime}setPerformanceMonitor(t){this.performanceMonitor=t}destroy(){this.stop(),this.callbacks.clear(),this.frameTimeHistory=[]}};class _i{constructor(t,i={}){this.canvasManager=t,this.ctx=t.getContext(),this.gestureCompositor=new gi,this.currentUndertone=null,this.gestureAnimator=new Ti(this),this.colorUtilities=new Oi,this.specialEffects=new Ri(this),this.eyeRenderer=new zi(this),this.breathingAnimator=new Ei(this),this.glowRenderer=new Di(this),this.coreRenderer=new Ii(this),this.rotationBrake=new ji(this),this.ambientDanceAnimator=new $i(this),this.config={coreColor:i.coreColor||"#FFFFFF",coreSizeDivisor:i.coreSizeDivisor||12,glowMultiplier:i.glowMultiplier||2.5,defaultGlowColor:i.defaultGlowColor||"#14B8A6",breathingSpeed:i.breathingSpeed||.42,breathingDepth:i.breathingDepth||.08,renderingStyle:i.renderingStyle||"classic",baseScale:i.baseScale||1,referenceSize:400,topOffset:i.topOffset||0};const e=Math.min(this.canvasManager.width||400,this.canvasManager.height||400);this.scaleFactor=e/this.config.referenceSize*this.config.baseScale,this.state={emotion:"neutral",glowColor:this.config.defaultGlowColor,glowIntensity:1,breathRate:1,breathDepth:this.config.breathingDepth,coreJitter:!1,speaking:!1,recording:!1,sleeping:!1,blinking:!1,blinkingEnabled:!0,gazeOffset:{x:0,y:0},gazeIntensity:0,gazeLocked:!1,gazeTrackingEnabled:!1,gazeTarget:{x:0,y:0},zenVortexIntensity:1,squintAmount:0,targetSquintAmount:0,scanPhase:0,lastScanTime:0,isSuspicious:!1,customScale:null,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!1,glowRadiusMult:1,breathRateMult:1,breathDepthMult:1,breathIrregular:!1,particleRateMult:1,glowPulse:0,brightnessFlicker:0,brightnessMult:1,saturationMult:1,hueShift:0,manualRotation:0,rotationSpeed:0,lastRotationUpdate:performance.now()},this.animationFrameIds={colorTransition:null,eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.loopCallbackIds={eyeClose:null,eyeOpen:null,zenEnter:null,zenExit:null},this.offscreenCanvas=null,this.offscreenCtx=null,this.initOffscreenCanvas(),this.canvas=t.canvas,this.glowCache=new Map,this.maxCacheSize=10,this.gestureAnimations={bounce:{active:!1,startTime:0,progress:0,params:null},pulse:{active:!1,startTime:0,progress:0,params:null},shake:{active:!1,startTime:0,progress:0,params:null},spin:{active:!1,startTime:0,progress:0,params:null},nod:{active:!1,startTime:0,progress:0,params:null},tilt:{active:!1,startTime:0,progress:0,params:null},expand:{active:!1,startTime:0,progress:0,params:null},contract:{active:!1,startTime:0,progress:0,params:null},flash:{active:!1,startTime:0,progress:0,params:null},drift:{active:!1,startTime:0,progress:0,params:null,startX:0,startY:0},stretch:{active:!1,startTime:0,progress:0,params:null},glow:{active:!1,startTime:0,progress:0,params:null},flicker:{active:!1,startTime:0,progress:0,params:null},vibrate:{active:!1,startTime:0,progress:0,params:null},wave:{active:!1,startTime:0,progress:0,params:null},breathe:{active:!1,startTime:0,progress:0,params:null},morph:{active:!1,startTime:0,progress:0,params:null},slowBlink:{active:!1,startTime:0,progress:0,params:null},look:{active:!1,startTime:0,progress:0,params:null,targetX:0,targetY:0},settle:{active:!1,startTime:0,progress:0,params:null},breathIn:{active:!1,startTime:0,progress:0,params:null},breathOut:{active:!1,startTime:0,progress:0,params:null},breathHold:{active:!1,startTime:0,progress:0,params:null},breathHoldEmpty:{active:!1,startTime:0,progress:0,params:null},jump:{active:!1,startTime:0,progress:0,params:null},orbital:{active:!1,startTime:0,progress:0,params:null},hula:{active:!1,startTime:0,progress:0,params:null}},this.episodicEffects={nervous:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+2e3*Math.random()},confident:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+2e3*Math.random()},tired:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:5e3+2e3*Math.random()},intense:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:3e3+3e3*Math.random()},subdued:{active:!1,startTime:0,duration:0,intensity:0,nextTrigger:4e3+3e3*Math.random()}},this.speakingRings=[],this.maxRings=5,this.ringSpawnTimer=0,this.ringSpawnInterval=200,this.recordingRings=[],this.recordingPulse=0,this.sleepZ=[],this.zenTransition={active:!1,phase:null,startTime:0,previousEmotion:null,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0},this.colorTransition={active:!1,fromColor:this.state.glowColor,toColor:this.state.glowColor,fromIntensity:this.state.glowIntensity,toIntensity:this.state.glowIntensity,progress:0,startTime:0,duration:1500},this.undertoneModifiers={nervous:{hueShift:0,saturationMult:1.05,brightnessMult:1,brightnessFlicker:.05,sizeMultiplier:1,jitterAmount:0,episodicFlutter:!0,glowRadiusMult:1,glowPulse:.05,breathRateMult:1.1,breathDepthMult:.9,breathIrregular:!0},confident:{hueShift:15,saturationMult:1.2,brightnessMult:1.1,sizeMultiplier:1,jitterAmount:0,episodicPowerPose:!0,glowRadiusMult:1.15,breathRateMult:.95,breathDepthMult:1.1,breathIrregular:!1},tired:{hueShift:-5,saturationMult:.7,brightnessMult:.85,sizeMultiplier:.95,jitterAmount:0,episodicMicroSleep:!0,glowRadiusMult:.9,breathRateMult:.8,breathDepthMult:1.2,breathIrregular:!1},intense:{hueShift:5,saturationMult:1.3,brightnessMult:1.15,sizeMultiplier:1,jitterAmount:0,episodicLaserFocus:!0,glowRadiusMult:1.2,breathRateMult:1.2,breathDepthMult:.9,breathIrregular:!1},subdued:{hueShift:-10,saturationMult:.75,brightnessMult:.9,sizeMultiplier:.95,jitterAmount:0,episodicWithdrawal:!0,glowRadiusMult:.85,breathRateMult:.9,breathDepthMult:.9,breathIrregular:!1}},this.lastFrameTime=0}scaleValue(t){return t*this.scaleFactor}initOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.updateOffscreenSize()}updateOffscreenSize(){if(this.offscreenCanvas&&this.canvasManager){const{width:t}=this.canvasManager.canvas,{height:i}=this.canvasManager.canvas;this.offscreenCanvas.width===t&&this.offscreenCanvas.height===i||(this.offscreenCanvas.width=t,this.offscreenCanvas.height=i)}}render(t,i,e=null){this.performanceMonitor&&this.performanceMonitor.markFrameStart();const s=performance.now();this.forceCleanRender&&(this.forceCleanRender=!1,this.canvas&&this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height));const n=this.ambientDanceAnimator.getTransform(i);e?(e.x=(e.x||0)+(n.x||0),e.y=(e.y||0)+(n.y||0),e.rotation=(e.rotation||0)+(n.rotation||0),e.scale=(e.scale||1)*(n.scale||1)):e=n,this.gestureTransform=e,this.updateOffscreenSize();const h=this.canvasManager.width||this.canvas.width||400,a=this.canvasManager.height||this.canvas.height||400,r=this.ctx;if(this.ctx=this.offscreenCtx,this.ctx.clearRect(0,0,h,a),this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers){const t=this.stateMachine.getWeightedUndertoneModifiers();t?this.applyUndertoneModifiers(t):this.applyUndertoneModifiers(null)}if(this.colorTransition&&this.colorTransition.active&&this.updateColorTransition(i),this.updateTimers(i),this.state.gazeTrackingEnabled){const t=.15,i=50;this.state.gazeOffset.x+=(this.state.gazeTarget.x*i-this.state.gazeOffset.x)*t,this.state.gazeOffset.y+=(this.state.gazeTarget.y*i-this.state.gazeOffset.y)*t}else{const t=.1;this.state.gazeOffset.x+=(0-this.state.gazeOffset.x)*t,this.state.gazeOffset.y+=(0-this.state.gazeOffset.y)*t}const o=Math.min(h,a);let c=h/2,l=a/2-this.config.topOffset;t.properties&&t.properties.verticalOffset&&(l=a/2-this.config.topOffset+a*t.properties.verticalOffset),this.scaleFactor=o/this.config.referenceSize*this.config.baseScale;let u=1,p=0,d=1;e&&(c+=e.x||0,l+=e.y||0,u=e.scale||1,p=(e.rotation||0)*Math.PI/180,d=e.glowIntensity||1);const m=this.gestureAnimator.applyGestureAnimations();if(m&&(c+=m.offsetX||0,l+=m.offsetY||0,u*=m.scale||1,p+=(m.rotation||0)*Math.PI/180,d=m.glow||1),"zen"===this.state.emotion&&"in"===this.zenTransition.phase){const t=Date.now()/1e3;l+=15*Math.sin(.3*t)*this.scaleFactor,c+=8*Math.sin(.2*t)*this.scaleFactor,p+=.05*Math.sin(.25*t)}let f,g,y=1,M=1,b=1;if(this.state.sleeping||"resting"===this.state.emotion||Ci("sleeping",this.state)){const t=Bi("sleeping");if(t){const i=t.getDimmingValues();y=void 0!==this.state.sleepDimness?this.state.sleepDimness:i.orbDimming,b=i.glowDimming,M=void 0!==this.state.sleepScale?this.state.sleepScale:.9}else y=void 0!==this.state.sleepDimness?this.state.sleepDimness:.3,b=.2,M=void 0!==this.state.sleepScale?this.state.sleepScale:.9;this.state.breathRate=.5,this.state.breathDepth=.15}if(null!==this.state.customScale)f=this.state.customScale,g=1+.5*(this.state.customScale-1);else{const t=this.breathingAnimator.getBreathingScale();f=t,g=1-.5*(t-1)}"nervous"===this.state.undertone&&this.undertoneModifiers.nervous.glowPulse&&(g*=1+Math.sin(Date.now()/200)*this.undertoneModifiers.nervous.glowPulse);const w=this.config.referenceSize/this.config.coreSizeDivisor*this.scaleFactor,v=t.properties&&t.properties.coreSize?t.properties.coreSize:1,S=this.state.sizeMultiplier||1;let F=w*v*f*u*M*S,k=w*this.config.glowMultiplier*g*this.state.glowIntensity*u*M*S*d;const x=this.state.glowIntensity*d;this.state.sleeping||"zen"===this.state.emotion||(F*=this.eyeRenderer.getBlinkScale());let B=0,P=0;const C=this.state.jitterAmount||0;if(this.currentUndertone&&this.episodicEffects[this.currentUndertone]){const t=this.episodicEffects[this.currentUndertone],i=performance.now();if(!t.active&&i>=t.nextTrigger)switch(t.active=!0,t.startTime=i,this.currentUndertone){case"nervous":t.duration=500+500*Math.random(),t.intensity=2+Math.random(),t.nextTrigger=i+3e3+2e3*Math.random();break;case"confident":t.duration=1e3+1e3*Math.random(),t.intensity=.15,t.nextTrigger=i+4e3+2e3*Math.random();break;case"tired":t.duration=1e3+2e3*Math.random(),t.intensity=.2,t.nextTrigger=i+5e3+2e3*Math.random();break;case"intense":t.duration=500+500*Math.random(),t.intensity=.5,t.nextTrigger=i+3e3+3e3*Math.random();break;case"subdued":t.duration=2e3+1e3*Math.random(),t.intensity=.3,t.nextTrigger=i+4e3+3e3*Math.random()}if(t.active){const e=i-t.startTime;if(e<t.duration){const i=e/t.duration;switch(this.currentUndertone){case"nervous":{const e=1-i,s=15,n=Math.sin(i*Math.PI*s)*e;B=n*t.intensity,P=n*t.intensity*.7;break}case"confident":{const e=Math.sin(i*Math.PI);F*=1+t.intensity*e,k*=1+.5*t.intensity*e;break}case"tired":{const e=Math.sin(i*Math.PI*.5);F*=1-t.intensity*e,P+=5*e;break}case"intense":{const e=1-Math.cos(i*Math.PI);F*=1-.05*e,k*=1+t.intensity*e;break}case"subdued":{const e=Math.sin(i*Math.PI*.5);F*=1-.1*e,k*=1-t.intensity*e;break}}}else t.active=!1}}else if(this.state.coreJitter||C>0){const t=Math.max(C,this.state.coreJitter?this.scaleValue(2):0);B=(Math.random()-.5)*t,P=(Math.random()-.5)*t}const A=c+this.state.gazeOffset.x+B,T=l+this.state.gazeOffset.y+P,O=performance.now();if(this.rotationBrake&&this.rotationBrake.isBraking()){const t=this.rotationBrake.updateBrake(O);t&&(this.state.manualRotation=t.rotation,this.state.rotationSpeed=t.complete?0:t.speed)}else 0!==this.state.rotationSpeed&&(this.state.manualRotation+=this.state.rotationSpeed);const R=p+this.state.manualRotation*Math.PI/180;if(0!==R&&(this.ctx.save(),this.ctx.translate(A,T),this.ctx.rotate(R),this.ctx.translate(-A,-T)),Ci("recording-glow",this.state)?Pi("recording-glow",this.ctx,{x:A,y:T,radius:k,deltaTime:i}):Ci("zen-vortex",this.state)||(this.state.sleeping||"resting"===this.state.emotion||Ci("sleeping",this.state)?(this.ctx.save(),this.ctx.globalAlpha=b,this.glowRenderer.renderGlow(A,T,k,{intensity:x}),this.ctx.restore()):this.glowRenderer.renderGlow(A,T,k,{intensity:x})),m&&m.flashWave){const t=m.flashWave,{ctx:i}=this;i.save(),i.globalCompositeOperation="lighter";const e=F*t.innerRadius,s=F*t.outerRadius;if(s>e){const n=qi.getRadialGradient(i,A,T,e,A,T,s,[{offset:0,color:"rgba(255, 255, 255, 0)"},{offset:.2,color:`rgba(255, 255, 255, ${.15*t.intensity})`},{offset:.5,color:`rgba(255, 255, 255, ${.25*t.intensity})`},{offset:.8,color:`rgba(255, 255, 255, ${.15*t.intensity})`},{offset:1,color:"rgba(255, 255, 255, 0)"}]);i.fillStyle=n,i.beginPath(),i.arc(A,T,s,0,2*Math.PI),i.arc(A,T,Math.max(0,e),0,2*Math.PI,!0),i.fill()}i.restore()}Ci("speaking-pulse",this.state)&&Pi("speaking-pulse",this.ctx,{x:A,y:T,radius:F,audioLevel:this.state.audioLevel||0,deltaTime:i}),(this.state.sleeping||"resting"===this.state.emotion)&&(this.ctx.globalAlpha=y);let z=null,E=null;this.shapeMorpher&&(this.shapeMorpher.update(),z=this.shapeMorpher.getCanvasPoints(0,0,F),E=this.shapeMorpher.getCurrentShadow());let q=!1;!E||"sun"!==E.type&&"solar-hybrid"!==E.type||(this.renderSunEffects(A,T,F,E),q=!0),this.coreRenderer.renderCore(A,T,F,{scaleX:1,scaleY:1,rotation:R,shapePoints:z}),this.specialEffects&&(this.specialEffects.update(i),this.specialEffects.renderSparkles());const D=this.shapeMorpher?this.shapeMorpher.currentShape:null,I=this.shapeMorpher?this.shapeMorpher.targetShape:null,j=this.shapeMorpher&&"solar"===I&&this.shapeMorpher.isTransitioning,$=this.shapeMorpher&&"solar"===D&&this.shapeMorpher.isTransitioning,G=E&&"solar-hybrid"===E.type,L=this.shapeMorpher&&this.shapeMorpher.isTransitioning&&"solar"===D&&"moon"===I,V=this.shapeMorpher&&this.shapeMorpher.isTransitioning&&"moon"===D&&"solar"===I;if(!E||"crescent"!==E.type&&"lunar"!==E.type||V||this.renderMoonShadow(A,T,F,E,z,!1,0),(G&&E.lunarOverlay||j||$)&&!L){const t=G&&E.lunarOverlay?E.lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"};let i=0,e=0,s=0;if(this.shapeMorpher){s=this.shapeMorpher.getProgress();const t=2.5*F;j&&s<1?(i=-t*(1-s),e=t*(1-s)):$&&s<1&&(i=t*s,e=-t*s)}if(this.renderMoonShadow(A,T,F,t,z,!0),(j||$)&&(j||q)&&(this.renderBaileysBeads(A,T,F,i,e,s,j,!0),Math.abs(i)<30&&Math.abs(e)<30&&this.specialEffects)){const t=Math.sqrt(i*i+e*e),s=Math.max(.1,.5*(1-t/30));this.specialEffects.triggerChromaticAberration(s)}}if((this.state.sleeping||"resting"===this.state.emotion)&&(this.ctx.globalAlpha=1),0!==R&&this.ctx.restore(),this.state.sleeping&&this.renderSleepIndicator(c,l-k-this.scaleValue(20),i),this.ctx=r,r.drawImage(this.offscreenCanvas,0,0),Ci("recording-glow",this.state)){const t=Bi("recording-glow");t&&t.drawRecordingIndicator&&t.drawRecordingIndicator(r,this.canvas.width,this.canvas.height)}const H=performance.now()-s;this.performanceMonitor&&(this.performanceMonitor.markFrameEnd(),this.performanceMonitor.recordFrameTime(H))}renderRecordingGlow(t,i,e,s){const n=this.canvas?.width||600,h=this.canvas?.height||600,a=Math.min(e,t-10,i-10,n-t-10,h-i-10),r=Math.max(50,a),o=qi.getRadialGradient(this.ctx,t,i,0,t,i,r,[{offset:0,color:this.hexToRgba("#FF0000",.7*s)},{offset:.3,color:this.hexToRgba("#FF0000",.5*s)},{offset:.6,color:this.hexToRgba("#FF0000",.3*s)},{offset:.85,color:this.hexToRgba("#FF0000",.1*s)},{offset:1,color:this.hexToRgba("#FF0000",0)}]);this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(t,i,r,0,2*Math.PI),this.ctx.fill()}renderDropShadow(t,i,e,s){const{ctx:n}=this,h=this.shapeMorpher&&this.shapeMorpher.isTransitioning;if(!(this.shapeMorpher&&(this.shapeMorpher.audioDeformation>.1||this.shapeMorpher.vocalEnergy>.1)||h&&!(this.shapeMorpher.morphProgress>.8))){n.save(),n.translate(t,i);const h=this.scaleValue(2);if(n.translate(0,h),s&&s.length>32)n.fillStyle="rgba(0, 0, 0, 0.15)",n.beginPath(),n.arc(0,0,1.05*e,0,2*Math.PI),n.fill();else{const t=n.createRadialGradient(0,0,.7*e,0,0,1.2*e);if(t.addColorStop(0,"rgba(0, 0, 0, 0.2)"),t.addColorStop(.8,"rgba(0, 0, 0, 0.1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),n.fillStyle=t,n.beginPath(),s){const t=1.1,i=s.length>20?2:1;n.moveTo(s[0].x*t,s[0].y*t);for(let e=i;e<s.length;e+=i)n.lineTo(s[e].x*t,s[e].y*t);n.closePath()}else n.arc(0,0,1.1*e,0,2*Math.PI);n.fill()}n.restore()}}renderSunEffects(t,i,e,s){const{ctx:n}=this,h=Date.now()/100;if(n.save(),n.translate(t,i),s.texture&&(void 0===s.textureOpacity||s.textureOpacity>0)){n.save(),n.globalCompositeOperation="screen",n.globalAlpha=void 0!==s.textureOpacity?s.textureOpacity:1;const t=.05*h*(s.turbulence||.3)/.3,i=n.createRadialGradient(Math.sin(t)*e*.15,Math.cos(.7*t)*e*.15,.2*e,0,0,e);i.addColorStop(0,"rgba(255, 255, 200, 0)"),i.addColorStop(.4,"rgba(255, 200, 100, 0.1)"),i.addColorStop(.7,"rgba(255, 150, 50, 0.08)"),i.addColorStop(1,"rgba(255, 100, 30, 0.05)"),n.fillStyle=i,n.beginPath(),n.arc(0,0,e,0,2*Math.PI),n.fill(),n.restore()}const a=void 0!==s.coronaOpacity?s.coronaOpacity:1;if(a>0){n.save(),n.globalCompositeOperation="screen";const t=n.createRadialGradient(0,0,.5*e,0,0,1.1*e);t.addColorStop(0,`rgba(255, 255, 255, ${.8*a})`),t.addColorStop(.3,`rgba(255, 250, 200, ${.6*a})`),t.addColorStop(.5,`rgba(255, 200, 100, ${.4*a})`),t.addColorStop(.7,`rgba(255, 150, 50, ${.2*a})`),t.addColorStop(1,"rgba(255, 100, 20, 0)"),n.fillStyle=t,n.beginPath(),n.arc(0,0,1.1*e,0,2*Math.PI),n.fill();for(let t=0;t<2;t++){const i=1.3+.4*t,s=(.35-.15*t)*a,r=.05*Math.sin(.1*h+t),o=n.createRadialGradient(0,0,e*(.9+r),0,0,e*(i+r));o.addColorStop(0,"rgba(255, 255, 200, 0)"),o.addColorStop(.4,`rgba(255, 200, 100, ${.5*s})`),o.addColorStop(.7,`rgba(255, 150, 50, ${s})`),o.addColorStop(.9,`rgba(255, 100, 30, ${.5*s})`),o.addColorStop(1,"rgba(255, 50, 10, 0)"),n.fillStyle=o,n.beginPath(),n.arc(0,0,e*(i+r),0,2*Math.PI),n.fill()}n.restore()}if(s.flares){n.save();const t=Math.sin(.08*h),i=Math.sin(.12*h),s=Math.sin(.16*h),a=n.createLinearGradient(0,-e,0,3*-e);a.addColorStop(0,"rgba(255, 255, 230, 0.4)"),a.addColorStop(.2,"rgba(255, 220, 150, 0.25)"),a.addColorStop(.5,"rgba(255, 180, 80, 0.15)"),a.addColorStop(.8,"rgba(255, 120, 40, 0.08)"),a.addColorStop(1,"rgba(255, 60, 20, 0)"),n.fillStyle=a,n.globalCompositeOperation="screen",n.beginPath();const r=(t,i,s,h)=>{const a=Math.cos(t),r=Math.sin(t),o=a*e,c=r*e,l=a*(e+i),u=r*(e+i),p=-r*s*.5,d=a*s*.5,m=h*s*.3;n.moveTo(o-p,c-d),n.quadraticCurveTo(.5*(o+l)+p*m,.5*(c+u)+d*m,l,u),n.quadraticCurveTo(.5*(o+l)-p*m,.5*(c+u)-d*m,o+p,c+d)};for(let i=0;i<8;i++)r(i/8*Math.PI*2+.1*t,e*(1.8+.4*Math.sin(.1*h+.5*i)),.18*e,Math.sin(.15*h+i));for(let t=0;t<12;t++)r((t+.5)/12*Math.PI*2+.08*i,e*(1.2+.3*Math.sin(.13*h+.7*t)),.12*e,Math.sin(.18*h+1.2*t));for(let t=0;t<15;t++)r(t/15*Math.PI*2+.05*s,e*(.7+.25*Math.sin(.17*h+.9*t)),.08*e,Math.sin(.2*h+1.5*t));for(let t=0;t<15;t++){const i=(t+.25)/15*Math.PI*2,s=e*(.4+.2*Math.sin(.22*h+t)),a=.06*e,r=Math.cos(i),o=Math.sin(i),c=r*e,l=o*e,u=r*(e+s),p=o*(e+s),d=-o*a*.5,m=r*a*.5;n.moveTo(c-d,l-m),n.lineTo(u,p),n.lineTo(c+d,l+m)}n.fill(),n.restore()}const r=n.createRadialGradient(0,0,.95*e,0,0,1.05*e);r.addColorStop(0,"rgba(255, 255, 255, 0)"),r.addColorStop(.7,"rgba(255, 255, 200, 0.2)"),r.addColorStop(.9,"rgba(255, 200, 100, 0.5)"),r.addColorStop(1,"rgba(255, 150, 50, 0.3)"),n.fillStyle=r,n.beginPath(),n.arc(0,0,1.05*e,0,2*Math.PI),n.fill(),n.restore()}renderBaileysBeads(t,i,e,s,n,h,a,r){const{ctx:o}=this;if(!r)return void(this.S=null);const c=Math.abs(s)<1&&Math.abs(n)<1,l=a?30:15;if(!(Math.abs(s)<l&&Math.abs(n)<l||c))return void(this.S=null);if(!this.S){const t=Math.floor(4*Math.random())+1;this.F=[];const i=[];for(let e=0;e<t;e++)i.push(Math.random()*Math.PI*2);const e=Array.from({length:t},(t,i)=>i);for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}for(let s=0;s<t;s++)this.F.push({angle:i[s],size:3+5*Math.random(),order:e[s],delay:200*e[s]});this.S=Date.now()}const u=Date.now()-this.S;(this.F||[]).forEach(s=>{if(u<s.delay)return;const n=u-s.delay,h=Math.min(1,n/300),a=t+Math.cos(s.angle)*e,r=i+Math.sin(s.angle)*e;o.save(),o.translate(a,r),o.globalAlpha=h;const c=this.scaleValue(s.size),l=[{color:`rgba(255, 100, 100, ${.6*h})`,offset:-2},{color:`rgba(100, 255, 100, ${.6*h})`,offset:0},{color:`rgba(100, 100, 255, ${.6*h})`,offset:2}];o.globalCompositeOperation="screen",l.forEach(({color:t,offset:i})=>{const e=o.createRadialGradient(i,i,0,i,i,2*c);e.addColorStop(0,t),e.addColorStop(.2,t.replace(""+.6*h,""+.4*h)),e.addColorStop(.5,t.replace(""+.6*h,""+.2*h)),e.addColorStop(1,"rgba(255, 255, 255, 0)"),o.fillStyle=e,o.beginPath(),o.arc(i,i,2*c,0,2*Math.PI),o.fill()}),o.globalCompositeOperation="lighter";const p=o.createRadialGradient(0,0,0,0,0,c);p.addColorStop(0,`rgba(255, 255, 255, ${h})`),p.addColorStop(.3,`rgba(255, 255, 255, ${.5*h})`),p.addColorStop(1,"rgba(255, 255, 255, 0)"),o.fillStyle=p,o.beginPath(),o.arc(0,0,c,0,2*Math.PI),o.fill(),o.restore()})}renderMoonShadow(t,i,e,s,n,h=!1,a=0){const{ctx:r}=this;if(r.save(),r.translate(t,i),"crescent"===s.type){let t=1,i=s.offset||.7;if(this.shapeMorpher){const e=this.shapeMorpher.getProgress(),{targetShape:n}=this.shapeMorpher;"moon"===n&&void 0!==e&&e<1&&!s.shadowX&&(t=e,i=2.7*t-2)}const h=(s.angle||-30)*Math.PI/180,a=Math.cos(h)*e*i,o=Math.sin(h)*e*i;if(r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.beginPath(),n){r.moveTo(n[0].x,n[0].y);for(let t=1;t<n.length;t++)r.lineTo(n[t].x,n[t].y);r.closePath()}else r.arc(0,0,e,0,2*Math.PI);r.clip();const c=r.createRadialGradient(a,o,.9*e,a,o,1.1*e),l=void 0!==s.coverage?s.coverage:.85,u=Math.min(1,1.2*t)*(l/.85);c.addColorStop(0,`rgba(0, 0, 0, ${1*u})`),c.addColorStop(.8,`rgba(0, 0, 0, ${1*u})`),c.addColorStop(.88,`rgba(0, 0, 0, ${.98*u})`),c.addColorStop(.91,`rgba(0, 0, 0, ${.95*u})`),c.addColorStop(.93,`rgba(0, 0, 0, ${.9*u})`),c.addColorStop(.95,`rgba(0, 0, 0, ${.8*u})`),c.addColorStop(.96,`rgba(0, 0, 0, ${.65*u})`),c.addColorStop(.97,`rgba(0, 0, 0, ${.45*u})`),c.addColorStop(.98,`rgba(0, 0, 0, ${.25*u})`),c.addColorStop(.99,`rgba(0, 0, 0, ${.1*u})`),c.addColorStop(1,"rgba(0, 0, 0, 0)"),r.fillStyle=c,r.beginPath(),r.arc(a,o,1.1*e,0,2*Math.PI),r.fill()}else if("lunar"===s.type){const t=1-(void 0!==s.diffusion?s.diffusion:1);let i=0,n=0;if(this.shapeMorpher){const t=this.shapeMorpher.getProgress(),{currentShape:s}=this.shapeMorpher,{targetShape:a}=this.shapeMorpher;if(h&&"solar"===a&&void 0!==t&&t<1){const s=2.5*e;i=-s*(1-t),n=s*(1-t)}else if(h&&"solar"===s&&"solar"!==a&&null!==a&&void 0!==t&&t<1){const s=2.5*e;i=s*t,n=-s*t}}r.translate(i,n),h?(r.save(),r.beginPath(),r.arc(-i,-n,e,0,2*Math.PI),r.clip()):(r.beginPath(),r.arc(0,0,e,0,2*Math.PI),r.clip());const a=e*(1.8-.5*t),o=r.createRadialGradient(0,0,.2*e,0,0,a),c=s.coverage||.9;if(s.color&&s.color.includes("0, 0, 0")?(o.addColorStop(0,`rgba(0, 0, 0, ${c})`),o.addColorStop(.3+.2*t,`rgba(0, 0, 0, ${.95*c})`),o.addColorStop(.6+.2*t,`rgba(0, 0, 0, ${.8*c})`),o.addColorStop(.85,`rgba(0, 0, 0, ${.4*c})`),o.addColorStop(1,"rgba(0, 0, 0, 0)")):(o.addColorStop(0,`rgba(10, 2, 0, ${c})`),o.addColorStop(.3+.2*t,`rgba(20, 5, 0, ${.95*c})`),o.addColorStop(.6+.2*t,`rgba(40, 10, 5, ${.8*c})`),o.addColorStop(.85,`rgba(60, 15, 10, ${.4*c})`),o.addColorStop(1,"rgba(80, 20, 15, 0)")),r.fillStyle=o,r.beginPath(),r.arc(0,0,a,0,2*Math.PI),r.fill(),t>.3){const i=e*(.8+.3*t),n=r.createRadialGradient(0,0,0,0,0,i);s.color&&s.color.includes("0, 0, 0")?(n.addColorStop(0,`rgba(0, 0, 0, ${c})`),n.addColorStop(.5,`rgba(0, 0, 0, ${.9*c})`),n.addColorStop(.8,`rgba(0, 0, 0, ${.5*c})`),n.addColorStop(1,"rgba(0, 0, 0, 0)")):(n.addColorStop(0,`rgba(0, 0, 0, ${c})`),n.addColorStop(.5,`rgba(10, 2, 0, ${.9*c})`),n.addColorStop(.8,`rgba(20, 5, 0, ${.5*c})`),n.addColorStop(1,"rgba(30, 8, 5, 0)")),r.fillStyle=n,r.beginPath(),r.arc(0,0,i,0,2*Math.PI),r.fill()}}h&&r.restore(),r.restore()}renderZenCore(t,i,e){this.ctx.save(),this.state.shakeOffset&&(t+=this.state.shakeOffset),this.state.driftY&&(i+=this.state.driftY),this.ctx.translate(t,i),this.gestureTransform&&void 0!==this.gestureTransform.rotation&&this.ctx.rotate(this.gestureTransform.rotation*Math.PI/180);const s=Date.now()/1e3,n=.5*Math.sin(.5*s)+1.5;let h=.1;"in"===this.zenTransition.phase?h=1:"entering"===this.zenTransition.phase?h=Math.max(.1,3.3*(this.zenTransition.lotusMorph-.7)):"exiting"===this.zenTransition.phase&&(h=Math.max(.1,.5*this.zenTransition.lotusMorph));const a=n*h;if(this.zenTransition.lotusMorph>0){this.ctx.shadowBlur=this.scaleValue(100)*a,this.ctx.shadowColor=`rgba(255, 223, 0, ${.5*a})`;const t=this.ctx.createRadialGradient(0,0,0,0,0,4*e);"in"!==this.zenTransition.phase?(t.addColorStop(0,"rgba(184, 134, 11, 0.8)"),t.addColorStop(.3,"rgba(153, 101, 21, 0.6)"),t.addColorStop(.6,"rgba(139, 69, 19, 0.4)"),t.addColorStop(1,"rgba(101, 67, 33, 0)")):(t.addColorStop(0,`rgba(255, 255, 255, ${1*a})`),t.addColorStop(.1,`rgba(255, 255, 240, ${1*a})`),t.addColorStop(.2,`rgba(255, 250, 205, ${.95*a})`),t.addColorStop(.35,`rgba(255, 240, 150, ${.85*a})`),t.addColorStop(.5,`rgba(255, 223, 0, ${.7*a})`),t.addColorStop(.65,`rgba(255, 215, 0, ${.5*a})`),t.addColorStop(.8,`rgba(255, 215, 0, ${.3*a})`),t.addColorStop(.9,`rgba(255, 215, 0, ${.15*a})`),t.addColorStop(.95,`rgba(255, 215, 0, ${.05*a})`),t.addColorStop(1,"rgba(255, 215, 0, 0)")),this.ctx.fillStyle=t,this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=this.scaleValue(2),this.ctx.beginPath(),this.ctx.arc(0,0,e,0,2*Math.PI,!1);const i=this.zenTransition.lotusMorph,s=this.zenTransition.petalSpread,n=this.zenTransition.smileCurve;if(i>.1){const t=e*(.05+.15*i);if(this.ctx.moveTo(0,t),this.ctx.bezierCurveTo(-e*(.05+.25*i*s),.1*e,-e*(.05+.3*i*s),-e*(.1+.4*i),0,-e*(.2+.65*i)),this.ctx.bezierCurveTo(e*(.05+.3*i*s),-e*(.1+.4*i),e*(.05+.25*i*s),.1*e,0,t),i>.3){const t=(i-.3)/.7;this.ctx.moveTo(.1*-e*t,.2*e),this.ctx.bezierCurveTo(-e*(.1+.4*t*s),.1*e,-e*(.2+.5*t*s),-e*(.1+.2*t),-e*(.1+.4*t*s),-e*(.2+.45*t)),this.ctx.bezierCurveTo(-e*(.05+.15*t),-e*(.1+.4*t),.05*-e*t,.1*e,.1*-e*t,.2*e),this.ctx.moveTo(.1*e*t,.2*e),this.ctx.bezierCurveTo(e*(.1+.4*t*s),.1*e,e*(.2+.5*t*s),-e*(.1+.2*t),e*(.1+.4*t*s),-e*(.2+.45*t)),this.ctx.bezierCurveTo(e*(.05+.15*t),-e*(.1+.4*t),.05*e*t,.1*e,.1*e*t,.2*e)}n>0&&(this.ctx.moveTo(.6*-e,e*(.5-.1*n)),this.ctx.quadraticCurveTo(0,e*(.5+.1*n),.6*e,e*(.5-.1*n)))}if(this.ctx.closePath(),this.ctx.fill("evenodd"),this.ctx.beginPath(),this.ctx.arc(0,0,e,0,2*Math.PI),this.ctx.stroke(),"in"===this.zenTransition.phase){const t=2*e,i=this.zenTransition.arcHeight*e,s=.5*e,n=this.ctx.createRadialGradient(0,s,0,0,s,1.2*t);n.addColorStop(0,`rgba(255, 255, 255, ${1*a})`),n.addColorStop(.25,`rgba(255, 252, 240, ${.8*a})`),n.addColorStop(.5,`rgba(255, 245, 200, ${.6*a})`),n.addColorStop(.75,`rgba(255, 235, 150, ${.4*a})`),n.addColorStop(1,"rgba(255, 223, 0, 0)"),this.ctx.fillStyle=n,this.ctx.fill();const h=this.ctx.createRadialGradient(0,-i/2,.5*e,0,-i/2,5*e);h.addColorStop(0,"rgba(255, 223, 0, 0)"),h.addColorStop(.1,`rgba(255, 223, 0, ${.25*a})`),h.addColorStop(.2,`rgba(255, 220, 0, ${.2*a})`),h.addColorStop(.35,`rgba(255, 215, 0, ${.15*a})`),h.addColorStop(.5,`rgba(255, 215, 0, ${.1*a})`),h.addColorStop(.65,`rgba(255, 215, 0, ${.06*a})`),h.addColorStop(.8,`rgba(255, 215, 0, ${.03*a})`),h.addColorStop(.9,`rgba(255, 215, 0, ${.01*a})`),h.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=h,this.ctx.fill()}}else{this.ctx.shadowBlur=0,this.ctx.shadowColor="transparent";const t=.3;this.ctx.fillStyle=`rgba(255, 215, 0, ${t})`,this.ctx.beginPath(),this.ctx.arc(0,0,e,0,2*Math.PI),this.ctx.fill();const i=this.ctx.createRadialGradient(0,0,0,0,0,e);i.addColorStop(0,"rgba(255, 255, 255, 0.2)"),i.addColorStop(.5,"rgba(255, 250, 230, 0.1)"),i.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=i,this.ctx.fill()}this.ctx.restore()}renderSpeakingRings(t,i,e,s){return this.specialEffects.renderSpeakingRings(t,i,e,s)}renderRecordingIndicator(t,i){return this.specialEffects.renderRecordingIndicator(t,i)}renderSleepIndicator(t,i,e){return this.specialEffects.renderSleepIndicator(t,i,e)}updateTimers(t){this.breathingAnimator.update(t,this.state.emotion,this.currentUndertone),"zen"===this.state.emotion?(this.breathingAnimator.setBreathRateMultiplier(.15),this.breathingAnimator.setBreathDepthMultiplier(2.5)):this.state.sleeping?(this.breathingAnimator.setBreathRateMultiplier(.5),this.breathingAnimator.setBreathDepthMultiplier(1.2)):(this.breathingAnimator.setBreathRateMultiplier(1),this.breathingAnimator.setBreathDepthMultiplier(1)),this.breathingAnimator.setIrregularBreathing(this.state.breathIrregular),this.eyeRenderer.setBlinkingEnabled(this.state.blinkingEnabled&&!this.state.sleeping&&"zen"!==this.state.emotion),this.eyeRenderer.update(t),this.state.blinking=this.eyeRenderer.blinking}applyUndertoneModifiers(t){if(t&&"object"==typeof t&&void 0!==t.weight){const{weight:i}=t;return this.state.sizeMultiplier=1+((t.sizeMultiplier||1)-1)*i,this.state.jitterAmount=(t.jitterAmount||0)*i,this.state.episodicFlutter=i>.5&&t.episodicFlutter||!1,this.state.glowRadiusMult=1+((t.glowRadiusMult||1)-1)*i,this.state.breathRateMult=1+((t.breathRateMult||1)-1)*i,this.state.breathDepthMult=1+((t.breathDepthMult||1)-1)*i,this.state.breathIrregular=i>.5&&t.breathIrregular||!1,this.state.particleRateMult=1,this.state.glowPulse=(t.glowPulse||0)*i,this.state.brightnessFlicker=(t.brightnessFlicker||0)*i,this.state.brightnessMult=1+((t.brightnessMult||1)-1)*i,this.state.saturationMult=1+((t.saturationMult||1)-1)*i,void(this.state.hueShift=(t.hueShift||0)*i)}if(!t||!this.undertoneModifiers[t])return this.state.sizeMultiplier=1,this.state.jitterAmount=0,this.state.episodicFlutter=!1,this.state.glowRadiusMult=1,this.state.breathRateMult=1,this.state.breathDepthMult=1,this.state.breathIrregular=!1,this.state.particleRateMult=1,this.state.glowPulse=0,this.state.brightnessFlicker=0,this.state.brightnessMult=1,this.state.saturationMult=1,void(this.state.hueShift=0);const i=this.undertoneModifiers[t];this.state.sizeMultiplier=i.sizeMultiplier,this.state.jitterAmount=i.jitterAmount||0,this.state.episodicFlutter=i.episodicFlutter||!1,this.state.glowRadiusMult=i.glowRadiusMult,this.state.breathRateMult=i.breathRateMult,this.state.breathDepthMult=i.breathDepthMult,this.state.breathIrregular=i.breathIrregular||!1,this.state.particleRateMult=1,this.state.glowPulse=i.glowPulse||0,this.state.brightnessFlicker=i.brightnessFlicker||0,this.state.brightnessMult=i.brightnessMult||1,this.state.saturationMult=i.saturationMult||1,this.state.hueShift=i.hueShift||0}applyUndertoneToColor(t,i){return this.colorUtilities.applyUndertoneToColor(t,i)}hexToRgb(t){return this.colorUtilities.hexToRgb(t)}rgbToHsl(t,i,e){return this.colorUtilities.rgbToHsl(t,i,e)}hslToHex(t,i,e){return this.colorUtilities.hslToHex(t,i,e)}hexToRgba(t,i=1){const e=this.hexToRgb(t);return e?`rgba(${e.r}, ${e.g}, ${e.b}, ${i})`:`rgba(255, 255, 255, ${i})`}startColorTransition(t,i,e=1500){this.colorUtilities.currentColor=this.state.glowColor,this.colorUtilities.currentIntensity=this.state.glowIntensity,this.colorUtilities.startColorTransition(t,i,e),this.colorTransition=this.colorUtilities.colorTransition}updateColorTransition(t){const i=this.colorUtilities.updateColorTransition(t);i&&(this.state.glowColor=i.color,this.state.glowIntensity=i.intensity,this.colorTransition=this.colorUtilities.colorTransition)}updateUndertone(t){this.state.undertone!==t&&this.glowCache.clear(),this.state.undertone=t,this.currentUndertone=t;const i=this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers?this.stateMachine.getWeightedUndertoneModifiers():null;if(this.applyUndertoneModifiers(i||t),this.state.emotion){const e=E&&E.isInitialized?E.getEmotion(this.state.emotion):A(this.state.emotion);if(e){const s=e.glowColor||this.config.defaultGlowColor,n=this.applyUndertoneToColor(s,i||t);this.startColorTransition(n,200)}}}setEmotionalState(t,i,e=null){this.state.emotion===t&&this.state.undertone===e||this.glowCache.clear(),this.state.undertone=e,this.currentUndertone=e;const s=this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers?this.stateMachine.getWeightedUndertoneModifiers():null;this.applyUndertoneModifiers(s||e);const n=i.glowColor||this.config.defaultGlowColor;let h;h="suspicion"===t?i.glowColor||n:this.applyUndertoneToColor(n,s||e);const a=s||(e?this.undertoneModifiers[e]:null),r=i.glowIntensity||1;let o=1;if(a)if(s){const t=a.weight||0;o=void 0!==a.glowRadiusMult&&isFinite(a.glowRadiusMult)&&isFinite(t)?1+(a.glowRadiusMult-1)*t:1}else o=void 0!==a.glowRadiusMult?a.glowRadiusMult:1;const c=r*o;let l=1500;"anger"===t||"fear"===t?l=800:("sadness"===t||"resting"===t||"zen"===t)&&(l=2e3);const u=this.state.emotion;this.state.emotion=t,"suspicion"===t?(this.state.isSuspicious=!0,this.state.targetSquintAmount=i&&i.coreSquint?i.coreSquint:.4,void 0===this.state.squintAmount&&(this.state.squintAmount=0),this.state.lastScanTime=Date.now(),this.state.scanPhase=0):(this.state.isSuspicious=!1,this.state.targetSquintAmount=0,void 0===this.state.squintAmount&&(this.state.squintAmount=0)),"zen"===t&&"zen"!==u?this.enterZenMode(h,c):"zen"===u&&"zen"!==t?this.exitZenMode(t,h,c):this.startColorTransition(h,c,l);const p=i.breathRate||1,d=i.breathDepth||this.config.breathingDepth;this.state.breathRate=a?p*a.breathRateMult:p,this.state.breathDepth=a?d*a.breathDepthMult:d,this.state.coreJitter=i.coreJitter||a&&a.jitterAmount>0,this.state.emotionEyeOpenness=i.eyeOpenness,this.state.emotionEyeArc=i.eyeArc}setBPM(t){}setRotationSpeed(t){this.state.rotationSpeed=t}setRotationAngle(t){this.state.manualRotation=t}setGazeOffset(t){"object"==typeof t&&null!==t&&({}.hasOwnProperty.call(t,"x")&&{}.hasOwnProperty.call(t,"y")?this.state.gazeOffset=t:(this.state.gazeOffset=t.offset||{x:0,y:0},this.state.gazeIntensity=t.proximity||0,this.state.gazeLocked=t.isLocked||!1)),this.idleTimer=0,this.isAsleep&&this.wakeUp()}getCurrentOrbPosition(){const t=this.canvasManager.width/2,i=this.canvasManager.height/2-this.config.topOffset;return{x:t+this.state.gazeOffset.x,y:i+this.state.gazeOffset.y}}setCustomScale(t){this.state.customScale=t}startSpeaking(){this.state.speaking=!0,this.speakingRings=[],this.ringSpawnTimer=0}stopSpeaking(){this.state.speaking=!1,this.speakingRings=[]}enterSleepMode(){this.state.sleeping=!0,this.sleepZ=[],this.state.eyeOpenness=1,this.state.sleepDimness=1,this.state.sleepScale=1,this.state.blinking=!1,this.animateEyeClose()}animateEyeClose(){this.loopCallbackIds.eyeClose&&(Hi.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null),this.loopCallbackIds.eyeOpen&&(Hi.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null);const t=performance.now(),i=2e3;this.loopCallbackIds.eyeClose=Hi.register(()=>{if(!this.state.sleeping)return void(this.loopCallbackIds.eyeClose=null);const e=performance.now()-t;if(e<i){const t=e/i,s=1-Math.pow(t,2);this.state.eyeOpenness=.1+.9*s,this.state.sleepDimness=1,this.state.sleepScale=1}else if(e<3e3){const t=(e-i)/1e3,s=1-Math.pow(1-t,3);this.state.eyeOpenness=.1,this.state.sleepDimness=1-.4*s,this.state.sleepScale=1-.1*s}else this.state.eyeOpenness=.1,this.state.sleepDimness=.6,this.state.sleepScale=.9,this.loopCallbackIds.eyeClose=null},1,this)}wakeUp(){this.state.sleeping&&(this.state.sleeping=!1,this.state.breathRate=1,this.state.breathDepth=this.config.breathingDepth,this.sleepZ=[],this.state.blinking=!1,this.eyeRenderer.blinking=!1,this.eyeRenderer.blinkTimer=0,this.animateEyeOpen(),this.state.coreJitter=!0,setTimeout(()=>{this.state.coreJitter=!1},200))}animateEyeOpen(){this.loopCallbackIds.eyeOpen&&(Hi.unregister(this.loopCallbackIds.eyeOpen),this.loopCallbackIds.eyeOpen=null),this.loopCallbackIds.eyeClose&&(Hi.unregister(this.loopCallbackIds.eyeClose),this.loopCallbackIds.eyeClose=null);const t=performance.now();this.loopCallbackIds.eyeOpen=Hi.register(()=>{const i=performance.now()-t;if(i<500){const t=i/500,e=Math.sin(t*Math.PI/2);this.state.sleepDimness=.6+.4*e,this.state.sleepScale=.9+.1*e,this.state.eyeOpenness=.1}else if(i<1500){const t=(i-500)/1e3,e=Math.sin(t*Math.PI/2);this.state.sleepDimness=1,this.state.sleepScale=1,this.state.eyeOpenness=.1+.9*e}else this.state.eyeOpenness=1,this.state.sleepDimness=1,this.state.sleepScale=1,this.loopCallbackIds.eyeOpen=null},1,this)}enterZenMode(t,i){this.animationFrameIds.zenEnter&&(cancelAnimationFrame(this.animationFrameIds.zenEnter),this.animationFrameIds.zenEnter=null),this.animationFrameIds.zenExit&&(cancelAnimationFrame(this.animationFrameIds.zenExit),this.animationFrameIds.zenExit=null),this.state.glowColor=t,this.state.glowIntensity=i,this.colorTransition.active=!1,this.zenTransition={active:!0,phase:"entering",startTime:performance.now(),previousEmotion:this.state.emotion,targetEmotion:null,scaleX:1,scaleY:1,arcHeight:0,lotusMorph:0,petalSpread:0,smileCurve:0};const e=()=>{if(!this.zenTransition.active||"entering"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenEnter=null);const t=performance.now()-this.zenTransition.startTime;if(t<400){const i=t/400,s=1-Math.pow(1-i,2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=s,this.zenTransition.petalSpread=s,this.zenTransition.smileCurve=Math.sin(i*Math.PI/2),this.loopCallbackIds.zenEnter=Hi.register(e,2,this)}else this.zenTransition.phase="in",this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=1,this.zenTransition.petalSpread=1,this.zenTransition.smileCurve=1,this.state.zenVortexIntensity=1,this.loopCallbackIds.zenEnter=null};this.loopCallbackIds.zenEnter=Hi.register(e,2,this)}exitZenMode(t,i,e){if(!this.zenTransition.active||"in"!==this.zenTransition.phase)return;this.animationFrameIds.zenEnter&&(cancelAnimationFrame(this.animationFrameIds.zenEnter),this.animationFrameIds.zenEnter=null),this.animationFrameIds.zenExit&&(cancelAnimationFrame(this.animationFrameIds.zenExit),this.animationFrameIds.zenExit=null),this.zenTransition.phase="exiting",this.zenTransition.startTime=performance.now(),this.zenTransition.targetEmotion=t;const s=()=>{if(!this.zenTransition.active||"exiting"!==this.zenTransition.phase)return void(this.loopCallbackIds.zenExit=null);const t=performance.now()-this.zenTransition.startTime,n=150;if(t<n){const h=t/n,a=1-Math.pow(1-h,2);if(0!==h&&this.colorTransition.active||this.startColorTransition(i,e,n),this.zenTransition.arcHeight=1.5*(1-a),this.zenTransition.smileCurve=1*(1-a),h>.3){const t=(h-.3)/.7;this.zenTransition.petalSpread=1*(1-t)}if(h>.5){const t=(h-.5)/.5;this.zenTransition.lotusMorph=1*(1-t)}this.loopCallbackIds.zenExit=Hi.register(s,2,this)}else if(t<350){const i=(t-n)/200;if(this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,i<.2){const t=i/.2;this.zenTransition.scaleY=1-.8*Math.sin(t*Math.PI)}else if(i<.6){const t=(i-.2)/.4;this.zenTransition.scaleY=1,this.state.shakeOffset=3*Math.sin(t*Math.PI*4)}else{const t=(i-.6)/.4;this.state.driftY=-10*t,this.state.glowIntensity=1+.5*t}this.loopCallbackIds.zenExit=Hi.register(s,2,this)}else if(t<550){const i=(t-n-200)/200,e=Math.sin(i*Math.PI/2);this.zenTransition.scaleX=1,this.zenTransition.scaleY=.2+.8*e,this.state.driftY=-10*(1-i),this.state.glowIntensity=1.5-.5*i,this.loopCallbackIds.zenExit=Hi.register(s,2,this)}else if(t<650){const i=(t-n-200-200)/100,e=Math.sin(i*Math.PI);this.zenTransition.scaleX=1+.05*e,this.zenTransition.scaleY=1+.05*e,this.loopCallbackIds.zenExit=Hi.register(s,2,this)}else this.zenTransition.active=!1,this.zenTransition.phase=null,this.zenTransition.scaleX=1,this.zenTransition.scaleY=1,this.zenTransition.arcHeight=0,this.zenTransition.lotusMorph=0,this.zenTransition.petalSpread=0,this.zenTransition.smileCurve=0,this.state.shakeOffset=0,this.state.driftY=0,this.loopCallbackIds.zenExit=null};this.loopCallbackIds.zenExit=Hi.register(s,2,this)}startRecording(){this.state.recording=!0}stopRecording(){this.state.recording=!1}setBlinkingEnabled(t){this.state.blinkingEnabled=t,t||(this.state.blinking=!1,this.eyeRenderer.blinking=!1,this.eyeRenderer.blinkTimer=0)}setGazeTracking(t){this.state.gazeTrackingEnabled=t,t?this.gazeTrackingInitialized||this.initGazeTracking():this.state.gazeTarget={x:0,y:0}}initGazeTracking(){this.gazeTrackingInitialized||(this.handleMouseMove=t=>{if(!this.state.gazeTrackingEnabled)return;const i=this.canvas.getBoundingClientRect(),e=i.width/2,s=i.height/2,n=t.clientX-i.left-e,h=t.clientY-i.top-s;this.state.gazeTarget={x:n/e,y:h/s}},this.handleTouchMove=t=>{if(this.state.gazeTrackingEnabled&&t.touches.length>0){const i=t.touches[0],e=this.canvas.getBoundingClientRect(),s=e.width/2,n=e.height/2,h=i.clientX-e.left-s,a=i.clientY-e.top-n;this.state.gazeTarget={x:h/s,y:a/n}}},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("touchmove",this.handleTouchMove),this.gazeTrackingInitialized=!0)}cleanupGazeTracking(){this.gazeTrackingInitialized&&(this.handleMouseMove&&document.removeEventListener("mousemove",this.handleMouseMove),this.handleTouchMove&&document.removeEventListener("touchmove",this.handleTouchMove),this.gazeTrackingInitialized=!1)}resetCanvasContext(){if(!this.canvas||!this.ctx)return;const{width:t}=this.canvas,{height:i}=this.canvas;this.ctx.setTransform(1,0,0,1,0,0),this.ctx.globalAlpha=1,this.ctx.globalCompositeOperation="source-over",this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.ctx.clearRect(0,0,t,i),this.offscreenCanvas&&this.offscreenCtx&&(this.offscreenCtx.setTransform(1,0,0,1,0,0),this.offscreenCtx.globalAlpha=1,this.offscreenCtx.globalCompositeOperation="source-over",this.offscreenCtx.imageSmoothingEnabled=!0,this.offscreenCtx.imageSmoothingQuality="high",this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)),this.contextStateManager&&this.contextStateManager.reset(),this.forceCleanRender=!0}setQualityLevel(t){this.qualityLevel=Math.max(0,Math.min(1,t)),this.qualityLevel<.5?(this.ctx.imageSmoothingEnabled=!1,this.state.breathDepth*=.5):this.qualityLevel<.8?(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="medium"):(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high")}setQualityReduction(t){t?this.setQualityLevel(.5):this.setQualityLevel(1)}handleContextRecovery(t){this.ctx=t}getUndertoneModifier(){return this.stateMachine&&this.stateMachine.getWeightedUndertoneModifiers?this.stateMachine.getWeightedUndertoneModifiers():this.currentUndertone&&this.undertoneModifiers[this.currentUndertone]?this.undertoneModifiers[this.currentUndertone]:null}applyGestureAnimations(){return this.gestureAnimator.applyGestureAnimations()}startGesture(t){return this.gestureAnimator.startGesture(t)}getCurrentGesture(){return this.gestureAnimator.getCurrentGesture()}startBounce(){this.gestureAnimator.startBounce()}startPulse(){this.gestureAnimator.startPulse()}startShake(){this.gestureAnimator.startShake()}startSpin(){this.gestureAnimator.startSpin()}startNod(){this.gestureAnimator.startNod()}startTilt(){this.gestureAnimator.startTilt()}startExpand(){this.gestureAnimator.startExpand()}startContract(){this.gestureAnimator.startContract()}startFlash(){this.gestureAnimator.startFlash()}startDrift(){this.gestureAnimator.startDrift()}startStretch(){this.gestureAnimator.startStretch()}startGlow(){this.gestureAnimator.startGlow()}startFlicker(){this.gestureAnimator.startFlicker()}startVibrate(){this.gestureAnimator.startVibrate()}startOrbital(){this.gestureAnimator.startOrbital()}startHula(){this.gestureAnimator.startHula()}startWave(){this.gestureAnimator.startWave()}startBreathe(){this.gestureAnimator.startBreathe()}startMorph(){this.gestureAnimator.startMorph()}startSlowBlink(){this.gestureAnimator.startSlowBlink()}startLook(){this.gestureAnimator.startLook()}startSettle(){this.gestureAnimator.startSettle()}startBreathIn(){this.gestureAnimator.startBreathIn()}startBreathOut(){this.gestureAnimator.startBreathOut()}startBreathHold(){this.gestureAnimator.startBreathHold()}startBreathHoldEmpty(){this.gestureAnimator.startBreathHoldEmpty()}startJump(){this.gestureAnimator.startJump()}startSway(){this.gestureAnimator.startSway()}startFloat(){this.gestureAnimator.startFloat()}startRain(){this.gestureAnimator.startRain()}startRunningMan(){this.gestureAnimator.startRunningMan()}startCharleston(){this.gestureAnimator.startCharleston()}startGrooveSway(t){this.ambientDanceAnimator.startAmbientAnimation("grooveSway",t)}startGrooveBob(t){this.ambientDanceAnimator.startAmbientAnimation("grooveBob",t)}startGrooveFlow(t){this.ambientDanceAnimator.startAmbientAnimation("grooveFlow",t)}startGroovePulse(t){this.ambientDanceAnimator.startAmbientAnimation("groovePulse",t)}startGrooveStep(t){this.ambientDanceAnimator.startAmbientAnimation("grooveStep",t)}startSparkle(){this.gestureAnimator.startSparkle()}startShimmer(){this.gestureAnimator.startShimmer()}startWiggle(){this.gestureAnimator.startWiggle()}startGroove(){this.gestureAnimator.startGroove()}startPoint(){this.gestureAnimator.startPoint()}startLean(){this.gestureAnimator.startLean()}startReach(){this.gestureAnimator.startReach()}startHeadBob(){this.gestureAnimator.startHeadBob()}startOrbit(){this.gestureAnimator.startOrbit()}stopAllGestures(){this.gestureAnimator.stopAllGestures(),this.currentGesture=null}isGestureActive(){return Object.values(this.gestureAnimator.gestureAnimations).some(t=>t.active)}destroy(){for(const t in this.animationFrameIds)this.animationFrameIds[t]&&(cancelAnimationFrame(this.animationFrameIds[t]),this.animationFrameIds[t]=null);this.colorTransition.active=!1,this.zenTransition&&(this.zenTransition.active=!1),this.speakingRings=[],this.gestureCompositor&&this.gestureCompositor.clearCache()}}class Xi{constructor(t,i={}){this.canvas=t,this.config={smoothing:i.smoothing||.1,maxOffset:i.maxOffset||.3,lockDistance:i.lockDistance||30,enabled:!1!==i.enabled,boundaryPadding:i.boundaryPadding||.8},this.canvasCenter={x:0,y:0},this.mousePos={x:0,y:0},this.targetGaze={x:0,y:0},this.currentGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.cachedRect=null,this.touches=new Map,this.primaryTouch=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.onInteraction=null,this.updateCanvasCenter(),this.attachEventListeners(),this.resizeObserver=new ResizeObserver(()=>{this.updateCanvasCenter()}),this.resizeObserver.observe(this.canvas)}updateCanvasCenter(){this.cachedRect=this.canvas.getBoundingClientRect(),this.canvasCenter={x:this.cachedRect.width/2,y:this.cachedRect.height/2},0===this.mousePos.x&&0===this.mousePos.y&&(this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y})}attachEventListeners(){this.config.enabled&&(this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseleave",this.handleMouseLeave),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!0}),this.canvas.addEventListener("touchcancel",this.handleTouchEnd,{passive:!0}))}handleMouseMove(t){const i=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:t.clientX-i.left,y:t.clientY-i.top},this.updateTargetGaze(),this.onInteraction&&this.onInteraction("mouse")}handleMouseLeave(){this.targetGaze={x:0,y:0},this.isLocked=!1,this.proximity=0,this.mousePos={x:this.canvasCenter.x,y:this.canvasCenter.y}}handleTouchStart(t){for(const i of t.changedTouches)this.touches.set(i.identifier,{x:i.clientX,y:i.clientY}),this.primaryTouch||1!==this.touches.size||(this.primaryTouch=i.identifier);null!==this.primaryTouch&&this.updateTouchPosition(t.touches)}handleTouchMove(t){for(const i of t.changedTouches)this.touches.has(i.identifier)&&this.touches.set(i.identifier,{x:i.clientX,y:i.clientY});null!==this.primaryTouch&&(this.updateTouchPosition(t.touches),this.onInteraction&&this.onInteraction("touch"))}handleTouchEnd(t){for(const i of t.changedTouches)this.touches.delete(i.identifier),i.identifier===this.primaryTouch&&(this.primaryTouch=null,this.touches.size>0?this.primaryTouch=this.touches.keys().next().value:this.handleMouseLeave())}updateTouchPosition(t){for(const i of t)if(i.identifier===this.primaryTouch){const t=this.cachedRect||this.canvas.getBoundingClientRect();this.mousePos={x:i.clientX-t.left,y:i.clientY-t.top},this.updateTargetGaze();break}}updateTargetGaze(){const t=this.mousePos.x-this.canvasCenter.x,i=this.mousePos.y-this.canvasCenter.y,e=Math.sqrt(t*t+i*i),s=Math.min(this.canvasCenter.x,this.canvasCenter.y);if(this.proximity=Math.max(0,1-e/s),this.isLocked=e<this.config.lockDistance,this.isLocked)this.targetGaze={x:t*this.config.maxOffset*2,y:i*this.config.maxOffset*2};else{const n=Math.min(this.canvasCenter.x,this.canvasCenter.y)*this.config.maxOffset;if(e>0){const h=Math.min(1,e/s);this.targetGaze={x:t/e*n*h*this.config.boundaryPadding,y:i/e*n*h*this.config.boundaryPadding}}else this.targetGaze={x:0,y:0}}}update(t){if(!this.config.enabled)return;const i=1-Math.pow(1-this.config.smoothing,t/16.67);if(this.currentGaze.x+=(this.targetGaze.x-this.currentGaze.x)*i,this.currentGaze.y+=(this.targetGaze.y-this.currentGaze.y)*i,this.isLocked){const t=.5;this.currentGaze.x+=(Math.random()-.5)*t,this.currentGaze.y+=(Math.random()-.5)*t}}getGazeOffset(t){return{x:this.currentGaze.x,y:this.currentGaze.y}}getState(){return{gaze:{...this.currentGaze},target:{...this.targetGaze},proximity:this.proximity,isLocked:this.isLocked,isActive:this.config.enabled}}enable(){this.config.enabled||(this.config.enabled=!0,this.attachEventListeners())}disable(){this.config.enabled&&(this.config.enabled=!1,this.detachEventListeners(),this.targetGaze={x:0,y:0})}detachEventListeners(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseleave",this.handleMouseLeave),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("touchcancel",this.handleTouchEnd)}setInteractionCallback(t){this.onInteraction=t}destroy(){this.detachEventListeners(),this.resizeObserver&&this.resizeObserver.disconnect(),this.touches.clear()}}class Yi{constructor(t={}){this.config={blinkInterval:t.blinkInterval||{min:3e3,max:7e3},blinkDuration:t.blinkDuration||150,swayInterval:t.swayInterval||{min:2e4,max:4e4},swayDuration:t.swayDuration||4e3,swayIntensity:t.swayIntensity||1.5,sleepTimeout:void 0!==t.sleepTimeout?t.sleepTimeout:1/0,breathingSpeed:t.breathingSpeed||.25,breathingDepth:t.breathingDepth||.1,enabled:!1!==t.enabled},this.state={isBlinking:!1,isSwaying:!1,isAsleep:!1,breathingPhase:0,breathRate:1,breathDepth:this.config.breathingDepth},this.timers={idle:0,blink:0,sway:0,swayProgress:0,nextBlink:this.getRandomInterval("blink"),nextSway:this.getRandomInterval("sway")},this.swayOffset={x:0,y:0},this.swayTarget={x:0,y:0},this.swayStart={x:0,y:0},this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}update(t){this.config.enabled&&(this.updateBreathing(t),this.timers.idle+=t,!this.state.isAsleep&&this.timers.idle>=this.config.sleepTimeout&&this.enterSleep(),this.state.isAsleep||this.updateBlinking(t),this.state.isAsleep||this.updateSwaying(t))}updateBreathing(t){const i=this.config.breathingSpeed*this.state.breathRate;this.state.breathingPhase+=i*t/1e3,this.state.breathingPhase>2*Math.PI&&(this.state.breathingPhase-=2*Math.PI)}updateBlinking(t){this.isBlinkingEnabled()&&(this.state.isBlinking?(this.timers.blink+=t,this.timers.blink>=this.config.blinkDuration&&this.endBlink()):(this.timers.blink+=t,this.timers.blink>=this.timers.nextBlink&&this.startBlink()))}updateSwaying(t){if(this.state.isSwaying){this.timers.sway+=t;const i=Math.min(this.timers.sway/this.config.swayDuration,1),e=(Math.sin((i-.5)*Math.PI)+1)/2;this.swayOffset.x=this.swayStart.x+(this.swayTarget.x-this.swayStart.x)*e,this.swayOffset.y=this.swayStart.y+(this.swayTarget.y-this.swayStart.y)*e,i>=1&&this.endSway()}else this.timers.sway+=t,this.timers.sway>=this.timers.nextSway&&this.startSway()}startBlink(){this.state.isBlinking=!0,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"start"})}endBlink(){this.state.isBlinking=!1,this.timers.blink=0,this.timers.nextBlink=this.getRandomInterval("blink"),this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})}startSway(){this.state.isSwaying=!0,this.timers.sway=0,this.swayStart={...this.swayOffset};const t=Math.random()*Math.PI*2,i=this.config.swayIntensity*(.5+.5*Math.random());this.swayTarget={x:Math.cos(t)*i*1.5,y:Math.sin(t)*i*.5},this.callbacks.onSway&&this.callbacks.onSway({phase:"start",offset:this.swayOffset})}endSway(){this.state.isSwaying=!1,this.timers.sway=0,this.timers.nextSway=this.getRandomInterval("sway"),this.swayStart={...this.swayOffset},this.callbacks.onSway&&this.callbacks.onSway({phase:"end",offset:this.swayOffset})}enterSleep(){this.state.isAsleep=!0,this.state.breathRate=.5,this.state.breathDepth=.15,this.state.isBlinking&&(this.state.isBlinking=!1,this.timers.blink=0,this.callbacks.onBlink&&this.callbacks.onBlink({phase:"end"})),this.callbacks.onSleep&&this.callbacks.onSleep()}wakeUp(){this.state.isAsleep&&(this.state.isAsleep=!1,this.state.breathRate=1,this.state.breathDepth=this.config.breathingDepth,this.timers.idle=0,this.callbacks.onWake&&this.callbacks.onWake(),this.performWakeAnimation())}performWakeAnimation(){const t={x:.5*this.config.swayIntensity,y:-this.config.swayIntensity};this.swayStart={...this.swayOffset},this.swayTarget=t,this.state.isSwaying=!0,this.timers.sway=0,this.callbacks.onSway&&this.callbacks.onSway({phase:"wake",offset:this.swayOffset}),setTimeout(()=>{this.swayStart={...this.swayOffset},this.swayTarget={x:0,y:0},this.timers.sway=0},1e3)}resetIdleTimer(){this.timers.idle=0,this.state.isAsleep&&this.wakeUp()}setBlinkingEnabled(t){this.config.blinkingEnabled=t,!t&&this.state.isBlinking&&this.endBlink()}isBlinkingEnabled(){return!1!==this.config.blinkingEnabled}getBreathingFactor(){return 1+Math.sin(this.state.breathingPhase)*this.state.breathDepth*this.state.breathRate}getBlinkProgress(){return this.state.isBlinking?Math.min(this.timers.blink/this.config.blinkDuration,1):0}getSwayOffset(){return this.swayOffset||{x:0,y:0}}getRandomInterval(t){const i=this.config[`${t}Interval`];return i.min+Math.random()*(i.max-i.min)}setCallback(t,i){({}).hasOwnProperty.call(this.callbacks,t)&&(this.callbacks[t]=i)}getState(){return{...this.state,breathingFactor:this.getBreathingFactor(),blinkProgress:this.getBlinkProgress(),swayOffset:this.getSwayOffset()}}enable(){this.config.enabled=!0}disable(){this.config.enabled=!1,this.state.isBlinking=!1,this.state.isSwaying=!1,this.swayOffset={x:0,y:0}}destroy(){this.callbacks={onBlink:null,onSway:null,onSleep:null,onWake:null}}}class Ui{constructor(){this.A4_FREQUENCY=440,this.NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.INTERVALS={unison:0,minorSecond:1,majorSecond:2,minorThird:3,majorThird:4,perfectFourth:5,tritone:6,perfectFifth:7,minorSixth:8,majorSixth:9,minorSeventh:10,majorSeventh:11,octave:12},this.SCALES={major:[0,2,4,5,7,9,11],naturalMinor:[0,2,3,5,7,8,10],harmonicMinor:[0,2,3,5,7,8,11],melodicMinor:[0,2,3,5,7,9,11],ionian:[0,2,4,5,7,9,11],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],aeolian:[0,2,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],majorPentatonic:[0,2,4,7,9],minorPentatonic:[0,3,5,7,10],blues:[0,3,5,6,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],wholeHalfDiminished:[0,2,3,5,6,8,9,11],arabic:[0,1,4,5,7,8,11],japanese:[0,1,5,7,8],hungarian:[0,2,3,6,7,8,11],bebopMajor:[0,2,4,5,7,8,9,11]},this.CHORDS={major:[0,4,7],minor:[0,3,7],diminished:[0,3,6],augmented:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],min7b5:[0,3,6,10],dim7:[0,3,6,9],maj9:[0,4,7,11,14],min9:[0,3,7,10,14],dom9:[0,4,7,10,14],add9:[0,4,7,14],maj11:[0,4,7,11,14,17],min11:[0,3,7,10,14,17],maj13:[0,4,7,11,14,17,21],min13:[0,3,7,10,14,17,21]},this.EMOTION_MODES={excited:{scale:"lydian",tempo:140,dynamics:"forte",articulation:"staccato"},calm:{scale:"major",tempo:60,dynamics:"piano",articulation:"legato"},curious:{scale:"mixolydian",tempo:100,dynamics:"mezzoForte",articulation:"tenuto"},sleepy:{scale:"aeolian",tempo:50,dynamics:"pianissimo",articulation:"legato"},alert:{scale:"dorian",tempo:120,dynamics:"forte",articulation:"marcato"},pleased:{scale:"majorPentatonic",tempo:90,dynamics:"mezzoForte",articulation:"legato"},confused:{scale:"wholeHalfDiminished",tempo:80,dynamics:"mezzoPiano",articulation:"rubato"},energetic:{scale:"bebopMajor",tempo:160,dynamics:"fortissimo",articulation:"staccato"},melancholy:{scale:"harmonicMinor",tempo:70,dynamics:"mezzoPiano",articulation:"legato"},playful:{scale:"blues",tempo:110,dynamics:"mezzoForte",articulation:"swing"}},this.PROGRESSIONS={I_V_vi_IV:[1,5,6,4],I_IV_V:[1,4,5],ii_V_I:[2,5,1],I_vi_IV_V:[1,6,4,5],vi_IV_I_V:[6,4,1,5],I_VI_ii_V:[1,6,2,5],iii_vi_ii_V:[3,6,2,5],I_ii_iii_IV:[1,2,3,4],I_I_I_I_IV_IV_I_I_V_IV_I_V:[1,1,1,1,4,4,1,1,5,4,1,5],i_VII_VI_VII:[1,7,6,7],I_II_IV_I:[1,2,4,1]}}noteToMidi(t){const i=t.slice(0,-1),e=parseInt(t.slice(-1),10),s=this.NOTES.indexOf(i);if(-1===s)throw new Error(`Invalid note: ${t}`);return 12*(e+1)+s}midiToFrequency(t){return this.A4_FREQUENCY*Math.pow(2,(t-69)/12)}noteToFrequency(t){return this.midiToFrequency(this.noteToMidi(t))}generateScale(t,i="major"){const e=this.SCALES[i];if(!e)throw new Error(`Unknown scale type: ${i}`);const s=this.noteToMidi(t);return e.map(t=>this.midiToFrequency(s+t))}generateChord(t,i="major"){const e=this.CHORDS[i];if(!e)throw new Error(`Unknown chord type: ${i}`);const s=this.noteToMidi(t);return e.map(t=>this.midiToFrequency(s+t))}generateProgression(t,i="major",e=this.PROGRESSIONS.I_V_vi_IV){const s=this.generateScale(t,i),n=[];for(const t of e){const e=s[(t-1)%s.length];let h="major";"major"===i?2===t||3===t||6===t?h="minor":7===t&&(h="diminished"):"naturalMinor"===i&&(h=1===t||4===t||5===t?"minor":2===t?"diminished":"major");const a=Math.round(12*Math.log2(e/this.A4_FREQUENCY)+69),r=Math.floor(a/12)-1,o=a%12,c=this.NOTES[o]+r;n.push({degree:t,root:e,frequencies:this.generateChord(c,h),type:h})}return n}getEmotionMusic(t){return this.EMOTION_MODES[t]||this.EMOTION_MODES.calm}circleOfFifths(t="C",i=12,e=!0){const s=t.replace(/\d/,"");let n=this.NOTES.indexOf(s);const h=[t];for(let t=1;t<i;t++)n=e?(n+7)%12:(n+5)%12,h.push(this.NOTES[n]);return h}analyzeInterval(t,i){const e=this.noteToMidi(t),s=this.noteToMidi(i),n=Math.abs(s-e);let h="unknown";for(const[t,i]of Object.entries(this.INTERVALS))if(i===n%12){h=t;break}return{semitones:n,intervalName:h,octaves:Math.floor(n/12),consonant:[0,3,4,5,7,8,9,12].includes(n%12),ratio:this.getIntervalRatio(n%12)}}getIntervalRatio(t){return{0:"1:1",1:"16:15",2:"9:8",3:"6:5",4:"5:4",5:"4:3",6:"45:32",7:"3:2",8:"8:5",9:"5:3",10:"16:9",11:"15:8",12:"2:1"}[t]||"complex"}generateMelody(t={}){const{key:i="C4",scale:e="major",length:s=8,stepProbability:n=.7,restProbability:h=.1}=t,a=this.generateScale(i,e),r=[];let o=0;for(let t=0;t<s;t++){if(Math.random()<h){r.push({frequency:0,duration:.25,isRest:!0});continue}let t;if(Math.random()<n){const i=Math.random()<.5?-1:1;t=Math.max(0,Math.min(a.length-1,o+i))}else{const i=Math.floor(3*Math.random())+2,e=Math.random()<.5?-1:1;t=Math.max(0,Math.min(a.length-1,o+i*e))}o=t;const i=[.25,.5,.75,1],e=i[Math.floor(Math.random()*i.length)];r.push({frequency:a[o],duration:e,isRest:!1})}return r}}class Wi{constructor(t){this.audioContext=t,this.musicTheory=new Ui,this.currentKey="C4",this.currentScale="major",this.currentTempo=120,this.currentEmotion="calm",this.voices=new Map,this.layers={bass:{active:!1,gain:.3},chord:{active:!1,gain:.2},melody:{active:!1,gain:.4},pad:{active:!1,gain:.15}},this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.audioContext.destination),this.reverb=this.createReverb(),this.delay=this.createDelay(),this.filter=this.createFilter(),this.filter.connect(this.delay),this.delay.connect(this.reverb),this.reverb.connect(this.masterGain),this.dryGain=this.audioContext.createGain(),this.dryGain.gain.value=.7,this.dryGain.connect(this.masterGain),this.wetGain=this.audioContext.createGain(),this.wetGain.gain.value=.3,this.wetGain.connect(this.filter),this.nextNoteTime=0,this.noteResolution=0,this.noteLength=.05,this.currentChordIndex=0,this.currentMelodyNote=0,this.progression=null,this.isPlaying=!1,this.lookahead=25,this.scheduleAheadTime=.1}createReverb(){const t=this.audioContext.createConvolver(),i=2*this.audioContext.sampleRate,e=this.audioContext.createBuffer(2,i,this.audioContext.sampleRate);for(let t=0;t<2;t++){const s=e.getChannelData(t);for(let t=0;t<i;t++)s[t]=(2*Math.random()-1)*Math.pow(1-t/i,2)}return t.buffer=e,t}createDelay(){const t=this.audioContext.createDelay(1);t.delayTime.value=.15;const i=this.audioContext.createGain();return i.gain.value=.3,t.connect(i),i.connect(t),t}createFilter(){const t=this.audioContext.createBiquadFilter();return t.type="lowpass",t.frequency.value=2e3,t.Q.value=1,t}setEmotion(t){this.currentEmotion=t;const i=this.musicTheory.getEmotionMusic(t);this.currentScale=i.scale,this.currentTempo=i.tempo;const e={excited:{freq:4e3,Q:2},calm:{freq:1500,Q:.7},curious:{freq:2500,Q:1.5},sleepy:{freq:800,Q:.5},alert:{freq:3e3,Q:1.8},energetic:{freq:5e3,Q:2.5}}[t]||{freq:2e3,Q:1};this.filter.frequency.exponentialRampToValueAtTime(e.freq,this.audioContext.currentTime+.5),this.filter.Q.linearRampToValueAtTime(e.Q,this.audioContext.currentTime+.5),this.generateEmotionProgression()}generateEmotionProgression(){const t={excited:"I_V_vi_IV",calm:"I_vi_IV_V",curious:"ii_V_I",sleepy:"vi_IV_I_V",alert:"I_IV_V",energetic:"I_V_vi_IV"}[this.currentEmotion]||"I_V_vi_IV";this.progression=this.musicTheory.generateProgression(this.currentKey,this.currentScale,this.musicTheory.PROGRESSIONS[t])}playChord(t,i=1,e=.01){const s=this.audioContext.currentTime,n=this.audioContext.createGain();n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(this.layers.chord.gain,s+e),n.gain.exponentialRampToValueAtTime(.01,s+i),n.connect(this.dryGain),n.connect(this.wetGain);const h=t.map((t,e)=>{const h=this.audioContext.createOscillator();return h.frequency.value=t,h.type=0===e?"sine":1===e?"triangle":"sawtooth",h.detune.value=10*(Math.random()-.5),h.connect(n),h.start(s),h.stop(s+i),h}),a=`chord_${Date.now()}`;this.voices.set(a,{oscillators:h,gain:n}),setTimeout(()=>{this.voices.delete(a)},1e3*(i+.1))}playMelody(t,i=0){let e=i||this.audioContext.currentTime;t.forEach((t,i)=>{if(t.isRest)return void(e+=t.duration);const s=this.audioContext.createOscillator(),n=this.audioContext.createGain();s.frequency.value=t.frequency,s.type="sine";const h=this.audioContext.createOscillator(),a=this.audioContext.createGain();h.frequency.value=5,a.gain.value=5,h.connect(a),a.connect(s.frequency),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(this.layers.melody.gain,e+.01),n.gain.exponentialRampToValueAtTime(.01,e+.9*t.duration),s.connect(n),n.connect(this.dryGain),n.connect(this.wetGain),s.start(e),s.stop(e+t.duration),h.start(e),h.stop(e+t.duration),e+=t.duration})}createPad(t,i=4){const e=this.audioContext.currentTime,s=this.audioContext.createGain();s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(this.layers.pad.gain,e+1),s.gain.linearRampToValueAtTime(this.layers.pad.gain,e+i-1),s.gain.linearRampToValueAtTime(0,e+i),s.connect(this.wetGain);for(let n=0;n<4;n++){const h=this.audioContext.createOscillator();h.frequency.value=t,h.type="sawtooth",h.detune.value=15*(n-2);const a=this.audioContext.createGain();a.gain.value=1/4;const r=this.audioContext.createOscillator(),o=this.audioContext.createGain();r.frequency.value=.2+.1*n,o.gain.value=10,r.connect(o),o.connect(h.frequency),h.connect(a),a.connect(s),h.start(e),h.stop(e+i),r.start(e),r.stop(e+i)}}playGestureSound(t){const i={breathe:()=>{const t=this.musicTheory.generateChord(this.currentKey,"maj7");this.playChord(t,2,.5),this.createPad(t[0]/2,3)},excited:()=>{const t=this.musicTheory.generateScale(this.currentKey,"lydian").map((t,i)=>({frequency:t,duration:.1,isRest:!1}));this.playMelody(t)},wave:()=>{const t=this.musicTheory.noteToFrequency(this.currentKey),i=2*t,e=this.audioContext.createOscillator(),s=this.audioContext.createGain();e.frequency.setValueAtTime(t,this.audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(i,this.audioContext.currentTime+.5),e.frequency.exponentialRampToValueAtTime(t,this.audioContext.currentTime+1),s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.1),s.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.9),s.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+1),e.connect(s),s.connect(this.wetGain),e.start(),e.stop(this.audioContext.currentTime+1)},morph:()=>{const t=this.musicTheory.generateChord(this.currentKey,"minor"),i=this.musicTheory.generateChord(this.currentKey,"major");this.playChord(t,.5),setTimeout(()=>{this.playChord(i,1)},400)},jump:()=>{const t=this.musicTheory.generateChord(this.currentKey,"dom7");for(let i=0;i<3;i++)setTimeout(()=>{this.playChord(t.map(t=>t*Math.pow(2,i/12)),.1,.001)},100*i)},curious:()=>{const t=this.musicTheory.generateMelody({key:this.currentKey,scale:"mixolydian",length:5,stepProbability:.3});this.playMelody(t)}}[t];i&&i()}startHarmony(){this.isPlaying||(this.isPlaying=!0,this.currentChordIndex=0,this.nextNoteTime=this.audioContext.currentTime,this.generateEmotionProgression(),this.scheduleHarmony())}scheduleHarmony(){if(this.isPlaying){for(;this.nextNoteTime<this.audioContext.currentTime+this.scheduleAheadTime;){if(this.progression&&this.layers.chord.active){const t=this.progression[this.currentChordIndex];this.playChord(t.frequencies,.5),this.currentChordIndex=(this.currentChordIndex+1)%this.progression.length}if(this.layers.bass.active&&this.progression){const t=this.progression[this.currentChordIndex].frequencies[0]/2;this.playBassNote(t,.25)}const t=60/this.currentTempo;this.nextNoteTime+=.25*t}setTimeout(()=>this.scheduleHarmony(),this.lookahead)}}playBassNote(t,i){const e=this.audioContext.createOscillator(),s=this.audioContext.createGain();e.frequency.value=t,e.type="sine",s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.linearRampToValueAtTime(this.layers.bass.gain,this.audioContext.currentTime+.01),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+i),e.connect(s),s.connect(this.dryGain),e.start(),e.stop(this.audioContext.currentTime+i)}stopHarmony(){this.isPlaying=!1}setLayerActive(t,i){this.layers[t]&&(this.layers[t].active=i)}setMasterVolume(t){this.masterGain.gain.exponentialRampToValueAtTime(Math.max(.01,t),this.audioContext.currentTime+.1)}setEffectsMix(t){const i=1-t;this.dryGain.gain.linearRampToValueAtTime(i,this.audioContext.currentTime+.1),this.wetGain.gain.linearRampToValueAtTime(t,this.audioContext.currentTime+.1)}}class Ni{constructor(){this.context=null,this.isEnabled=!1,this.isInitialized=!1,this.nodes={master:null,ambient:null,effects:null},this.harmonicSystem=null,this.useHarmonicSystem=!1,this.warningTimestamps={},this.warningThrottle=5e3,this.currentOscillator=null,this.currentGain=null,this.masterVolume=.5,this.ambientVolume=.1,this.emotionalTones=new Map([["neutral",{frequency:220,waveform:"sine",volume:.1}],["joy",{frequency:440,waveform:"triangle",volume:.15}],["sadness",{frequency:165,waveform:"sine",volume:.08}],["anger",{frequency:330,waveform:"sawtooth",volume:.12}],["fear",{frequency:880,waveform:"square",volume:.09}],["surprise",{frequency:660,waveform:"triangle",volume:.13}],["disgust",{frequency:110,waveform:"sawtooth",volume:.07}],["love",{frequency:528,waveform:"sine",volume:.11}]])}initialize(){try{const t=window.AudioContext||window.webkitAudioContext;return!!t&&(this.context=new t,this.harmonicSystem=new Wi(this.context),this.nodes.master=this.context.createGain(),this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),this.nodes.master.connect(this.context.destination),this.nodes.effects=this.context.createGain(),this.nodes.effects.gain.setValueAtTime(1,this.context.currentTime),this.nodes.effects.connect(this.nodes.master),this.isEnabled=!0,this.isInitialized=!0,!0)}catch(t){return this.isEnabled=!1,!1}}async resumeContext(){if(this.context&&"suspended"===this.context.state)try{await this.context.resume()}catch(t){}}setMasterVolume(t,i=null){this.masterVolume=Math.max(0,Math.min(1,t)),this.isEnabled&&this.nodes.master&&(this.nodes.master.gain.setValueAtTime(this.masterVolume,this.context.currentTime),i&&this.updateAmbientVolume(i))}getMasterVolume(){return this.masterVolume}isAvailable(){return this.isEnabled&&this.isInitialized}setHarmonicMode(t){this.useHarmonicSystem=t,t&&this.harmonicSystem?this.stopAmbientTone():!t&&this.harmonicSystem&&this.harmonicSystem.stopHarmony()}startHarmony(){this.harmonicSystem&&this.useHarmonicSystem&&this.isAvailable()&&this.harmonicSystem.startHarmony()}stopHarmony(){this.harmonicSystem&&this.harmonicSystem.stopHarmony()}setHarmonicLayer(t,i){this.harmonicSystem&&this.harmonicSystem.setLayerActive(t,i)}setHarmonicEffects(t){this.harmonicSystem&&this.harmonicSystem.setEffectsMix(t)}cleanup(){try{this.currentOscillator&&(this.currentOscillator.stop(),this.currentOscillator=null),this.currentGain&&(this.currentGain=null),this.context&&"closed"!==this.context.state&&this.context.close()}catch(t){}finally{this.context=null,this.nodes={master:null,ambient:null,effects:null},this.currentOscillator=null,this.currentGain=null,this.isEnabled=!1,this.isInitialized=!1}}getEmotionalTone(t){return this.emotionalTones.get(t)||null}setAmbientTone(t,i=500){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.setEmotion(t);const e=this.getEmotionalTone(t);if(e)try{this.resumeContext();const{currentTime:t}=this.context,s=i/1e3;this.currentOscillator&&this.currentGain&&(this.currentGain.gain.exponentialRampToValueAtTime(.001,t+.5*s),this.currentOscillator.stop(t+.5*s));const n=this.context.createOscillator(),h=this.context.createGain();n.type=e.waveform,n.frequency.setValueAtTime(e.frequency,t);const a=e.volume*this.masterVolume;h.gain.setValueAtTime(.001,t),h.gain.exponentialRampToValueAtTime(a,t+s),n.connect(h),h.connect(this.nodes.master),n.start(t),this.currentOscillator=n,this.currentGain=h}catch(t){}}stopAmbientTone(t=500){if(this.isAvailable()&&this.currentOscillator)try{const{currentTime:i}=this.context,e=t/1e3;this.currentGain&&this.currentGain.gain.exponentialRampToValueAtTime(.001,i+e),this.currentOscillator.stop(i+e),this.currentOscillator=null,this.currentGain=null}catch(t){}}updateAmbientVolume(t){if(!this.isAvailable()||!this.currentGain||!t)return;const i=this.getEmotionalTone(t);if(i)try{const t=i.volume*this.masterVolume,{currentTime:e}=this.context;this.currentGain.gain.exponentialRampToValueAtTime(t,e+.1)}catch(t){}}playGestureSound(t,i="neutral"){if(!this.isAvailable())return;if(this.useHarmonicSystem&&this.harmonicSystem)return void this.harmonicSystem.playGestureSound(t);const e=this.getGestureSoundConfig(t);if(e)try{this.resumeContext();const{currentTime:t}=this.context,s=e.duration/1e3,n=this.getEmotionalModifiers(i),h=e.volume*this.masterVolume*n.intensity,a=this.context.createOscillator(),r=this.context.createGain();a.type=e.waveform,this.applyFrequencyEnvelope(a,e.frequencyEnvelope,t,s),this.applyVolumeEnvelope(r,e.volumeEnvelope,t,s,h),a.connect(r),r.connect(this.nodes.effects),a.start(t),a.stop(t+s)}catch(t){}else this.throttledWarn(`Unknown gesture "${t}", cannot play sound`,`gesture_${t}`)}getGestureSoundConfig(t){return new Map([["bounce",{duration:100,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:200},{time:.5,frequency:400},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.8},{time:1,volume:0}]}],["pulse",{duration:300,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:450},{time:1,frequency:300}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["shake",{duration:200,waveform:"sawtooth",volume:.2,frequencyEnvelope:[{time:0,frequency:150},{time:.25,frequency:200},{time:.5,frequency:150},{time:.75,frequency:200},{time:1,frequency:150}],volumeEnvelope:[{time:0,volume:.8},{time:.5,volume:1},{time:1,volume:0}]}],["spin",{duration:600,waveform:"triangle",volume:.35,frequencyEnvelope:[{time:0,frequency:220},{time:.3,frequency:440},{time:.7,frequency:660},{time:1,frequency:330}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["nod",{duration:150,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:180},{time:.5,frequency:220},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:1,volume:0}]}],["tilt",{duration:200,waveform:"triangle",volume:.18,frequencyEnvelope:[{time:0,frequency:250},{time:.6,frequency:350},{time:1,frequency:280}],volumeEnvelope:[{time:0,volume:0},{time:.4,volume:1},{time:1,volume:0}]}],["expand",{duration:500,waveform:"sine",volume:.4,frequencyEnvelope:[{time:0,frequency:200},{time:.7,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.9,volume:.8},{time:1,volume:0}]}],["contract",{duration:400,waveform:"triangle",volume:.22,frequencyEnvelope:[{time:0,frequency:400},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:1},{time:.6,volume:.8},{time:1,volume:0}]}],["flash",{duration:200,waveform:"square",volume:.3,frequencyEnvelope:[{time:0,frequency:800},{time:.1,frequency:1200},{time:.2,frequency:800},{time:1,frequency:600}],volumeEnvelope:[{time:0,volume:0},{time:.05,volume:1},{time:.15,volume:.3},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.6,frequency:400},{time:1,frequency:350}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.7,volume:.6},{time:1,volume:0}]}],["breathe",{duration:800,waveform:"triangle",volume:.6,frequencyEnvelope:[{time:0,frequency:300},{time:.3,frequency:500},{time:.5,frequency:600},{time:.7,frequency:400},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.2},{time:.2,volume:1},{time:.5,volume:.9},{time:.8,volume:.7},{time:1,volume:0}]}],["morph",{duration:600,waveform:"triangle",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.2,frequency:300},{time:.5,frequency:600},{time:.8,frequency:400},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:.5},{time:.3,volume:1},{time:.7,volume:.8},{time:1,volume:0}]}],["jump",{duration:250,waveform:"square",volume:.35,frequencyEnvelope:[{time:0,frequency:200},{time:.2,frequency:600},{time:.4,frequency:800},{time:.8,frequency:400},{time:1,frequency:100}],volumeEnvelope:[{time:0,volume:.8},{time:.1,volume:1},{time:.3,volume:.6},{time:1,volume:0}]}],["drift",{duration:800,waveform:"sine",volume:.12,frequencyEnvelope:[{time:0,frequency:160},{time:.4,frequency:240},{time:.8,frequency:200},{time:1,frequency:180}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:1},{time:.8,volume:.8},{time:1,volume:0}]}],["wave",{duration:400,waveform:"sine",volume:.25,frequencyEnvelope:[{time:0,frequency:200},{time:.25,frequency:300},{time:.5,frequency:250},{time:.75,frequency:280},{time:1,frequency:200}],volumeEnvelope:[{time:0,volume:0},{time:.2,volume:.8},{time:.8,volume:.8},{time:1,volume:0}]}],["breathe",{duration:3500,waveform:"sine",volume:.2,frequencyEnvelope:[{time:0,frequency:80},{time:.4,frequency:150},{time:.5,frequency:160},{time:.9,frequency:100},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:.3},{time:.4,volume:.8},{time:.5,volume:.7},{time:.9,volume:.6},{time:1,volume:.2}]}],["flicker",{duration:300,waveform:"square",volume:.2,frequencyEnvelope:[{time:0,frequency:600},{time:.1,frequency:400},{time:.2,frequency:800},{time:.3,frequency:300},{time:.5,frequency:700},{time:1,frequency:500}],volumeEnvelope:[{time:0,volume:1},{time:.1,volume:.2},{time:.2,volume:.9},{time:.3,volume:.3},{time:.5,volume:.8},{time:1,volume:0}]}],["vibrate",{duration:250,waveform:"sawtooth",volume:.3,frequencyEnvelope:[{time:0,frequency:100},{time:.1,frequency:150},{time:.2,frequency:100},{time:.3,frequency:150},{time:.4,frequency:100},{time:.5,frequency:150},{time:.6,frequency:100},{time:.7,frequency:150},{time:1,frequency:80}],volumeEnvelope:[{time:0,volume:1},{time:.8,volume:1},{time:1,volume:0}]}],["glow",{duration:600,waveform:"sine",volume:.15,frequencyEnvelope:[{time:0,frequency:300},{time:.5,frequency:500},{time:1,frequency:400}],volumeEnvelope:[{time:0,volume:0},{time:.3,volume:1},{time:.7,volume:1},{time:1,volume:0}]}],["stretch",{duration:450,waveform:"triangle",volume:.2,frequencyEnvelope:[{time:0,frequency:250},{time:.3,frequency:180},{time:.7,frequency:320},{time:1,frequency:250}],volumeEnvelope:[{time:0,volume:.6},{time:.2,volume:1},{time:.8,volume:.9},{time:1,volume:0}]}]]).get(t)||null}applyFrequencyEnvelope(t,i,e,s){i.forEach(i=>{const n=e+i.time*s;t.frequency.linearRampToValueAtTime(i.frequency,n)})}applyVolumeEnvelope(t,i,e,s,n){i.forEach((i,h)=>{const a=e+i.time*s,r=i.volume*n;0===h?t.gain.setValueAtTime(r,a):t.gain.linearRampToValueAtTime(r,a)})}getEmotionalModifiers(t){const i=new Map([["neutral",{intensity:1,speed:1}],["joy",{intensity:1.3,speed:1.2}],["sadness",{intensity:.6,speed:.8}],["anger",{intensity:1.5,speed:1.4}],["fear",{intensity:.8,speed:1.3}],["surprise",{intensity:1.4,speed:1.5}],["disgust",{intensity:.7,speed:.9}],["love",{intensity:1.1,speed:.9}]]);return i.get(t)||i.get("neutral")}setQualityReduction(t){this.qualityReduction=t,t&&this.audioContext?this.maxOscillators=2:this.maxOscillators=4}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}throttledWarn(t,i){const e=Date.now();e-(this.warningTimestamps[i]||0)>this.warningThrottle&&(this.warningTimestamps[i]=e)}}class Qi{constructor(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.smoothingFactor=.9,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.maxFrameTimeSamples=10,this.averageFrameTime=0}update(t){for(;this.timestamps.length>0&&this.timestamps[0]<=t-1e3;)this.timestamps.shift();if(this.timestamps.push(t),this.fps=this.timestamps.length,0===this.smoothedFPS?this.smoothedFPS=this.fps:this.smoothedFPS=this.smoothedFPS*this.smoothingFactor+this.fps*(1-this.smoothingFactor),this.lastFrameTime>0&&(this.frameTime=t-this.lastFrameTime,this.frameTimes.push(this.frameTime),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift(),this.frameTimes.length>0)){const t=this.frameTimes.reduce((t,i)=>t+i,0);this.averageFrameTime=t/this.frameTimes.length}this.lastFrameTime=t}getFPS(){return Math.round(this.fps)}getSmoothedFPS(){return Math.round(this.smoothedFPS)}getFrameTime(){return this.frameTime}getAverageFrameTime(){return this.averageFrameTime}reset(){this.timestamps=[],this.fps=0,this.smoothedFPS=0,this.lastFrameTime=0,this.frameTime=0,this.frameTimes=[],this.averageFrameTime=0}getMetrics(){return{fps:this.getFPS(),smoothedFPS:this.getSmoothedFPS(),frameTime:this.getFrameTime(),averageFrameTime:this.getAverageFrameTime(),status:this.fps>=55?"good":this.fps>=30?"okay":"poor"}}}class Ji{constructor(t,i={}){this.errorBoundary=t,this.config=i,this.config.targetFPS=i.targetFPS||60,this.isRunning=!1,this.animationFrameId=null,this.loopCallbackId=null,this.lastFrameTime=0,this.deltaTime=0,this.isPaused=!1,this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleWindowBlur=this.handleWindowBlur.bind(this),this.handleWindowFocus=this.handleWindowFocus.bind(this),"undefined"!=typeof document&&(document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("blur",this.handleWindowBlur),window.addEventListener("focus",this.handleWindowFocus)),this.performanceMonitor=null,this.fpsCounter=new Qi,this.subsystems={},this.eventCallback=null,this.parentMascot=null}setSubsystems(t){this.subsystems={stateMachine:t.stateMachine,particleSystem:t.particleSystem,renderer:t.renderer,soundSystem:t.soundSystem,canvasManager:t.canvasManager};const i=["stateMachine","particleSystem","renderer"];for(const t of i)if(!this.subsystems[t])throw new Error(`Required subsystem '${t}' not provided`);this.performanceMonitor&&this.performanceMonitor.setSubsystems(this.subsystems)}setEventCallback(t){if("function"!=typeof t)throw new Error("Event callback must be a function");this.eventCallback=t}setParentMascot(t){this.parentMascot=t}emit(t,i=null){this.eventCallback&&this.eventCallback(t,i)}start(){return this.errorBoundary.wrap(()=>{if(this.isRunning)return!1;if(!this.subsystems.stateMachine)throw new Error("Cannot start animation without subsystems configured");return this.isRunning=!0,this.lastFrameTime=performance.now(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.resumeContext(),this.loopCallbackId=Hi.register((t,i)=>this.animate(t,i),0,this),this.emit("animationStarted",{targetFPS:this.targetFPS}),!0},"animation-start")()}stop(){return this.errorBoundary.wrap(()=>!!this.isRunning&&(this.isRunning=!1,this.loopCallbackId&&(Hi.unregister(this.loopCallbackId),this.loopCallbackId=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.subsystems.renderer&&this.subsystems.renderer.stopAllGestures&&this.subsystems.renderer.stopAllGestures(),this.subsystems.soundSystem&&this.subsystems.soundSystem.isAvailable()&&this.subsystems.soundSystem.stopAmbientTone(),this.subsystems.particleSystem&&this.subsystems.particleSystem.clear(),this.emit("animationStopped"),!0),"animation-stop")()}handleWindowBlur(){document.hidden||this.handleVisibilityChange()}handleWindowFocus(){!document.hidden&&this.isPaused&&this.handleVisibilityChange()}handleVisibilityChange(){if(document.hidden)this.wasRunning=this.isRunning,this.isPaused=!0,this.pauseTime=performance.now(),this.subsystems?.particleSystem&&(this.subsystems.particleSystem.resetAccumulator(),this.pausedParticleCount=this.subsystems.particleSystem.particles?.length||0),this.subsystems?.renderer?.gestureAnimator&&this.subsystems.renderer.gestureAnimator.pauseCurrentAnimation?.(),this.parentMascot?.pause&&this.parentMascot.pause();else if(this.isPaused&&this.wasRunning){const t=performance.now(),i=t-this.pauseTime;if(this.lastFrameTime=t,this.frameTimeAccumulator=0,this.fpsCounter&&this.fpsCounter.reset(),this.subsystems?.particleSystem)if(this.subsystems.particleSystem.resetAccumulator(),i>3e4)this.subsystems.particleSystem.particles=[];else if(i>1e4){const t=Math.max(10,Math.floor(.5*this.pausedParticleCount));for(;this.subsystems.particleSystem.particles.length>t;)this.subsystems.particleSystem.removeParticle(0)}this.renderer&&(i>3e4&&this.renderer.resetCanvasContext(),this.renderer.gestureAnimator&&this.renderer.gestureAnimator.resumeAnimation?.(),i>3e4&&(this.renderer.forceCleanRender=!0)),this.subsystems?.stateMachine&&(this.subsystems.stateMachine.lastUpdateTime=t),this.parentMascot?.resume&&this.parentMascot.resume(),this.isPaused=!1,this.performanceMonitor}}animate(t,i){if(!this.isRunning||this.isPaused)return;const e=i||performance.now();this.deltaTime=t||e-this.lastFrameTime,this.deltaTime>20&&(this.deltaTime=20),this.deltaTime>16.67&&this.deltaTime<20&&(this.deltaTime=16.67),this.lastFrameTime=e,this.update(this.deltaTime),this.render()}update(t){if(this.subsystems.stateMachine&&this.subsystems.stateMachine.update(t),this.parentMascot&&"function"==typeof this.parentMascot.update&&this.parentMascot.update(t),"classic"!==this.parentMascot?.config?.renderingStyle&&this.subsystems.particleSystem&&this.subsystems.stateMachine&&this.subsystems.canvasManager){const i=this.subsystems.stateMachine.getCurrentEmotionalProperties(),e=this.subsystems.canvasManager.getCenter();let s=null,n=0;if(this.subsystems.renderer&&this.subsystems.renderer.getCurrentGesture){const t=this.subsystems.renderer.getCurrentGesture();t&&t.particleMotion&&(s=t.particleMotion,n=t.progress||0)}this.subsystems.particleSystem.spawn(i.particleBehavior,this.subsystems.stateMachine.getCurrentState().emotion,i.particleRate,e.x,e.y,t),this.subsystems.particleSystem.update(t,e.x,e.y,s,n)}this.performanceMonitor&&this.performanceMonitor.updateMetrics({particleCount:this.subsystems.particleSystem?.getActiveParticleCount?.()||0,audioLatency:this.subsystems.soundSystem?.getLatency?.()||0})}render(){this.parentMascot&&"function"==typeof this.parentMascot.render?this.parentMascot.render():this.subsystems.renderer&&this.subsystems.renderer.render()}getPerformanceMetrics(){const t=this.fpsCounter?this.fpsCounter.getMetrics():{};return{fps:t.fps||60,instantFps:t.smoothedFPS||60,frameTime:t.frameTime||16.67,averageFrameTime:t.averageFrameTime||16.67,isRunning:this.isRunning,deltaTime:this.deltaTime}}setTargetFPS(t){}get targetFPS(){return this.config.targetFPS||60}isAnimating(){return this.isRunning}destroy(){this.stop(),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("blur",this.handleWindowBlur),window.removeEventListener("focus",this.handleWindowFocus)),this.performanceMonitor&&(this.performanceMonitor.destroy(),this.performanceMonitor=null),this.subsystems={},this.eventCallback=null}}class Zi{constructor(t={}){this.config={spikeThreshold:t.spikeThreshold||1.5,minimumSpikeLevel:t.minimumSpikeLevel||.1,spikeMinInterval:t.spikeMinInterval||1e3,historySize:t.historySize||10,smoothingTimeConstant:t.smoothingTimeConstant||.8,fftSize:t.fftSize||256,levelUpdateThrottle:t.levelUpdateThrottle||100,...t},this.audioContext=null,this.analyser=null,this.dataArray=null,this.currentLevel=0,this.levelHistory=[],this.isActive=!1,this.lastVolumeSpike=0,this.lastLevelEmit=0,this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}initialize(t){try{if(!t)throw new Error("AudioContext is required for audio level processing");if("function"!=typeof t.createAnalyser)throw new Error("Invalid AudioContext provided");return this.audioContext=t,this.analyser=t.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.isActive=!0,"suspended"===t.state&&t.resume().catch(t=>{this.emitError("Failed to resume AudioContext",t)}),!0}catch(t){return this.emitError("Failed to initialize AudioLevelProcessor",t),!1}}cleanup(){try{this.isActive=!1,this.currentLevel=0,this.levelHistory=[],this.lastVolumeSpike=0,this.lastLevelEmit=0,this.audioContext=null,this.analyser=null,this.dataArray=null}catch(t){this.emitError("Error during AudioLevelProcessor cleanup",t)}}updateAudioLevel(t=16){if(this.isActive&&this.analyser&&this.dataArray)try{this.analyser.getByteFrequencyData(this.dataArray);const t=this.calculateRMS();this.currentLevel=Math.min(1,2*t),this.updateLevelHistory(),this.detectVolumeSpikes(),this.emitLevelUpdate()}catch(t){this.emitError("Error updating audio level",t),this.currentLevel=0}}calculateRMS(){if(!this.dataArray||0===this.dataArray.length)return 0;let t=0;for(let i=0;i<this.dataArray.length;i++){const e=this.dataArray[i]/255;t+=e*e}return Math.sqrt(t/this.dataArray.length)}updateLevelHistory(){this.levelHistory.push(this.currentLevel),this.levelHistory.length>this.config.historySize&&this.levelHistory.shift()}detectVolumeSpikes(){if(this.levelHistory.length<5)return;const t=performance.now();if(t-this.lastVolumeSpike<this.config.spikeMinInterval)return;const i=this.levelHistory.slice(0,-1),e=i.reduce((t,i)=>t+i,0)/i.length;this.currentLevel>=e*this.config.spikeThreshold&&e>=this.config.minimumSpikeLevel&&this.currentLevel>=2*this.config.minimumSpikeLevel&&(this.lastVolumeSpike=t,this.emitVolumeSpike({level:this.currentLevel,previousAverage:e,spikeRatio:this.currentLevel/e,timestamp:t,threshold:this.config.spikeThreshold,minimumLevel:this.config.minimumSpikeLevel}))}clearHistory(){this.levelHistory=[]}getCurrentLevel(){return this.currentLevel}getLevelHistory(){return[...this.levelHistory]}getAnalyser(){return this.analyser}getFrequencyData(){return this.dataArray?new Uint8Array(this.dataArray):null}isProcessingActive(){return this.isActive}onLevelUpdate(t){if("function"!=typeof t)throw new Error("Level update callback must be a function");this.callbacks.levelUpdate=t}onVolumeSpike(t){if("function"!=typeof t)throw new Error("Volume spike callback must be a function");this.callbacks.volumeSpike=t}onError(t){if("function"!=typeof t)throw new Error("Error callback must be a function");this.callbacks.error=t}removeAllCallbacks(){this.callbacks={levelUpdate:null,volumeSpike:null,error:null}}updateConfig(t){this.config={...this.config,...t},this.analyser&&(t.fftSize&&(this.analyser.fftSize=this.config.fftSize,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount)),void 0!==t.smoothingTimeConstant&&(this.analyser.smoothingTimeConstant=this.config.smoothingTimeConstant))}getConfig(){return{...this.config}}getStats(){return{isActive:this.isActive,currentLevel:this.currentLevel,historySize:this.levelHistory.length,maxHistorySize:this.config.historySize,lastSpikeTime:this.lastVolumeSpike,timeSinceLastSpike:this.lastVolumeSpike>0?performance.now()-this.lastVolumeSpike:0,averageLevel:this.levelHistory.length>0?this.levelHistory.reduce((t,i)=>t+i,0)/this.levelHistory.length:0}}emitLevelUpdate(){const t=performance.now();if(!(t-this.lastLevelEmit<this.config.levelUpdateThrottle)&&(this.lastLevelEmit=t,this.callbacks.levelUpdate))try{this.callbacks.levelUpdate({level:this.currentLevel,rawData:this.getFrequencyData(),timestamp:t,history:this.getLevelHistory()})}catch(t){}}emitVolumeSpike(t){if(this.callbacks.volumeSpike)try{this.callbacks.volumeSpike(t)}catch(t){}}emitError(t,i){if(this.callbacks.error)try{this.callbacks.error({message:t,error:i,timestamp:performance.now()})}catch(t){}}static isSupported(){return!(!window.AudioContext&&!window.webkitAudioContext)}}class Ki{constructor(){this.listeners=new Map,this.groups=new Map,this.stats={registered:0,removed:0,active:0}}addEventListener(t,i,e,s={},n="default"){const h=this.generateId(),a={id:h,target:t,eventType:i,handler:e,options:s,group:n,active:!0};return this.listeners.set(h,a),this.groups.has(n)||this.groups.set(n,new Set),this.groups.get(n).add(h),t.addEventListener(i,e,s),this.stats.registered++,this.stats.active++,h}removeEventListener(t){const i=this.listeners.get(t);if(!i||!i.active)return!1;i.target.removeEventListener(i.eventType,i.handler,i.options),i.active=!1;const e=this.groups.get(i.group);return e&&(e.delete(t),0===e.size&&this.groups.delete(i.group)),this.listeners.delete(t),this.stats.removed++,this.stats.active--,!0}removeGroup(t){const i=this.groups.get(t);if(!i)return 0;let e=0;for(const t of i)this.removeEventListener(t)&&e++;return e}removeAllForTarget(t){let i=0;for(const[e,s]of this.listeners.entries())s.target===t&&s.active&&this.removeEventListener(e)&&i++;return i}removeAllOfType(t){let i=0;for(const[e,s]of this.listeners.entries())s.eventType===t&&s.active&&this.removeEventListener(e)&&i++;return i}removeAll(){let t=0;for(const[i,e]of this.listeners.entries())e.active&&this.removeEventListener(i)&&t++;return t}createAutoRemove(t,i,e,s={}){const n=this.addEventListener(t,i,e,s);return{id:n,remove:()=>this.removeEventListener(n)}}once(t,i,e,s={}){const n=this.addEventListener(t,i,t=>{e(t),this.removeEventListener(n)},s);return n}debounced(t,i,e,s=250,n={}){let h;return this.addEventListener(t,i,t=>{clearTimeout(h),h=setTimeout(()=>e(t),s)},n)}throttled(t,i,e,s=100,n={}){let h=!1;return this.addEventListener(t,i,t=>{h||(e(t),h=!0,setTimeout(()=>{h=!1},s))},n)}generateId(){return`listener_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getStats(){return{...this.stats,groups:this.groups.size,listeners:this.listeners.size}}getActiveListeners(){const t=[];for(const[i,e]of this.listeners.entries())e.active&&t.push({id:i,eventType:e.eventType,group:e.group,target:e.target.constructor.name});return t}analyzeLeaks(){const t={totalListeners:this.listeners.size,activeListeners:this.stats.active,inactiveButNotRemoved:0,byTarget:new Map,byType:new Map,potentialLeaks:[]};for(const[i,e]of this.listeners.entries()){const s=e.target.constructor.name;t.byTarget.set(s,(t.byTarget.get(s)||0)+1),t.byType.set(e.eventType,(t.byType.get(e.eventType)||0)+1),e.active||(t.inactiveButNotRemoved++,t.potentialLeaks.push({id:i,eventType:e.eventType,target:s}))}return t.byTarget=Object.fromEntries(t.byTarget),t.byType=Object.fromEntries(t.byType),t}cleanup(){let t=0;for(const[i,e]of this.listeners.entries())e.active||(this.listeners.delete(i),t++);return t}}class te{constructor(t={}){this.config={enableReducedMotion:!1!==t.enableReducedMotion,enableHighContrast:!1!==t.enableHighContrast,enableScreenReaderSupport:!1!==t.enableScreenReaderSupport,enableKeyboardNavigation:!1!==t.enableKeyboardNavigation,enableFocusIndicators:!1!==t.enableFocusIndicators,announceStateChanges:!1!==t.announceStateChanges,colorBlindMode:t.colorBlindMode||"none",...t},this.reducedMotionPreferred=!1,this.highContrastEnabled=!1,this.screenReaderActive=!1,this.keyboardNavigationActive=!1,this.currentColorBlindMode=this.config.colorBlindMode,this.focusableElements=new Map,this.currentFocusIndex=-1,this.focusHistory=[],this.liveRegion=null,this.announcementQueue=[],this.colorSchemes={normal:null,highContrast:{primary:"#FFFFFF",secondary:"#000000",accent:"#FFFF00",background:"#000000",particles:"#FFFFFF"},protanopia:{primary:"#0066CC",secondary:"#FFCC00",accent:"#00CCFF",background:"#1A1A1A",particles:"#66CCFF"},deuteranopia:{primary:"#0099FF",secondary:"#FF9900",accent:"#FF00FF",background:"#1A1A1A",particles:"#9966FF"},tritanopia:{primary:"#FF0066",secondary:"#00FF66",accent:"#FF6600",background:"#1A1A1A",particles:"#FFCC00"}},this.patterns={dots:"dots",stripes:"stripes",crosshatch:"crosshatch",solid:"solid"},this.statePatterns={idle:this.patterns.solid,happy:this.patterns.dots,excited:this.patterns.stripes,calm:this.patterns.solid,curious:this.patterns.crosshatch,frustrated:this.patterns.stripes,sad:this.patterns.dots,neutral:this.patterns.solid},this.initialize()}initialize(){this.detectUserPreferences(),this.setupLiveRegion(),this.config.enableKeyboardNavigation&&this.setupKeyboardNavigation(),this.setupPreferenceListeners()}detectUserPreferences(){if(this.config.enableReducedMotion&&window.matchMedia){const t=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreferred=t.matches}if(this.config.enableHighContrast&&window.matchMedia){const t=window.matchMedia("(prefers-contrast: high)");if(this.highContrastEnabled=t.matches,!this.highContrastEnabled){const t=window.matchMedia("(-ms-high-contrast: active)");this.highContrastEnabled=t.matches}}this.detectScreenReader()}detectScreenReader(){const t=document.querySelector("[aria-live]"),i=document.querySelector("[aria-atomic]"),e=document.querySelector('[role="application"]'),s=navigator.userAgent.toLowerCase(),n=s.includes("nvda")||s.includes("jaws")||s.includes("voiceover");this.screenReaderActive=!!(t||i||e||n)}setupLiveRegion(){this.config.enableScreenReaderSupport&&(this.liveRegion=document.getElementById("mascot-announcements"),this.liveRegion||(this.liveRegion=document.createElement("div"),this.liveRegion.id="mascot-announcements",this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.style.position="absolute",this.liveRegion.style.left="-10000px",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.overflow="hidden",document.body.appendChild(this.liveRegion)))}setupKeyboardNavigation(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}setupPreferenceListeners(){window.matchMedia&&(window.matchMedia("(prefers-reduced-motion: reduce)").addListener(t=>{this.reducedMotionPreferred=t.matches,this.onPreferenceChange("reducedMotion",t.matches)}),window.matchMedia("(prefers-contrast: high)").addListener(t=>{this.highContrastEnabled=t.matches,this.onPreferenceChange("highContrast",t.matches)}))}handleKeyDown(t){if(this.config.enableKeyboardNavigation){switch(t.key){case"Tab":t.preventDefault(),this.navigateFocus(t.shiftKey?-1:1);break;case"Enter":case" ":this.activateCurrentFocus();break;case"Escape":this.clearFocus();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":this.handleArrowNavigation(t.key)}this.keyboardNavigationActive=!0}}handleKeyUp(t){}navigateFocus(t){const i=Array.from(this.focusableElements.values());if(0===i.length)return;this.currentFocusIndex+=t,this.currentFocusIndex<0?this.currentFocusIndex=i.length-1:this.currentFocusIndex>=i.length&&(this.currentFocusIndex=0);const e=i[this.currentFocusIndex];this.setFocus(e),e.label&&this.announce(`Focused on ${e.label}`)}handleArrowNavigation(t){const i={ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1}}[t];i&&this.onArrowNavigation&&this.onArrowNavigation(i)}registerFocusableElement(t,i){this.focusableElements.set(t,{id:t,label:i.label||t,bounds:i.bounds||null,action:i.action||null,type:i.type||"button"})}unregisterFocusableElement(t){this.focusableElements.delete(t)}setFocus(t){this.onFocusChange&&this.onFocusChange(t),this.focusHistory.push(t.id),this.focusHistory.length>10&&this.focusHistory.shift()}clearFocus(){this.currentFocusIndex=-1,this.onFocusChange&&this.onFocusChange(null),this.announce("Focus cleared")}activateCurrentFocus(){const t=Array.from(this.focusableElements.values());if(this.currentFocusIndex>=0&&this.currentFocusIndex<t.length){const i=t[this.currentFocusIndex];i.action&&(i.action(),this.announce(`Activated ${i.label}`))}}announce(t,i="polite"){this.config.enableScreenReaderSupport&&this.liveRegion&&(this.announcementQueue.push({message:t,priority:i}),this.processAnnouncementQueue())}processAnnouncementQueue(){if(0===this.announcementQueue.length)return;const{message:t,priority:i}=this.announcementQueue.shift();this.liveRegion.setAttribute("aria-live",i),this.liveRegion.textContent=t,setTimeout(()=>{this.liveRegion&&(this.liveRegion.textContent=""),this.announcementQueue.length>0&&this.processAnnouncementQueue()},100)}getAnimationSettings(t={}){return this.reducedMotionPreferred?{...t,duration:t.duration?.5*t.duration:0,iterations:1,easing:"linear",particlesEnabled:!1,complexAnimations:!1,autoPlay:!1}:t}getColorScheme(t={}){return this.colorSchemes.normal||(this.colorSchemes.normal={...t}),this.highContrastEnabled?this.colorSchemes.highContrast:"none"!==this.currentColorBlindMode&&this.colorSchemes[this.currentColorBlindMode]?this.colorSchemes[this.currentColorBlindMode]:t}getStatePattern(t){return"none"===this.currentColorBlindMode?this.patterns.solid:this.statePatterns[t]||this.patterns.solid}applyPatternOverlay(t,i,e){if(i===this.patterns.solid)return;t.save();const s=document.createElement("canvas"),n=s.getContext("2d");switch(i){case this.patterns.dots:this.createDotPattern(n,s);break;case this.patterns.stripes:this.createStripePattern(n,s);break;case this.patterns.crosshatch:this.createCrosshatchPattern(n,s)}const h=t.createPattern(s,"repeat");t.fillStyle=h,t.globalAlpha=.3,t.fillRect(e.x,e.y,e.width,e.height),t.restore()}createDotPattern(t,i){i.width=10,i.height=10,t.fillStyle="white",t.beginPath(),t.arc(5,5,2,0,2*Math.PI),t.fill()}createStripePattern(t,i){i.width=10,i.height=10,t.strokeStyle="white",t.lineWidth=2,t.beginPath(),t.moveTo(0,10),t.lineTo(10,0),t.stroke()}createCrosshatchPattern(t,i){i.width=10,i.height=10,t.strokeStyle="white",t.lineWidth=1,t.beginPath(),t.moveTo(0,10),t.lineTo(10,0),t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(10,10),t.stroke()}setColorBlindMode(t){["none","protanopia","deuteranopia","tritanopia"].includes(t)&&(this.currentColorBlindMode=t,this.announce(`Color blind mode set to ${t}`),this.onColorSchemeChange&&this.onColorSchemeChange(this.getColorScheme()))}getStatus(){return{reducedMotion:this.reducedMotionPreferred,highContrast:this.highContrastEnabled,screenReader:this.screenReaderActive,keyboardNavigation:this.keyboardNavigationActive,colorBlindMode:this.currentColorBlindMode,focusedElement:this.currentFocusIndex>=0?Array.from(this.focusableElements.values())[this.currentFocusIndex]:null,registeredElements:this.focusableElements.size}}onPreferenceChange(t,i){this.announce(`${t} is now ${i?"enabled":"disabled"}`),"reducedMotion"===t&&this.onReducedMotionChange&&this.onReducedMotionChange(i),"highContrast"===t&&this.onHighContrastChange&&this.onHighContrastChange(i)}createStateDescription(t){return{idle:"Mascot is idle and gently breathing",happy:"Mascot is happy and bouncing",excited:"Mascot is excited with particles flying",calm:"Mascot is calm and peaceful",curious:"Mascot is curious and looking around",frustrated:"Mascot is frustrated and shaking",sad:"Mascot is sad and drooping",neutral:"Mascot is in a neutral state"}[t.emotional]||"Mascot is active"}destroy(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.liveRegion&&this.liveRegion.parentNode&&this.liveRegion.parentNode.removeChild(this.liveRegion),this.focusableElements.clear(),this.announcementQueue=[],this.focusHistory=[]}}class ie{constructor(t={}){this.config={enableTouchOptimization:!1!==t.enableTouchOptimization,enableViewportHandling:!1!==t.enableViewportHandling,enableBatteryOptimization:!1!==t.enableBatteryOptimization,enableOrientationSupport:!1!==t.enableOrientationSupport,enableResponsiveScaling:!1!==t.enableResponsiveScaling,touchSensitivity:t.touchSensitivity||1,doubleTapDelay:t.doubleTapDelay||300,swipeThreshold:t.swipeThreshold||50,pinchThreshold:t.pinchThreshold||.1,...t},this.isMobile=this.detectMobile(),this.isTablet=this.detectTablet(),this.isTouchDevice=this.detectTouch(),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.isAndroid=/Android/.test(navigator.userAgent),this.touches=new Map,this.lastTouchTime=0,this.lastTapTime=0,this.tapCount=0,this.touchStartPosition=null,this.isPinching=!1,this.isRotating=!1,this.lastPinchDistance=0,this.lastRotation=0,this.currentGesture=null,this.gestureStartTime=0,this.gestureHistory=[],this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.orientation=this.getOrientation(),this.pixelRatio=window.devicePixelRatio||1,this.lastViewportChange=0,this.batteryLevel=1,this.isCharging=!0,this.lowPowerMode=!1,this.mobilePerformanceSettings={reducedParticles:this.isMobile,simplifiedAnimations:this.isMobile,lowerFrameRate:this.isMobile,reducedEffects:this.isMobile||this.isTablet,targetFPS:this.isMobile?30:60,maxParticles:this.isMobile?20:50},this.canvasScale=1,this.useOffscreenCanvas=this.supportsOffscreenCanvas(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this),this.handleOrientationChange=this.handleOrientationChange.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.initialize()}initialize(){this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers(),this.config.enableViewportHandling&&this.setupViewportHandlers(),this.config.enableBatteryOptimization&&this.setupBatteryMonitoring(),this.config.enableOrientationSupport&&this.setupOrientationHandlers(),this.applyMobileOptimizations()}detectMobile(){const t=navigator.userAgent.toLowerCase(),i=["android","iphone","ipod","windows phone","blackberry"].some(i=>t.includes(i)),e=window.innerWidth<=768,s="ontouchstart"in window||navigator.maxTouchPoints>0;return i||e&&s}detectTablet(){const t=navigator.userAgent.toLowerCase(),i=/ipad/.test(t),e=/android/.test(t)&&!/mobile/.test(t),s=/windows/.test(t)&&/touch/.test(t),n=window.innerWidth>768&&window.innerWidth<=1024,h="ontouchstart"in window||navigator.maxTouchPoints>0;return i||e||s||n&&h}detectTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}setupTouchHandlers(){const t=this.getCanvas();t&&(t.style.touchAction="none",t.style.userSelect="none",t.style.webkitUserSelect="none",t.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),t.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),t.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),t.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1}),t.addEventListener("contextmenu",t=>t.preventDefault()))}setupViewportHandlers(){window.addEventListener("resize",this.handleViewportChange),window.addEventListener("orientationchange",this.handleOrientationChange),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.setupViewportMeta()}setupViewportMeta(){let t=document.querySelector('meta[name="viewport"]');t||(t=document.createElement("meta"),t.name="viewport",document.head.appendChild(t)),t.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"}async setupBatteryMonitoring(){if(navigator.getBattery)try{const t=await navigator.getBattery();this.batteryLevel=t.level,this.isCharging=t.charging,t.addEventListener("levelchange",()=>{this.batteryLevel=t.level,this.onBatteryChange()}),t.addEventListener("chargingchange",()=>{this.isCharging=t.charging,this.onBatteryChange()}),this.onBatteryChange()}catch(t){}}setupOrientationHandlers(){window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",t=>{this.handleDeviceOrientation(t)})}handleTouchStart(t){t.preventDefault();const i=Date.now();this.gestureStartTime=i;for(const e of t.touches)this.touches.set(e.identifier,{id:e.identifier,startX:e.clientX,startY:e.clientY,currentX:e.clientX,currentY:e.clientY,startTime:i});1===t.touches.length?this.handleSingleTouchStart(t.touches[0]):2===t.touches.length&&this.handleMultiTouchStart(t.touches),this.emitTouchEvent("touchStart",{touches:Array.from(this.touches.values()),timestamp:i})}handleSingleTouchStart(t){const i=Date.now();i-this.lastTapTime<this.config.doubleTapDelay?this.tapCount++:this.tapCount=1,this.lastTapTime=i,this.touchStartPosition={x:t.clientX,y:t.clientY}}handleMultiTouchStart(t){if(2===t.length){const i=t[0],e=t[1];this.lastPinchDistance=this.getDistance(i.clientX,i.clientY,e.clientX,e.clientY),this.lastRotation=this.getAngle(i.clientX,i.clientY,e.clientX,e.clientY),this.isPinching=!0}}handleTouchMove(t){t.preventDefault();for(const i of t.touches){const t=this.touches.get(i.identifier);t&&(t.currentX=i.clientX,t.currentY=i.clientY)}1===t.touches.length?this.handleSingleTouchMove(t.touches[0]):2===t.touches.length&&this.handleMultiTouchMove(t.touches),this.emitTouchEvent("touchMove",{touches:Array.from(this.touches.values()),gesture:this.currentGesture})}handleSingleTouchMove(t){const i=this.touches.get(t.identifier);if(!i)return;const e=t.clientX-i.startX,s=t.clientY-i.startY;Math.sqrt(e*e+s*s)>this.config.swipeThreshold?Math.abs(e)>Math.abs(s)?this.currentGesture=e>0?"swipeRight":"swipeLeft":this.currentGesture=s>0?"swipeDown":"swipeUp":this.currentGesture="pan"}handleMultiTouchMove(t){if(2!==t.length)return;const i=t[0],e=t[1],s=this.getDistance(i.clientX,i.clientY,e.clientX,e.clientY),n=s-this.lastPinchDistance,h=s/this.lastPinchDistance;Math.abs(n)>this.config.pinchThreshold&&(this.currentGesture=h>1?"pinchOut":"pinchIn",this.emitTouchEvent("pinch",{scale:h,delta:n}));const a=this.getAngle(i.clientX,i.clientY,e.clientX,e.clientY),r=a-this.lastRotation;Math.abs(r)>5&&(this.currentGesture="rotate",this.emitTouchEvent("rotate",{angle:a,delta:r})),this.lastPinchDistance=s,this.lastRotation=a}handleTouchEnd(t){t.preventDefault();const i=Date.now();for(const e of t.changedTouches){const t=this.touches.get(e.identifier);if(t){const s=i-t.startTime,n=t.currentX-t.startX,h=t.currentY-t.startY,a=Math.sqrt(n*n+h*h);s<300&&a<10&&(2===this.tapCount?(this.emitTouchEvent("doubleTap",{x:t.currentX,y:t.currentY}),this.tapCount=0):this.emitTouchEvent("tap",{x:t.currentX,y:t.currentY})),s>500&&a<10&&this.emitTouchEvent("longPress",{x:t.currentX,y:t.currentY}),this.touches.delete(e.identifier)}}0===t.touches.length&&(this.currentGesture=null,this.isPinching=!1,this.isRotating=!1),this.emitTouchEvent("touchEnd",{gesture:this.currentGesture,duration:i-this.gestureStartTime})}handleTouchCancel(t){this.touches.clear(),this.currentGesture=null,this.isPinching=!1,this.isRotating=!1,this.emitTouchEvent("touchCancel",{})}handleOrientationChange(t){this.orientation=this.getOrientation(),this.emitTouchEvent("orientationChange",{orientation:this.orientation,angle:window.orientation||0}),this.applyOrientationOptimizations()}handleDeviceOrientation(t){const{alpha:i,beta:e,gamma:s}=t;this.emitTouchEvent("deviceOrientation",{alpha:i,beta:e,gamma:s})}handleViewportChange(t){const i=Date.now();i-this.lastViewportChange<100||(this.lastViewportChange=i,this.viewportSize={width:window.innerWidth,height:window.innerHeight},this.pixelRatio=window.devicePixelRatio||1,this.emitTouchEvent("viewportChange",{size:this.viewportSize,pixelRatio:this.pixelRatio,orientation:this.getOrientation()}),this.config.enableResponsiveScaling&&this.applyResponsiveScaling())}handleVisibilityChange(t){const i=!document.hidden;this.emitTouchEvent("visibilityChange",{visible:i}),!i&&this.config.enableBatteryOptimization?this.applyBackgroundOptimizations():this.restorePerformance()}getOrientation(){return window.innerWidth>window.innerHeight?"landscape":"portrait"}getDistance(t,i,e,s){const n=e-t,h=s-i;return Math.sqrt(n*n+h*h)}getAngle(t,i,e,s){return 180*Math.atan2(s-i,e-t)/Math.PI}applyMobileOptimizations(){if(!this.isMobile&&!this.isTablet)return;const t={...this.mobilePerformanceSettings,canvasScale:this.calculateOptimalCanvasScale(),useWebGL:!1,useOffscreenCanvas:this.useOffscreenCanvas};return this.emitTouchEvent("mobileOptimizations",t),t}applyOrientationOptimizations(){const t="landscape"===this.orientation,i={layoutMode:t?"horizontal":"vertical",particleDirection:t?"horizontal":"vertical",uiScale:t?.8:1};return this.emitTouchEvent("orientationOptimizations",i),i}applyResponsiveScaling(){const t=Math.min(this.viewportSize.width/375,2);return this.canvasScale=t,this.emitTouchEvent("responsiveScale",{scale:this.canvasScale,viewport:this.viewportSize}),this.canvasScale}applyBackgroundOptimizations(){const t={targetFPS:5,particlesEnabled:!1,animationsEnabled:!1,audioEnabled:!1};return this.emitTouchEvent("backgroundOptimizations",t),t}restorePerformance(){const t=this.applyMobileOptimizations();return this.emitTouchEvent("performanceRestore",t),t}onBatteryChange(){if(this.lowPowerMode=this.batteryLevel<.2&&!this.isCharging,this.lowPowerMode){const t={targetFPS:15,maxParticles:5,reducedEffects:!0,audioEnabled:!1};this.emitTouchEvent("lowPowerMode",{batteryLevel:this.batteryLevel,isCharging:this.isCharging,optimizations:t})}}calculateOptimalCanvasScale(){return this.isMobile?Math.min(this.pixelRatio,2):this.isTablet?Math.min(this.pixelRatio,2.5):this.pixelRatio}getCanvas(){return this.canvas||document.querySelector("canvas")}setCanvas(t){this.canvas=t,this.config.enableTouchOptimization&&this.isTouchDevice&&this.setupTouchHandlers()}emitTouchEvent(t,i){this.onTouchEvent&&this.onTouchEvent(t,i)}getStatus(){return{device:{isMobile:this.isMobile,isTablet:this.isTablet,isTouchDevice:this.isTouchDevice,isIOS:this.isIOS,isAndroid:this.isAndroid},viewport:{size:this.viewportSize,orientation:this.orientation,pixelRatio:this.pixelRatio,canvasScale:this.canvasScale},battery:{level:this.batteryLevel,isCharging:this.isCharging,lowPowerMode:this.lowPowerMode},touch:{activeTouches:this.touches.size,currentGesture:this.currentGesture,isPinching:this.isPinching,isRotating:this.isRotating},performance:this.mobilePerformanceSettings}}destroy(){const t=this.getCanvas();t&&(t.removeEventListener("touchstart",this.handleTouchStart),t.removeEventListener("touchmove",this.handleTouchMove),t.removeEventListener("touchend",this.handleTouchEnd),t.removeEventListener("touchcancel",this.handleTouchCancel)),window.removeEventListener("resize",this.handleViewportChange),window.removeEventListener("orientationchange",this.handleOrientationChange),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.touches.clear(),this.gestureHistory=[]}}class ee{constructor(t={}){this.config={enablePlugins:!1!==t.enablePlugins,validatePlugins:!1!==t.validatePlugins,sandboxPlugins:!1!==t.sandboxPlugins,maxPlugins:t.maxPlugins||50,pluginTimeout:t.pluginTimeout||5e3,allowOverrides:!1!==t.allowOverrides,...t},this.plugins=new Map,this.pluginTypes=["emotion","gesture","particle","audio","renderer","animation"],this.pluginsByType=new Map(this.pluginTypes.map(t=>[t,new Set])),this.dependencies=new Map,this.dependencyGraph=new Map,this.pluginStates=new Map,this.loadingPlugins=new Set,this.activePlugins=new Set,this.hooks=new Map([["beforeInit",new Set],["afterInit",new Set],["beforeUpdate",new Set],["afterUpdate",new Set],["beforeRender",new Set],["afterRender",new Set],["beforeDestroy",new Set],["afterDestroy",new Set]]),this.pluginAPI=this.createPluginAPI(),this.conflicts=new Map,this.resolutionStrategies={override:this.overrideConflict.bind(this),merge:this.mergeConflict.bind(this),reject:this.rejectConflict.bind(this),queue:this.queueConflict.bind(this)},this.validationSchemas=this.createValidationSchemas(),this.sandbox=null,this.config.sandboxPlugins&&(this.sandbox=this.createSandbox())}createPluginAPI(){return{registerHook:this.registerHook.bind(this),emit:this.emitPluginEvent.bind(this),on:this.onPluginEvent.bind(this),getPlugin:this.getPlugin.bind(this),hasPlugin:this.hasPlugin.bind(this),log:this.logFromPlugin.bind(this),error:this.errorFromPlugin.bind(this),setState:this.setPluginState.bind(this),getState:this.getPluginState.bind(this),getConfig:()=>({...this.config}),version:"1.0.0"}}createValidationSchemas(){const t=new Map,i={name:{type:"string",required:!0},version:{type:"string",required:!0},type:{type:"string",required:!0,enum:this.pluginTypes},description:{type:"string",required:!1},author:{type:"string",required:!1},dependencies:{type:"array",required:!1},conflicts:{type:"array",required:!1},init:{type:"function",required:!0},destroy:{type:"function",required:!0}};return t.set("emotion",{...i,emotion:{type:"object",required:!0,properties:{name:{type:"string",required:!0},color:{type:"string",required:!0},particleColor:{type:"string",required:!1},animation:{type:"object",required:!0},transitions:{type:"object",required:!1}}},updateEmotion:{type:"function",required:!0},renderEmotion:{type:"function",required:!1}}),t.set("gesture",{...i,gesture:{type:"object",required:!0,properties:{name:{type:"string",required:!0},duration:{type:"number",required:!0},keyframes:{type:"array",required:!0},compatibility:{type:"object",required:!1}}},executeGesture:{type:"function",required:!0},canExecute:{type:"function",required:!1}}),t.set("particle",{...i,particle:{type:"object",required:!0,properties:{name:{type:"string",required:!0},maxParticles:{type:"number",required:!1},behavior:{type:"function",required:!0},render:{type:"function",required:!0}}},updateParticles:{type:"function",required:!0},spawnParticle:{type:"function",required:!1}}),t.set("audio",{...i,audio:{type:"object",required:!0,properties:{name:{type:"string",required:!0},sounds:{type:"object",required:!0},effects:{type:"array",required:!1}}},playSound:{type:"function",required:!0},processAudio:{type:"function",required:!1}}),t}createSandbox(){return{Math:Math,Date:Date,JSON:JSON,console:{log:(...t)=>null,warn:(...t)=>null,error:(...t)=>null},window:void 0,document:void 0,localStorage:void 0,sessionStorage:void 0,fetch:void 0,XMLHttpRequest:void 0,api:this.pluginAPI}}async registerPlugin(t){if(!this.config.enablePlugins)return!1;if(this.plugins.size>=this.config.maxPlugins)return!1;if(this.config.validatePlugins&&!this.validatePlugin(t).valid)return!1;if(this.checkConflicts(t).length>0&&!this.config.allowOverrides)return!1;if(!(await this.resolveDependencies(t)).resolved)return!1;try{this.loadingPlugins.add(t.name);const i=this.config.sandboxPlugins?this.sandbox:window;if(!await this.initializePlugin(t,i))throw new Error("Plugin initialization failed");return this.plugins.set(t.name,t),this.pluginsByType.get(t.type).add(t.name),this.pluginStates.set(t.name,"active"),this.activePlugins.add(t.name),t.dependencies&&(this.dependencies.set(t.name,t.dependencies),this.updateDependencyGraph(t.name,t.dependencies)),t.hooks&&Object.entries(t.hooks).forEach(([i,e])=>{this.registerHook(i,e,t.name)}),this.emitPluginEvent("pluginRegistered",{name:t.name,type:t.type,version:t.version}),!0}catch(t){return!1}finally{this.loadingPlugins.delete(t.name)}}validatePlugin(t){const i=[];if(t.name&&"string"==typeof t.name||i.push("Plugin must have a valid name"),t.type&&this.pluginTypes.includes(t.type)||i.push(`Plugin type must be one of: ${this.pluginTypes.join(", ")}`),t.version&&"string"==typeof t.version||i.push("Plugin must have a version"),"function"!=typeof t.init&&i.push("Plugin must have an init function"),"function"!=typeof t.destroy&&i.push("Plugin must have a destroy function"),t.type&&this.validationSchemas.has(t.type)){const e=this.validationSchemas.get(t.type),s=this.validateAgainstSchema(t,e);i.push(...s)}return{valid:0===i.length,errors:i}}validateAgainstSchema(t,i){const e=[];return Object.entries(i).forEach(([i,s])=>{if(s.required&&!(i in t)&&e.push(`Missing required property: ${i}`),i in t){const n=t[i];if(s.type&&typeof n!==s.type&&e.push(`Property ${i} must be of type ${s.type}`),s.enum&&!s.enum.includes(n)&&e.push(`Property ${i} must be one of: ${s.enum.join(", ")}`),s.properties&&"object"==typeof n){const t=this.validateAgainstSchema(n,s.properties);e.push(...t.map(t=>`${i}.${t}`))}}}),e}checkConflicts(t){const i=[];return t.conflicts&&t.conflicts.forEach(t=>{this.plugins.has(t)&&i.push(t)}),"emotion"!==t.type&&"gesture"!==t.type||this.plugins.forEach(e=>{if(e.type===t.type){const s=e[t.type]?.name,n=t[t.type]?.name;s===n&&i.push(`${t.type} name collision: ${n}`)}}),i}async resolveDependencies(t){if(!t.dependencies||0===t.dependencies.length)return{resolved:!0,missing:[]};const i=[];for(const e of t.dependencies)this.plugins.has(e)||await this.tryLoadDependency(e)||i.push(e);return{resolved:0===i.length,missing:i}}tryLoadDependency(t){return this.plugins.has(t)}updateDependencyGraph(t,i){this.dependencyGraph.set(t,new Set(i)),i.forEach(t=>{this.dependencyGraph.has(t)||this.dependencyGraph.set(t,new Set)})}async initializePlugin(t,i){try{const e=new Promise((t,i)=>{setTimeout(()=>i(new Error("Plugin initialization timeout")),this.config.pluginTimeout)}),s=t.init.bind(i);return!1!==await Promise.race([s(this.pluginAPI),e])}catch(t){return!1}}async unregisterPlugin(t){const i=this.plugins.get(t);if(!i)return!1;if(this.getDependentPlugins(t).length>0)return!1;try{return"function"==typeof i.destroy&&await i.destroy(),this.plugins.delete(t),this.pluginsByType.get(i.type).delete(t),this.pluginStates.delete(t),this.activePlugins.delete(t),this.dependencies.delete(t),this.dependencyGraph.delete(t),this.hooks.forEach(i=>{i.forEach(e=>{e.pluginName===t&&i.delete(e)})}),this.emitPluginEvent("pluginUnregistered",{name:t}),!0}catch(t){return!1}}getDependentPlugins(t){const i=[];return this.dependencies.forEach((e,s)=>{e.includes(t)&&i.push(s)}),i}registerHook(t,i,e){this.hooks.has(t)||this.hooks.set(t,new Set),this.hooks.get(t).add({handler:i,pluginName:e})}async executeHooks(t,i){const e=this.hooks.get(t);if(!e||0===e.size)return[];const s=[];for(const t of e)try{const e=await t.handler(i);s.push({pluginName:t.pluginName,result:e})}catch(t){}return s}getPlugin(t){return this.plugins.get(t)||null}hasPlugin(t){return this.plugins.has(t)}getPluginsByType(t){const i=this.pluginsByType.get(t);return i?Array.from(i).map(t=>this.plugins.get(t)):[]}enablePlugin(t){if(!this.plugins.has(t))return;this.pluginStates.set(t,"active"),this.activePlugins.add(t);const i=this.plugins.get(t);i.onEnable&&i.onEnable(),this.emitPluginEvent("pluginEnabled",{name:t})}disablePlugin(t){if(!this.plugins.has(t))return;this.getDependentPlugins(t),this.pluginStates.set(t,"disabled"),this.activePlugins.delete(t);const i=this.plugins.get(t);i.onDisable&&i.onDisable(),this.emitPluginEvent("pluginDisabled",{name:t})}emitPluginEvent(t,i){this.onPluginEvent&&this.onPluginEvent(t,i)}onPluginEvent(t,i){}logFromPlugin(t,...i){}errorFromPlugin(t,...i){}setPluginState(t,i,e){this.pluginStates.has(t)||this.pluginStates.set(t,{});const s=this.pluginStates.get(t);"object"==typeof s&&(s[i]=e)}getPluginState(t,i){const e=this.pluginStates.get(t);if("object"==typeof e)return e[i]}overrideConflict(t,i){return i}mergeConflict(t,i){return{...t,...i}}rejectConflict(t,i){return t}queueConflict(t,i){return[t,i]}getStatus(){return{enabled:this.config.enablePlugins,totalPlugins:this.plugins.size,activePlugins:this.activePlugins.size,loadingPlugins:this.loadingPlugins.size,pluginsByType:Object.fromEntries(Array.from(this.pluginsByType.entries()).map(([t,i])=>[t,i.size])),hooks:Object.fromEntries(Array.from(this.hooks.entries()).map(([t,i])=>[t,i.size]))}}async destroy(){const t=Array.from(this.plugins.keys());for(const i of t)await this.unregisterPlugin(i);this.plugins.clear(),this.pluginsByType.clear(),this.dependencies.clear(),this.dependencyGraph.clear(),this.pluginStates.clear(),this.activePlugins.clear(),this.loadingPlugins.clear(),this.hooks.clear(),this.conflicts.clear()}}class se{constructor(){if(se.k)return this.features=se.k,void(this.capabilities=se.B);this.features={webAudio:this.detectWebAudio(),canvas2d:this.detectCanvas2D(),requestAnimationFrame:this.detectRequestAnimationFrame(),devicePixelRatio:this.detectDevicePixelRatio(),audioContext:this.detectAudioContext(),mediaDevices:this.detectMediaDevices(),performance:this.detectPerformance(),intersectionObserver:this.detectIntersectionObserver()},this.capabilities=this.assessCapabilities(),se.k=this.features,se.B=this.capabilities}detectWebAudio(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch(t){return!1}}detectCanvas2D(){try{const t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}catch(t){return!1}}detectRequestAnimationFrame(){return!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame)}detectDevicePixelRatio(){return"number"==typeof window.devicePixelRatio}detectAudioContext(){try{return!(!window.AudioContext&&!window.webkitAudioContext)}catch(t){return!1}}detectMediaDevices(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)}detectPerformance(){return!(!window.performance||!window.performance.now)}detectIntersectionObserver(){return"function"==typeof window.IntersectionObserver}assessCapabilities(){const t=Object.values(this.features).filter(Boolean).length,i=Object.keys(this.features).length,e=t/i*100;let s="basic";return e>=90?s="full":e>=70?s="good":e>=50&&(s="limited"),{score:t,total:i,percentage:e,level:s,recommendations:this.getRecommendations(s)}}getRecommendations(t){const i=[];return this.features.webAudio||i.push("Audio features will be disabled"),this.features.requestAnimationFrame||i.push("Animation will use setTimeout fallback"),this.features.performance||i.push("Performance monitoring will be limited"),"basic"===t&&i.push("Consider using minimal build for better performance"),i}getFeatures(){return{...this.features}}getCapabilities(){return{...this.capabilities}}}class ne{constructor(){this.polyfills=new Map,this.applied=new Set}register(t,i){this.polyfills.set(t,i)}apply(t){if(this.applied.has(t))return!0;const i=this.polyfills.get(t);if(!i)return!1;try{return i(),this.applied.add(t),!0}catch(t){return!1}}applyAll(){const t=[];for(const i of this.polyfills.keys())this.apply(i)&&t.push(i);return t}isApplied(t){return this.applied.has(t)}}function he(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(()=>{t(Date.now())},1e3/60)},window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){window.clearTimeout(t)})}function ae(){if(window.performance&&window.performance.now)return;window.performance||(window.performance={});const t=Date.now();window.performance.now=function(){return Date.now()-t}}function re(){window.AudioContext||window.webkitAudioContext||(window.AudioContext=function(){this.state="suspended",this.sampleRate=44100,this.currentTime=0,this.destination={connect(){},disconnect(){}},this.createGain=function(){return{gain:{value:1},connect(){},disconnect(){}}},this.createOscillator=function(){return{frequency:{value:440},type:"sine",start(){},stop(){},connect(){},disconnect(){}}},this.createAnalyser=function(){return{fftSize:2048,frequencyBinCount:1024,getByteFrequencyData(t){for(let i=0;i<t.length;i++)t[i]=0},connect(){},disconnect(){}}},this.resume=function(){return this.state="running",Promise.resolve()},this.suspend=function(){return this.state="suspended",Promise.resolve()},this.close=function(){return this.state="closed",Promise.resolve()}})}class oe{constructor(t){this.canvas=t,this.context=null,this.isContextLost=!1,this.recoveryCallbacks=[],this.setupContextLossHandling()}setupContextLossHandling(){this.canvas.addEventListener("webglcontextlost",t=>{t.preventDefault(),this.isContextLost=!0}),this.canvas.addEventListener("webglcontextrestored",()=>{this.isContextLost=!1,this.context=this.canvas.getContext("2d"),this.recoveryCallbacks.forEach(t=>{try{t(this.context)}catch(t){}})})}getContext(){if(this.isContextLost)return null;if(!this.context)try{this.context=this.canvas.getContext("2d")}catch(t){return null}return this.context}onRecovery(t){this.recoveryCallbacks.push(t)}isLost(){return this.isContextLost}recover(){if(!this.isContextLost)return!0;try{if(this.context=this.canvas.getContext("2d"),this.context)return this.isContextLost=!1,!0}catch(t){}return!1}}class ce{constructor(){if(ce.P)return this.browser=ce.P,void(this.optimizations=ce.C);this.browser=this.detectBrowser(),this.optimizations=new Map,this.setupOptimizations(),ce.P=this.browser,ce.C=this.optimizations}detectBrowser(){const{userAgent:t}=navigator;let i="unknown",e="unknown";if(t.includes("Chrome")){i="chrome";const s=t.match(/Chrome\/(\d+)/);e=s?s[1]:"unknown"}else if(t.includes("Firefox")){i="firefox";const s=t.match(/Firefox\/(\d+)/);e=s?s[1]:"unknown"}else if(t.includes("Safari")&&!t.includes("Chrome")){i="safari";const s=t.match(/Version\/(\d+)/);e=s?s[1]:"unknown"}else if(t.includes("Edge")){i="edge";const s=t.match(/Edge\/(\d+)/);e=s?s[1]:"unknown"}return{name:i,version:e,userAgent:t}}setupOptimizations(){this.optimizations.set("chrome",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:50}),this.optimizations.set("firefox",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"balanced"},canvasOptimizations:[],particleLimit:40}),this.optimizations.set("safari",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"playback"},canvasOptimizations:[],particleLimit:30}),this.optimizations.set("edge",{preferredAnimationMethod:"requestAnimationFrame",audioContextOptions:{latencyHint:"interactive"},canvasOptimizations:["willReadFrequently"],particleLimit:45})}getOptimizations(){return this.optimizations.get(this.browser.name)||this.optimizations.get("chrome")}getBrowser(){return{...this.browser}}applyCanvasOptimizations(t,i){if(this.getOptimizations().canvasOptimizations.includes("willReadFrequently"))try{t.getContext("2d",{willReadFrequently:!0})}catch(t){}}getRecommendedParticleLimit(){return this.getOptimizations().particleLimit}getAudioContextOptions(){return this.getOptimizations().audioContextOptions}}let le=null,ue=null;const pe=(ue||(ue=function(){if(le)return le;const t=new se,i=new ne,e=new ce;i.register("requestAnimationFrame",he),i.register("performanceNow",ae),i.register("webAudio",re);const s=[];return t.features.requestAnimationFrame||i.apply("requestAnimationFrame")&&s.push("requestAnimationFrame"),t.features.performance||i.apply("performanceNow")&&s.push("performanceNow"),t.features.webAudio||i.apply("webAudio")&&s.push("webAudio"),le={featureDetection:t,polyfillManager:i,browserOptimizations:e,appliedPolyfills:s,capabilities:t.getCapabilities(),browser:e.getBrowser()},le}()),ue),de={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5},me=new class{constructor(t={}){this.config={enabled:!1!==t.enabled,level:t.level||de.INFO,enableProfiling:!1!==t.enableProfiling,enableErrorTracking:!1!==t.enableErrorTracking,enableMemoryTracking:!1!==t.enableMemoryTracking,maxLogEntries:t.maxLogEntries||1e3,maxProfileEntries:t.maxProfileEntries||500,...t},this.logs=[],this.errors=[],this.profiles=new Map,this.memorySnapshots=[],this.frameTimings=[],this.maxFrameTimings=120,this.errorCounts=new Map,this.lastErrors=new Map,this.capabilities={performance:"undefined"!=typeof performance&&performance.now,memory:"undefined"!=typeof performance&&performance.memory,console:"undefined"!=typeof console,stackTrace:"undefined"!=typeof Error},this.startTime=this.now(),this.setupErrorHandling(),this.config.enabled&&this.log("DEBUG","EmotiveDebugger initialized",{config:this.config,capabilities:this.capabilities})}now(){return this.capabilities.performance?performance.now():Date.now()-this.startTime}setupErrorHandling(){this.config.enableErrorTracking&&"undefined"!=typeof window&&(window.addEventListener("error",t=>{this.trackError("UNHANDLED_ERROR",t.error||new Error(t.message),{filename:t.filename,lineno:t.lineno,colno:t.colno})}),window.addEventListener("unhandledrejection",t=>{this.trackError("UNHANDLED_REJECTION",t.reason,{promise:t.promise})}))}log(t,i,e=null){if(!this.config.enabled)return;if((de[t]||de.INFO)>this.config.level)return;const s=this.now(),n={timestamp:s,level:t,message:i,data:e,stackTrace:this.getStackTrace()};if(this.logs.push(n),this.logs.length>this.config.maxLogEntries&&this.logs.shift(),this.capabilities.console){const n=this.getConsoleMethod(t),h=`[${(s/1e3).toFixed(3)}s]`;e?n(`${h} [${t}] ${i}`,e):n(`${h} [${t}] ${i}`)}}getConsoleMethod(t){return(()=>{}).bind(console)}getStackTrace(){if(!this.capabilities.stackTrace)return null;try{throw new Error}catch(t){return t.stack}}trackError(t,i,e={}){if(!this.config.enableErrorTracking)return;const s={timestamp:this.now(),type:t,message:i.message||String(i),stack:i.stack,context:e,count:1},n=`${t}:${i.message}`;this.errorCounts.has(n)?(this.errorCounts.set(n,this.errorCounts.get(n)+1),s.count=this.errorCounts.get(n)):this.errorCounts.set(n,1),this.errors.push(s),this.lastErrors.set(t,s),this.log("ERROR",`${t}: ${i.message}`,{error:s,context:e})}startProfile(t,i={}){if(!this.config.enableProfiling)return;const e={name:t,startTime:this.now(),metadata:i,samples:[],isActive:!0};this.profiles.set(t,e),this.log("TRACE",`Started profiling: ${t}`,i)}profileSample(t,i,e=null){if(!this.config.enableProfiling)return;const s=this.profiles.get(t);if(!s||!s.isActive)return;const n={timestamp:this.now(),label:i,data:e,relativeTime:this.now()-s.startTime};s.samples.push(n)}endProfile(t){if(!this.config.enableProfiling)return null;const i=this.profiles.get(t);if(!i||!i.isActive)return null;if(i.endTime=this.now(),i.duration=i.endTime-i.startTime,i.isActive=!1,i.stats=this.calculateProfileStats(i),this.log("TRACE",`Ended profiling: ${t}`,{duration:i.duration,samples:i.samples.length,stats:i.stats}),this.profiles.size>this.config.maxProfileEntries){const t=this.profiles.keys().next().value;this.profiles.delete(t)}return{...i}}calculateProfileStats(t){if(0===t.samples.length)return{sampleCount:0};const i=[];for(let e=1;e<t.samples.length;e++)i.push(t.samples[e].relativeTime-t.samples[e-1].relativeTime);if(0===i.length)return{sampleCount:t.samples.length};const e=i.reduce((t,i)=>t+i,0)/i.length,s=Math.min(...i),n=Math.max(...i);return{sampleCount:t.samples.length,avgSampleDuration:e,minSampleDuration:s,maxSampleDuration:n,totalDuration:t.duration}}trackFrameTiming(t){this.config.enableProfiling&&(this.frameTimings.push({timestamp:this.now(),frameTime:t,fps:1e3/t}),this.frameTimings.length>this.maxFrameTimings&&this.frameTimings.shift())}takeMemorySnapshot(t="snapshot"){if(!this.config.enableMemoryTracking||!this.capabilities.memory)return;const i={timestamp:this.now(),label:t,memory:{usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}};this.memorySnapshots.push(i),this.memorySnapshots.length>100&&this.memorySnapshots.shift(),this.log("DEBUG",`Memory snapshot: ${t}`,i.memory)}getDebugReport(){return{timestamp:this.now(),uptime:this.now()-0,config:this.config,capabilities:this.capabilities,logCount:this.logs.length,recentLogs:this.logs.slice(-10),errorCount:this.errors.length,uniqueErrors:this.errorCounts.size,recentErrors:this.errors.slice(-5),errorCounts:Object.fromEntries(this.errorCounts),activeProfiles:Array.from(this.profiles.values()).filter(t=>t.isActive).length,completedProfiles:Array.from(this.profiles.values()).filter(t=>!t.isActive).length,frameTimings:this.getFrameTimingStats(),memorySnapshots:this.memorySnapshots.slice(-5)}}getFrameTimingStats(){if(0===this.frameTimings.length)return{sampleCount:0};const t=this.frameTimings.map(t=>t.frameTime),i=this.frameTimings.map(t=>t.fps);return{sampleCount:this.frameTimings.length,avgFrameTime:t.reduce((t,i)=>t+i,0)/t.length,minFrameTime:Math.min(...t),maxFrameTime:Math.max(...t),avgFPS:i.reduce((t,i)=>t+i,0)/i.length,minFPS:Math.min(...i),maxFPS:Math.max(...i)}}exportDebugData(){return{metadata:{exportTime:Date.now(),debuggerUptime:this.now(),config:this.config,capabilities:this.capabilities},logs:[...this.logs],errors:[...this.errors],profiles:Object.fromEntries(this.profiles),frameTimings:[...this.frameTimings],memorySnapshots:[...this.memorySnapshots],errorCounts:Object.fromEntries(this.errorCounts)}}clear(){this.logs=[],this.errors=[],this.profiles.clear(),this.frameTimings=[],this.memorySnapshots=[],this.errorCounts.clear(),this.lastErrors.clear(),this.log("INFO","Debug data cleared")}destroy(){this.clear(),this.config.enabled=!1}}({enabled:"undefined"!=typeof window&&window.location&&window.location.search.includes("debug=true"),level:de.INFO}),fe=new class{constructor(){this.capabilities=this.detectCapabilities(),this.performance=this.measurePerformance()}detectCapabilities(){return{es6:this.detectES6(),es2017:this.detectES2017(),modules:this.detectModules(),webGL:this.detectWebGL(),webGL2:this.detectWebGL2(),webWorkers:this.detectWebWorkers(),serviceWorkers:this.detectServiceWorkers(),performanceObserver:this.detectPerformanceObserver(),intersectionObserver:this.detectIntersectionObserver(),resizeObserver:this.detectResizeObserver(),localStorage:this.detectLocalStorage(),sessionStorage:this.detectSessionStorage(),indexedDB:this.detectIndexedDB(),fetch:this.detectFetch(),webSockets:this.detectWebSockets(),touchEvents:this.detectTouchEvents(),pointerEvents:this.detectPointerEvents(),deviceOrientation:this.detectDeviceOrientation(),canvas2d:this.detectCanvas2D(),canvasFilters:this.detectCanvasFilters(),offscreenCanvas:this.detectOffscreenCanvas()}}detectES6(){try{return"undefined"!=typeof Symbol&&"undefined"!=typeof Promise&&"undefined"!=typeof Map&&"undefined"!=typeof Set}catch(t){return!1}}detectES2017(){try{return"undefined"!=typeof async||function(){try{return"function"==typeof async function(){}.constructor}catch(t){return!1}}()}catch(t){return!1}}detectModules(){try{return"undefined"!=typeof document&&"noModule"in document.createElement("script")}catch(t){return!1}}detectWebGL(){try{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(t){return!1}}detectWebGL2(){try{return!!document.createElement("canvas").getContext("webgl2")}catch(t){return!1}}detectWebWorkers(){return"undefined"!=typeof Worker}detectServiceWorkers(){return"serviceWorker"in navigator}detectPerformanceObserver(){return"undefined"!=typeof PerformanceObserver}detectIntersectionObserver(){return"undefined"!=typeof IntersectionObserver}detectResizeObserver(){return"undefined"!=typeof ResizeObserver}detectLocalStorage(){try{return"undefined"!=typeof localStorage&&null!==localStorage}catch(t){return!1}}detectSessionStorage(){try{return"undefined"!=typeof sessionStorage&&null!==sessionStorage}catch(t){return!1}}detectIndexedDB(){return"undefined"!=typeof indexedDB}detectFetch(){return"undefined"!=typeof fetch}detectWebSockets(){return"undefined"!=typeof WebSocket}detectTouchEvents(){return"ontouchstart"in window||navigator.maxTouchPoints>0}detectPointerEvents(){return"undefined"!=typeof PointerEvent}detectDeviceOrientation(){return"ondeviceorientation"in window}detectCanvas2D(){try{return!!document.createElement("canvas").getContext("2d")}catch(t){return!1}}detectCanvasFilters(){try{return"filter"in document.createElement("canvas").getContext("2d")}catch(t){return!1}}detectOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}measurePerformance(){const t={},i=performance.now();t.jsExecutionSpeed=performance.now()-i;try{const i=document.createElement("canvas");i.width=100,i.height=100;const e=i.getContext("2d"),s=performance.now();for(let t=0;t<1e3;t++)e.fillRect(100*Math.random(),100*Math.random(),10,10);t.canvasPerformance=performance.now()-s}catch(i){t.canvasPerformance=null}return t}getCapabilities(){return{...this.capabilities}}getPerformance(){return{...this.performance}}generateReport(){const t=Object.entries(this.capabilities).filter(([,t])=>t).map(([t])=>t),i=Object.entries(this.capabilities).filter(([,t])=>!t).map(([t])=>t),e=t.length/Object.keys(this.capabilities).length*100;return{timestamp:Date.now(),userAgent:navigator.userAgent,supportedFeatures:t,unsupportedFeatures:i,supportPercentage:Math.round(e),performance:this.performance,recommendations:this.generateRecommendations(e)}}generateRecommendations(t){const i=[];return t<50&&i.push("Consider using the minimal build for better compatibility"),this.capabilities.webGL||i.push("WebGL not supported - advanced graphics features unavailable"),this.capabilities.webWorkers||i.push("Web Workers not supported - background processing unavailable"),this.capabilities.fetch||i.push("Fetch API not supported - consider using XMLHttpRequest polyfill"),this.performance.jsExecutionSpeed>50&&i.push("Slow JavaScript execution detected - consider performance optimizations"),this.performance.canvasPerformance>100&&i.push("Slow canvas performance detected - consider reducing visual complexity"),i}};function ge(t){const i=[];for(let e=0;e<t;e++){const s=e/t*Math.PI*2;i.push({x:.5+.5*Math.cos(s),y:.5+.5*Math.sin(s)})}return i}function ye(t,i=12){return ge(t)}const Me={circle:{points:ge(64),shadow:{type:"none"}},heart:{points:function(){const t=[];for(let i=0;i<64;i++){const e=i/64*Math.PI*2,s=16*Math.pow(Math.sin(e),3),n=-(13*Math.cos(e)-5*Math.cos(2*e)-2*Math.cos(3*e)-Math.cos(4*e));t.push({x:.5+s/32,y:.5+n/32})}return t}(),shadow:{type:"none"}},star:{points:function(){const t=[];for(let i=0;i<64;i++){const e=i/64,s=Math.floor(10*e),n=s%2==0,h=Math.floor(s/2);let a;a=n?(72*h-90)*Math.PI/180:(72*h+36-90)*Math.PI/180;const r=n?.5:.2;t.push({x:.5+Math.cos(a)*r,y:.5+Math.sin(a)*r})}return t}(0),shadow:{type:"none"}},sun:{points:ye(64,12),shadow:{type:"sun",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3}},moon:{points:ge(64),shadow:{type:"crescent",coverage:.85,angle:-30,softness:.05,offset:.7}},lunar:{points:ge(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)",progression:"center"}},suspicion:{points:function(){const t=[];for(let i=0;i<64;i++){const e=i/64*Math.PI*2;let s,n;if(e<Math.PI)s=.45*Math.cos(e),n=.45*Math.sin(e);else{const t=2*Math.PI-e;s=.25*Math.cos(t)-.1,n=.35*Math.sin(t)}t.push({x:.5+s,y:.5+n})}return t}(),shadow:{type:"none"}},eclipse:{points:ge(64),shadow:{type:"lunar",coverage:.7,color:"rgba(80, 20, 0, 0.8)"}},square:{points:function(){const t=[],i=Math.floor(16);for(let e=0;e<4;e++)for(let s=0;s<i;s++){const n=s/i;let h,a;switch(e){case 0:h=-.5+n,a=-.5;break;case 1:h=.5,a=-.5+n;break;case 2:h=.5-n,a=.5;break;case 3:h=-.5,a=.5-n}t.push({x:.5+.8*h,y:.5+.8*a})}return t}(),shadow:{type:"none"}},triangle:{points:function(){const t=[],i=[{x:0,y:-.5},{x:-.433,y:.25},{x:.433,y:.25}],e=[Math.sqrt(Math.pow(i[1].x-i[0].x,2)+Math.pow(i[1].y-i[0].y,2)),Math.sqrt(Math.pow(i[2].x-i[1].x,2)+Math.pow(i[2].y-i[1].y,2)),Math.sqrt(Math.pow(i[0].x-i[2].x,2)+Math.pow(i[0].y-i[2].y,2))],s=e[0]+e[1]+e[2],n=e.map(t=>Math.round(64*t/s)),h=n.reduce((t,i)=>t+i,0);h<64&&(n[0]+=64-h);for(let e=0;e<3;e++){const s=i[e],h=i[(e+1)%3],a=n[e];for(let i=0;i<a;i++){if(i===a-1&&e<2)continue;const n=i/a,r=s.x+(h.x-s.x)*n,o=s.y+(h.y-s.y)*n;t.push({x:.5+.9*r,y:.5+.9*o})}}for(;t.length<64;)t.push(t[t.length-1]);for(;t.length>64;)t.pop();return t}(),shadow:{type:"none"}},solar:{points:ye(64,12),shadow:{type:"solar-hybrid",corona:!0,intensity:1.5,flares:!0,texture:!0,turbulence:.3,lunarOverlay:{type:"lunar",coverage:1,color:"rgba(0, 0, 0, 1.0)",progression:"center"}}}};const be=new class{constructor(){this.shapeCache=new Map,this.morphCache=new Map,this.propertyCache=new Map,this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1,this.loadStartTime=0,this.initialize()}initialize(){this.loadStartTime=performance.now();try{const t=Object.keys(Me);t.forEach(t=>{this.cacheShape(t)}),this.cacheCommonMorphs(t),this.isInitialized=!0,this.stats.loadTime=performance.now()-this.loadStartTime,this.stats.cacheSize=this.shapeCache.size}catch(t){this.isInitialized=!1}}cacheShape(t){try{const i=Me[t];if(i){this.shapeCache.set(t,i);const e={pointCount:i.points?.length||64,hasShadow:"none"!==i.shadow?.type,shadowType:i.shadow?.type||"none",isRadial:this.isRadialShape(t),bounds:this.calculateBounds(i.points)};this.propertyCache.set(t,e)}}catch(t){}}cacheCommonMorphs(t){[["circle","heart"],["circle","star"],["circle","square"],["heart","star"],["star","circle"],["square","circle"],["triangle","circle"],["moon","sun"],["lunar","eclipse"]].forEach(([i,e])=>{if(t.includes(i)&&t.includes(e))try{const t=this.calculateMorphSteps(i,e),s=`${i}->${e}`;this.morphCache.set(s,t)}catch(t){}})}calculateMorphSteps(t,i){const e=this.shapeCache.get(t),s=this.shapeCache.get(i);if(!e||!s)return null;const n=[];for(let t=0;t<5;t++){const i=t/4,h=this.interpolateShapePoints(e.points,s.points,i);n.push({progress:i,points:h})}return{from:t,to:i,steps:n,isRadial:this.isRadialShape(t)||this.isRadialShape(i)}}interpolateShapePoints(t,i,e){if(!t||!i)return t||i||[];const s=Math.max(t.length,i.length),n=[];for(let h=0;h<s;h++){const s=t[h]||t[0]||{x:.5,y:.5},a=i[h]||i[0]||{x:.5,y:.5};n.push({x:s.x+(a.x-s.x)*e,y:s.y+(a.y-s.y)*e})}return n}isRadialShape(t){return["circle","star","square","triangle","sun","moon"].includes(t)}calculateBounds(t){if(!t||0===t.length)return{minX:0,minY:0,maxX:1,maxY:1,width:1,height:1};let i=1/0,e=1/0,s=-1/0,n=-1/0;return t.forEach(t=>{i=Math.min(i,t.x),e=Math.min(e,t.y),s=Math.max(s,t.x),n=Math.max(n,t.y)}),{minX:i,minY:e,maxX:s,maxY:n,width:s-i,height:n-e}}getShape(t){if(!this.isInitialized)return Me[t]||null;const i=this.shapeCache.get(t);return i?(this.stats.hits++,i):(this.stats.misses++,Me[t]||null)}getProperties(t){if(!this.isInitialized){const i=Me[t];return i?{pointCount:i.points?.length||64,hasShadow:"none"!==i.shadow?.type,shadowType:i.shadow?.type||"none",isRadial:this.isRadialShape(t),bounds:this.calculateBounds(i.points)}:{}}const i=this.propertyCache.get(t);return i?(this.stats.hits++,i):(this.stats.misses++,{})}getMorph(t,i){if(!this.isInitialized)return this.calculateMorphSteps(t,i);const e=`${t}->${i}`,s=this.morphCache.get(e);return s?(this.stats.hits++,s):(this.stats.misses++,this.calculateMorphSteps(t,i))}hasShape(t){return this.shapeCache.has(t)}getStats(){const t=this.stats.hits+this.stats.misses;return{...this.stats,hitRate:t>0?`${(this.stats.hits/t*100).toFixed(1)}%`:"0%",shapes:this.shapeCache.size,morphs:this.morphCache.size,properties:this.propertyCache.size}}clear(){this.shapeCache.clear(),this.morphCache.clear(),this.propertyCache.clear(),this.stats={hits:0,misses:0,loadTime:0,cacheSize:0},this.isInitialized=!1}},we=new class{constructor(){this.pools=new Map,this.inUse=new Set}acquire(t,i="array"){const e=`${i}_${t}`;this.pools.has(e)||this.pools.set(e,[]);const s=this.pools.get(e);if(s.length>0){const t=s.pop();return this.inUse.add(t),t}let n;switch(i){case"float32":n=new Float32Array(t);break;case"uint8":n=new Uint8Array(t);break;default:n=new Array(t).fill(0)}return this.inUse.add(n),n}release(t){if(!this.inUse.has(t))return;this.inUse.delete(t);let i="array";t instanceof Float32Array?i="float32":t instanceof Uint8Array&&(i="uint8");const e=`${i}_${t.length}`;t.fill(0),this.pools.has(e)||this.pools.set(e,[]);const s=this.pools.get(e);s.length<10&&s.push(t)}clear(){this.pools.clear(),this.inUse.clear()}};class ve{constructor(t){this.morpher=t,this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.bassEnergy=0,this.vocalPresence=0,this.highFreqEnergy=0,this.transientActive=!1,this.transientStrength=0,this.transientDecay=.92,this.transientHoldTime=8,this.transientHoldCounter=0}applyAudioDeformation(t){if(!t||0===t.length)return this.morpher.generateFallbackCircle();if(this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.currentFrequencies&&this.morpher.audioAnalyzer.currentFrequencies.length>0){this.morpher.frequencyData=[...this.morpher.audioAnalyzer.currentFrequencies];let t=0,i=0;for(let e=0;e<=2&&e<this.morpher.frequencyData.length;e++)t+=this.morpher.frequencyData[e],i++;i>0&&(t/=i),this.morpher.bassPeakHistory||(this.morpher.bassPeakHistory=[],this.morpher.bassThumpTimer=0),this.morpher.bassPeakHistory.push(t),this.morpher.bassPeakHistory.length>20&&this.morpher.bassPeakHistory.shift();const e=this.morpher.bassPeakHistory.reduce((t,i)=>t+i,0)/this.morpher.bassPeakHistory.length,s=this.morpher.audioAnalyzer&&this.morpher.audioAnalyzer.microphoneStream;if(t>1.08*e&&t>(s?.15:.25)){const i=s?8:6;this.bassEnergy=Math.min(1,(t-e)*i),this.morpher.bassThumpTimer=12}else this.morpher.bassThumpTimer>0?(this.morpher.bassThumpTimer--,this.bassEnergy*=.9):this.bassEnergy=0;this.morpher.spectralHistory||(this.morpher.spectralHistory=[],this.morpher.spectralFluxHistory=[],this.morpher.onsetThreshold=0,this.morpher.musicDetector.reset(),this.morpher.detectedBPM=0,this.morpher.onsetStrengths=[],this.morpher.detectedTimeSignature=null,this.morpher.timeSignatureConfidence=0,this.morpher.measureStartTime=0,this.morpher.timeSignatureHistory=[],this.morpher.timeSignatureLocked=!1);const n=[...this.morpher.frequencyData];let h=0,a=0;if(this.morpher.spectralHistory.length>0){const t=this.morpher.spectralHistory[this.morpher.spectralHistory.length-1];for(let i=0;i<=2&&i<n.length;i++){const e=n[i]-t[i];e>0&&(a+=e)}for(let i=4;i<=15&&i<n.length;i++){const e=n[i]-t[i];e>0&&(h+=e*(i>=9&&i<=13?2:1))}a>.15&&(h*=.3)}if(this.morpher.spectralHistory.push(n),this.morpher.spectralHistory.length>30&&this.morpher.spectralHistory.shift(),this.morpher.spectralFluxHistory.push(h),this.morpher.spectralFluxHistory.length>30&&this.morpher.spectralFluxHistory.shift(),this.morpher.spectralFluxHistory.length>=10){const t=[...this.morpher.spectralFluxHistory].sort((t,i)=>t-i),i=t[Math.floor(t.length/2)],e=t.reduce((t,i)=>t+i,0)/t.length;this.morpher.onsetThreshold=i+.5*(e-i)}const r=h>1.2*this.morpher.onsetThreshold&&h>.02,o=h>2*this.morpher.onsetThreshold&&h>.05;if(r&&(this.transientHoldTime=8,this.morpher.vocalGlowBoost=.3),o){const t=performance.now(),i={time:t,strength:h/(this.morpher.onsetThreshold||1),bassWeight:a};this.morpher.onsetStrengths.push(i),this.morpher.onsetStrengths.length>40&&this.morpher.onsetStrengths.shift(),this.morpher.musicDetector.addOnset(t,h)}this.morpher.musicDetector.update(performance.now()),this.morpher.detectedBPM=this.morpher.musicDetector.detectedBPM,this.morpher.bpmConfidence=this.morpher.musicDetector.bpmConfidence,this.morpher.detectedBPM>0&&this.morpher.bpmConfidence>.8&&this.morpher.forceFastDetection&&(this.morpher.forceFastDetection=!1),this.transientHoldTime>0&&this.transientHoldTime--,this.morpher.vocalGlowBoost>0&&(this.morpher.vocalGlowBoost*=.92),this.vocalPresence=h,this.morpher.bassHistory[this.morpher.historyIndex]=this.bassEnergy,this.morpher.vocalHistory[this.morpher.historyIndex]=this.vocalPresence,this.morpher.historyIndex=(this.morpher.historyIndex+1)%this.morpher.bassHistory.length,this.morpher.bassHistory.reduce((t,i)=>t+i,0),this.morpher.bassHistory.length,this.morpher.vocalHistory.reduce((t,i)=>t+i,0),this.morpher.vocalHistory.length,this.morpher.bassEffectActive=this.morpher.bassThumpTimer>0,this.morpher.lastVocalPresence=this.morpher.lastVocalPresence||0,this.morpher.lastVocalPresence=this.vocalPresence,this.vocalEffectActive=this.transientHoldTime>0}const i=this.morpher.frequencyData&&this.morpher.frequencyData.some(t=>t>.01);if(this.morpher.audioAnalyzer&&i||(this.audioDeformation>.15?(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.min(1,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)):this.morpher.bassThumpTimer>0&&(this.morpher.bassThumpTimer--,this.bassEnergy*=.9),this.vocalEnergy>.2&&(this.vocalEffectActive=!0,this.vocalPresence=this.vocalEnergy)),!i&&this.audioDeformation>.15&&!this.morpher.bassEffectActive&&(this.morpher.bassEffectActive=!0,this.bassEnergy=Math.max(this.bassEnergy,.8*this.audioDeformation),(!this.morpher.bassThumpTimer||this.morpher.bassThumpTimer<=0)&&(this.morpher.bassThumpTimer=12)),!(0!==this.audioDeformation||this.bassEnergy>.01||this.vocalPresence>.01))return t;const e=[];if(this.morpher.bassEffectActive&&(Math.random()<.05&&(this.morpher.undulationDirection*=-1),this.morpher.undulationPhase+=.08*this.morpher.undulationDirection),this.morpher.audioAnalyzer&&this.beatGlitchIntensity>0&&(this.beatGlitchIntensity*=.9),this.vocalEffectActive&&Math.random()<.2){this.glitchPoints=[];const i=2+Math.floor(2*Math.random());for(let e=0;e<i;e++)this.glitchPoints.push({index:Math.floor(Math.random()*t.length),intensity:.02+.03*Math.random(),decay:.94+.02*Math.random()})}this.glitchPoints=this.glitchPoints.filter(t=>(t.intensity*=t.decay,t.intensity>.01));for(let i=0;i<t.length;i++){const s=t[i];if(!s||void 0===s.x||void 0===s.y){const s=i/t.length*Math.PI*2;e.push({x:.5+.5*Math.cos(s),y:.5+.5*Math.sin(s)});continue}const n=s.x-.5,h=s.y-.5,a=Math.sqrt(n*n+h*h),r=Math.atan2(h,n),o=.12*Math.abs(this.audioDeformation);let c=0,l=0;if(this.morpher.bassEffectActive){const t=2,i=.25*this.bassEnergy;c=Math.sin(r*t+this.morpher.undulationPhase)*i,l=Math.sin(.5*this.morpher.undulationPhase)*this.bassEnergy*.08}let u=0;const p=this.glitchPoints.find(t=>t.index===i);if(p){const t=.015*Date.now(),e=Math.sin(t+.5*i)*Math.cos(.7*t);u=p.intensity*e*.5}const d=1+o+c+l+u,m=a*Math.max(.8,d);e.push({x:.5+Math.cos(r)*m,y:.5+Math.sin(r)*m})}return e}setAudioDeformation(t){this.audioDeformation=Math.max(0,Math.min(1,t)),this.vocalEffectActive=t>.01}setVocalEnergy(t){this.vocalEnergy=Math.max(0,Math.min(1,t)),this.vocalEffectActive=t>.01}updateFrequencyBands(t){t&&(this.bassEnergy=t.bass||0,this.vocalPresence=t.vocal||0,this.highFreqEnergy=t.high||0)}processTransient(t,i){t>i?(this.transientActive=!0,this.transientStrength=t,this.transientHoldCounter=this.transientHoldTime):this.transientHoldCounter>0?this.transientHoldCounter--:(this.transientStrength*=this.transientDecay,this.transientStrength<.01&&(this.transientActive=!1))}getState(){return{audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy,vocalEffectActive:this.vocalEffectActive,beatGlitchIntensity:this.beatGlitchIntensity,transientActive:this.transientActive,transientStrength:this.transientStrength}}reset(){this.audioDeformation=0,this.vocalEnergy=0,this.vocalEffectActive=!1,this.beatGlitchIntensity=0,this.glitchPoints=[],this.transientActive=!1,this.transientStrength=0}}class Se{constructor(){this.agents=[],this.maxAgents=8,this.isActive=!1,this.confidence=0,this.lockedBPM=0,this.lastBeatTime=0,this.peakHistory=[],this.maxHistoryLength=100,this.minBPM=40,this.maxBPM=300,this.convergenceThreshold=.7,this.subdivisionPreference={slow:{min:40,max:80,prefer:1},normal:{min:80,max:140,prefer:1},fast:{min:140,max:180,prefer:.5},veryfast:{min:180,max:300,prefer:.5}}}createAgent(t,i=1){return{bpm:t,subdivision:i,effectiveBPM:t*i,phase:0,confidence:.5,hits:0,misses:0,lastBeatTime:performance.now(),beatInterval:6e4/(t*i)}}initializeAgents(t=120){this.agents=[];let i=[1];i=t>180||t>140?[.5,.75,1]:t<60?[1,1.5,2]:[.5,1,1.5],i.forEach(i=>{const e=this.createAgent(t,i);t*i<140&&(e.confidence=.6),this.agents.push(e)}),t>140&&(this.agents.push(this.createAgent(t/2,1)),this.agents.push(this.createAgent(t/2,1.5)))}processPeak(t,i=performance.now()){if(this.peakHistory.push({strength:t,time:i}),this.peakHistory.length>this.maxHistoryLength&&this.peakHistory.shift(),!(this.peakHistory.length<4)){if(!this.isActive||0===this.agents.length){const t=this.getFFTEstimate();this.initializeAgents(t),this.isActive=!0}this.lockedBPM>0&&this.confidence>.7?(this.agents.forEach(e=>{this.scoreAgent(e,i,t)}),this.confidence<.6&&(this.evolveAgents(),this.checkConvergence())):(this.agents.forEach(e=>{this.scoreAgent(e,i,t)}),this.evolveAgents(),this.checkConvergence())}}scoreAgent(t,i,e){const s=i-t.lastBeatTime,n=t.beatInterval,h=1-2*Math.abs(s%n/n-.5);h>.7?(t.hits++,t.confidence=Math.min(1,t.confidence+.1),h>.85&&(t.lastBeatTime=i)):h<.3&&(t.misses++,t.confidence=Math.max(0,t.confidence-.03)),t.confidence*=.998}evolveAgents(){this.agents.sort((t,i)=>i.confidence-t.confidence),this.agents.length>this.maxAgents&&(this.agents=this.agents.slice(0,this.maxAgents));const t=this.agents[0];if(t.confidence>.7&&this.agents.length<this.maxAgents){const i=1+.02*(Math.random()-.5),e=this.createAgent(t.bpm*i,t.subdivision);e.confidence=.8*t.confidence,this.agents.push(e)}this.agents=this.agents.filter(t=>t.confidence>.1)}checkConvergence(){if(0===this.agents.length)return;const t=this.agents[0];return t.confidence>this.convergenceThreshold&&this.agents.filter(i=>Math.abs(i.effectiveBPM-t.effectiveBPM)/t.effectiveBPM<.05).length>=Math.min(2,.3*this.agents.length)&&(this.lockedBPM=Math.round(t.bpm),this.confidence=t.confidence,this.autoSelectSubdivision(),!0)}autoSelectSubdivision(){for(const[t,i]of Object.entries(this.subdivisionPreference))if(this.lockedBPM>=i.min&&this.lockedBPM<i.max&&this.agents.find(t=>Math.abs(t.bpm-this.lockedBPM)<2&&Math.abs(t.subdivision-i.prefer)<.1))return i.prefer;return 1}getFFTEstimate(){if(this.peakHistory.length<4)return 120;const t=this.peakHistory.slice(-10),i=[];for(let e=1;e<t.length;e++)i.push(t[e].time-t[e-1].time);if(0===i.length)return 120;i.sort((t,i)=>t-i);let e=6e4/i[Math.floor(i.length/2)];return e<this.minBPM?e*=2:e>this.maxBPM&&(e/=2),Math.max(this.minBPM,Math.min(this.maxBPM,e))}reset(t=null){this.agents=[],this.confidence=0,this.lockedBPM=0,this.peakHistory=[],t&&this.initializeAgents(t)}getBPM(){return this.lockedBPM>0&&this.confidence>.8?this.lockedBPM:this.agents.length>0?Math.round(this.agents[0].bpm):0}getSubdivision(){if(this.agents.length>0){const t=this.agents[0],{bpm:i}=t;for(const[t,e]of Object.entries(this.subdivisionPreference))if(i>=e.min&&i<e.max)return e.prefer;return t.subdivision}return 1}getStatus(){return{bpm:this.getBPM(),subdivision:this.getSubdivision(),confidence:this.confidence,locked:this.lockedBPM>0&&this.confidence>.8,agentCount:this.agents.length,topAgents:this.agents.slice(0,3).map(t=>({bpm:Math.round(t.bpm),subdivision:t.subdivision,confidence:t.confidence.toFixed(2)}))}}}class Fe{constructor(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.onsetThreshold=.3,this.detectedBPM=0,this.bpmConfidence=0,this.lastBPMCalculation=0,this.bpmCalculationInterval=2e3,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.agentDetector=new Se,this.useAgentDetection=!0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.downbeatPhase=0,this.measureLength=4,this.measureStartTime=0,this.isMusicalContent=!1,this.musicalityScore=0,this.forceFastDetection=!1}calculateBPM(){if(this.useAgentDetection){const t=this.agentDetector.getStatus();if(t.locked&&t.confidence>.6)return this.detectedBPM=t.bpm,this.bpmConfidence=t.confidence,this.tempoLocked=!0,this.fundamentalBPM=t.bpm,this.bpmHistory.push(this.detectedBPM),this.bpmHistory.length>10&&this.bpmHistory.shift(),this.detectedBPM;if(t.bpm>0&&t.confidence>.4)return this.detectedBPM=t.bpm,this.bpmConfidence=t.confidence,t.confidence>.6&&(this.tempoLocked=!0),this.detectedBPM}if(this.onsetIntervals.length<4)return this.detectedBPM;const t=this.onsetIntervals.slice(-15),i=this.findTempoCandidates(t);if(0===i.length)return this.detectedBPM;const e=i[0],s=Math.round(6e4/e.interval);if(!this.tempoLocked&&this.bpmHistory.length>3){const t=this.bpmHistory.slice(-3),i=t.reduce((t,i)=>t+i,0)/t.length;t.reduce((t,e)=>t+Math.pow(e-i,2),0)/t.length<5&&(this.fundamentalBPM=Math.round(i),this.tempoLocked=!0,this.bpmConfidence=1)}let n=s;if(this.tempoLocked&&(this.checkHarmonicRelation(s,this.fundamentalBPM)?(n=this.fundamentalBPM,this.bpmConfidence=Math.min(1,this.bpmConfidence+.1)):(this.bpmConfidence*=.9,this.bpmConfidence<.3&&e.strength>.8?(this.fundamentalBPM=s,this.bpmConfidence=.5):n=this.fundamentalBPM)),this.bpmHistory.push(n),this.bpmHistory.length>10&&this.bpmHistory.shift(),0===this.detectedBPM)this.detectedBPM=n;else{const t=this.tempoLocked?1:2,i=n-this.detectedBPM;Math.abs(i)<=t?this.detectedBPM=n:this.detectedBPM+=Math.sign(i)*t}return window.rhythmIntegration&&window.rhythmIntegration.updateBPM&&(window.rhythmManuallyStoppedForCurrentAudio||window.rhythmIntegration.updateBPM(this.detectedBPM)),this.detectedBPM}findTempoCandidates(t){const i=[];for(const e of[1,2,4]){const s=t.map(t=>t*e),n=this.clusterIntervals(s);for(const s of n){const n=s.intervals.reduce((t,i)=>t+i,0)/s.intervals.length/e,h=s.intervals.length/t.length*s.consistency,a=6e4/n,r=a>=120&&a<=140?.2:0;a>=60&&a<=220&&i.push({interval:n,strength:h+r,multiplier:e})}}return i.sort((t,i)=>i.strength-t.strength)}clusterIntervals(t){const i=[...t].sort((t,i)=>t-i),e=[];let s=[i[0]];for(let t=1;t<i.length;t++){const n=.03*s[0];if(i[t]-s[0]<=n)s.push(i[t]);else{if(s.length>=2){const t=s.reduce((t,i)=>t+i,0)/s.length,i=1/(1+s.reduce((i,e)=>i+Math.pow(e-t,2),0)/s.length/(t*t));e.push({intervals:s,consistency:i})}s=[i[t]]}}if(s.length>=3){const t=s.reduce((t,i)=>t+i,0)/s.length,i=1/(1+s.reduce((i,e)=>i+Math.pow(e-t,2),0)/s.length/(t*t));e.push({intervals:s,consistency:i})}return e}checkHarmonicRelation(t,i){const e=Math.max(t,i)/Math.min(t,i);return[2,1.5,1.333,1.25].some(t=>Math.abs(e-t)<.03)}detectTimeSignature(){const t=this.forceFastDetection?6:12;if(0===this.detectedBPM||this.onsetStrengths.length<t)return this.timeSignature;if(this.timeSignatureLocked&&!this.forceFastDetection)return this.detectedTimeSignature||this.timeSignature;const i=6e4/this.detectedBPM,e=new Array(4).fill(0).map(()=>({strength:0,bassWeight:0,count:0})),s=this.onsetStrengths.slice(-Math.min(20,this.onsetStrengths.length));if(0===s.length)return this.timeSignature;const n=s[0].time;for(const t of s){const s=(t.time-n)/i%4,h=Math.round(s)%4;e[h].strength+=t.strength,e[h].bassWeight+=t.bassWeight||0,e[h].count++}for(const t of e)t.count>0&&(t.strength/=t.count,t.bassWeight/=t.count);let h="4/4";e[0].strength>2*e[1].strength&&e[0].strength>2*e[2].strength&&e[3].count<.5*e[0].count&&this.testWaltzPattern(s,i)>.8&&(h="3/4"),this.timeSignatureHistory.push(h),this.timeSignatureHistory.length>3&&this.timeSignatureHistory.shift();const a=this.forceFastDetection?2:3;if(this.timeSignatureHistory.length>=a){const t={};for(const i of this.timeSignatureHistory)t[i]=(t[i]||0)+1;let i="4/4",e=0;for(const[s,n]of Object.entries(t))n>e&&(e=n,i=s);if(e>=2){this.detectedTimeSignature=i,this.timeSignatureLocked=!0,this.timeSignatureConfidence=e/3,window.rhythmIntegration&&window.rhythmIntegration.setTimeSignature&&window.rhythmIntegration.setTimeSignature(this.detectedTimeSignature);const t=document.getElementById("time-sig-display");t&&(t.textContent=this.detectedTimeSignature)}}return this.detectedTimeSignature||this.timeSignature}testWaltzPattern(t,i){let e=0,s=0;for(let i=0;i<t.length-2;i+=3)if(i+2<t.length){s++;const n=t[i].strength+(t[i].bassWeight||0),h=t[i+1].strength+(t[i+1].bassWeight||0),a=t[i+2].strength+(t[i+2].bassWeight||0);n>1.5*h&&n>1.5*a&&e++}return s>0?e/s:0}addOnset(t,i,e=0){if(this.useAgentDetection&&this.agentDetector.processPeak(i,t),this.lastOnsetTime>0){const i=t-this.lastOnsetTime;i>273&&i<1e3&&(this.onsetIntervals.push(i),this.onsetIntervals.length>20&&this.onsetIntervals.shift())}this.onsetStrengths.push({time:t,strength:i,bassWeight:e}),this.onsetStrengths.length>40&&this.onsetStrengths.shift(),this.lastOnsetTime=t}update(t){t-this.lastBPMCalculation>this.bpmCalculationInterval&&(this.calculateBPM(),this.detectTimeSignature(),this.lastBPMCalculation=t)}getRecommendedSubdivision(){return this.useAgentDetection?this.agentDetector.getSubdivision():this.detectedBPM<60?2:this.detectedBPM<80?1:this.detectedBPM>180||this.detectedBPM>140?.5:1}reset(){this.onsetIntervals=[],this.onsetStrengths=[],this.lastOnsetTime=0,this.detectedBPM=0,this.bpmConfidence=0,this.bpmHistory=[],this.tempoLocked=!1,this.fundamentalBPM=0,this.timeSignature="4/4",this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.timeSignatureHistory=[],this.agentDetector&&this.agentDetector.reset(),this.timeSignatureLocked=!1,this.isMusicalContent=!1,this.forceFastDetection=!1}getMusicInfo(){return{bpm:this.detectedBPM,confidence:this.bpmConfidence,timeSignature:this.timeSignature,isMusical:this.isMusicalContent,musicalityScore:this.musicalityScore}}}class ke{constructor(t){this.morpher=t,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=800,this.transitionProgress=0,this.easingFunction="easeInOutQuad",this.currentShape="circle",this.targetShape=null,this.previousShape=null,this.morphQueue=[],this.maxQueueSize=3,this.shadowConfig=null,this.shadowProgress=0}startTransition(t,i={}){this.isTransitioning&&this.morphQueue.length<this.maxQueueSize?this.morphQueue.push({shape:t,options:i}):(this.previousShape=this.currentShape,this.targetShape=t,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.transitionDuration=i.duration||800,this.easingFunction=i.easing||"easeInOutQuad",this.transitionProgress=0,this.shadowConfig=this.getTransitionConfig(this.currentShape,t))}update(t){if(!this.isTransitioning)return;const i=performance.now()-this.transitionStartTime,e=Math.min(1,i/this.transitionDuration);this.transitionProgress=this.applyEasing(e),this.shadowConfig&&(this.shadowProgress=this.calculateShadowProgress(e)),e>=1&&this.completeTransition()}completeTransition(){if(this.currentShape=this.targetShape,this.targetShape=null,this.isTransitioning=!1,this.transitionProgress=0,this.shadowConfig=null,this.morphQueue.length>0){const t=this.morphQueue.shift();this.startTransition(t.shape,t.options)}}getTransitionConfig(t,i){return{"circle-heart":{type:"bloom",shadowColor:"#ff69b4",shadowIntensity:.3},"heart-circle":{type:"contract",shadowColor:"#ff69b4",shadowIntensity:.2},"circle-star":{type:"burst",shadowColor:"#ffd700",shadowIntensity:.4},"star-circle":{type:"collapse",shadowColor:"#ffd700",shadowIntensity:.3}}[`${t}-${i}`]||null}calculateShadowProgress(t){if(!this.shadowConfig)return 0;switch(this.shadowConfig.type){case"bloom":return t<.5?2*t:2-2*t;case"burst":return Math.pow(1-t,2);case"contract":case"collapse":return Math.sin(t*Math.PI);default:return 0}}applyEasing(t){switch(this.easingFunction){case"linear":default:return t;case"easeInQuad":return t*t;case"easeOutQuad":return t*(2-t);case"easeInOutQuad":return t<.5?2*t*t:(4-2*t)*t-1;case"easeInCubic":return t*t*t;case"easeOutCubic":return--t*t*t+1;case"easeInOutCubic":return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}}clearQueue(){this.morphQueue=[]}hasQueuedMorphs(){return this.morphQueue.length>0}getState(){return{isTransitioning:this.isTransitioning,currentShape:this.currentShape,targetShape:this.targetShape,progress:this.transitionProgress,queueLength:this.morphQueue.length}}reset(){this.isTransitioning=!1,this.currentShape="circle",this.targetShape=null,this.transitionProgress=0,this.morphQueue=[],this.shadowConfig=null}}class xe{constructor(t={}){this.numPoints=t.numPoints||64,this.morphDuration=t.morphDuration||1e3,this.easing=t.easing||"easeInOutCubic",this.transitionManager=new ke(this),this.audioDeformer=new ve(this),this.musicDetector=new Fe,this.currentShape="circle",this.targetShape=null,this.morphProgress=0,this.visualProgress=0,this.morphStartTime=null,this.isTransitioning=!1,this.shapeCache=new Map,this.currentPoints=[],this.targetPoints=[],this.musicalDuration=null,this.onBeat=!1,this.audioDeformation=0,this.vocalEnergy=0,this.lastAudioUpdate=0,this.lastVocalUpdate=0,this.audioUpdateInterval=33,this.audioAnalyzer=null,this.frequencyData=we.acquire(32,"float32"),this.glitchPoints=[],this.undulationPhase=0,this.undulationDirection=1,this.beatGlitchIntensity=0,this.bassEnergy=0,this.vocalPresence=0,this.bassHistory=we.acquire(60,"float32"),this.vocalHistory=we.acquire(60,"float32"),this.historyIndex=0,this.bassEffectCooldown=0,this.vocalEffectCooldown=0,this.bassThresholdMultiplier=1.2,this.vocalThresholdMultiplier=1.1,this.bassEffectActive=!1,this.vocalEffectActive=!1,this.transientHoldTime=0,this.vocalGlowBoost=0,this.onComplete=null,this.onProgress=null,this.queuedMorph=null,this.currentPoints=this.getShapePoints("circle"),this.shapesLoaded=!0,this.prewarmCache()}prewarmCache(){["circle","heart","star","sun","moon","lunar","square","triangle"].forEach(t=>{(be&&be.isInitialized?be.hasShape(t):Me[t])&&this.getShapePoints(t)}),[0,.25,.5,.75,1].forEach(t=>{this.applyEasing(t)})}getShapePoints(t){if(!this.shapeCache.has(t)){const i=be&&be.isInitialized?be.getShape(t):Me[t];if(!i||!i.points){const i=Me.circle.points;return this.shapeCache.set(t,i),i}const{points:e}=i;return this.shapeCache.set(t,e),e}return this.shapeCache.get(t)}morphTo(t,i={}){if(!this.shapesLoaded)return;if(t===this.currentShape&&!this.isTransitioning)return;if(this.isTransitioning&&!i.force)return this.queuedMorph={targetShape:t,options:i},"queued";this.isTransitioning&&i.force&&this.completeMorph(!0);const e=this.getTransitionConfig(this.currentShape,t);if(this.targetShape=t,this.targetPoints=this.getShapePoints(t),this.morphStartTime=Date.now(),this.isTransitioning=!0,this.morphProgress=0,this.visualProgress=0,"bar"===i.duration||"beat"===i.duration){const t=6e4/(ci.bpm||120);"bar"===i.duration?this.morphDuration=4*t:this.morphDuration=t,this.musicalDuration=!0,this.onBeat=!1!==i.onBeat}else this.morphDuration=e?.duration||i.duration||1e3,this.musicalDuration=null,this.onBeat=!1;this.morphMode=i.mode||"smooth",this.transitionConfig=e,this.onComplete=i.onComplete,this.onProgress=i.onProgress}update(t){if(this.audioAnalyzer&&this.audioAnalyzer.isAnalyzing){const t=this.audioAnalyzer.getShapeMorpherData();if(t&&t.frequencies){let i=!1;for(let e=0;e<Math.min(t.frequencies.length,this.frequencyData.length);e++)this.frequencyData[e]=t.frequencies[e],t.frequencies[e]>0&&(i=!0);i&&!this.A&&(this.A=!0)}}if(this.musicDetector&&this.musicDetector.update(performance.now()),!this.isTransitioning||!this.targetShape)return;const i=Date.now()-this.morphStartTime;if(this.musicalDuration){const t=6e4/(ci.bpm||120),i=this.morphDuration>2*t;this.morphDuration=i?4*t:t}let e=Math.min(i/this.morphDuration,1);if(this.musicalDuration&&this.onBeat){const t=ci.bpm||120;let i;i=t>140?2:t>100?4:8;const s=6e4/t,n=this.morphDuration/s,h=e*n,a=Math.round(h*i)/i,r=Math.min(1,a/n),o=(.3+.5*(t<90?Math.max(.3,(t-60)/30):Math.max(.4,Math.min(1,1-(t-90)/90))))*(.3+.7*Math.sin(e*Math.PI));e+=o*o*(3-2*o)*(r-e)}this.morphProgress=this.applyEasing(e),this.visualProgress=.8*this.visualProgress+.2*this.morphProgress,Math.abs(this.visualProgress-this.morphProgress)<.001&&(this.visualProgress=this.morphProgress),this.onProgress&&this.onProgress(this.morphProgress),this.morphProgress>=1&&(this.visualProgress=1,this.completeMorph())}completeMorph(t=!1){if(this.targetShape&&(this.currentShape=this.targetShape,this.currentPoints=[...this.targetPoints]),this.targetShape=null,this.isTransitioning=!1,this.morphProgress=0,this.visualProgress=0,this.onComplete&&this.onComplete(this.currentShape),!t&&this.queuedMorph){const t=this.queuedMorph;this.queuedMorph=null,setTimeout(()=>{this.morphTo(t.targetShape,t.options)},50)}}hasQueuedMorph(){return null!==this.queuedMorph}clearQueue(){this.queuedMorph=null}getCanvasPoints(t,i,e){let s;try{s=this.getInterpolatedPoints()}catch(t){s=this.generateFallbackCircle()}this.canvasPointsCache||(this.canvasPointsCache=[]);const n=this.canvasPointsCache;if(n.length=0,!s||0===s.length){for(let s=0;s<this.numPoints;s++){const h=s/this.numPoints*Math.PI*2;n.push({x:t+Math.cos(h)*e,y:i+Math.sin(h)*e})}return n}const h=Array.isArray(s)?s:[];for(let s=0;s<h.length;s++){const a=h[s];if(a&&"number"==typeof a.x&&"number"==typeof a.y){const s=t+(a.x-.5)*e*2,h=i+(a.y-.5)*e*2;n.push({x:s,y:h})}else{const a=s/h.length*Math.PI*2;n.push({x:t+Math.cos(a)*e,y:i+Math.sin(a)*e})}}for(;n.length<this.numPoints;){const s=n.length/this.numPoints*Math.PI*2;n.push({x:t+Math.cos(s)*e,y:i+Math.sin(s)*e})}return n}getInterpolatedPoints(){if(this.currentPoints&&0!==this.currentPoints.length||(this.currentPoints=this.generateFallbackCircle()),!this.isTransitioning)return this.applyAudioDeformation(this.currentPoints);const t=[];for(let i=0;i<this.numPoints;i++){const e=this.currentPoints[i],s=this.targetPoints[i];if(!e||!s){const e=i/this.numPoints*Math.PI*2;t.push({x:.5+.5*Math.cos(e),y:.5+.5*Math.sin(e)});continue}const n=this.visualProgress;let h,a;const r=["square","circle","star","triangle"],o=r.includes(this.currentShape),c=r.includes(this.targetShape);if(o||c){const t=.5,i=.5;if(c&&!o){const r=s.x-t,o=s.y-i;if(this.applyEasing(n),n<.3){const s=n/.3;h=e.x+(t-e.x)*s,a=e.y+(i-e.y)*s}else{const e=(n-.3)/.7;h=t+r*e,a=i+o*e}}else if(o&&!c){const r=e.x-t,o=e.y-i;if(n<.5){const t=n/.5;h=e.x-r*t,a=e.y-o*t}else{const e=(n-.5)/.5;h=t+(s.x-t)*e,a=i+(s.y-i)*e}}else{const r=e.x-t,o=e.y-i,c=s.x-t,l=s.y-i;if(n<.5){const t=n/.5;h=e.x-r*t,a=e.y-o*t}else{const e=(n-.5)/.5;h=t+c*e,a=i+l*e}}}else if("spiral"===this.morphMode){const t=n*Math.PI*2,r=.02*Math.sin(t+.2*i)*(1-2*Math.abs(n-.5));h=e.x+(s.x-e.x)*n+r,a=e.y+(s.y-e.y)*n+r}else if("wave"===this.morphMode){const t=.01*Math.sin(.3*i+n*Math.PI*4);h=e.x+(s.x-e.x)*n+t,a=e.y+(s.y-e.y)*n+t}else h=e.x+(s.x-e.x)*n,a=e.y+(s.y-e.y)*n;t.push({x:h,y:a})}return this.applyAudioDeformation(t)}applyAudioDeformation(t){return this.audioDeformer.applyAudioDeformation(t)}setAudioDeformation(t){const i=Date.now();i-this.lastAudioUpdate>this.audioUpdateInterval&&(this.audioDeformation=Math.max(-1,Math.min(1,t)),this.lastAudioUpdate=i,this.audioDeformer&&this.audioDeformer.setAudioDeformation(Math.abs(this.audioDeformation)))}setVocalEnergy(t){const i=Date.now();i-this.lastVocalUpdate>this.audioUpdateInterval&&(this.vocalEnergy=Math.max(0,Math.min(1,t)),this.lastVocalUpdate=i,this.audioDeformer&&this.audioDeformer.setVocalEnergy(this.vocalEnergy))}getTransitionConfig(t,i){const e=be&&be.isInitialized?be.getShape(t):Me[t],s=be&&be.isInitialized?be.getShape(i):Me[i];return"moon"===i?{type:"to_moon",easing:"easeInOutCubic",duration:1500,glowIntensity:1.5,fadeInCrescent:!0}:"moon"===t&&"lunar"===i?{type:"moon_to_lunar",easing:"easeInOutSine",duration:2e3,slideOutCrescent:!1,description:"Crescent shadow moves to center and becomes lunar eclipse"}:"moon"===t?{type:"from_moon",easing:"easeInOutCubic",duration:1e3,slideOutCrescent:!0,shadowSlideRatio:.4,description:"Moon shadow slides away THEN morphs to target"}:"lunar"===i?{type:"eclipse_enter_lunar",startAngle:-30}:"lunar"===t&&"moon"===i?{type:"lunar_to_moon",exitAngle:-30}:"lunar"===t?{type:"eclipse_exit_lunar",exitAngle:-30}:"none"===e?.shadow?.type&&"solar"===s?.shadow?.type?{type:"eclipse_enter",direction:"right"}:"solar"===e?.shadow?.type&&"none"===s?.shadow?.type?{type:"eclipse_exit",direction:"left"}:"sun"===t&&"sun"!==i?{type:"sun_fade",fadeEffects:!0}:"sun"!==t&&"sun"===i?{type:"sun_bloom",bloomEffects:!0}:{type:"standard"}}getCurrentShadow(){const t=this.currentShape||"circle",i=be&&be.isInitialized?be.getShape(t):Me[t],e=this.targetShape?be&&be.isInitialized?be.getShape(this.targetShape):Me[this.targetShape]:null,s=i?.shadow||{type:"none"},n=e?.shadow||null;if(!this.isTransitioning||!n)return s;const h=this.morphProgress;if(this.transitionConfig&&"from_moon"===this.transitionConfig.type&&this.transitionConfig.slideOutCrescent){const t=this.transitionConfig.shadowSlideRatio||.4;if(h<t){const i=h/t,e=-30*Math.PI/180,s=.7,n=s+(2.5-s)*i;return{type:"crescent",coverage:i>.8?.85*(1-5*(i-.8)):.85,angle:-30,offset:n,shadowX:Math.cos(e)*n,shadowY:Math.sin(e)*n}}return{type:"none"}}if(this.transitionConfig&&"moon_to_lunar"===this.transitionConfig.type){const t=this.transitionConfig.startAngle*Math.PI/180,i=1-h,e=.7*Math.cos(t)*i,s=.7*Math.sin(t)*i,n=Math.pow(h,2);if(h<.6)return{type:"crescent",coverage:.85*(1-.2*n),angle:this.transitionConfig.startAngle,offset:.7*i,shadowX:e,shadowY:s};{const t=(h-.6)/.4,i=Math.sin(t*Math.PI/2);return{type:"lunar",coverage:.85+.1*i,color:`rgba(80, 20, 0, ${.7+.2*i})`,shadowX:e*(1-i),shadowY:s*(1-i),diffusion:i,shadowProgress:h}}}if(this.transitionConfig&&"eclipse_enter_lunar"===this.transitionConfig.type){if(h<.3)return{type:"none"};const t=(h-.3)/.7,i=Math.sin(t*Math.PI/2),e=this.transitionConfig.startAngle*Math.PI/180,s=1-i,n=.7*Math.cos(e)*s,a=.7*Math.sin(e)*s;if(t<.7)return{type:"crescent",coverage:.85*Math.pow(t/.7,.5),angle:this.transitionConfig.startAngle,offset:.7*s,shadowX:n,shadowY:a};{const i=(t-.7)/.3,e=Math.sin(i*Math.PI/2);return{type:"lunar",coverage:.85+.1*e,color:`rgba(80, 20, 0, ${.6+.3*e})`,shadowX:n*(1-e),shadowY:a*(1-e),diffusion:e,shadowProgress:t}}}if(this.transitionConfig&&"lunar_to_moon"===this.transitionConfig.type){const t=this.transitionConfig.exitAngle*Math.PI/180,i=Math.sin(h*Math.PI/2),e=.7*Math.cos(t)*i,s=.7*Math.sin(t)*i;if(h<.6){const t=h/.6,i=Math.pow(t,.7);return{type:"lunar",coverage:.95-.1*i,color:`rgba(80, 20, 0, ${.9-.3*i})`,shadowX:.7*e,shadowY:.7*s,diffusion:1-i}}{const t=(h-.6)/.4;return{type:"crescent",coverage:.85*Math.sin(t*Math.PI/2)+.1,angle:this.transitionConfig.exitAngle,offset:.7,shadowX:e,shadowY:s}}}if(this.transitionConfig&&"eclipse_exit_lunar"===this.transitionConfig.type){if(h<.7){const t=h/.7,i=this.transitionConfig.exitAngle*Math.PI/180;if(t<.4){const e=t/.4,s=1-e,n=.3*e;return{type:"lunar",coverage:.95-.1*e,color:`rgba(80, 20, 0, ${.9-.2*e})`,shadowX:.7*Math.cos(i)*n,shadowY:.7*Math.sin(i)*n,diffusion:s}}{const e=(t-.4)/.6,s=Math.pow(e,.8),n=.7*Math.cos(i)*s,h=.7*Math.sin(i)*s;return{type:"crescent",coverage:.85*(1-Math.pow(e,2)),angle:this.transitionConfig.exitAngle,offset:.7*s,shadowX:n,shadowY:h}}}return{type:"none"}}if(this.transitionConfig&&"eclipse_enter"===this.transitionConfig.type){const t=1.5-1.5*h;return{...n,shadowX:t,shadowProgress:h}}if("eclipse_exit"===this.transitionConfig.type){const t=1.5*-h;return{...s,coverage:s.coverage*(1-h),shadowX:t,shadowProgress:1-h}}if("sun_fade"===this.transitionConfig.type){const t=1-h;return{...s,intensity:(s.intensity||1)*Math.pow(t,.7),corona:s.corona,coronaOpacity:t,flares:s.flares,flaresOpacity:Math.pow(t,1.5),texture:s.texture,textureOpacity:Math.pow(t,2),turbulence:(s.turbulence||.3)*t}}if("sun_bloom"===this.transitionConfig.type){const t=h;return{...n,intensity:(n.intensity||1)*Math.pow(t,1.5),corona:n.corona,coronaOpacity:Math.pow(t,.8),flares:n.flares,flaresOpacity:t>.3?Math.pow((t-.3)/.7,.7):0,texture:n.texture,textureOpacity:t>.5?Math.pow((t-.5)/.5,2):0,turbulence:(n.turbulence||.3)*t}}if("none"!==s.type||"none"!==n.type){const t=(s.coverage||0)+((n.coverage||0)-(s.coverage||0))*h;return{type:"none"!==n.type?n.type:s.type,coverage:t,angle:n.angle||s.angle||0,softness:n.softness||s.softness||.2,progress:h}}return s}getCurrentRenderer(){return null}applyEasing(t){switch(this.transitionConfig?.easing||this.easing||"linear"){case"linear":return t;case"easeInQuad":return t*t;case"easeOutQuad":return t*(2-t);case"easeInOutQuad":return t<.5?2*t*t:(4-2*t)*t-1;case"easeInOutSine":return-(Math.cos(Math.PI*t)-1)/2;default:return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}calculateBPM(){return this.musicDetector.calculateBPM()}findTempoCandidates(t){return this.musicDetector.findTempoCandidates(t)}clusterIntervals(t){return this.musicDetector.clusterIntervals(t)}checkHarmonicRelation(t,i){return this.musicDetector.checkHarmonicRelation(t,i)}detectTimeSignature(){this.musicDetector.forceFastDetection=this.forceFastDetection;const t=this.musicDetector.detectTimeSignature();return this.detectedTimeSignature=this.musicDetector.detectedTimeSignature,this.timeSignatureConfidence=this.musicDetector.timeSignatureConfidence,this.timeSignatureLocked=this.musicDetector.timeSignatureLocked,t}testWaltzPattern(t,i){return this.musicDetector.testWaltzPattern(t,i)}resetMusicDetection(){this.forceFastDetection=!0,this.musicDetector.reset(),this.musicDetector.forceFastDetection=!0,this.onsetThreshold=0,this.detectedBPM=0,this.bpmConfidence=0,this.onsetStrengths=[],this.detectedTimeSignature=null,this.timeSignatureConfidence=0,this.musicDetector.lastBPMCalculation=0,this.measureStartTime=0,this.timeSignatureHistory=[],this.timeSignatureLocked=!1,this.spectralHistory=[],this.spectralFluxHistory=[];const t=document.getElementById("time-sig-display");t&&(t.textContent="â€”")}getCurrentMusicInfo(){return{bpm:this.detectedBPM,timeSignature:this.detectedTimeSignature,bpmLocked:this.tempoLocked,timeSigLocked:this.timeSignatureLocked}}generateFallbackCircle(){const t=[];for(let i=0;i<this.numPoints;i++){const e=i/this.numPoints*Math.PI*2;t.push({x:.5+.5*Math.cos(e),y:.5+.5*Math.sin(e)})}return t}getState(){return{currentShape:this.currentShape,targetShape:this.targetShape,isTransitioning:this.isTransitioning,progress:this.morphProgress,audioDeformation:this.audioDeformation,vocalEnergy:this.vocalEnergy}}getProgress(t=!0){return t?this.visualProgress:this.morphProgress}isInTransition(){return this.isTransitioning}}class Be{constructor(){this.audioContext=null,this.analyser=null,this.source=null,this.elementSource=null,this.dataArray=null,this.isAnalyzing=!1,this.connectedElement=null,this.gainNode=null,this.frequencyBands=32,this.smoothingFactor=.3,this.vocalRange={min:80,max:1e3},this.currentAmplitude=0,this.currentFrequencies=new Array(this.frequencyBands).fill(0),this.beatThreshold=.3,this.lastBeatTime=0,this.beatCallbacks=[]}init(){try{return this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state?this.audioContext.resume().then(()=>(this.createAnalyser(),!0)).catch(()=>!1):(this.createAnalyser(),!0)}catch(t){return!1}}createAnalyser(){if(this.audioContext&&!this.analyser){this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.5;const t=this.analyser.frequencyBinCount;this.dataArray=new Uint8Array(t)}}connectAudioElement(t){if(this.audioContext)try{this.elementSource&&this.connectedElement===t||(this.elementSource=this.audioContext.createMediaElementSource(t),this.elementSource.connect(this.analyser),this.elementSource.connect(this.audioContext.destination)),this.source=this.elementSource,this.connectedElement=t,this.isAnalyzing=!0,this.analyze()}catch(i){i.message&&i.message.includes("already been used")&&(this.source=this.elementSource,this.connectedElement=t,this.isAnalyzing=!0,this.analyze())}}analyze(){if(!this.isAnalyzing)return;requestAnimationFrame(()=>this.analyze()),this.analyser.getByteFrequencyData(this.dataArray);const t=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteTimeDomainData(t);let i=0,e=0,s=0;const n=this.audioContext.sampleRate/2/this.dataArray.length,h=Math.floor(this.vocalRange.min/n),a=Math.ceil(this.vocalRange.max/n);for(let t=0;t<this.dataArray.length;t++){const n=this.dataArray[t]/255;i+=n,t>=h&&t<=a&&(e+=n,s++)}this.currentAmplitude=i/this.dataArray.length;const r=s>0?e/s:0;return this.extractFrequencyBands(),this.detectBeat(this.currentAmplitude),{amplitude:this.currentAmplitude,vocalAmplitude:r,frequencies:this.currentFrequencies,rawData:this.dataArray}}extractFrequencyBands(){const t=Math.floor(this.dataArray.length/this.frequencyBands);for(let i=0;i<this.frequencyBands;i++){let e=0;const s=i*t,n=Math.min(s+t,this.dataArray.length);for(let t=s;t<n;t++)e+=this.dataArray[t]/255;const h=e/t;this.currentFrequencies[i]=this.currentFrequencies[i]*this.smoothingFactor+h*(1-this.smoothingFactor)}}detectBeat(t){const i=performance.now();t>this.beatThreshold&&i-this.lastBeatTime>60&&(this.lastBeatTime=i,this.beatCallbacks.forEach(i=>i(t)))}getVocalInstability(){let t=0;const i=this.currentFrequencies.reduce((t,i)=>t+i,0)/this.frequencyBands;for(let e=0;e<this.frequencyBands;e++)t+=Math.pow(this.currentFrequencies[e]-i,2);return t=Math.sqrt(t/this.frequencyBands),Math.min(1,2*t+.5*this.currentAmplitude)}getShapeMorpherData(){return{instability:this.getVocalInstability(),frequencies:[...this.currentFrequencies],amplitude:this.currentAmplitude}}onBeat(t){this.beatCallbacks.push(t)}stop(){if(this.isAnalyzing=!1,this.gainNode){try{this.gainNode.disconnect()}catch(t){}this.gainNode=null}if(this.elementSource&&this.connectedElement){try{this.elementSource.connect(this.analyser)}catch(t){}this.source=this.elementSource}}async resume(){this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume()}destroy(){this.stop(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.dataArray=null,this.beatCallbacks=[]}}class Pe{constructor(){this.timingClasses={downbeat:{gestures:["bounce","jump","headBob","spin","orbit"],timing:1,priority:1,description:"Strong emphasis on the downbeat"},upbeat:{gestures:["wave","nod","point","reach"],timing:.5,priority:2,description:"Medium emphasis on upbeat"},offbeat:{gestures:["wiggle","sway","lean","tilt","groove"],timing:.5,priority:3,description:"Syncopated, creates groove"},subdivision:{gestures:["pulse","sparkle","flash","shimmer","flicker"],timing:.25,priority:4,description:"Quick accents and fills"},continuous:{gestures:["breathe","float","rain"],timing:-1,priority:5,description:"Ambient, continuous motion"}},this.fillPatterns={subtle:["breathe","float"],rhythmic:["pulse","shimmer"],energetic:["wiggle","sparkle"],smooth:["sway","glow"]},this.densityProfiles={sparse:{fillProbability:.1,subdivisionLevel:2,description:"Minimal movement"},moderate:{fillProbability:.3,subdivisionLevel:4,description:"Balanced movement"},dense:{fillProbability:.5,subdivisionLevel:8,description:"Busy, energetic"},chaos:{fillProbability:.8,subdivisionLevel:16,description:"Maximum energy"}},this.groups={movement:{gestures:["bounce","spin","orbit","sway","hula","jump","twist","groove"],maxSimultaneous:1,priority:1,description:"Primary body movements - mutually exclusive"},expression:{gestures:["wave","nod","shake","point","lean","tilt","reach"],maxSimultaneous:2,priority:2,description:"Expressive gestures - can combine up to 2"},dance:{gestures:["headBob","wiggle","runningman","charleston"],maxSimultaneous:1,priority:2,description:"Dance moves - one at a time but can add effects"},effects:{gestures:["pulse","glow","sparkle","flash","shimmer","flicker"],maxSimultaneous:-1,priority:3,description:"Visual effects - all can layer together"},modifiers:{gestures:["breathe","float","rain"],maxSimultaneous:-1,priority:4,description:"Ambient effects - always allowed"}},this.enhancingCombinations=[["bounce","sparkle"],["spin","glow"],["wave","pulse"],["nod","pulse"],["jump","flash"],["sway","breathe"],["float","shimmer"],["orbit","sparkle"],["headBob","pulse"]],this.incompatiblePairs=[["bounce","jump"],["spin","orbit"],["wave","point"],["nod","shake"],["lean","tilt"]],this.chords={celebrate:["bounce","sparkle","pulse"],greeting:["wave","nod","glow"],excited:["jump","flash","wiggle"],mystical:["float","shimmer","breathe"],party:["headBob","pulse","sparkle"],smooth:["sway","glow","breathe"],dramatic:["spin","flash","sparkle"]},this.chains={rise:"breathe > sway+lean+tilt",flow:"sway > lean+tilt > spin > bounce",burst:"jump > nod > shake > flash",drift:"sway+breathe+float+drift",chaos:"shake+shake > spin+flash > bounce+pulse > twist+sparkle",morph:"expand > contract > morph+glow > expand+flash",rhythm:"pulse > pulse+sparkle > pulse+flicker",spiral:"spin > orbital > twist > orbital+sparkle",routine:"nod > bounce > spin+sparkle > sway+pulse > nod+flash",radiance:"sparkle > pulse+flicker > shimmer",twinkle:"sparkle > flash > pulse+sparkle > shimmer+flicker",stream:"wave > nod+pulse > sparkle > flash",buildup:"pulse > pulse > bounce+sparkle > spin+flash",cascade:"wave > lean > tilt > spin > bounce+glow",celebrate:"bounce+sparkle > spin > jump+flash > nod+pulse",smooth:"sway+breathe > float > orbit+shimmer > sway+glow",custom:"expand > contract > morph > expand+glow",greeting:"wave+glow > nod+pulse > wave",mystical:"float+shimmer > orbit+breathe > spin+sparkle > float+glow"}}canExecuteSimultaneously(t,i){if(t===i)return!1;if(this.incompatiblePairs.some(e=>e.includes(t)&&e.includes(i)))return!1;const e=this.getGestureGroup(t),s=this.getGestureGroup(i);if(e===s){const t=this.groups[e];return t&&1!==t.maxSimultaneous}return!("movement"===e&&"movement"===s||"dance"===e&&"dance"===s)}getGestureGroup(t){for(const[i,e]of Object.entries(this.groups))if(e.gestures.includes(t))return i;return null}getGesturePriority(t){const i=this.getGestureGroup(t);return i?this.groups[i].priority:99}getCompatibleGestures(t){if(!t||0===t.length)return[];if(1===t.length)return t;const i=[],e=new Set,s=t=>"string"==typeof t?t:t.gestureName,n=[...t].sort((t,i)=>this.getGesturePriority(s(t))-this.getGesturePriority(s(i)));for(const t of n){if(e.has(t))continue;const n=s(t);let h=!0;for(const t of i){const i=s(t);if(!this.canExecuteSimultaneously(n,i)){h=!1;break}}if(h){const h=this.groups[this.getGestureGroup(n)];if(h&&h.maxSimultaneous>0&&i.filter(t=>this.getGestureGroup(s(t))===this.getGestureGroup(n)).length>=h.maxSimultaneous)continue;i.push(t),e.add(t)}}return i}parseChain(t){return t?(this.chains[t]&&(t=this.chains[t]),t.split(">").map(t=>t.trim()).map(t=>t.split("+").map(t=>t.trim()).filter(t=>t))):[]}isEnhancingCombination(t){const i=t.map(t=>"string"==typeof t?t:t.gestureName);return this.enhancingCombinations.some(t=>t.every(t=>i.includes(t)))}getChord(t){return this.chords[t]||null}createChord(t){const i=this.getCompatibleGestures(t),e=this.isEnhancingCombination(i);return{type:"chord",gestures:i.map(t=>"string"==typeof t?t:t.gestureName),isEnhancing:e,timestamp:Date.now()}}isValidGesture(t){return null!==this.getGestureGroup(t)}getAllGestures(){const t=[];for(const i of Object.values(this.groups))t.push(...i.gestures);return[...new Set(t)]}getGestureTiming(t){for(const[i,e]of Object.entries(this.timingClasses))if(e.gestures.includes(t))return{name:i,...e};return null}getNextBeatForGesture(t,i,e=1){const s=this.getGestureTiming(t);if(!s)return i+1;if(-1===s.timing)return i;const n=s.timing/e,h=Math.ceil(i/n)*n;return"offbeat"===s.name?h+.5:h}getFillGestures(t,i="moderate"){const e=this.densityProfiles[i]||this.densityProfiles.moderate;let s;return s=t<80?"energetic":t<120?"rhythmic":t<160?"smooth":"subtle",Math.random()<e.fillProbability&&this.fillPatterns[s]||[]}getNextBeatTiming(t,i,e){return this.getNextBeatForGesture(t,i)}getIntensityFromBPM(t){return t<60?"dense":t<100||t<140?"moderate":"sparse"}applySwingTiming(t,i=.67){return.5==t%1?Math.floor(t)+i:t}}const Ce=new Pe;var Ae=Object.freeze({__proto__:null,GestureCompatibility:Pe,default:Ce});class Te{constructor(){this.templates={straight:{name:"Straight",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",pattern:{emphasis:[1,0,.5,0],velocities:[1,0,.6,0],subdivisions:[0,.5]},swing:0,humanization:.05,preferredGestures:{downbeat:["bounce","headBob","jump"],offbeat:["pulse","breathe"],fills:["sparkle","glow"]},compositeMove:null,intensity:"moderate",description:"Standard 4/4 rhythm, good for pop/rock"},swing:{name:"Swing",timeSignature:"4/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:"swingOut",pattern:{emphasis:[1,0,.66,0],velocities:[1,0,.7,0],subdivisions:[0,.66]},swing:.67,humanization:.08,preferredGestures:{downbeat:["sway","lean","bounce"],offbeat:["wiggle","pulse"],fills:["shimmer","float"]},intensity:"moderate",description:"Jazz swing feel with triplet subdivision"},shuffle:{name:"Shuffle",timeSignature:"4/4",baseMovement:"grooveBob",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,.25,.5,.75],velocities:[1,.3,.7,.3],subdivisions:[0,.25,.5,.75]},swing:.75,humanization:.06,preferredGestures:{downbeat:["bounce","headBob"],upbeat:["twist","wiggle"],offbeat:["pulse","breathe"],fills:["sparkle","flash"]},intensity:"dense",description:"Blues/rock shuffle with heavy swing"},latin:{name:"Latin",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"latinHips",pattern:{emphasis:[1,0,.375,.5,0,.75,0,0],velocities:[1,0,.8,.9,0,.8,0,0],subdivisions:[0,.375,.5,.75]},swing:0,humanization:.04,preferredGestures:{downbeat:["sway","wiggle"],syncopation:["twist","lean"],offbeat:["pulse","shimmer"],fills:["sparkle","shake"]},intensity:"dense",description:"Latin clave rhythm with syncopation"},breakbeat:{name:"Breakbeat",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,0,0,.75,.25,.5,0,.625],velocities:[1,0,0,.9,.6,.8,0,.7],subdivisions:[0,.25,.5,.625,.75]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","twist"],syncopation:["flash","shake"],offbeat:["pulse","wiggle"],fills:["sparkle","glitch"]},intensity:"chaos",description:"Hip-hop/DnB breakbeat pattern"},waltz:{name:"Waltz",timeSignature:"3/4",baseMovement:"grooveFlow",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[1,.33,.67],velocities:[1,.5,.5],subdivisions:[0,.33,.67]},swing:0,humanization:.07,preferredGestures:{downbeat:["sway","float"],weak:["breathe","lean"],fills:["shimmer","glow"]},intensity:"sparse",description:"3/4 waltz time"},techno:{name:"Techno",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionLean",compositeMove:"robotPop",pattern:{emphasis:[1,.25,.5,.75,1,.25,.5,.75],velocities:[1,.6,1,.6,1,.6,1,.6],subdivisions:[0,.25,.5,.75]},swing:0,humanization:.02,preferredGestures:{downbeat:["pulse","bounce"],subdivision:["flash","glitch"],fills:["sparkle","strobe"]},intensity:"dense",description:"Driving techno four-on-the-floor"},ambient:{name:"Ambient",timeSignature:"4/4",baseMovement:"groovePulse",transitionStyle:"transitionGlide",compositeMove:null,pattern:{emphasis:[.8,0,.3,0,.5,0,.3,0],velocities:[.8,0,.3,0,.5,0,.3,0],subdivisions:[0,.5]},swing:0,humanization:.15,preferredGestures:{downbeat:["float","breathe"],offbeat:["sway","shimmer"],fills:["glow","pulse"]},intensity:"sparse",description:"Floating ambient rhythm"},funk:{name:"Funk",timeSignature:"4/4",baseMovement:"grooveSway",transitionStyle:"transitionRoll",compositeMove:"funkChicken",pattern:{emphasis:[1.2,.125,.25,0,.625,.75,0,.875],velocities:[1.2,.3,.4,0,.8,.6,0,.4],subdivisions:[0,.125,.25,.625,.75,.875]},swing:.1,humanization:.06,preferredGestures:{one:["bounce","twist"],ghost:["wiggle","pulse"],syncopation:["lean","shake"],fills:["flash","sparkle"]},intensity:"chaos",description:"Funky syncopated rhythm with THE ONE"},trap:{name:"Trap",timeSignature:"4/4",baseMovement:"grooveStep",transitionStyle:"transitionLean",compositeMove:null,pattern:{emphasis:[1,0,0,.375,0,.75,.875,0],velocities:[1,0,0,.7,0,.8,.6,0],subdivisions:[0,.375,.75,.875]},swing:0,humanization:.03,preferredGestures:{downbeat:["bounce","lean"],hihat:["shake","shimmer"],syncopation:["twist","flash"],fills:["sparkle","glitch"]},intensity:"moderate",description:"Trap rhythm with triplet hi-hats"}},this.transitions={instant:0,nextBar:1,nextPhrase:4,fadeIn:8},this.currentGroove=null,this.transitionMode="nextBar",this.pendingGroove=null}getTemplate(t){return this.templates[t.toLowerCase()]||this.templates.straight}getEmphasis(t,i,e){if(!t||!t.pattern)return 0;const s=t.pattern.subdivisions.findIndex(t=>Math.abs(t-e)<.01);return-1===s?0:t.pattern.emphasis[s]||0}getVelocity(t,i,e){if(!t||!t.pattern)return 1;const s=t.pattern.subdivisions.findIndex(t=>Math.abs(t-e)<.01);return-1===s?0:t.pattern.velocities[s]||0}getPreferredGesture(t,i,e,s=[]){if(!t||!t.preferredGestures)return null;let n;n=0===e?"downbeat":.5===e?"offbeat":.25===e||.75===e?"subdivision":"syncopation","Funk"===t.name&&i%4==0&&0===e&&(n="one");const h=t.preferredGestures[n]||t.preferredGestures.fills;if(!h||0===h.length)return null;if(s.length>0){const t=h.filter(t=>s.includes(t));if(t.length>0)return t[Math.floor(Math.random()*t.length)]}return h[Math.floor(Math.random()*h.length)]}humanizeTiming(t,i){if(!t||!t.humanization)return i;const e=t.humanization,s=(Math.random()-.5)*e;return Math.max(0,Math.min(1,i+s))}applySwing(t,i){return t&&t.swing&&0!==t.swing?Math.abs(i-.5)<.01?.5+.5*(t.swing-.5):Math.abs(i-.25)<.01?.25+.25*(t.swing-.5):Math.abs(i-.75)<.01?.75+.25*(t.swing-.5):i:i}setGroove(t,i=null){const e=this.getTemplate(t);return!!e&&("instant"!==(i||this.transitionMode)&&this.currentGroove?this.pendingGroove=e:(this.currentGroove=e,this.pendingGroove=null),!0)}onBeat(t){this.pendingGroove&&("nextBar"===this.transitionMode&&t%4==0||"nextPhrase"===this.transitionMode&&t%16==0)&&(this.currentGroove=this.pendingGroove,this.pendingGroove=null)}getBaseMovement(){return this.currentGroove?.baseMovement||null}getTransitionStyle(){return this.currentGroove?.transitionStyle||"transitionLean"}getCompositeMove(){return this.currentGroove?.compositeMove||null}shouldTriggerComposite(t){return!!this.currentGroove?.compositeMove&&t%("sparse"===this.currentGroove.intensity?32:16)==0}getLayeredGestures(t,i){if(!this.currentGroove)return null;const e={base:this.getBaseMovement(),accent:null,transition:null,composite:null,velocity:1};this.shouldTriggerComposite(t)&&0===i&&(e.composite=this.getCompositeMove());const s=this.getEmphasis(this.currentGroove,t,i),n=this.getVelocity(this.currentGroove,t,i);return s>.3&&n>.3&&(e.accent=this.getPreferredGesture(this.currentGroove,t,i),e.velocity=n),e.accent&&Math.random()<.3&&(e.transition=this.getTransitionStyle()),e}getGrooveNames(){return Object.keys(this.templates)}getGrooveInfo(t){const i=this.templates[t];return i?{name:i.name,timeSignature:i.timeSignature,description:i.description,intensity:i.intensity,swing:i.swing,baseMovement:i.baseMovement,compositeMove:i.compositeMove}:null}}class Oe{constructor(t){this.mascot=t,this.vocalUpdateInterval=null}init(){}disconnectAudio(){return this.mascot.audioAnalyzer&&this.mascot.audioAnalyzer.stop(),this.vocalUpdateInterval&&(clearInterval(this.vocalUpdateInterval),this.vocalUpdateInterval=null),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.setVocalEnergy(0),this.mascot.shapeMorpher.setAudioDeformation(0),this.mascot.shapeMorpher.audioAnalyzer=null,this.mascot.shapeMorpher.beatGlitchIntensity=0,this.mascot.shapeMorpher.glitchPoints=[]),this.mascot.renderer&&this.mascot.renderer.ambientDanceAnimator.stopAmbientAnimation("grooveBob"),this.mascot}async connectAudio(t){if(!this.mascot.audioAnalyzer)return this.mascot;if(!this.mascot.audioAnalyzer.audioContext)try{await this.mascot.audioAnalyzer.init()}catch(t){return this.mascot}if(this.mascot.audioAnalyzer.audioContext&&"suspended"===this.mascot.audioAnalyzer.audioContext.state)try{await this.mascot.audioAnalyzer.audioContext.resume()}catch(t){}return this.mascot.audioAnalyzer.connectAudioElement(t),this.mascot.shapeMorpher&&(this.mascot.shapeMorpher.audioAnalyzer=this.mascot.audioAnalyzer,this.mascot.audioAnalyzer.onBeat(t=>{if(this.mascot.shapeMorpher){if(this.mascot.shapeMorpher.musicDetector){const i=performance.now();this.mascot.shapeMorpher.musicDetector.addOnset(i,t)}this.mascot.shapeMorpher.vocalEffectActive&&(this.mascot.shapeMorpher.beatGlitchIntensity=.3*t)}})),this.vocalUpdateInterval&&clearInterval(this.vocalUpdateInterval),this.mascot.renderer&&this.mascot.renderer.startGrooveBob({intensity:.5,frequency:1}),this.vocalUpdateInterval=setInterval(()=>{if(this.mascot.audioAnalyzer.isAnalyzing&&this.mascot.shapeMorpher){const t=this.mascot.audioAnalyzer.currentAmplitude||0,i=this.mascot.audioAnalyzer.getVocalInstability()||0;this.mascot.shapeMorpher.setVocalEnergy(i),this.mascot.shapeMorpher.setAudioDeformation(2*t)}},50),this.mascot.renderer&&(this.mascot.renderer.audioAnalyzer=this.mascot.audioAnalyzer),this.mascot}stopSpeaking(){if(!this.mascot.speaking)return this.mascot;const t=this.mascot.audioLevelProcessor.getCurrentLevel();return this.mascot.audioLevelProcessor.cleanup(),this.mascot.speaking=!1,this.mascot.renderer.onSpeechStop(),this.mascot.emit("speechStopped",{previousAudioLevel:t,returnToBaseTime:500}),this.mascot}setVolume(t){const i=Math.max(0,Math.min(1,t));if(this.mascot.config.masterVolume=i,this.mascot.soundSystem.isAvailable()){const t=this.mascot.stateMachine.getCurrentState().emotion;this.mascot.soundSystem.setMasterVolume(i,t)}return this.mascot.emit("volumeChanged",{volume:i}),this.mascot}destroy(){this.disconnectAudio()}}class Re{constructor(t){this.mascot=t,this.currentGesture=null}init(){}destroy(){this.currentGesture=null}}class ze{constructor(t){this.mascot=t,this.currentEmotion="neutral",this.emotionIntensity=1}init(){}setEmotion(t,i=null){const e={happy:"joy",curious:"surprise",frustrated:"anger",sad:"sadness"}[t]||t;let s=null,n=500;if("string"==typeof i?s=i:i&&"object"==typeof i&&(s=i.undertone||null,n=i.duration||500),this.mascot.stateMachine.setEmotion(e,s,n)){const t=A(e);if(t&&li.registerConfig("emotion",e,t),this.mascot.particleSystem){this.mascot.particleSystem.clear();const t=this.mascot.stateMachine.getCurrentEmotionalProperties();let i;if(i="neutral"===e?1:"resting"===e?4:Math.min(3,Math.floor(t.particleRate/4)),i>0){const e=this.mascot.canvasManager.width/2,s=this.mascot.canvasManager.height/2;this.mascot.particleSystem.burst(i,t.particleBehavior,e,s)}}if("classic"===this.mascot.config.renderingStyle&&this.mascot.renderer.setEmotionalState){const t=T(e);this.mascot.renderer.setEmotionalState(e,t,s)}this.mascot.emit("emotionChanged",{emotion:e,undertone:s,duration:n})}return this.currentEmotion=e,this.mascot}destroy(){this.currentEmotion="neutral"}}class Ee{constructor(t){this.mascot=t,this.animationId=null,this.isRunning=!1,this.lastTime=0}init(){}start(){if(this.mascot.animationController.isAnimating())return this.mascot;if(this.mascot.animationController.start()){if(this.mascot.isRunning=!0,this.isRunning=!0,"classic"===this.mascot.config.renderingStyle&&this.mascot.particleSystem){const t=this.mascot.stateMachine.getCurrentState(),{emotion:i}=t,e=T(i);let s,n;if(this.mascot.renderer&&this.mascot.renderer.getCurrentOrbPosition){const t=this.mascot.renderer.getCurrentOrbPosition();s=t.x,n=t.y}else s=this.mascot.canvasManager.width/2,n=this.mascot.canvasManager.height/2;if(this.mascot.particleSystem.clear(),e.particleRate>0){const t=Math.min(3,Math.floor(e.particleRate/4));t>0&&this.mascot.particleSystem.burst(t,e.particleBehavior,s,n)}}this.mascot.degradationManager&&this.mascot.degradationManager.startMonitoring(),this.mascot.emit("started")}return this.mascot}stop(){return this.mascot.animationController.isAnimating()?(this.mascot.speaking&&this.mascot.audioHandler.stopSpeaking(),this.mascot.animationController.stop()&&(this.mascot.isRunning=!1,this.isRunning=!1,this.mascot.degradationManager&&this.mascot.degradationManager.stopMonitoring(),this.mascot.emit("stopped")),this.mascot):this.mascot}update(t){if(this.mascot.speaking&&this.mascot.audioLevelProcessor.isProcessingActive()&&this.mascot.audioLevelProcessor.updateAudioLevel(t),"classic"===this.mascot.config.renderingStyle){if(this.mascot.gazeTracker&&(this.mascot.gazeTracker.update(t),"suspicion"===this.mascot.stateMachine.getCurrentState().emotion)){const{mousePos:t}=this.mascot.gazeTracker,i=this.mascot.canvas.width/2,e=this.mascot.canvas.height/2,s=Math.sqrt(Math.pow(t.x-i,2)+Math.pow(t.y-e,2)),n=A("suspicion");if(n&&n.visual){const t=Math.min(i,e),h=Math.max(0,Math.min(1,1-s/t));n.visual.threatLevel=h}}if(this.mascot.idleBehavior&&this.mascot.idleBehavior.update(t),this.mascot.gazeTracker&&this.mascot.idleBehavior){const t=this.mascot.gazeTracker.getGazeOffset(),i=this.mascot.idleBehavior.getSwayOffset(),e=this.mascot.gazeTracker.getState(),s={offset:{x:t.x+i.x,y:t.y+i.y},proximity:e.proximity,isFocused:e.isFocused};this.mascot.renderer.setGazeData&&this.mascot.renderer.setGazeData(s)}}}destroy(){this.stop()}}class qe{constructor(t,i={}){this.mascot=t,this.config=this.validateConfig(i)}validateConfig(t){return{canvasId:t.canvasId||"emotive-canvas",startingEmotion:t.startingEmotion||"neutral",emotionalResponsiveness:t.emotionalResponsiveness??.5,particleIntensity:t.particleIntensity??1,glowIntensity:t.glowIntensity??1,audioEnabled:t.audioEnabled??!1,showFPS:t.showFPS??!1,debugMode:t.debugMode??!1,renderMode:t.renderMode||"default",maxParticles:t.maxParticles||100,...t}}getConfig(){return{...this.config}}updateConfig(t){return this.config={...this.config,...t},this.config}}class De{constructor(t={}){this.errorBoundary=new i,this.eventManager=new Ki({maxListeners:t.maxEventListeners||100,enableDebugging:t.enableEventDebugging||!1,enableMonitoring:t.enableEventMonitoring||!0,memoryWarningThreshold:t.eventMemoryWarningThreshold||50}),this.eventManager.emit||(this.eventManager.T={},this.eventManager.emit=(t,i)=>{const e=this.eventManager.T[t];e&&e.forEach(t=>t(i))},this.eventManager.on=(t,i)=>{this.eventManager.T[t]||(this.eventManager.T[t]=[]),this.eventManager.T[t].push(i)},this.eventManager.off=(t,i)=>{const e=this.eventManager.T[t];if(e){const t=e.indexOf(i);t>-1&&e.splice(t,1)}}),this.errorBoundary.wrap(()=>{this.initialize(t)},"initialization")()}initialize(i){const e=pe.browserOptimizations.getOptimizations(),s={canvasId:"emotive-mascot",targetFPS:60,enableAudio:pe.featureDetection.features.webAudio,soundEnabled:!1,masterVolume:.5,maxParticles:e.particleLimit,defaultEmotion:"neutral",enableAutoOptimization:!0,enableGracefulDegradation:!0,renderingStyle:"classic",enableGazeTracking:!0,enableIdleBehaviors:!0,classicConfig:{coreColor:"#FFFFFF",coreSizeDivisor:12,glowMultiplier:2.5,defaultGlowColor:"#14B8A6"},topOffset:0};if(this.config={...s,...i},this.canvas="string"==typeof this.config.canvasId?document.getElementById(this.config.canvasId):this.config.canvasId,!this.canvas)throw new Error(`Canvas with ID '${this.config.canvasId}' not found`);this.canvasManager=new t(this.canvas),this.contextRecovery=new oe(this.canvas),this.contextRecovery.onRecovery(t=>{this.renderer&&this.renderer.handleContextRecovery(t)}),pe.browserOptimizations.applyCanvasOptimizations(this.canvas,this.canvasManager.getContext()),this.stateMachine=new q(this.errorBoundary),this.particleSystem=new pi(this.config.maxParticles,this.errorBoundary),this.renderer=new _i(this.canvasManager,{...this.config.classicConfig,topOffset:this.config.topOffset||0}),this.shapeMorpher=new xe,this.audioAnalyzer=new Be,this.gestureCompatibility=Ce,this.grooveTemplates=new Te,this.shapeMorpher.audioAnalyzer=this.audioAnalyzer,this.renderer.shapeMorpher=this.shapeMorpher,this.renderer.audioAnalyzer=this.audioAnalyzer,this.renderer.stateMachine=this.stateMachine,this.stateMachine.renderer=this.renderer,this.config.enableGazeTracking&&(this.gazeTracker=new Xi(this.canvas,{smoothing:.1,maxOffset:.15,enabled:!0}),this.gazeTracker.setInteractionCallback(()=>{this.sleeping?this.wake():this.idleBehavior&&this.idleBehavior.resetIdleTimer()})),this.config.enableIdleBehaviors&&(this.idleBehavior=new Yi({enabled:!0,sleepTimeout:1/0}),this.idleBehavior.setCallback("onBlink",t=>{this.renderer&&this.renderer.state&&(this.renderer.state.blinking="start"===t.phase)}),this.idleBehavior.setCallback("onSleep",()=>{this.renderer&&this.renderer.enterSleepMode&&this.renderer.enterSleepMode()}),this.idleBehavior.setCallback("onWake",()=>{this.renderer&&this.renderer.wakeUp&&this.renderer.wakeUp()})),this.soundSystem=new Ni,this.degradationManager=null,this.accessibilityManager=new te({enableReducedMotion:!1!==this.config.enableReducedMotion,enableHighContrast:!1!==this.config.enableHighContrast,enableScreenReaderSupport:!1!==this.config.enableScreenReaderSupport,enableKeyboardNavigation:!1!==this.config.enableKeyboardNavigation,colorBlindMode:this.config.colorBlindMode||"none"}),this.mobileOptimization=new ie({enableTouchOptimization:!1!==this.config.enableTouchOptimization,enableViewportHandling:!1!==this.config.enableViewportHandling,enableBatteryOptimization:!1!==this.config.enableBatteryOptimization}),this.mobileOptimization.setCanvas(this.canvas),this.pluginSystem=new ee({enablePlugins:!1!==this.config.enablePlugins,validatePlugins:!1!==this.config.validatePlugins,sandboxPlugins:!1!==this.config.sandboxPlugins}),this.audioLevelProcessor=new Zi({spikeThreshold:this.config.spikeThreshold||1.5,minimumSpikeLevel:this.config.minimumSpikeLevel||.1,spikeMinInterval:this.config.spikeMinInterval||1e3});try{this.animationController=new Ji(this.errorBoundary,{targetFPS:this.config.targetFPS})}catch(t){this.animationController={isAnimating:()=>this.isRunning,start:()=>(this.isRunning=!0,!0),stop:()=>(this.isRunning=!1,!0),setTargetFPS:()=>{},targetFPS:this.config.targetFPS,getPerformanceMetrics:()=>({fps:0,isRunning:this.isRunning,performanceDegradation:!1,deltaTime:16,frameCount:0,targetFPS:this.config.targetFPS}),setSubsystems:()=>{},setEventCallback:()=>{},setParentMascot:()=>{},destroy:()=>{},deltaTime:16}}this.animationController.setSubsystems({stateMachine:this.stateMachine,particleSystem:this.particleSystem,renderer:this.renderer,soundSystem:this.soundSystem,canvasManager:this.canvasManager}),this.animationController.setEventCallback((t,i)=>{this.emit(t,i)}),this.animationController.setParentMascot(this),this.isRunning=!1,this.config.enableAudio&&this.soundSystem.initialize().then(t=>{t&&this.soundSystem.setMasterVolume(this.config.masterVolume)}),this.speaking=!1,this.warningTimestamps={},this.rhythmEnabled=!1,li.initialize(),this.rhythmIntegration=li,this.warningThrottle=5e3,this.recording=!1,this.sleeping=!1,this.tts={available:"undefined"!=typeof window&&"speechSynthesis"in window,speaking:!1,currentUtterance:null},this.audioHandler=new Oe(this),this.gestureController=new Re(this),this.stateCoordinator=new ze(this),this.visualizationRunner=new Ee(this),this.configurationManager=new qe(this,i),this.audioHandler.init(),this.gestureController.init(),this.stateCoordinator.init(),this.visualizationRunner.init(),this.debugMode=this.config.enableDebug||!1,this.debugMode&&(me.log("INFO","Debug mode enabled for EmotiveMascot",{config:this.config,runtimeCapabilities:fe.generateReport()}),me.startProfile("mascot-initialization",{canvasId:this.config.canvasId,maxParticles:this.config.maxParticles})),this.setupAudioLevelProcessorCallbacks(),this.stateMachine.setEmotion(this.config.defaultEmotion),this.canvasManager.onResize((t,i,e)=>{this.handleResize(t,i,e)}),this.debugMode&&(me.endProfile("mascot-initialization"),me.takeMemorySnapshot("post-initialization"))}handleDegradationEvent(t,i){switch(t){case"degradationApplied":this.applyDegradationSettings(i.settings),this.emit("performanceDegradation",i);break;case"recoveryApplied":this.applyDegradationSettings(i.settings),this.emit("performanceRecovery",i);break;case"levelChanged":this.applyDegradationSettings(i.settings),this.emit("degradationLevelChanged",i)}}applyDegradationSettings(t){this.particleSystem&&void 0!==t.particleLimit&&this.particleSystem.setMaxParticles(t.particleLimit),this.soundSystem&&void 0!==t.audioEnabled&&!t.audioEnabled&&this.soundSystem.isAvailable()&&this.soundSystem.stopAmbientTone(200),this.renderer&&void 0!==t.qualityLevel&&this.renderer.setQualityLevel(t.qualityLevel)}setupAudioLevelProcessorCallbacks(){this.audioLevelProcessor.onLevelUpdate(t=>{this.renderer.updateAudioLevel(t.level),this.emit("audioLevelUpdate",{level:t.level,rawData:Array.from(t.rawData),timestamp:t.timestamp})}),this.audioLevelProcessor.onVolumeSpike(t=>{this.particleSystem.particles.some(t=>t.gestureProgress<1)||(this.stateMachine.getCurrentState().emotion,this.stateMachine.getCurrentEmotionalProperties(),this.express("pulse"),this.emit("volumeSpike",{...t,gestureTriggered:!0}))}),this.audioLevelProcessor.onError(t=>{this.emit("audioProcessingError",t)})}setEmotion(t,i=null){return this.errorBoundary.wrap(()=>this.stateCoordinator.setEmotion(t,i),"emotion-setting",this)()}updateUndertone(t){return this.errorBoundary.wrap(()=>(this.stateMachine.applyUndertoneModifier(t),this.renderer&&this.renderer.updateUndertone&&this.renderer.updateUndertone(t),this),"undertone-update",this)()}setBPM(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setBPM&&this.renderer.setBPM(t),this),"bpm-update",this)()}setRotationSpeed(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setRotationSpeed&&this.renderer.setRotationSpeed(t),this),"rotation-speed-update",this)()}setRotationAngle(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setRotationAngle&&this.renderer.setRotationAngle(t),this),"rotation-angle-update",this)()}setGazeTracking(t){return this.errorBoundary.wrap(()=>(this.renderer&&this.renderer.setGazeTracking&&this.renderer.setGazeTracking(t),this),"gaze-tracking-update",this)()}express(t,i={}){return this.errorBoundary.wrap(()=>{const e=performance.now(),s=Array.isArray(t)||"object"==typeof t&&"chord"===t.type?"chord":t;if(this.performanceMonitor&&this.performanceMonitor.markGestureStart(s),!t)return this.performanceMonitor&&this.performanceMonitor.markGestureEnd(s),this;if(Array.isArray(t))return this.expressChord(t,i);if("object"==typeof t&&"chord"===t.type)return this.expressChord(t.gestures,i);const n={bounce:"startBounce",pulse:"startPulse",shake:"startShake",spin:"startSpin",nod:"startNod",tilt:"startTilt",expand:"startExpand",contract:"startContract",flash:"startFlash",drift:"startDrift",stretch:"startStretch",glow:"startGlow",sparkle:"startSparkle",shimmer:"startShimmer",wiggle:"startWiggle",groove:"startGroove",point:"startPoint",lean:"startLean",reach:"startReach",headBob:"startHeadBob",orbit:"startOrbit",flicker:"startFlicker",vibrate:"startVibrate",wave:"startWave",breathe:"startBreathe",morph:"startMorph",slowBlink:"startSlowBlink",look:"startLook",settle:"startSettle",orbital:"startOrbital",hula:"startHula",sway:"startSway",breathIn:"startBreathIn",breathOut:"startBreathOut",breathHold:"startBreathHold",breathHoldEmpty:"startBreathHoldEmpty",jump:"startJump",rain:"startRain",runningman:"startRunningMan",charleston:"startCharleston",grooveSway:"startGrooveSway",grooveBob:"startGrooveBob",grooveFlow:"startGrooveFlow",groovePulse:"startGroovePulse",grooveStep:"startGrooveStep"}[t];if(n&&this.renderer&&this.renderer[n]){if(this.renderer[n](i),this.config.soundEnabled&&this.soundSystem.isAvailable()&&this.soundSystem.playGestureSound(t),this.performanceMonitor){const t=performance.now();this.performanceMonitor.markGestureEnd(s),this.performanceMonitor.recordGestureTime(s,t-e)}return this}const h=oi(t);if(h){if(li.registerConfig("gesture",t,h),this.currentModularGesture={type:t,config:h,startTime:performance.now(),duration:h.defaultParams?.duration||1e3,progress:0},this.config.soundEnabled&&this.soundSystem.isAvailable()&&this.soundSystem.playGestureSound(t),this.performanceMonitor){const t=performance.now();this.performanceMonitor.markGestureEnd(s),this.performanceMonitor.recordGestureTime(s,t-e)}return this}return this.throttledWarn(`Unknown gesture: ${t}`,`gesture_${t}`),this.performanceMonitor&&this.performanceMonitor.markGestureEnd(s),this},"gesture-expression",this)()}expressChord(t,i={}){return this.errorBoundary.wrap(()=>{if(!t||!Array.isArray(t)||0===t.length)return this;this.gestureCompatibility||Promise.resolve().then(function(){return Ae}).then(t=>{this.gestureCompatibility=t.default}).catch(t=>{});const e=this.gestureCompatibility?this.gestureCompatibility.getCompatibleGestures(t):t;return e.forEach(t=>{const e="string"==typeof t?t:t.gestureName;this.executeGestureDirectly(e,i)}),this.gestureCompatibility?.isEnhancingCombination?.(e)&&this.renderer?.specialEffects?.addSparkle?.(),this},"gesture-chord",this)()}executeGestureDirectly(t,i={}){const e={bounce:"startBounce",pulse:"startPulse",shake:"startShake",spin:"startSpin",nod:"startNod",tilt:"startTilt",flash:"startFlash",glow:"startGlow",sparkle:"startSparkle",shimmer:"startShimmer",wiggle:"startWiggle",groove:"startGroove",point:"startPoint",lean:"startLean",reach:"startReach",headBob:"startHeadBob",orbit:"startOrbit",sway:"startSway",jump:"startJump",wave:"startWave",flicker:"startFlicker",breathe:"startBreathe",float:"startFloat",rain:"startRain",hula:"startHula",twist:"startTwist"}[t];e&&this.renderer&&"function"==typeof this.renderer[e]&&this.renderer[e](i),this.emit("gesture",{name:t,options:i})}chain(...t){if(this.gestureCompatibility){const i=t.join(">"),e=this.gestureCompatibility.parseChain(i);this.executeChainSequence(e)}else t.length>0&&this.express(t[0]);return this}executeChainSequence(t){if(!t||0===t.length)return;let i=0;const e=()=>{if(i>=t.length)return;const s=t[i];1===s.length?this.express(s[0]):this.expressChord(s),i++,i<t.length&&setTimeout(e,800)};e()}startSpeaking(t){return this.errorBoundary.wrap(()=>{if(!t)throw new Error("AudioContext is required for speech reactivity");return this.config.enableAudio?this.speaking?this:this.audioLevelProcessor.initialize(t)?(this.speaking=!0,this.renderer.onSpeechStart(t),this.emit("speechStarted",{audioContext:t,analyser:this.audioLevelProcessor.getAnalyser(),mascot:this}),this):this:this},"speech-start",this)()}stopSpeaking(){return this.errorBoundary.wrap(()=>this.audioHandler.stopSpeaking(),"speech-stop",this)()}startRecording(){return this.errorBoundary.wrap(()=>(this.recording||(this.recording=!0,this.renderer&&this.renderer.startRecording&&this.renderer.startRecording(),this.emit("recordingStarted")),this),"recording-start",this)()}stopRecording(){return this.errorBoundary.wrap(()=>this.recording?(this.recording=!1,this.renderer&&this.renderer.stopRecording&&this.renderer.stopRecording(),this.emit("recordingStopped"),this):this,"recording-stop",this)()}sleep(){return this.errorBoundary.wrap(async()=>(this.sleeping||(this.express("yawn"),await new Promise(t=>setTimeout(t,1e3)),this.express("sway"),await new Promise(t=>setTimeout(t,1e3)),this.sleeping=!0,this.renderer&&this.renderer.enterSleepMode&&this.renderer.enterSleepMode(),this.idleBehavior&&this.idleBehavior.enterSleep&&this.idleBehavior.enterSleep(),this.emit("sleep")),this),"sleep",this)()}wake(){return this.errorBoundary.wrap(async()=>this.sleeping?(this.sleeping=!1,this.renderer&&this.renderer.wakeUp&&this.renderer.wakeUp(),this.idleBehavior&&this.idleBehavior.wakeUp&&this.idleBehavior.wakeUp(),this.express("stretch"),await new Promise(t=>setTimeout(t,1e3)),this.express("slowBlink"),await new Promise(t=>setTimeout(t,1e3)),this.express("shake"),await new Promise(t=>setTimeout(t,500)),this.emit("wake"),this):this,"wake",this)()}getTTSVoices(){return this.tts.available?window.speechSynthesis.getVoices():[]}isTTSSpeaking(){return this.tts.speaking}start(){return this.errorBoundary.wrap(()=>this.visualizationRunner.start(),"start",this)()}stop(){return this.errorBoundary.wrap(()=>this.visualizationRunner.stop(),"stop",this)()}setBreathePattern(t,i,e,s){return this.errorBoundary.wrap(()=>{const n=t+i+e+s;return this.breathePattern={inhale:t,hold1:i,exhale:e,hold2:s,totalCycle:n,currentPhase:"inhale",phaseStartTime:Date.now(),phaseProgress:0},this.startBreathingAnimation(),this},"setBreathePattern",this)()}setOrbScale(t,i=1e3,e="easeInOut"){return this.errorBoundary.wrap(()=>{if(this.renderer){const s=this.currentOrbScale||1,n=Date.now(),h=()=>{const a=Date.now()-n,r=Math.min(a/i,1);let o=r;"easeIn"===e?o=r*r:"easeOut"===e?o=r*(2-r):"easeInOut"===e&&(o=r<.5?2*r*r:(4-2*r)*r-1),this.currentOrbScale=s+(t-s)*o,this.renderer.setCustomScale&&this.renderer.setCustomScale(this.currentOrbScale),r<1&&this.isRunning&&requestAnimationFrame(h)};h()}return this},"setOrbScale",this)()}breathe(t="calm"){return this.errorBoundary.wrap(()=>{const i={calm:{inhale:4,hold1:0,exhale:4,hold2:0},anxious:{inhale:2,hold1:0,exhale:2,hold2:0},meditative:{inhale:4,hold1:7,exhale:8,hold2:0},deep:{inhale:5,hold1:5,exhale:5,hold2:5},sleep:{inhale:6,hold1:0,exhale:8,hold2:2}},e=i[t]||i.calm;return this.setBreathePattern(e.inhale,e.hold1,e.exhale,e.hold2)},"breathe",this)()}startBreathingAnimation(){this.breathingAnimationId&&cancelAnimationFrame(this.breathingAnimationId);const t=()=>{if(!this.breathePattern||!this.isRunning)return;const i=this.breathePattern,e=Date.now(),s=(e-i.phaseStartTime)/1e3;let n=1,h=i.currentPhase;switch(i.currentPhase){case"inhale":s>=i.inhale?(h="hold1",i.phaseStartTime=e,this.emit("hold-start",{type:"post-inhale"})):n=1+s/i.inhale*.3;break;case"hold1":s>=i.hold1&&(h="exhale",i.phaseStartTime=e,this.emit("exhale-start")),n=1.3;break;case"exhale":s>=i.exhale?(h="hold2",i.phaseStartTime=e,this.emit("hold-start",{type:"post-exhale"})):n=1.3-s/i.exhale*.4;break;case"hold2":s>=i.hold2&&(h="inhale",i.phaseStartTime=e,this.emit("inhale-start")),n=.9}h!==i.currentPhase&&(i.currentPhase=h),this.renderer&&this.renderer.setCustomScale&&this.renderer.setCustomScale(n),this.breathingAnimationId=requestAnimationFrame(t)};this.breathePattern.currentPhase="inhale",this.breathePattern.phaseStartTime=Date.now(),this.emit("inhale-start"),t()}stopBreathing(){return this.errorBoundary.wrap(()=>(this.breathingAnimationId&&(cancelAnimationFrame(this.breathingAnimationId),this.breathingAnimationId=null),this.breathePattern=null,this.renderer&&this.renderer.setCustomScale&&this.renderer.setCustomScale(1),this),"stopBreathing",this)()}on(t,i){return this.errorBoundary.wrap(()=>(this.eventManager.on(t,i),this),"event-listener-add",this)()}off(t,i){return this.errorBoundary.wrap(()=>(this.eventManager.off(t,i),this),"event-listener-remove",this)()}once(t,i){return this.errorBoundary.wrap(()=>(this.eventManager.once(t,i),this),"event-listener-once",this)()}removeAllListeners(t=null){return this.errorBoundary.wrap(()=>(this.eventManager.removeAllListeners(t),this),"event-listeners-clear",this)()}listenerCount(t){return this.eventManager.listenerCount(t)}getEventNames(){return this.eventManager.getEventNames()}getEventStats(){return this.eventManager.getEventStats()}getEventDebugInfo(){return this.eventManager.getDebugInfo()}getBrowserCompatibility(){return{browser:pe.browser,features:pe.featureDetection.getFeatures(),capabilities:pe.capabilities,appliedPolyfills:pe.appliedPolyfills,optimizations:pe.browserOptimizations.getOptimizations()}}getDegradationStatus(){return this.degradationManager?{currentLevel:this.degradationManager.getCurrentLevel(),availableFeatures:this.degradationManager.getAvailableFeatures(),recommendedSettings:this.degradationManager.getRecommendedSettings(),performanceStats:this.degradationManager.getPerformanceStats(),allLevels:this.degradationManager.getAllLevels()}:null}setDegradationLevel(t){return!!this.degradationManager&&this.degradationManager.setLevel(t)}isFeatureAvailable(t){return this.degradationManager?this.degradationManager.isFeatureAvailable(t):pe.featureDetection.getFeatures()[t]||!1}recoverCanvasContext(){return!!this.contextRecovery&&this.contextRecovery.recover()}isCanvasContextLost(){return!!this.contextRecovery&&this.contextRecovery.isLost()}getDebugReport(){const t={timestamp:Date.now(),mascot:{isRunning:this.isRunning,speaking:this.speaking,debugMode:this.debugMode,config:this.config},currentState:this.getCurrentState(),performanceMetrics:this.getPerformanceMetrics(),audioStats:this.getAudioStats(),eventStats:this.getEventStats(),browserCompatibility:this.getBrowserCompatibility(),degradationStatus:this.getDegradationStatus(),runtimeCapabilities:fe.generateReport(),debuggerReport:me.getDebugReport()};return this.debugMode&&me.log("DEBUG","Generated debug report",{reportSize:JSON.stringify(t).length,sections:Object.keys(t)}),t}exportDebugData(){const t={metadata:{exportTime:Date.now(),version:"1.0.0",userAgent:navigator.userAgent,url:window.location?.href},mascotState:{config:this.config,currentState:this.getCurrentState(),isRunning:this.isRunning,speaking:this.speaking},performance:{metrics:this.getPerformanceMetrics(),degradationStatus:this.getDegradationStatus(),frameTimings:me.frameTimings},compatibility:{browser:this.getBrowserCompatibility(),runtimeCapabilities:fe.generateReport()},debuggerData:me.exportDebugData()};return this.debugMode&&me.log("INFO","Exported debug data",{dataSize:JSON.stringify(t).length}),t}startProfiling(t,i={}){this.debugMode&&me.startProfile(t,i)}endProfiling(t){return this.debugMode?me.endProfile(t):null}takeMemorySnapshot(t){this.debugMode&&me.takeMemorySnapshot(t)}clearDebugData(){me.clear(),this.debugMode&&me.log("INFO","Debug data cleared")}getRuntimeCapabilities(){return fe.generateReport()}emit(t,i=null){this.eventManager.emit(t,i)}update(t){this.errorBoundary.wrap(()=>{this.visualizationRunner.update(t)},"audio-update")()}render(){let t=16.67,i=0;try{i=this.debugMode?performance.now():0,t=this.animationController?this.animationController.deltaTime:16.67;const e={properties:this.stateMachine.getCurrentEmotionalProperties(),emotion:this.stateMachine.getCurrentState().emotion,undertone:this.stateMachine.getCurrentState().undertone,particleSystem:this.particleSystem,speaking:this.speaking,audioLevel:this.audioLevelProcessor.getCurrentLevel(),gazeOffset:this.gazeTracker?this.gazeTracker.currentGaze:{x:0,y:0}};if(this.debugMode&&me.trackFrameTiming(t),this.canvasManager.clear(),this.gazeTracker&&this.gazeTracker.update(t),"suspicion"===e.emotion&&this.gazeTracker){const t=A("suspicion");if(t&&t.visual){this.gazeTracker.getState();const{mousePos:i}=this.gazeTracker,e=this.canvasManager.width/2,s=this.canvasManager.height/2-this.config.topOffset,n=Math.sqrt(Math.pow(i.x-e,2)+Math.pow(i.y-s,2)),h=Math.min(this.canvasManager.width,this.canvasManager.height)/2,a=Math.max(0,Math.min(1,1-n/h));t.visual.threatLevel=a}}const s=T(e.emotion);this.renderer.setEmotionalState(e.emotion,s,e.undertone);const n=this.canvasManager.width/2;let h=this.canvasManager.height/2-this.config.topOffset;const a=this.stateMachine.getCurrentEmotionalProperties();a.verticalOffset&&(h=this.canvasManager.height/2-this.config.topOffset+this.canvasManager.height*a.verticalOffset);let r=s.particleBehavior||"ambient",o=s.particleRate||15;e.emotion;const c=void 0!==s.minParticles?s.minParticles:a.minParticles||0;let l=void 0!==s.maxParticles?s.maxParticles:a.maxParticles||10;"zen"===e.emotion&&(r=Math.random()<.6?"falling":"orbiting"),this.renderer.state&&this.renderer.state.particleBehaviorOverride&&(r=this.renderer.state.particleBehaviorOverride),this.renderer.state&&this.renderer.state.particleRateMult&&(o=Math.floor(o*this.renderer.state.particleRateMult),l=Math.floor(l*this.renderer.state.particleRateMult)),this.particleSystem.spawn(r,e.emotion,o,n,h,t,null,c,l,this.renderer.scaleFactor||1,this.config.classicConfig?.particleSizeMultiplier||1,s.particleColors||null,e.undertone);const u=this.renderer.getUndertoneModifier?this.renderer.getUndertoneModifier():null;let p=u;"zen"===e.emotion&&this.renderer.state.zenVortexIntensity&&(p={...u||{},zenVortexIntensity:this.renderer.state.zenVortexIntensity});let d=null,m=0;if(this.currentModularGesture){const t=performance.now()-this.currentModularGesture.startTime;m=Math.min(t/this.currentModularGesture.duration,1),m>=1?(d={type:this.currentModularGesture.type,amplitude:1,frequency:1,intensity:1},m=1,this.currentModularGesture.cleanupPending?this.currentModularGesture=null:this.currentModularGesture.cleanupPending=!0):d={type:this.currentModularGesture.type,amplitude:1,frequency:1,intensity:1}}else if(this.renderer&&this.renderer.getCurrentGesture){const t=this.renderer.getCurrentGesture();t&&t.particleMotion&&(d=t.particleMotion,m=t.progress||0)}this.particleSystem.update(t,n,h,d,m,p);const f=this.renderer.gestureAnimator?this.renderer.gestureAnimator.applyGestureAnimations():null;if(this.particleSystem.renderBackground(this.canvasManager.getContext(),s.glowColor,f),this.renderer.render(e,t,f),this.particleSystem.renderForeground(this.canvasManager.getContext(),s.glowColor,f),(this.config.showFPS||this.config.showDebug)&&this.renderDebugInfo(t),this.debugMode){const e=performance.now()-i;e>16.67&&me.log("WARN","Slow render frame detected",{renderTime:e,deltaTime:t,particleCount:this.particleSystem.getStats().activeParticles})}}catch(t){this.errorBoundary.logError(t,"main-render")}}renderDebugInfo(t){const i=this.canvasManager.getContext();i.save(),i.fillStyle="#ffffff",i.font="12px monospace",i.strokeStyle="#000000",i.lineWidth=2;let e=20;if(this.config.showFPS){const t=this.animationController.getPerformanceMetrics(),s=t.instantFps||t.fps||0,n=[`FPS: ${s}`,`Frame: ${t.averageFrameTime?t.averageFrameTime.toFixed(1):"0.0"}ms`,`Particles: ${this.particleSystem.getStats().activeParticles}`],h=8;let a=0;n.forEach(t=>{const{width:e}=i.measureText(t);e>a&&(a=e)});const r=this.canvasManager.width-a-h-10;let o;i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(r-h,e-14,a+2*h,18*n.length+4),o=s>=55?"#00ff00":s>=30?"#ffff00":"#ff0000",i.strokeStyle=o,i.lineWidth=2,i.strokeRect(r-h,e-14,a+2*h,18*n.length+4),n.forEach((t,s)=>{const n=e+16*s;i.fillStyle="#ffffff",i.fillText(t,r,n)}),e+=16*n.length}if(this.config.showDebug){const t=this.stateMachine.getCurrentState(),s=this.particleSystem.getStats(),n=[`Emotion: ${t.emotion}${t.undertone?` (${t.undertone})`:""}`,`Particles: ${s.activeParticles}/${s.maxParticles}`,`Gesture: ${this.currentModularGesture?this.currentModularGesture.type:"none"}`,"Speaking: "+(this.speaking?"yes":"no"),`Audio Level: ${(100*this.audioLevel).toFixed(1)}%`];i.fillStyle="rgba(0, 0, 0, 0.7)";const h=Math.max(...n.map(t=>i.measureText(t).width));i.fillRect(8,e-14,h+16,16*n.length+4),i.fillStyle="#ffffff";for(const t of n)i.fillText(t,10,e),e+=16}i.restore()}getEmotionalColor(){const t=this.stateMachine.getCurrentEmotionalProperties();return t?.primaryColor||"#B0B0B0"}getCurrentState(){return this.stateMachine.getCurrentState()}getAvailableEmotions(){return this.stateMachine.getAvailableEmotions()}getAvailableUndertones(){return this.stateMachine.getAvailableUndertones()}getAudioStats(){return this.audioLevelProcessor.getStats()}updateAudioConfig(t){this.audioLevelProcessor.updateConfig(t)}getAvailableGestures(){return["bounce","pulse","shake","spin","drift","nod","tilt","expand","contract","flash","stretch","glow","flicker","vibrate","wave","morph","slowBlink","look","settle","breathIn","breathOut","breathHold","breathHoldEmpty","jump"]}connectAudioSource(t){return this.errorBoundary.wrap(()=>this.audioAnalyser&&t&&"function"==typeof t.connect?(t.connect(this.audioAnalyser),this.emit("audioSourceConnected",{audioSource:t}),this):this,"audio-source-connection",this)()}setVolume(t){return this.errorBoundary.wrap(()=>this.audioHandler.setVolume(t),"volume-setting",this)()}getVolume(){return this.config.masterVolume}setSoundEnabled(t){return this.config.soundEnabled=t,this}isSoundEnabled(){return this.config.soundEnabled}pause(){return this.errorBoundary.wrap(()=>this.animationController.isAnimating()?(this.animationController.stop(),this.isRunning=!1,this.soundSystem.isAvailable()&&this.soundSystem.stopAmbientTone(200),this.emit("paused"),this):this,"pause",this)()}resume(){return this.errorBoundary.wrap(()=>(this.animationController.isAnimating()||(this.animationController.start(),this.isRunning=!0,this.emit("resumed")),this),"resume",this)()}isActive(){return this.animationController.isAnimating()}setTargetFPS(t){const i=Math.max(15,Math.min(120,t));return this.config.targetFPS=i,this.animationController.setTargetFPS(i),this.emit("targetFPSChanged",{targetFPS:i}),this}getTargetFPS(){return this.animationController.targetFPS}setPerformanceDegradation(t){const i=this.animationController.getPerformanceMetrics();if(t&&!i.performanceDegradation){const t=this.particleSystem.maxParticles,i=Math.max(5,Math.floor(.5*t));this.particleSystem.setMaxParticles(i)}else!t&&i.performanceDegradation&&this.particleSystem.setMaxParticles(this.config.maxParticles);return this}getAudioLevel(){return this.speaking?this.audioLevel:0}isSpeaking(){return this.speaking}setAudioSmoothing(t){return this.errorBoundary.wrap(()=>{const i=Math.max(0,Math.min(1,t));return this.audioAnalyser&&(this.audioAnalyser.smoothingTimeConstant=i),this},"audio-smoothing",this)()}getSystemStatus(){return this.errorBoundary.wrap(()=>{const t=this.stateMachine.getCurrentState(),i=this.particleSystem.getStats(),e=this.renderer.getStats(),s=this.animationController.getPerformanceMetrics();return{isRunning:s.isRunning,fps:s.fps,targetFPS:s.targetFPS,performanceDegradation:s.performanceDegradation,emotion:t.emotion,undertone:t.undertone,isTransitioning:t.isTransitioning,transitionProgress:t.transitionProgress,currentGesture:this.renderer?.currentGesture||null,gestureActive:this.renderer?.isGestureActive()||!1,particles:{active:i.activeParticles,max:i.maxParticles,poolEfficiency:i.poolEfficiency},audioEnabled:this.config.enableAudio,soundSystemAvailable:this.soundSystem.isAvailable(),speaking:this.speaking,audioLevel:this.audioLevel,masterVolume:this.config.masterVolume,renderer:{gradientCacheSize:e.gradientCacheSize,breathingPhase:e.breathingPhase,layers:e.layers},eventListeners:this.getEventNames().length,errorStats:this.errorBoundary.getErrorStats()}},"system-status",{})()}setDebugMode(t){return this.config.showDebug=!!t,this.config.showFPS=!!t,this}triggerTestError(t="manual-test"){return this.errorBoundary.wrap(()=>{throw new Error(`Test error triggered in context: ${t}`)},t,this)()}getPerformanceMetrics(){const t=this.animationController.getPerformanceMetrics(),i=this.stateMachine.getCurrentState();return{...t,currentEmotion:i.emotion,currentUndertone:i.undertone,isTransitioning:i.isTransitioning,errorStats:this.errorBoundary.getErrorStats()}}registerPlugin(t){return this.pluginSystem.registerPlugin(t)}setAccessibility(t){t.colorBlindMode&&this.accessibilityManager.setColorBlindMode(t.colorBlindMode),void 0!==t.reducedMotion&&(this.accessibilityManager.reducedMotionPreferred=t.reducedMotion),void 0!==t.highContrast&&(this.accessibilityManager.highContrastEnabled=t.highContrast)}getMobileStatus(){return this.mobileOptimization.getStatus()}getAccessibilityStatus(){return this.accessibilityManager.getStatus()}setState(t){return this.setEmotion(t)}speak(t,i={}){if(!window.speechSynthesis)return null;const e=new SpeechSynthesisUtterance(t);return i.voice&&(e.voice=i.voice),i.rate&&(e.rate=i.rate),i.pitch&&(e.pitch=i.pitch),i.volume&&(e.volume=i.volume),i.lang&&(e.lang=i.lang),e.onstart=()=>{this.setTTSSpeaking(!0),this.emit("tts:start",{text:t})},e.onend=()=>{this.setTTSSpeaking(!1),this.emit("tts:end")},e.onerror=t=>{this.setTTSSpeaking(!1),this.emit("tts:error",{error:t})},e.onboundary=t=>{this.emit("tts:boundary",{name:t.name,charIndex:t.charIndex,charLength:t.charLength})},window.speechSynthesis.speak(e),e}setTTSSpeaking(t){this.ttsSpeaking=t,this.renderer&&this.renderer.startSpeaking&&(t?this.renderer.startSpeaking():this.renderer.stopSpeaking()),this.speaking=t}getVoices(){return window.speechSynthesis?window.speechSynthesis.getVoices():[]}stopTTS(){window.speechSynthesis&&(window.speechSynthesis.cancel(),this.setTTSSpeaking(!1))}handleResize(t,i,e){if(this.renderer&&this.renderer.initOffscreenCanvas&&this.renderer.initOffscreenCanvas(),this.stateMachine){const{currentEmotion:t}=this.stateMachine,{currentUndertone:i}=this.stateMachine;t&&this.stateMachine.setEmotion(t),i&&"none"!==i&&this.stateMachine.setUndertone(i)}this.emit("resize",{width:t,height:i,dpr:e})}morphTo(t,i={}){return this.errorBoundary.wrap(()=>this.shapeMorpher?(this.shapeMorpher.morphTo(t,i),this.renderer&&(this.renderer.shapeMorpher=this.shapeMorpher),this.emit("shapeMorphStarted",{from:this.shapeMorpher.currentShape,to:t}),this):this,"morphTo",this)()}connectAudio(t){return this.errorBoundary.wrap(()=>this.audioHandler.connectAudio(t),"connectAudio",this)()}disconnectAudio(){return this.errorBoundary.wrap(()=>this.audioHandler.disconnectAudio(),"disconnectAudio",this)()}getAvailableShapes(){return xe.getAvailableShapes()}destroy(){this.errorBoundary.wrap(()=>{this.stop(),this.speaking&&this.stopSpeaking(),this.animationController&&this.animationController.destroy(),this.soundSystem&&this.soundSystem.cleanup(),this.audioLevelProcessor&&this.audioLevelProcessor.cleanup(),this.particleSystem&&this.particleSystem.destroy(),this.renderer&&(this.renderer.stopAllGestures(),this.renderer.destroy()),this.canvasManager&&this.canvasManager.destroy(),this.eventManager&&this.eventManager.destroy(),this.accessibilityManager&&this.accessibilityManager.destroy(),this.mobileOptimization&&this.mobileOptimization.destroy(),this.pluginSystem&&this.pluginSystem.destroy(),this.audioAnalyzer&&(this.disconnectAudio(),this.audioAnalyzer.destroy()),this.shapeMorpher&&this.shapeMorpher.reset(),this.errorBoundary.clearErrors()},"destruction")()}throttledWarn(t,i){const e=Date.now();e-(this.warningTimestamps[i]||0)>this.warningThrottle&&(this.warningTimestamps[i]=e)}}export{De as default};
